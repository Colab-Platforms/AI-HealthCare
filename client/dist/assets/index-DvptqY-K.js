import{r as j,a as BY,u as Ga,b as hg,L as Rt,d as GY,R as o2,e as Lh,f as c2,c as zf,g as WY,h as HY,i as Fs,N as _r,B as zY}from"./vendor-BZrlrEDh.js";import{M as Mh,X as ra,S as Kd,H as zn,W as _o,C as Pn,L as DE,a as pg,A as ms,b as l2,F as un,c as KY,U as mg,d as Ji,e as ng,B as Eo,f as Yr,g as kE,D as jE,h as $i,i as d2,j as Ba,T as Qn,k as vr,P as oc,l as Yd,m as u2,n as iE,o as xo,Z as zr,p as mP,q as PE,r as Wd,s as Kr,t as yo,u as qd,v as kh,E as h2,w as hl,x as ag,y as p2,z as dn,G as fP,R as YY,I as LE,J as qY,K as XY,N as JY,O as fg,Q as Xd,V as uc,Y as Hs,_ as hn,$ as $Y,a0 as m2,a1 as QY,a2 as cc,a3 as bo,a4 as gP,a5 as qi,a6 as ZY,a7 as Dh,a8 as jh,a9 as oE,aa as cE,ab as gg,ac as xg,ad as bg,ae as ME,af as lc,ag as vi,ah as lE,ai as UE,aj as f2,ak as VE,al as g2,am as wo,an as cn,ao as Bd,ap as vo,aq as x2,ar as eq,as as tq,at as dc,au as FE,av as BE,aw as b2,ax as _2,ay as v2,az as dE,aA as E2,aB as xP,aC as bP,aD as Uh,aE as sq,aF as y2,aG as uE,aH as nq,aI as aq,aJ as rq,aK as iq,aL as w2,aM as S2,aN as hE,aO as oq,aP as cq,aQ as lq,aR as dq,aS as uq,aT as qv,aU as hq,aV as pq,aW as mq,aX as Xv,aY as fq,aZ as gq,a_ as _P}from"./ui-hRMYkbT1.js";(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const E of document.querySelectorAll('link[rel="modulepreload"]'))_(E);new MutationObserver(E=>{for(const y of E)if(y.type==="childList")for(const R of y.addedNodes)R.tagName==="LINK"&&R.rel==="modulepreload"&&_(R)}).observe(document,{childList:!0,subtree:!0});function x(E){const y={};return E.integrity&&(y.integrity=E.integrity),E.referrerPolicy&&(y.referrerPolicy=E.referrerPolicy),E.crossOrigin==="use-credentials"?y.credentials="include":E.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function _(E){if(E.ep)return;E.ep=!0;const y=x(E);fetch(E.href,y)}})();var N2={exports:{}},_g={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xq=j,bq=Symbol.for("react.element"),_q=Symbol.for("react.fragment"),vq=Object.prototype.hasOwnProperty,Eq=xq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,yq={key:!0,ref:!0,__self:!0,__source:!0};function T2(u,f,x){var _,E={},y=null,R=null;x!==void 0&&(y=""+x),f.key!==void 0&&(y=""+f.key),f.ref!==void 0&&(R=f.ref);for(_ in f)vq.call(f,_)&&!yq.hasOwnProperty(_)&&(E[_]=f[_]);if(u&&u.defaultProps)for(_ in f=u.defaultProps,f)E[_]===void 0&&(E[_]=f[_]);return{$$typeof:bq,type:u,key:y,ref:R,props:E,_owner:Eq.current}}_g.Fragment=_q;_g.jsx=T2;_g.jsxs=T2;N2.exports=_g;var a=N2.exports,pE={},vP=BY;pE.createRoot=vP.createRoot,pE.hydrateRoot=vP.hydrateRoot;let wq={data:""},Sq=u=>{if(typeof window=="object"){let f=(u?u.querySelector("#_goober"):window._goober)||Object.assign(document.createElement("style"),{innerHTML:" ",id:"_goober"});return f.nonce=window.__nonce__,f.parentNode||(u||document.head).appendChild(f),f.firstChild}return u||wq},Nq=/(?:([\u0080-\uFFFF\w-%@]+) *:? *([^{;]+?);|([^;}{]*?) *{)|(}\s*)/g,Tq=/\/\*[^]*?\*\/|  +/g,EP=/\n+/g,ic=(u,f)=>{let x="",_="",E="";for(let y in u){let R=u[y];y[0]=="@"?y[1]=="i"?x=y+" "+R+";":_+=y[1]=="f"?ic(R,y):y+"{"+ic(R,y[1]=="k"?"":f)+"}":typeof R=="object"?_+=ic(R,f?f.replace(/([^,])+/g,P=>y.replace(/([^,]*:\S+\([^)]*\))|([^,])+/g,U=>/&/.test(U)?U.replace(/&/g,P):P?P+" "+U:U)):y):R!=null&&(y=/^--/.test(y)?y:y.replace(/[A-Z]/g,"-$&").toLowerCase(),E+=ic.p?ic.p(y,R):y+":"+R+";")}return x+(f&&E?f+"{"+E+"}":E)+_},mo={},R2=u=>{if(typeof u=="object"){let f="";for(let x in u)f+=x+R2(u[x]);return f}return u},Rq=(u,f,x,_,E)=>{let y=R2(u),R=mo[y]||(mo[y]=(U=>{let G=0,F=11;for(;G<U.length;)F=101*F+U.charCodeAt(G++)>>>0;return"go"+F})(y));if(!mo[R]){let U=y!==u?u:(G=>{let F,k,X=[{}];for(;F=Nq.exec(G.replace(Tq,""));)F[4]?X.shift():F[3]?(k=F[3].replace(EP," ").trim(),X.unshift(X[0][k]=X[0][k]||{})):X[0][F[1]]=F[2].replace(EP," ").trim();return X[0]})(u);mo[R]=ic(E?{["@keyframes "+R]:U}:U,x?"":"."+R)}let P=x&&mo.g?mo.g:null;return x&&(mo.g=mo[R]),((U,G,F,k)=>{k?G.data=G.data.replace(k,U):G.data.indexOf(U)===-1&&(G.data=F?U+G.data:G.data+U)})(mo[R],f,_,P),R},Cq=(u,f,x)=>u.reduce((_,E,y)=>{let R=f[y];if(R&&R.call){let P=R(x),U=P&&P.props&&P.props.className||/^go/.test(P)&&P;R=U?"."+U:P&&typeof P=="object"?P.props?"":ic(P,""):P===!1?"":P}return _+E+(R??"")},"");function vg(u){let f=this||{},x=u.call?u(f.p):u;return Rq(x.unshift?x.raw?Cq(x,[].slice.call(arguments,1),f.p):x.reduce((_,E)=>Object.assign(_,E&&E.call?E(f.p):E),{}):x,Sq(f.target),f.g,f.o,f.k)}let C2,mE,fE;vg.bind({g:1});let So=vg.bind({k:1});function Iq(u,f,x,_){ic.p=f,C2=u,mE=x,fE=_}function hc(u,f){let x=this||{};return function(){let _=arguments;function E(y,R){let P=Object.assign({},y),U=P.className||E.className;x.p=Object.assign({theme:mE&&mE()},P),x.o=/ *go\d+/.test(U),P.className=vg.apply(x,_)+(U?" "+U:"");let G=u;return u[0]&&(G=P.as||u,delete P.as),fE&&G[0]&&fE(P),C2(G,P)}return E}}var Aq=u=>typeof u=="function",rg=(u,f)=>Aq(u)?u(f):u,Oq=(()=>{let u=0;return()=>(++u).toString()})(),I2=(()=>{let u;return()=>{if(u===void 0&&typeof window<"u"){let f=matchMedia("(prefers-reduced-motion: reduce)");u=!f||f.matches}return u}})(),Dq=20,GE="default",A2=(u,f)=>{let{toastLimit:x}=u.settings;switch(f.type){case 0:return{...u,toasts:[f.toast,...u.toasts].slice(0,x)};case 1:return{...u,toasts:u.toasts.map(R=>R.id===f.toast.id?{...R,...f.toast}:R)};case 2:let{toast:_}=f;return A2(u,{type:u.toasts.find(R=>R.id===_.id)?1:0,toast:_});case 3:let{toastId:E}=f;return{...u,toasts:u.toasts.map(R=>R.id===E||E===void 0?{...R,dismissed:!0,visible:!1}:R)};case 4:return f.toastId===void 0?{...u,toasts:[]}:{...u,toasts:u.toasts.filter(R=>R.id!==f.toastId)};case 5:return{...u,pausedAt:f.time};case 6:let y=f.time-(u.pausedAt||0);return{...u,pausedAt:void 0,toasts:u.toasts.map(R=>({...R,pauseDuration:R.pauseDuration+y}))}}},$f=[],O2={toasts:[],pausedAt:void 0,settings:{toastLimit:Dq}},Xi={},D2=(u,f=GE)=>{Xi[f]=A2(Xi[f]||O2,u),$f.forEach(([x,_])=>{x===f&&_(Xi[f])})},k2=u=>Object.keys(Xi).forEach(f=>D2(u,f)),kq=u=>Object.keys(Xi).find(f=>Xi[f].toasts.some(x=>x.id===u)),Eg=(u=GE)=>f=>{D2(f,u)},jq={blank:4e3,error:4e3,success:2e3,loading:1/0,custom:4e3},Pq=(u={},f=GE)=>{let[x,_]=j.useState(Xi[f]||O2),E=j.useRef(Xi[f]);j.useEffect(()=>(E.current!==Xi[f]&&_(Xi[f]),$f.push([f,_]),()=>{let R=$f.findIndex(([P])=>P===f);R>-1&&$f.splice(R,1)}),[f]);let y=x.toasts.map(R=>{var P,U,G;return{...u,...u[R.type],...R,removeDelay:R.removeDelay||((P=u[R.type])==null?void 0:P.removeDelay)||(u==null?void 0:u.removeDelay),duration:R.duration||((U=u[R.type])==null?void 0:U.duration)||(u==null?void 0:u.duration)||jq[R.type],style:{...u.style,...(G=u[R.type])==null?void 0:G.style,...R.style}}});return{...x,toasts:y}},Lq=(u,f="blank",x)=>({createdAt:Date.now(),visible:!0,dismissed:!1,type:f,ariaProps:{role:"status","aria-live":"polite"},message:u,pauseDuration:0,...x,id:(x==null?void 0:x.id)||Oq()}),Vh=u=>(f,x)=>{let _=Lq(f,u,x);return Eg(_.toasterId||kq(_.id))({type:2,toast:_}),_.id},aa=(u,f)=>Vh("blank")(u,f);aa.error=Vh("error");aa.success=Vh("success");aa.loading=Vh("loading");aa.custom=Vh("custom");aa.dismiss=(u,f)=>{let x={type:3,toastId:u};f?Eg(f)(x):k2(x)};aa.dismissAll=u=>aa.dismiss(void 0,u);aa.remove=(u,f)=>{let x={type:4,toastId:u};f?Eg(f)(x):k2(x)};aa.removeAll=u=>aa.remove(void 0,u);aa.promise=(u,f,x)=>{let _=aa.loading(f.loading,{...x,...x==null?void 0:x.loading});return typeof u=="function"&&(u=u()),u.then(E=>{let y=f.success?rg(f.success,E):void 0;return y?aa.success(y,{id:_,...x,...x==null?void 0:x.success}):aa.dismiss(_),E}).catch(E=>{let y=f.error?rg(f.error,E):void 0;y?aa.error(y,{id:_,...x,...x==null?void 0:x.error}):aa.dismiss(_)}),u};var Mq=1e3,Uq=(u,f="default")=>{let{toasts:x,pausedAt:_}=Pq(u,f),E=j.useRef(new Map).current,y=j.useCallback((k,X=Mq)=>{if(E.has(k))return;let q=setTimeout(()=>{E.delete(k),R({type:4,toastId:k})},X);E.set(k,q)},[]);j.useEffect(()=>{if(_)return;let k=Date.now(),X=x.map(q=>{if(q.duration===1/0)return;let D=(q.duration||0)+q.pauseDuration-(k-q.createdAt);if(D<0){q.visible&&aa.dismiss(q.id);return}return setTimeout(()=>aa.dismiss(q.id,f),D)});return()=>{X.forEach(q=>q&&clearTimeout(q))}},[x,_,f]);let R=j.useCallback(Eg(f),[f]),P=j.useCallback(()=>{R({type:5,time:Date.now()})},[R]),U=j.useCallback((k,X)=>{R({type:1,toast:{id:k,height:X}})},[R]),G=j.useCallback(()=>{_&&R({type:6,time:Date.now()})},[_,R]),F=j.useCallback((k,X)=>{let{reverseOrder:q=!1,gutter:D=8,defaultPosition:H}=X||{},B=x.filter(Z=>(Z.position||H)===(k.position||H)&&Z.height),ne=B.findIndex(Z=>Z.id===k.id),ae=B.filter((Z,te)=>te<ne&&Z.visible).length;return B.filter(Z=>Z.visible).slice(...q?[ae+1]:[0,ae]).reduce((Z,te)=>Z+(te.height||0)+D,0)},[x]);return j.useEffect(()=>{x.forEach(k=>{if(k.dismissed)y(k.id,k.removeDelay);else{let X=E.get(k.id);X&&(clearTimeout(X),E.delete(k.id))}})},[x,y]),{toasts:x,handlers:{updateHeight:U,startPause:P,endPause:G,calculateOffset:F}}},Vq=So`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
 transform: scale(1) rotate(45deg);
  opacity: 1;
}`,Fq=So`
from {
  transform: scale(0);
  opacity: 0;
}
to {
  transform: scale(1);
  opacity: 1;
}`,Bq=So`
from {
  transform: scale(0) rotate(90deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(90deg);
	opacity: 1;
}`,Gq=hc("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${u=>u.primary||"#ff4b4b"};
  position: relative;
  transform: rotate(45deg);

  animation: ${Vq} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;

  &:after,
  &:before {
    content: '';
    animation: ${Fq} 0.15s ease-out forwards;
    animation-delay: 150ms;
    position: absolute;
    border-radius: 3px;
    opacity: 0;
    background: ${u=>u.secondary||"#fff"};
    bottom: 9px;
    left: 4px;
    height: 2px;
    width: 12px;
  }

  &:before {
    animation: ${Bq} 0.15s ease-out forwards;
    animation-delay: 180ms;
    transform: rotate(90deg);
  }
`,Wq=So`
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
`,Hq=hc("div")`
  width: 12px;
  height: 12px;
  box-sizing: border-box;
  border: 2px solid;
  border-radius: 100%;
  border-color: ${u=>u.secondary||"#e0e0e0"};
  border-right-color: ${u=>u.primary||"#616161"};
  animation: ${Wq} 1s linear infinite;
`,zq=So`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(45deg);
	opacity: 1;
}`,Kq=So`
0% {
	height: 0;
	width: 0;
	opacity: 0;
}
40% {
  height: 0;
	width: 6px;
	opacity: 1;
}
100% {
  opacity: 1;
  height: 10px;
}`,Yq=hc("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${u=>u.primary||"#61d345"};
  position: relative;
  transform: rotate(45deg);

  animation: ${zq} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;
  &:after {
    content: '';
    box-sizing: border-box;
    animation: ${Kq} 0.2s ease-out forwards;
    opacity: 0;
    animation-delay: 200ms;
    position: absolute;
    border-right: 2px solid;
    border-bottom: 2px solid;
    border-color: ${u=>u.secondary||"#fff"};
    bottom: 6px;
    left: 6px;
    height: 10px;
    width: 6px;
  }
`,qq=hc("div")`
  position: absolute;
`,Xq=hc("div")`
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: 20px;
  min-height: 20px;
`,Jq=So`
from {
  transform: scale(0.6);
  opacity: 0.4;
}
to {
  transform: scale(1);
  opacity: 1;
}`,$q=hc("div")`
  position: relative;
  transform: scale(0.6);
  opacity: 0.4;
  min-width: 20px;
  animation: ${Jq} 0.3s 0.12s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
`,Qq=({toast:u})=>{let{icon:f,type:x,iconTheme:_}=u;return f!==void 0?typeof f=="string"?j.createElement($q,null,f):f:x==="blank"?null:j.createElement(Xq,null,j.createElement(Hq,{..._}),x!=="loading"&&j.createElement(qq,null,x==="error"?j.createElement(Gq,{..._}):j.createElement(Yq,{..._})))},Zq=u=>`
0% {transform: translate3d(0,${u*-200}%,0) scale(.6); opacity:.5;}
100% {transform: translate3d(0,0,0) scale(1); opacity:1;}
`,eX=u=>`
0% {transform: translate3d(0,0,-1px) scale(1); opacity:1;}
100% {transform: translate3d(0,${u*-150}%,-1px) scale(.6); opacity:0;}
`,tX="0%{opacity:0;} 100%{opacity:1;}",sX="0%{opacity:1;} 100%{opacity:0;}",nX=hc("div")`
  display: flex;
  align-items: center;
  background: #fff;
  color: #363636;
  line-height: 1.3;
  will-change: transform;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1), 0 3px 3px rgba(0, 0, 0, 0.05);
  max-width: 350px;
  pointer-events: auto;
  padding: 8px 10px;
  border-radius: 8px;
`,aX=hc("div")`
  display: flex;
  justify-content: center;
  margin: 4px 10px;
  color: inherit;
  flex: 1 1 auto;
  white-space: pre-line;
`,rX=(u,f)=>{let x=u.includes("top")?1:-1,[_,E]=I2()?[tX,sX]:[Zq(x),eX(x)];return{animation:f?`${So(_)} 0.35s cubic-bezier(.21,1.02,.73,1) forwards`:`${So(E)} 0.4s forwards cubic-bezier(.06,.71,.55,1)`}},iX=j.memo(({toast:u,position:f,style:x,children:_})=>{let E=u.height?rX(u.position||f||"top-center",u.visible):{opacity:0},y=j.createElement(Qq,{toast:u}),R=j.createElement(aX,{...u.ariaProps},rg(u.message,u));return j.createElement(nX,{className:u.className,style:{...E,...x,...u.style}},typeof _=="function"?_({icon:y,message:R}):j.createElement(j.Fragment,null,y,R))});Iq(j.createElement);var oX=({id:u,className:f,style:x,onHeightUpdate:_,children:E})=>{let y=j.useCallback(R=>{if(R){let P=()=>{let U=R.getBoundingClientRect().height;_(u,U)};P(),new MutationObserver(P).observe(R,{subtree:!0,childList:!0,characterData:!0})}},[u,_]);return j.createElement("div",{ref:y,className:f,style:x},E)},cX=(u,f)=>{let x=u.includes("top"),_=x?{top:0}:{bottom:0},E=u.includes("center")?{justifyContent:"center"}:u.includes("right")?{justifyContent:"flex-end"}:{};return{left:0,right:0,display:"flex",position:"absolute",transition:I2()?void 0:"all 230ms cubic-bezier(.21,1.02,.73,1)",transform:`translateY(${f*(x?1:-1)}px)`,..._,...E}},lX=vg`
  z-index: 9999;
  > * {
    pointer-events: auto;
  }
`,Kf=16,dX=({reverseOrder:u,position:f="top-center",toastOptions:x,gutter:_,children:E,toasterId:y,containerStyle:R,containerClassName:P})=>{let{toasts:U,handlers:G}=Uq(x,y);return j.createElement("div",{"data-rht-toaster":y||"",style:{position:"fixed",zIndex:9999,top:Kf,left:Kf,right:Kf,bottom:Kf,pointerEvents:"none",...R},className:P,onMouseEnter:G.startPause,onMouseLeave:G.endPause},U.map(F=>{let k=F.position||f,X=G.calculateOffset(F,{reverseOrder:u,gutter:_,defaultPosition:f}),q=cX(k,X);return j.createElement(oX,{id:F.id,key:F.id,onHeightUpdate:G.updateHeight,className:F.visible?lX:"",style:q},F.type==="custom"?rg(F.message,F):E?E(F):j.createElement(iX,{toast:F,position:k}))}))},Ve=aa;function j2(u,f){return function(){return u.apply(f,arguments)}}const{toString:uX}=Object.prototype,{getPrototypeOf:WE}=Object,{iterator:yg,toStringTag:P2}=Symbol,wg=(u=>f=>{const x=uX.call(f);return u[x]||(u[x]=x.slice(8,-1).toLowerCase())})(Object.create(null)),Ei=u=>(u=u.toLowerCase(),f=>wg(f)===u),Sg=u=>f=>typeof f===u,{isArray:Jd}=Array,Hd=Sg("undefined");function Fh(u){return u!==null&&!Hd(u)&&u.constructor!==null&&!Hd(u.constructor)&&nr(u.constructor.isBuffer)&&u.constructor.isBuffer(u)}const L2=Ei("ArrayBuffer");function hX(u){let f;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?f=ArrayBuffer.isView(u):f=u&&u.buffer&&L2(u.buffer),f}const pX=Sg("string"),nr=Sg("function"),M2=Sg("number"),Bh=u=>u!==null&&typeof u=="object",mX=u=>u===!0||u===!1,Qf=u=>{if(wg(u)!=="object")return!1;const f=WE(u);return(f===null||f===Object.prototype||Object.getPrototypeOf(f)===null)&&!(P2 in u)&&!(yg in u)},fX=u=>{if(!Bh(u)||Fh(u))return!1;try{return Object.keys(u).length===0&&Object.getPrototypeOf(u)===Object.prototype}catch{return!1}},gX=Ei("Date"),xX=Ei("File"),bX=Ei("Blob"),_X=Ei("FileList"),vX=u=>Bh(u)&&nr(u.pipe),EX=u=>{let f;return u&&(typeof FormData=="function"&&u instanceof FormData||nr(u.append)&&((f=wg(u))==="formdata"||f==="object"&&nr(u.toString)&&u.toString()==="[object FormData]"))},yX=Ei("URLSearchParams"),[wX,SX,NX,TX]=["ReadableStream","Request","Response","Headers"].map(Ei),RX=u=>u.trim?u.trim():u.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Gh(u,f,{allOwnKeys:x=!1}={}){if(u===null||typeof u>"u")return;let _,E;if(typeof u!="object"&&(u=[u]),Jd(u))for(_=0,E=u.length;_<E;_++)f.call(null,u[_],_,u);else{if(Fh(u))return;const y=x?Object.getOwnPropertyNames(u):Object.keys(u),R=y.length;let P;for(_=0;_<R;_++)P=y[_],f.call(null,u[P],P,u)}}function U2(u,f){if(Fh(u))return null;f=f.toLowerCase();const x=Object.keys(u);let _=x.length,E;for(;_-- >0;)if(E=x[_],f===E.toLowerCase())return E;return null}const ul=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,V2=u=>!Hd(u)&&u!==ul;function gE(){const{caseless:u,skipUndefined:f}=V2(this)&&this||{},x={},_=(E,y)=>{const R=u&&U2(x,y)||y;Qf(x[R])&&Qf(E)?x[R]=gE(x[R],E):Qf(E)?x[R]=gE({},E):Jd(E)?x[R]=E.slice():(!f||!Hd(E))&&(x[R]=E)};for(let E=0,y=arguments.length;E<y;E++)arguments[E]&&Gh(arguments[E],_);return x}const CX=(u,f,x,{allOwnKeys:_}={})=>(Gh(f,(E,y)=>{x&&nr(E)?u[y]=j2(E,x):u[y]=E},{allOwnKeys:_}),u),IX=u=>(u.charCodeAt(0)===65279&&(u=u.slice(1)),u),AX=(u,f,x,_)=>{u.prototype=Object.create(f.prototype,_),u.prototype.constructor=u,Object.defineProperty(u,"super",{value:f.prototype}),x&&Object.assign(u.prototype,x)},OX=(u,f,x,_)=>{let E,y,R;const P={};if(f=f||{},u==null)return f;do{for(E=Object.getOwnPropertyNames(u),y=E.length;y-- >0;)R=E[y],(!_||_(R,u,f))&&!P[R]&&(f[R]=u[R],P[R]=!0);u=x!==!1&&WE(u)}while(u&&(!x||x(u,f))&&u!==Object.prototype);return f},DX=(u,f,x)=>{u=String(u),(x===void 0||x>u.length)&&(x=u.length),x-=f.length;const _=u.indexOf(f,x);return _!==-1&&_===x},kX=u=>{if(!u)return null;if(Jd(u))return u;let f=u.length;if(!M2(f))return null;const x=new Array(f);for(;f-- >0;)x[f]=u[f];return x},jX=(u=>f=>u&&f instanceof u)(typeof Uint8Array<"u"&&WE(Uint8Array)),PX=(u,f)=>{const _=(u&&u[yg]).call(u);let E;for(;(E=_.next())&&!E.done;){const y=E.value;f.call(u,y[0],y[1])}},LX=(u,f)=>{let x;const _=[];for(;(x=u.exec(f))!==null;)_.push(x);return _},MX=Ei("HTMLFormElement"),UX=u=>u.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(x,_,E){return _.toUpperCase()+E}),yP=(({hasOwnProperty:u})=>(f,x)=>u.call(f,x))(Object.prototype),VX=Ei("RegExp"),F2=(u,f)=>{const x=Object.getOwnPropertyDescriptors(u),_={};Gh(x,(E,y)=>{let R;(R=f(E,y,u))!==!1&&(_[y]=R||E)}),Object.defineProperties(u,_)},FX=u=>{F2(u,(f,x)=>{if(nr(u)&&["arguments","caller","callee"].indexOf(x)!==-1)return!1;const _=u[x];if(nr(_)){if(f.enumerable=!1,"writable"in f){f.writable=!1;return}f.set||(f.set=()=>{throw Error("Can not rewrite read-only method '"+x+"'")})}})},BX=(u,f)=>{const x={},_=E=>{E.forEach(y=>{x[y]=!0})};return Jd(u)?_(u):_(String(u).split(f)),x},GX=()=>{},WX=(u,f)=>u!=null&&Number.isFinite(u=+u)?u:f;function HX(u){return!!(u&&nr(u.append)&&u[P2]==="FormData"&&u[yg])}const zX=u=>{const f=new Array(10),x=(_,E)=>{if(Bh(_)){if(f.indexOf(_)>=0)return;if(Fh(_))return _;if(!("toJSON"in _)){f[E]=_;const y=Jd(_)?[]:{};return Gh(_,(R,P)=>{const U=x(R,E+1);!Hd(U)&&(y[P]=U)}),f[E]=void 0,y}}return _};return x(u,0)},KX=Ei("AsyncFunction"),YX=u=>u&&(Bh(u)||nr(u))&&nr(u.then)&&nr(u.catch),B2=((u,f)=>u?setImmediate:f?((x,_)=>(ul.addEventListener("message",({source:E,data:y})=>{E===ul&&y===x&&_.length&&_.shift()()},!1),E=>{_.push(E),ul.postMessage(x,"*")}))(`axios@${Math.random()}`,[]):x=>setTimeout(x))(typeof setImmediate=="function",nr(ul.postMessage)),qX=typeof queueMicrotask<"u"?queueMicrotask.bind(ul):typeof process<"u"&&process.nextTick||B2,XX=u=>u!=null&&nr(u[yg]),Ie={isArray:Jd,isArrayBuffer:L2,isBuffer:Fh,isFormData:EX,isArrayBufferView:hX,isString:pX,isNumber:M2,isBoolean:mX,isObject:Bh,isPlainObject:Qf,isEmptyObject:fX,isReadableStream:wX,isRequest:SX,isResponse:NX,isHeaders:TX,isUndefined:Hd,isDate:gX,isFile:xX,isBlob:bX,isRegExp:VX,isFunction:nr,isStream:vX,isURLSearchParams:yX,isTypedArray:jX,isFileList:_X,forEach:Gh,merge:gE,extend:CX,trim:RX,stripBOM:IX,inherits:AX,toFlatObject:OX,kindOf:wg,kindOfTest:Ei,endsWith:DX,toArray:kX,forEachEntry:PX,matchAll:LX,isHTMLForm:MX,hasOwnProperty:yP,hasOwnProp:yP,reduceDescriptors:F2,freezeMethods:FX,toObjectSet:BX,toCamelCase:UX,noop:GX,toFiniteNumber:WX,findKey:U2,global:ul,isContextDefined:V2,isSpecCompliantForm:HX,toJSONObject:zX,isAsyncFn:KX,isThenable:YX,setImmediate:B2,asap:qX,isIterable:XX};function cs(u,f,x,_,E){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=u,this.name="AxiosError",f&&(this.code=f),x&&(this.config=x),_&&(this.request=_),E&&(this.response=E,this.status=E.status?E.status:null)}Ie.inherits(cs,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Ie.toJSONObject(this.config),code:this.code,status:this.status}}});const G2=cs.prototype,W2={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(u=>{W2[u]={value:u}});Object.defineProperties(cs,W2);Object.defineProperty(G2,"isAxiosError",{value:!0});cs.from=(u,f,x,_,E,y)=>{const R=Object.create(G2);Ie.toFlatObject(u,R,function(F){return F!==Error.prototype},G=>G!=="isAxiosError");const P=u&&u.message?u.message:"Error",U=f==null&&u?u.code:f;return cs.call(R,P,U,x,_,E),u&&R.cause==null&&Object.defineProperty(R,"cause",{value:u,configurable:!0}),R.name=u&&u.name||"Error",y&&Object.assign(R,y),R};const JX=null;function xE(u){return Ie.isPlainObject(u)||Ie.isArray(u)}function H2(u){return Ie.endsWith(u,"[]")?u.slice(0,-2):u}function wP(u,f,x){return u?u.concat(f).map(function(E,y){return E=H2(E),!x&&y?"["+E+"]":E}).join(x?".":""):f}function $X(u){return Ie.isArray(u)&&!u.some(xE)}const QX=Ie.toFlatObject(Ie,{},null,function(f){return/^is[A-Z]/.test(f)});function Ng(u,f,x){if(!Ie.isObject(u))throw new TypeError("target must be an object");f=f||new FormData,x=Ie.toFlatObject(x,{metaTokens:!0,dots:!1,indexes:!1},!1,function(H,B){return!Ie.isUndefined(B[H])});const _=x.metaTokens,E=x.visitor||F,y=x.dots,R=x.indexes,U=(x.Blob||typeof Blob<"u"&&Blob)&&Ie.isSpecCompliantForm(f);if(!Ie.isFunction(E))throw new TypeError("visitor must be a function");function G(D){if(D===null)return"";if(Ie.isDate(D))return D.toISOString();if(Ie.isBoolean(D))return D.toString();if(!U&&Ie.isBlob(D))throw new cs("Blob is not supported. Use a Buffer instead.");return Ie.isArrayBuffer(D)||Ie.isTypedArray(D)?U&&typeof Blob=="function"?new Blob([D]):Buffer.from(D):D}function F(D,H,B){let ne=D;if(D&&!B&&typeof D=="object"){if(Ie.endsWith(H,"{}"))H=_?H:H.slice(0,-2),D=JSON.stringify(D);else if(Ie.isArray(D)&&$X(D)||(Ie.isFileList(D)||Ie.endsWith(H,"[]"))&&(ne=Ie.toArray(D)))return H=H2(H),ne.forEach(function(Z,te){!(Ie.isUndefined(Z)||Z===null)&&f.append(R===!0?wP([H],te,y):R===null?H:H+"[]",G(Z))}),!1}return xE(D)?!0:(f.append(wP(B,H,y),G(D)),!1)}const k=[],X=Object.assign(QX,{defaultVisitor:F,convertValue:G,isVisitable:xE});function q(D,H){if(!Ie.isUndefined(D)){if(k.indexOf(D)!==-1)throw Error("Circular reference detected in "+H.join("."));k.push(D),Ie.forEach(D,function(ne,ae){(!(Ie.isUndefined(ne)||ne===null)&&E.call(f,ne,Ie.isString(ae)?ae.trim():ae,H,X))===!0&&q(ne,H?H.concat(ae):[ae])}),k.pop()}}if(!Ie.isObject(u))throw new TypeError("data must be an object");return q(u),f}function SP(u){const f={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(u).replace(/[!'()~]|%20|%00/g,function(_){return f[_]})}function HE(u,f){this._pairs=[],u&&Ng(u,this,f)}const z2=HE.prototype;z2.append=function(f,x){this._pairs.push([f,x])};z2.toString=function(f){const x=f?function(_){return f.call(this,_,SP)}:SP;return this._pairs.map(function(E){return x(E[0])+"="+x(E[1])},"").join("&")};function ZX(u){return encodeURIComponent(u).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function K2(u,f,x){if(!f)return u;const _=x&&x.encode||ZX;Ie.isFunction(x)&&(x={serialize:x});const E=x&&x.serialize;let y;if(E?y=E(f,x):y=Ie.isURLSearchParams(f)?f.toString():new HE(f,x).toString(_),y){const R=u.indexOf("#");R!==-1&&(u=u.slice(0,R)),u+=(u.indexOf("?")===-1?"?":"&")+y}return u}class NP{constructor(){this.handlers=[]}use(f,x,_){return this.handlers.push({fulfilled:f,rejected:x,synchronous:_?_.synchronous:!1,runWhen:_?_.runWhen:null}),this.handlers.length-1}eject(f){this.handlers[f]&&(this.handlers[f]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(f){Ie.forEach(this.handlers,function(_){_!==null&&f(_)})}}const Y2={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},eJ=typeof URLSearchParams<"u"?URLSearchParams:HE,tJ=typeof FormData<"u"?FormData:null,sJ=typeof Blob<"u"?Blob:null,nJ={isBrowser:!0,classes:{URLSearchParams:eJ,FormData:tJ,Blob:sJ},protocols:["http","https","file","blob","url","data"]},zE=typeof window<"u"&&typeof document<"u",bE=typeof navigator=="object"&&navigator||void 0,aJ=zE&&(!bE||["ReactNative","NativeScript","NS"].indexOf(bE.product)<0),rJ=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",iJ=zE&&window.location.href||"http://localhost",oJ=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:zE,hasStandardBrowserEnv:aJ,hasStandardBrowserWebWorkerEnv:rJ,navigator:bE,origin:iJ},Symbol.toStringTag,{value:"Module"})),Da={...oJ,...nJ};function cJ(u,f){return Ng(u,new Da.classes.URLSearchParams,{visitor:function(x,_,E,y){return Da.isNode&&Ie.isBuffer(x)?(this.append(_,x.toString("base64")),!1):y.defaultVisitor.apply(this,arguments)},...f})}function lJ(u){return Ie.matchAll(/\w+|\[(\w*)]/g,u).map(f=>f[0]==="[]"?"":f[1]||f[0])}function dJ(u){const f={},x=Object.keys(u);let _;const E=x.length;let y;for(_=0;_<E;_++)y=x[_],f[y]=u[y];return f}function q2(u){function f(x,_,E,y){let R=x[y++];if(R==="__proto__")return!0;const P=Number.isFinite(+R),U=y>=x.length;return R=!R&&Ie.isArray(E)?E.length:R,U?(Ie.hasOwnProp(E,R)?E[R]=[E[R],_]:E[R]=_,!P):((!E[R]||!Ie.isObject(E[R]))&&(E[R]=[]),f(x,_,E[R],y)&&Ie.isArray(E[R])&&(E[R]=dJ(E[R])),!P)}if(Ie.isFormData(u)&&Ie.isFunction(u.entries)){const x={};return Ie.forEachEntry(u,(_,E)=>{f(lJ(_),E,x,0)}),x}return null}function uJ(u,f,x){if(Ie.isString(u))try{return(f||JSON.parse)(u),Ie.trim(u)}catch(_){if(_.name!=="SyntaxError")throw _}return(x||JSON.stringify)(u)}const Wh={transitional:Y2,adapter:["xhr","http","fetch"],transformRequest:[function(f,x){const _=x.getContentType()||"",E=_.indexOf("application/json")>-1,y=Ie.isObject(f);if(y&&Ie.isHTMLForm(f)&&(f=new FormData(f)),Ie.isFormData(f))return E?JSON.stringify(q2(f)):f;if(Ie.isArrayBuffer(f)||Ie.isBuffer(f)||Ie.isStream(f)||Ie.isFile(f)||Ie.isBlob(f)||Ie.isReadableStream(f))return f;if(Ie.isArrayBufferView(f))return f.buffer;if(Ie.isURLSearchParams(f))return x.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),f.toString();let P;if(y){if(_.indexOf("application/x-www-form-urlencoded")>-1)return cJ(f,this.formSerializer).toString();if((P=Ie.isFileList(f))||_.indexOf("multipart/form-data")>-1){const U=this.env&&this.env.FormData;return Ng(P?{"files[]":f}:f,U&&new U,this.formSerializer)}}return y||E?(x.setContentType("application/json",!1),uJ(f)):f}],transformResponse:[function(f){const x=this.transitional||Wh.transitional,_=x&&x.forcedJSONParsing,E=this.responseType==="json";if(Ie.isResponse(f)||Ie.isReadableStream(f))return f;if(f&&Ie.isString(f)&&(_&&!this.responseType||E)){const R=!(x&&x.silentJSONParsing)&&E;try{return JSON.parse(f,this.parseReviver)}catch(P){if(R)throw P.name==="SyntaxError"?cs.from(P,cs.ERR_BAD_RESPONSE,this,null,this.response):P}}return f}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Da.classes.FormData,Blob:Da.classes.Blob},validateStatus:function(f){return f>=200&&f<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Ie.forEach(["delete","get","head","post","put","patch"],u=>{Wh.headers[u]={}});const hJ=Ie.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),pJ=u=>{const f={};let x,_,E;return u&&u.split(`
`).forEach(function(R){E=R.indexOf(":"),x=R.substring(0,E).trim().toLowerCase(),_=R.substring(E+1).trim(),!(!x||f[x]&&hJ[x])&&(x==="set-cookie"?f[x]?f[x].push(_):f[x]=[_]:f[x]=f[x]?f[x]+", "+_:_)}),f},TP=Symbol("internals");function Th(u){return u&&String(u).trim().toLowerCase()}function Zf(u){return u===!1||u==null?u:Ie.isArray(u)?u.map(Zf):String(u)}function mJ(u){const f=Object.create(null),x=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let _;for(;_=x.exec(u);)f[_[1]]=_[2];return f}const fJ=u=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(u.trim());function Jv(u,f,x,_,E){if(Ie.isFunction(_))return _.call(this,f,x);if(E&&(f=x),!!Ie.isString(f)){if(Ie.isString(_))return f.indexOf(_)!==-1;if(Ie.isRegExp(_))return _.test(f)}}function gJ(u){return u.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(f,x,_)=>x.toUpperCase()+_)}function xJ(u,f){const x=Ie.toCamelCase(" "+f);["get","set","has"].forEach(_=>{Object.defineProperty(u,_+x,{value:function(E,y,R){return this[_].call(this,f,E,y,R)},configurable:!0})})}let ar=class{constructor(f){f&&this.set(f)}set(f,x,_){const E=this;function y(P,U,G){const F=Th(U);if(!F)throw new Error("header name must be a non-empty string");const k=Ie.findKey(E,F);(!k||E[k]===void 0||G===!0||G===void 0&&E[k]!==!1)&&(E[k||U]=Zf(P))}const R=(P,U)=>Ie.forEach(P,(G,F)=>y(G,F,U));if(Ie.isPlainObject(f)||f instanceof this.constructor)R(f,x);else if(Ie.isString(f)&&(f=f.trim())&&!fJ(f))R(pJ(f),x);else if(Ie.isObject(f)&&Ie.isIterable(f)){let P={},U,G;for(const F of f){if(!Ie.isArray(F))throw TypeError("Object iterator must return a key-value pair");P[G=F[0]]=(U=P[G])?Ie.isArray(U)?[...U,F[1]]:[U,F[1]]:F[1]}R(P,x)}else f!=null&&y(x,f,_);return this}get(f,x){if(f=Th(f),f){const _=Ie.findKey(this,f);if(_){const E=this[_];if(!x)return E;if(x===!0)return mJ(E);if(Ie.isFunction(x))return x.call(this,E,_);if(Ie.isRegExp(x))return x.exec(E);throw new TypeError("parser must be boolean|regexp|function")}}}has(f,x){if(f=Th(f),f){const _=Ie.findKey(this,f);return!!(_&&this[_]!==void 0&&(!x||Jv(this,this[_],_,x)))}return!1}delete(f,x){const _=this;let E=!1;function y(R){if(R=Th(R),R){const P=Ie.findKey(_,R);P&&(!x||Jv(_,_[P],P,x))&&(delete _[P],E=!0)}}return Ie.isArray(f)?f.forEach(y):y(f),E}clear(f){const x=Object.keys(this);let _=x.length,E=!1;for(;_--;){const y=x[_];(!f||Jv(this,this[y],y,f,!0))&&(delete this[y],E=!0)}return E}normalize(f){const x=this,_={};return Ie.forEach(this,(E,y)=>{const R=Ie.findKey(_,y);if(R){x[R]=Zf(E),delete x[y];return}const P=f?gJ(y):String(y).trim();P!==y&&delete x[y],x[P]=Zf(E),_[P]=!0}),this}concat(...f){return this.constructor.concat(this,...f)}toJSON(f){const x=Object.create(null);return Ie.forEach(this,(_,E)=>{_!=null&&_!==!1&&(x[E]=f&&Ie.isArray(_)?_.join(", "):_)}),x}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([f,x])=>f+": "+x).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(f){return f instanceof this?f:new this(f)}static concat(f,...x){const _=new this(f);return x.forEach(E=>_.set(E)),_}static accessor(f){const _=(this[TP]=this[TP]={accessors:{}}).accessors,E=this.prototype;function y(R){const P=Th(R);_[P]||(xJ(E,R),_[P]=!0)}return Ie.isArray(f)?f.forEach(y):y(f),this}};ar.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);Ie.reduceDescriptors(ar.prototype,({value:u},f)=>{let x=f[0].toUpperCase()+f.slice(1);return{get:()=>u,set(_){this[x]=_}}});Ie.freezeMethods(ar);function $v(u,f){const x=this||Wh,_=f||x,E=ar.from(_.headers);let y=_.data;return Ie.forEach(u,function(P){y=P.call(x,y,E.normalize(),f?f.status:void 0)}),E.normalize(),y}function X2(u){return!!(u&&u.__CANCEL__)}function $d(u,f,x){cs.call(this,u??"canceled",cs.ERR_CANCELED,f,x),this.name="CanceledError"}Ie.inherits($d,cs,{__CANCEL__:!0});function J2(u,f,x){const _=x.config.validateStatus;!x.status||!_||_(x.status)?u(x):f(new cs("Request failed with status code "+x.status,[cs.ERR_BAD_REQUEST,cs.ERR_BAD_RESPONSE][Math.floor(x.status/100)-4],x.config,x.request,x))}function bJ(u){const f=/^([-+\w]{1,25})(:?\/\/|:)/.exec(u);return f&&f[1]||""}function _J(u,f){u=u||10;const x=new Array(u),_=new Array(u);let E=0,y=0,R;return f=f!==void 0?f:1e3,function(U){const G=Date.now(),F=_[y];R||(R=G),x[E]=U,_[E]=G;let k=y,X=0;for(;k!==E;)X+=x[k++],k=k%u;if(E=(E+1)%u,E===y&&(y=(y+1)%u),G-R<f)return;const q=F&&G-F;return q?Math.round(X*1e3/q):void 0}}function vJ(u,f){let x=0,_=1e3/f,E,y;const R=(G,F=Date.now())=>{x=F,E=null,y&&(clearTimeout(y),y=null),u(...G)};return[(...G)=>{const F=Date.now(),k=F-x;k>=_?R(G,F):(E=G,y||(y=setTimeout(()=>{y=null,R(E)},_-k)))},()=>E&&R(E)]}const ig=(u,f,x=3)=>{let _=0;const E=_J(50,250);return vJ(y=>{const R=y.loaded,P=y.lengthComputable?y.total:void 0,U=R-_,G=E(U),F=R<=P;_=R;const k={loaded:R,total:P,progress:P?R/P:void 0,bytes:U,rate:G||void 0,estimated:G&&P&&F?(P-R)/G:void 0,event:y,lengthComputable:P!=null,[f?"download":"upload"]:!0};u(k)},x)},RP=(u,f)=>{const x=u!=null;return[_=>f[0]({lengthComputable:x,total:u,loaded:_}),f[1]]},CP=u=>(...f)=>Ie.asap(()=>u(...f)),EJ=Da.hasStandardBrowserEnv?((u,f)=>x=>(x=new URL(x,Da.origin),u.protocol===x.protocol&&u.host===x.host&&(f||u.port===x.port)))(new URL(Da.origin),Da.navigator&&/(msie|trident)/i.test(Da.navigator.userAgent)):()=>!0,yJ=Da.hasStandardBrowserEnv?{write(u,f,x,_,E,y,R){if(typeof document>"u")return;const P=[`${u}=${encodeURIComponent(f)}`];Ie.isNumber(x)&&P.push(`expires=${new Date(x).toUTCString()}`),Ie.isString(_)&&P.push(`path=${_}`),Ie.isString(E)&&P.push(`domain=${E}`),y===!0&&P.push("secure"),Ie.isString(R)&&P.push(`SameSite=${R}`),document.cookie=P.join("; ")},read(u){if(typeof document>"u")return null;const f=document.cookie.match(new RegExp("(?:^|; )"+u+"=([^;]*)"));return f?decodeURIComponent(f[1]):null},remove(u){this.write(u,"",Date.now()-864e5,"/")}}:{write(){},read(){return null},remove(){}};function wJ(u){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(u)}function SJ(u,f){return f?u.replace(/\/?\/$/,"")+"/"+f.replace(/^\/+/,""):u}function $2(u,f,x){let _=!wJ(f);return u&&(_||x==!1)?SJ(u,f):f}const IP=u=>u instanceof ar?{...u}:u;function ml(u,f){f=f||{};const x={};function _(G,F,k,X){return Ie.isPlainObject(G)&&Ie.isPlainObject(F)?Ie.merge.call({caseless:X},G,F):Ie.isPlainObject(F)?Ie.merge({},F):Ie.isArray(F)?F.slice():F}function E(G,F,k,X){if(Ie.isUndefined(F)){if(!Ie.isUndefined(G))return _(void 0,G,k,X)}else return _(G,F,k,X)}function y(G,F){if(!Ie.isUndefined(F))return _(void 0,F)}function R(G,F){if(Ie.isUndefined(F)){if(!Ie.isUndefined(G))return _(void 0,G)}else return _(void 0,F)}function P(G,F,k){if(k in f)return _(G,F);if(k in u)return _(void 0,G)}const U={url:y,method:y,data:y,baseURL:R,transformRequest:R,transformResponse:R,paramsSerializer:R,timeout:R,timeoutMessage:R,withCredentials:R,withXSRFToken:R,adapter:R,responseType:R,xsrfCookieName:R,xsrfHeaderName:R,onUploadProgress:R,onDownloadProgress:R,decompress:R,maxContentLength:R,maxBodyLength:R,beforeRedirect:R,transport:R,httpAgent:R,httpsAgent:R,cancelToken:R,socketPath:R,responseEncoding:R,validateStatus:P,headers:(G,F,k)=>E(IP(G),IP(F),k,!0)};return Ie.forEach(Object.keys({...u,...f}),function(F){const k=U[F]||E,X=k(u[F],f[F],F);Ie.isUndefined(X)&&k!==P||(x[F]=X)}),x}const Q2=u=>{const f=ml({},u);let{data:x,withXSRFToken:_,xsrfHeaderName:E,xsrfCookieName:y,headers:R,auth:P}=f;if(f.headers=R=ar.from(R),f.url=K2($2(f.baseURL,f.url,f.allowAbsoluteUrls),u.params,u.paramsSerializer),P&&R.set("Authorization","Basic "+btoa((P.username||"")+":"+(P.password?unescape(encodeURIComponent(P.password)):""))),Ie.isFormData(x)){if(Da.hasStandardBrowserEnv||Da.hasStandardBrowserWebWorkerEnv)R.setContentType(void 0);else if(Ie.isFunction(x.getHeaders)){const U=x.getHeaders(),G=["content-type","content-length"];Object.entries(U).forEach(([F,k])=>{G.includes(F.toLowerCase())&&R.set(F,k)})}}if(Da.hasStandardBrowserEnv&&(_&&Ie.isFunction(_)&&(_=_(f)),_||_!==!1&&EJ(f.url))){const U=E&&y&&yJ.read(y);U&&R.set(E,U)}return f},NJ=typeof XMLHttpRequest<"u",TJ=NJ&&function(u){return new Promise(function(x,_){const E=Q2(u);let y=E.data;const R=ar.from(E.headers).normalize();let{responseType:P,onUploadProgress:U,onDownloadProgress:G}=E,F,k,X,q,D;function H(){q&&q(),D&&D(),E.cancelToken&&E.cancelToken.unsubscribe(F),E.signal&&E.signal.removeEventListener("abort",F)}let B=new XMLHttpRequest;B.open(E.method.toUpperCase(),E.url,!0),B.timeout=E.timeout;function ne(){if(!B)return;const Z=ar.from("getAllResponseHeaders"in B&&B.getAllResponseHeaders()),ie={data:!P||P==="text"||P==="json"?B.responseText:B.response,status:B.status,statusText:B.statusText,headers:Z,config:u,request:B};J2(function(Ne){x(Ne),H()},function(Ne){_(Ne),H()},ie),B=null}"onloadend"in B?B.onloadend=ne:B.onreadystatechange=function(){!B||B.readyState!==4||B.status===0&&!(B.responseURL&&B.responseURL.indexOf("file:")===0)||setTimeout(ne)},B.onabort=function(){B&&(_(new cs("Request aborted",cs.ECONNABORTED,u,B)),B=null)},B.onerror=function(te){const ie=te&&te.message?te.message:"Network Error",ue=new cs(ie,cs.ERR_NETWORK,u,B);ue.event=te||null,_(ue),B=null},B.ontimeout=function(){let te=E.timeout?"timeout of "+E.timeout+"ms exceeded":"timeout exceeded";const ie=E.transitional||Y2;E.timeoutErrorMessage&&(te=E.timeoutErrorMessage),_(new cs(te,ie.clarifyTimeoutError?cs.ETIMEDOUT:cs.ECONNABORTED,u,B)),B=null},y===void 0&&R.setContentType(null),"setRequestHeader"in B&&Ie.forEach(R.toJSON(),function(te,ie){B.setRequestHeader(ie,te)}),Ie.isUndefined(E.withCredentials)||(B.withCredentials=!!E.withCredentials),P&&P!=="json"&&(B.responseType=E.responseType),G&&([X,D]=ig(G,!0),B.addEventListener("progress",X)),U&&B.upload&&([k,q]=ig(U),B.upload.addEventListener("progress",k),B.upload.addEventListener("loadend",q)),(E.cancelToken||E.signal)&&(F=Z=>{B&&(_(!Z||Z.type?new $d(null,u,B):Z),B.abort(),B=null)},E.cancelToken&&E.cancelToken.subscribe(F),E.signal&&(E.signal.aborted?F():E.signal.addEventListener("abort",F)));const ae=bJ(E.url);if(ae&&Da.protocols.indexOf(ae)===-1){_(new cs("Unsupported protocol "+ae+":",cs.ERR_BAD_REQUEST,u));return}B.send(y||null)})},RJ=(u,f)=>{const{length:x}=u=u?u.filter(Boolean):[];if(f||x){let _=new AbortController,E;const y=function(G){if(!E){E=!0,P();const F=G instanceof Error?G:this.reason;_.abort(F instanceof cs?F:new $d(F instanceof Error?F.message:F))}};let R=f&&setTimeout(()=>{R=null,y(new cs(`timeout ${f} of ms exceeded`,cs.ETIMEDOUT))},f);const P=()=>{u&&(R&&clearTimeout(R),R=null,u.forEach(G=>{G.unsubscribe?G.unsubscribe(y):G.removeEventListener("abort",y)}),u=null)};u.forEach(G=>G.addEventListener("abort",y));const{signal:U}=_;return U.unsubscribe=()=>Ie.asap(P),U}},CJ=function*(u,f){let x=u.byteLength;if(x<f){yield u;return}let _=0,E;for(;_<x;)E=_+f,yield u.slice(_,E),_=E},IJ=async function*(u,f){for await(const x of AJ(u))yield*CJ(x,f)},AJ=async function*(u){if(u[Symbol.asyncIterator]){yield*u;return}const f=u.getReader();try{for(;;){const{done:x,value:_}=await f.read();if(x)break;yield _}}finally{await f.cancel()}},AP=(u,f,x,_)=>{const E=IJ(u,f);let y=0,R,P=U=>{R||(R=!0,_&&_(U))};return new ReadableStream({async pull(U){try{const{done:G,value:F}=await E.next();if(G){P(),U.close();return}let k=F.byteLength;if(x){let X=y+=k;x(X)}U.enqueue(new Uint8Array(F))}catch(G){throw P(G),G}},cancel(U){return P(U),E.return()}},{highWaterMark:2})},OP=64*1024,{isFunction:Yf}=Ie,OJ=(({Request:u,Response:f})=>({Request:u,Response:f}))(Ie.global),{ReadableStream:DP,TextEncoder:kP}=Ie.global,jP=(u,...f)=>{try{return!!u(...f)}catch{return!1}},DJ=u=>{u=Ie.merge.call({skipUndefined:!0},OJ,u);const{fetch:f,Request:x,Response:_}=u,E=f?Yf(f):typeof fetch=="function",y=Yf(x),R=Yf(_);if(!E)return!1;const P=E&&Yf(DP),U=E&&(typeof kP=="function"?(D=>H=>D.encode(H))(new kP):async D=>new Uint8Array(await new x(D).arrayBuffer())),G=y&&P&&jP(()=>{let D=!1;const H=new x(Da.origin,{body:new DP,method:"POST",get duplex(){return D=!0,"half"}}).headers.has("Content-Type");return D&&!H}),F=R&&P&&jP(()=>Ie.isReadableStream(new _("").body)),k={stream:F&&(D=>D.body)};E&&["text","arrayBuffer","blob","formData","stream"].forEach(D=>{!k[D]&&(k[D]=(H,B)=>{let ne=H&&H[D];if(ne)return ne.call(H);throw new cs(`Response type '${D}' is not supported`,cs.ERR_NOT_SUPPORT,B)})});const X=async D=>{if(D==null)return 0;if(Ie.isBlob(D))return D.size;if(Ie.isSpecCompliantForm(D))return(await new x(Da.origin,{method:"POST",body:D}).arrayBuffer()).byteLength;if(Ie.isArrayBufferView(D)||Ie.isArrayBuffer(D))return D.byteLength;if(Ie.isURLSearchParams(D)&&(D=D+""),Ie.isString(D))return(await U(D)).byteLength},q=async(D,H)=>{const B=Ie.toFiniteNumber(D.getContentLength());return B??X(H)};return async D=>{let{url:H,method:B,data:ne,signal:ae,cancelToken:Z,timeout:te,onDownloadProgress:ie,onUploadProgress:ue,responseType:Ne,headers:be,withCredentials:Q="same-origin",fetchOptions:pe}=Q2(D),he=f||fetch;Ne=Ne?(Ne+"").toLowerCase():"text";let Ae=RJ([ae,Z&&Z.toAbortSignal()],te),fe=null;const le=Ae&&Ae.unsubscribe&&(()=>{Ae.unsubscribe()});let we;try{if(ue&&G&&B!=="get"&&B!=="head"&&(we=await q(be,ne))!==0){let He=new x(H,{method:"POST",body:ne,duplex:"half"}),ot;if(Ie.isFormData(ne)&&(ot=He.headers.get("content-type"))&&be.setContentType(ot),He.body){const[_t,Ke]=RP(we,ig(CP(ue)));ne=AP(He.body,OP,_t,Ke)}}Ie.isString(Q)||(Q=Q?"include":"omit");const re=y&&"credentials"in x.prototype,oe={...pe,signal:Ae,method:B.toUpperCase(),headers:be.normalize().toJSON(),body:ne,duplex:"half",credentials:re?Q:void 0};fe=y&&new x(H,oe);let J=await(y?he(fe,pe):he(H,oe));const Oe=F&&(Ne==="stream"||Ne==="response");if(F&&(ie||Oe&&le)){const He={};["status","statusText","headers"].forEach(ht=>{He[ht]=J[ht]});const ot=Ie.toFiniteNumber(J.headers.get("content-length")),[_t,Ke]=ie&&RP(ot,ig(CP(ie),!0))||[];J=new _(AP(J.body,OP,_t,()=>{Ke&&Ke(),le&&le()}),He)}Ne=Ne||"text";let $e=await k[Ie.findKey(k,Ne)||"text"](J,D);return!Oe&&le&&le(),await new Promise((He,ot)=>{J2(He,ot,{data:$e,headers:ar.from(J.headers),status:J.status,statusText:J.statusText,config:D,request:fe})})}catch(re){throw le&&le(),re&&re.name==="TypeError"&&/Load failed|fetch/i.test(re.message)?Object.assign(new cs("Network Error",cs.ERR_NETWORK,D,fe),{cause:re.cause||re}):cs.from(re,re&&re.code,D,fe)}}},kJ=new Map,Z2=u=>{let f=u&&u.env||{};const{fetch:x,Request:_,Response:E}=f,y=[_,E,x];let R=y.length,P=R,U,G,F=kJ;for(;P--;)U=y[P],G=F.get(U),G===void 0&&F.set(U,G=P?new Map:DJ(f)),F=G;return G};Z2();const KE={http:JX,xhr:TJ,fetch:{get:Z2}};Ie.forEach(KE,(u,f)=>{if(u){try{Object.defineProperty(u,"name",{value:f})}catch{}Object.defineProperty(u,"adapterName",{value:f})}});const PP=u=>`- ${u}`,jJ=u=>Ie.isFunction(u)||u===null||u===!1;function PJ(u,f){u=Ie.isArray(u)?u:[u];const{length:x}=u;let _,E;const y={};for(let R=0;R<x;R++){_=u[R];let P;if(E=_,!jJ(_)&&(E=KE[(P=String(_)).toLowerCase()],E===void 0))throw new cs(`Unknown adapter '${P}'`);if(E&&(Ie.isFunction(E)||(E=E.get(f))))break;y[P||"#"+R]=E}if(!E){const R=Object.entries(y).map(([U,G])=>`adapter ${U} `+(G===!1?"is not supported by the environment":"is not available in the build"));let P=x?R.length>1?`since :
`+R.map(PP).join(`
`):" "+PP(R[0]):"as no adapter specified";throw new cs("There is no suitable adapter to dispatch the request "+P,"ERR_NOT_SUPPORT")}return E}const eL={getAdapter:PJ,adapters:KE};function Qv(u){if(u.cancelToken&&u.cancelToken.throwIfRequested(),u.signal&&u.signal.aborted)throw new $d(null,u)}function LP(u){return Qv(u),u.headers=ar.from(u.headers),u.data=$v.call(u,u.transformRequest),["post","put","patch"].indexOf(u.method)!==-1&&u.headers.setContentType("application/x-www-form-urlencoded",!1),eL.getAdapter(u.adapter||Wh.adapter,u)(u).then(function(_){return Qv(u),_.data=$v.call(u,u.transformResponse,_),_.headers=ar.from(_.headers),_},function(_){return X2(_)||(Qv(u),_&&_.response&&(_.response.data=$v.call(u,u.transformResponse,_.response),_.response.headers=ar.from(_.response.headers))),Promise.reject(_)})}const tL="1.13.2",Tg={};["object","boolean","number","function","string","symbol"].forEach((u,f)=>{Tg[u]=function(_){return typeof _===u||"a"+(f<1?"n ":" ")+u}});const MP={};Tg.transitional=function(f,x,_){function E(y,R){return"[Axios v"+tL+"] Transitional option '"+y+"'"+R+(_?". "+_:"")}return(y,R,P)=>{if(f===!1)throw new cs(E(R," has been removed"+(x?" in "+x:"")),cs.ERR_DEPRECATED);return x&&!MP[R]&&(MP[R]=!0,console.warn(E(R," has been deprecated since v"+x+" and will be removed in the near future"))),f?f(y,R,P):!0}};Tg.spelling=function(f){return(x,_)=>(console.warn(`${_} is likely a misspelling of ${f}`),!0)};function LJ(u,f,x){if(typeof u!="object")throw new cs("options must be an object",cs.ERR_BAD_OPTION_VALUE);const _=Object.keys(u);let E=_.length;for(;E-- >0;){const y=_[E],R=f[y];if(R){const P=u[y],U=P===void 0||R(P,y,u);if(U!==!0)throw new cs("option "+y+" must be "+U,cs.ERR_BAD_OPTION_VALUE);continue}if(x!==!0)throw new cs("Unknown option "+y,cs.ERR_BAD_OPTION)}}const eg={assertOptions:LJ,validators:Tg},zi=eg.validators;let pl=class{constructor(f){this.defaults=f||{},this.interceptors={request:new NP,response:new NP}}async request(f,x){try{return await this._request(f,x)}catch(_){if(_ instanceof Error){let E={};Error.captureStackTrace?Error.captureStackTrace(E):E=new Error;const y=E.stack?E.stack.replace(/^.+\n/,""):"";try{_.stack?y&&!String(_.stack).endsWith(y.replace(/^.+\n.+\n/,""))&&(_.stack+=`
`+y):_.stack=y}catch{}}throw _}}_request(f,x){typeof f=="string"?(x=x||{},x.url=f):x=f||{},x=ml(this.defaults,x);const{transitional:_,paramsSerializer:E,headers:y}=x;_!==void 0&&eg.assertOptions(_,{silentJSONParsing:zi.transitional(zi.boolean),forcedJSONParsing:zi.transitional(zi.boolean),clarifyTimeoutError:zi.transitional(zi.boolean)},!1),E!=null&&(Ie.isFunction(E)?x.paramsSerializer={serialize:E}:eg.assertOptions(E,{encode:zi.function,serialize:zi.function},!0)),x.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?x.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:x.allowAbsoluteUrls=!0),eg.assertOptions(x,{baseUrl:zi.spelling("baseURL"),withXsrfToken:zi.spelling("withXSRFToken")},!0),x.method=(x.method||this.defaults.method||"get").toLowerCase();let R=y&&Ie.merge(y.common,y[x.method]);y&&Ie.forEach(["delete","get","head","post","put","patch","common"],D=>{delete y[D]}),x.headers=ar.concat(R,y);const P=[];let U=!0;this.interceptors.request.forEach(function(H){typeof H.runWhen=="function"&&H.runWhen(x)===!1||(U=U&&H.synchronous,P.unshift(H.fulfilled,H.rejected))});const G=[];this.interceptors.response.forEach(function(H){G.push(H.fulfilled,H.rejected)});let F,k=0,X;if(!U){const D=[LP.bind(this),void 0];for(D.unshift(...P),D.push(...G),X=D.length,F=Promise.resolve(x);k<X;)F=F.then(D[k++],D[k++]);return F}X=P.length;let q=x;for(;k<X;){const D=P[k++],H=P[k++];try{q=D(q)}catch(B){H.call(this,B);break}}try{F=LP.call(this,q)}catch(D){return Promise.reject(D)}for(k=0,X=G.length;k<X;)F=F.then(G[k++],G[k++]);return F}getUri(f){f=ml(this.defaults,f);const x=$2(f.baseURL,f.url,f.allowAbsoluteUrls);return K2(x,f.params,f.paramsSerializer)}};Ie.forEach(["delete","get","head","options"],function(f){pl.prototype[f]=function(x,_){return this.request(ml(_||{},{method:f,url:x,data:(_||{}).data}))}});Ie.forEach(["post","put","patch"],function(f){function x(_){return function(y,R,P){return this.request(ml(P||{},{method:f,headers:_?{"Content-Type":"multipart/form-data"}:{},url:y,data:R}))}}pl.prototype[f]=x(),pl.prototype[f+"Form"]=x(!0)});let MJ=class sL{constructor(f){if(typeof f!="function")throw new TypeError("executor must be a function.");let x;this.promise=new Promise(function(y){x=y});const _=this;this.promise.then(E=>{if(!_._listeners)return;let y=_._listeners.length;for(;y-- >0;)_._listeners[y](E);_._listeners=null}),this.promise.then=E=>{let y;const R=new Promise(P=>{_.subscribe(P),y=P}).then(E);return R.cancel=function(){_.unsubscribe(y)},R},f(function(y,R,P){_.reason||(_.reason=new $d(y,R,P),x(_.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(f){if(this.reason){f(this.reason);return}this._listeners?this._listeners.push(f):this._listeners=[f]}unsubscribe(f){if(!this._listeners)return;const x=this._listeners.indexOf(f);x!==-1&&this._listeners.splice(x,1)}toAbortSignal(){const f=new AbortController,x=_=>{f.abort(_)};return this.subscribe(x),f.signal.unsubscribe=()=>this.unsubscribe(x),f.signal}static source(){let f;return{token:new sL(function(E){f=E}),cancel:f}}};function UJ(u){return function(x){return u.apply(null,x)}}function VJ(u){return Ie.isObject(u)&&u.isAxiosError===!0}const _E={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(_E).forEach(([u,f])=>{_E[f]=u});function nL(u){const f=new pl(u),x=j2(pl.prototype.request,f);return Ie.extend(x,pl.prototype,f,{allOwnKeys:!0}),Ie.extend(x,f,null,{allOwnKeys:!0}),x.create=function(E){return nL(ml(u,E))},x}const ks=nL(Wh);ks.Axios=pl;ks.CanceledError=$d;ks.CancelToken=MJ;ks.isCancel=X2;ks.VERSION=tL;ks.toFormData=Ng;ks.AxiosError=cs;ks.Cancel=ks.CanceledError;ks.all=function(f){return Promise.all(f)};ks.spread=UJ;ks.isAxiosError=VJ;ks.mergeConfig=ml;ks.AxiosHeaders=ar;ks.formToJSON=u=>q2(Ie.isHTMLForm(u)?new FormData(u):u);ks.getAdapter=eL.getAdapter;ks.HttpStatusCode=_E;ks.default=ks;const{Axios:mee,AxiosError:fee,CanceledError:gee,isCancel:xee,CancelToken:bee,VERSION:_ee,all:vee,Cancel:Eee,isAxiosError:yee,spread:wee,toFormData:See,AxiosHeaders:Nee,HttpStatusCode:Tee,formToJSON:Ree,getAdapter:Cee,mergeConfig:Iee}=ks,Rh="healthai_cache_",FJ=5*60*1e3,Yi={set(u,f,x=FJ){try{const _={value:f,expiry:Date.now()+x};localStorage.setItem(Rh+u,JSON.stringify(_))}catch(_){console.error("Cache set error:",_)}},get(u){try{const f=localStorage.getItem(Rh+u);if(!f)return null;const x=JSON.parse(f);return Date.now()>x.expiry?(this.delete(u),null):x.value}catch(f){return console.error("Cache get error:",f),null}},delete(u){try{localStorage.removeItem(Rh+u)}catch(f){console.error("Cache delete error:",f)}},clear(){try{Object.keys(localStorage).forEach(f=>{f.startsWith(Rh)&&localStorage.removeItem(f)})}catch(u){console.error("Cache clear error:",u)}},cleanup(){try{Object.keys(localStorage).forEach(f=>{if(f.startsWith(Rh)){const x=localStorage.getItem(f);if(x){const _=JSON.parse(x);Date.now()>_.expiry&&localStorage.removeItem(f)}}})}catch(u){console.error("Cache cleanup error:",u)}}};Yi.cleanup();setInterval(()=>Yi.cleanup(),5*60*1e3);const BJ=()=>"/api",et=ks.create({baseURL:BJ(),headers:{"Content-Type":"application/json"}});console.log(" API Configuration:",{baseURL:et.defaults.baseURL,hostname:window.location.hostname,isProd:!0,isDev:!1,mode:"production"});et.interceptors.request.use(u=>{const f=localStorage.getItem("token");return f&&(u.headers.Authorization=`Bearer ${f}`),u});et.interceptors.response.use(u=>u,u=>{var x,_,E;const f=(x=u.config)==null?void 0:x.skipAutoLogout;return((_=u.response)==null?void 0:_.status)===401&&!f?(console.log("401 Unauthorized - Logging out"),localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/login"):((E=u.response)==null?void 0:E.status)===401&&f&&console.log("401 Unauthorized - Skipping auto-logout (skipAutoLogout flag set)"),u.response||console.error("Network Error:",{message:u.message,apiUrl:et.defaults.baseURL,currentHost:window.location.hostname,currentPort:window.location.port}),Promise.reject(u)});const qr={uploadReport:u=>et.post("/health/upload",u,{headers:{"Content-Type":"multipart/form-data"}}),getReports:()=>et.get("/health/reports"),getReport:u=>et.get(`/health/reports/${u}`),deleteReport:u=>et.delete(`/health/reports/${u}`),getDashboard:()=>et.get("/health/dashboard"),getHistory:u=>et.get("/health/history",{params:{reportType:u}}),compareReport:u=>et.get(`/health/reports/${u}/compare`),chatAboutReport:(u,f,x)=>et.post(`/health/reports/${u}/chat`,{message:f,chatHistory:x}),askAI:u=>et.post("/health/ai-chat",u),getMetricInfo:u=>et.post("/health/metric-info",u)},sr={getAll:u=>et.get("/doctors",{params:u}),getById:u=>et.get(`/doctors/${u}`),getRecommended:u=>et.get("/doctors/recommended",{params:{specializations:u}}),bookAppointment:u=>et.post("/doctors/book",u),getAppointments:()=>et.get("/doctors/appointments"),getAppointment:u=>et.get(`/doctors/appointments/${u}`),startConsultation:u=>et.post(`/doctors/appointments/${u}/start`),endConsultation:u=>et.post(`/doctors/appointments/${u}/end`),getConsultationSummary:u=>et.get(`/doctors/appointments/${u}/summary`),submitReview:(u,f)=>et.post(`/doctors/appointments/${u}/review`,f),downloadPrescription:u=>et.get(`/doctors/appointments/${u}/prescription`,{responseType:"blob"}),getDashboard:()=>et.get("/doctors/me/dashboard"),getMyProfile:()=>et.get("/doctors/me/profile"),updateMyProfile:u=>et.put("/doctors/me/profile",u),getMyAppointments:u=>et.get("/doctors/me/appointments",{params:u}),updateAppointmentStatus:(u,f)=>et.patch(`/doctors/me/appointments/${u}`,f),getPatientProfile:(u,f)=>et.get(`/doctors/patient/${u}`,{params:{appointmentId:f}}),getDoctorAppointments:(u,f)=>et.get(`/doctors/${u}/appointments`,{params:{status:f}}),getMyAvailability:()=>et.get("/doctors/me/availability"),updateMyAvailability:u=>et.put("/doctors/me/availability",u),generateTimeSlots:()=>et.post("/doctors/me/generate-slots"),getDoctorAvailableSlots:(u,f)=>et.get(`/doctors/${u}/available-slots`,{params:{date:f}}),checkSlotAvailability:(u,f,x)=>et.get(`/doctors/${u}/check-slot`,{params:{date:f,timeSlot:x}})},Ud={connectDevice:(u,f)=>et.post("/wearables/connect",{deviceType:u,deviceName:f}),disconnectDevice:u=>et.post(`/wearables/disconnect/${u}`),getDevices:()=>et.get("/wearables/devices"),syncMetrics:(u,f)=>et.post("/wearables/sync",{deviceType:u,metrics:f}),addHeartRate:(u,f,x)=>et.post("/wearables/heart-rate",{deviceType:u,bpm:f,type:x}),addSleepData:(u,f)=>et.post("/wearables/sleep",{deviceType:u,sleepData:f}),getDashboard:()=>et.get("/wearables/dashboard"),generateDemoData:u=>et.post("/wearables/demo-data",{deviceType:u})},tg={getStats:()=>et.get("/admin/stats"),getUsers:u=>et.get("/admin/users",{params:u}),getUserDetails:u=>et.get(`/admin/users/${u}`),updateUserStatus:(u,f)=>et.patch(`/admin/users/${u}/status`,{isActive:f}),getReports:u=>et.get("/admin/reports",{params:u}),getDeficiencyRules:()=>et.get("/admin/deficiency-rules"),createDeficiencyRule:u=>et.post("/admin/deficiency-rules",u),updateDeficiencyRule:(u,f)=>et.put(`/admin/deficiency-rules/${u}`,f),deleteDeficiencyRule:u=>et.delete(`/admin/deficiency-rules/${u}`),getSupplements:()=>et.get("/admin/supplements"),createSupplement:u=>et.post("/admin/supplements",u),updateSupplement:(u,f)=>et.put(`/admin/supplements/${u}`,f),deleteSupplement:u=>et.delete(`/admin/supplements/${u}`),getDietPlans:u=>et.get("/admin/diet-plans",{params:u}),createDietPlan:u=>et.post("/admin/diet-plans",u),updateDietPlan:(u,f)=>et.put(`/admin/diet-plans/${u}`,f),approveDietPlan:(u,f)=>et.patch(`/admin/diet-plans/${u}/approve`,{status:f}),deleteDietPlan:u=>et.delete(`/admin/diet-plans/${u}`),getDoctors:u=>et.get("/admin/doctors",{params:u}),createDoctor:u=>et.post("/admin/doctors",u),updateDoctor:(u,f)=>et.put(`/admin/doctors/${u}`,f),approveDoctor:u=>et.patch(`/admin/doctors/${u}/approve`),rejectDoctor:(u,f)=>et.patch(`/admin/doctors/${u}/reject`,{reason:f}),deleteDoctor:u=>et.delete(`/admin/doctors/${u}`),toggleDoctorVisibility:u=>et.patch(`/admin/doctors/${u}/visibility`),getDoctorScheduleOverview:u=>et.get(`/admin/doctors/${u}/schedule-overview`)},GJ={getSubscription:()=>et.get("/auth/subscription")},WJ={analyzeFood:u=>et.post("/nutrition/analyze-food",{foodDescription:u}),logMeal:u=>et.post("/nutrition/log-meal",u),getTodayLogs:()=>et.get("/nutrition/logs/today"),getDailySummary:u=>et.get("/nutrition/summary/daily",{params:{date:u}}),getGoals:()=>et.get("/nutrition/goals"),updateGoals:u=>et.put("/nutrition/goals",u)},aL=j.createContext(),ia=()=>j.useContext(aL),HJ=({children:u})=>{const[f,x]=j.useState(null),[_,E]=j.useState(!0);j.useEffect(()=>{const H=localStorage.getItem("token"),B=localStorage.getItem("user");H&&B&&(x(JSON.parse(B)),et.defaults.headers.common.Authorization=`Bearer ${H}`),E(!1)},[]);const y=async(H,B)=>{const ae=H.includes("@")?{email:H,password:B}:{phone:H,password:B},{data:Z}=await et.post("/auth/login",ae);return localStorage.setItem("token",Z.token),localStorage.setItem("user",JSON.stringify(Z)),et.defaults.headers.common.Authorization=`Bearer ${Z.token}`,x(Z),Z},R=async(H,B,ne,ae={},Z=null)=>{const{data:te}=await et.post("/auth/register",{name:H,email:B,password:ne,profile:ae,nutritionGoal:Z});return localStorage.setItem("token",te.token),localStorage.setItem("user",JSON.stringify(te)),et.defaults.headers.common.Authorization=`Bearer ${te.token}`,x(te),te},P=async H=>{const{data:B}=await et.post("/auth/register/doctor",H);return localStorage.setItem("token",B.token),localStorage.setItem("user",JSON.stringify(B)),et.defaults.headers.common.Authorization=`Bearer ${B.token}`,x(B),B},U=()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),delete et.defaults.headers.common.Authorization,x(null)},G=H=>{x(H),localStorage.setItem("user",JSON.stringify(H))},F=()=>(f==null?void 0:f.role)==="admin",k=()=>(f==null?void 0:f.role)==="doctor",X=()=>(f==null?void 0:f.role)==="patient"||(f==null?void 0:f.role)==="client",q=()=>{var H;return((H=f==null?void 0:f.doctorProfile)==null?void 0:H.approvalStatus)==="approved"},D=()=>{var H;return((H=f==null?void 0:f.subscription)==null?void 0:H.status)==="active"};return a.jsx(aL.Provider,{value:{user:f,login:y,register:R,registerDoctor:P,logout:U,updateUser:G,loading:_,isAdmin:F,isDoctor:k,isPatient:X,isDoctorApproved:q,isSubscribed:D},children:u})};function zJ(){const[u,f]=j.useState(""),[x,_]=j.useState({x:0,y:0}),[E,y]=j.useState(!1),R=Ga();j.useEffect(()=>{const U=()=>{const G=window.getSelection(),F=G.toString().trim();if(F.length>0){const X=G.getRangeAt(0).getBoundingClientRect();f(F),_({x:X.left+X.width/2,y:X.top-10}),y(!0)}else y(!1)};return document.addEventListener("mouseup",U),document.addEventListener("touchend",U),()=>{document.removeEventListener("mouseup",U),document.removeEventListener("touchend",U)}},[]);const P=()=>{R("/ai-chat",{state:{selectedText:u}}),y(!1)};return E?a.jsx("div",{className:"fixed z-50 animate-fade-in",style:{left:`${x.x}px`,top:`${x.y}px`,transform:"translate(-50%, -100%)"},children:a.jsxs("button",{onClick:P,className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg shadow-lg hover:shadow-xl transition-all text-sm font-medium",children:[a.jsx(Mh,{className:"w-4 h-4"}),"Ask AI"]})}):null}function KJ(){var X,q;const u=hg(),f=Ga(),{user:x,logout:_}=ia(),[E,y]=j.useState(!1),[R,P]=j.useState(!1);j.useEffect(()=>{const D=()=>{const ne=document.querySelectorAll(".fixed");let ae=!1;ne.forEach(Z=>{const te=Z.className,ie=te.includes("bg-black")||te.includes("inset-0"),ue=te.includes("z-50")||te.includes("z-40");ie&&ue&&Z.offsetHeight>0&&(ae=!0)}),u.pathname==="/ai-chat"&&(ae=!0),P(ae||E)};D();const H=setTimeout(D,100),B=new MutationObserver(D);return B.observe(document.body,{childList:!0,subtree:!0}),()=>{clearTimeout(H),B.disconnect()}},[u.pathname,E]);const U=[{path:"/dashboard",icon:pg,label:"Home"},{path:"/nutrition",icon:ms,label:"Nutrition"},{path:"/quick-food-scan",icon:l2,label:"Scan Food",isCenter:!0},{path:"/upload",icon:un,label:"Reports"}],G=[{path:"/profile",icon:Kd,label:"Profile"},{path:"/diet-plan",icon:zn,label:"Diet Plan"},{path:"/wearables",icon:_o,label:"Wearables",comingSoon:!0},{path:"#appointment",icon:Pn,label:"Appointment",comingSoon:!0}],F=D=>u.pathname===D,k=()=>{_(),Ve.success("Logged out successfully"),f("/login"),y(!1)};return a.jsxs(a.Fragment,{children:[E&&a.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 md:hidden",onClick:()=>y(!1)}),E&&a.jsxs("div",{className:"fixed bottom-24 right-4 left-4 sm:left-auto sm:w-72 bg-gradient-to-br from-white to-cyan-50 rounded-3xl shadow-2xl z-50 overflow-hidden animate-fade-in border-2 border-cyan-200",children:[a.jsx("div",{className:"p-5 bg-gradient-to-r from-cyan-500 to-blue-500",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"font-bold text-white text-lg",children:"Menu"}),a.jsx("button",{onClick:()=>y(!1),className:"text-white hover:bg-white/20 rounded-full p-1.5 transition-colors",children:a.jsx(ra,{className:"w-5 h-5"})})]})}),a.jsxs("div",{className:"space-y-1 p-3",children:[G.map(D=>{const H=D.icon,B=F(D.path);return D.comingSoon?a.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-3.5 text-slate-500 bg-slate-50 rounded-xl opacity-60 cursor-not-allowed text-sm",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-slate-200 flex items-center justify-center",children:a.jsx(H,{className:"w-5 h-5"})}),a.jsx("span",{className:"font-medium",children:D.label})]}),a.jsx("span",{className:"text-xs bg-amber-100 text-amber-700 px-2.5 py-1 rounded-full font-semibold",children:"Soon"})]},D.label):D.path==="#appointment"?a.jsxs("button",{onClick:()=>{Ve.info("Appointment coming soon"),y(!1)},className:"w-full flex items-center gap-3 px-4 py-3.5 text-slate-700 hover:bg-cyan-50 rounded-xl transition-all text-sm group",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-cyan-100 flex items-center justify-center group-hover:bg-cyan-200 transition-colors",children:a.jsx(H,{className:"w-5 h-5 text-cyan-600"})}),a.jsx("span",{className:"font-medium",children:D.label})]},D.label):a.jsxs(Rt,{to:D.path,onClick:()=>y(!1),className:`flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all text-sm group ${B?"bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg":"text-slate-700 hover:bg-cyan-50"}`,children:[a.jsx("div",{className:`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${B?"bg-white/20":"bg-cyan-100 group-hover:bg-cyan-200"}`,children:a.jsx(H,{className:`w-5 h-5 ${B?"text-white":"text-cyan-600"}`})}),a.jsx("span",{className:"font-medium",children:D.label})]},D.path)}),a.jsx("div",{className:"border-t-2 border-cyan-100 my-3"}),a.jsxs("div",{className:"px-4 py-2 flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold",children:(q=(X=x==null?void 0:x.name)==null?void 0:X[0])==null?void 0:q.toUpperCase()}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-semibold text-slate-800 truncate",children:x==null?void 0:x.name}),a.jsx("p",{className:"text-xs text-slate-500 truncate",children:x==null?void 0:x.email})]})]}),a.jsxs("button",{onClick:k,className:"w-full flex items-center gap-3 px-4 py-3.5 text-red-600 hover:bg-red-50 rounded-xl transition-all text-sm font-medium group",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors",children:a.jsx(DE,{className:"w-5 h-5"})}),a.jsx("span",{children:"Logout"})]})]})]}),a.jsx("nav",{className:`mobile-bottom-nav-container ${R?"hidden":""}`,children:a.jsxs("div",{className:"mobile-bottom-nav",children:[U.map(D=>{const H=D.icon,B=F(D.path);return D.isCenter?a.jsx(Rt,{to:D.path,className:"nav-center-fab flex flex-col items-center justify-center","aria-label":D.label,title:D.label,children:a.jsx(H,{className:"w-7 h-7"})},D.path):a.jsxs(Rt,{to:D.path,className:`nav-item-modern flex flex-col items-center justify-center gap-0.5 ${B?"active":""}`,"aria-label":D.label,title:D.label,children:[a.jsx(H,{className:"w-5 h-5"}),a.jsx("span",{className:"text-[9px] font-medium",children:D.label})]},D.path)}),a.jsxs("button",{onClick:()=>y(!E),className:`nav-item-modern flex flex-col items-center justify-center gap-0.5 ${E?"active":""}`,"aria-label":"More",title:"More",children:[a.jsx(KY,{className:"w-5 h-5"}),a.jsx("span",{className:"text-[11px] font-medium",children:"More"})]})]})})]})}const YJ=[{path:"/dashboard",icon:pg,label:"Dashboard"},{path:"/ai-chat",icon:Mh,label:"AI Assistant"},{path:"/upload",icon:un,label:"My Reports"},{path:"/nutrition",icon:mg,label:"Nutrition"},{path:"/diet-plan",icon:Ji,label:"Diet Plan"},{path:"/profile",icon:Kd,label:"Profile"},{path:"/doctors",icon:Pn,label:"Appointments",comingSoon:!0},{path:"/wearables",icon:_o,label:"Devices",comingSoon:!0}],qJ=[{path:"/doctor/dashboard",icon:pg,label:"Dashboard"},{path:"/doctor/availability",icon:Yr,label:"Manage Slots"},{path:"/profile",icon:Kd,label:"Profile"}],XJ=[{path:"/admin",icon:pg,label:"Dashboard"},{path:"/profile",icon:Kd,label:"Settings"}];function kn({children:u,isAdmin:f,isDoctor:x}){var H,B,ne,ae;const{user:_,logout:E,isAdmin:y,isDoctor:R}=ia(),P=hg(),U=Ga(),[G,F]=j.useState(!1),k=()=>{E(),U("/")};let X=YJ,q="/dashboard",D="Patient Portal";return y()||f?(X=XJ,q="/admin",D="Admin Panel"):(R()||x)&&(X=qJ,q="/doctor/dashboard",D=((H=_==null?void 0:_.doctorProfile)==null?void 0:H.specialization)||"Doctor Portal"),a.jsxs("div",{className:"min-h-screen flex",children:[a.jsx("aside",{className:`fixed inset-y-0 right-0 lg:left-0 lg:right-auto z-50 w-64 shadow-lg lg:shadow-sm transform transition-transform duration-300 hidden lg:flex lg:flex-col bg-gradient-to-br from-cyan-500 to-blue-600 ${G?"translate-x-0":"translate-x-full lg:translate-x-0"}`,children:a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsx("div",{className:"p-6 shrink-0",style:{borderBottom:"1px solid rgba(255,255,255,0.2)"},children:a.jsxs(Rt,{to:q,className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl flex items-center justify-center bg-white/20",children:a.jsx(ms,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{children:[a.jsx("p",{className:"font-bold text-white",children:"FitCure"}),a.jsx("p",{className:"text-xs text-white/80",children:D})]})]})}),a.jsx("nav",{className:"flex-1 p-4 space-y-1 overflow-y-auto",children:X.map(({path:Z,icon:te,label:ie,comingSoon:ue})=>ue?a.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all cursor-not-allowed relative",style:{color:"rgba(255,255,255,0.5)",opacity:.6},children:[a.jsx(te,{className:"w-5 h-5"}),a.jsx("span",{children:ie}),a.jsx("span",{className:"ml-auto text-xs px-2 py-0.5 rounded-full font-semibold bg-white/20 text-white",children:"Soon"})]},Z):a.jsxs(Rt,{to:Z,onClick:()=>F(!1),className:`flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all ${P.pathname===Z?"border":""}`,style:P.pathname===Z?{backgroundColor:"rgba(255,255,255,0.2)",color:"white",borderColor:"rgba(255,255,255,0.3)"}:{color:"rgba(255,255,255,0.8)"},onMouseEnter:Ne=>{P.pathname!==Z&&(Ne.currentTarget.style.backgroundColor="rgba(255,255,255,0.15)",Ne.currentTarget.style.color="white")},onMouseLeave:Ne=>{P.pathname!==Z&&(Ne.currentTarget.style.backgroundColor="transparent",Ne.currentTarget.style.color="rgba(255,255,255,0.8)")},children:[a.jsx(te,{className:"w-5 h-5"}),a.jsx("span",{children:ie})]},Z))}),a.jsx("div",{className:"p-4 shrink-0",style:{borderTop:"1px solid rgba(255,255,255,0.2)"},children:a.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-xl bg-white/20",children:[a.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center shrink-0 bg-white",children:a.jsx("span",{className:"font-bold text-cyan-600",children:(ne=(B=_==null?void 0:_.name)==null?void 0:B[0])==null?void 0:ne.toUpperCase()})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-medium truncate text-white",children:R()?`Dr. ${_==null?void 0:_.name}`:_==null?void 0:_.name}),a.jsx("p",{className:"text-xs truncate text-white/80",children:_==null?void 0:_.email})]}),a.jsx("button",{onClick:k,className:"p-2 rounded-lg transition-all shrink-0 text-white/80",onMouseEnter:Z=>{Z.currentTarget.style.color="#fca5a5",Z.currentTarget.style.backgroundColor="rgba(255,255,255,0.2)"},onMouseLeave:Z=>{Z.currentTarget.style.color="rgba(255,255,255,0.8)",Z.currentTarget.style.backgroundColor="transparent"},title:"Logout",children:a.jsx(DE,{className:"w-5 h-5"})})]})})]})}),G&&a.jsx("div",{className:"fixed inset-0 bg-black/20 z-40 lg:hidden",onClick:()=>F(!1)}),a.jsxs("div",{className:"flex-1 flex flex-col min-h-screen lg:ml-64",children:[a.jsx("header",{className:"sticky top-0 z-30 backdrop-blur-xl bg-gradient-to-r from-cyan-500 to-blue-600 border-b border-white/20 hidden md:block",children:a.jsxs("div",{className:"flex items-center justify-between px-3 md:px-4 lg:px-8 py-3 md:py-4",children:[a.jsxs("div",{className:"flex items-center gap-2 md:gap-4 flex-1 md:flex-none",children:[a.jsxs(Rt,{to:q,className:"lg:hidden flex items-center gap-2 flex-shrink-0",children:[a.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center bg-white/20",children:a.jsx(ms,{className:"w-5 h-5 text-white"})}),a.jsx("span",{className:"text-sm font-bold text-white",children:"FitCure"})]}),a.jsx("h1",{className:"text-base md:text-lg font-semibold hidden sm:block text-white",children:((ae=X.find(Z=>Z.path===P.pathname))==null?void 0:ae.label)||"Dashboard"})]}),a.jsxs("div",{className:"flex items-center gap-2 md:gap-3 overflow-hidden",children:[a.jsx("div",{className:"hidden md:flex items-center",children:a.jsxs("div",{className:"relative",children:[a.jsx(ng,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/60"}),a.jsx("input",{type:"text",placeholder:"Search...",className:"w-48 pl-10 pr-4 py-2 rounded-xl text-sm focus:outline-none bg-white/20 border border-white/30 text-white placeholder-white/60"})]})}),a.jsxs("button",{className:"relative p-2 rounded-xl transition-all flex-shrink-0 text-white/80 hover:bg-white/20",children:[a.jsx(Eo,{className:"w-5 h-5"}),a.jsx("span",{className:"absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full"})]})]})]})}),a.jsx("main",{className:"flex-1 main-content-mobile overflow-x-hidden w-full",style:P.pathname==="/nutrition"||P.pathname==="/ai-chat"?{padding:0,backgroundColor:"white"}:P.pathname==="/dashboard"||P.pathname==="/glucose-log"?{padding:0}:{padding:0},children:u}),!y()&&!R()&&!f&&!x&&a.jsx(KJ,{})]}),P.pathname!=="/ai-chat"&&a.jsx(zJ,{})]})}function JJ(){const[u,f]=j.useState(null),[x,_]=j.useState(!1),[E,y]=j.useState(!1);j.useEffect(()=>{if(window.matchMedia("(display-mode: standalone)").matches){y(!0);return}const U=F=>{F.preventDefault(),f(F);const X=window.innerWidth<768?1e3:5e3,q=setTimeout(()=>{_(!0)},X);return()=>clearTimeout(q)},G=()=>{y(!0),_(!1),f(null),Ve.success(" FitCure app installed successfully!")};return window.addEventListener("beforeinstallprompt",U),window.addEventListener("appinstalled",G),()=>{window.removeEventListener("beforeinstallprompt",U),window.removeEventListener("appinstalled",G)}},[]),j.useEffect(()=>{if(!u||E)return;const U=setInterval(()=>{_(!0)},2*60*1e3);return()=>clearInterval(U)},[u,E]);const R=async()=>{if(!u)return;u.prompt();const{outcome:U}=await u.userChoice;U==="accepted"?Ve.success("Installing FitCure app..."):Ve("You can install later from browser menu",{icon:""}),f(null),_(!1)},P=()=>{_(!1)};return E||!x||!u?null:a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"md:hidden fixed bottom-20 left-0 right-0 z-50 px-3 animate-slide-up",children:a.jsx("div",{className:"bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl shadow-2xl p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center flex-shrink-0",children:a.jsx(kE,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:"font-bold text-white text-sm",children:"Install FitCure App"}),a.jsx("p",{className:"text-xs text-white/90",children:"Quick access from home screen"})]}),a.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[a.jsx("button",{onClick:R,className:"px-4 py-2 bg-white text-cyan-600 rounded-xl font-bold hover:bg-white/90 transition-all text-sm shadow-lg",children:"Install"}),a.jsx("button",{onClick:P,className:"p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all",children:a.jsx(ra,{className:"w-5 h-5"})})]})]})})}),a.jsx("div",{className:"hidden md:block fixed bottom-8 right-8 z-40 animate-slide-up",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border-2 border-cyan-200 p-6 max-w-sm",children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center flex-shrink-0",children:a.jsx(jE,{className:"w-7 h-7 text-white"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-bold text-slate-800 text-lg",children:"Install FitCure"}),a.jsx("p",{className:"text-sm text-slate-600",children:"Progressive Web App"})]})]}),a.jsx("button",{onClick:P,className:"text-slate-400 hover:text-slate-600 flex-shrink-0",children:a.jsx(ra,{className:"w-5 h-5"})})]}),a.jsxs("p",{className:"text-sm text-slate-600 mb-4",children:[" Install FitCure for quick access to your health data",a.jsx("br",{})," Works offline with cached data",a.jsx("br",{})," Faster loading and better performance"]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:R,className:"flex-1 px-5 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all",children:"Install Now"}),a.jsx("button",{onClick:P,className:"px-5 py-3 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-all",children:"Later"})]})]})})]})}const No=()=>a.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 sm:p-6 animate-pulse",children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("div",{className:"h-8 bg-slate-700/50 rounded w-48 mb-2"}),a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-64"})]}),a.jsx("div",{className:"space-y-4",children:[1,2,3].map(u=>a.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[a.jsx("div",{className:"h-6 bg-slate-700/50 rounded w-40 mb-4"}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-full"}),a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-5/6"}),a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-4/6"})]})]},u))})]}),$J=()=>{const[u,f]=j.useState(!1),[x,_]=j.useState(!1),E=j.useRef(null);return j.useEffect(()=>{const y=R=>{E.current&&!E.current.contains(R.target)&&_(!1)};return document.addEventListener("mousedown",y),()=>document.removeEventListener("mousedown",y)},[]),a.jsx("header",{className:"fixed top-5 z-50 left-1/2 -translate-x-1/2 w-[calc(100%-200px)] max-w-5xl max-md:w-[calc(100%-40px)]",children:a.jsx("div",{className:"bg-white/80 backdrop-blur-md rounded-[28px] border border-white/40 shadow-2xl shadow-black/10",children:a.jsxs("div",{className:"px-6 lg:px-8",children:[a.jsxs("div",{className:"flex items-center justify-between h-16",children:[a.jsxs("nav",{className:"hidden lg:flex items-center gap-6",children:[a.jsx("a",{href:"#features",className:"text-sm text-gray-700 hover:text-gray-900 transition-colors font-medium",children:"Features"}),a.jsx("a",{href:"#showcase",className:"text-sm text-gray-700 hover:text-gray-900 transition-colors font-medium",children:"Showcase"})]}),a.jsx(Rt,{to:"/",className:"absolute left-1/2 -translate-x-1/2",children:a.jsx("span",{className:"text-xl lg:text-2xl font-serif text-gray-900",children:"FitCure"})}),a.jsxs("div",{className:"hidden lg:flex items-center gap-6",children:[a.jsx("a",{href:"#testimonials",className:"text-sm text-gray-700 hover:text-gray-900 transition-colors font-medium",children:"Testimonials"}),a.jsx("a",{href:"#faq",className:"text-sm text-gray-700 hover:text-gray-900 transition-colors font-medium",children:"FAQ"}),a.jsxs("div",{className:"relative",ref:E,children:[a.jsx("button",{onClick:()=>_(!x),className:"w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center hover:bg-cyan-400 transition-colors ml-2",children:a.jsx($i,{className:"w-5 h-5 text-white"})}),x&&a.jsxs("div",{className:"absolute right-0 mt-3 w-48 bg-white backdrop-blur-2xl rounded-2xl shadow-xl border border-gray-200 py-2 animate-fade-in",children:[a.jsx(Rt,{to:"/login",className:"block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors font-medium",onClick:()=>_(!1),children:"Sign In"}),a.jsx(Rt,{to:"/register",className:"block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors font-medium",onClick:()=>_(!1),children:"Get Started"})]})]})]}),a.jsx("button",{className:"lg:hidden p-2 text-gray-900 ml-auto",onClick:()=>f(!u),children:u?a.jsx(ra,{className:"w-6 h-6"}):a.jsx(d2,{className:"w-6 h-6"})})]}),u&&a.jsx("div",{className:"lg:hidden py-6 border-t border-gray-200",children:a.jsxs("nav",{className:"flex flex-col gap-4",children:[a.jsx("a",{href:"#features",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"Features"}),a.jsx("a",{href:"#showcase",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"Showcase"}),a.jsx("a",{href:"#testimonials",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"Testimonials"}),a.jsx("a",{href:"#faq",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"FAQ"}),a.jsxs("div",{className:"flex flex-col gap-2 pt-4 border-t border-gray-200",children:[a.jsx(Rt,{to:"/login",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"Sign In"}),a.jsx(Rt,{to:"/register",className:"text-sm text-gray-700 hover:text-gray-900 py-2 font-medium",children:"Get Started"})]})]})})]})})})},QJ=()=>a.jsxs("div",{className:"relative min-h-screen flex items-center overflow-hidden bg-gradient-to-b from-[#0a3d5c] to-[#0d5a8a]",children:[a.jsxs("div",{className:"absolute inset-0 z-0",children:[a.jsxs("video",{autoPlay:!0,loop:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover opacity-60",children:[a.jsx("source",{src:"https://cdn.shopify.com/videos/c/o/v/dcb48db72fdb4641a2af2df51c03aad5.mp4",type:"video/mp4"}),a.jsx("img",{src:"https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=1920&h=1080&fit=crop",alt:"Healthcare",className:"w-full h-full object-cover opacity-60"})]}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-black/40 via-black/20 to-transparent"})]}),a.jsx("div",{className:"relative z-10 w-full max-w-7xl mx-auto px-6 sm:px-8 lg:px-12 py-32",children:a.jsxs("div",{className:"max-w-xl lg:max-w-2xl text-center lg:text-left",children:[a.jsx("p",{className:"text-xs sm:text-sm uppercase tracking-[0.2em] text-cyan-300 mb-6 font-medium",children:"SMART NUTRITION TRACKING"}),a.jsx("h1",{className:"text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl font-serif text-white mb-6 leading-[1.1]",children:"Take Control of your Health Journey."}),a.jsx("p",{className:"text-base sm:text-lg md:text-xl text-cyan-100 mb-10 leading-relaxed max-w-lg",children:"Empowers user to take informed action on their health through easy to understand insights, continuous tracking, and goal-based guidance."}),a.jsxs(Rt,{to:"/register",className:"inline-flex items-center gap-2 px-8 py-4 bg-cyan-500 text-white rounded-full font-medium hover:bg-cyan-400 transition-all group shadow-lg",children:["Start Tracking",a.jsx(Ba,{className:"w-5 h-5 group-hover:translate-x-1 transition-transform"})]})]})}),a.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 z-10",children:[a.jsx("span",{className:"text-xs uppercase tracking-wider text-cyan-300 font-medium",children:"SCROLL"}),a.jsx("div",{className:"w-px h-12 bg-cyan-300/30"})]})]}),ZJ=()=>{const u=[{icon:ms,title:"Health Tracking",description:"Effortless daily tracking"},{icon:Qn,title:"Progress Analytics",description:"Real-time health insights"},{icon:vr,title:"Goal Setting",description:"Personalized targets"},{icon:zn,title:"Wellness Plans",description:"AI-powered recommendations"}];return a.jsx("section",{id:"features",className:"py-20 bg-transparent",children:a.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8",children:u.map((f,x)=>{const _=f.icon;return a.jsxs("div",{className:"text-center bg-gradient-to-br from-[#0a3d5c]/60 to-[#0d5a8a]/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-400/30 hover:border-cyan-400/60 transition-all hover:shadow-lg hover:shadow-cyan-500/20",children:[a.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 mb-6 bg-cyan-500/20 rounded-full border border-cyan-400/40",children:a.jsx(_,{className:"w-12 h-12 text-cyan-300 stroke-[1.5]"})}),a.jsx("h3",{className:"text-lg font-serif text-white mb-2",children:f.title}),a.jsx("p",{className:"text-sm text-cyan-100",children:f.description})]},x)})})})})},e$=()=>a.jsx("section",{className:"bg-transparent py-20",children:a.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:a.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[a.jsxs("div",{className:"relative rounded-3xl overflow-hidden group",children:[a.jsx("img",{src:"https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=800&h=600&fit=crop",alt:"AI-Powered Nutrition",className:"w-full h-full object-cover min-h-[400px]"}),a.jsxs("div",{className:"absolute bottom-8 left-8 right-8 bg-gradient-to-r from-[#0a3d5c]/90 to-[#0d5a8a]/90 backdrop-blur-sm rounded-2xl p-6 border border-cyan-400/30",children:[a.jsx("h3",{className:"text-2xl font-serif text-white mb-2",children:"AI-Powered Nutrition"}),a.jsx("p",{className:"text-sm text-cyan-100",children:"Smart meal recognition and instant calorie calculation with advanced AI technology."})]})]}),a.jsxs("div",{className:"flex flex-col gap-8",children:[a.jsx("div",{className:"relative rounded-3xl overflow-hidden bg-gradient-to-br from-[#0a3d5c]/80 to-[#0d5a8a]/80 backdrop-blur-sm p-8 border border-cyan-400/30",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-2xl font-serif text-white mb-2",children:"Track Everything"}),a.jsx("h4",{className:"text-xl font-serif text-cyan-300 mb-4",children:"Achieve Anything"}),a.jsxs("ul",{className:"space-y-2 text-sm text-cyan-100",children:[a.jsxs("li",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"w-1 h-1 rounded-full bg-cyan-400"}),"Calorie & Macro Tracking"]}),a.jsxs("li",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"w-1 h-1 rounded-full bg-cyan-400"}),"Meal Planning & Recipes"]}),a.jsxs("li",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"w-1 h-1 rounded-full bg-cyan-400"}),"Progress Analytics"]})]})]}),a.jsx("div",{className:"flex-shrink-0",children:a.jsx("img",{src:"https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=300&h=400&fit=crop",alt:"Healthy Food",className:"w-48 h-64 object-cover rounded-2xl"})})]})}),a.jsx("div",{className:"relative rounded-3xl overflow-hidden bg-gradient-to-br from-[#0a3d5c]/80 to-[#0d5a8a]/80 backdrop-blur-sm p-8 border border-cyan-400/30",children:a.jsxs("div",{className:"flex items-center gap-6",children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx("div",{className:"w-16 h-16 rounded-full bg-cyan-500/20 flex items-center justify-center border border-cyan-400/50",children:a.jsx(kE,{className:"w-8 h-8 text-cyan-300"})})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-xl font-serif text-white mb-2",children:"Report Analyzer"}),a.jsx("p",{className:"text-sm text-cyan-100",children:"Track on-the-go"})]}),a.jsx("div",{className:"flex-shrink-0",children:a.jsx("img",{src:"https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=200&h=200&fit=crop",alt:"Mobile App",className:"w-32 h-32 object-cover rounded-xl"})})]})})]})]})})}),t$=()=>{const[u,f]=j.useState(0),x=j.useRef(null),_=[{title:"Track Your Health Metrics",description:"Monitor vital signs, lab results, and health trends all in one place with AI-powered insights.",phoneScreen:"dashboard",cards:[{icon:zn,title:"Heart Rate",value:"72 bpm",color:"rose",position:"left-top"},{icon:ms,title:"Blood Pressure",value:"120/80",color:"blue",position:"left-bottom"},{icon:Qn,title:"Health Score",value:"85/100",color:"emerald",position:"right-top"},{icon:oc,title:"Vitamin D",value:"45 ng/mL",color:"amber",position:"right-bottom"}]},{title:"Smart Nutrition Tracking",description:"Track your meals and get actionable feedback that helps you build a better relationship with food.",phoneScreen:"nutrition",cards:[{icon:mg,title:"Today's Meals",value:"3 logged",color:"emerald",position:"left-top"},{icon:ms,title:"Calories",value:"1,850 kcal",color:"orange",position:"left-bottom"},{icon:Qn,title:"Protein",value:"95g",color:"blue",position:"right-top"},{icon:zn,title:"Macro Balance",value:"Optimal",color:"purple",position:"right-bottom"}]},{title:"AI-Powered Health Insights",description:"Get personalized recommendations based on your medical reports and wearable data.",phoneScreen:"ai-chat",cards:[{icon:Mh,title:"AI Assistant",value:"24/7 Available",color:"cyan",position:"left-top"},{icon:Qn,title:"Insights",value:"12 new",color:"indigo",position:"left-bottom"},{icon:Pn,title:"Reminders",value:"5 today",color:"pink",position:"right-top"},{icon:zn,title:"Health Tips",value:"Updated",color:"red",position:"right-bottom"}]},{title:"Sleep & Recovery Tracking",description:"Improve your sleep by understanding patterns, identifying disruptions, and building habits.",phoneScreen:"sleep",cards:[{icon:Yd,title:"Sleep Quality",value:"85%",color:"indigo",position:"left-top"},{icon:ms,title:"Sleep Duration",value:"7h 45m",color:"blue",position:"left-bottom"},{icon:Qn,title:"Deep Sleep",value:"2h 15m",color:"purple",position:"right-top"},{icon:zn,title:"REM Sleep",value:"1h 30m",color:"pink",position:"right-bottom"}]}];j.useEffect(()=>{const P=()=>{if(!x.current)return;const U=x.current,{top:G,height:F}=U.getBoundingClientRect(),k=window.innerHeight,X=(k/2-G)/(F-k/2),q=Math.max(0,Math.min(1,X)),D=Math.floor(q*_.length),H=Math.min(D,_.length-1);f(H)};return window.addEventListener("scroll",P),P(),()=>window.removeEventListener("scroll",P)},[_.length]);const E=P=>({"left-top":"left-[1%] sm:left-[3%] md:left-[8%] top-[8%] sm:top-[10%] md:top-[12%]","left-bottom":"left-[1%] sm:left-[5%] md:left-[10%] bottom-[12%] sm:bottom-[15%] md:bottom-[18%]","right-top":"right-[1%] sm:right-[3%] md:right-[8%] top-[14%] sm:top-[16%] md:top-[18%]","right-bottom":"right-[1%] sm:right-[5%] md:right-[10%] bottom-[6%] sm:bottom-[9%] md:bottom-[12%]"})[P]||"left-[10%] top-[20%]",y=(P,U)=>({"left-top":U?"opacity-100 translate-x-0 translate-y-0 scale-100":"opacity-0 translate-x-32 translate-y-16 scale-75","left-bottom":U?"opacity-100 translate-x-0 translate-y-0 scale-100":"opacity-0 translate-x-32 -translate-y-16 scale-75","right-top":U?"opacity-100 translate-x-0 translate-y-0 scale-100":"opacity-0 -translate-x-32 translate-y-16 scale-75","right-bottom":U?"opacity-100 translate-x-0 translate-y-0 scale-100":"opacity-0 -translate-x-32 -translate-y-16 scale-75"})[P],R=P=>({dashboard:"from-blue-500 to-cyan-500",nutrition:"from-emerald-500 to-green-500","ai-chat":"from-purple-500 to-pink-500",sleep:"from-indigo-500 to-blue-500"})[P]||"from-cyan-500 to-blue-500";return a.jsx("div",{id:"showcase",ref:x,className:"relative bg-transparent",style:{height:`${_.length*100}vh`},children:a.jsx("div",{className:"sticky top-0 h-screen flex items-center justify-center overflow-hidden pt-20 sm:pt-24 px-2 sm:px-4",children:a.jsx("div",{className:"relative w-full max-w-7xl mx-auto",children:a.jsxs("div",{className:"relative flex flex-col items-center",children:[a.jsx("div",{className:"text-center mb-2 sm:mb-3 max-w-2xl px-4 transition-all duration-700 transform relative z-30",children:a.jsx("h2",{className:"text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-serif text-white mb-6 sm:mb-8 leading-tight",children:_[u].title})}),a.jsx("div",{className:"absolute inset-0 pointer-events-none z-40",children:_[u].cards.map((P,U)=>{const G=P.icon,F={rose:{bg:"bg-rose-50",icon:"text-rose-500",value:"text-rose-600",border:"border-rose-100"},blue:{bg:"bg-blue-50",icon:"text-blue-500",value:"text-blue-600",border:"border-blue-100"},emerald:{bg:"bg-emerald-50",icon:"text-emerald-500",value:"text-emerald-600",border:"border-emerald-100"},amber:{bg:"bg-amber-50",icon:"text-amber-500",value:"text-amber-600",border:"border-amber-100"},orange:{bg:"bg-orange-50",icon:"text-orange-500",value:"text-orange-600",border:"border-orange-100"},purple:{bg:"bg-purple-50",icon:"text-purple-500",value:"text-purple-600",border:"border-purple-100"},cyan:{bg:"bg-cyan-50",icon:"text-cyan-500",value:"text-cyan-600",border:"border-cyan-100"},indigo:{bg:"bg-indigo-50",icon:"text-indigo-500",value:"text-indigo-600",border:"border-indigo-100"},pink:{bg:"bg-pink-50",icon:"text-pink-500",value:"text-pink-600",border:"border-pink-100"},red:{bg:"bg-red-50",icon:"text-red-500",value:"text-red-600",border:"border-red-100"}};return F[P.color]||F.blue,a.jsx("div",{className:`absolute ${E(P.position)} ${y(P.position,!0)} 
                      transition-all duration-1000 ease-out`,style:{transitionDelay:`${U*150}ms`},children:a.jsxs("div",{className:`bg-gradient-to-br from-[#0a3d5c]/90 to-[#0d5a8a]/90 rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-4 md:p-6 border border-cyan-400/40 
                      hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 w-32 sm:w-40 md:w-48 backdrop-blur-sm`,children:[a.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-lg sm:rounded-xl bg-cyan-500/20 flex items-center justify-center mb-2 sm:mb-3 border border-cyan-400/30",children:a.jsx(G,{className:"w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-cyan-300",strokeWidth:2})}),a.jsx("h4",{className:"text-white font-medium text-xs sm:text-sm md:text-base mb-1 leading-tight",children:P.title}),a.jsx("p",{className:"text-cyan-300 font-bold text-base sm:text-lg md:text-xl",children:P.value})]})},U)})}),a.jsxs("div",{className:"relative transform perspective-1000 z-10",children:[a.jsxs("div",{className:"relative w-[240px] sm:w-[280px] md:w-[320px] lg:w-[340px] h-[480px] sm:h-[560px] md:h-[640px] lg:h-[680px] bg-slate-900 rounded-[2.5rem] sm:rounded-[3rem] md:rounded-[3.5rem] p-2 sm:p-3 shadow-2xl",children:[a.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 w-28 sm:w-32 md:w-36 h-5 sm:h-6 md:h-7 bg-slate-900 rounded-b-2xl sm:rounded-b-3xl z-10"}),a.jsx("div",{className:"relative w-full h-full bg-white rounded-[2rem] sm:rounded-[2.5rem] md:rounded-[3rem] overflow-hidden",children:a.jsxs("div",{className:`absolute inset-0 bg-gradient-to-br ${R(_[u].phoneScreen)} 
                    transition-all duration-1000 ease-in-out`,children:[a.jsxs("div",{className:"flex items-center justify-between px-4 sm:px-5 md:px-6 pt-2 sm:pt-3 text-white text-[10px] sm:text-xs",children:[a.jsx("span",{children:"9:41"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 h-2 sm:w-4 sm:h-3 border border-white rounded-sm"}),a.jsx("div",{className:"w-0.5 h-2 sm:w-1 sm:h-3 bg-white rounded-sm"})]})]}),a.jsxs("div",{className:"px-4 sm:px-5 md:px-6 pt-6 sm:pt-7 md:pt-8",children:[a.jsxs("h3",{className:"text-white text-lg sm:text-xl md:text-2xl font-bold",children:[_[u].phoneScreen==="dashboard"&&"Dashboard",_[u].phoneScreen==="nutrition"&&"Nutrition",_[u].phoneScreen==="ai-chat"&&"AI Assistant",_[u].phoneScreen==="sleep"&&"Sleep"]}),a.jsx("p",{className:"text-white/80 text-[10px] sm:text-xs md:text-sm mt-1",children:new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})})]}),a.jsx("div",{className:`absolute inset-x-4 sm:inset-x-5 md:inset-x-6 top-24 sm:top-28 md:top-32 bottom-4 sm:bottom-5 md:bottom-6 bg-white/10 backdrop-blur-md rounded-2xl sm:rounded-3xl border border-white/20 p-4 sm:p-5 md:p-6 \r
                      transition-all duration-1000 shadow-inner`,children:a.jsx("div",{className:"space-y-3 sm:space-y-4",children:[1,2,3].map(P=>a.jsx("div",{className:"bg-white/20 rounded-xl sm:rounded-2xl h-14 sm:h-16 md:h-20 animate-pulse shadow-lg",style:{animationDelay:`${P*200}ms`,animationDuration:"2s"}},P))})})]})})]}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-transparent via-slate-900/10 to-slate-900/30 rounded-[2.5rem] sm:rounded-[3rem] md:rounded-[3.5rem] -z-10 blur-2xl sm:blur-3xl transform scale-105"})]})]})})})})},s$=(u,f)=>{const x=new Array(u.length+f.length);for(let _=0;_<u.length;_++)x[_]=u[_];for(let _=0;_<f.length;_++)x[u.length+_]=f[_];return x},n$=(u,f)=>({classGroupId:u,validator:f}),rL=(u=new Map,f=null,x)=>({nextPart:u,validators:f,classGroupId:x}),og="-",UP=[],a$="arbitrary..",r$=u=>{const f=o$(u),{conflictingClassGroups:x,conflictingClassGroupModifiers:_}=u;return{getClassGroupId:R=>{if(R.startsWith("[")&&R.endsWith("]"))return i$(R);const P=R.split(og),U=P[0]===""&&P.length>1?1:0;return iL(P,U,f)},getConflictingClassGroupIds:(R,P)=>{if(P){const U=_[R],G=x[R];return U?G?s$(G,U):U:G||UP}return x[R]||UP}}},iL=(u,f,x)=>{if(u.length-f===0)return x.classGroupId;const E=u[f],y=x.nextPart.get(E);if(y){const G=iL(u,f+1,y);if(G)return G}const R=x.validators;if(R===null)return;const P=f===0?u.join(og):u.slice(f).join(og),U=R.length;for(let G=0;G<U;G++){const F=R[G];if(F.validator(P))return F.classGroupId}},i$=u=>u.slice(1,-1).indexOf(":")===-1?void 0:(()=>{const f=u.slice(1,-1),x=f.indexOf(":"),_=f.slice(0,x);return _?a$+_:void 0})(),o$=u=>{const{theme:f,classGroups:x}=u;return c$(x,f)},c$=(u,f)=>{const x=rL();for(const _ in u){const E=u[_];YE(E,x,_,f)}return x},YE=(u,f,x,_)=>{const E=u.length;for(let y=0;y<E;y++){const R=u[y];l$(R,f,x,_)}},l$=(u,f,x,_)=>{if(typeof u=="string"){d$(u,f,x);return}if(typeof u=="function"){u$(u,f,x,_);return}h$(u,f,x,_)},d$=(u,f,x)=>{const _=u===""?f:oL(f,u);_.classGroupId=x},u$=(u,f,x,_)=>{if(p$(u)){YE(u(_),f,x,_);return}f.validators===null&&(f.validators=[]),f.validators.push(n$(x,u))},h$=(u,f,x,_)=>{const E=Object.entries(u),y=E.length;for(let R=0;R<y;R++){const[P,U]=E[R];YE(U,oL(f,P),x,_)}},oL=(u,f)=>{let x=u;const _=f.split(og),E=_.length;for(let y=0;y<E;y++){const R=_[y];let P=x.nextPart.get(R);P||(P=rL(),x.nextPart.set(R,P)),x=P}return x},p$=u=>"isThemeGetter"in u&&u.isThemeGetter===!0,m$=u=>{if(u<1)return{get:()=>{},set:()=>{}};let f=0,x=Object.create(null),_=Object.create(null);const E=(y,R)=>{x[y]=R,f++,f>u&&(f=0,_=x,x=Object.create(null))};return{get(y){let R=x[y];if(R!==void 0)return R;if((R=_[y])!==void 0)return E(y,R),R},set(y,R){y in x?x[y]=R:E(y,R)}}},vE="!",VP=":",f$=[],FP=(u,f,x,_,E)=>({modifiers:u,hasImportantModifier:f,baseClassName:x,maybePostfixModifierPosition:_,isExternal:E}),g$=u=>{const{prefix:f,experimentalParseClassName:x}=u;let _=E=>{const y=[];let R=0,P=0,U=0,G;const F=E.length;for(let H=0;H<F;H++){const B=E[H];if(R===0&&P===0){if(B===VP){y.push(E.slice(U,H)),U=H+1;continue}if(B==="/"){G=H;continue}}B==="["?R++:B==="]"?R--:B==="("?P++:B===")"&&P--}const k=y.length===0?E:E.slice(U);let X=k,q=!1;k.endsWith(vE)?(X=k.slice(0,-1),q=!0):k.startsWith(vE)&&(X=k.slice(1),q=!0);const D=G&&G>U?G-U:void 0;return FP(y,q,X,D)};if(f){const E=f+VP,y=_;_=R=>R.startsWith(E)?y(R.slice(E.length)):FP(f$,!1,R,void 0,!0)}if(x){const E=_;_=y=>x({className:y,parseClassName:E})}return _},x$=u=>{const f=new Map;return u.orderSensitiveModifiers.forEach((x,_)=>{f.set(x,1e6+_)}),x=>{const _=[];let E=[];for(let y=0;y<x.length;y++){const R=x[y],P=R[0]==="[",U=f.has(R);P||U?(E.length>0&&(E.sort(),_.push(...E),E=[]),_.push(R)):E.push(R)}return E.length>0&&(E.sort(),_.push(...E)),_}},b$=u=>({cache:m$(u.cacheSize),parseClassName:g$(u),sortModifiers:x$(u),...r$(u)}),_$=/\s+/,v$=(u,f)=>{const{parseClassName:x,getClassGroupId:_,getConflictingClassGroupIds:E,sortModifiers:y}=f,R=[],P=u.trim().split(_$);let U="";for(let G=P.length-1;G>=0;G-=1){const F=P[G],{isExternal:k,modifiers:X,hasImportantModifier:q,baseClassName:D,maybePostfixModifierPosition:H}=x(F);if(k){U=F+(U.length>0?" "+U:U);continue}let B=!!H,ne=_(B?D.substring(0,H):D);if(!ne){if(!B){U=F+(U.length>0?" "+U:U);continue}if(ne=_(D),!ne){U=F+(U.length>0?" "+U:U);continue}B=!1}const ae=X.length===0?"":X.length===1?X[0]:y(X).join(":"),Z=q?ae+vE:ae,te=Z+ne;if(R.indexOf(te)>-1)continue;R.push(te);const ie=E(ne,B);for(let ue=0;ue<ie.length;++ue){const Ne=ie[ue];R.push(Z+Ne)}U=F+(U.length>0?" "+U:U)}return U},E$=(...u)=>{let f=0,x,_,E="";for(;f<u.length;)(x=u[f++])&&(_=cL(x))&&(E&&(E+=" "),E+=_);return E},cL=u=>{if(typeof u=="string")return u;let f,x="";for(let _=0;_<u.length;_++)u[_]&&(f=cL(u[_]))&&(x&&(x+=" "),x+=f);return x},y$=(u,...f)=>{let x,_,E,y;const R=U=>{const G=f.reduce((F,k)=>k(F),u());return x=b$(G),_=x.cache.get,E=x.cache.set,y=P,P(U)},P=U=>{const G=_(U);if(G)return G;const F=v$(U,x);return E(U,F),F};return y=R,(...U)=>y(E$(...U))},w$=[],na=u=>{const f=x=>x[u]||w$;return f.isThemeGetter=!0,f},lL=/^\[(?:(\w[\w-]*):)?(.+)\]$/i,dL=/^\((?:(\w[\w-]*):)?(.+)\)$/i,S$=/^\d+\/\d+$/,N$=/^(\d+(\.\d+)?)?(xs|sm|md|lg|xl)$/,T$=/\d+(%|px|r?em|[sdl]?v([hwib]|min|max)|pt|pc|in|cm|mm|cap|ch|ex|r?lh|cq(w|h|i|b|min|max))|\b(calc|min|max|clamp)\(.+\)|^0$/,R$=/^(rgba?|hsla?|hwb|(ok)?(lab|lch)|color-mix)\(.+\)$/,C$=/^(inset_)?-?((\d+)?\.?(\d+)[a-z]+|0)_-?((\d+)?\.?(\d+)[a-z]+|0)/,I$=/^(url|image|image-set|cross-fade|element|(repeating-)?(linear|radial|conic)-gradient)\(.+\)$/,Md=u=>S$.test(u),xs=u=>!!u&&!Number.isNaN(Number(u)),rc=u=>!!u&&Number.isInteger(Number(u)),Zv=u=>u.endsWith("%")&&xs(u.slice(0,-1)),fo=u=>N$.test(u),A$=()=>!0,O$=u=>T$.test(u)&&!R$.test(u),uL=()=>!1,D$=u=>C$.test(u),k$=u=>I$.test(u),j$=u=>!Nt(u)&&!Tt(u),P$=u=>Qd(u,mL,uL),Nt=u=>lL.test(u),cl=u=>Qd(u,fL,O$),eE=u=>Qd(u,F$,xs),BP=u=>Qd(u,hL,uL),L$=u=>Qd(u,pL,k$),qf=u=>Qd(u,gL,D$),Tt=u=>dL.test(u),Ch=u=>Zd(u,fL),M$=u=>Zd(u,B$),GP=u=>Zd(u,hL),U$=u=>Zd(u,mL),V$=u=>Zd(u,pL),Xf=u=>Zd(u,gL,!0),Qd=(u,f,x)=>{const _=lL.exec(u);return _?_[1]?f(_[1]):x(_[2]):!1},Zd=(u,f,x=!1)=>{const _=dL.exec(u);return _?_[1]?f(_[1]):x:!1},hL=u=>u==="position"||u==="percentage",pL=u=>u==="image"||u==="url",mL=u=>u==="length"||u==="size"||u==="bg-size",fL=u=>u==="length",F$=u=>u==="number",B$=u=>u==="family-name",gL=u=>u==="shadow",G$=()=>{const u=na("color"),f=na("font"),x=na("text"),_=na("font-weight"),E=na("tracking"),y=na("leading"),R=na("breakpoint"),P=na("container"),U=na("spacing"),G=na("radius"),F=na("shadow"),k=na("inset-shadow"),X=na("text-shadow"),q=na("drop-shadow"),D=na("blur"),H=na("perspective"),B=na("aspect"),ne=na("ease"),ae=na("animate"),Z=()=>["auto","avoid","all","avoid-page","page","left","right","column"],te=()=>["center","top","bottom","left","right","top-left","left-top","top-right","right-top","bottom-right","right-bottom","bottom-left","left-bottom"],ie=()=>[...te(),Tt,Nt],ue=()=>["auto","hidden","clip","visible","scroll"],Ne=()=>["auto","contain","none"],be=()=>[Tt,Nt,U],Q=()=>[Md,"full","auto",...be()],pe=()=>[rc,"none","subgrid",Tt,Nt],he=()=>["auto",{span:["full",rc,Tt,Nt]},rc,Tt,Nt],Ae=()=>[rc,"auto",Tt,Nt],fe=()=>["auto","min","max","fr",Tt,Nt],le=()=>["start","end","center","between","around","evenly","stretch","baseline","center-safe","end-safe"],we=()=>["start","end","center","stretch","center-safe","end-safe"],re=()=>["auto",...be()],oe=()=>[Md,"auto","full","dvw","dvh","lvw","lvh","svw","svh","min","max","fit",...be()],J=()=>[u,Tt,Nt],Oe=()=>[...te(),GP,BP,{position:[Tt,Nt]}],$e=()=>["no-repeat",{repeat:["","x","y","space","round"]}],He=()=>["auto","cover","contain",U$,P$,{size:[Tt,Nt]}],ot=()=>[Zv,Ch,cl],_t=()=>["","none","full",G,Tt,Nt],Ke=()=>["",xs,Ch,cl],ht=()=>["solid","dashed","dotted","double"],st=()=>["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],ct=()=>[xs,Zv,GP,BP],fs=()=>["","none",D,Tt,Nt],ys=()=>["none",xs,Tt,Nt],As=()=>["none",xs,Tt,Nt],zs=()=>[xs,Tt,Nt],je=()=>[Md,"full",...be()];return{cacheSize:500,theme:{animate:["spin","ping","pulse","bounce"],aspect:["video"],blur:[fo],breakpoint:[fo],color:[A$],container:[fo],"drop-shadow":[fo],ease:["in","out","in-out"],font:[j$],"font-weight":["thin","extralight","light","normal","medium","semibold","bold","extrabold","black"],"inset-shadow":[fo],leading:["none","tight","snug","normal","relaxed","loose"],perspective:["dramatic","near","normal","midrange","distant","none"],radius:[fo],shadow:[fo],spacing:["px",xs],text:[fo],"text-shadow":[fo],tracking:["tighter","tight","normal","wide","wider","widest"]},classGroups:{aspect:[{aspect:["auto","square",Md,Nt,Tt,B]}],container:["container"],columns:[{columns:[xs,Nt,Tt,P]}],"break-after":[{"break-after":Z()}],"break-before":[{"break-before":Z()}],"break-inside":[{"break-inside":["auto","avoid","avoid-page","avoid-column"]}],"box-decoration":[{"box-decoration":["slice","clone"]}],box:[{box:["border","content"]}],display:["block","inline-block","inline","flex","inline-flex","table","inline-table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row-group","table-row","flow-root","grid","inline-grid","contents","list-item","hidden"],sr:["sr-only","not-sr-only"],float:[{float:["right","left","none","start","end"]}],clear:[{clear:["left","right","both","none","start","end"]}],isolation:["isolate","isolation-auto"],"object-fit":[{object:["contain","cover","fill","none","scale-down"]}],"object-position":[{object:ie()}],overflow:[{overflow:ue()}],"overflow-x":[{"overflow-x":ue()}],"overflow-y":[{"overflow-y":ue()}],overscroll:[{overscroll:Ne()}],"overscroll-x":[{"overscroll-x":Ne()}],"overscroll-y":[{"overscroll-y":Ne()}],position:["static","fixed","absolute","relative","sticky"],inset:[{inset:Q()}],"inset-x":[{"inset-x":Q()}],"inset-y":[{"inset-y":Q()}],start:[{start:Q()}],end:[{end:Q()}],top:[{top:Q()}],right:[{right:Q()}],bottom:[{bottom:Q()}],left:[{left:Q()}],visibility:["visible","invisible","collapse"],z:[{z:[rc,"auto",Tt,Nt]}],basis:[{basis:[Md,"full","auto",P,...be()]}],"flex-direction":[{flex:["row","row-reverse","col","col-reverse"]}],"flex-wrap":[{flex:["nowrap","wrap","wrap-reverse"]}],flex:[{flex:[xs,Md,"auto","initial","none",Nt]}],grow:[{grow:["",xs,Tt,Nt]}],shrink:[{shrink:["",xs,Tt,Nt]}],order:[{order:[rc,"first","last","none",Tt,Nt]}],"grid-cols":[{"grid-cols":pe()}],"col-start-end":[{col:he()}],"col-start":[{"col-start":Ae()}],"col-end":[{"col-end":Ae()}],"grid-rows":[{"grid-rows":pe()}],"row-start-end":[{row:he()}],"row-start":[{"row-start":Ae()}],"row-end":[{"row-end":Ae()}],"grid-flow":[{"grid-flow":["row","col","dense","row-dense","col-dense"]}],"auto-cols":[{"auto-cols":fe()}],"auto-rows":[{"auto-rows":fe()}],gap:[{gap:be()}],"gap-x":[{"gap-x":be()}],"gap-y":[{"gap-y":be()}],"justify-content":[{justify:[...le(),"normal"]}],"justify-items":[{"justify-items":[...we(),"normal"]}],"justify-self":[{"justify-self":["auto",...we()]}],"align-content":[{content:["normal",...le()]}],"align-items":[{items:[...we(),{baseline:["","last"]}]}],"align-self":[{self:["auto",...we(),{baseline:["","last"]}]}],"place-content":[{"place-content":le()}],"place-items":[{"place-items":[...we(),"baseline"]}],"place-self":[{"place-self":["auto",...we()]}],p:[{p:be()}],px:[{px:be()}],py:[{py:be()}],ps:[{ps:be()}],pe:[{pe:be()}],pt:[{pt:be()}],pr:[{pr:be()}],pb:[{pb:be()}],pl:[{pl:be()}],m:[{m:re()}],mx:[{mx:re()}],my:[{my:re()}],ms:[{ms:re()}],me:[{me:re()}],mt:[{mt:re()}],mr:[{mr:re()}],mb:[{mb:re()}],ml:[{ml:re()}],"space-x":[{"space-x":be()}],"space-x-reverse":["space-x-reverse"],"space-y":[{"space-y":be()}],"space-y-reverse":["space-y-reverse"],size:[{size:oe()}],w:[{w:[P,"screen",...oe()]}],"min-w":[{"min-w":[P,"screen","none",...oe()]}],"max-w":[{"max-w":[P,"screen","none","prose",{screen:[R]},...oe()]}],h:[{h:["screen","lh",...oe()]}],"min-h":[{"min-h":["screen","lh","none",...oe()]}],"max-h":[{"max-h":["screen","lh",...oe()]}],"font-size":[{text:["base",x,Ch,cl]}],"font-smoothing":["antialiased","subpixel-antialiased"],"font-style":["italic","not-italic"],"font-weight":[{font:[_,Tt,eE]}],"font-stretch":[{"font-stretch":["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded",Zv,Nt]}],"font-family":[{font:[M$,Nt,f]}],"fvn-normal":["normal-nums"],"fvn-ordinal":["ordinal"],"fvn-slashed-zero":["slashed-zero"],"fvn-figure":["lining-nums","oldstyle-nums"],"fvn-spacing":["proportional-nums","tabular-nums"],"fvn-fraction":["diagonal-fractions","stacked-fractions"],tracking:[{tracking:[E,Tt,Nt]}],"line-clamp":[{"line-clamp":[xs,"none",Tt,eE]}],leading:[{leading:[y,...be()]}],"list-image":[{"list-image":["none",Tt,Nt]}],"list-style-position":[{list:["inside","outside"]}],"list-style-type":[{list:["disc","decimal","none",Tt,Nt]}],"text-alignment":[{text:["left","center","right","justify","start","end"]}],"placeholder-color":[{placeholder:J()}],"text-color":[{text:J()}],"text-decoration":["underline","overline","line-through","no-underline"],"text-decoration-style":[{decoration:[...ht(),"wavy"]}],"text-decoration-thickness":[{decoration:[xs,"from-font","auto",Tt,cl]}],"text-decoration-color":[{decoration:J()}],"underline-offset":[{"underline-offset":[xs,"auto",Tt,Nt]}],"text-transform":["uppercase","lowercase","capitalize","normal-case"],"text-overflow":["truncate","text-ellipsis","text-clip"],"text-wrap":[{text:["wrap","nowrap","balance","pretty"]}],indent:[{indent:be()}],"vertical-align":[{align:["baseline","top","middle","bottom","text-top","text-bottom","sub","super",Tt,Nt]}],whitespace:[{whitespace:["normal","nowrap","pre","pre-line","pre-wrap","break-spaces"]}],break:[{break:["normal","words","all","keep"]}],wrap:[{wrap:["break-word","anywhere","normal"]}],hyphens:[{hyphens:["none","manual","auto"]}],content:[{content:["none",Tt,Nt]}],"bg-attachment":[{bg:["fixed","local","scroll"]}],"bg-clip":[{"bg-clip":["border","padding","content","text"]}],"bg-origin":[{"bg-origin":["border","padding","content"]}],"bg-position":[{bg:Oe()}],"bg-repeat":[{bg:$e()}],"bg-size":[{bg:He()}],"bg-image":[{bg:["none",{linear:[{to:["t","tr","r","br","b","bl","l","tl"]},rc,Tt,Nt],radial:["",Tt,Nt],conic:[rc,Tt,Nt]},V$,L$]}],"bg-color":[{bg:J()}],"gradient-from-pos":[{from:ot()}],"gradient-via-pos":[{via:ot()}],"gradient-to-pos":[{to:ot()}],"gradient-from":[{from:J()}],"gradient-via":[{via:J()}],"gradient-to":[{to:J()}],rounded:[{rounded:_t()}],"rounded-s":[{"rounded-s":_t()}],"rounded-e":[{"rounded-e":_t()}],"rounded-t":[{"rounded-t":_t()}],"rounded-r":[{"rounded-r":_t()}],"rounded-b":[{"rounded-b":_t()}],"rounded-l":[{"rounded-l":_t()}],"rounded-ss":[{"rounded-ss":_t()}],"rounded-se":[{"rounded-se":_t()}],"rounded-ee":[{"rounded-ee":_t()}],"rounded-es":[{"rounded-es":_t()}],"rounded-tl":[{"rounded-tl":_t()}],"rounded-tr":[{"rounded-tr":_t()}],"rounded-br":[{"rounded-br":_t()}],"rounded-bl":[{"rounded-bl":_t()}],"border-w":[{border:Ke()}],"border-w-x":[{"border-x":Ke()}],"border-w-y":[{"border-y":Ke()}],"border-w-s":[{"border-s":Ke()}],"border-w-e":[{"border-e":Ke()}],"border-w-t":[{"border-t":Ke()}],"border-w-r":[{"border-r":Ke()}],"border-w-b":[{"border-b":Ke()}],"border-w-l":[{"border-l":Ke()}],"divide-x":[{"divide-x":Ke()}],"divide-x-reverse":["divide-x-reverse"],"divide-y":[{"divide-y":Ke()}],"divide-y-reverse":["divide-y-reverse"],"border-style":[{border:[...ht(),"hidden","none"]}],"divide-style":[{divide:[...ht(),"hidden","none"]}],"border-color":[{border:J()}],"border-color-x":[{"border-x":J()}],"border-color-y":[{"border-y":J()}],"border-color-s":[{"border-s":J()}],"border-color-e":[{"border-e":J()}],"border-color-t":[{"border-t":J()}],"border-color-r":[{"border-r":J()}],"border-color-b":[{"border-b":J()}],"border-color-l":[{"border-l":J()}],"divide-color":[{divide:J()}],"outline-style":[{outline:[...ht(),"none","hidden"]}],"outline-offset":[{"outline-offset":[xs,Tt,Nt]}],"outline-w":[{outline:["",xs,Ch,cl]}],"outline-color":[{outline:J()}],shadow:[{shadow:["","none",F,Xf,qf]}],"shadow-color":[{shadow:J()}],"inset-shadow":[{"inset-shadow":["none",k,Xf,qf]}],"inset-shadow-color":[{"inset-shadow":J()}],"ring-w":[{ring:Ke()}],"ring-w-inset":["ring-inset"],"ring-color":[{ring:J()}],"ring-offset-w":[{"ring-offset":[xs,cl]}],"ring-offset-color":[{"ring-offset":J()}],"inset-ring-w":[{"inset-ring":Ke()}],"inset-ring-color":[{"inset-ring":J()}],"text-shadow":[{"text-shadow":["none",X,Xf,qf]}],"text-shadow-color":[{"text-shadow":J()}],opacity:[{opacity:[xs,Tt,Nt]}],"mix-blend":[{"mix-blend":[...st(),"plus-darker","plus-lighter"]}],"bg-blend":[{"bg-blend":st()}],"mask-clip":[{"mask-clip":["border","padding","content","fill","stroke","view"]},"mask-no-clip"],"mask-composite":[{mask:["add","subtract","intersect","exclude"]}],"mask-image-linear-pos":[{"mask-linear":[xs]}],"mask-image-linear-from-pos":[{"mask-linear-from":ct()}],"mask-image-linear-to-pos":[{"mask-linear-to":ct()}],"mask-image-linear-from-color":[{"mask-linear-from":J()}],"mask-image-linear-to-color":[{"mask-linear-to":J()}],"mask-image-t-from-pos":[{"mask-t-from":ct()}],"mask-image-t-to-pos":[{"mask-t-to":ct()}],"mask-image-t-from-color":[{"mask-t-from":J()}],"mask-image-t-to-color":[{"mask-t-to":J()}],"mask-image-r-from-pos":[{"mask-r-from":ct()}],"mask-image-r-to-pos":[{"mask-r-to":ct()}],"mask-image-r-from-color":[{"mask-r-from":J()}],"mask-image-r-to-color":[{"mask-r-to":J()}],"mask-image-b-from-pos":[{"mask-b-from":ct()}],"mask-image-b-to-pos":[{"mask-b-to":ct()}],"mask-image-b-from-color":[{"mask-b-from":J()}],"mask-image-b-to-color":[{"mask-b-to":J()}],"mask-image-l-from-pos":[{"mask-l-from":ct()}],"mask-image-l-to-pos":[{"mask-l-to":ct()}],"mask-image-l-from-color":[{"mask-l-from":J()}],"mask-image-l-to-color":[{"mask-l-to":J()}],"mask-image-x-from-pos":[{"mask-x-from":ct()}],"mask-image-x-to-pos":[{"mask-x-to":ct()}],"mask-image-x-from-color":[{"mask-x-from":J()}],"mask-image-x-to-color":[{"mask-x-to":J()}],"mask-image-y-from-pos":[{"mask-y-from":ct()}],"mask-image-y-to-pos":[{"mask-y-to":ct()}],"mask-image-y-from-color":[{"mask-y-from":J()}],"mask-image-y-to-color":[{"mask-y-to":J()}],"mask-image-radial":[{"mask-radial":[Tt,Nt]}],"mask-image-radial-from-pos":[{"mask-radial-from":ct()}],"mask-image-radial-to-pos":[{"mask-radial-to":ct()}],"mask-image-radial-from-color":[{"mask-radial-from":J()}],"mask-image-radial-to-color":[{"mask-radial-to":J()}],"mask-image-radial-shape":[{"mask-radial":["circle","ellipse"]}],"mask-image-radial-size":[{"mask-radial":[{closest:["side","corner"],farthest:["side","corner"]}]}],"mask-image-radial-pos":[{"mask-radial-at":te()}],"mask-image-conic-pos":[{"mask-conic":[xs]}],"mask-image-conic-from-pos":[{"mask-conic-from":ct()}],"mask-image-conic-to-pos":[{"mask-conic-to":ct()}],"mask-image-conic-from-color":[{"mask-conic-from":J()}],"mask-image-conic-to-color":[{"mask-conic-to":J()}],"mask-mode":[{mask:["alpha","luminance","match"]}],"mask-origin":[{"mask-origin":["border","padding","content","fill","stroke","view"]}],"mask-position":[{mask:Oe()}],"mask-repeat":[{mask:$e()}],"mask-size":[{mask:He()}],"mask-type":[{"mask-type":["alpha","luminance"]}],"mask-image":[{mask:["none",Tt,Nt]}],filter:[{filter:["","none",Tt,Nt]}],blur:[{blur:fs()}],brightness:[{brightness:[xs,Tt,Nt]}],contrast:[{contrast:[xs,Tt,Nt]}],"drop-shadow":[{"drop-shadow":["","none",q,Xf,qf]}],"drop-shadow-color":[{"drop-shadow":J()}],grayscale:[{grayscale:["",xs,Tt,Nt]}],"hue-rotate":[{"hue-rotate":[xs,Tt,Nt]}],invert:[{invert:["",xs,Tt,Nt]}],saturate:[{saturate:[xs,Tt,Nt]}],sepia:[{sepia:["",xs,Tt,Nt]}],"backdrop-filter":[{"backdrop-filter":["","none",Tt,Nt]}],"backdrop-blur":[{"backdrop-blur":fs()}],"backdrop-brightness":[{"backdrop-brightness":[xs,Tt,Nt]}],"backdrop-contrast":[{"backdrop-contrast":[xs,Tt,Nt]}],"backdrop-grayscale":[{"backdrop-grayscale":["",xs,Tt,Nt]}],"backdrop-hue-rotate":[{"backdrop-hue-rotate":[xs,Tt,Nt]}],"backdrop-invert":[{"backdrop-invert":["",xs,Tt,Nt]}],"backdrop-opacity":[{"backdrop-opacity":[xs,Tt,Nt]}],"backdrop-saturate":[{"backdrop-saturate":[xs,Tt,Nt]}],"backdrop-sepia":[{"backdrop-sepia":["",xs,Tt,Nt]}],"border-collapse":[{border:["collapse","separate"]}],"border-spacing":[{"border-spacing":be()}],"border-spacing-x":[{"border-spacing-x":be()}],"border-spacing-y":[{"border-spacing-y":be()}],"table-layout":[{table:["auto","fixed"]}],caption:[{caption:["top","bottom"]}],transition:[{transition:["","all","colors","opacity","shadow","transform","none",Tt,Nt]}],"transition-behavior":[{transition:["normal","discrete"]}],duration:[{duration:[xs,"initial",Tt,Nt]}],ease:[{ease:["linear","initial",ne,Tt,Nt]}],delay:[{delay:[xs,Tt,Nt]}],animate:[{animate:["none",ae,Tt,Nt]}],backface:[{backface:["hidden","visible"]}],perspective:[{perspective:[H,Tt,Nt]}],"perspective-origin":[{"perspective-origin":ie()}],rotate:[{rotate:ys()}],"rotate-x":[{"rotate-x":ys()}],"rotate-y":[{"rotate-y":ys()}],"rotate-z":[{"rotate-z":ys()}],scale:[{scale:As()}],"scale-x":[{"scale-x":As()}],"scale-y":[{"scale-y":As()}],"scale-z":[{"scale-z":As()}],"scale-3d":["scale-3d"],skew:[{skew:zs()}],"skew-x":[{"skew-x":zs()}],"skew-y":[{"skew-y":zs()}],transform:[{transform:[Tt,Nt,"","none","gpu","cpu"]}],"transform-origin":[{origin:ie()}],"transform-style":[{transform:["3d","flat"]}],translate:[{translate:je()}],"translate-x":[{"translate-x":je()}],"translate-y":[{"translate-y":je()}],"translate-z":[{"translate-z":je()}],"translate-none":["translate-none"],accent:[{accent:J()}],appearance:[{appearance:["none","auto"]}],"caret-color":[{caret:J()}],"color-scheme":[{scheme:["normal","dark","light","light-dark","only-dark","only-light"]}],cursor:[{cursor:["auto","default","pointer","wait","text","move","help","not-allowed","none","context-menu","progress","cell","crosshair","vertical-text","alias","copy","no-drop","grab","grabbing","all-scroll","col-resize","row-resize","n-resize","e-resize","s-resize","w-resize","ne-resize","nw-resize","se-resize","sw-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out",Tt,Nt]}],"field-sizing":[{"field-sizing":["fixed","content"]}],"pointer-events":[{"pointer-events":["auto","none"]}],resize:[{resize:["none","","y","x"]}],"scroll-behavior":[{scroll:["auto","smooth"]}],"scroll-m":[{"scroll-m":be()}],"scroll-mx":[{"scroll-mx":be()}],"scroll-my":[{"scroll-my":be()}],"scroll-ms":[{"scroll-ms":be()}],"scroll-me":[{"scroll-me":be()}],"scroll-mt":[{"scroll-mt":be()}],"scroll-mr":[{"scroll-mr":be()}],"scroll-mb":[{"scroll-mb":be()}],"scroll-ml":[{"scroll-ml":be()}],"scroll-p":[{"scroll-p":be()}],"scroll-px":[{"scroll-px":be()}],"scroll-py":[{"scroll-py":be()}],"scroll-ps":[{"scroll-ps":be()}],"scroll-pe":[{"scroll-pe":be()}],"scroll-pt":[{"scroll-pt":be()}],"scroll-pr":[{"scroll-pr":be()}],"scroll-pb":[{"scroll-pb":be()}],"scroll-pl":[{"scroll-pl":be()}],"snap-align":[{snap:["start","end","center","align-none"]}],"snap-stop":[{snap:["normal","always"]}],"snap-type":[{snap:["none","x","y","both"]}],"snap-strictness":[{snap:["mandatory","proximity"]}],touch:[{touch:["auto","none","manipulation"]}],"touch-x":[{"touch-pan":["x","left","right"]}],"touch-y":[{"touch-pan":["y","up","down"]}],"touch-pz":["touch-pinch-zoom"],select:[{select:["none","text","all","auto"]}],"will-change":[{"will-change":["auto","scroll","contents","transform",Tt,Nt]}],fill:[{fill:["none",...J()]}],"stroke-w":[{stroke:[xs,Ch,cl,eE]}],stroke:[{stroke:["none",...J()]}],"forced-color-adjust":[{"forced-color-adjust":["auto","none"]}]},conflictingClassGroups:{overflow:["overflow-x","overflow-y"],overscroll:["overscroll-x","overscroll-y"],inset:["inset-x","inset-y","start","end","top","right","bottom","left"],"inset-x":["right","left"],"inset-y":["top","bottom"],flex:["basis","grow","shrink"],gap:["gap-x","gap-y"],p:["px","py","ps","pe","pt","pr","pb","pl"],px:["pr","pl"],py:["pt","pb"],m:["mx","my","ms","me","mt","mr","mb","ml"],mx:["mr","ml"],my:["mt","mb"],size:["w","h"],"font-size":["leading"],"fvn-normal":["fvn-ordinal","fvn-slashed-zero","fvn-figure","fvn-spacing","fvn-fraction"],"fvn-ordinal":["fvn-normal"],"fvn-slashed-zero":["fvn-normal"],"fvn-figure":["fvn-normal"],"fvn-spacing":["fvn-normal"],"fvn-fraction":["fvn-normal"],"line-clamp":["display","overflow"],rounded:["rounded-s","rounded-e","rounded-t","rounded-r","rounded-b","rounded-l","rounded-ss","rounded-se","rounded-ee","rounded-es","rounded-tl","rounded-tr","rounded-br","rounded-bl"],"rounded-s":["rounded-ss","rounded-es"],"rounded-e":["rounded-se","rounded-ee"],"rounded-t":["rounded-tl","rounded-tr"],"rounded-r":["rounded-tr","rounded-br"],"rounded-b":["rounded-br","rounded-bl"],"rounded-l":["rounded-tl","rounded-bl"],"border-spacing":["border-spacing-x","border-spacing-y"],"border-w":["border-w-x","border-w-y","border-w-s","border-w-e","border-w-t","border-w-r","border-w-b","border-w-l"],"border-w-x":["border-w-r","border-w-l"],"border-w-y":["border-w-t","border-w-b"],"border-color":["border-color-x","border-color-y","border-color-s","border-color-e","border-color-t","border-color-r","border-color-b","border-color-l"],"border-color-x":["border-color-r","border-color-l"],"border-color-y":["border-color-t","border-color-b"],translate:["translate-x","translate-y","translate-none"],"translate-none":["translate","translate-x","translate-y","translate-z"],"scroll-m":["scroll-mx","scroll-my","scroll-ms","scroll-me","scroll-mt","scroll-mr","scroll-mb","scroll-ml"],"scroll-mx":["scroll-mr","scroll-ml"],"scroll-my":["scroll-mt","scroll-mb"],"scroll-p":["scroll-px","scroll-py","scroll-ps","scroll-pe","scroll-pt","scroll-pr","scroll-pb","scroll-pl"],"scroll-px":["scroll-pr","scroll-pl"],"scroll-py":["scroll-pt","scroll-pb"],touch:["touch-x","touch-y","touch-pz"],"touch-x":["touch"],"touch-y":["touch"],"touch-pz":["touch"]},conflictingClassGroupModifiers:{"font-size":["leading"]},orderSensitiveModifiers:["*","**","after","backdrop","before","details-content","file","first-letter","first-line","marker","placeholder","selection"]}},W$=y$(G$);function Er(...u){return W$(u2(u))}const H$=Math.sqrt(5e3),z$=[{tempId:0,testimonial:"My favorite solution in the market. We work 5x faster with COMPANY.",by:"Alex, CEO at TechCorp",imgSrc:"https://i.pravatar.cc/150?img=1"},{tempId:1,testimonial:"I'm confident my data is safe with COMPANY. I can't say that about other providers.",by:"Dan, CTO at SecureNet",imgSrc:"https://i.pravatar.cc/150?img=2"},{tempId:2,testimonial:"I know it's cliche, but we were lost before we found COMPANY. Can't thank you guys enough!",by:"Stephanie, COO at InnovateCo",imgSrc:"https://i.pravatar.cc/150?img=3"},{tempId:3,testimonial:"COMPANY's products make planning for the future seamless. Can't recommend them enough!",by:"Marie, CFO at FuturePlanning",imgSrc:"https://i.pravatar.cc/150?img=4"},{tempId:4,testimonial:"If I could give 11 stars, I'd give 12.",by:"Andre, Head of Design at CreativeSolutions",imgSrc:"https://i.pravatar.cc/150?img=5"},{tempId:5,testimonial:"SO SO SO HAPPY WE FOUND YOU GUYS!!!! I'd bet you've saved me 100 hours so far.",by:"Jeremy, Product Manager at TimeWise",imgSrc:"https://i.pravatar.cc/150?img=6"},{tempId:6,testimonial:"Took some convincing, but now that we're on COMPANY, we're never going back.",by:"Pam, Marketing Director at BrandBuilders",imgSrc:"https://i.pravatar.cc/150?img=7"},{tempId:7,testimonial:"I would be lost without COMPANY's in-depth analytics. The ROI is EASILY 100X for us.",by:"Daniel, Data Scientist at AnalyticsPro",imgSrc:"https://i.pravatar.cc/150?img=8"},{tempId:8,testimonial:"It's just the best. Period.",by:"Fernando, UX Designer at UserFirst",imgSrc:"https://i.pravatar.cc/150?img=9"},{tempId:9,testimonial:"I switched 5 years ago and never looked back.",by:"Andy, DevOps Engineer at CloudMasters",imgSrc:"https://i.pravatar.cc/150?img=10"},{tempId:10,testimonial:"I've been searching for a solution like COMPANY for YEARS. So glad I finally found one!",by:"Pete, Sales Director at RevenueRockets",imgSrc:"https://i.pravatar.cc/150?img=11"},{tempId:11,testimonial:"It's so simple and intuitive, we got the team up to speed in 10 minutes.",by:"Marina, HR Manager at TalentForge",imgSrc:"https://i.pravatar.cc/150?img=12"},{tempId:12,testimonial:"COMPANY's customer support is unparalleled. They're always there when we need them.",by:"Olivia, Customer Success Manager at ClientCare",imgSrc:"https://i.pravatar.cc/150?img=13"},{tempId:13,testimonial:"The efficiency gains we've seen since implementing COMPANY are off the charts!",by:"Raj, Operations Manager at StreamlineSolutions",imgSrc:"https://i.pravatar.cc/150?img=14"},{tempId:14,testimonial:"COMPANY has revolutionized how we handle our workflow. It's a game-changer!",by:"Lila, Workflow Specialist at ProcessPro",imgSrc:"https://i.pravatar.cc/150?img=15"},{tempId:15,testimonial:"The scalability of COMPANY's solution is impressive. It grows with our business seamlessly.",by:"Trevor, Scaling Officer at GrowthGurus",imgSrc:"https://i.pravatar.cc/150?img=16"},{tempId:16,testimonial:"I appreciate how COMPANY continually innovates. They're always one step ahead.",by:"Naomi, Innovation Lead at FutureTech",imgSrc:"https://i.pravatar.cc/150?img=17"},{tempId:17,testimonial:"The ROI we've seen with COMPANY is incredible. It's paid for itself many times over.",by:"Victor, Finance Analyst at ProfitPeak",imgSrc:"https://i.pravatar.cc/150?img=18"},{tempId:18,testimonial:"COMPANY's platform is so robust, yet easy to use. It's the perfect balance.",by:"Yuki, Tech Lead at BalancedTech",imgSrc:"https://i.pravatar.cc/150?img=19"},{tempId:19,testimonial:"We've tried many solutions, but COMPANY stands out in terms of reliability and performance.",by:"Zoe, Performance Manager at ReliableSystems",imgSrc:"https://i.pravatar.cc/150?img=20"}],K$=({position:u,testimonial:f,handleMove:x,cardSize:_})=>{const E=u===0;return a.jsxs("div",{onClick:()=>x(u),className:Er("absolute left-1/2 top-1/2 cursor-pointer border-2 p-8 transition-all duration-500 ease-in-out",E?"z-10 bg-gradient-to-br from-[#0a3d5c] to-[#0d5a8a] text-white border-cyan-400/60":"z-0 bg-gradient-to-br from-[#0a3d5c]/40 to-[#0d5a8a]/40 text-cyan-100 border-cyan-400/20 hover:border-cyan-400/40"),style:{width:_,height:_,clipPath:"polygon(50px 0%, calc(100% - 50px) 0%, 100% 50px, 100% 100%, calc(100% - 50px) 100%, 50px 100%, 0 100%, 0 0)",transform:`
          translate(-50%, -50%) 
          translateX(${_/1.5*u}px)
          translateY(${E?-65:u%2?15:-15}px)
          rotate(${E?0:u%2?2.5:-2.5}deg)
        `,boxShadow:E?"0px 8px 0px 4px hsl(var(--border))":"0px 0px 0px 0px transparent"},children:[a.jsx("span",{className:"absolute block origin-top-right rotate-45 bg-border",style:{right:-2,top:48,width:H$,height:2}}),a.jsx("img",{src:f.imgSrc,alt:`${f.by.split(",")[0]}`,className:"mb-4 h-14 w-12 bg-muted object-cover object-top",style:{boxShadow:"3px 3px 0px hsl(var(--background))"}}),a.jsxs("h3",{className:Er("text-base sm:text-xl font-medium",E?"text-white":"text-cyan-100"),children:['"',f.testimonial,'"']}),a.jsxs("p",{className:Er("absolute bottom-8 left-8 right-8 mt-2 text-sm italic",E?"text-white/80":"text-cyan-100/60"),children:["- ",f.by]})]})},Y$=()=>{const[u,f]=j.useState(365),[x,_]=j.useState(z$),E=y=>{const R=[...x];if(y>0)for(let P=y;P>0;P--){const U=R.shift();if(!U)return;R.push({...U,tempId:Math.random()})}else for(let P=y;P<0;P++){const U=R.pop();if(!U)return;R.unshift({...U,tempId:Math.random()})}_(R)};return j.useEffect(()=>{const y=()=>{const{matches:R}=window.matchMedia("(min-width: 640px)");f(R?365:290)};return y(),window.addEventListener("resize",y),()=>window.removeEventListener("resize",y)},[]),a.jsxs("div",{className:"relative w-full overflow-hidden bg-muted/30",style:{height:600},children:[x.map((y,R)=>{const P=x.length%2?R-(x.length+1)/2:R-x.length/2;return a.jsx(K$,{testimonial:y,handleMove:E,position:P,cardSize:u},y.tempId)}),a.jsxs("div",{className:"absolute bottom-4 left-1/2 flex -translate-x-1/2 gap-2",children:[a.jsx("button",{onClick:()=>E(-1),className:Er("flex h-14 w-14 items-center justify-center text-2xl transition-colors","bg-background border-2 border-border hover:bg-primary hover:text-primary-foreground","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"),"aria-label":"Previous testimonial",children:a.jsx(iE,{})}),a.jsx("button",{onClick:()=>E(1),className:Er("flex h-14 w-14 items-center justify-center text-2xl transition-colors","bg-background border-2 border-border hover:bg-primary hover:text-primary-foreground","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"),"aria-label":"Next testimonial",children:a.jsx(xo,{})})]})]})};function q$(){const u=j.useRef(null);return j.useEffect(()=>{const f=async()=>{const _=(E,y)=>new Promise((R,P)=>{if(window[y]){R();return}if(document.querySelector(`script[src="${E}"]`)){const G=setInterval(()=>{window[y]&&(clearInterval(G),R())},50);setTimeout(()=>{clearInterval(G),P(new Error(`Timeout waiting for ${y}`))},1e4);return}const U=document.createElement("script");U.src=E,U.onload=()=>{setTimeout(()=>R(),100)},U.onerror=()=>P(new Error(`Failed to load ${E}`)),document.head.appendChild(U)});try{await _("https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js","gsap"),await _("https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js","THREE")}catch(E){console.error("Failed to load base scripts:",E)}x()},x=async()=>{const _={settings:{transitionDuration:1.2,autoSlideSpeed:5e3,currentEffect:"glass",currentEffectPreset:"Default",globalIntensity:1,speedMultiplier:1,distortionStrength:1,colorEnhancement:1,glassRefractionStrength:1,glassChromaticAberration:1,glassBubbleClarity:1,glassEdgeGlow:1,glassLiquidFlow:1,frostIntensity:1.5,frostCrystalSize:1,frostIceCoverage:1,frostTemperature:1,frostTexture:1,rippleFrequency:25,rippleAmplitude:.08,rippleWaveSpeed:1,rippleRippleCount:1,rippleDecay:1,plasmaIntensity:1.2,plasmaSpeed:.8,plasmaEnergyIntensity:.4,plasmaContrastBoost:.3,plasmaTurbulence:1,timeshiftDistortion:1.6,timeshiftBlur:1.5,timeshiftFlow:1.4,timeshiftChromatic:1.5,timeshiftTurbulence:1.4}};let E=0,y=!1,R,P,U,G,F=[],k=!1,X=null,q=null,D=!1;const H=()=>_.settings.autoSlideSpeed,B=50,ne=()=>_.settings.transitionDuration,ae=[{title:"Ai Lab report Analyser",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/AILabReportAnalyser_DesktopSize_3f161f3f-0678-452f-9c1a-a413994df30a.png?v=1770719872",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/AILabReportAnalyser_MobileSize.png?v=1770719520"},{title:"Track Health Parameter",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/NutritionTracker_jpg.jpg?v=1770722505",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/TrackHealthParameter_MobileSize_jpg.jpg?v=1770719520"},{title:"Nutrition Tracker",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/TrackHealthParameter_DesktopSize_jpg.jpg?v=1770719871",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/NutritionTrackerMobile_jpg.jpg?v=1770722504"},{title:"Diet Recommendations",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/WhatsApp_Image_2026-02-07_at_6.44.25_PM.jpg?v=1770707929",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/2150040498_2__jpg.jpg?v=1770722504"},{title:"Supplement Recommendation",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/2150040498_jpg_f6df5fdb-1a8b-4c71-97ec-58643d0dca22.jpg?v=1770722509",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/NutritionTrackerMobile_jpg.jpg?v=1770722504"},{title:"Doctor Recommendation",description:"",media:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/WhatsApp_Image_2026-02-07_at_6.43.52_PM.jpg?v=1770707929",mediaMobile:"https://cdn.shopify.com/s/files/1/0636/5226/6115/files/TrackHealthParameter_MobileSize_jpg.jpg?v=1770719520"}],Z="varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }",te=`
            uniform sampler2D uTexture1, uTexture2;
            uniform float uProgress;
            uniform vec2 uResolution, uTexture1Size, uTexture2Size;
            uniform int uEffectType;
            uniform float uGlobalIntensity, uSpeedMultiplier, uDistortionStrength, uColorEnhancement;
            uniform float uGlassRefractionStrength, uGlassChromaticAberration, uGlassBubbleClarity, uGlassEdgeGlow, uGlassLiquidFlow;
            uniform float uFrostIntensity, uFrostCrystalSize, uFrostIceCoverage, uFrostTemperature, uFrostTexture;
            uniform float uRippleFrequency, uRippleAmplitude, uRippleWaveSpeed, uRippleRippleCount, uRippleDecay;
            uniform float uPlasmaIntensity, uPlasmaSpeed, uPlasmaEnergyIntensity, uPlasmaContrastBoost, uPlasmaTurbulence;
            uniform float uTimeshiftDistortion, uTimeshiftBlur, uTimeshiftFlow, uTimeshiftChromatic, uTimeshiftTurbulence;
            varying vec2 vUv;

            vec2 getCoverUV(vec2 uv, vec2 textureSize) {
                vec2 s = uResolution / textureSize;
                float scale = max(s.x, s.y);
                vec2 scaledSize = textureSize * scale;
                vec2 offset = (uResolution - scaledSize) * 0.5;
                return (uv * uResolution - offset) / scaledSize;
            }
            float noise(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
            
            vec4 glassEffect(vec2 uv, float progress) {
                float time = progress * 5.0 * uSpeedMultiplier;
                vec2 uv1 = getCoverUV(uv, uTexture1Size); vec2 uv2 = getCoverUV(uv, uTexture2Size);
                float maxR = length(uResolution) * 0.85; float br = progress * maxR;
                vec2 p = uv * uResolution; vec2 c = uResolution * 0.5;
                float d = length(p - c); float nd = d / max(br, 0.001);
                float param = smoothstep(br + 3.0, br - 3.0, d); // Inside circle
                vec4 img;
                if (param > 0.0) {
                     float ro = 0.08 * uGlassRefractionStrength * uDistortionStrength * uGlobalIntensity * pow(smoothstep(0.3 * uGlassBubbleClarity, 1.0, nd), 1.5);
                     vec2 dir = (d > 0.0) ? (p - c) / d : vec2(0.0);
                     vec2 distUV = uv2 - dir * ro;
                     distUV += vec2(sin(time + nd * 10.0), cos(time * 0.8 + nd * 8.0)) * 0.015 * uGlassLiquidFlow * uSpeedMultiplier * nd * param;
                     float ca = 0.02 * uGlassChromaticAberration * uGlobalIntensity * pow(smoothstep(0.3, 1.0, nd), 1.2);
                     img = vec4(texture2D(uTexture2, distUV + dir * ca * 1.2).r, texture2D(uTexture2, distUV + dir * ca * 0.2).g, texture2D(uTexture2, distUV - dir * ca * 0.8).b, 1.0);
                     if (uGlassEdgeGlow > 0.0) {
                        float rim = smoothstep(0.95, 1.0, nd) * (1.0 - smoothstep(1.0, 1.01, nd));
                        img.rgb += rim * 0.08 * uGlassEdgeGlow * uGlobalIntensity;
                     }
                } else { img = texture2D(uTexture2, uv2); }
                vec4 oldImg = texture2D(uTexture1, uv1);
                if (progress > 0.95) img = mix(img, texture2D(uTexture2, uv2), (progress - 0.95) / 0.05);
                return mix(oldImg, img, param);
            }
            // Simplified stubs for other effects (to save space, logic is in glassEffect mainly for demo)
            vec4 frostEffect(vec2 uv, float progress) { return mix(texture2D(uTexture1, getCoverUV(uv, uTexture1Size)), texture2D(uTexture2, getCoverUV(uv, uTexture2Size)), progress); }
            vec4 rippleEffect(vec2 uv, float progress) { return mix(texture2D(uTexture1, getCoverUV(uv, uTexture1Size)), texture2D(uTexture2, getCoverUV(uv, uTexture2Size)), progress); }
            vec4 plasmaEffect(vec2 uv, float progress) { return mix(texture2D(uTexture1, getCoverUV(uv, uTexture1Size)), texture2D(uTexture2, getCoverUV(uv, uTexture2Size)), progress); }
            vec4 timeshiftEffect(vec2 uv, float progress) { return mix(texture2D(uTexture1, getCoverUV(uv, uTexture1Size)), texture2D(uTexture2, getCoverUV(uv, uTexture2Size)), progress); }

            void main() {
                if (uEffectType == 0) gl_FragColor = glassEffect(vUv, uProgress);
                else if (uEffectType == 1) gl_FragColor = frostEffect(vUv, uProgress);
                else if (uEffectType == 2) gl_FragColor = rippleEffect(vUv, uProgress);
                else if (uEffectType == 3) gl_FragColor = plasmaEffect(vUv, uProgress);
                else gl_FragColor = timeshiftEffect(vUv, uProgress);
            }
        `,ie=Ke=>({glass:0,frost:1,ripple:2,plasma:3,timeshift:4})[Ke]||0,ue=()=>{if(!R)return;const Ke=_.settings,ht=R.uniforms;for(const st in Ke){const ct="u"+st.charAt(0).toUpperCase()+st.slice(1);ht[ct]&&(ht[ct].value=Ke[st])}ht.uEffectType.value=ie(Ke.currentEffect)},Ne=Ke=>Ke.split("").map(ht=>`<span style="display: inline-block; opacity: 0;">${ht===" "?"&nbsp;":ht}</span>`).join(""),be=Ke=>{const ht=document.getElementById("mainTitle"),st=document.getElementById("mainDesc");ht&&st&&(gsap.to(ht.children,{y:-20,opacity:0,duration:.5,stagger:.02,ease:"power2.in"}),gsap.to(st,{y:-10,opacity:0,duration:.4,ease:"power2.in"}),setTimeout(()=>{ht.innerHTML=Ne(ae[Ke].title),st.textContent=ae[Ke].description,gsap.set(ht.children,{opacity:0}),gsap.set(st,{y:20,opacity:0});const ct=ht.children;switch(Ke){case 0:gsap.set(ct,{y:20}),gsap.to(ct,{y:0,opacity:1,duration:.8,stagger:.03,ease:"power3.out"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power3.out"});break;case 1:gsap.set(ct,{y:-20}),gsap.to(ct,{y:0,opacity:1,duration:.8,stagger:.03,ease:"back.out(1.7)"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power3.out"});break;case 2:gsap.set(ct,{filter:"blur(10px)",scale:1.5,y:0}),gsap.to(ct,{filter:"blur(0px)",scale:1,opacity:1,duration:1,stagger:{amount:.5,from:"random"},ease:"power2.out"}),gsap.to(st,{y:0,opacity:1,duration:1,delay:.3,ease:"power2.out"});break;case 3:gsap.set(ct,{scale:0,y:0}),gsap.to(ct,{scale:1,opacity:1,duration:.6,stagger:.05,ease:"back.out(1.5)"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power3.out"});break;case 4:gsap.set(ct,{rotationX:90,y:0,transformOrigin:"50% 50%"}),gsap.to(ct,{rotationX:0,opacity:1,duration:.8,stagger:.04,ease:"power2.out"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power2.out"});break;case 5:gsap.set(ct,{x:30,y:0}),gsap.to(ct,{x:0,opacity:1,duration:.8,stagger:.03,ease:"power3.out"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power3.out"});break;default:gsap.set(ct,{y:20}),gsap.to(ct,{y:0,opacity:1,duration:.8,stagger:.03,ease:"power3.out"}),gsap.to(st,{y:0,opacity:1,duration:.8,delay:.2,ease:"power3.out"})}},500))},Q=Ke=>{if(y||Ke===E)return;J(),we(E);const ht=F[E],st=F[Ke];!ht||!st||(y=!0,R.uniforms.uTexture1.value=ht,R.uniforms.uTexture2.value=st,R.uniforms.uTexture1Size.value=ht.userData.size,R.uniforms.uTexture2Size.value=st.userData.size,be(Ke),E=Ke,re(E),Ae(E),gsap.fromTo(R.uniforms.uProgress,{value:0},{value:1,duration:ne(),ease:"power2.inOut",onComplete:()=>{R.uniforms.uProgress.value=0,R.uniforms.uTexture1.value=st,R.uniforms.uTexture1Size.value=st.userData.size,y=!1,Oe(100)}}))},pe=()=>{y||!k||!D||Q((E+1)%ae.length)},he=()=>{const Ke=document.getElementById("slidesNav");Ke&&(Ke.children.length>0||ae.forEach((ht,st)=>{const ct=document.createElement("div");ct.className=`slide-nav-item${st===0?" active":""}`,ct.dataset.slideIndex=String(st),ct.innerHTML=`<div class="slide-progress-line"><div class="slide-progress-fill"></div></div><div class="slide-nav-title">${ht.title}</div>`,ct.addEventListener("click",fs=>{fs.stopPropagation(),!y&&st!==E&&(J(),we(E),Q(st))}),Ke.appendChild(ct)}))},Ae=Ke=>document.querySelectorAll(".slide-nav-item").forEach((ht,st)=>ht.classList.toggle("active",st===Ke)),fe=(Ke,ht)=>{var ct;const st=(ct=document.querySelectorAll(".slide-nav-item")[Ke])==null?void 0:ct.querySelector(".slide-progress-fill");st&&(st.style.width=`${ht}%`,st.style.opacity="1")},le=Ke=>{var st;const ht=(st=document.querySelectorAll(".slide-nav-item")[Ke])==null?void 0:st.querySelector(".slide-progress-fill");ht&&(ht.style.opacity="0",setTimeout(()=>ht.style.width="0%",300))},we=Ke=>{var st;const ht=(st=document.querySelectorAll(".slide-nav-item")[Ke])==null?void 0:st.querySelector(".slide-progress-fill");ht&&(ht.style.transition="width 0.2s ease-out",ht.style.width="0%",setTimeout(()=>ht.style.transition="width 0.1s ease, opacity 0.3s ease",200))},re=Ke=>{const ht=document.getElementById("slideNumber");ht&&(ht.textContent=String(Ke+1).padStart(2,"0"));const st=document.getElementById("slideTotal");st&&(st.textContent=String(ae.length).padStart(2,"0"))},oe=()=>{if(!k||!D||y)return;J();let Ke=0;const ht=100/H()*B;q=setInterval(()=>{if(!D||y){J();return}Ke+=ht,fe(E,Ke),Ke>=100&&(clearInterval(q),q=null,le(E),y||pe())},B)},J=()=>{q&&clearInterval(q),X&&clearTimeout(X),q=null,X=null},Oe=(Ke=0)=>{J(),D&&k&&(Ke>0?X=setTimeout(oe,Ke):oe())},$e=Ke=>new Promise((ht,st)=>{new THREE.TextureLoader().load(Ke,fs=>{fs.minFilter=fs.magFilter=THREE.LinearFilter,fs.userData={size:new THREE.Vector2(fs.image.width,fs.image.height)},ht(fs)},void 0,st)}),He=async()=>{var ct;const Ke=document.querySelector(".webgl-canvas");if(!Ke)return;U=new THREE.Scene,G=new THREE.OrthographicCamera(-1,1,1,-1,0,1),P=new THREE.WebGLRenderer({canvas:Ke,antialias:!1,alpha:!1}),P.setSize(window.innerWidth,window.innerHeight),P.setPixelRatio(Math.min(window.devicePixelRatio,2)),R=new THREE.ShaderMaterial({uniforms:{uTexture1:{value:null},uTexture2:{value:null},uProgress:{value:0},uResolution:{value:new THREE.Vector2(window.innerWidth,window.innerHeight)},uTexture1Size:{value:new THREE.Vector2(1,1)},uTexture2Size:{value:new THREE.Vector2(1,1)},uEffectType:{value:0},uGlobalIntensity:{value:1},uSpeedMultiplier:{value:1},uDistortionStrength:{value:1},uColorEnhancement:{value:1},uGlassRefractionStrength:{value:1},uGlassChromaticAberration:{value:1},uGlassBubbleClarity:{value:1},uGlassEdgeGlow:{value:1},uGlassLiquidFlow:{value:1},uFrostIntensity:{value:1},uFrostCrystalSize:{value:1},uFrostIceCoverage:{value:1},uFrostTemperature:{value:1},uFrostTexture:{value:1},uRippleFrequency:{value:25},uRippleAmplitude:{value:.08},uRippleWaveSpeed:{value:1},uRippleRippleCount:{value:1},uRippleDecay:{value:1},uPlasmaIntensity:{value:1.2},uPlasmaSpeed:{value:.8},uPlasmaEnergyIntensity:{value:.4},uPlasmaContrastBoost:{value:.3},uPlasmaTurbulence:{value:1},uTimeshiftDistortion:{value:1.6},uTimeshiftBlur:{value:1.5},uTimeshiftFlow:{value:1.4},uTimeshiftChromatic:{value:1.5},uTimeshiftTurbulence:{value:1.4}},vertexShader:Z,fragmentShader:te}),U.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2),R));const ht=window.innerWidth<=768;for(const fs of ae)try{const ys=ht&&fs.mediaMobile||fs.media;F.push(await $e(ys))}catch{console.warn("Failed texture")}F.length>=2&&(R.uniforms.uTexture1.value=F[0],R.uniforms.uTexture2.value=F[1],R.uniforms.uTexture1Size.value=F[0].userData.size,R.uniforms.uTexture2Size.value=F[1].userData.size,k=!0,D=!0,ue(),(ct=document.querySelector(".slider-wrapper"))==null||ct.classList.add("loaded"),Oe(500));const st=()=>{requestAnimationFrame(st),P.render(U,G)};st()};he(),re(0);const ot=document.getElementById("mainTitle"),_t=document.getElementById("mainDesc");ot&&_t&&(ot.innerHTML=Ne(ae[0].title),_t.textContent=ae[0].description,gsap.fromTo(ot.children,{y:20,opacity:0},{y:0,opacity:1,duration:1,stagger:.03,ease:"power3.out",delay:.5}),gsap.fromTo(_t,{y:20,opacity:0},{y:0,opacity:1,duration:1,ease:"power3.out",delay:.8})),He(),document.addEventListener("visibilitychange",()=>document.hidden?J():!y&&Oe()),window.addEventListener("resize",()=>{P&&(P.setSize(window.innerWidth,window.innerHeight),R.uniforms.uResolution.value.set(window.innerWidth,window.innerHeight))})};return f(),()=>{}},[]),a.jsxs(a.Fragment,{children:[a.jsx("style",{children:`
        .slider-wrapper {
          position: relative;
          width: 100%;
          height: 100vh;
          overflow: hidden;
          background: transparent;
          border-radius: 1.5rem;
        }

        .webgl-canvas {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border-radius: 1.5rem;
        }

        /* Slide Numbers - Left and Right */
        .slide-number, .slide-total {
          position: absolute;
          font-size: 2rem;
          font-weight: 300;
          color: rgba(255, 255, 255, 0.6);
          z-index: 10;
          letter-spacing: 2px;
        }

        .slide-number {
          top: 50%;
          left: 2rem;
          transform: translateY(-50%);
        }

        .slide-total {
          top: 50%;
          right: 2rem;
          transform: translateY(-50%);
        }

        /* Center Content */
        .slide-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          z-index: 5;
          width: 80%;
          max-width: 800px;
        }

        .slide-title {
          font-size: 2.5rem;
          font-weight: 300;
          color: white;
          margin: 0;
          margin-bottom: 1rem;
          letter-spacing: 2px;
          line-height: 1.2;
        }

        .slide-description {
          font-size: 1.1rem;
          color: rgba(255, 255, 255, 0.8);
          margin: 0;
          letter-spacing: 0.5px;
          line-height: 1.6;
        }

        /* Navigation at bottom */
        .slides-navigation {
          position: absolute;
          bottom: 2rem;
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 2rem;
          z-index: 10;
          width: 90%;
          max-width: 1200px;
          justify-content: center;
          flex-wrap: nowrap;
          overflow-x: hidden;
        }

        .slide-nav-item {
          cursor: pointer;
          position: relative;
          padding-bottom: 0.5rem;
          transition: all 0.3s ease;
        }

        .slide-nav-title {
          font-size: 0.9rem;
          color: rgba(255, 255, 255, 0.6);
          letter-spacing: 1px;
          text-transform: uppercase;
          transition: color 0.3s ease;
        }

        .slide-nav-item.active .slide-nav-title {
          color: rgba(255, 255, 255, 1);
        }

        .slide-progress-line {
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 1px;
          background: rgba(255, 255, 255, 0.2);
        }

        .slide-progress-fill {
          height: 100%;
          background: rgba(255, 255, 255, 0.8);
          width: 0%;
          transition: width 0.1s ease, opacity 0.3s ease;
          opacity: 0;
        }

        .slider-wrapper.loaded {
          opacity: 1;
        }

        @media (max-width: 768px) {
          .slide-title {
            font-size: 1.8rem;
          }

          .slide-description {
            font-size: 0.9rem;
          }

          .slide-number, .slide-total {
            font-size: 1.2rem;
            top: 1.5rem;
          }

          .slide-number {
            left: 1.5rem;
            transform: none;
          }

          .slide-total {
            right: 1.5rem;
            transform: none;
          }

          .slides-navigation {
            bottom: 1rem;
            gap: 0.5rem;
            width: 95%;
            max-width: 100%;
            flex-wrap: wrap;
            justify-content: center;
          }

          .slide-nav-item {
            flex: 0 1 calc(50% - 0.25rem);
            min-width: 0;
          }

          .slide-nav-title {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          .slide-content {
            width: 90%;
          }
        }
      `}),a.jsxs("main",{className:"slider-wrapper",ref:u,children:[a.jsx("canvas",{className:"webgl-canvas"}),a.jsx("span",{className:"slide-number",id:"slideNumber",children:"01"}),a.jsx("span",{className:"slide-total",id:"slideTotal",children:"06"}),a.jsx("div",{className:"slide-content",children:a.jsx("p",{className:"slide-description",id:"mainDesc"})}),a.jsx("nav",{className:"slides-navigation",id:"slidesNav"})]})]})}const WP=u=>typeof u=="boolean"?`${u}`:u===0?"0":u,HP=u2,xL=(u,f)=>x=>{var _;if((f==null?void 0:f.variants)==null)return HP(u,x==null?void 0:x.class,x==null?void 0:x.className);const{variants:E,defaultVariants:y}=f,R=Object.keys(E).map(G=>{const F=x==null?void 0:x[G],k=y==null?void 0:y[G];if(F===null)return null;const X=WP(F)||WP(k);return E[G][X]}),P=x&&Object.entries(x).reduce((G,F)=>{let[k,X]=F;return X===void 0||(G[k]=X),G},{}),U=f==null||(_=f.compoundVariants)===null||_===void 0?void 0:_.reduce((G,F)=>{let{class:k,className:X,...q}=F;return Object.entries(q).every(D=>{let[H,B]=D;return Array.isArray(B)?B.includes({...y,...P}[H]):{...y,...P}[H]===B})?[...G,k,X]:G},[]);return HP(u,R,U,x==null?void 0:x.class,x==null?void 0:x.className)},X$=xL("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function zP({className:u,variant:f,...x}){return a.jsx("div",{className:Er(X$({variant:f}),u),...x})}function KP(u,f){if(typeof u=="function")return u(f);u!=null&&(u.current=f)}function J$(...u){return f=>{let x=!1;const _=u.map(E=>{const y=KP(E,f);return!x&&typeof y=="function"&&(x=!0),y});if(x)return()=>{for(let E=0;E<_.length;E++){const y=_[E];typeof y=="function"?y():KP(u[E],null)}}}}var $$=Symbol.for("react.lazy"),cg=GY[" use ".trim().toString()];function Q$(u){return typeof u=="object"&&u!==null&&"then"in u}function bL(u){return u!=null&&typeof u=="object"&&"$$typeof"in u&&u.$$typeof===$$&&"_payload"in u&&Q$(u._payload)}function Z$(u){const f=tQ(u),x=j.forwardRef((_,E)=>{let{children:y,...R}=_;bL(y)&&typeof cg=="function"&&(y=cg(y._payload));const P=j.Children.toArray(y),U=P.find(nQ);if(U){const G=U.props.children,F=P.map(k=>k===U?j.Children.count(G)>1?j.Children.only(null):j.isValidElement(G)?G.props.children:null:k);return a.jsx(f,{...R,ref:E,children:j.isValidElement(G)?j.cloneElement(G,void 0,F):null})}return a.jsx(f,{...R,ref:E,children:y})});return x.displayName=`${u}.Slot`,x}var eQ=Z$("Slot");function tQ(u){const f=j.forwardRef((x,_)=>{let{children:E,...y}=x;if(bL(E)&&typeof cg=="function"&&(E=cg(E._payload)),j.isValidElement(E)){const R=rQ(E),P=aQ(y,E.props);return E.type!==j.Fragment&&(P.ref=_?J$(_,R):R),j.cloneElement(E,P)}return j.Children.count(E)>1?j.Children.only(null):null});return f.displayName=`${u}.SlotClone`,f}var sQ=Symbol("radix.slottable");function nQ(u){return j.isValidElement(u)&&typeof u.type=="function"&&"__radixId"in u.type&&u.type.__radixId===sQ}function aQ(u,f){const x={...f};for(const _ in f){const E=u[_],y=f[_];/^on[A-Z]/.test(_)?E&&y?x[_]=(...P)=>{const U=y(...P);return E(...P),U}:E&&(x[_]=E):_==="style"?x[_]={...E,...y}:_==="className"&&(x[_]=[E,y].filter(Boolean).join(" "))}return{...u,...x}}function rQ(u){var _,E;let f=(_=Object.getOwnPropertyDescriptor(u.props,"ref"))==null?void 0:_.get,x=f&&"isReactWarning"in f&&f.isReactWarning;return x?u.ref:(f=(E=Object.getOwnPropertyDescriptor(u,"ref"))==null?void 0:E.get,x=f&&"isReactWarning"in f&&f.isReactWarning,x?u.props.ref:u.props.ref||u.ref)}const iQ=xL("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),EE=j.forwardRef(({className:u,variant:f,size:x,asChild:_=!1,...E},y)=>{const R=_?eQ:"button";return a.jsx(R,{className:Er(iQ({variant:f,size:x,className:u})),ref:y,...E})});EE.displayName="Button";const yE=j.forwardRef(({className:u,...f},x)=>a.jsx("div",{ref:x,className:Er("rounded-lg border bg-card text-card-foreground shadow-sm",u),...f}));yE.displayName="Card";const wE=j.forwardRef(({className:u,...f},x)=>a.jsx("div",{ref:x,className:Er("flex flex-col space-y-1.5 p-6",u),...f}));wE.displayName="CardHeader";const SE=j.forwardRef(({className:u,...f},x)=>a.jsx("h3",{ref:x,className:Er("text-2xl font-semibold leading-none tracking-tight",u),...f}));SE.displayName="CardTitle";const oQ=j.forwardRef(({className:u,...f},x)=>a.jsx("p",{ref:x,className:Er("text-sm text-muted-foreground",u),...f}));oQ.displayName="CardDescription";const NE=j.forwardRef(({className:u,...f},x)=>a.jsx("div",{ref:x,className:Er("p-6 pt-0",u),...f}));NE.displayName="CardContent";const cQ=j.forwardRef(({className:u,...f},x)=>a.jsx("div",{ref:x,className:Er("flex items-center p-6 pt-0",u),...f}));cQ.displayName="CardFooter";function lQ({timelineData:u}){const[f,x]=j.useState({}),[_,E]=j.useState("orbital"),[y,R]=j.useState(0),[P,U]=j.useState(!0),[G,F]=j.useState({}),[k,X]=j.useState({x:0,y:0}),[q,D]=j.useState(null),H=j.useRef(null),B=j.useRef(null),ne=j.useRef({}),ae=Q=>{(Q.target===H.current||Q.target===B.current)&&(x({}),D(null),F({}),U(!0))},Z=Q=>{x(pe=>{const he={...pe};if(Object.keys(he).forEach(Ae=>{parseInt(Ae)!==Q&&(he[parseInt(Ae)]=!1)}),he[Q]=!pe[Q],pe[Q])D(null),U(!0),F({});else{D(Q),U(!1);const Ae=ue(Q),fe={};Ae.forEach(le=>{fe[le]=!0}),F(fe),te(Q)}return he})};j.useEffect(()=>{let Q;return P&&_==="orbital"&&(Q=setInterval(()=>{R(pe=>(pe+.5)%360)},30)),()=>{Q&&clearInterval(Q)}},[P,_]);const te=Q=>{if(_!=="orbital"||!ne.current[Q])return;const pe=u.findIndex(fe=>fe.id===Q),he=u.length,Ae=pe/he*360;R(270-Ae)},ie=(Q,pe)=>{const he=(Q/pe*360+y)%360,fe=typeof window<"u"&&window.innerWidth<1024?160:200,le=he*Math.PI/180,we=fe*Math.cos(le)+k.x,re=fe*Math.sin(le)+k.y,oe=Math.round(100+50*Math.cos(le)),J=Math.max(.4,Math.min(1,.4+.6*((1+Math.sin(le))/2)));return{x:we,y:re,angle:he,zIndex:oe,opacity:J}},ue=Q=>{const pe=u.find(he=>he.id===Q);return pe?pe.relatedIds:[]},Ne=Q=>q?ue(q).includes(Q):!1,be=Q=>{switch(Q){case"completed":return"text-white bg-black border-white";case"in-progress":return"text-black bg-white border-black";case"pending":return"text-white bg-black/40 border-white/50";default:return"text-white bg-black/40 border-white/50"}};return a.jsx("div",{className:"w-full py-20 md:py-32 bg-gradient-to-b from-transparent via-transparent to-transparent overflow-hidden",ref:H,onClick:ae,children:a.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[a.jsxs("div",{className:"hidden md:block text-center max-w-3xl mx-auto mb-16",children:[a.jsxs("div",{className:"inline-flex items-center gap-2 mb-4",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-400"}),a.jsx("span",{className:"text-sm uppercase tracking-wider text-cyan-300 font-medium",children:"Platform Features"})]}),a.jsx("h2",{className:"text-3xl md:text-5xl font-bold text-white mb-6",children:"Five Core Features That Power HealthAI"}),a.jsx("p",{className:"text-lg text-cyan-100",children:"Discover the essential capabilities that make intelligent health management possible"})]}),a.jsxs("div",{className:"hidden lg:flex items-center justify-center gap-16 h-[600px]",children:[a.jsx("div",{className:"flex-1 flex flex-col justify-center",children:a.jsx("p",{className:"text-6xl md:text-7xl font-serif font-bold text-white leading-tight",children:"Transform Your Health With Advanced AI Intelligence and Insights"})}),a.jsx("div",{className:"flex-1 h-full relative rounded-3xl overflow-visible bg-gradient-to-br from-[#0a3d5c] via-[#0d5a8a] to-[#051f2e] border border-cyan-400/20 shadow-2xl shadow-cyan-600/20",children:a.jsxs("div",{className:"absolute w-full h-full flex items-center justify-center z-10",ref:B,style:{perspective:"1000px",transform:`translate(${k.x}px, ${k.y}px)`},children:[a.jsxs("div",{className:"absolute w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 via-blue-500 to-teal-500 animate-pulse flex items-center justify-center z-50",children:[a.jsx("div",{className:"absolute w-20 h-20 rounded-full border-2 border-white/30 animate-ping opacity-70"}),a.jsx("div",{className:"absolute w-24 h-24 rounded-full border-2 border-white/20 animate-ping opacity-50",style:{animationDelay:"0.5s"}}),a.jsx("div",{className:"w-8 h-8 rounded-full bg-white/90 backdrop-blur-md shadow-lg shadow-white/50"})]}),a.jsx("div",{className:"absolute w-96 h-96 rounded-full border border-white/10"}),u.map((Q,pe)=>{const he=ie(pe,u.length),Ae=f[Q.id],fe=Ne(Q.id),le=G[Q.id],we=Q.icon,re={transform:`translate(${he.x}px, ${he.y}px)`,zIndex:Ae?200:he.zIndex,opacity:Ae?1:he.opacity};return a.jsxs("div",{ref:oe=>ne.current[Q.id]=oe,className:"absolute transition-all duration-700 cursor-pointer",style:re,onClick:oe=>{oe.stopPropagation(),Z(Q.id)},children:[a.jsx("div",{className:`absolute rounded-full -inset-1 ${le?"animate-pulse duration-1000":""}`,style:{background:"radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%)",width:`${Q.energy*.5+40}px`,height:`${Q.energy*.5+40}px`,left:`-${(Q.energy*.5+40-40)/2}px`,top:`-${(Q.energy*.5+40-40)/2}px`}}),a.jsx("div",{className:`
                  w-10 h-10 rounded-full flex items-center justify-center
                  bg-transparent text-white
                  border-2 
                  ${Ae?"border-white shadow-lg shadow-white/30":fe?"border-white animate-pulse":"border-white"}
                  transition-all duration-300 transform
                  ${Ae?"scale-150":""}
                `,children:a.jsx(we,{size:16})}),a.jsx("div",{className:`
                  absolute top-12  whitespace-nowrap
                  text-xs font-semibold tracking-wider
                  transition-all duration-300
                  ${Ae?"text-white scale-125":"text-white"}
                `,children:Q.title}),Ae&&a.jsxs(yE,{className:"absolute top-14 left-1/2 -translate-x-1/2 w-48 bg-gradient-to-br from-[#0a3d5c] to-[#0d5a8a] backdrop-blur-lg border-cyan-500/50 shadow-xl shadow-cyan-500/20 overflow-visible z-50",children:[a.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-px h-1.5 bg-cyan-400/70"}),a.jsxs(wE,{className:"pb-1.5 pt-3 px-3",children:[a.jsxs("div",{className:"flex justify-between items-center mb-0.5",children:[a.jsx(zP,{className:`px-1.5 text-xs font-semibold ${be(Q.status)}`,children:Q.status==="completed"?" COMPLETE":Q.status==="in-progress"?" IN PROGRESS":" PENDING"}),a.jsx("span",{className:"text-xs font-mono text-cyan-300/70",children:Q.date})]}),a.jsx(SE,{className:"text-xs text-white mt-0.5",children:Q.title})]}),a.jsxs(NE,{className:"text-xs text-cyan-100/90 space-y-1.5 px-3 pb-2",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"text-cyan-300 font-semibold mb-0.5 text-xs",children:" Overview"}),a.jsx("p",{className:"text-cyan-100/80 text-xs leading-tight",children:Q.content})]}),a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsx("h4",{className:"text-cyan-300 font-semibold mb-1 text-xs",children:" Key Features"}),a.jsxs("div",{className:"space-y-0.5",children:[Q.id===1&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Comprehensive health data collection"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"User needs and pain points analysis"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Feature prioritization framework"})]})]}),Q.id===2&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Scalable microservices architecture"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"AI/ML pipeline integration"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Secure data storage design"})]})]}),Q.id===3&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Claude AI integration for analysis"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Real-time report processing"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Multi-language support"})]})]}),Q.id===4&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Automated test suite coverage"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Performance optimization"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Security vulnerability scanning"})]})]}),Q.id===5&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Production deployment pipeline"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"24/7 monitoring and alerts"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"User onboarding and support"})]})]})]})]}),a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsxs("div",{className:"flex justify-between items-center text-xs mb-0.5",children:[a.jsxs("span",{className:"flex items-center text-cyan-300",children:[a.jsx(zr,{size:9,className:"mr-0.5"}),"Progress"]}),a.jsxs("span",{className:"font-mono text-cyan-400 text-xs",children:[Q.energy,"%"]})]}),a.jsx("div",{className:"w-full h-1 bg-cyan-900/50 rounded-full overflow-hidden border border-cyan-500/30",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-cyan-500 to-cyan-400",style:{width:`${Q.energy}%`}})})]}),Q.relatedIds.length>0&&a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsxs("div",{className:"flex items-center mb-0.5",children:[a.jsx(mP,{size:9,className:"text-cyan-400 mr-0.5"}),a.jsx("h4",{className:"text-xs uppercase tracking-wider font-semibold text-cyan-300",children:"Related Phases"})]}),a.jsx("div",{className:"flex flex-wrap gap-1",children:Q.relatedIds.map(oe=>{const J=u.find(Oe=>Oe.id===oe);return a.jsxs(EE,{variant:"outline",size:"sm",className:"flex items-center h-5 px-1 py-0 text-xs rounded-md border-cyan-500/40 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-300 hover:text-cyan-200 transition-all",onClick:Oe=>{Oe.stopPropagation(),Z(oe)},children:[J==null?void 0:J.title,a.jsx(Ba,{size:7,className:"ml-0.5 text-cyan-400/60"})]},oe)})})]})]})]})]},Q.id)})]})})]}),a.jsx("div",{className:"lg:hidden h-auto py-4 flex flex-col items-center justify-center",children:a.jsxs("div",{className:"relative w-full h-[480px] flex items-center justify-center rounded-2xl overflow-visible",style:{background:"linear-gradient(135deg, rgba(10, 61, 92, 0.4) 0%, rgba(13, 90, 138, 0.4) 100%)"},children:[a.jsx("div",{className:"absolute inset-0 rounded-2xl border border-cyan-500/30"}),a.jsxs("div",{className:"absolute w-full h-full flex items-center justify-center",ref:B,style:{perspective:"1000px",transform:`translate(${k.x}px, ${k.y}px)`},children:[a.jsxs("div",{className:"absolute w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 via-blue-500 to-teal-500 animate-pulse flex items-center justify-center z-50",children:[a.jsx("div",{className:"absolute w-20 h-20 rounded-full border-2 border-white/30 animate-ping opacity-70"}),a.jsx("div",{className:"absolute w-24 h-24 rounded-full border-2 border-white/20 animate-ping opacity-50",style:{animationDelay:"0.5s"}}),a.jsx("div",{className:"w-8 h-8 rounded-full bg-white/90 backdrop-blur-md shadow-lg shadow-white/50"})]}),a.jsx("div",{className:"absolute w-96 h-96 rounded-full border border-white/10"}),u.map((Q,pe)=>{const he=ie(pe,u.length),Ae=f[Q.id],fe=Ne(Q.id),le=G[Q.id],we=Q.icon,re={transform:`translate(${he.x}px, ${he.y}px)`,zIndex:Ae?200:he.zIndex,opacity:Ae?1:he.opacity};return a.jsxs("div",{ref:oe=>ne.current[Q.id]=oe,className:"absolute transition-all duration-700 cursor-pointer",style:re,onClick:oe=>{oe.stopPropagation(),Z(Q.id)},children:[a.jsx("div",{className:`absolute rounded-full -inset-1 ${le?"animate-pulse duration-1000":""}`,style:{background:"radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%)",width:`${Q.energy*.5+40}px`,height:`${Q.energy*.5+40}px`,left:`-${(Q.energy*.5+40-40)/2}px`,top:`-${(Q.energy*.5+40-40)/2}px`}}),a.jsx("div",{className:`
                      w-10 h-10 rounded-full flex items-center justify-center
                      bg-transparent text-white
                      border-2 
                      ${Ae?"border-white shadow-lg shadow-white/30":fe?"border-white animate-pulse":"border-white"}
                      transition-all duration-300 transform
                      ${Ae?"scale-150":""}
                    `,children:a.jsx(we,{size:16})}),a.jsx("div",{className:`
                      absolute top-12  whitespace-nowrap
                      text-xs font-semibold tracking-wider
                      transition-all duration-300
                      ${Ae?"text-white scale-125":"text-white"}
                    `,children:Q.title}),Ae&&a.jsxs(yE,{className:"absolute top-14 left-1/2 -translate-x-1/2 w-48 bg-gradient-to-br from-[#0a3d5c] to-[#0d5a8a] backdrop-blur-lg border-cyan-500/50 shadow-xl shadow-cyan-500/20 overflow-visible z-50",children:[a.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-px h-1.5 bg-cyan-400/70"}),a.jsxs(wE,{className:"pb-1.5 pt-3 px-3",children:[a.jsxs("div",{className:"flex justify-between items-center mb-0.5",children:[a.jsx(zP,{className:`px-1.5 text-xs font-semibold ${be(Q.status)}`,children:Q.status==="completed"?" COMPLETE":Q.status==="in-progress"?" IN PROGRESS":" PENDING"}),a.jsx("span",{className:"text-xs font-mono text-cyan-300/70",children:Q.date})]}),a.jsx(SE,{className:"text-xs text-white mt-0.5",children:Q.title})]}),a.jsxs(NE,{className:"text-xs text-cyan-100/90 space-y-1.5 px-3 pb-2",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"text-cyan-300 font-semibold mb-0.5 text-xs",children:" Overview"}),a.jsx("p",{className:"text-cyan-100/80 text-xs leading-tight",children:Q.content})]}),a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsx("h4",{className:"text-cyan-300 font-semibold mb-1 text-xs",children:" Key Features"}),a.jsxs("div",{className:"space-y-0.5",children:[Q.id===1&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Comprehensive health data collection"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"User needs and pain points analysis"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Feature prioritization framework"})]})]}),Q.id===2&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Scalable microservices architecture"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"AI/ML pipeline integration"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Secure data storage design"})]})]}),Q.id===3&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Claude AI integration for analysis"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Real-time report processing"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Multi-language support"})]})]}),Q.id===4&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Automated test suite coverage"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Performance optimization"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Security vulnerability scanning"})]})]}),Q.id===5&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"Production deployment pipeline"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"24/7 monitoring and alerts"})]}),a.jsxs("div",{className:"flex gap-1.5 text-xs",children:[a.jsx("span",{className:"text-cyan-400 flex-shrink-0",children:""}),a.jsx("span",{children:"User onboarding and support"})]})]})]})]}),a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsxs("div",{className:"flex justify-between items-center text-xs mb-0.5",children:[a.jsxs("span",{className:"flex items-center text-cyan-300",children:[a.jsx(zr,{size:9,className:"mr-0.5"}),"Progress"]}),a.jsxs("span",{className:"font-mono text-cyan-400 text-xs",children:[Q.energy,"%"]})]}),a.jsx("div",{className:"w-full h-1 bg-cyan-900/50 rounded-full overflow-hidden border border-cyan-500/30",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-cyan-500 to-cyan-400",style:{width:`${Q.energy}%`}})})]}),Q.relatedIds.length>0&&a.jsxs("div",{className:"pt-1.5 border-t border-cyan-500/30",children:[a.jsxs("div",{className:"flex items-center mb-0.5",children:[a.jsx(mP,{size:9,className:"text-cyan-400 mr-0.5"}),a.jsx("h4",{className:"text-xs uppercase tracking-wider font-semibold text-cyan-300",children:"Related Phases"})]}),a.jsx("div",{className:"flex flex-wrap gap-1",children:Q.relatedIds.map(oe=>{const J=u.find(Oe=>Oe.id===oe);return a.jsxs(EE,{variant:"outline",size:"sm",className:"flex items-center h-5 px-1 py-0 text-xs rounded-md border-cyan-500/40 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-300 hover:text-cyan-200 transition-all",onClick:Oe=>{Oe.stopPropagation(),Z(oe)},children:[J==null?void 0:J.title,a.jsx(Ba,{size:7,className:"ml-0.5 text-cyan-400/60"})]},oe)})})]})]})]})]},Q.id)})]})]})})]})})}const dQ=[{id:1,title:"AI Analysis",date:"Real-time",content:"Advanced AI-powered analysis of your medical reports to identify health patterns and risks.",category:"Feature",icon:PE,relatedIds:[2,3],status:"completed",energy:100},{id:2,title:"Health Tracking",date:"24/7",content:"Continuous monitoring of your health metrics with smart alerts and personalized recommendations.",category:"Feature",icon:zn,relatedIds:[1,4],status:"completed",energy:95},{id:3,title:"Doctor Network",date:"Verified",content:"Connect with verified healthcare professionals recommended based on your specific health needs.",category:"Feature",icon:Wd,relatedIds:[1,5],status:"completed",energy:90},{id:4,title:"Nutrition Plans",date:"Personalized",content:"Get customized nutrition plans and supplement recommendations based on your health profile.",category:"Feature",icon:Ji,relatedIds:[2,5],status:"completed",energy:85},{id:5,title:"Report Upload",date:"Instant",content:"Upload your medical reports and get instant AI-powered analysis with actionable insights.",category:"Feature",icon:Kr,relatedIds:[3,4],status:"completed",energy:100}];function uQ(){const[u,f]=j.useState(0),x=[{question:"What types of health reports can I upload?",answer:"FitCure supports all common medical report formats including blood tests, lab results, imaging reports, and general health checkups. You can upload PDFs, images, or even photos of paper reports. Our AI can extract and analyze data from virtually any medical document."},{question:"How accurate is the AI analysis?",answer:"Our AI has been trained on millions of medical records and achieves 98% accuracy in data extraction and analysis. However, our insights are meant to supplement, not replace, professional medical advice. We always recommend consulting with healthcare professionals for serious health concerns."},{question:"Is my health data secure and private?",answer:"Absolutely. We use bank-level encryption to protect your data and are fully HIPAA compliant. Your health information is never shared with third parties without your explicit consent. You have complete control over your data and can delete it at any time."},{question:"Can I connect with real doctors through the platform?",answer:"Yes! Based on your AI analysis, we recommend verified healthcare professionals who specialize in your specific health needs. Our network includes thousands of doctors, specialists, and healthcare providers who understand our AI insights."},{question:"What if I don't have any medical reports?",answer:"No problem! You can start by taking our comprehensive health assessment, or we can help you understand what tests to request from your doctor. We also provide guidance on essential health screenings based on your age, gender, and health goals."},{question:"Can I cancel my subscription anytime?",answer:"Yes, you can cancel your subscription at any time with no penalties or fees. If you cancel mid-cycle, you'll continue to have access to all features until the end of your billing period. We also offer a 30-day money-back guarantee for new subscribers."}];return a.jsx("section",{id:"faq",className:"py-20 md:py-32 bg-transparent",children:a.jsxs("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 lg:px-8",children:[a.jsxs("div",{className:"text-center mb-16",children:[a.jsxs("div",{className:"inline-flex items-center gap-2 mb-4",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-400"}),a.jsx("span",{className:"text-sm uppercase tracking-wider text-cyan-300 font-medium",children:"FAQ"})]}),a.jsx("h2",{className:"text-3xl md:text-5xl font-serif text-white mb-6",children:"Got questions?"}),a.jsx("p",{className:"text-lg text-cyan-100",children:"We've got answers. If you can't find what you're looking for, chat with our team."})]}),a.jsx("div",{className:"space-y-4",children:x.map((_,E)=>a.jsxs("div",{className:"border border-cyan-500/30 rounded-xl overflow-hidden bg-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors",children:[a.jsxs("button",{onClick:()=>f(u===E?null:E),className:"w-full flex items-center justify-between p-6 text-left",children:[a.jsx("span",{className:"text-lg font-medium text-white pr-4",children:_.question}),a.jsx(yo,{className:`w-5 h-5 text-cyan-300 shrink-0 transition-transform duration-200 ${u===E?"rotate-180":""}`})]}),a.jsx("div",{className:`overflow-hidden transition-all duration-200 ${u===E?"max-h-96":"max-h-0"}`,children:a.jsx("p",{className:"px-6 pb-6 text-cyan-100 leading-relaxed",children:_.answer})})]},E))})]})})}function hQ(){return a.jsx("section",{className:"py-20 md:py-32 bg-transparent",children:a.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center",children:[a.jsx("h2",{className:"text-3xl md:text-5xl font-serif text-white mb-6",children:"Ready to transform your health with AI?"}),a.jsx("p",{className:"text-lg text-cyan-100 mb-10 max-w-2xl mx-auto",children:"Join 10,000+ people who've made the switch to proactive, AI-powered healthcare. Your future self will thank you."}),a.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center gap-4",children:[a.jsxs(Rt,{to:"/register?skip=true",className:"bg-white text-[#8B7355] hover:bg-[#F5F1EA] rounded-full px-8 py-4 text-base font-medium transition-all inline-flex items-center gap-2 shadow-lg",children:["Start your free analysis",a.jsx(Ba,{className:"w-5 h-5"})]}),a.jsx(Rt,{to:"/login",className:"rounded-full px-8 py-4 text-base font-medium border-2 border-white/40 text-white hover:bg-white/10 bg-transparent transition-all backdrop-blur-sm",children:"Talk to our team"})]}),a.jsx("p",{className:"text-sm text-white/80 mt-6",children:"Free forever plan  No credit card required  Cancel anytime"})]})})}function pQ(){return a.jsx("footer",{className:"bg-gradient-to-b from-[#0a3d5c] to-[#051f2e] text-white py-16",children:a.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-8 mb-12",children:[a.jsxs("div",{className:"col-span-2 lg:col-span-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx("div",{className:"w-8 h-8 bg-[#8B7355] rounded-xl flex items-center justify-center",children:a.jsx(ms,{className:"w-5 h-5 text-white"})}),a.jsx("span",{className:"font-serif text-xl",children:"FitCure"})]}),a.jsx("p",{className:"text-white/60 text-sm mb-4",children:"AI-powered health insights for better living."})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold mb-4",children:"Product"}),a.jsxs("ul",{className:"space-y-3 text-sm",children:[a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Features"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Pricing"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Mobile App"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"API"})})]})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold mb-4",children:"Company"}),a.jsxs("ul",{className:"space-y-3 text-sm",children:[a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"About"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Blog"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Careers"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Press"})})]})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold mb-4",children:"Resources"}),a.jsxs("ul",{className:"space-y-3 text-sm",children:[a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Help Center"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Health Guides"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Find a Doctor"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Partner with Us"})})]})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold mb-4",children:"Legal"}),a.jsxs("ul",{className:"space-y-3 text-sm",children:[a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Privacy Policy"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"Terms of Service"})}),a.jsx("li",{children:a.jsx("a",{href:"#",className:"text-white/60 hover:text-white transition-colors",children:"HIPAA Compliance"})})]})]})]}),a.jsx("div",{className:"pt-8 border-t border-white/10 flex flex-col md:flex-row items-center justify-between gap-4",children:a.jsx("p",{className:"text-sm text-white/60",children:" 2026 FitCure. All rights reserved."})})]})})}function mQ(){return a.jsxs("div",{className:"min-h-screen bg-transparent",children:[a.jsx($J,{}),a.jsx(QJ,{}),a.jsx(ZJ,{}),a.jsx(e$,{}),a.jsx(q$,{}),a.jsx(lQ,{timelineData:dQ}),a.jsx(t$,{}),a.jsx(Y$,{}),a.jsx(uQ,{}),a.jsx(hQ,{}),a.jsx(pQ,{})]})}function fQ(){const[u,f]=j.useState(""),[x,_]=j.useState(""),[E,y]=j.useState(!1),[R,P]=j.useState(!1),{login:U}=ia(),G=Ga(),F=async k=>{var X,q,D;k.preventDefault(),P(!0);try{const H=await U(u,x);Ve.success("Welcome back!"),G(H.role==="admin"?"/admin":H.role==="doctor"?"/doctor/dashboard":"/dashboard")}catch(H){const B=((q=(X=H.response)==null?void 0:X.data)==null?void 0:q.message)||H.message||"Login failed";H.response?Ve.error(B):(Ve.error("Network error - Check if server is running and accessible"),console.error("Connection details:",{apiUrl:(D=H.config)==null?void 0:D.baseURL,host:window.location.hostname,port:window.location.port}))}finally{P(!1)}};return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center w-full p-12 text-white",children:[a.jsx("div",{className:"w-20 h-20 bg-white/20 backdrop-blur-xl rounded-3xl flex items-center justify-center mb-8",children:a.jsx(ms,{className:"w-10 h-10"})}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Welcome to HealthAI"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md",children:"Your AI-powered health companion for smarter healthcare decisions."})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:a.jsxs("div",{className:"w-full max-w-md",children:[a.jsxs("div",{className:"lg:hidden flex items-center justify-center gap-3 mb-8",children:[a.jsx("div",{className:"w-12 h-12 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center",children:a.jsx(ms,{className:"w-7 h-7 text-white"})}),a.jsx("span",{className:"text-2xl font-bold text-gray-900",children:"HealthAI"})]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-gray-900",children:"Sign In"}),a.jsx("p",{className:"text-gray-600",children:"Access your health dashboard"})]}),a.jsxs("form",{onSubmit:F,className:"space-y-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-700",children:"Email Address"}),a.jsxs("div",{className:"relative",children:[a.jsx(qd,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),a.jsx("input",{type:"email",value:u,onChange:k=>f(k.target.value),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-gray-200 text-gray-900",placeholder:"you@example.com",required:!0})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-700",children:"Password"}),a.jsxs("div",{className:"relative",children:[a.jsx(kh,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),a.jsx("input",{type:E?"text":"password",value:x,onChange:k=>_(k.target.value),className:"w-full bg-white rounded-xl py-3 pl-12 pr-12 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-gray-200 text-gray-900",placeholder:"",required:!0}),a.jsx("button",{type:"button",onClick:()=>y(!E),className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:E?a.jsx(h2,{className:"w-5 h-5"}):a.jsx(hl,{className:"w-5 h-5"})})]})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",className:"w-4 h-4 rounded border-gray-300 text-cyan-500 focus:ring-cyan-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"Remember me"})]}),a.jsx("a",{href:"#",className:"text-sm font-medium text-cyan-600 hover:text-cyan-700",children:"Forgot password?"})]}),a.jsx("button",{type:"submit",disabled:R,className:"w-full py-3 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700",children:R?a.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}):a.jsxs(a.Fragment,{children:["Sign In ",a.jsx(Ba,{className:"w-5 h-5"})]})})]}),a.jsxs("p",{className:"text-center mt-8 text-gray-600",children:["Don't have an account?"," ",a.jsx(Rt,{to:"/register",className:"font-semibold text-cyan-600 hover:text-cyan-700",children:"Create one"})]})]})})]})}function gQ({step:u}){const f=(u-1)/6*100,x=()=>{switch(u){case 2:return a.jsx(zn,{className:"w-12 h-12"});case 3:return a.jsx(ms,{className:"w-12 h-12"});case 4:return a.jsx(p2,{className:"w-12 h-12"});case 5:return a.jsx(mg,{className:"w-12 h-12"});case 6:return a.jsx(ag,{className:"w-12 h-12"});case 7:return a.jsx(vr,{className:"w-12 h-12"});default:return a.jsx(zn,{className:"w-12 h-12"})}},_=()=>{switch(u){case 2:return"Building Your Profile";case 3:return"Analyzing Your Health";case 4:return"Understanding Diabetes";case 5:return"Diet Preferences";case 6:return"Fitness & Goals";case 7:return"Almost Complete!";default:return"Getting Started"}};return a.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-4",children:[a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full opacity-20 animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full opacity-30 animate-pulse",style:{animationDelay:"0.2s"}}),a.jsx("div",{className:"absolute inset-8 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-white shadow-lg",children:x()}),a.jsxs("svg",{className:"absolute inset-0 w-full h-full -rotate-90",children:[a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"currentColor",strokeOpacity:"0.1",strokeWidth:"4",fill:"none",className:"text-cyan-500"}),a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"currentColor",strokeWidth:"4",fill:"none",strokeDasharray:"377",strokeDashoffset:377-377*(f/100),className:"text-cyan-500 transition-all duration-500",strokeLinecap:"round"})]})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-lg font-semibold text-cyan-600 mb-1",children:_()}),a.jsxs("p",{className:"text-sm text-gray-600",children:[Math.round(f),"% Complete"]})]}),a.jsx("div",{className:"flex items-center gap-2 mt-4",children:[2,3,4,5,6,7].map(E=>a.jsx("div",{className:`w-2 h-2 rounded-full transition-all duration-300 ${E<u?"bg-cyan-500 w-8":E===u?"bg-cyan-500 w-3 h-3":"bg-gray-300"}`},E))})]})}function xQ(){const u=hg();new URLSearchParams(u.search);const[f,x]=j.useState(2),[_,E]=j.useState("patient"),[y,R]=j.useState({name:"",email:"",password:"",confirmPassword:"",age:"",gender:"",height:"",weight:"",bloodGroup:"",dietaryPreference:"non-vegetarian",activityLevel:"sedentary",smoker:!1,alcohol:!1,sleepHours:"7",stressLevel:"moderate",waterIntake:"8",chronicConditions:[],isDiabetic:"no",diabetesType:"",diagnosisYear:"",diabetesStatus:"",hba1c:"",glucoseMonitoring:"",fastingGlucose:"",postMealGlucose:"",testingFrequency:"",onMedication:!1,medicationType:[],insulinTiming:"",recentDosageChange:!1,primaryGoal:"general_health",targetWeight:"",weeklyGoal:"0.5"}),[P,U]=j.useState(!1),[G,F]=j.useState(!1),[k,X]=j.useState(""),[q,D]=j.useState(""),[H,B]=j.useState(""),[ne,ae]=j.useState(""),{register:Z}=ia(),te=Ga(),ie=async Q=>{var pe,he;if(Q.preventDefault(),y.password!==y.confirmPassword){Ve.error("Passwords do not match");return}if(!y.age||!y.gender){Ve.error("Please provide your age and gender");return}F(!0);try{const Ae={age:parseInt(y.age),gender:y.gender,height:y.height?parseFloat(y.height):void 0,weight:y.weight?parseFloat(y.weight):void 0,bloodGroup:y.bloodGroup||void 0,dietaryPreference:y.dietaryPreference,activityLevel:y.activityLevel,medicalHistory:{conditions:y.chronicConditions.includes("Diabetes")?y.chronicConditions:y.isDiabetic==="yes"?["Diabetes",...y.chronicConditions]:y.chronicConditions},lifestyle:{smoker:y.smoker,alcohol:y.alcohol,sleepHours:parseInt(y.sleepHours),stressLevel:y.stressLevel,waterIntake:parseInt(y.waterIntake)},diabetesProfile:y.isDiabetic==="yes"?{type:y.diabetesType,diagnosisYear:y.diagnosisYear,status:y.diabetesStatus,hba1c:y.hba1c,glucoseMonitoring:y.glucoseMonitoring,fastingGlucose:y.fastingGlucose,postMealGlucose:y.postMealGlucose,testingFrequency:y.testingFrequency,onMedication:y.onMedication,medicationType:y.medicationType,insulinTiming:y.insulinTiming,recentDosageChange:y.recentDosageChange}:void 0},fe={goal:y.primaryGoal,targetWeight:y.targetWeight?parseFloat(y.targetWeight):null,weeklyGoal:parseFloat(y.weeklyGoal)};await Z(y.name,y.email,y.password,Ae,fe),Ve.success("Account created successfully!"),te("/dashboard")}catch(Ae){Ve.error(((he=(pe=Ae.response)==null?void 0:pe.data)==null?void 0:he.message)||"Registration failed")}finally{F(!1)}},ue=()=>{if(f===2&&(!y.name||!y.email||!y.password||!y.age||!y.gender)){Ve.error("Please fill in all basic fields");return}if(f===3&&(!y.height||!y.weight)){Ve.error("Please provide height and weight");return}if(f===5&&y.isDiabetic==="no"){x(6);return}x(f+1)},Ne=()=>{f===2?te("/"):x(f-1)},be=(Q,pe)=>{R(he=>({...he,[Q]:he[Q].includes(pe)?he[Q].filter(Ae=>Ae!==pe):[...he[Q],pe]}))};if(f===2)return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsx("div",{className:"lg:hidden w-full",children:a.jsx(gQ,{step:2})}),a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(zn,{className:"w-12 h-12 animate-pulse"})}),a.jsxs("svg",{className:"absolute inset-0 w-full h-full -rotate-90",children:[a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeOpacity:"0.2",strokeWidth:"4",fill:"none"}),a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeWidth:"4",fill:"none",strokeDasharray:"377",strokeDashoffset:377-377*.16,className:"transition-all duration-500",strokeLinecap:"round"})]})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Your Health Journey Starts Here"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"Get personalized health insights, diet plans, and supplement recommendations based on your unique profile."}),a.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${f>=2?"bg-white text-cyan-600":"bg-white/20"}`,children:a.jsx("span",{className:"text-sm font-bold",children:"1"})}),a.jsx("span",{className:"text-xs",children:"Basic"})]}),a.jsx("div",{className:"w-8 h-0.5 bg-white/20"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${f>=3?"bg-white text-cyan-600":"bg-white/20"}`,children:a.jsx("span",{className:"text-sm font-bold",children:"2"})}),a.jsx("span",{className:"text-xs",children:"Health"})]}),a.jsx("div",{className:"w-8 h-0.5 bg-white/20"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${f>=4?"bg-white text-cyan-600":"bg-white/20"}`,children:a.jsx("span",{className:"text-sm font-bold",children:"3"})}),a.jsx("span",{className:"text-xs",children:"Lifestyle"})]}),a.jsx("div",{className:"w-8 h-0.5 bg-white/20"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${f>=5?"bg-white text-cyan-600":"bg-white/20"}`,children:a.jsx("span",{className:"text-sm font-bold",children:"4"})}),a.jsx("span",{className:"text-xs",children:"Diabetes"})]}),a.jsx("div",{className:"w-8 h-0.5 bg-white/20"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${f>=6?"bg-white text-cyan-600":"bg-white/20"}`,children:a.jsx("span",{className:"text-sm font-bold",children:"5"})}),a.jsx("span",{className:"text-xs",children:"Goals"})]})]}),a.jsxs("p",{className:"text-sm text-white/70 mt-6",children:["Step ",f-1," of 5 - ",f===2?"Basic Info":f===3?"Health Profile":f===4?"Lifestyle":f===5?"Diabetes":"Goals"]})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:a.jsxs("div",{className:"w-full max-w-md",children:[a.jsxs("button",{onClick:()=>te("/"),className:"flex items-center gap-2 mb-6 text-cyan-600 hover:text-cyan-700",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Basic Information"}),a.jsx("p",{className:"text-slate-600",children:"Step 1 of 5 - Let's start with the basics"})]}),a.jsxs("form",{onSubmit:Q=>{Q.preventDefault(),ue()},className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Full Name *"}),a.jsxs("div",{className:"relative",children:[a.jsx($i,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),a.jsx("input",{type:"text",value:y.name,onChange:Q=>R({...y,name:Q.target.value}),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900 placeholder:text-slate-400",placeholder:"John Doe",required:!0})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Age *"}),a.jsx("input",{type:"number",value:y.age,onChange:Q=>R({...y,age:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900 placeholder:text-slate-400",placeholder:"25",min:"1",max:"120",required:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Gender *"}),a.jsxs("select",{value:y.gender,onChange:Q=>R({...y,gender:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900",required:!0,children:[a.jsx("option",{value:"",className:"text-slate-900",children:"Select"}),a.jsx("option",{value:"male",className:"text-slate-900",children:"Male"}),a.jsx("option",{value:"female",className:"text-slate-900",children:"Female"}),a.jsx("option",{value:"other",className:"text-slate-900",children:"Other"})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Email Address *"}),a.jsxs("div",{className:"relative",children:[a.jsx(qd,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),a.jsx("input",{type:"email",value:y.email,onChange:Q=>R({...y,email:Q.target.value}),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900 placeholder:text-slate-400",placeholder:"you@example.com",required:!0})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Password *"}),a.jsxs("div",{className:"relative",children:[a.jsx(kh,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),a.jsx("input",{type:P?"text":"password",value:y.password,onChange:Q=>R({...y,password:Q.target.value}),className:"w-full bg-white rounded-xl py-3 pl-12 pr-12 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900 placeholder:text-slate-400",placeholder:"",required:!0}),a.jsx("button",{type:"button",onClick:()=>U(!P),className:"absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600",children:P?a.jsx(h2,{className:"w-5 h-5"}):a.jsx(hl,{className:"w-5 h-5"})})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Confirm Password *"}),a.jsxs("div",{className:"relative",children:[a.jsx(kh,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),a.jsx("input",{type:"password",value:y.confirmPassword,onChange:Q=>R({...y,confirmPassword:Q.target.value}),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-slate-200 text-slate-900 placeholder:text-slate-400",placeholder:"",required:!0})]})]}),a.jsxs("button",{type:"submit",className:"w-full py-3 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700",children:["Continue ",a.jsx(Ba,{className:"w-5 h-5"})]})]}),a.jsxs("p",{className:"text-center mt-6 text-slate-600",children:["Already have an account?"," ",a.jsx(Rt,{to:"/login",className:"font-semibold text-cyan-600 hover:text-cyan-700",children:"Sign in"})]})]})})]});if(f===3)return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(fP,{className:"w-12 h-12 animate-bounce",style:{animationDuration:"2s"}})}),a.jsxs("svg",{className:"absolute inset-0 w-full h-full -rotate-90",children:[a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeOpacity:"0.2",strokeWidth:"4",fill:"none"}),a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeWidth:"4",fill:"none",strokeDasharray:"377",strokeDashoffset:377-377*.4,className:"transition-all duration-500",strokeLinecap:"round"})]})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Health Profile"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"Help us calculate your personalized nutrition goals based on your body metrics."}),a.jsx("p",{className:"text-sm text-white/70 mt-6",children:"Step 2 of 5"})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:a.jsxs("div",{className:"w-full max-w-md",children:[a.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 mb-6 text-cyan-700 hover:text-cyan-800",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Health Profile"}),a.jsx("p",{className:"text-cyan-700",children:"Step 2 of 5 - Your body metrics"})]}),a.jsxs("form",{onSubmit:Q=>{Q.preventDefault(),ue()},className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Height (cm) *"}),a.jsxs("div",{className:"relative",children:[a.jsx(YY,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-600"}),a.jsx("input",{type:"number",value:y.height,onChange:Q=>R(pe=>({...pe,height:Q.target.value})),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:"170",min:"100",max:"250",step:"0.1",required:!0})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Weight (kg) *"}),a.jsxs("div",{className:"relative",children:[a.jsx(fP,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-600"}),a.jsx("input",{type:"number",value:y.weight,onChange:Q=>R(pe=>({...pe,weight:Q.target.value})),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:"70",min:"30",max:"300",step:"0.1",required:!0})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Blood Group"}),a.jsxs("div",{className:"relative",children:[a.jsx(LE,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-600"}),a.jsxs("select",{value:y.bloodGroup,onChange:Q=>R(pe=>({...pe,bloodGroup:Q.target.value})),className:"w-full bg-white rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900",children:[a.jsx("option",{value:"",className:"text-slate-900",children:"Select (Optional)"}),a.jsx("option",{value:"A+",className:"text-slate-900",children:"A+"}),a.jsx("option",{value:"A-",className:"text-slate-900",children:"A-"}),a.jsx("option",{value:"B+",className:"text-slate-900",children:"B+"}),a.jsx("option",{value:"B-",className:"text-slate-900",children:"B-"}),a.jsx("option",{value:"AB+",className:"text-slate-900",children:"AB+"}),a.jsx("option",{value:"AB-",className:"text-slate-900",children:"AB-"}),a.jsx("option",{value:"O+",className:"text-slate-900",children:"O+"}),a.jsx("option",{value:"O-",className:"text-slate-900",children:"O-"})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Dietary Preference *"}),a.jsxs("select",{value:y.dietaryPreference,onChange:Q=>R(pe=>({...pe,dietaryPreference:Q.target.value})),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900",required:!0,children:[a.jsx("option",{value:"non-vegetarian",className:"text-slate-900",children:"Non-Vegetarian"}),a.jsx("option",{value:"vegetarian",className:"text-slate-900",children:"Vegetarian"}),a.jsx("option",{value:"vegan",className:"text-slate-900",children:"Vegan"}),a.jsx("option",{value:"eggetarian",className:"text-slate-900",children:"Eggetarian"})]}),a.jsx("p",{className:"text-xs mt-1 text-cyan-700",children:"This helps us recommend suitable diet plans"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Activity Level *"}),a.jsxs("select",{value:y.activityLevel,onChange:Q=>R(pe=>({...pe,activityLevel:Q.target.value})),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900",required:!0,children:[a.jsx("option",{value:"sedentary",className:"text-slate-900",children:"Sedentary (Little or no exercise)"}),a.jsx("option",{value:"lightly_active",className:"text-slate-900",children:"Lightly Active (1-3 days/week)"}),a.jsx("option",{value:"moderately_active",className:"text-slate-900",children:"Moderately Active (3-5 days/week)"}),a.jsx("option",{value:"very_active",className:"text-slate-900",children:"Very Active (6-7 days/week)"}),a.jsx("option",{value:"extremely_active",className:"text-slate-900",children:"Extremely Active (Athlete)"})]}),a.jsx("p",{className:"text-xs mt-1 text-cyan-700",children:"Used to calculate your daily calorie needs"})]}),a.jsxs("button",{type:"submit",className:"w-full py-3 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700",children:["Continue ",a.jsx(Ba,{className:"w-5 h-5"})]})]})]})})]});if(f===5)return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(ms,{className:"w-12 h-12"})})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Diabetes Information"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"Skip this if you don't have diabetes. This helps us tailor your glucose management plan."}),a.jsx("p",{className:"text-sm text-white/70 mt-6",children:"Step 4 of 5"})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8 overflow-y-auto",children:a.jsxs("div",{className:"w-full max-w-md py-8",children:[a.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 mb-6 text-cyan-700 hover:text-cyan-800",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Are you diabetic?"}),a.jsx("p",{className:"text-cyan-700",children:"Step 4 of 5 - Detailed health check"})]}),a.jsxs("form",{onSubmit:Q=>{Q.preventDefault(),ue()},className:"space-y-6",children:[a.jsxs("div",{className:"flex gap-4 p-4 bg-white rounded-xl border border-cyan-200",children:[a.jsxs("label",{className:"flex-1 flex items-center justify-center gap-2 p-3 rounded-lg border cursor-pointer transition-all hover:bg-cyan-50 border-cyan-200",children:[a.jsx("input",{type:"radio",checked:y.isDiabetic==="no",onChange:()=>R({...y,isDiabetic:"no",diabetesType:""}),className:"text-cyan-500"}),a.jsx("span",{className:"font-medium text-slate-800",children:"No"})]}),a.jsxs("label",{className:"flex-1 flex items-center justify-center gap-2 p-3 rounded-lg border cursor-pointer transition-all hover:bg-cyan-50 border-cyan-200",children:[a.jsx("input",{type:"radio",checked:y.isDiabetic==="yes",onChange:()=>R({...y,isDiabetic:"yes"}),className:"text-cyan-500"}),a.jsx("span",{className:"font-medium text-slate-800",children:"Yes"})]})]}),y.isDiabetic==="yes"&&a.jsxs("div",{className:"space-y-6 animate-in fade-in slide-in-from-top-4 duration-300",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Diabetes Type"}),a.jsxs("select",{value:y.diabetesType,onChange:Q=>R({...y,diabetesType:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900",children:[a.jsx("option",{value:"",className:"text-slate-900",children:"Select Type"}),a.jsx("option",{value:"Type 1",className:"text-slate-900",children:"Type 1"}),a.jsx("option",{value:"Type 2",className:"text-slate-900",children:"Type 2"}),a.jsx("option",{value:"Prediabetes",className:"text-slate-900",children:"Prediabetes"}),a.jsx("option",{value:"Gestational",className:"text-slate-900",children:"Gestational"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Diagnosis Year"}),a.jsx("input",{type:"number",value:y.diagnosisYear,onChange:Q=>R({...y,diagnosisYear:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:"2020"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"HbA1c (%)"}),a.jsx("input",{type:"number",step:"0.1",value:y.hba1c,onChange:Q=>R({...y,hba1c:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:"6.5"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Are you on medication?"}),a.jsxs("div",{className:"flex gap-4",children:[a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"radio",checked:!y.onMedication,onChange:()=>R({...y,onMedication:!1}),className:"text-cyan-500"}),a.jsx("span",{className:"text-sm text-slate-800",children:"No"})]}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"radio",checked:y.onMedication,onChange:()=>R({...y,onMedication:!0}),className:"text-cyan-500"}),a.jsx("span",{className:"text-sm text-slate-800",children:"Yes"})]})]})]})]}),a.jsxs("button",{type:"submit",className:"w-full py-3 text-white font-semibold rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 flex items-center justify-center gap-2",children:["Continue ",a.jsx(Ba,{className:"w-5 h-5"})]})]})]})})]});if(f===4)return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(ms,{className:"w-12 h-12"})})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Lifestyle & Health"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"Tell us about your daily habits and any existing health conditions."}),a.jsx("p",{className:"text-sm text-white/70 mt-6",children:"Step 3 of 5"})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8 overflow-y-auto",children:a.jsxs("div",{className:"w-full max-w-md py-8",children:[a.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 mb-6 text-cyan-700 hover:text-cyan-800",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Lifestyle & Conditions"}),a.jsx("p",{className:"text-cyan-700",children:"Step 3 of 5 - Habits and health history"})]}),a.jsxs("form",{onSubmit:Q=>{Q.preventDefault(),ue()},className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"flex items-center gap-2 p-3 bg-white rounded-xl border border-slate-200",children:[a.jsx(qY,{className:"w-5 h-5 text-slate-400"}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:y.smoker,onChange:Q=>R({...y,smoker:Q.target.checked}),className:"text-cyan-500"}),a.jsx("span",{className:"text-sm text-slate-800",children:"Smoker"})]})]}),a.jsxs("div",{className:"flex items-center gap-2 p-3 bg-white rounded-xl border border-slate-200",children:[a.jsx(XY,{className:"w-5 h-5 text-slate-400"}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:y.alcohol,onChange:Q=>R({...y,alcohol:Q.target.checked}),className:"text-cyan-500"}),a.jsx("span",{className:"text-sm text-slate-800",children:"Alcohol"})]})]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:["Sleep Hours/Night: ",y.sleepHours,"h"]}),a.jsx("input",{type:"range",min:"4",max:"12",value:y.sleepHours,onChange:Q=>R({...y,sleepHours:Q.target.value}),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-cyan-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Stress Level"}),a.jsxs("select",{value:y.stressLevel,onChange:Q=>R({...y,stressLevel:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-slate-200 text-slate-900",children:[a.jsx("option",{value:"low",className:"text-slate-900",children:"Low"}),a.jsx("option",{value:"moderate",className:"text-slate-900",children:"Moderate"}),a.jsx("option",{value:"high",className:"text-slate-900",children:"High"})]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:["Water Intake (Glasses/Day): ",y.waterIntake]}),a.jsx("input",{type:"range",min:"1",max:"15",value:y.waterIntake,onChange:Q=>R({...y,waterIntake:Q.target.value}),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-cyan-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700",children:"Chronic Conditions (If any)"}),a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:["Hypertension","Thyroid","PCOS/PCOD","Asthma","Arthritis","None"].map(Q=>a.jsx("button",{type:"button",onClick:()=>{Q==="None"?R({...y,chronicConditions:[]}):be("chronicConditions",Q)},className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${y.chronicConditions.includes(Q)?"bg-cyan-600 text-white":"bg-slate-100 text-slate-700"}`,children:Q},Q))})]}),a.jsxs("button",{type:"submit",className:"w-full py-3 text-white font-semibold rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 flex items-center justify-center gap-2",children:["Continue ",a.jsx(Ba,{className:"w-5 h-5"})]})]})]})})]});if(f===7){const pe=(()=>{if(!y.targetWeight||!y.weight)return null;const he=Math.abs(parseFloat(y.targetWeight)-parseFloat(y.weight));return Math.ceil(he/parseFloat(y.weeklyGoal))})();return a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(vr,{className:"w-12 h-12"})}),a.jsxs("svg",{className:"absolute inset-0 w-full h-full -rotate-90",children:[a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeOpacity:"0.2",strokeWidth:"4",fill:"none"}),a.jsx("circle",{cx:"64",cy:"64",r:"60",stroke:"white",strokeWidth:"4",fill:"none",strokeDasharray:"377",strokeDashoffset:377-377*1,className:"transition-all duration-500",strokeLinecap:"round"})]}),a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsx(JY,{className:"w-16 h-16 text-white/80 animate-pulse"})})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Final Step!"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"We'll calculate your personalized nutrition plan based on your goals."}),a.jsxs("div",{className:"mt-6 text-center",children:[a.jsx("p",{className:"text-lg font-bold text-white mb-2",children:" Almost Complete!"}),a.jsx("p",{className:"text-sm text-white/70",children:"One more step to unlock your personalized health plan"})]})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8 overflow-y-auto",children:a.jsxs("div",{className:"w-full max-w-md py-8",children:[a.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 mb-6 text-cyan-700 hover:text-cyan-800",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Nutrition Goals"}),a.jsx("p",{className:"text-cyan-700",children:"Step 6 of 6 - Final step!"})]}),a.jsxs("form",{onSubmit:ie,className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-3 text-slate-900",children:"What's your primary nutrition goal?"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>R({...y,nutritionGoal:"weight_loss"}),className:`p-4 rounded-xl border-2 transition-all ${y.nutritionGoal==="weight_loss"?"border-cyan-600 bg-cyan-50":"border-slate-200 bg-white hover:border-cyan-300"}`,children:[a.jsx(fg,{className:`w-8 h-8 mx-auto mb-2 ${y.nutritionGoal==="weight_loss"?"text-cyan-600":"text-slate-400"}`}),a.jsx("p",{className:"text-sm font-medium text-slate-900",children:"Weight Loss"})]}),a.jsxs("button",{type:"button",onClick:()=>R({...y,nutritionGoal:"weight_gain"}),className:`p-4 rounded-xl border-2 transition-all ${y.nutritionGoal==="weight_gain"?"border-cyan-600 bg-cyan-50":"border-slate-200 bg-white hover:border-cyan-300"}`,children:[a.jsx(Qn,{className:`w-8 h-8 mx-auto mb-2 ${y.nutritionGoal==="weight_gain"?"text-cyan-600":"text-slate-400"}`}),a.jsx("p",{className:"text-sm font-medium text-slate-900",children:"Weight Gain"})]}),a.jsxs("button",{type:"button",onClick:()=>R({...y,nutritionGoal:"muscle_gain"}),className:`p-4 rounded-xl border-2 transition-all ${y.nutritionGoal==="muscle_gain"?"border-cyan-600 bg-cyan-50":"border-slate-200 bg-white hover:border-cyan-300"}`,children:[a.jsx(ag,{className:`w-8 h-8 mx-auto mb-2 ${y.nutritionGoal==="muscle_gain"?"text-cyan-600":"text-slate-400"}`}),a.jsx("p",{className:"text-sm font-medium text-slate-900",children:"Muscle Gain"})]}),a.jsxs("button",{type:"button",onClick:()=>R({...y,nutritionGoal:"maintain"}),className:`p-4 rounded-xl border-2 transition-all ${y.nutritionGoal==="maintain"?"border-cyan-600 bg-cyan-50":"border-slate-200 bg-white hover:border-cyan-300"}`,children:[a.jsx(Xd,{className:`w-8 h-8 mx-auto mb-2 ${y.nutritionGoal==="maintain"?"text-cyan-600":"text-slate-400"}`}),a.jsx("p",{className:"text-sm font-medium text-slate-900",children:"Maintain"})]}),a.jsxs("button",{type:"button",onClick:()=>R({...y,nutritionGoal:"general_health"}),className:`p-4 rounded-xl border-2 transition-all col-span-2 ${y.nutritionGoal==="general_health"?"border-cyan-600 bg-cyan-50":"border-slate-200 bg-white hover:border-cyan-300"}`,children:[a.jsx(zn,{className:`w-8 h-8 mx-auto mb-2 ${y.nutritionGoal==="general_health"?"text-cyan-600":"text-slate-400"}`}),a.jsx("p",{className:"text-sm font-medium text-slate-900",children:"General Health"})]})]})]}),(y.nutritionGoal==="weight_loss"||y.nutritionGoal==="weight_gain")&&a.jsxs("div",{className:"bg-white rounded-xl p-4 space-y-4 border border-cyan-200",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Target Weight (kg)"}),a.jsx("input",{type:"number",value:y.targetWeight,onChange:he=>R({...y,targetWeight:he.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:y.weight,min:"30",max:"300",step:"0.1"}),a.jsxs("p",{className:"text-xs mt-1 text-slate-600",children:["Current: ",y.weight," kg"]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Weekly Goal"}),a.jsxs("select",{value:y.weeklyGoal,onChange:he=>R({...y,weeklyGoal:he.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-200 text-slate-900",children:[a.jsx("option",{value:"0.25",className:"text-slate-900",children:"0.25 kg/week (Slow & Steady)"}),a.jsx("option",{value:"0.5",className:"text-slate-900",children:"0.5 kg/week (Recommended)"}),a.jsx("option",{value:"1",className:"text-slate-900",children:"1 kg/week (Aggressive)"})]})]}),pe&&a.jsx("div",{className:"bg-cyan-50 rounded-xl p-3 border border-cyan-200",children:a.jsxs("p",{className:"text-sm text-cyan-900",children:[a.jsx("strong",{children:"Estimated time:"})," ",pe," weeks (",Math.ceil(pe/4)," months)"]})})]}),a.jsx("div",{className:"bg-cyan-50 rounded-xl p-4 border border-cyan-200",children:a.jsx("p",{className:"text-sm text-cyan-900 font-medium",children:"What happens next? We'll calculate your personalized daily calorie and macro goals based on your profile and goals. You can adjust these anytime from your nutrition dashboard."})}),a.jsx("button",{type:"submit",disabled:G,className:"w-full py-3 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700",children:G?a.jsx(uc,{className:"w-5 h-5 animate-spin"}):a.jsxs(a.Fragment,{children:["Create Account & Calculate Goals ",a.jsx(Ba,{className:"w-5 h-5"})]})})]})]})})]})}return f===6?a.jsxs("div",{className:"min-h-screen flex bg-gradient-to-br from-cyan-50 to-blue-50",children:[a.jsxs("div",{className:"hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-500 to-cyan-600",children:[a.jsxs("div",{className:"absolute inset-0",children:[a.jsx("div",{className:"absolute top-20 left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl"}),a.jsx("div",{className:"absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"})]}),a.jsxs("div",{className:"relative z-10 flex flex-col justify-center items-center p-12 text-white",children:[a.jsxs("div",{className:"relative w-32 h-32 mb-8",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 backdrop-blur-xl rounded-full animate-pulse"}),a.jsx("div",{className:"absolute inset-4 bg-white/30 backdrop-blur-xl rounded-full flex items-center justify-center",children:a.jsx(vr,{className:"w-12 h-12"})})]}),a.jsx("h1",{className:"text-4xl font-bold mb-4 text-center",children:"Set Your Goals"}),a.jsx("p",{className:"text-xl text-white/80 text-center max-w-md mb-6",children:"Define your target and we'll help you reach it with precision."}),a.jsx("p",{className:"text-sm text-white/70 mt-6",children:"Step 5 of 5"})]})]}),a.jsx("div",{className:"flex-1 flex items-center justify-center p-8 overflow-y-auto",children:a.jsxs("div",{className:"w-full max-w-md py-8",children:[a.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 mb-6 text-cyan-700 hover:text-cyan-800",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h2",{className:"text-3xl font-bold mb-2 text-slate-900",children:"Health Goals"}),a.jsx("p",{className:"text-cyan-700",children:"Step 5 of 5 - The finish line!"})]}),a.jsxs("form",{onSubmit:ie,className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Primary Goal"}),a.jsxs("select",{value:y.primaryGoal,onChange:Q=>R({...y,primaryGoal:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900",children:[a.jsx("option",{value:"weight_loss",className:"text-slate-900",children:"Weight Loss"}),a.jsx("option",{value:"weight_gain",className:"text-slate-900",children:"Weight Gain"}),a.jsx("option",{value:"maintain",className:"text-slate-900",children:"Maintain Weight"}),a.jsx("option",{value:"general_health",className:"text-slate-900",children:"General Health"}),a.jsx("option",{value:"diabetes_management",className:"text-slate-900",children:"Diabetes Management"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Target Weight (kg)"}),a.jsx("input",{type:"number",step:"0.1",value:y.targetWeight,onChange:Q=>R({...y,targetWeight:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900 placeholder:text-slate-400",placeholder:"65"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-900",children:"Weekly Goal (kg/week)"}),a.jsxs("select",{value:y.weeklyGoal,onChange:Q=>R({...y,weeklyGoal:Q.target.value}),className:"w-full bg-white rounded-xl py-3 px-4 border border-cyan-200 text-slate-900",children:[a.jsx("option",{value:"0.25",className:"text-slate-900",children:"0.25 kg (Steady)"}),a.jsx("option",{value:"0.5",className:"text-slate-900",children:"0.5 kg (Recommended)"}),a.jsx("option",{value:"1.0",className:"text-slate-900",children:"1.0 kg (Aggressive)"})]})]}),a.jsx("button",{type:"submit",disabled:G,className:"w-full py-3 text-white font-semibold rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 flex items-center justify-center gap-2 disabled:opacity-50",children:G?a.jsx(uc,{className:"w-5 h-5 animate-spin"}):a.jsxs(a.Fragment,{children:["Create Account ",a.jsx(Ba,{className:"w-5 h-5"})]})})]})]})})]}):null}const bQ=["General Physician","Cardiologist","Dermatologist","Endocrinologist","Gastroenterologist","Neurologist","Nutritionist","Oncologist","Orthopedic","Pediatrician","Psychiatrist","Pulmonologist"],YP=[{id:"license",name:"Medical License",description:"Valid medical license certificate"},{id:"degree",name:"Medical Degree",description:"MBBS/MD or equivalent degree certificate"},{id:"id_proof",name:"ID Proof",description:"Government issued ID (Aadhar/Passport)"}];function _Q(){const{registerDoctor:u}=ia(),f=Ga(),[x,_]=j.useState(!1),[E,y]=j.useState(1),[R,P]=j.useState({name:"",email:"",phone:"",password:"",confirmPassword:"",specialization:"",qualifications:"",experience:"",hospital:"",licenseNumber:"",consultationFee:"",bio:""}),[U,G]=j.useState({}),F=D=>{P({...R,[D.target.name]:D.target.value})},k=(D,H)=>{H&&G(B=>({...B,[D]:{file:H,name:H.name,size:(H.size/1024).toFixed(1)+" KB"}}))},X=D=>{G(H=>{const B={...H};return delete B[D],B})},q=async D=>{var B,ne;if(D.preventDefault(),R.password!==R.confirmPassword){Ve.error("Passwords do not match");return}const H=YP.filter(ae=>!U[ae.id]);if(H.length>0){Ve.error(`Please upload: ${H.map(ae=>ae.name).join(", ")}`);return}_(!0);try{const ae=Object.entries(U).map(([Z,te])=>({name:te.name,type:Z,url:`pending_upload_${Z}`}));await u({...R,qualifications:R.qualifications.split(",").map(Z=>Z.trim()).filter(Boolean),experience:parseInt(R.experience),consultationFee:parseInt(R.consultationFee)||500,documents:ae}),Ve.success("Registration successful! Your profile is pending approval."),f("/doctor/dashboard")}catch(ae){Ve.error(((ne=(B=ae.response)==null?void 0:B.data)==null?void 0:ne.message)||"Registration failed")}finally{_(!1)}};return a.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"w-full max-w-2xl",children:[a.jsxs("div",{className:"text-center mb-8",children:[a.jsxs(Rt,{to:"/",className:"inline-flex items-center gap-2 mb-6",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center",children:a.jsx(ms,{className:"w-7 h-7 text-white"})}),a.jsx("span",{className:"text-2xl font-bold text-slate-800",children:"HealthAI"})]}),a.jsx("h1",{className:"text-3xl font-bold text-slate-800 mb-2",children:"Doctor Registration"}),a.jsx("p",{className:"text-slate-500",children:"Join our platform and connect with patients"})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-8 shadow-sm",children:[a.jsx("div",{className:"flex items-center justify-center gap-4 mb-8",children:[1,2,3].map(D=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-semibold ${E>=D?"bg-cyan-500 text-white":"bg-slate-200 text-slate-400"}`,children:D}),a.jsx("span",{className:`text-sm hidden sm:block ${E>=D?"text-cyan-600 font-medium":"text-slate-400"}`,children:D===1?"Account":D===2?"Professional":"Documents"}),D<3&&a.jsx("div",{className:`w-8 h-1 rounded ${E>D?"bg-cyan-500":"bg-slate-200"}`})]},D))}),a.jsxs("form",{onSubmit:q,children:[E===1&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Full Name"}),a.jsx("input",{type:"text",name:"name",value:R.name,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"Dr. John Smith",required:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Email"}),a.jsx("input",{type:"email",name:"email",value:R.email,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"doctor@example.com",required:!0})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Phone"}),a.jsx("input",{type:"tel",name:"phone",value:R.phone,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"+91 98765 43210"})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Password"}),a.jsx("input",{type:"password",name:"password",value:R.password,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"",required:!0,minLength:6})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Confirm Password"}),a.jsx("input",{type:"password",name:"confirmPassword",value:R.confirmPassword,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"",required:!0})]})]}),a.jsx("button",{type:"button",onClick:()=>y(2),className:"w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all mt-4",children:"Continue "})]}),E===2&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Specialization"}),a.jsxs("select",{name:"specialization",value:R.specialization,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:outline-none",required:!0,children:[a.jsx("option",{value:"",children:"Select specialization"}),bQ.map(D=>a.jsx("option",{value:D,children:D},D))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Experience (years)"}),a.jsx("input",{type:"number",name:"experience",value:R.experience,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"5",required:!0,min:0})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Medical License Number"}),a.jsx("input",{type:"text",name:"licenseNumber",value:R.licenseNumber,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"MCI-12345",required:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Qualifications (comma separated)"}),a.jsx("input",{type:"text",name:"qualifications",value:R.qualifications,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"MBBS, MD, FRCP"})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Hospital/Clinic"}),a.jsx("input",{type:"text",name:"hospital",value:R.hospital,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"City Hospital"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Consultation Fee ()"}),a.jsx("input",{type:"number",name:"consultationFee",value:R.consultationFee,onChange:F,className:"w-full bg-white border border-slate-200 rounded-xl py-3 px-4 text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none",placeholder:"500",min:0})]})]}),a.jsxs("div",{className:"flex gap-3 mt-4",children:[a.jsxs("button",{type:"button",onClick:()=>y(1),className:"flex-1 py-3 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition-all flex items-center justify-center gap-2",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsx("button",{type:"button",onClick:()=>y(3),className:"flex-1 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all",children:"Continue "})]})]}),E===3&&a.jsxs("div",{className:"space-y-4",children:[a.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4",children:a.jsxs("p",{className:"text-sm text-amber-800",children:[a.jsx("strong",{children:"Important:"})," Please upload clear copies of the following documents. These will be reviewed by our admin team before your profile is approved."]})}),YP.map(D=>a.jsxs("div",{className:"border border-slate-200 rounded-xl p-4",children:[a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{children:[a.jsxs("h4",{className:"font-medium text-slate-800",children:[D.name," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("p",{className:"text-sm text-slate-500",children:D.description})]}),U[D.id]?a.jsx(Hs,{className:"w-5 h-5 text-green-500"}):null]}),U[D.id]?a.jsxs("div",{className:"mt-3 flex items-center justify-between bg-slate-50 rounded-lg p-3",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(un,{className:"w-5 h-5 text-cyan-500"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-medium text-slate-700",children:U[D.id].name}),a.jsx("p",{className:"text-xs text-slate-500",children:U[D.id].size})]})]}),a.jsx("button",{type:"button",onClick:()=>X(D.id),className:"p-1 text-slate-400 hover:text-red-500",children:a.jsx(ra,{className:"w-4 h-4"})})]}):a.jsxs("label",{className:"mt-3 flex items-center justify-center gap-2 p-4 border-2 border-dashed border-slate-200 rounded-lg cursor-pointer hover:border-cyan-500 hover:bg-cyan-50 transition-all",children:[a.jsx(Kr,{className:"w-5 h-5 text-slate-400"}),a.jsx("span",{className:"text-sm text-slate-500",children:"Click to upload"}),a.jsx("input",{type:"file",className:"hidden",accept:".pdf,.jpg,.jpeg,.png",onChange:H=>k(D.id,H.target.files[0])})]})]},D.id)),a.jsxs("div",{className:"flex gap-3 mt-6",children:[a.jsxs("button",{type:"button",onClick:()=>y(2),className:"flex-1 py-3 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition-all flex items-center justify-center gap-2",children:[a.jsx(dn,{className:"w-4 h-4"})," Back"]}),a.jsx("button",{type:"submit",disabled:x,className:"flex-1 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all disabled:opacity-50",children:x?"Submitting...":"Submit Application"})]})]})]}),a.jsxs("p",{className:"text-center text-slate-500 mt-6",children:["Already have an account? ",a.jsx(Rt,{to:"/login",className:"text-cyan-600 hover:text-cyan-700 font-medium",children:"Sign in"})]})]}),a.jsxs("p",{className:"text-center text-sm text-slate-500 mt-6 flex items-center justify-center gap-2",children:[a.jsx(p2,{className:"w-4 h-4"}),"Your profile will be reviewed by our admin team before being listed."]})]})})}const _L=j.createContext(),vL=()=>{const u=j.useContext(_L);if(!u)throw new Error("useData must be used within DataProvider");return u},vQ=({children:u})=>{const[f,x]=j.useState(null),[_,E]=j.useState(null),[y,R]=j.useState(null),[P,U]=j.useState({dashboard:!1,wearable:!1,nutrition:!1}),G=j.useCallback(async(D=!1)=>{if(!D){const H=Yi.get("dashboard");if(H)return x(H),H}U(H=>({...H,dashboard:!0}));try{const B=(await qr.getDashboard()).data;return x(B),Yi.set("dashboard",B,10*60*1e3),B}catch(H){throw console.error("Failed to fetch dashboard:",H),H}finally{U(H=>({...H,dashboard:!1}))}},[]),F=j.useCallback(async(D=!1)=>{if(!D){const H=Yi.get("wearable");if(H)return E(H),H}U(H=>({...H,wearable:!0}));try{const B=(await Ud.getDashboard()).data;return E(B),Yi.set("wearable",B,2*60*1e3),B}catch(H){console.error("Failed to fetch wearable:",H);const B={connected:!1};return E(B),B}finally{U(H=>({...H,wearable:!1}))}},[]),k=j.useCallback(async(D,H=!1)=>{var ne;const B=`nutrition_${D}`;if(!H){const ae=Yi.get(B);if(ae)return R(ae),ae}U(ae=>({...ae,nutrition:!0}));try{const Z=((ne=(await WJ.getDailySummary(D)).data)==null?void 0:ne.summary)||null;return R(Z),Z&&Yi.set(B,Z,5*60*1e3),Z}catch(ae){return console.error("Failed to fetch nutrition:",ae),R(null),null}finally{U(ae=>({...ae,nutrition:!1}))}},[]),X=j.useCallback((D=[])=>{D.length===0?(Yi.clear(),x(null),E(null),R(null)):D.forEach(H=>{Yi.delete(H),H==="dashboard"&&x(null),H==="wearable"&&E(null),H.startsWith("nutrition_")&&R(null)})},[]),q={dashboardData:f,wearableData:_,nutritionData:y,loading:P,fetchDashboard:G,fetchWearable:F,fetchNutrition:k,invalidateCache:X};return a.jsx(_L.Provider,{value:q,children:u})},EQ="http://localhost:5000",yQ=({bmi:u})=>{const[E,y]=j.useState(null),P=u<16?0:u>=40?180:(u-16)/24*180,U=[{start:0,end:30,color:"#ef4444",label:"Underweight",range:"< 18.5"},{start:30,end:82.5,color:"#22c55e",label:"Normal",range:"18.5 - 25"},{start:82.5,end:120,color:"#eab308",label:"Overweight",range:"25 - 30"},{start:120,end:157.5,color:"#f97316",label:"Obese",range:"30 - 35"},{start:157.5,end:180,color:"#dc2626",label:"Severely Obese",range:"> 35"}];return a.jsxs("div",{className:"relative flex items-center justify-center",children:[a.jsxs("svg",{width:200,height:200/2+20,className:"overflow-visible",children:[U.map((G,F)=>{const k=G.start-90,X=G.end-90,q=X-k>180?1:0,D=200/2+90*Math.cos(k*Math.PI/180),H=200/2+90*Math.sin(k*Math.PI/180),B=200/2+90*Math.cos(X*Math.PI/180),ne=200/2+90*Math.sin(X*Math.PI/180);return a.jsx("g",{children:a.jsx("path",{d:`M ${D} ${H} A 90 90 0 ${q} 1 ${B} ${ne}`,fill:"none",stroke:G.color,strokeWidth:20,strokeLinecap:"round",className:"cursor-pointer transition-opacity hover:opacity-80",onMouseEnter:()=>y(F),onMouseLeave:()=>y(null)})},F)}),a.jsxs("g",{transform:`rotate(${P-90} ${200/2} ${200/2})`,children:[a.jsx("line",{x1:200/2,y1:200/2,x2:200/2+90-10,y2:200/2,stroke:"#1e293b",strokeWidth:"3",strokeLinecap:"round"}),a.jsx("circle",{cx:200/2,cy:200/2,r:"8",fill:"#1e293b"})]}),a.jsx("text",{x:200/2,y:200/2+35,textAnchor:"middle",className:"text-3xl font-bold fill-slate-800",children:u.toFixed(1)}),a.jsx("text",{x:200/2,y:200/2+55,textAnchor:"middle",className:"text-xs fill-slate-500",children:"kg/m"})]}),E!==null&&a.jsxs("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-full mb-2 px-3 py-2 bg-slate-800 text-white text-xs font-medium rounded-lg shadow-lg whitespace-nowrap z-10",children:[a.jsx("div",{className:"font-semibold",children:U[E].label}),a.jsxs("div",{className:"text-slate-300",children:["BMI: ",U[E].range]}),a.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"})]})]})},wQ=({bmi:u})=>{const[E,y]=j.useState(null),P=u<16?0:u>=40?180:(u-16)/24*180,U=[{start:0,end:30,color:"#ef4444",label:"Underweight",range:"< 18.5"},{start:30,end:82.5,color:"#22c55e",label:"Normal",range:"18.5 - 25"},{start:82.5,end:120,color:"#eab308",label:"Overweight",range:"25 - 30"},{start:120,end:157.5,color:"#f97316",label:"Obese",range:"30 - 35"},{start:157.5,end:180,color:"#dc2626",label:"Severely Obese",range:"> 35"}];return a.jsxs("div",{className:"relative flex items-center justify-center",children:[a.jsxs("svg",{width:240,height:240/2+30,className:"overflow-visible",children:[U.map((G,F)=>{const k=G.start,X=G.end,q=0,D=240/2-109*Math.cos(k*Math.PI/180),H=240/2-109*Math.sin(k*Math.PI/180),B=240/2-109*Math.cos(X*Math.PI/180),ne=240/2-109*Math.sin(X*Math.PI/180);return a.jsx("g",{children:a.jsx("path",{d:`M ${D} ${H} A 109 109 0 ${q} 1 ${B} ${ne}`,fill:"none",stroke:G.color,strokeWidth:22,strokeLinecap:"round",className:"cursor-pointer transition-opacity active:opacity-80",onTouchStart:()=>y(F),onTouchEnd:()=>y(null),onMouseEnter:()=>y(F),onMouseLeave:()=>y(null)})},F)}),a.jsxs("g",{transform:`rotate(${P} ${240/2} ${240/2})`,children:[a.jsx("line",{x1:240/2,y1:240/2,x2:240/2-109+12,y2:240/2,stroke:"#1e293b",strokeWidth:"3",strokeLinecap:"round"}),a.jsx("circle",{cx:240/2,cy:240/2,r:"9",fill:"#1e293b"})]}),a.jsx("text",{x:240/2,y:240/2+25,textAnchor:"middle",className:"text-4xl font-bold fill-slate-800",children:u.toFixed(1)}),a.jsx("text",{x:240/2,y:240/2+45,textAnchor:"middle",className:"text-sm fill-slate-500 font-medium",children:"kg/m"})]}),E!==null&&a.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-800 text-white text-xs font-medium rounded-lg shadow-lg whitespace-nowrap z-10 animate-fade-in",children:[a.jsx("div",{className:"font-semibold",children:U[E].label}),a.jsxs("div",{className:"text-slate-300",children:["BMI: ",U[E].range]}),a.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"})]})]})},SQ=({bmi:u})=>{const x=u<16?{label:"Severely Underweight",color:"bg-red-100 text-red-700 border-red-200",icon:hn}:u<18.5?{label:"Underweight",color:"bg-red-50 text-red-600 border-red-200",icon:hn}:u<25?{label:"Normal",color:"bg-green-100 text-green-700 border-green-200",icon:Hs}:u<30?{label:"Overweight",color:"bg-yellow-100 text-yellow-700 border-yellow-200",icon:Qn}:u<35?{label:"Obese",color:"bg-orange-100 text-orange-700 border-orange-200",icon:Qn}:{label:"Severely Obese",color:"bg-red-100 text-red-700 border-red-200",icon:hn},_=x.icon;return a.jsxs("div",{className:`flex items-center gap-1.5 lg:gap-2 px-3 lg:px-4 py-1.5 lg:py-2 rounded-full border-2 ${x.color} font-semibold text-xs lg:text-sm`,children:[a.jsx(_,{className:"w-3.5 h-3.5 lg:w-4 lg:h-4"}),x.label]})};function NQ(){const{user:u}=ia(),[f,x]=j.useState(null),[_,E]=j.useState(null),[y,R]=j.useState(null),[P,U]=j.useState(null),[G,F]=j.useState(null);j.useEffect(()=>{k(),X()},[u]);const k=()=>{var ie,ue;const q=(ie=u==null?void 0:u.profile)==null?void 0:ie.height,D=(ue=u==null?void 0:u.profile)==null?void 0:ue.weight;if(!q||!D)return;const H=q/100,B=D/(H*H);x(B);const ne=B/25;E(ne);const ae=D/Math.pow(H,3);R(ae);const Z=18.5*H*H,te=25*H*H;U({min:Z.toFixed(1),max:te.toFixed(1)})},X=async()=>{var q;try{const D=localStorage.getItem("token"),{data:H}=await ks.get(`${EQ}/api/auth/profile`,{headers:{Authorization:`Bearer ${D}`}});F((q=H.user)==null?void 0:q.nutritionGoal)}catch(D){console.error("Failed to fetch goal:",D)}};return f?a.jsx(a.Fragment,{children:a.jsx("div",{className:"bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl border-2 border-cyan-200 p-4 lg:p-6 shadow-sm",children:a.jsxs("div",{className:"flex flex-col lg:flex-row items-center gap-3 lg:gap-6",children:[a.jsx("div",{className:"lg:hidden w-full flex justify-center",children:a.jsx(wQ,{bmi:f})}),a.jsx("div",{className:"hidden lg:block flex-shrink-0",children:a.jsx(yQ,{bmi:f})}),a.jsxs("div",{className:"flex-1 w-full space-y-2 lg:space-y-4 text-center lg:text-left",children:[a.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2 justify-center lg:justify-start",children:[a.jsx("h3",{className:"hidden lg:block text-2xl font-bold text-slate-800",children:"Your BMI"}),a.jsx(SQ,{bmi:f})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2 lg:gap-3",children:[a.jsxs("div",{className:"bg-white rounded-lg lg:rounded-xl p-2 lg:p-3 border border-slate-200",children:[a.jsx("p",{className:"text-[10px] lg:text-xs text-slate-600 mb-0.5 lg:mb-1",children:"Healthy BMI"}),a.jsx("p",{className:"text-xs lg:text-sm font-bold text-slate-800",children:"18.5 - 25"})]}),a.jsxs("div",{className:"bg-white rounded-lg lg:rounded-xl p-2 lg:p-3 border border-slate-200",children:[a.jsx("p",{className:"text-[10px] lg:text-xs text-slate-600 mb-0.5 lg:mb-1",children:"Healthy Weight"}),a.jsxs("p",{className:"text-xs lg:text-sm font-bold text-slate-800",children:[P==null?void 0:P.min," - ",P==null?void 0:P.max," kg"]})]}),a.jsxs("div",{className:"bg-white rounded-lg lg:rounded-xl p-2 lg:p-3 border border-slate-200",children:[a.jsx("p",{className:"text-[10px] lg:text-xs text-slate-600 mb-0.5 lg:mb-1",children:"BMI Prime"}),a.jsx("p",{className:"text-xs lg:text-sm font-bold text-slate-800",children:_==null?void 0:_.toFixed(2)})]}),a.jsxs("div",{className:"bg-white rounded-lg lg:rounded-xl p-2 lg:p-3 border border-slate-200",children:[a.jsx("p",{className:"text-[10px] lg:text-xs text-slate-600 mb-0.5 lg:mb-1",children:"Ponderal Index"}),a.jsxs("p",{className:"text-xs lg:text-sm font-bold text-slate-800",children:[y==null?void 0:y.toFixed(1)," kg/m"]})]})]}),G!=null&&G.goal?a.jsx("div",{className:"bg-white rounded-lg lg:rounded-xl p-2.5 lg:p-4 border-2 border-cyan-200",children:a.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-2 lg:gap-3",children:[a.jsxs("div",{className:"text-center sm:text-left",children:[a.jsx("p",{className:"text-[10px] lg:text-xs text-slate-600 mb-0.5 lg:mb-1",children:"Current Goal"}),a.jsxs("p",{className:"text-xs lg:text-sm font-bold text-slate-800 capitalize",children:[G.goal.replace("_"," "),G.targetWeight&&` - ${G.targetWeight} kg`]})]}),a.jsx(Rt,{to:"/profile?tab=goals",className:"px-3 py-1.5 lg:px-4 lg:py-2 bg-cyan-500 text-white rounded-lg text-xs lg:text-sm font-medium hover:bg-cyan-600 transition-colors whitespace-nowrap",children:"Change"})]})}):a.jsxs(Rt,{to:"/profile?tab=goals",className:"w-full py-2 lg:py-3 bg-cyan-500 text-white rounded-lg lg:rounded-xl font-semibold hover:bg-cyan-600 transition-colors flex items-center justify-center gap-2 text-sm lg:text-base",children:[a.jsx(vr,{className:"w-4 h-4 lg:w-5 lg:h-5"}),"Set Your Goal"]})]})]})})}):a.jsx("div",{className:"bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl border-2 border-cyan-200 p-6",children:a.jsxs("div",{className:"text-center",children:[a.jsx(vr,{className:"w-12 h-12 text-cyan-500 mx-auto mb-3"}),a.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2",children:"Complete Your Profile"}),a.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Add your height and weight to see your BMI and get personalized recommendations"}),a.jsx("a",{href:"/profile",className:"inline-block px-6 py-2 bg-cyan-500 text-white rounded-xl font-medium hover:bg-cyan-600 transition-colors",children:"Update Profile"})]})})}function TQ({isOpen:u,onClose:f}){const[x,_]=j.useState(!1),[E,y]=j.useState(null),[R,P]=j.useState(0),[U,G]=j.useState([]),[F,k]=j.useState(!1),[X,q]=j.useState(""),[D,H]=j.useState(""),[B,ne]=j.useState(new Date);j.useEffect(()=>{const fe=localStorage.getItem("sleep_tracking"),le=localStorage.getItem("sleep_history");if(fe){const we=JSON.parse(fe);if(_(we.isTracking),y(we.startTime?new Date(we.startTime):null),we.isTracking&&we.startTime){const re=Date.now()-new Date(we.startTime).getTime();P(re)}}le&&G(JSON.parse(le))},[]),j.useEffect(()=>{let fe;return x&&E&&(fe=setInterval(()=>{const le=Date.now()-E.getTime();P(le)},1e3)),()=>clearInterval(fe)},[x,E]);const ae=fe=>{const le=Math.floor(fe/1e3),we=Math.floor(le/3600),re=Math.floor(le%3600/60);return{hours:we,minutes:re}},Z=()=>{const fe=new Date;_(!0),y(fe),P(0),localStorage.setItem("sleep_tracking",JSON.stringify({isTracking:!0,startTime:fe.toISOString()})),Ve.success("Sleep tracking started ")},te=()=>{if(!E)return;const fe=new Date,le=fe.getTime()-E.getTime(),{hours:we,minutes:re}=ae(le),J=[{id:Date.now(),date:E.toISOString(),startTime:E.toISOString(),endTime:fe.toISOString(),duration:le,hours:we,minutes:re,quality:ie(we)},...U].slice(0,7);G(J),localStorage.setItem("sleep_history",JSON.stringify(J)),_(!1),y(null),P(0),localStorage.removeItem("sleep_tracking"),Ve.success(`Sleep recorded: ${we}h ${re}m `)},ie=fe=>fe>=7&&fe<=9?85+Math.floor(Math.random()*15):fe>=6&&fe<7?70+Math.floor(Math.random()*15):fe>=5&&fe<6?55+Math.floor(Math.random()*15):40+Math.floor(Math.random()*15),ue=()=>{const fe=parseInt(X)||0,le=parseInt(D)||0;if(fe===0&&le===0){Ve.error("Please enter valid time");return}const we=(fe*3600+le*60)*1e3,re=new Date(B),oe=new Date(re.getTime()-we),Oe=[{id:Date.now(),date:B.toISOString(),startTime:oe.toISOString(),endTime:re.toISOString(),duration:we,hours:fe,minutes:le,quality:ie(fe),manual:!0},...U].slice(0,7);G(Oe),localStorage.setItem("sleep_history",JSON.stringify(Oe)),k(!1),q(""),H(""),Ve.success("Sleep data saved manually ")},Ne=()=>{const fe=new Date().toDateString();return U.find(le=>new Date(le.date).toDateString()===fe)},be=()=>{const fe=[];for(let le=6;le>=0;le--){const we=new Date;we.setDate(we.getDate()-le),fe.push(we)}return fe},{hours:Q,minutes:pe}=ae(R),he=Ne(),Ae=be();return u?a.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-3xl w-full max-w-md max-h-[90vh] flex flex-col shadow-2xl border border-slate-700",children:[a.jsxs("div",{className:"flex-shrink-0 bg-slate-900/95 backdrop-blur-sm p-4 border-b border-slate-700 flex items-center justify-between rounded-t-3xl",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center",children:a.jsx(Yd,{className:"w-5 h-5 text-white"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-lg font-bold text-white",children:"Sleep Tracker"}),a.jsx("p",{className:"text-xs text-slate-400",children:"Track your sleep quality"})]})]}),a.jsx("button",{onClick:f,className:"p-2 hover:bg-slate-800 rounded-full transition",children:a.jsx(ra,{className:"w-5 h-5 text-slate-400"})})]}),a.jsxs("div",{className:"flex-1 overflow-y-auto overflow-x-hidden",children:[a.jsxs("div",{className:"p-3 sm:p-4 border-b border-slate-700",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-xl sm:text-2xl font-bold text-white truncate",children:new Date().toLocaleDateString("en-US",{weekday:"long"})}),a.jsx("p",{className:"text-xs sm:text-sm text-slate-400",children:new Date().toLocaleDateString("en-US",{day:"numeric",month:"long"})})]}),a.jsx("button",{onClick:()=>k(!F),className:"p-2 hover:bg-slate-800 rounded-lg transition flex-shrink-0",children:a.jsx(Pn,{className:"w-4 h-4 sm:w-5 sm:h-5 text-slate-400"})})]}),a.jsx("div",{className:"flex justify-between gap-1.5 sm:gap-2",children:Ae.map((fe,le)=>{const we=U.find(oe=>new Date(oe.date).toDateString()===fe.toDateString()),re=fe.toDateString()===new Date().toDateString();return a.jsx("div",{className:`flex-1 text-center ${re?"opacity-100":"opacity-60"}`,children:a.jsx("div",{className:`w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full flex items-center justify-center mb-1 ${we?"bg-gradient-to-br from-orange-500 to-orange-600 ring-2 ring-orange-400/30":"bg-slate-800"} ${re?"ring-2 ring-white/30":""}`,children:a.jsx("span",{className:"text-[10px] sm:text-xs font-medium text-white",children:fe.toLocaleDateString("en-US",{weekday:"short"})[0]})})},le)})}),a.jsxs("div",{className:"mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-slate-700/50",children:[a.jsx("p",{className:"text-xs text-slate-400 mb-3 font-medium",children:"Weekly Sleep Pattern"}),a.jsx("div",{className:"flex items-end justify-between gap-1.5 sm:gap-2 h-24",children:Ae.map((fe,le)=>{const we=U.find(J=>new Date(J.date).toDateString()===fe.toDateString()),re=(we==null?void 0:we.hours)||0,oe=re>0?Math.max(Math.min(re/10*100,100),10):0;return a.jsxs("div",{className:"flex-1 flex flex-col items-center gap-1 min-w-[10px]",children:[a.jsx("div",{className:"w-full bg-slate-800 rounded-t-lg overflow-hidden relative",style:{height:"80px"},children:oe>0&&a.jsx("div",{className:"absolute bottom-0 w-full bg-gradient-to-t from-orange-500 to-orange-400 rounded-t-lg transition-all duration-700 ease-out",style:{height:`${oe}%`},children:a.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-transparent to-white/20"})})}),a.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500 font-medium",children:fe.toLocaleDateString("en-US",{weekday:"short"})[0]})]},le)})}),U.length===0&&a.jsx("p",{className:"text-xs text-slate-500 text-center mt-3",children:" Add sleep data to see your weekly pattern"})]})]}),a.jsxs("div",{className:"p-3 sm:p-6",children:[a.jsxs("div",{className:"flex items-center justify-between gap-3 mb-4 sm:mb-6",children:[a.jsxs("div",{className:"relative w-24 h-24 sm:w-32 sm:h-32 flex-shrink-0",children:[a.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[a.jsx("circle",{cx:"48",cy:"48",r:"42",stroke:"#1e293b",strokeWidth:"10",fill:"none",className:"sm:hidden"}),a.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"#1e293b",strokeWidth:"12",fill:"none",className:"hidden sm:block"}),a.jsx("circle",{cx:"48",cy:"48",r:"42",stroke:"url(#gradient)",strokeWidth:"10",fill:"none",strokeDasharray:`${((he==null?void 0:he.quality)||0)*2.64} 264`,strokeLinecap:"round",className:"transition-all duration-1000 sm:hidden"}),a.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"url(#gradient)",strokeWidth:"12",fill:"none",strokeDasharray:`${((he==null?void 0:he.quality)||0)*3.51} 351`,strokeLinecap:"round",className:"transition-all duration-1000 hidden sm:block"}),a.jsx("defs",{children:a.jsxs("linearGradient",{id:"gradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[a.jsx("stop",{offset:"0%",stopColor:"#f97316"}),a.jsx("stop",{offset:"100%",stopColor:"#fb923c"})]})})]}),a.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[a.jsxs("span",{className:"text-2xl sm:text-3xl font-bold text-white",children:[(he==null?void 0:he.quality)||0,"%"]}),a.jsx("span",{className:"text-xs text-slate-400",children:"Quality"})]})]}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsxs("div",{className:"text-center sm:text-left",children:[a.jsx("span",{className:"text-2xl sm:text-3xl font-bold text-white block",children:x?`${Q}h ${pe}m`:he?`${he.hours}h ${he.minutes}m`:"0h 0m"}),a.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Time in bed"})]})})]}),F?a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"bg-slate-800 rounded-2xl p-4",children:[a.jsx("p",{className:"text-sm text-slate-400 mb-3",children:"Enter sleep duration"}),a.jsxs("div",{className:"flex gap-3",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("input",{type:"number",value:X,onChange:fe=>q(fe.target.value),placeholder:"0",className:"w-full px-4 py-3 bg-slate-700 text-white placeholder-slate-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-lg font-semibold",min:"0",max:"24"}),a.jsx("p",{className:"text-xs text-slate-500 mt-1 text-center",children:"Hours"})]}),a.jsxs("div",{className:"flex-1",children:[a.jsx("input",{type:"number",value:D,onChange:fe=>H(fe.target.value),placeholder:"0",className:"w-full px-4 py-3 bg-slate-700 text-white placeholder-slate-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-lg font-semibold",min:"0",max:"59"}),a.jsx("p",{className:"text-xs text-slate-500 mt-1 text-center",children:"Minutes"})]})]})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsxs("button",{onClick:ue,className:"flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-2xl font-semibold flex items-center justify-center gap-2 transition",children:[a.jsx(cc,{className:"w-4 h-4"}),"Save"]}),a.jsx("button",{onClick:()=>{k(!1),q(""),H("")},className:"flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-2xl font-medium transition",children:"Cancel"})]})]}):a.jsx("div",{className:"space-y-2",children:x?a.jsxs("button",{onClick:te,className:"w-full py-3 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition shadow-lg animate-pulse text-sm",children:[a.jsx(QY,{className:"w-4 h-4"}),"Stop & Save Sleep"]}):a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{onClick:Z,className:"flex-1 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-semibold flex items-center justify-center gap-1.5 transition shadow-lg text-xs",children:[a.jsx($Y,{className:"w-3.5 h-3.5"}),"Start Sleep"]}),a.jsxs("button",{onClick:()=>k(!0),className:"flex-1 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium flex items-center justify-center gap-1.5 transition text-xs",children:[a.jsx(m2,{className:"w-3.5 h-3.5"}),"Manual Edit"]})]})}),U.length>0&&a.jsxs("div",{className:"mt-6 pt-6 border-t border-slate-700",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-400 mb-3",children:"Recent Sleep History"}),a.jsx("div",{className:"space-y-2",children:U.slice(0,3).map(fe=>a.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-3 flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-medium text-white",children:new Date(fe.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}),a.jsxs("p",{className:"text-xs text-slate-400",children:[fe.hours,"h ",fe.minutes,"m ",fe.manual&&"(Manual)"]})]}),a.jsxs("div",{className:"text-right",children:[a.jsxs("p",{className:"text-lg font-bold text-orange-400",children:[fe.quality,"%"]}),a.jsx("p",{className:"text-xs text-slate-500",children:"Quality"})]})]},fe.id))})]})]})]})]})}):null}function RQ(){var we,re,oe,J,Oe,$e,He,ot,_t,Ke,ht,st,ct,fs,ys,As,zs,je,Ze,Ct,zt,ts,ge,We,rt,ws,Cn,Fe,Je,De,it,gs,Gt,Ss,pn,Zn,tn,mn,hs;const{user:u}=ia(),f=Ga(),{dashboardData:x,loading:_,fetchDashboard:E,fetchNutrition:y,nutritionData:R}=vL(),[P,U]=j.useState(0),[G,F]=j.useState(!x),[k,X]=j.useState(null),[q,D]=j.useState(!1),[H,B]=j.useState(""),[ne,ae]=j.useState(!1),[Z,te]=j.useState(new Date),ie=()=>{const ze=new Date(Z);ze.setDate(ze.getDate()-1),te(ze)},ue=()=>{const ze=new Date(Z);ze.setDate(ze.getDate()+1),te(ze)},Ne=()=>{const ze=new Date().getHours();return ze<12?"Morning":ze<18?"Afternoon":"Evening"},be=ze=>{ze.preventDefault(),H.trim()&&f("/ai-chat",{state:{initialQuery:H}})};if(j.useEffect(()=>{(async()=>{await E(),F(!1)})()},[E]),j.useEffect(()=>{const ze=Z.toISOString().split("T")[0];y(ze)},[Z,y]),j.useEffect(()=>{!x&&!_.dashboard&&!G&&E()},[x,_.dashboard,E,G]),j.useEffect(()=>{var ze;if(((ze=x==null?void 0:x.recentReports)==null?void 0:ze.length)>0&&!k){const It=x.recentReports.find(wt=>{var ft;return(ft=wt.aiAnalysis)==null?void 0:ft.metrics});if(It){const wt=Object.keys(It.aiAnalysis.metrics)[0];wt&&X(wt)}}},[x,k]),j.useEffect(()=>{const ze=()=>{!document.hidden&&x&&E(!0)};return document.addEventListener("visibilitychange",ze),()=>document.removeEventListener("visibilitychange",ze)},[E,x]),j.useEffect(()=>{var ze,It,wt;if(x){let ft=0;const Os=4;(ze=u==null?void 0:u.profile)!=null&&ze.age&&((It=u==null?void 0:u.profile)!=null&&It.gender)&&ft++,((wt=x.recentReports)==null?void 0:wt.length)>0&&ft++,x.nutritionTracked&&ft++,x.wearableConnected&&ft++;const Kn=Math.round(ft/Os*100);setTimeout(()=>U(Kn),300)}},[x,u]),G&&_.dashboard&&!x)return a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-600",children:"Loading your health dashboard..."})]})});const Q=((we=x==null?void 0:x.recentReports)==null?void 0:we.length)>0;(re=u==null?void 0:u.profile)!=null&&re.age&&((oe=u==null?void 0:u.profile)==null||oe.gender),x==null||x.nutritionTracked,x==null||x.wearableConnected;const pe=((Oe=(J=x==null?void 0:x.user)==null?void 0:J.healthMetrics)==null?void 0:Oe.healthScore)||(($e=x==null?void 0:x.latestAnalysis)==null?void 0:$e.healthScore),he={};x!=null&&x.recentReports&&x.recentReports.forEach(ze=>{var It;(It=ze.aiAnalysis)!=null&&It.metrics&&Object.entries(ze.aiAnalysis.metrics).forEach(([wt,ft])=>{he[wt]||(he[wt]={name:wt.replace(/([A-Z])/g," $1").trim(),unit:ft.unit||"",history:[]})})}),Object.keys(he).forEach(ze=>{var It;(It=x==null?void 0:x.recentReports)==null||It.forEach(wt=>{var Os,Kn;const ft=(Kn=(Os=wt.aiAnalysis)==null?void 0:Os.metrics)==null?void 0:Kn[ze];ft&&he[ze].history.push({date:new Date(wt.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric"}),value:parseFloat(ft.value)||0,fullDate:new Date(wt.createdAt)})}),he[ze].history.sort((wt,ft)=>wt.fullDate-ft.fullDate)});const Ae=Object.keys(he),fe=k||Ae[0],le=he[fe];return a.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-cyan-50 via-blue-50 to-cyan-100",children:[_.dashboard&&x&&a.jsxs("div",{className:"fixed top-20 right-4 z-50 bg-white rounded-full shadow-lg px-4 py-2 flex items-center gap-2 animate-slide-in-right",children:[a.jsx("div",{className:"w-4 h-4 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"}),a.jsx("span",{className:"text-sm text-slate-600",children:"Refreshing..."})]}),a.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 animate-fade-in pb-20 px-0 md:px-4",children:[a.jsxs("div",{className:"pt-4 space-y-3 md:hidden px-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-lg font-bold shadow-md",children:((ot=(He=u==null?void 0:u.name)==null?void 0:He[0])==null?void 0:ot.toUpperCase())||"U"}),a.jsxs("div",{children:[a.jsxs("h1",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[Ne(),", ",a.jsxs("span",{className:"text-slate-900",children:[((_t=u==null?void 0:u.name)==null?void 0:_t.split(" ")[0])||"there","!"]})]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600",children:[a.jsxs("span",{className:"font-semibold",children:[((Ke=x==null?void 0:x.nutritionData)==null?void 0:Ke.totalCalories)||0," cal"]}),a.jsx("span",{className:"text-slate-400",children:"."}),a.jsxs("span",{className:"font-semibold text-emerald-600",children:[((st=(ht=x==null?void 0:x.user)==null?void 0:ht.healthMetrics)==null?void 0:st.healthScore)||82,"% Healthy"]})]})]})]}),a.jsx("button",{className:"w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all",children:a.jsx(Eo,{className:"w-5 h-5 text-slate-700"})})]}),a.jsx("form",{onSubmit:be,className:"relative",children:a.jsxs("div",{className:"flex items-center gap-2 bg-white rounded-full px-4 py-2.5 shadow-md border-2 border-purple-200 hover:border-purple-300 transition-all",children:[a.jsx(bo,{className:"w-4 h-4 text-purple-500 flex-shrink-0"}),a.jsx("input",{type:"text",placeholder:"Ask coach",value:H,onChange:ze=>B(ze.target.value),className:"flex-1 bg-transparent outline-none text-sm text-slate-700 placeholder-slate-400"}),a.jsx("button",{type:"submit",className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center hover:bg-purple-600 transition-all flex-shrink-0",children:a.jsx(gP,{className:"w-4 h-4 text-white"})})]})}),a.jsxs("div",{className:"bg-gradient-to-br from-purple-200 to-purple-300 rounded-2xl p-4 shadow-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("button",{onClick:ie,className:"w-8 h-8 rounded-full bg-white/30 flex items-center justify-center hover:bg-white/50 transition-all",children:a.jsx(iE,{className:"w-4 h-4 text-slate-800"})}),a.jsxs("h3",{className:"text-sm font-bold text-slate-800",children:[Z.toDateString()===new Date().toDateString()?"Today, ":"",Z.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"})]}),a.jsx("button",{onClick:ue,className:"w-8 h-8 rounded-full bg-white/30 flex items-center justify-center hover:bg-white/50 transition-all",children:a.jsx(xo,{className:"w-4 h-4 text-slate-800"})})]}),a.jsx("div",{className:"grid grid-cols-7 gap-1.5",children:(()=>{const ze=["Su","Mo","Tu","We","Th","Fr","Sa"],It=[];for(let wt=-3;wt<=3;wt++){const ft=new Date(Z);ft.setDate(ft.getDate()+wt),It.push({label:ze[ft.getDay()],date:ft.getDate(),fullDate:ft,isToday:ft.toDateString()===new Date().toDateString()})}return It.map((wt,ft)=>{var oa,Js,En,Ln,ln,ca;const Os=wt.isToday,Kn=Z.toDateString()===wt.fullDate.toDateString();let Ye=0;const Pt=wt.fullDate;if(Os){const yr=(oa=x==null?void 0:x.nutritionData)!=null&&oa.totalCalories&&((Js=x==null?void 0:x.nutritionData)!=null&&Js.calorieGoal)?Math.min(x.nutritionData.totalCalories/x.nutritionData.calorieGoal*100,100):0,rr=(En=x==null?void 0:x.recentReports)==null?void 0:En.some(gl=>new Date(gl.createdAt).toDateString()===new Date().toDateString()),Bn=((ln=(Ln=x==null?void 0:x.wearableData)==null?void 0:Ln.todayMetrics)==null?void 0:ln.activeMinutes)||0;Ye=Math.round(yr*.5+(rr?25:0)+(Bn>0?25:0))}else Ye=((ca=x==null?void 0:x.recentReports)==null?void 0:ca.some(rr=>new Date(rr.createdAt).toDateString()===Pt.toDateString()))?100:0;return a.jsxs("div",{className:"text-center cursor-pointer group",onClick:()=>te(Pt),children:[a.jsx("div",{className:`text-xs font-medium mb-1.5 transition-colors ${Kn?"text-indigo-800 font-bold":"text-slate-700"}`,children:wt.label}),a.jsxs("div",{className:`w-10 h-10 mx-auto rounded-full flex items-center justify-center relative transition-all ${Kn?"bg-white shadow-lg scale-110 ring-2 ring-indigo-400":Os?"bg-white shadow-md":"bg-white/40 group-hover:bg-white/60"}`,children:[Os?a.jsx(qi,{className:"w-5 h-5 text-orange-500 relative z-10"}):Ye===100?a.jsx("div",{className:"w-7 h-7 rounded-full border-4 border-yellow-400"}):Ye>0?a.jsx("div",{className:"w-7 h-7 rounded-full border-4 border-yellow-400 border-t-transparent",style:{transform:`rotate(${Ye/100*360}deg)`,borderTopColor:"transparent"}}):a.jsx("div",{className:"w-7 h-7 rounded-full border-4 border-slate-300"}),Os&&Ye<100&&a.jsx("svg",{className:"absolute inset-0 w-full h-full -rotate-90",viewBox:"0 0 40 40",children:a.jsx("circle",{cx:"20",cy:"20",r:"18",fill:"none",stroke:"#fbbf24",strokeWidth:"3",strokeDasharray:`${Ye/100*113} 113`,strokeLinecap:"round"})})]}),Os&&a.jsx("div",{className:"text-xs font-medium text-slate-700 mt-1",children:wt.date})]},ft)})})()})]})]}),a.jsxs("div",{className:"pt-4 space-y-3 hidden md:block px-3 md:px-0",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-lg font-bold shadow-md",children:((fs=(ct=u==null?void 0:u.name)==null?void 0:ct[0])==null?void 0:fs.toUpperCase())||"U"}),a.jsxs("div",{children:[a.jsxs("h1",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[Ne(),", ",a.jsxs("span",{className:"text-slate-900",children:[((ys=u==null?void 0:u.name)==null?void 0:ys.split(" ")[0])||"there","!"]})]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600",children:[a.jsxs("span",{className:"font-semibold",children:[((As=x==null?void 0:x.nutritionData)==null?void 0:As.totalCalories)||0," cal"]}),a.jsx("span",{className:"text-slate-400",children:"."}),a.jsxs("span",{className:"font-semibold text-emerald-600",children:[((je=(zs=x==null?void 0:x.user)==null?void 0:zs.healthMetrics)==null?void 0:je.healthScore)||82,"% Healthy"]})]})]})]}),a.jsx("button",{className:"w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all",children:a.jsx(Eo,{className:"w-5 h-5 text-slate-700"})})]}),a.jsx("form",{onSubmit:be,className:"relative",children:a.jsxs("div",{className:"flex items-center gap-2 bg-white rounded-full px-4 py-2.5 shadow-md border-2 border-purple-200 hover:border-purple-300 transition-all",children:[a.jsx(bo,{className:"w-4 h-4 text-purple-500 flex-shrink-0"}),a.jsx("input",{type:"text",placeholder:"Ask coach",value:H,onChange:ze=>B(ze.target.value),className:"flex-1 bg-transparent outline-none text-sm text-slate-700 placeholder-slate-400"}),a.jsx("button",{type:"submit",className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center hover:bg-purple-600 transition-all flex-shrink-0",children:a.jsx(gP,{className:"w-4 h-4 text-white"})})]})}),a.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:[a.jsx("button",{className:"px-4 py-2 bg-white rounded-full text-xs font-medium text-slate-700 shadow-sm hover:shadow-md transition-all whitespace-nowrap border border-slate-200",children:"Book a health checkup"}),a.jsx("button",{className:"px-4 py-2 bg-white rounded-full text-xs font-medium text-slate-700 shadow-sm hover:shadow-md transition-all whitespace-nowrap border border-slate-200",children:"Analyze my vitals"}),a.jsx("button",{className:"px-4 py-2 bg-white rounded-full text-xs font-medium text-slate-700 shadow-sm hover:shadow-md transition-all whitespace-nowrap border border-slate-200",children:"Give me a health tip"})]}),a.jsxs("div",{className:"bg-gradient-to-br from-purple-200 to-purple-300 rounded-2xl p-4 shadow-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("button",{onClick:ie,className:"w-8 h-8 rounded-full bg-white/30 flex items-center justify-center hover:bg-white/50 transition-all",children:a.jsx(iE,{className:"w-4 h-4 text-slate-800"})}),a.jsxs("h3",{className:"text-sm font-bold text-slate-800",children:[Z.toDateString()===new Date().toDateString()?"Today, ":"",Z.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),a.jsx("button",{onClick:ue,className:"w-8 h-8 rounded-full bg-white/30 flex items-center justify-center hover:bg-white/50 transition-all",children:a.jsx(xo,{className:"w-4 h-4 text-slate-800"})})]}),a.jsx("div",{className:"grid grid-cols-7 gap-1.5",children:(()=>{const ze=["Su","Mo","Tu","We","Th","Fr","Sa"],It=[];for(let wt=-3;wt<=3;wt++){const ft=new Date(Z);ft.setDate(ft.getDate()+wt),It.push({label:ze[ft.getDay()],date:ft.getDate(),fullDate:ft,isToday:ft.toDateString()===new Date().toDateString()})}return It.map((wt,ft)=>{var oa,Js,En,Ln,ln;const Os=wt.isToday,Kn=Z.toDateString()===wt.fullDate.toDateString();let Ye=0;const Pt=wt.fullDate;if(Os){const ca=(oa=x==null?void 0:x.nutritionData)!=null&&oa.totalCalories&&((Js=x==null?void 0:x.nutritionData)!=null&&Js.calorieGoal)?Math.min(x.nutritionData.totalCalories/x.nutritionData.calorieGoal*100,100):0,yr=(En=x==null?void 0:x.recentReports)==null?void 0:En.some(Bn=>new Date(Bn.createdAt).toDateString()===new Date().toDateString()),rr=((ln=(Ln=x==null?void 0:x.wearableData)==null?void 0:Ln.todayMetrics)==null?void 0:ln.activeMinutes)||0;Ye=Math.round(ca*.5+(yr?25:0)+(rr>0?25:0))}else Ye=ft<6?Math.random()>.3?100:Math.random()*100:0;return a.jsxs("div",{className:"text-center cursor-pointer group",onClick:()=>te(Pt),children:[a.jsx("div",{className:`text-xs font-medium mb-1.5 transition-colors ${Kn?"text-indigo-800 font-bold":"text-slate-700"}`,children:wt.label}),a.jsxs("div",{className:`w-10 h-10 mx-auto rounded-full flex items-center justify-center relative transition-all ${Kn?"bg-white shadow-lg scale-110 ring-2 ring-indigo-400":Os?"bg-white shadow-md":"bg-white/40 group-hover:bg-white/60"}`,children:[Os?a.jsx(qi,{className:"w-5 h-5 text-orange-500 relative z-10"}):Ye===100?a.jsx("div",{className:"w-7 h-7 rounded-full border-4 border-yellow-400"}):a.jsx("div",{className:"w-7 h-7 rounded-full border-4 border-yellow-400 border-t-transparent",style:{transform:`rotate(${Ye/100*360}deg)`,borderTopColor:Ye>0?"transparent":"#facc15"}}),Os&&Ye<100&&a.jsx("svg",{className:"absolute inset-0 w-full h-full -rotate-90",viewBox:"0 0 40 40",children:a.jsx("circle",{cx:"20",cy:"20",r:"18",fill:"none",stroke:"#fbbf24",strokeWidth:"3",strokeDasharray:`${Ye/100*113} 113`,strokeLinecap:"round"})})]}),Os&&a.jsx("div",{className:"text-xs font-medium text-slate-700 mt-1",children:wt.date})]},ft)})})()})]})]}),a.jsx(TQ,{isOpen:ne,onClose:()=>ae(!1)}),a.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:gap-6 px-3 md:px-0",children:[a.jsxs(Rt,{to:"/nutrition",className:"card card-gradient p-4 sm:p-6 group relative overflow-hidden",children:[a.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"}),a.jsx("div",{className:"flex items-center justify-between mb-3 relative z-10",children:a.jsx("div",{className:"w-12 h-12 sm:w-14 sm:h-14 rounded-2xl bg-white/30 backdrop-blur-md flex items-center justify-center group-hover:rotate-12 transition-transform shadow-inner",children:a.jsx(qi,{className:"w-6 h-6 sm:w-7 sm:h-7 text-orange-600"})})}),a.jsx("h3",{className:"text-slate-700 text-[10px] sm:text-xs font-black mb-1 uppercase tracking-[0.15em] relative z-10",children:"Nutrition"}),a.jsxs("p",{className:"text-2xl sm:text-3xl font-black text-slate-900 mb-1 relative z-10",children:[(R==null?void 0:R.totalCalories)||0," ",a.jsx("span",{className:"text-base sm:text-lg opacity-60 font-medium",children:"kcal"})]}),a.jsx("p",{className:"text-[10px] sm:text-xs text-slate-600 font-bold relative z-10",children:R!=null&&R.calorieGoal?`${Math.round(R.totalCalories/R.calorieGoal*100)}% Goal`:"Track your meals"})]}),a.jsxs("button",{onClick:()=>ae(!0),className:"card p-4 sm:p-6 group relative overflow-hidden text-left",children:[a.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl -mr-10 -mt-10"}),a.jsx("div",{className:"flex items-center justify-between mb-3 relative z-10",children:a.jsx("div",{className:"w-12 h-12 sm:w-14 sm:h-14 rounded-2xl bg-indigo-50 flex items-center justify-center group-hover:rotate-12 transition-transform shadow-inner",children:a.jsx(Yd,{className:"w-6 h-6 sm:w-7 sm:h-7 text-indigo-500"})})}),a.jsx("h3",{className:"text-slate-500 text-[10px] sm:text-xs font-black mb-1 uppercase tracking-[0.15em] relative z-10",children:"Sleep"}),a.jsx("p",{className:"text-2xl sm:text-3xl font-black text-slate-800 mb-1 relative z-10",children:(()=>{const ze=JSON.parse(localStorage.getItem("sleep_history")||"[]"),It=Z.toDateString(),wt=ze.find(ft=>new Date(ft.date).toDateString()===It);return wt?`${wt.hours}h ${wt.minutes}m`:"0h 0m"})()}),a.jsx("p",{className:"text-[10px] sm:text-xs text-slate-400 font-bold relative z-10",children:(()=>{const ze=JSON.parse(localStorage.getItem("sleep_history")||"[]"),It=Z.toDateString(),wt=ze.find(ft=>new Date(ft.date).toDateString()===It);if(wt){const ft=wt.hours*60+wt.minutes;return`${Math.round(ft/480*100)}% Efficiency`}return"Track your sleep"})()})]}),a.jsxs(Rt,{to:"/wearables",className:"card p-4 sm:p-6 group relative overflow-hidden",children:[a.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-blue-500/5 rounded-full blur-2xl -mr-10 -mt-10"}),a.jsx("div",{className:"flex items-center justify-between mb-3 relative z-10",children:a.jsx("div",{className:"w-12 h-12 sm:w-14 sm:h-14 rounded-2xl bg-blue-50 flex items-center justify-center group-hover:rotate-12 transition-transform shadow-inner",children:a.jsx(ms,{className:"w-6 h-6 sm:w-7 sm:h-7 text-blue-500"})})}),a.jsx("h3",{className:"text-slate-500 text-[10px] sm:text-xs font-black mb-1 uppercase tracking-[0.15em] relative z-10",children:"Movement"}),a.jsxs("p",{className:"text-2xl sm:text-3xl font-black text-slate-800 mb-1 relative z-10",children:[((Ct=(Ze=x==null?void 0:x.wearableData)==null?void 0:Ze.todayMetrics)==null?void 0:Ct.activeMinutes)||0," ",a.jsx("span",{className:"text-base sm:text-lg opacity-60 font-medium",children:"mins"})]}),a.jsx("p",{className:"text-[10px] sm:text-xs text-slate-400 font-bold relative z-10",children:((ts=(zt=x==null?void 0:x.wearableData)==null?void 0:zt.todayMetrics)==null?void 0:ts.steps)>0?`${x.wearableData.todayMetrics.steps.toLocaleString()} steps`:"Start moving"})]}),a.jsxs(Rt,{to:"/challenge",className:"bg-white rounded-2xl border border-slate-200 shadow-sm p-4 sm:p-6 hover:shadow-lg transition-all cursor-pointer group",children:[a.jsx("div",{className:"flex items-center justify-between mb-3",children:a.jsx("div",{className:"w-12 h-12 sm:w-14 sm:h-14 rounded-2xl bg-emerald-50 flex items-center justify-center group-hover:scale-110 transition-transform",children:a.jsx(ZY,{className:"w-6 h-6 sm:w-7 sm:h-7 text-emerald-500"})})}),a.jsx("h3",{className:"text-slate-500 text-xs sm:text-sm font-medium mb-1 uppercase tracking-wide",children:"Mind"}),a.jsxs("p",{className:"text-2xl sm:text-3xl font-bold text-slate-800 mb-1",children:[(x==null?void 0:x.streakDays)||(u==null?void 0:u.challengeStreak)||0," ",a.jsx("span",{className:"text-base sm:text-lg text-slate-400",children:"days"})]}),a.jsx("p",{className:"text-xs sm:text-sm text-slate-400",children:"Daily Streak"})]})]}),a.jsxs(Rt,{to:"/glucose-log",className:"block bg-gradient-to-br from-[#e8f0fe] via-[#edf3ff] to-[#f0f4ff] rounded-3xl shadow-md p-5 sm:p-6 hover:shadow-xl transition-all group relative overflow-hidden border border-blue-100 mx-3 md:mx-0",children:[a.jsx("div",{className:"absolute bottom-2 right-2 opacity-[0.06] pointer-events-none",children:a.jsx(Dh,{className:"w-28 h-28 text-blue-500"})}),a.jsxs("div",{className:"relative z-10",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-11 h-11 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-md",children:a.jsx(Dh,{className:"w-5 h-5 text-white"})}),a.jsx("span",{className:"text-sm font-bold text-slate-700 uppercase tracking-wider",children:"Diabetes Management"})]}),a.jsx("span",{className:"px-3 py-1 bg-emerald-500 text-white rounded-full text-[11px] font-bold shadow-sm tracking-wide",children:"IN RANGE"})]}),a.jsxs("div",{className:"flex items-baseline gap-2 mb-1.5",children:[a.jsx("span",{className:"text-4xl sm:text-5xl font-extrabold text-slate-800",children:(()=>{const ze=JSON.parse(localStorage.getItem("glucoseData")||"[]");return ze.length>0?ze[0].value:108})()}),a.jsx("span",{className:"text-sm text-slate-400 font-semibold tracking-wide",children:"MG/DL"})]}),a.jsx("p",{className:"text-slate-500 text-sm mb-4 leading-relaxed",children:"Your fasting glucose is stable. Tap to log your next reading or view progress."}),a.jsxs("div",{className:"flex items-center gap-1.5 text-blue-600 font-bold text-sm group-hover:gap-3 transition-all",children:[a.jsx("span",{children:"OPEN CARE CENTER"}),a.jsx(xo,{className:"w-4 h-4"})]})]})]}),Q&&a.jsxs("div",{className:"space-y-6 mx-3 md:mx-0",children:[a.jsxs("div",{className:"bg-gradient-to-br from-[#4F46E5] via-[#6366F1] to-[#818CF8] rounded-[2.5rem] p-8 shadow-xl relative overflow-hidden group",children:[a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl pointer-events-none"}),a.jsx("div",{className:"absolute bottom-0 left-0 w-32 h-32 bg-indigo-400/20 rounded-full translate-y-1/2 -translate-x-1/2 blur-2xl pointer-events-none"}),a.jsx(bo,{className:"absolute top-8 right-12 w-16 h-16 text-white/10 group-hover:scale-110 transition-transform duration-500"}),a.jsxs("div",{className:"relative z-10",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[a.jsx(bo,{className:"w-5 h-5 text-white/80"}),a.jsx("span",{className:"text-xs font-bold text-white/80 uppercase tracking-[0.2em]",children:"AI Health Insights"})]}),a.jsxs("h2",{className:"text-2xl sm:text-3xl font-black text-white mb-4 tracking-tight leading-tight",children:[((ge=x.recentReports[0])==null?void 0:ge.reportType)||"Health Report"," Analysis",a.jsxs("span",{className:"block text-lg font-medium text-white/80 mt-1",children:["(",new Date((We=x.recentReports[0])==null?void 0:We.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),")"]})]}),a.jsxs("p",{className:"text-white/90 text-sm sm:text-base leading-relaxed mb-8 max-w-xl font-medium italic",children:['"',(ws=(rt=x.latestAnalysis)==null?void 0:rt.summary)==null?void 0:ws.split(".")[0],"... ",(Fe=(Cn=x.latestAnalysis)==null?void 0:Cn.summary)==null?void 0:Fe.split(".")[1],'."']}),a.jsxs(Rt,{to:`/reports/${(Je=x.recentReports[0])==null?void 0:Je._id}`,className:"inline-flex items-center gap-2 bg-white/20 backdrop-blur-md hover:bg-white/30 text-white px-8 py-4 rounded-2xl font-bold transition-all border border-white/30 shadow-lg group",children:["View Full Analysis",a.jsx(xo,{className:"w-5 h-5 group-hover:translate-x-1 transition-transform"})]})]})]}),a.jsxs("div",{className:"bg-gradient-to-br from-[#6366F1] to-[#4F46E5] rounded-[2.5rem] p-8 shadow-xl relative overflow-hidden text-white",children:[a.jsxs("div",{className:"flex justify-between items-start mb-2",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-xs font-bold text-white/70 uppercase tracking-widest",children:"Wellness Score"}),a.jsx("div",{className:"flex items-baseline gap-2 mt-2",children:a.jsxs("span",{className:"text-6xl font-black",children:[pe||88,"%"]})})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("p",{className:"text-lg font-bold text-white",children:"Excellent Condition"}),a.jsxs("p",{className:"text-xs text-white/60",children:["Updated ",new Date((De=x.recentReports[0])==null?void 0:De.createdAt).getHours(),"h ago"]})]})]}),a.jsx("div",{className:"h-40 w-full mt-6 -mx-4",children:a.jsx(jh,{width:"100%",height:"100%",children:a.jsxs(oE,{data:((it=x.healthScores)==null?void 0:it.slice(-7))||[],children:[a.jsx("defs",{children:a.jsxs("linearGradient",{id:"scoreGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[a.jsx("stop",{offset:"5%",stopColor:"#fff",stopOpacity:.3}),a.jsx("stop",{offset:"95%",stopColor:"#fff",stopOpacity:0})]})}),a.jsx(cE,{type:"monotone",dataKey:"score",stroke:"#fff",strokeWidth:4,fillOpacity:1,fill:"url(#scoreGradient)"})]})})}),a.jsxs("p",{className:"text-sm font-medium mt-4 text-white/90",children:["Your health score is ",pe>80?"trending up":"stable",". Keep maintaining your routine!"]})]}),a.jsxs("div",{className:"bg-white rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-slate-100",children:[a.jsxs("div",{className:"flex items-center justify-between mb-8",children:[a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Biomarker Trends"}),a.jsxs("button",{className:"text-indigo-600 text-xs font-black uppercase tracking-widest flex items-center gap-1 group",children:["View All",a.jsx(Ba,{className:"w-3 h-3 group-hover:translate-x-1 transition-transform"})]})]}),a.jsxs("div",{className:"space-y-6 sm:space-y-8",children:[a.jsxs("div",{className:"relative",children:[a.jsxs("button",{onClick:()=>D(!q),className:"w-full bg-[#F8FAFC] rounded-3xl p-4 sm:p-6 border border-slate-100 flex items-center justify-between hover:border-indigo-200 transition-all text-left",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-slate-900 font-bold block sm:inline",children:(le==null?void 0:le.name)||"Core Biomarker"}),le&&le.history.length>0&&a.jsxs("p",{className:"text-xs text-slate-500 font-semibold mt-1",children:["Current: ",(gs=le.history[le.history.length-1])==null?void 0:gs.value," ",le.unit]})]}),a.jsx(xo,{className:`w-5 h-5 text-slate-400 transition-transform ${q?"rotate-[-90deg]":"rotate-90"}`})]}),q&&a.jsx("div",{className:"absolute top-full left-0 right-0 mt-2 bg-white rounded-3xl shadow-2xl border border-slate-100 z-50 py-4 max-h-64 overflow-y-auto anima-fade-in",children:Ae.map(ze=>a.jsx("button",{onClick:()=>{X(ze),D(!1)},className:`w-full px-6 py-3 text-left hover:bg-slate-50 transition-colors ${k===ze?"text-indigo-600 font-bold":"text-slate-700"}`,children:he[ze].name},ze))})]}),a.jsx("div",{className:"h-64 sm:h-72 w-full relative -mx-2 sm:mx-0 pr-4 sm:pr-0",children:a.jsx(jh,{width:"100%",height:"100%",children:a.jsxs(oE,{data:(le==null?void 0:le.history)||[],margin:{top:20,right:30,left:0,bottom:20},children:[a.jsx(gg,{strokeDasharray:"3 3",vertical:!1,stroke:"#f1f5f9"}),a.jsx(xg,{dataKey:"date",axisLine:!1,tickLine:!1,tick:{fill:"#64748b",fontSize:10,fontWeight:700},dy:8,interval:"preserveStartEnd",minTickGap:20}),a.jsx(bg,{axisLine:!1,tickLine:!1,tick:{fill:"#64748b",fontSize:10,fontWeight:700},dx:-8,width:45,domain:["dataMin - 1","dataMax + 1"]}),a.jsx(ME,{content:({active:ze,payload:It})=>ze&&It&&It.length?a.jsxs("div",{className:"bg-white shadow-2xl rounded-2xl p-4 border border-indigo-100 ring-4 ring-indigo-50/50",children:[a.jsx("p",{className:"text-[10px] font-black text-indigo-600 uppercase mb-1 tracking-wider",children:It[0].payload.date}),a.jsxs("p",{className:"text-sm font-bold text-slate-900",children:[It[0].value," ",le==null?void 0:le.unit]})]}):null}),a.jsx(cE,{type:"monotone",dataKey:"value",stroke:"#4F46E5",strokeWidth:4,fill:"#4F46E5",fillOpacity:.08,dot:{r:5,fill:"#4F46E5",strokeWidth:3,stroke:"#fff"},activeDot:{r:7,fill:"#4F46E5",strokeWidth:3,stroke:"#fff",shadow:"0 0 15px rgba(79,70,229,0.4)"}})]})})}),le&&a.jsxs("div",{className:"bg-[#F0FDF4] rounded-3xl p-5 sm:p-6 border border-emerald-100 flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-bold text-slate-800 mb-1",children:le.name}),a.jsx("p",{className:"text-[10px] sm:text-xs text-slate-500 font-medium lowercase",children:"Target: Normal Range"}),a.jsxs("div",{className:"flex items-baseline gap-2 mt-2 sm:mt-4",children:[a.jsx("span",{className:"text-3xl sm:text-4xl font-black text-emerald-600",children:(Gt=le.history[le.history.length-1])==null?void 0:Gt.value}),a.jsx("span",{className:"text-xs sm:text-sm font-bold text-emerald-600/70",children:le.unit}),le.history.length>1&&a.jsx(Qn,{className:`w-5 h-5 text-emerald-500 ${le.history[le.history.length-1].value<le.history[le.history.length-2].value?"transform rotate-180":""}`})]})]}),a.jsx("div",{className:"bg-white px-3 sm:px-4 py-2 rounded-full text-[10px] sm:text-[11px] font-black text-emerald-600 uppercase shadow-sm border border-emerald-50",children:"Stable"})]})]})]}),a.jsxs("div",{className:"bg-white rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-slate-100",children:[a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight mb-6 sm:mb-8 uppercase",children:"Metrics Overview"}),a.jsxs("div",{className:"grid grid-cols-3 gap-3 sm:gap-4 pb-2 sm:pb-0",children:[a.jsxs("div",{className:"bg-[#F0FDF4] rounded-3xl p-4 sm:p-6 border border-emerald-100 text-center group hover:scale-105 transition-transform shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-2xl flex items-center justify-center mx-auto mb-3 sm:mb-4 shadow-sm border border-emerald-50",children:a.jsx("span",{className:"text-xl sm:text-2xl font-black text-emerald-600",children:Object.values(((Ss=x.latestAnalysis)==null?void 0:Ss.metrics)||{}).filter(ze=>{var It;return ze.status==="normal"||((It=ze.status)==null?void 0:It.toLowerCase())==="normal"}).length||4})}),a.jsx("span",{className:"text-[9px] sm:text-[10px] font-black text-emerald-600 uppercase tracking-widest block",children:"Good"})]}),a.jsxs("div",{className:"bg-[#FFFBEB] rounded-3xl p-4 sm:p-6 border border-amber-100 text-center group hover:scale-105 transition-transform shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-2xl flex items-center justify-center mx-auto mb-3 sm:mb-4 shadow-sm border border-amber-50",children:a.jsx("span",{className:"text-xl sm:text-2xl font-black text-amber-600",children:Object.values(((pn=x.latestAnalysis)==null?void 0:pn.metrics)||{}).filter(ze=>{var It;return ze.status==="moderate"||ze.status==="warning"||((It=ze.status)==null?void 0:It.toLowerCase().includes("borderline"))}).length||2})}),a.jsx("span",{className:"text-[9px] sm:text-[10px] font-black text-amber-600 uppercase tracking-widest block",children:"Moderate"})]}),a.jsxs("div",{className:"bg-[#FEF2F2] rounded-3xl p-4 sm:p-6 border border-red-100 text-center group hover:scale-105 transition-transform shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-2xl flex items-center justify-center mx-auto mb-3 sm:mb-4 shadow-sm border border-red-50",children:a.jsx("span",{className:"text-xl sm:text-2xl font-black text-red-600",children:Object.values(((Zn=x.latestAnalysis)==null?void 0:Zn.metrics)||{}).filter(ze=>{var It;return["low","high","critical"].includes((It=ze.status)==null?void 0:It.toLowerCase())}).length||2})}),a.jsx("span",{className:"text-[9px] sm:text-[10px] font-black text-red-600 uppercase tracking-widest block",children:"Issues"})]})]})]}),a.jsxs("div",{className:"bg-[#FFF1F2] rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-red-100",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6 sm:mb-8",children:[a.jsx("div",{className:"bg-[#FE2C55] p-2 rounded-xl",children:a.jsx(hn,{className:"w-5 h-5 text-white"})}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Critical Deficiencies"})]}),a.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[(((mn=(tn=x.latestAnalysis)==null?void 0:tn.deficiencies)==null?void 0:mn.length)>0?x.latestAnalysis.deficiencies:[{name:"Vitamin D Deficiency",severity:"High"},{name:"Iron Insufficiency",severity:"Moderate"}]).map((ze,It)=>{var wt,ft;return a.jsxs(Rt,{to:`/reports/${(wt=x.recentReports[0])==null?void 0:wt._id}`,className:"flex items-center justify-between bg-white rounded-2xl sm:rounded-3xl p-4 sm:p-6 border border-red-100/50 hover:border-red-200 transition-all group shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-3 sm:gap-4 overflow-hidden",children:[a.jsx("div",{className:`w-8 h-8 sm:w-10 sm:h-10 rounded-xl sm:rounded-2xl flex-shrink-0 flex items-center justify-center ${((ft=ze.severity)==null?void 0:ft.toLowerCase())==="high"?"bg-[#FE2C55]":"bg-orange-500"}`,children:a.jsx(lc,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),a.jsxs("div",{className:"min-w-0",children:[a.jsx("h4",{className:"font-extrabold text-slate-800 group-hover:text-[#FE2C55] transition-colors text-sm sm:text-base truncate",children:ze.name}),a.jsxs("p",{className:"text-[9px] sm:text-[10px] font-black text-slate-400 uppercase tracking-widest mt-0.5 sm:mt-1",children:[ze.severity||"High"," Priority"]})]})]}),a.jsx(xo,{className:"w-4 h-4 sm:w-5 h-5 text-slate-300 group-hover:text-[#FE2C55] transition-all flex-shrink-0"})]},It)}),a.jsxs(Rt,{to:"/nutrition",className:"w-full mt-2 sm:mt-4 bg-[#FE2C55] hover:bg-[#E5264D] text-white font-black text-[11px] sm:text-sm uppercase tracking-widest py-4 sm:py-5 rounded-2xl sm:rounded-3xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 group",children:["View Personalized Diet Plan",a.jsx(Ba,{className:"w-4 h-4 group-hover:translate-x-1 transition-transform"})]})]})]})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6 px-3 md:px-0",children:[a.jsxs("div",{className:"bg-white rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-slate-100",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h3",{className:"text-lg font-black text-[#0F172A] uppercase tracking-tight",children:"Recent Tests"}),a.jsx(Rt,{to:"/reports",className:"text-[10px] font-black text-slate-400 uppercase tracking-widest hover:text-indigo-600 transition-colors",children:"View All"})]}),a.jsx("div",{className:"space-y-4",children:(((hs=x==null?void 0:x.recentReports)==null?void 0:hs.length)>0?x.recentReports.slice(0,3):[{_id:"1",reportType:"Complete Blood Count",createdAt:"2026-02-12",status:"completed"},{_id:"2",reportType:"Lipid Profile",createdAt:"2026-01-28",status:"pending"},{_id:"3",reportType:"Thyroid Panel",createdAt:"2025-12-15",status:"completed"}]).map((ze,It)=>a.jsxs(Rt,{to:ze._id?`/reports/${ze._id}`:"#",className:"flex items-center justify-between p-4 bg-slate-50 hover:bg-white border border-transparent hover:border-slate-100 rounded-3xl transition-all group shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-2xl bg-white flex items-center justify-center shadow-sm text-slate-400 group-hover:text-indigo-600 transition-colors",children:a.jsx(un,{className:"w-6 h-6"})}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-bold text-slate-800 group-hover:text-indigo-600 transition-colors",children:ze.reportType}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mt-0.5",children:new Date(ze.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})})]})]}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("span",{className:`text-[10px] font-black uppercase tracking-widest ${ze.status==="completed"?"text-emerald-500":"text-amber-500"}`,children:ze.status==="completed"?"Analyzed - Healthy":"Action Required"}),a.jsx(xo,{className:"w-4 h-4 text-slate-300 group-hover:text-indigo-600 transition-colors"})]})]},ze._id||It))})]}),a.jsxs("div",{className:"bg-white rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-slate-100",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center",children:a.jsx(ms,{className:"w-5 h-5 text-indigo-600"})}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] uppercase tracking-tight",children:"Personalized Recommendations"})]}),a.jsx("div",{className:"space-y-4",children:[{name:"Vitamin B12 Panel",reason:"Low intake detected in food log",type:"Test"},{name:"Omega-3 (1000mg)",reason:"To support heart and brain health",type:"Supplement"},{name:"HbA1c Test",reason:"Important for diabetes monitoring",type:"Test"},{name:"Vitamin D3 (2000 IU)",reason:"Low sun exposure detected",type:"Supplement"}].map((ze,It)=>a.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-50 rounded-3xl group cursor-pointer hover:bg-white border border-transparent hover:border-slate-100 transition-all shadow-sm",children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("h4",{className:"font-bold text-slate-800",children:ze.name}),a.jsx("span",{className:`text-[8px] font-black uppercase tracking-tighter px-1.5 py-0.5 rounded-md ${ze.type==="Test"?"bg-indigo-100 text-indigo-600":"bg-emerald-100 text-emerald-600"}`,children:ze.type})]}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:ze.reason})]}),a.jsx("button",{className:"w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-indigo-600 hover:bg-indigo-600 hover:text-white transition-all ring-1 ring-slate-100",children:a.jsx(vi,{className:"w-5 h-5"})})]},It))})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center",children:a.jsx(lE,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"30 Days Challenge"}),a.jsx("p",{className:"text-slate-600 text-sm",children:"Build healthy habits, one day at a time"})]})]}),a.jsxs(Rt,{to:"/challenge",className:"block bg-gradient-to-br from-amber-400 via-orange-500 to-red-500 rounded-3xl p-5 sm:p-8 text-white hover:shadow-2xl transition-all hover:-translate-y-1 group",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4 sm:mb-6",children:[a.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-1",children:[a.jsx("div",{className:"w-12 h-12 sm:w-16 sm:h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center flex-shrink-0",children:a.jsx(lE,{className:"w-6 h-6 sm:w-8 sm:h-8 text-white"})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:"text-base sm:text-2xl font-bold mb-0.5 sm:mb-1 leading-tight",children:"30 Days Health Challenge"}),a.jsx("p",{className:"text-xs sm:text-base text-amber-100 leading-tight",children:"Complete daily tasks to build lasting habits"})]})]}),a.jsx(xo,{className:"w-6 h-6 sm:w-8 sm:h-8 group-hover:translate-x-2 transition-transform flex-shrink-0"})]}),a.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4 sm:mb-6",children:[a.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-xl p-3 sm:p-4 text-center",children:[a.jsx("div",{className:"text-2xl sm:text-3xl mb-1 sm:mb-2",children:""}),a.jsx("p",{className:"text-xs sm:text-sm font-medium",children:"Drink Water"})]}),a.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-xl p-3 sm:p-4 text-center",children:[a.jsx("div",{className:"text-2xl sm:text-3xl mb-1 sm:mb-2",children:""}),a.jsx("p",{className:"text-xs sm:text-sm font-medium",children:"Workout/Yoga"})]}),a.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-xl p-3 sm:p-4 text-center",children:[a.jsx("div",{className:"text-2xl sm:text-3xl mb-1 sm:mb-2",children:""}),a.jsx("p",{className:"text-xs sm:text-sm font-medium",children:"Eat Fruits"})]}),a.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-xl p-3 sm:p-4 text-center",children:[a.jsx("div",{className:"text-2xl sm:text-3xl mb-1 sm:mb-2",children:""}),a.jsx("p",{className:"text-xs sm:text-sm font-medium",children:"Sleep Well"})]})]}),a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-wrap",children:[a.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[a.jsx(qi,{className:"w-4 h-4 sm:w-5 sm:h-5"}),a.jsx("span",{className:"text-xs sm:text-base font-bold",children:"Start Streak"})]}),a.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[a.jsx(UE,{className:"w-4 h-4 sm:w-5 sm:h-5"}),a.jsx("span",{className:"text-xs sm:text-base font-bold",children:"Earn Badges"})]})]}),a.jsxs("div",{className:"px-3 py-1.5 sm:px-4 sm:py-2 bg-white/20 backdrop-blur-sm rounded-full text-xs sm:text-base font-bold whitespace-nowrap flex items-center gap-1",children:["Start Challenge",a.jsx(Ba,{className:"w-3 h-3 sm:w-4 sm:h-4"})]})]})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center",children:a.jsx(bo,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"Did You Know?"}),a.jsx("p",{className:"text-slate-600 text-sm",children:"Surprising nutrition facts about everyday foods"})]})]}),a.jsxs("div",{className:"md:grid md:grid-cols-2 lg:grid-cols-4 md:gap-4 flex md:flex-none overflow-x-auto gap-4 pb-4 md:pb-0 snap-x snap-mandatory scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0",children:[a.jsxs("div",{className:"min-w-[280px] md:min-w-0 snap-center bg-white rounded-2xl border-2 border-orange-200 p-5 hover:shadow-lg transition-all hover:-translate-y-1",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"text-4xl",children:""}),a.jsx("div",{className:"w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center",children:a.jsx(Ji,{className:"w-5 h-5 text-green-600"})})]}),a.jsx("h3",{className:"font-bold text-slate-800 mb-2",children:"Guava Power"}),a.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["One guava contains ",a.jsx("span",{className:"font-bold text-green-600",children:"3g of protein"})," - more than most fruits!"]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[a.jsx(vr,{className:"w-3 h-3"}),a.jsx("span",{children:"Great for muscle recovery"})]})]}),a.jsxs("div",{className:"min-w-[280px] md:min-w-0 snap-center bg-white rounded-2xl border-2 border-blue-200 p-5 hover:shadow-lg transition-all hover:-translate-y-1",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"text-4xl",children:""}),a.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center",children:a.jsx(Dh,{className:"w-5 h-5 text-blue-600"})})]}),a.jsx("h3",{className:"font-bold text-slate-800 mb-2",children:"Spinach Iron"}),a.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["Spinach has ",a.jsx("span",{className:"font-bold text-blue-600",children:"2.7mg iron"})," per 100g - boosts blood health naturally"]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[a.jsx(zn,{className:"w-3 h-3"}),a.jsx("span",{children:"Prevents anemia"})]})]}),a.jsxs("div",{className:"min-w-[280px] md:min-w-0 snap-center bg-white rounded-2xl border-2 border-purple-200 p-5 hover:shadow-lg transition-all hover:-translate-y-1",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"text-4xl",children:""}),a.jsx("div",{className:"w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center",children:a.jsx(zr,{className:"w-5 h-5 text-purple-600"})})]}),a.jsx("h3",{className:"font-bold text-slate-800 mb-2",children:"Almond Energy"}),a.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["Just ",a.jsx("span",{className:"font-bold text-purple-600",children:"23 almonds"})," provide 6g protein and healthy fats for brain power"]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[a.jsx(PE,{className:"w-3 h-3"}),a.jsx("span",{children:"Boosts brain function"})]})]}),a.jsxs("div",{className:"min-w-[280px] md:min-w-0 snap-center bg-white rounded-2xl border-2 border-amber-200 p-5 hover:shadow-lg transition-all hover:-translate-y-1",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"text-4xl",children:""}),a.jsx("div",{className:"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center",children:a.jsx(f2,{className:"w-5 h-5 text-amber-600"})})]}),a.jsx("h3",{className:"font-bold text-slate-800 mb-2",children:"Egg Vitamin D"}),a.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["One egg yolk has ",a.jsx("span",{className:"font-bold text-amber-600",children:"40 IU Vitamin D"})," - supports bone health"]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[a.jsx(VE,{className:"w-3 h-3"}),a.jsx("span",{children:"Strengthens immunity"})]})]})]})]}),a.jsx("div",{className:"bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-3xl p-8 text-white",children:a.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-6",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-2xl font-bold mb-2",children:"Need Help Getting Started?"}),a.jsx("p",{className:"text-cyan-50",children:"Our AI assistant is here to guide you through your health journey"})]}),a.jsxs(Rt,{to:"/ai-chat",className:"px-8 py-4 bg-white text-cyan-600 rounded-xl font-bold hover:shadow-2xl transition-all flex items-center gap-2 group",children:[a.jsx(Mh,{className:"w-5 h-5"}),"Chat with AI",a.jsx(Ba,{className:"w-5 h-5 group-hover:translate-x-1 transition-transform"})]})]})})]})]})}function CQ(){var G,F;const{user:u}=ia(),[f,x]=j.useState(null),[_,E]=j.useState(!0);if(j.useEffect(()=>{(async()=>{try{const{data:X}=await sr.getDashboard();x(X)}catch(X){console.error("Failed to fetch dashboard:",X)}finally{E(!1)}})()},[]),_)return a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-500",children:"Loading dashboard..."})]})});const{doctor:y,stats:R,todaySchedule:P,upcomingSchedule:U}=f||{};return(y==null?void 0:y.approvalStatus)==="pending"?a.jsx("div",{className:"max-w-lg mx-auto mt-20",children:a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-8 text-center shadow-sm",children:[a.jsx("div",{className:"w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4",children:a.jsx(Yr,{className:"w-8 h-8 text-amber-500"})}),a.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-2",children:"Approval Pending"}),a.jsx("p",{className:"text-slate-500 mb-4",children:"Your profile is under review. You'll be notified once approved."}),a.jsxs("span",{className:"inline-flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-700 rounded-xl text-sm font-medium",children:[a.jsx(hn,{className:"w-4 h-4"})," Pending Review"]})]})}):(y==null?void 0:y.approvalStatus)==="rejected"?a.jsx("div",{className:"max-w-lg mx-auto mt-20",children:a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-8 text-center shadow-sm",children:[a.jsx("div",{className:"w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4",children:a.jsx(g2,{className:"w-8 h-8 text-red-500"})}),a.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-2",children:"Application Rejected"}),a.jsx("p",{className:"text-slate-500",children:"Please contact support for more information."})]})}):a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-2xl font-bold text-slate-800",children:["Welcome, Dr. ",(G=y==null?void 0:y.name)==null?void 0:G.split(" ")[0],"! "]}),a.jsx("p",{className:"text-slate-500 mt-1",children:y==null?void 0:y.specialization})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs(Rt,{to:"/doctor/availability",className:"flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-medium transition-all",children:[a.jsx(Kd,{className:"w-4 h-4"})," Manage Slots"]}),y!=null&&y.isListed?a.jsxs("span",{className:"px-3 py-2 bg-green-100 text-green-700 rounded-xl text-sm font-medium flex items-center gap-1",children:[a.jsx(Hs,{className:"w-4 h-4"})," Listed"]}):a.jsxs("span",{className:"px-3 py-2 bg-amber-100 text-amber-700 rounded-xl text-sm font-medium flex items-center gap-1",children:[a.jsx(hn,{className:"w-4 h-4"})," Not Listed"]})]})]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center mb-3",children:a.jsx(Pn,{className:"w-5 h-5 text-blue-600"})}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:(R==null?void 0:R.todayAppointments)||0}),a.jsx("p",{className:"text-sm text-slate-500",children:"Today"})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center mb-3",children:a.jsx(Qn,{className:"w-5 h-5 text-green-600"})}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:(R==null?void 0:R.upcomingAppointments)||0}),a.jsx("p",{className:"text-sm text-slate-500",children:"Upcoming"})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center mb-3",children:a.jsx(Wd,{className:"w-5 h-5 text-purple-600"})}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:(R==null?void 0:R.totalPatients)||0}),a.jsx("p",{className:"text-sm text-slate-500",children:"Patients"})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center mb-3",children:a.jsx(wo,{className:"w-5 h-5 text-amber-600"})}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:((F=y==null?void 0:y.rating)==null?void 0:F.toFixed(1))||"0.0"}),a.jsx("p",{className:"text-sm text-slate-500",children:"Rating"})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-6 shadow-sm",children:[a.jsx("div",{className:"flex items-center justify-between mb-4",children:a.jsxs("h2",{className:"text-lg font-semibold text-slate-800 flex items-center gap-2",children:[a.jsx(ms,{className:"w-5 h-5 text-cyan-500"})," Today's Schedule"]})}),(P==null?void 0:P.length)>0?a.jsx("div",{className:"space-y-3",children:P.map(k=>{var X,q,D,H,B;return a.jsxs("div",{className:"p-4 bg-slate-50 rounded-xl flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-cyan-100 flex items-center justify-center text-cyan-600 font-bold",children:((D=(q=(X=k.patient)==null?void 0:X.name)==null?void 0:q[0])==null?void 0:D.toUpperCase())||"P"}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium text-slate-800",children:(H=k.patient)==null?void 0:H.name}),a.jsx("p",{className:"text-sm text-slate-500",children:k.timeSlot})]})]}),a.jsxs(Rt,{to:`/patient/${(B=k.patient)==null?void 0:B._id}?appointmentId=${k._id}`,className:"px-4 py-2 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 transition-all text-sm flex items-center gap-1",children:[a.jsx(hl,{className:"w-4 h-4"})," View"]})]},k._id)})}):a.jsxs("div",{className:"text-center py-8 text-slate-500",children:[a.jsx(Pn,{className:"w-10 h-10 mx-auto mb-2 text-slate-300"}),a.jsx("p",{children:"No appointments today"})]})]}),(U==null?void 0:U.length)>0&&a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-6 shadow-sm",children:[a.jsxs("h2",{className:"text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2",children:[a.jsx(Yr,{className:"w-5 h-5 text-green-500"})," Upcoming Appointments"]}),a.jsx("div",{className:"space-y-3",children:U.slice(0,5).map(k=>{var X,q,D,H;return a.jsx("div",{className:"p-4 bg-slate-50 rounded-xl flex items-center justify-between",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center text-green-600 font-bold",children:((D=(q=(X=k.patient)==null?void 0:X.name)==null?void 0:q[0])==null?void 0:D.toUpperCase())||"P"}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium text-slate-800",children:(H=k.patient)==null?void 0:H.name}),a.jsxs("p",{className:"text-sm text-slate-500",children:[new Date(k.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),"  ",k.timeSlot]})]})]})},k._id)})})]})]})}function fl(u,f,x,_){function E(y){return y instanceof x?y:new x(function(R){R(y)})}return new(x||(x=Promise))(function(y,R){function P(F){try{G(_.next(F))}catch(k){R(k)}}function U(F){try{G(_.throw(F))}catch(k){R(k)}}function G(F){F.done?y(F.value):E(F.value).then(P,U)}G((_=_.apply(u,f||[])).next())})}const IQ=new Map([["1km","application/vnd.1000minds.decision-model+xml"],["3dml","text/vnd.in3d.3dml"],["3ds","image/x-3ds"],["3g2","video/3gpp2"],["3gp","video/3gp"],["3gpp","video/3gpp"],["3mf","model/3mf"],["7z","application/x-7z-compressed"],["7zip","application/x-7z-compressed"],["123","application/vnd.lotus-1-2-3"],["aab","application/x-authorware-bin"],["aac","audio/x-acc"],["aam","application/x-authorware-map"],["aas","application/x-authorware-seg"],["abw","application/x-abiword"],["ac","application/vnd.nokia.n-gage.ac+xml"],["ac3","audio/ac3"],["acc","application/vnd.americandynamics.acc"],["ace","application/x-ace-compressed"],["acu","application/vnd.acucobol"],["acutc","application/vnd.acucorp"],["adp","audio/adpcm"],["aep","application/vnd.audiograph"],["afm","application/x-font-type1"],["afp","application/vnd.ibm.modcap"],["ahead","application/vnd.ahead.space"],["ai","application/pdf"],["aif","audio/x-aiff"],["aifc","audio/x-aiff"],["aiff","audio/x-aiff"],["air","application/vnd.adobe.air-application-installer-package+zip"],["ait","application/vnd.dvb.ait"],["ami","application/vnd.amiga.ami"],["amr","audio/amr"],["apk","application/vnd.android.package-archive"],["apng","image/apng"],["appcache","text/cache-manifest"],["application","application/x-ms-application"],["apr","application/vnd.lotus-approach"],["arc","application/x-freearc"],["arj","application/x-arj"],["asc","application/pgp-signature"],["asf","video/x-ms-asf"],["asm","text/x-asm"],["aso","application/vnd.accpac.simply.aso"],["asx","video/x-ms-asf"],["atc","application/vnd.acucorp"],["atom","application/atom+xml"],["atomcat","application/atomcat+xml"],["atomdeleted","application/atomdeleted+xml"],["atomsvc","application/atomsvc+xml"],["atx","application/vnd.antix.game-component"],["au","audio/x-au"],["avi","video/x-msvideo"],["avif","image/avif"],["aw","application/applixware"],["azf","application/vnd.airzip.filesecure.azf"],["azs","application/vnd.airzip.filesecure.azs"],["azv","image/vnd.airzip.accelerator.azv"],["azw","application/vnd.amazon.ebook"],["b16","image/vnd.pco.b16"],["bat","application/x-msdownload"],["bcpio","application/x-bcpio"],["bdf","application/x-font-bdf"],["bdm","application/vnd.syncml.dm+wbxml"],["bdoc","application/x-bdoc"],["bed","application/vnd.realvnc.bed"],["bh2","application/vnd.fujitsu.oasysprs"],["bin","application/octet-stream"],["blb","application/x-blorb"],["blorb","application/x-blorb"],["bmi","application/vnd.bmi"],["bmml","application/vnd.balsamiq.bmml+xml"],["bmp","image/bmp"],["book","application/vnd.framemaker"],["box","application/vnd.previewsystems.box"],["boz","application/x-bzip2"],["bpk","application/octet-stream"],["bpmn","application/octet-stream"],["bsp","model/vnd.valve.source.compiled-map"],["btif","image/prs.btif"],["buffer","application/octet-stream"],["bz","application/x-bzip"],["bz2","application/x-bzip2"],["c","text/x-c"],["c4d","application/vnd.clonk.c4group"],["c4f","application/vnd.clonk.c4group"],["c4g","application/vnd.clonk.c4group"],["c4p","application/vnd.clonk.c4group"],["c4u","application/vnd.clonk.c4group"],["c11amc","application/vnd.cluetrust.cartomobile-config"],["c11amz","application/vnd.cluetrust.cartomobile-config-pkg"],["cab","application/vnd.ms-cab-compressed"],["caf","audio/x-caf"],["cap","application/vnd.tcpdump.pcap"],["car","application/vnd.curl.car"],["cat","application/vnd.ms-pki.seccat"],["cb7","application/x-cbr"],["cba","application/x-cbr"],["cbr","application/x-cbr"],["cbt","application/x-cbr"],["cbz","application/x-cbr"],["cc","text/x-c"],["cco","application/x-cocoa"],["cct","application/x-director"],["ccxml","application/ccxml+xml"],["cdbcmsg","application/vnd.contact.cmsg"],["cda","application/x-cdf"],["cdf","application/x-netcdf"],["cdfx","application/cdfx+xml"],["cdkey","application/vnd.mediastation.cdkey"],["cdmia","application/cdmi-capability"],["cdmic","application/cdmi-container"],["cdmid","application/cdmi-domain"],["cdmio","application/cdmi-object"],["cdmiq","application/cdmi-queue"],["cdr","application/cdr"],["cdx","chemical/x-cdx"],["cdxml","application/vnd.chemdraw+xml"],["cdy","application/vnd.cinderella"],["cer","application/pkix-cert"],["cfs","application/x-cfs-compressed"],["cgm","image/cgm"],["chat","application/x-chat"],["chm","application/vnd.ms-htmlhelp"],["chrt","application/vnd.kde.kchart"],["cif","chemical/x-cif"],["cii","application/vnd.anser-web-certificate-issue-initiation"],["cil","application/vnd.ms-artgalry"],["cjs","application/node"],["cla","application/vnd.claymore"],["class","application/octet-stream"],["clkk","application/vnd.crick.clicker.keyboard"],["clkp","application/vnd.crick.clicker.palette"],["clkt","application/vnd.crick.clicker.template"],["clkw","application/vnd.crick.clicker.wordbank"],["clkx","application/vnd.crick.clicker"],["clp","application/x-msclip"],["cmc","application/vnd.cosmocaller"],["cmdf","chemical/x-cmdf"],["cml","chemical/x-cml"],["cmp","application/vnd.yellowriver-custom-menu"],["cmx","image/x-cmx"],["cod","application/vnd.rim.cod"],["coffee","text/coffeescript"],["com","application/x-msdownload"],["conf","text/plain"],["cpio","application/x-cpio"],["cpp","text/x-c"],["cpt","application/mac-compactpro"],["crd","application/x-mscardfile"],["crl","application/pkix-crl"],["crt","application/x-x509-ca-cert"],["crx","application/x-chrome-extension"],["cryptonote","application/vnd.rig.cryptonote"],["csh","application/x-csh"],["csl","application/vnd.citationstyles.style+xml"],["csml","chemical/x-csml"],["csp","application/vnd.commonspace"],["csr","application/octet-stream"],["css","text/css"],["cst","application/x-director"],["csv","text/csv"],["cu","application/cu-seeme"],["curl","text/vnd.curl"],["cww","application/prs.cww"],["cxt","application/x-director"],["cxx","text/x-c"],["dae","model/vnd.collada+xml"],["daf","application/vnd.mobius.daf"],["dart","application/vnd.dart"],["dataless","application/vnd.fdsn.seed"],["davmount","application/davmount+xml"],["dbf","application/vnd.dbf"],["dbk","application/docbook+xml"],["dcr","application/x-director"],["dcurl","text/vnd.curl.dcurl"],["dd2","application/vnd.oma.dd2+xml"],["ddd","application/vnd.fujixerox.ddd"],["ddf","application/vnd.syncml.dmddf+xml"],["dds","image/vnd.ms-dds"],["deb","application/x-debian-package"],["def","text/plain"],["deploy","application/octet-stream"],["der","application/x-x509-ca-cert"],["dfac","application/vnd.dreamfactory"],["dgc","application/x-dgc-compressed"],["dic","text/x-c"],["dir","application/x-director"],["dis","application/vnd.mobius.dis"],["disposition-notification","message/disposition-notification"],["dist","application/octet-stream"],["distz","application/octet-stream"],["djv","image/vnd.djvu"],["djvu","image/vnd.djvu"],["dll","application/octet-stream"],["dmg","application/x-apple-diskimage"],["dmn","application/octet-stream"],["dmp","application/vnd.tcpdump.pcap"],["dms","application/octet-stream"],["dna","application/vnd.dna"],["doc","application/msword"],["docm","application/vnd.ms-word.template.macroEnabled.12"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["dot","application/msword"],["dotm","application/vnd.ms-word.template.macroEnabled.12"],["dotx","application/vnd.openxmlformats-officedocument.wordprocessingml.template"],["dp","application/vnd.osgi.dp"],["dpg","application/vnd.dpgraph"],["dra","audio/vnd.dra"],["drle","image/dicom-rle"],["dsc","text/prs.lines.tag"],["dssc","application/dssc+der"],["dtb","application/x-dtbook+xml"],["dtd","application/xml-dtd"],["dts","audio/vnd.dts"],["dtshd","audio/vnd.dts.hd"],["dump","application/octet-stream"],["dvb","video/vnd.dvb.file"],["dvi","application/x-dvi"],["dwd","application/atsc-dwd+xml"],["dwf","model/vnd.dwf"],["dwg","image/vnd.dwg"],["dxf","image/vnd.dxf"],["dxp","application/vnd.spotfire.dxp"],["dxr","application/x-director"],["ear","application/java-archive"],["ecelp4800","audio/vnd.nuera.ecelp4800"],["ecelp7470","audio/vnd.nuera.ecelp7470"],["ecelp9600","audio/vnd.nuera.ecelp9600"],["ecma","application/ecmascript"],["edm","application/vnd.novadigm.edm"],["edx","application/vnd.novadigm.edx"],["efif","application/vnd.picsel"],["ei6","application/vnd.pg.osasli"],["elc","application/octet-stream"],["emf","image/emf"],["eml","message/rfc822"],["emma","application/emma+xml"],["emotionml","application/emotionml+xml"],["emz","application/x-msmetafile"],["eol","audio/vnd.digital-winds"],["eot","application/vnd.ms-fontobject"],["eps","application/postscript"],["epub","application/epub+zip"],["es","application/ecmascript"],["es3","application/vnd.eszigno3+xml"],["esa","application/vnd.osgi.subsystem"],["esf","application/vnd.epson.esf"],["et3","application/vnd.eszigno3+xml"],["etx","text/x-setext"],["eva","application/x-eva"],["evy","application/x-envoy"],["exe","application/octet-stream"],["exi","application/exi"],["exp","application/express"],["exr","image/aces"],["ext","application/vnd.novadigm.ext"],["ez","application/andrew-inset"],["ez2","application/vnd.ezpix-album"],["ez3","application/vnd.ezpix-package"],["f","text/x-fortran"],["f4v","video/mp4"],["f77","text/x-fortran"],["f90","text/x-fortran"],["fbs","image/vnd.fastbidsheet"],["fcdt","application/vnd.adobe.formscentral.fcdt"],["fcs","application/vnd.isac.fcs"],["fdf","application/vnd.fdf"],["fdt","application/fdt+xml"],["fe_launch","application/vnd.denovo.fcselayout-link"],["fg5","application/vnd.fujitsu.oasysgp"],["fgd","application/x-director"],["fh","image/x-freehand"],["fh4","image/x-freehand"],["fh5","image/x-freehand"],["fh7","image/x-freehand"],["fhc","image/x-freehand"],["fig","application/x-xfig"],["fits","image/fits"],["flac","audio/x-flac"],["fli","video/x-fli"],["flo","application/vnd.micrografx.flo"],["flv","video/x-flv"],["flw","application/vnd.kde.kivio"],["flx","text/vnd.fmi.flexstor"],["fly","text/vnd.fly"],["fm","application/vnd.framemaker"],["fnc","application/vnd.frogans.fnc"],["fo","application/vnd.software602.filler.form+xml"],["for","text/x-fortran"],["fpx","image/vnd.fpx"],["frame","application/vnd.framemaker"],["fsc","application/vnd.fsc.weblaunch"],["fst","image/vnd.fst"],["ftc","application/vnd.fluxtime.clip"],["fti","application/vnd.anser-web-funds-transfer-initiation"],["fvt","video/vnd.fvt"],["fxp","application/vnd.adobe.fxp"],["fxpl","application/vnd.adobe.fxp"],["fzs","application/vnd.fuzzysheet"],["g2w","application/vnd.geoplan"],["g3","image/g3fax"],["g3w","application/vnd.geospace"],["gac","application/vnd.groove-account"],["gam","application/x-tads"],["gbr","application/rpki-ghostbusters"],["gca","application/x-gca-compressed"],["gdl","model/vnd.gdl"],["gdoc","application/vnd.google-apps.document"],["geo","application/vnd.dynageo"],["geojson","application/geo+json"],["gex","application/vnd.geometry-explorer"],["ggb","application/vnd.geogebra.file"],["ggt","application/vnd.geogebra.tool"],["ghf","application/vnd.groove-help"],["gif","image/gif"],["gim","application/vnd.groove-identity-message"],["glb","model/gltf-binary"],["gltf","model/gltf+json"],["gml","application/gml+xml"],["gmx","application/vnd.gmx"],["gnumeric","application/x-gnumeric"],["gpg","application/gpg-keys"],["gph","application/vnd.flographit"],["gpx","application/gpx+xml"],["gqf","application/vnd.grafeq"],["gqs","application/vnd.grafeq"],["gram","application/srgs"],["gramps","application/x-gramps-xml"],["gre","application/vnd.geometry-explorer"],["grv","application/vnd.groove-injector"],["grxml","application/srgs+xml"],["gsf","application/x-font-ghostscript"],["gsheet","application/vnd.google-apps.spreadsheet"],["gslides","application/vnd.google-apps.presentation"],["gtar","application/x-gtar"],["gtm","application/vnd.groove-tool-message"],["gtw","model/vnd.gtw"],["gv","text/vnd.graphviz"],["gxf","application/gxf"],["gxt","application/vnd.geonext"],["gz","application/gzip"],["gzip","application/gzip"],["h","text/x-c"],["h261","video/h261"],["h263","video/h263"],["h264","video/h264"],["hal","application/vnd.hal+xml"],["hbci","application/vnd.hbci"],["hbs","text/x-handlebars-template"],["hdd","application/x-virtualbox-hdd"],["hdf","application/x-hdf"],["heic","image/heic"],["heics","image/heic-sequence"],["heif","image/heif"],["heifs","image/heif-sequence"],["hej2","image/hej2k"],["held","application/atsc-held+xml"],["hh","text/x-c"],["hjson","application/hjson"],["hlp","application/winhlp"],["hpgl","application/vnd.hp-hpgl"],["hpid","application/vnd.hp-hpid"],["hps","application/vnd.hp-hps"],["hqx","application/mac-binhex40"],["hsj2","image/hsj2"],["htc","text/x-component"],["htke","application/vnd.kenameaapp"],["htm","text/html"],["html","text/html"],["hvd","application/vnd.yamaha.hv-dic"],["hvp","application/vnd.yamaha.hv-voice"],["hvs","application/vnd.yamaha.hv-script"],["i2g","application/vnd.intergeo"],["icc","application/vnd.iccprofile"],["ice","x-conference/x-cooltalk"],["icm","application/vnd.iccprofile"],["ico","image/x-icon"],["ics","text/calendar"],["ief","image/ief"],["ifb","text/calendar"],["ifm","application/vnd.shana.informed.formdata"],["iges","model/iges"],["igl","application/vnd.igloader"],["igm","application/vnd.insors.igm"],["igs","model/iges"],["igx","application/vnd.micrografx.igx"],["iif","application/vnd.shana.informed.interchange"],["img","application/octet-stream"],["imp","application/vnd.accpac.simply.imp"],["ims","application/vnd.ms-ims"],["in","text/plain"],["ini","text/plain"],["ink","application/inkml+xml"],["inkml","application/inkml+xml"],["install","application/x-install-instructions"],["iota","application/vnd.astraea-software.iota"],["ipfix","application/ipfix"],["ipk","application/vnd.shana.informed.package"],["irm","application/vnd.ibm.rights-management"],["irp","application/vnd.irepository.package+xml"],["iso","application/x-iso9660-image"],["itp","application/vnd.shana.informed.formtemplate"],["its","application/its+xml"],["ivp","application/vnd.immervision-ivp"],["ivu","application/vnd.immervision-ivu"],["jad","text/vnd.sun.j2me.app-descriptor"],["jade","text/jade"],["jam","application/vnd.jam"],["jar","application/java-archive"],["jardiff","application/x-java-archive-diff"],["java","text/x-java-source"],["jhc","image/jphc"],["jisp","application/vnd.jisp"],["jls","image/jls"],["jlt","application/vnd.hp-jlyt"],["jng","image/x-jng"],["jnlp","application/x-java-jnlp-file"],["joda","application/vnd.joost.joda-archive"],["jp2","image/jp2"],["jpe","image/jpeg"],["jpeg","image/jpeg"],["jpf","image/jpx"],["jpg","image/jpeg"],["jpg2","image/jp2"],["jpgm","video/jpm"],["jpgv","video/jpeg"],["jph","image/jph"],["jpm","video/jpm"],["jpx","image/jpx"],["js","application/javascript"],["json","application/json"],["json5","application/json5"],["jsonld","application/ld+json"],["jsonl","application/jsonl"],["jsonml","application/jsonml+json"],["jsx","text/jsx"],["jxr","image/jxr"],["jxra","image/jxra"],["jxrs","image/jxrs"],["jxs","image/jxs"],["jxsc","image/jxsc"],["jxsi","image/jxsi"],["jxss","image/jxss"],["kar","audio/midi"],["karbon","application/vnd.kde.karbon"],["kdb","application/octet-stream"],["kdbx","application/x-keepass2"],["key","application/x-iwork-keynote-sffkey"],["kfo","application/vnd.kde.kformula"],["kia","application/vnd.kidspiration"],["kml","application/vnd.google-earth.kml+xml"],["kmz","application/vnd.google-earth.kmz"],["kne","application/vnd.kinar"],["knp","application/vnd.kinar"],["kon","application/vnd.kde.kontour"],["kpr","application/vnd.kde.kpresenter"],["kpt","application/vnd.kde.kpresenter"],["kpxx","application/vnd.ds-keypoint"],["ksp","application/vnd.kde.kspread"],["ktr","application/vnd.kahootz"],["ktx","image/ktx"],["ktx2","image/ktx2"],["ktz","application/vnd.kahootz"],["kwd","application/vnd.kde.kword"],["kwt","application/vnd.kde.kword"],["lasxml","application/vnd.las.las+xml"],["latex","application/x-latex"],["lbd","application/vnd.llamagraphics.life-balance.desktop"],["lbe","application/vnd.llamagraphics.life-balance.exchange+xml"],["les","application/vnd.hhe.lesson-player"],["less","text/less"],["lgr","application/lgr+xml"],["lha","application/octet-stream"],["link66","application/vnd.route66.link66+xml"],["list","text/plain"],["list3820","application/vnd.ibm.modcap"],["listafp","application/vnd.ibm.modcap"],["litcoffee","text/coffeescript"],["lnk","application/x-ms-shortcut"],["log","text/plain"],["lostxml","application/lost+xml"],["lrf","application/octet-stream"],["lrm","application/vnd.ms-lrm"],["ltf","application/vnd.frogans.ltf"],["lua","text/x-lua"],["luac","application/x-lua-bytecode"],["lvp","audio/vnd.lucent.voice"],["lwp","application/vnd.lotus-wordpro"],["lzh","application/octet-stream"],["m1v","video/mpeg"],["m2a","audio/mpeg"],["m2v","video/mpeg"],["m3a","audio/mpeg"],["m3u","text/plain"],["m3u8","application/vnd.apple.mpegurl"],["m4a","audio/x-m4a"],["m4p","application/mp4"],["m4s","video/iso.segment"],["m4u","application/vnd.mpegurl"],["m4v","video/x-m4v"],["m13","application/x-msmediaview"],["m14","application/x-msmediaview"],["m21","application/mp21"],["ma","application/mathematica"],["mads","application/mads+xml"],["maei","application/mmt-aei+xml"],["mag","application/vnd.ecowin.chart"],["maker","application/vnd.framemaker"],["man","text/troff"],["manifest","text/cache-manifest"],["map","application/json"],["mar","application/octet-stream"],["markdown","text/markdown"],["mathml","application/mathml+xml"],["mb","application/mathematica"],["mbk","application/vnd.mobius.mbk"],["mbox","application/mbox"],["mc1","application/vnd.medcalcdata"],["mcd","application/vnd.mcd"],["mcurl","text/vnd.curl.mcurl"],["md","text/markdown"],["mdb","application/x-msaccess"],["mdi","image/vnd.ms-modi"],["mdx","text/mdx"],["me","text/troff"],["mesh","model/mesh"],["meta4","application/metalink4+xml"],["metalink","application/metalink+xml"],["mets","application/mets+xml"],["mfm","application/vnd.mfmp"],["mft","application/rpki-manifest"],["mgp","application/vnd.osgeo.mapguide.package"],["mgz","application/vnd.proteus.magazine"],["mid","audio/midi"],["midi","audio/midi"],["mie","application/x-mie"],["mif","application/vnd.mif"],["mime","message/rfc822"],["mj2","video/mj2"],["mjp2","video/mj2"],["mjs","application/javascript"],["mk3d","video/x-matroska"],["mka","audio/x-matroska"],["mkd","text/x-markdown"],["mks","video/x-matroska"],["mkv","video/x-matroska"],["mlp","application/vnd.dolby.mlp"],["mmd","application/vnd.chipnuts.karaoke-mmd"],["mmf","application/vnd.smaf"],["mml","text/mathml"],["mmr","image/vnd.fujixerox.edmics-mmr"],["mng","video/x-mng"],["mny","application/x-msmoney"],["mobi","application/x-mobipocket-ebook"],["mods","application/mods+xml"],["mov","video/quicktime"],["movie","video/x-sgi-movie"],["mp2","audio/mpeg"],["mp2a","audio/mpeg"],["mp3","audio/mpeg"],["mp4","video/mp4"],["mp4a","audio/mp4"],["mp4s","application/mp4"],["mp4v","video/mp4"],["mp21","application/mp21"],["mpc","application/vnd.mophun.certificate"],["mpd","application/dash+xml"],["mpe","video/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["mpg4","video/mp4"],["mpga","audio/mpeg"],["mpkg","application/vnd.apple.installer+xml"],["mpm","application/vnd.blueice.multipass"],["mpn","application/vnd.mophun.application"],["mpp","application/vnd.ms-project"],["mpt","application/vnd.ms-project"],["mpy","application/vnd.ibm.minipay"],["mqy","application/vnd.mobius.mqy"],["mrc","application/marc"],["mrcx","application/marcxml+xml"],["ms","text/troff"],["mscml","application/mediaservercontrol+xml"],["mseed","application/vnd.fdsn.mseed"],["mseq","application/vnd.mseq"],["msf","application/vnd.epson.msf"],["msg","application/vnd.ms-outlook"],["msh","model/mesh"],["msi","application/x-msdownload"],["msl","application/vnd.mobius.msl"],["msm","application/octet-stream"],["msp","application/octet-stream"],["msty","application/vnd.muvee.style"],["mtl","model/mtl"],["mts","model/vnd.mts"],["mus","application/vnd.musician"],["musd","application/mmt-usd+xml"],["musicxml","application/vnd.recordare.musicxml+xml"],["mvb","application/x-msmediaview"],["mvt","application/vnd.mapbox-vector-tile"],["mwf","application/vnd.mfer"],["mxf","application/mxf"],["mxl","application/vnd.recordare.musicxml"],["mxmf","audio/mobile-xmf"],["mxml","application/xv+xml"],["mxs","application/vnd.triscape.mxs"],["mxu","video/vnd.mpegurl"],["n-gage","application/vnd.nokia.n-gage.symbian.install"],["n3","text/n3"],["nb","application/mathematica"],["nbp","application/vnd.wolfram.player"],["nc","application/x-netcdf"],["ncx","application/x-dtbncx+xml"],["nfo","text/x-nfo"],["ngdat","application/vnd.nokia.n-gage.data"],["nitf","application/vnd.nitf"],["nlu","application/vnd.neurolanguage.nlu"],["nml","application/vnd.enliven"],["nnd","application/vnd.noblenet-directory"],["nns","application/vnd.noblenet-sealer"],["nnw","application/vnd.noblenet-web"],["npx","image/vnd.net-fpx"],["nq","application/n-quads"],["nsc","application/x-conference"],["nsf","application/vnd.lotus-notes"],["nt","application/n-triples"],["ntf","application/vnd.nitf"],["numbers","application/x-iwork-numbers-sffnumbers"],["nzb","application/x-nzb"],["oa2","application/vnd.fujitsu.oasys2"],["oa3","application/vnd.fujitsu.oasys3"],["oas","application/vnd.fujitsu.oasys"],["obd","application/x-msbinder"],["obgx","application/vnd.openblox.game+xml"],["obj","model/obj"],["oda","application/oda"],["odb","application/vnd.oasis.opendocument.database"],["odc","application/vnd.oasis.opendocument.chart"],["odf","application/vnd.oasis.opendocument.formula"],["odft","application/vnd.oasis.opendocument.formula-template"],["odg","application/vnd.oasis.opendocument.graphics"],["odi","application/vnd.oasis.opendocument.image"],["odm","application/vnd.oasis.opendocument.text-master"],["odp","application/vnd.oasis.opendocument.presentation"],["ods","application/vnd.oasis.opendocument.spreadsheet"],["odt","application/vnd.oasis.opendocument.text"],["oga","audio/ogg"],["ogex","model/vnd.opengex"],["ogg","audio/ogg"],["ogv","video/ogg"],["ogx","application/ogg"],["omdoc","application/omdoc+xml"],["onepkg","application/onenote"],["onetmp","application/onenote"],["onetoc","application/onenote"],["onetoc2","application/onenote"],["opf","application/oebps-package+xml"],["opml","text/x-opml"],["oprc","application/vnd.palm"],["opus","audio/ogg"],["org","text/x-org"],["osf","application/vnd.yamaha.openscoreformat"],["osfpvg","application/vnd.yamaha.openscoreformat.osfpvg+xml"],["osm","application/vnd.openstreetmap.data+xml"],["otc","application/vnd.oasis.opendocument.chart-template"],["otf","font/otf"],["otg","application/vnd.oasis.opendocument.graphics-template"],["oth","application/vnd.oasis.opendocument.text-web"],["oti","application/vnd.oasis.opendocument.image-template"],["otp","application/vnd.oasis.opendocument.presentation-template"],["ots","application/vnd.oasis.opendocument.spreadsheet-template"],["ott","application/vnd.oasis.opendocument.text-template"],["ova","application/x-virtualbox-ova"],["ovf","application/x-virtualbox-ovf"],["owl","application/rdf+xml"],["oxps","application/oxps"],["oxt","application/vnd.openofficeorg.extension"],["p","text/x-pascal"],["p7a","application/x-pkcs7-signature"],["p7b","application/x-pkcs7-certificates"],["p7c","application/pkcs7-mime"],["p7m","application/pkcs7-mime"],["p7r","application/x-pkcs7-certreqresp"],["p7s","application/pkcs7-signature"],["p8","application/pkcs8"],["p10","application/x-pkcs10"],["p12","application/x-pkcs12"],["pac","application/x-ns-proxy-autoconfig"],["pages","application/x-iwork-pages-sffpages"],["pas","text/x-pascal"],["paw","application/vnd.pawaafile"],["pbd","application/vnd.powerbuilder6"],["pbm","image/x-portable-bitmap"],["pcap","application/vnd.tcpdump.pcap"],["pcf","application/x-font-pcf"],["pcl","application/vnd.hp-pcl"],["pclxl","application/vnd.hp-pclxl"],["pct","image/x-pict"],["pcurl","application/vnd.curl.pcurl"],["pcx","image/x-pcx"],["pdb","application/x-pilot"],["pde","text/x-processing"],["pdf","application/pdf"],["pem","application/x-x509-user-cert"],["pfa","application/x-font-type1"],["pfb","application/x-font-type1"],["pfm","application/x-font-type1"],["pfr","application/font-tdpfr"],["pfx","application/x-pkcs12"],["pgm","image/x-portable-graymap"],["pgn","application/x-chess-pgn"],["pgp","application/pgp"],["php","application/x-httpd-php"],["php3","application/x-httpd-php"],["php4","application/x-httpd-php"],["phps","application/x-httpd-php-source"],["phtml","application/x-httpd-php"],["pic","image/x-pict"],["pkg","application/octet-stream"],["pki","application/pkixcmp"],["pkipath","application/pkix-pkipath"],["pkpass","application/vnd.apple.pkpass"],["pl","application/x-perl"],["plb","application/vnd.3gpp.pic-bw-large"],["plc","application/vnd.mobius.plc"],["plf","application/vnd.pocketlearn"],["pls","application/pls+xml"],["pm","application/x-perl"],["pml","application/vnd.ctc-posml"],["png","image/png"],["pnm","image/x-portable-anymap"],["portpkg","application/vnd.macports.portpkg"],["pot","application/vnd.ms-powerpoint"],["potm","application/vnd.ms-powerpoint.presentation.macroEnabled.12"],["potx","application/vnd.openxmlformats-officedocument.presentationml.template"],["ppa","application/vnd.ms-powerpoint"],["ppam","application/vnd.ms-powerpoint.addin.macroEnabled.12"],["ppd","application/vnd.cups-ppd"],["ppm","image/x-portable-pixmap"],["pps","application/vnd.ms-powerpoint"],["ppsm","application/vnd.ms-powerpoint.slideshow.macroEnabled.12"],["ppsx","application/vnd.openxmlformats-officedocument.presentationml.slideshow"],["ppt","application/powerpoint"],["pptm","application/vnd.ms-powerpoint.presentation.macroEnabled.12"],["pptx","application/vnd.openxmlformats-officedocument.presentationml.presentation"],["pqa","application/vnd.palm"],["prc","application/x-pilot"],["pre","application/vnd.lotus-freelance"],["prf","application/pics-rules"],["provx","application/provenance+xml"],["ps","application/postscript"],["psb","application/vnd.3gpp.pic-bw-small"],["psd","application/x-photoshop"],["psf","application/x-font-linux-psf"],["pskcxml","application/pskc+xml"],["pti","image/prs.pti"],["ptid","application/vnd.pvi.ptid1"],["pub","application/x-mspublisher"],["pvb","application/vnd.3gpp.pic-bw-var"],["pwn","application/vnd.3m.post-it-notes"],["pya","audio/vnd.ms-playready.media.pya"],["pyv","video/vnd.ms-playready.media.pyv"],["qam","application/vnd.epson.quickanime"],["qbo","application/vnd.intu.qbo"],["qfx","application/vnd.intu.qfx"],["qps","application/vnd.publishare-delta-tree"],["qt","video/quicktime"],["qwd","application/vnd.quark.quarkxpress"],["qwt","application/vnd.quark.quarkxpress"],["qxb","application/vnd.quark.quarkxpress"],["qxd","application/vnd.quark.quarkxpress"],["qxl","application/vnd.quark.quarkxpress"],["qxt","application/vnd.quark.quarkxpress"],["ra","audio/x-realaudio"],["ram","audio/x-pn-realaudio"],["raml","application/raml+yaml"],["rapd","application/route-apd+xml"],["rar","application/x-rar"],["ras","image/x-cmu-raster"],["rcprofile","application/vnd.ipunplugged.rcprofile"],["rdf","application/rdf+xml"],["rdz","application/vnd.data-vision.rdz"],["relo","application/p2p-overlay+xml"],["rep","application/vnd.businessobjects"],["res","application/x-dtbresource+xml"],["rgb","image/x-rgb"],["rif","application/reginfo+xml"],["rip","audio/vnd.rip"],["ris","application/x-research-info-systems"],["rl","application/resource-lists+xml"],["rlc","image/vnd.fujixerox.edmics-rlc"],["rld","application/resource-lists-diff+xml"],["rm","audio/x-pn-realaudio"],["rmi","audio/midi"],["rmp","audio/x-pn-realaudio-plugin"],["rms","application/vnd.jcp.javame.midlet-rms"],["rmvb","application/vnd.rn-realmedia-vbr"],["rnc","application/relax-ng-compact-syntax"],["rng","application/xml"],["roa","application/rpki-roa"],["roff","text/troff"],["rp9","application/vnd.cloanto.rp9"],["rpm","audio/x-pn-realaudio-plugin"],["rpss","application/vnd.nokia.radio-presets"],["rpst","application/vnd.nokia.radio-preset"],["rq","application/sparql-query"],["rs","application/rls-services+xml"],["rsa","application/x-pkcs7"],["rsat","application/atsc-rsat+xml"],["rsd","application/rsd+xml"],["rsheet","application/urc-ressheet+xml"],["rss","application/rss+xml"],["rtf","text/rtf"],["rtx","text/richtext"],["run","application/x-makeself"],["rusd","application/route-usd+xml"],["rv","video/vnd.rn-realvideo"],["s","text/x-asm"],["s3m","audio/s3m"],["saf","application/vnd.yamaha.smaf-audio"],["sass","text/x-sass"],["sbml","application/sbml+xml"],["sc","application/vnd.ibm.secure-container"],["scd","application/x-msschedule"],["scm","application/vnd.lotus-screencam"],["scq","application/scvp-cv-request"],["scs","application/scvp-cv-response"],["scss","text/x-scss"],["scurl","text/vnd.curl.scurl"],["sda","application/vnd.stardivision.draw"],["sdc","application/vnd.stardivision.calc"],["sdd","application/vnd.stardivision.impress"],["sdkd","application/vnd.solent.sdkm+xml"],["sdkm","application/vnd.solent.sdkm+xml"],["sdp","application/sdp"],["sdw","application/vnd.stardivision.writer"],["sea","application/octet-stream"],["see","application/vnd.seemail"],["seed","application/vnd.fdsn.seed"],["sema","application/vnd.sema"],["semd","application/vnd.semd"],["semf","application/vnd.semf"],["senmlx","application/senml+xml"],["sensmlx","application/sensml+xml"],["ser","application/java-serialized-object"],["setpay","application/set-payment-initiation"],["setreg","application/set-registration-initiation"],["sfd-hdstx","application/vnd.hydrostatix.sof-data"],["sfs","application/vnd.spotfire.sfs"],["sfv","text/x-sfv"],["sgi","image/sgi"],["sgl","application/vnd.stardivision.writer-global"],["sgm","text/sgml"],["sgml","text/sgml"],["sh","application/x-sh"],["shar","application/x-shar"],["shex","text/shex"],["shf","application/shf+xml"],["shtml","text/html"],["sid","image/x-mrsid-image"],["sieve","application/sieve"],["sig","application/pgp-signature"],["sil","audio/silk"],["silo","model/mesh"],["sis","application/vnd.symbian.install"],["sisx","application/vnd.symbian.install"],["sit","application/x-stuffit"],["sitx","application/x-stuffitx"],["siv","application/sieve"],["skd","application/vnd.koan"],["skm","application/vnd.koan"],["skp","application/vnd.koan"],["skt","application/vnd.koan"],["sldm","application/vnd.ms-powerpoint.slide.macroenabled.12"],["sldx","application/vnd.openxmlformats-officedocument.presentationml.slide"],["slim","text/slim"],["slm","text/slim"],["sls","application/route-s-tsid+xml"],["slt","application/vnd.epson.salt"],["sm","application/vnd.stepmania.stepchart"],["smf","application/vnd.stardivision.math"],["smi","application/smil"],["smil","application/smil"],["smv","video/x-smv"],["smzip","application/vnd.stepmania.package"],["snd","audio/basic"],["snf","application/x-font-snf"],["so","application/octet-stream"],["spc","application/x-pkcs7-certificates"],["spdx","text/spdx"],["spf","application/vnd.yamaha.smaf-phrase"],["spl","application/x-futuresplash"],["spot","text/vnd.in3d.spot"],["spp","application/scvp-vp-response"],["spq","application/scvp-vp-request"],["spx","audio/ogg"],["sql","application/x-sql"],["src","application/x-wais-source"],["srt","application/x-subrip"],["sru","application/sru+xml"],["srx","application/sparql-results+xml"],["ssdl","application/ssdl+xml"],["sse","application/vnd.kodak-descriptor"],["ssf","application/vnd.epson.ssf"],["ssml","application/ssml+xml"],["sst","application/octet-stream"],["st","application/vnd.sailingtracker.track"],["stc","application/vnd.sun.xml.calc.template"],["std","application/vnd.sun.xml.draw.template"],["stf","application/vnd.wt.stf"],["sti","application/vnd.sun.xml.impress.template"],["stk","application/hyperstudio"],["stl","model/stl"],["stpx","model/step+xml"],["stpxz","model/step-xml+zip"],["stpz","model/step+zip"],["str","application/vnd.pg.format"],["stw","application/vnd.sun.xml.writer.template"],["styl","text/stylus"],["stylus","text/stylus"],["sub","text/vnd.dvb.subtitle"],["sus","application/vnd.sus-calendar"],["susp","application/vnd.sus-calendar"],["sv4cpio","application/x-sv4cpio"],["sv4crc","application/x-sv4crc"],["svc","application/vnd.dvb.service"],["svd","application/vnd.svd"],["svg","image/svg+xml"],["svgz","image/svg+xml"],["swa","application/x-director"],["swf","application/x-shockwave-flash"],["swi","application/vnd.aristanetworks.swi"],["swidtag","application/swid+xml"],["sxc","application/vnd.sun.xml.calc"],["sxd","application/vnd.sun.xml.draw"],["sxg","application/vnd.sun.xml.writer.global"],["sxi","application/vnd.sun.xml.impress"],["sxm","application/vnd.sun.xml.math"],["sxw","application/vnd.sun.xml.writer"],["t","text/troff"],["t3","application/x-t3vm-image"],["t38","image/t38"],["taglet","application/vnd.mynfc"],["tao","application/vnd.tao.intent-module-archive"],["tap","image/vnd.tencent.tap"],["tar","application/x-tar"],["tcap","application/vnd.3gpp2.tcap"],["tcl","application/x-tcl"],["td","application/urc-targetdesc+xml"],["teacher","application/vnd.smart.teacher"],["tei","application/tei+xml"],["teicorpus","application/tei+xml"],["tex","application/x-tex"],["texi","application/x-texinfo"],["texinfo","application/x-texinfo"],["text","text/plain"],["tfi","application/thraud+xml"],["tfm","application/x-tex-tfm"],["tfx","image/tiff-fx"],["tga","image/x-tga"],["tgz","application/x-tar"],["thmx","application/vnd.ms-officetheme"],["tif","image/tiff"],["tiff","image/tiff"],["tk","application/x-tcl"],["tmo","application/vnd.tmobile-livetv"],["toml","application/toml"],["torrent","application/x-bittorrent"],["tpl","application/vnd.groove-tool-template"],["tpt","application/vnd.trid.tpt"],["tr","text/troff"],["tra","application/vnd.trueapp"],["trig","application/trig"],["trm","application/x-msterminal"],["ts","video/mp2t"],["tsd","application/timestamped-data"],["tsv","text/tab-separated-values"],["ttc","font/collection"],["ttf","font/ttf"],["ttl","text/turtle"],["ttml","application/ttml+xml"],["twd","application/vnd.simtech-mindmapper"],["twds","application/vnd.simtech-mindmapper"],["txd","application/vnd.genomatix.tuxedo"],["txf","application/vnd.mobius.txf"],["txt","text/plain"],["u8dsn","message/global-delivery-status"],["u8hdr","message/global-headers"],["u8mdn","message/global-disposition-notification"],["u8msg","message/global"],["u32","application/x-authorware-bin"],["ubj","application/ubjson"],["udeb","application/x-debian-package"],["ufd","application/vnd.ufdl"],["ufdl","application/vnd.ufdl"],["ulx","application/x-glulx"],["umj","application/vnd.umajin"],["unityweb","application/vnd.unity"],["uoml","application/vnd.uoml+xml"],["uri","text/uri-list"],["uris","text/uri-list"],["urls","text/uri-list"],["usdz","model/vnd.usdz+zip"],["ustar","application/x-ustar"],["utz","application/vnd.uiq.theme"],["uu","text/x-uuencode"],["uva","audio/vnd.dece.audio"],["uvd","application/vnd.dece.data"],["uvf","application/vnd.dece.data"],["uvg","image/vnd.dece.graphic"],["uvh","video/vnd.dece.hd"],["uvi","image/vnd.dece.graphic"],["uvm","video/vnd.dece.mobile"],["uvp","video/vnd.dece.pd"],["uvs","video/vnd.dece.sd"],["uvt","application/vnd.dece.ttml+xml"],["uvu","video/vnd.uvvu.mp4"],["uvv","video/vnd.dece.video"],["uvva","audio/vnd.dece.audio"],["uvvd","application/vnd.dece.data"],["uvvf","application/vnd.dece.data"],["uvvg","image/vnd.dece.graphic"],["uvvh","video/vnd.dece.hd"],["uvvi","image/vnd.dece.graphic"],["uvvm","video/vnd.dece.mobile"],["uvvp","video/vnd.dece.pd"],["uvvs","video/vnd.dece.sd"],["uvvt","application/vnd.dece.ttml+xml"],["uvvu","video/vnd.uvvu.mp4"],["uvvv","video/vnd.dece.video"],["uvvx","application/vnd.dece.unspecified"],["uvvz","application/vnd.dece.zip"],["uvx","application/vnd.dece.unspecified"],["uvz","application/vnd.dece.zip"],["vbox","application/x-virtualbox-vbox"],["vbox-extpack","application/x-virtualbox-vbox-extpack"],["vcard","text/vcard"],["vcd","application/x-cdlink"],["vcf","text/x-vcard"],["vcg","application/vnd.groove-vcard"],["vcs","text/x-vcalendar"],["vcx","application/vnd.vcx"],["vdi","application/x-virtualbox-vdi"],["vds","model/vnd.sap.vds"],["vhd","application/x-virtualbox-vhd"],["vis","application/vnd.visionary"],["viv","video/vnd.vivo"],["vlc","application/videolan"],["vmdk","application/x-virtualbox-vmdk"],["vob","video/x-ms-vob"],["vor","application/vnd.stardivision.writer"],["vox","application/x-authorware-bin"],["vrml","model/vrml"],["vsd","application/vnd.visio"],["vsf","application/vnd.vsf"],["vss","application/vnd.visio"],["vst","application/vnd.visio"],["vsw","application/vnd.visio"],["vtf","image/vnd.valve.source.texture"],["vtt","text/vtt"],["vtu","model/vnd.vtu"],["vxml","application/voicexml+xml"],["w3d","application/x-director"],["wad","application/x-doom"],["wadl","application/vnd.sun.wadl+xml"],["war","application/java-archive"],["wasm","application/wasm"],["wav","audio/x-wav"],["wax","audio/x-ms-wax"],["wbmp","image/vnd.wap.wbmp"],["wbs","application/vnd.criticaltools.wbs+xml"],["wbxml","application/wbxml"],["wcm","application/vnd.ms-works"],["wdb","application/vnd.ms-works"],["wdp","image/vnd.ms-photo"],["weba","audio/webm"],["webapp","application/x-web-app-manifest+json"],["webm","video/webm"],["webmanifest","application/manifest+json"],["webp","image/webp"],["wg","application/vnd.pmi.widget"],["wgt","application/widget"],["wks","application/vnd.ms-works"],["wm","video/x-ms-wm"],["wma","audio/x-ms-wma"],["wmd","application/x-ms-wmd"],["wmf","image/wmf"],["wml","text/vnd.wap.wml"],["wmlc","application/wmlc"],["wmls","text/vnd.wap.wmlscript"],["wmlsc","application/vnd.wap.wmlscriptc"],["wmv","video/x-ms-wmv"],["wmx","video/x-ms-wmx"],["wmz","application/x-msmetafile"],["woff","font/woff"],["woff2","font/woff2"],["word","application/msword"],["wpd","application/vnd.wordperfect"],["wpl","application/vnd.ms-wpl"],["wps","application/vnd.ms-works"],["wqd","application/vnd.wqd"],["wri","application/x-mswrite"],["wrl","model/vrml"],["wsc","message/vnd.wfa.wsc"],["wsdl","application/wsdl+xml"],["wspolicy","application/wspolicy+xml"],["wtb","application/vnd.webturbo"],["wvx","video/x-ms-wvx"],["x3d","model/x3d+xml"],["x3db","model/x3d+fastinfoset"],["x3dbz","model/x3d+binary"],["x3dv","model/x3d-vrml"],["x3dvz","model/x3d+vrml"],["x3dz","model/x3d+xml"],["x32","application/x-authorware-bin"],["x_b","model/vnd.parasolid.transmit.binary"],["x_t","model/vnd.parasolid.transmit.text"],["xaml","application/xaml+xml"],["xap","application/x-silverlight-app"],["xar","application/vnd.xara"],["xav","application/xcap-att+xml"],["xbap","application/x-ms-xbap"],["xbd","application/vnd.fujixerox.docuworks.binder"],["xbm","image/x-xbitmap"],["xca","application/xcap-caps+xml"],["xcs","application/calendar+xml"],["xdf","application/xcap-diff+xml"],["xdm","application/vnd.syncml.dm+xml"],["xdp","application/vnd.adobe.xdp+xml"],["xdssc","application/dssc+xml"],["xdw","application/vnd.fujixerox.docuworks"],["xel","application/xcap-el+xml"],["xenc","application/xenc+xml"],["xer","application/patch-ops-error+xml"],["xfdf","application/vnd.adobe.xfdf"],["xfdl","application/vnd.xfdl"],["xht","application/xhtml+xml"],["xhtml","application/xhtml+xml"],["xhvml","application/xv+xml"],["xif","image/vnd.xiff"],["xl","application/excel"],["xla","application/vnd.ms-excel"],["xlam","application/vnd.ms-excel.addin.macroEnabled.12"],["xlc","application/vnd.ms-excel"],["xlf","application/xliff+xml"],["xlm","application/vnd.ms-excel"],["xls","application/vnd.ms-excel"],["xlsb","application/vnd.ms-excel.sheet.binary.macroEnabled.12"],["xlsm","application/vnd.ms-excel.sheet.macroEnabled.12"],["xlsx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],["xlt","application/vnd.ms-excel"],["xltm","application/vnd.ms-excel.template.macroEnabled.12"],["xltx","application/vnd.openxmlformats-officedocument.spreadsheetml.template"],["xlw","application/vnd.ms-excel"],["xm","audio/xm"],["xml","application/xml"],["xns","application/xcap-ns+xml"],["xo","application/vnd.olpc-sugar"],["xop","application/xop+xml"],["xpi","application/x-xpinstall"],["xpl","application/xproc+xml"],["xpm","image/x-xpixmap"],["xpr","application/vnd.is-xpr"],["xps","application/vnd.ms-xpsdocument"],["xpw","application/vnd.intercon.formnet"],["xpx","application/vnd.intercon.formnet"],["xsd","application/xml"],["xsl","application/xml"],["xslt","application/xslt+xml"],["xsm","application/vnd.syncml+xml"],["xspf","application/xspf+xml"],["xul","application/vnd.mozilla.xul+xml"],["xvm","application/xv+xml"],["xvml","application/xv+xml"],["xwd","image/x-xwindowdump"],["xyz","chemical/x-xyz"],["xz","application/x-xz"],["yaml","text/yaml"],["yang","application/yang"],["yin","application/yin+xml"],["yml","text/yaml"],["ymp","text/x-suse-ymp"],["z","application/x-compress"],["z1","application/x-zmachine"],["z2","application/x-zmachine"],["z3","application/x-zmachine"],["z4","application/x-zmachine"],["z5","application/x-zmachine"],["z6","application/x-zmachine"],["z7","application/x-zmachine"],["z8","application/x-zmachine"],["zaz","application/vnd.zzazz.deck+xml"],["zip","application/zip"],["zir","application/vnd.zul"],["zirz","application/vnd.zul"],["zmm","application/vnd.handheld-entertainment+xml"],["zsh","text/x-scriptzsh"]]);function zd(u,f,x){const _=AQ(u),{webkitRelativePath:E}=u,y=typeof f=="string"?f:typeof E=="string"&&E.length>0?E:`./${u.name}`;return typeof _.path!="string"&&qP(_,"path",y),qP(_,"relativePath",y),_}function AQ(u){const{name:f}=u;if(f&&f.lastIndexOf(".")!==-1&&!u.type){const _=f.split(".").pop().toLowerCase(),E=IQ.get(_);E&&Object.defineProperty(u,"type",{value:E,writable:!1,configurable:!1,enumerable:!0})}return u}function qP(u,f,x){Object.defineProperty(u,f,{value:x,writable:!1,configurable:!1,enumerable:!0})}const OQ=[".DS_Store","Thumbs.db"];function DQ(u){return fl(this,void 0,void 0,function*(){return lg(u)&&kQ(u.dataTransfer)?MQ(u.dataTransfer,u.type):jQ(u)?PQ(u):Array.isArray(u)&&u.every(f=>"getFile"in f&&typeof f.getFile=="function")?LQ(u):[]})}function kQ(u){return lg(u)}function jQ(u){return lg(u)&&lg(u.target)}function lg(u){return typeof u=="object"&&u!==null}function PQ(u){return TE(u.target.files).map(f=>zd(f))}function LQ(u){return fl(this,void 0,void 0,function*(){return(yield Promise.all(u.map(x=>x.getFile()))).map(x=>zd(x))})}function MQ(u,f){return fl(this,void 0,void 0,function*(){if(u.items){const x=TE(u.items).filter(E=>E.kind==="file");if(f!=="drop")return x;const _=yield Promise.all(x.map(UQ));return XP(EL(_))}return XP(TE(u.files).map(x=>zd(x)))})}function XP(u){return u.filter(f=>OQ.indexOf(f.name)===-1)}function TE(u){if(u===null)return[];const f=[];for(let x=0;x<u.length;x++){const _=u[x];f.push(_)}return f}function UQ(u){if(typeof u.webkitGetAsEntry!="function")return JP(u);const f=u.webkitGetAsEntry();return f&&f.isDirectory?yL(f):JP(u,f)}function EL(u){return u.reduce((f,x)=>[...f,...Array.isArray(x)?EL(x):[x]],[])}function JP(u,f){return fl(this,void 0,void 0,function*(){var x;if(globalThis.isSecureContext&&typeof u.getAsFileSystemHandle=="function"){const y=yield u.getAsFileSystemHandle();if(y===null)throw new Error(`${u} is not a File`);if(y!==void 0){const R=yield y.getFile();return R.handle=y,zd(R)}}const _=u.getAsFile();if(!_)throw new Error(`${u} is not a File`);return zd(_,(x=f==null?void 0:f.fullPath)!==null&&x!==void 0?x:void 0)})}function VQ(u){return fl(this,void 0,void 0,function*(){return u.isDirectory?yL(u):FQ(u)})}function yL(u){const f=u.createReader();return new Promise((x,_)=>{const E=[];function y(){f.readEntries(R=>fl(this,void 0,void 0,function*(){if(R.length){const P=Promise.all(R.map(VQ));E.push(P),y()}else try{const P=yield Promise.all(E);x(P)}catch(P){_(P)}}),R=>{_(R)})}y()})}function FQ(u){return fl(this,void 0,void 0,function*(){return new Promise((f,x)=>{u.file(_=>{const E=zd(_,u.fullPath);f(E)},_=>{x(_)})})})}var tE=function(u,f){if(u&&f){var x=Array.isArray(f)?f:f.split(",");if(x.length===0)return!0;var _=u.name||"",E=(u.type||"").toLowerCase(),y=E.replace(/\/.*$/,"");return x.some(function(R){var P=R.trim().toLowerCase();return P.charAt(0)==="."?_.toLowerCase().endsWith(P):P.endsWith("/*")?y===P.replace(/\/.*$/,""):E===P})}return!0};function $P(u){return WQ(u)||GQ(u)||SL(u)||BQ()}function BQ(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function GQ(u){if(typeof Symbol<"u"&&u[Symbol.iterator]!=null||u["@@iterator"]!=null)return Array.from(u)}function WQ(u){if(Array.isArray(u))return RE(u)}function QP(u,f){var x=Object.keys(u);if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(u);f&&(_=_.filter(function(E){return Object.getOwnPropertyDescriptor(u,E).enumerable})),x.push.apply(x,_)}return x}function ZP(u){for(var f=1;f<arguments.length;f++){var x=arguments[f]!=null?arguments[f]:{};f%2?QP(Object(x),!0).forEach(function(_){wL(u,_,x[_])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(x)):QP(Object(x)).forEach(function(_){Object.defineProperty(u,_,Object.getOwnPropertyDescriptor(x,_))})}return u}function wL(u,f,x){return f in u?Object.defineProperty(u,f,{value:x,enumerable:!0,configurable:!0,writable:!0}):u[f]=x,u}function Ph(u,f){return KQ(u)||zQ(u,f)||SL(u,f)||HQ()}function HQ(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function SL(u,f){if(u){if(typeof u=="string")return RE(u,f);var x=Object.prototype.toString.call(u).slice(8,-1);if(x==="Object"&&u.constructor&&(x=u.constructor.name),x==="Map"||x==="Set")return Array.from(u);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return RE(u,f)}}function RE(u,f){(f==null||f>u.length)&&(f=u.length);for(var x=0,_=new Array(f);x<f;x++)_[x]=u[x];return _}function zQ(u,f){var x=u==null?null:typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(x!=null){var _=[],E=!0,y=!1,R,P;try{for(x=x.call(u);!(E=(R=x.next()).done)&&(_.push(R.value),!(f&&_.length===f));E=!0);}catch(U){y=!0,P=U}finally{try{!E&&x.return!=null&&x.return()}finally{if(y)throw P}}return _}}function KQ(u){if(Array.isArray(u))return u}var YQ=typeof tE=="function"?tE:tE.default,qQ="file-invalid-type",XQ="file-too-large",JQ="file-too-small",$Q="too-many-files",QQ=function(){var f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",x=f.split(","),_=x.length>1?"one of ".concat(x.join(", ")):x[0];return{code:qQ,message:"File type must be ".concat(_)}},e2=function(f){return{code:XQ,message:"File is larger than ".concat(f," ").concat(f===1?"byte":"bytes")}},t2=function(f){return{code:JQ,message:"File is smaller than ".concat(f," ").concat(f===1?"byte":"bytes")}},ZQ={code:$Q,message:"Too many files"};function NL(u,f){var x=u.type==="application/x-moz-file"||YQ(u,f);return[x,x?null:QQ(f)]}function TL(u,f,x){if(dl(u.size))if(dl(f)&&dl(x)){if(u.size>x)return[!1,e2(x)];if(u.size<f)return[!1,t2(f)]}else{if(dl(f)&&u.size<f)return[!1,t2(f)];if(dl(x)&&u.size>x)return[!1,e2(x)]}return[!0,null]}function dl(u){return u!=null}function eZ(u){var f=u.files,x=u.accept,_=u.minSize,E=u.maxSize,y=u.multiple,R=u.maxFiles,P=u.validator;return!y&&f.length>1||y&&R>=1&&f.length>R?!1:f.every(function(U){var G=NL(U,x),F=Ph(G,1),k=F[0],X=TL(U,_,E),q=Ph(X,1),D=q[0],H=P?P(U):null;return k&&D&&!H})}function dg(u){return typeof u.isPropagationStopped=="function"?u.isPropagationStopped():typeof u.cancelBubble<"u"?u.cancelBubble:!1}function Jf(u){return u.dataTransfer?Array.prototype.some.call(u.dataTransfer.types,function(f){return f==="Files"||f==="application/x-moz-file"}):!!u.target&&!!u.target.files}function s2(u){u.preventDefault()}function tZ(u){return u.indexOf("MSIE")!==-1||u.indexOf("Trident/")!==-1}function sZ(u){return u.indexOf("Edge/")!==-1}function nZ(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.navigator.userAgent;return tZ(u)||sZ(u)}function Ki(){for(var u=arguments.length,f=new Array(u),x=0;x<u;x++)f[x]=arguments[x];return function(_){for(var E=arguments.length,y=new Array(E>1?E-1:0),R=1;R<E;R++)y[R-1]=arguments[R];return f.some(function(P){return!dg(_)&&P&&P.apply(void 0,[_].concat(y)),dg(_)})}}function aZ(){return"showOpenFilePicker"in window}function rZ(u){if(dl(u)){var f=Object.entries(u).filter(function(x){var _=Ph(x,2),E=_[0],y=_[1],R=!0;return RL(E)||(console.warn('Skipped "'.concat(E,'" because it is not a valid MIME type. Check https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types for a list of valid MIME types.')),R=!1),(!Array.isArray(y)||!y.every(CL))&&(console.warn('Skipped "'.concat(E,'" because an invalid file extension was provided.')),R=!1),R}).reduce(function(x,_){var E=Ph(_,2),y=E[0],R=E[1];return ZP(ZP({},x),{},wL({},y,R))},{});return[{description:"Files",accept:f}]}return u}function iZ(u){if(dl(u))return Object.entries(u).reduce(function(f,x){var _=Ph(x,2),E=_[0],y=_[1];return[].concat($P(f),[E],$P(y))},[]).filter(function(f){return RL(f)||CL(f)}).join(",")}function oZ(u){return u instanceof DOMException&&(u.name==="AbortError"||u.code===u.ABORT_ERR)}function cZ(u){return u instanceof DOMException&&(u.name==="SecurityError"||u.code===u.SECURITY_ERR)}function RL(u){return u==="audio/*"||u==="video/*"||u==="image/*"||u==="text/*"||u==="application/*"||/\w+\/[-+.\w]+/g.test(u)}function CL(u){return/^.*\.[\w]+$/.test(u)}var lZ=["children"],dZ=["open"],uZ=["refKey","role","onKeyDown","onFocus","onBlur","onClick","onDragEnter","onDragOver","onDragLeave","onDrop"],hZ=["refKey","onChange","onClick"];function pZ(u){return gZ(u)||fZ(u)||IL(u)||mZ()}function mZ(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function fZ(u){if(typeof Symbol<"u"&&u[Symbol.iterator]!=null||u["@@iterator"]!=null)return Array.from(u)}function gZ(u){if(Array.isArray(u))return CE(u)}function sE(u,f){return _Z(u)||bZ(u,f)||IL(u,f)||xZ()}function xZ(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function IL(u,f){if(u){if(typeof u=="string")return CE(u,f);var x=Object.prototype.toString.call(u).slice(8,-1);if(x==="Object"&&u.constructor&&(x=u.constructor.name),x==="Map"||x==="Set")return Array.from(u);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return CE(u,f)}}function CE(u,f){(f==null||f>u.length)&&(f=u.length);for(var x=0,_=new Array(f);x<f;x++)_[x]=u[x];return _}function bZ(u,f){var x=u==null?null:typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(x!=null){var _=[],E=!0,y=!1,R,P;try{for(x=x.call(u);!(E=(R=x.next()).done)&&(_.push(R.value),!(f&&_.length===f));E=!0);}catch(U){y=!0,P=U}finally{try{!E&&x.return!=null&&x.return()}finally{if(y)throw P}}return _}}function _Z(u){if(Array.isArray(u))return u}function n2(u,f){var x=Object.keys(u);if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(u);f&&(_=_.filter(function(E){return Object.getOwnPropertyDescriptor(u,E).enumerable})),x.push.apply(x,_)}return x}function jn(u){for(var f=1;f<arguments.length;f++){var x=arguments[f]!=null?arguments[f]:{};f%2?n2(Object(x),!0).forEach(function(_){IE(u,_,x[_])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(x)):n2(Object(x)).forEach(function(_){Object.defineProperty(u,_,Object.getOwnPropertyDescriptor(x,_))})}return u}function IE(u,f,x){return f in u?Object.defineProperty(u,f,{value:x,enumerable:!0,configurable:!0,writable:!0}):u[f]=x,u}function ug(u,f){if(u==null)return{};var x=vZ(u,f),_,E;if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(u);for(E=0;E<y.length;E++)_=y[E],!(f.indexOf(_)>=0)&&Object.prototype.propertyIsEnumerable.call(u,_)&&(x[_]=u[_])}return x}function vZ(u,f){if(u==null)return{};var x={},_=Object.keys(u),E,y;for(y=0;y<_.length;y++)E=_[y],!(f.indexOf(E)>=0)&&(x[E]=u[E]);return x}var qE=j.forwardRef(function(u,f){var x=u.children,_=ug(u,lZ),E=OL(_),y=E.open,R=ug(E,dZ);return j.useImperativeHandle(f,function(){return{open:y}},[y]),o2.createElement(j.Fragment,null,x(jn(jn({},R),{},{open:y})))});qE.displayName="Dropzone";var AL={disabled:!1,getFilesFromEvent:DQ,maxSize:1/0,minSize:0,multiple:!0,maxFiles:0,preventDropOnDocument:!0,noClick:!1,noKeyboard:!1,noDrag:!1,noDragEventsBubbling:!1,validator:null,useFsAccessApi:!1,autoFocus:!1};qE.defaultProps=AL;qE.propTypes={children:cn.func,accept:cn.objectOf(cn.arrayOf(cn.string)),multiple:cn.bool,preventDropOnDocument:cn.bool,noClick:cn.bool,noKeyboard:cn.bool,noDrag:cn.bool,noDragEventsBubbling:cn.bool,minSize:cn.number,maxSize:cn.number,maxFiles:cn.number,disabled:cn.bool,getFilesFromEvent:cn.func,onFileDialogCancel:cn.func,onFileDialogOpen:cn.func,useFsAccessApi:cn.bool,autoFocus:cn.bool,onDragEnter:cn.func,onDragLeave:cn.func,onDragOver:cn.func,onDrop:cn.func,onDropAccepted:cn.func,onDropRejected:cn.func,onError:cn.func,validator:cn.func};var AE={isFocused:!1,isFileDialogActive:!1,isDragActive:!1,isDragAccept:!1,isDragReject:!1,acceptedFiles:[],fileRejections:[]};function OL(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},f=jn(jn({},AL),u),x=f.accept,_=f.disabled,E=f.getFilesFromEvent,y=f.maxSize,R=f.minSize,P=f.multiple,U=f.maxFiles,G=f.onDragEnter,F=f.onDragLeave,k=f.onDragOver,X=f.onDrop,q=f.onDropAccepted,D=f.onDropRejected,H=f.onFileDialogCancel,B=f.onFileDialogOpen,ne=f.useFsAccessApi,ae=f.autoFocus,Z=f.preventDropOnDocument,te=f.noClick,ie=f.noKeyboard,ue=f.noDrag,Ne=f.noDragEventsBubbling,be=f.onError,Q=f.validator,pe=j.useMemo(function(){return iZ(x)},[x]),he=j.useMemo(function(){return rZ(x)},[x]),Ae=j.useMemo(function(){return typeof B=="function"?B:a2},[B]),fe=j.useMemo(function(){return typeof H=="function"?H:a2},[H]),le=j.useRef(null),we=j.useRef(null),re=j.useReducer(EZ,AE),oe=sE(re,2),J=oe[0],Oe=oe[1],$e=J.isFocused,He=J.isFileDialogActive,ot=j.useRef(typeof window<"u"&&window.isSecureContext&&ne&&aZ()),_t=function(){!ot.current&&He&&setTimeout(function(){if(we.current){var it=we.current.files;it.length||(Oe({type:"closeDialog"}),fe())}},300)};j.useEffect(function(){return window.addEventListener("focus",_t,!1),function(){window.removeEventListener("focus",_t,!1)}},[we,He,fe,ot]);var Ke=j.useRef([]),ht=function(it){le.current&&le.current.contains(it.target)||(it.preventDefault(),Ke.current=[])};j.useEffect(function(){return Z&&(document.addEventListener("dragover",s2,!1),document.addEventListener("drop",ht,!1)),function(){Z&&(document.removeEventListener("dragover",s2),document.removeEventListener("drop",ht))}},[le,Z]),j.useEffect(function(){return!_&&ae&&le.current&&le.current.focus(),function(){}},[le,ae,_]);var st=j.useCallback(function(De){be?be(De):console.error(De)},[be]),ct=j.useCallback(function(De){De.preventDefault(),De.persist(),ws(De),Ke.current=[].concat(pZ(Ke.current),[De.target]),Jf(De)&&Promise.resolve(E(De)).then(function(it){if(!(dg(De)&&!Ne)){var gs=it.length,Gt=gs>0&&eZ({files:it,accept:pe,minSize:R,maxSize:y,multiple:P,maxFiles:U,validator:Q}),Ss=gs>0&&!Gt;Oe({isDragAccept:Gt,isDragReject:Ss,isDragActive:!0,type:"setDraggedFiles"}),G&&G(De)}}).catch(function(it){return st(it)})},[E,G,st,Ne,pe,R,y,P,U,Q]),fs=j.useCallback(function(De){De.preventDefault(),De.persist(),ws(De);var it=Jf(De);if(it&&De.dataTransfer)try{De.dataTransfer.dropEffect="copy"}catch{}return it&&k&&k(De),!1},[k,Ne]),ys=j.useCallback(function(De){De.preventDefault(),De.persist(),ws(De);var it=Ke.current.filter(function(Gt){return le.current&&le.current.contains(Gt)}),gs=it.indexOf(De.target);gs!==-1&&it.splice(gs,1),Ke.current=it,!(it.length>0)&&(Oe({type:"setDraggedFiles",isDragActive:!1,isDragAccept:!1,isDragReject:!1}),Jf(De)&&F&&F(De))},[le,F,Ne]),As=j.useCallback(function(De,it){var gs=[],Gt=[];De.forEach(function(Ss){var pn=NL(Ss,pe),Zn=sE(pn,2),tn=Zn[0],mn=Zn[1],hs=TL(Ss,R,y),ze=sE(hs,2),It=ze[0],wt=ze[1],ft=Q?Q(Ss):null;if(tn&&It&&!ft)gs.push(Ss);else{var Os=[mn,wt];ft&&(Os=Os.concat(ft)),Gt.push({file:Ss,errors:Os.filter(function(Kn){return Kn})})}}),(!P&&gs.length>1||P&&U>=1&&gs.length>U)&&(gs.forEach(function(Ss){Gt.push({file:Ss,errors:[ZQ]})}),gs.splice(0)),Oe({acceptedFiles:gs,fileRejections:Gt,isDragReject:Gt.length>0,type:"setFiles"}),X&&X(gs,Gt,it),Gt.length>0&&D&&D(Gt,it),gs.length>0&&q&&q(gs,it)},[Oe,P,pe,R,y,U,X,q,D,Q]),zs=j.useCallback(function(De){De.preventDefault(),De.persist(),ws(De),Ke.current=[],Jf(De)&&Promise.resolve(E(De)).then(function(it){dg(De)&&!Ne||As(it,De)}).catch(function(it){return st(it)}),Oe({type:"reset"})},[E,As,st,Ne]),je=j.useCallback(function(){if(ot.current){Oe({type:"openDialog"}),Ae();var De={multiple:P,types:he};window.showOpenFilePicker(De).then(function(it){return E(it)}).then(function(it){As(it,null),Oe({type:"closeDialog"})}).catch(function(it){oZ(it)?(fe(it),Oe({type:"closeDialog"})):cZ(it)?(ot.current=!1,we.current?(we.current.value=null,we.current.click()):st(new Error("Cannot open the file picker because the https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API is not supported and no <input> was provided."))):st(it)});return}we.current&&(Oe({type:"openDialog"}),Ae(),we.current.value=null,we.current.click())},[Oe,Ae,fe,ne,As,st,he,P]),Ze=j.useCallback(function(De){!le.current||!le.current.isEqualNode(De.target)||(De.key===" "||De.key==="Enter"||De.keyCode===32||De.keyCode===13)&&(De.preventDefault(),je())},[le,je]),Ct=j.useCallback(function(){Oe({type:"focus"})},[]),zt=j.useCallback(function(){Oe({type:"blur"})},[]),ts=j.useCallback(function(){te||(nZ()?setTimeout(je,0):je())},[te,je]),ge=function(it){return _?null:it},We=function(it){return ie?null:ge(it)},rt=function(it){return ue?null:ge(it)},ws=function(it){Ne&&it.stopPropagation()},Cn=j.useMemo(function(){return function(){var De=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},it=De.refKey,gs=it===void 0?"ref":it,Gt=De.role,Ss=De.onKeyDown,pn=De.onFocus,Zn=De.onBlur,tn=De.onClick,mn=De.onDragEnter,hs=De.onDragOver,ze=De.onDragLeave,It=De.onDrop,wt=ug(De,uZ);return jn(jn(IE({onKeyDown:We(Ki(Ss,Ze)),onFocus:We(Ki(pn,Ct)),onBlur:We(Ki(Zn,zt)),onClick:ge(Ki(tn,ts)),onDragEnter:rt(Ki(mn,ct)),onDragOver:rt(Ki(hs,fs)),onDragLeave:rt(Ki(ze,ys)),onDrop:rt(Ki(It,zs)),role:typeof Gt=="string"&&Gt!==""?Gt:"presentation"},gs,le),!_&&!ie?{tabIndex:0}:{}),wt)}},[le,Ze,Ct,zt,ts,ct,fs,ys,zs,ie,ue,_]),Fe=j.useCallback(function(De){De.stopPropagation()},[]),Je=j.useMemo(function(){return function(){var De=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},it=De.refKey,gs=it===void 0?"ref":it,Gt=De.onChange,Ss=De.onClick,pn=ug(De,hZ),Zn=IE({accept:pe,multiple:P,type:"file",style:{border:0,clip:"rect(0, 0, 0, 0)",clipPath:"inset(50%)",height:"1px",margin:"0 -1px -1px 0",overflow:"hidden",padding:0,position:"absolute",width:"1px",whiteSpace:"nowrap"},onChange:ge(Ki(Gt,zs)),onClick:ge(Ki(Ss,Fe)),tabIndex:-1},gs,we);return jn(jn({},Zn),pn)}},[we,x,P,zs,_]);return jn(jn({},J),{},{isFocused:$e&&!_,getRootProps:Cn,getInputProps:Je,rootRef:le,inputRef:we,open:ge(je)})}function EZ(u,f){switch(f.type){case"focus":return jn(jn({},u),{},{isFocused:!0});case"blur":return jn(jn({},u),{},{isFocused:!1});case"openDialog":return jn(jn({},AE),{},{isFileDialogActive:!0});case"closeDialog":return jn(jn({},u),{},{isFileDialogActive:!1});case"setDraggedFiles":return jn(jn({},u),{},{isDragActive:f.isDragActive,isDragAccept:f.isDragAccept,isDragReject:f.isDragReject});case"setFiles":return jn(jn({},u),{},{acceptedFiles:f.acceptedFiles,fileRejections:f.fileRejections,isDragReject:f.isDragReject});case"reset":return jn({},AE);default:return u}}function a2(){}const yZ=[{value:"Blood Test",label:"Blood Test",icon:""},{value:"X-Ray",label:"X-Ray",icon:""},{value:"MRI",label:"MRI",icon:""},{value:"CT Scan",label:"CT Scan",icon:""},{value:"ECG",label:"ECG",icon:""},{value:"Ultrasound",label:"Ultrasound",icon:""},{value:"General Checkup",label:"General Checkup",icon:""},{value:"Other",label:"Other",icon:""}];function wZ(){const[u,f]=j.useState([]),[x,_]=j.useState(!1),[E,y]=j.useState(0),[R,P]=j.useState([]),U=Ga();j.useEffect(()=>{window.scrollTo(0,0),G()},[]);const G=async()=>{try{const{data:ne}=await qr.getReports();P(ne.slice(0,3))}catch(ne){console.error("Failed to fetch recent reports",ne)}},F=j.useCallback(ne=>{const ae=ne.map(Z=>({file:Z,id:Math.random().toString(36).substr(2,9),reportType:"Blood Test",name:Z.name,size:Z.size}));f(Z=>[...Z,...ae])},[]),{getRootProps:k,getInputProps:X,isDragActive:q}=OL({onDrop:F,accept:{"application/pdf":[".pdf"],"image/*":[".png",".jpg",".jpeg"]},maxSize:10*1024*1024}),D=(ne,ae)=>{f(Z=>Z.map(te=>te.id===ne?{...te,reportType:ae}:te))},H=ne=>{f(ae=>ae.filter(Z=>Z.id!==ne))},B=async ne=>{var Z,te;if(ne.preventDefault(),u.length===0){Ve.error("Please select at least one file");return}_(!0),y(0);const ae=setInterval(()=>{y(ie=>ie>=90?(clearInterval(ae),90):ie+5)},300);try{const ie=new FormData;ie.append("report",u[0].file),ie.append("reportType",u[0].reportType);const{data:ue}=await qr.uploadReport(ie);clearInterval(ae),y(100),Ve.success("Report analyzed successfully!"),setTimeout(()=>U(`/reports/${ue.report._id}`),500)}catch(ie){clearInterval(ae),Ve.error(((te=(Z=ie.response)==null?void 0:Z.data)==null?void 0:te.message)||"Failed to analyze report"),y(0)}finally{_(!1)}};return a.jsxs("div",{className:"min-h-screen bg-slate-50 flex flex-col items-center py-12 px-4 sm:px-6",children:[a.jsxs("div",{className:"fixed inset-0 overflow-hidden pointer-events-none",children:[a.jsx("div",{className:"absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-400/10 rounded-full blur-[120px]"}),a.jsx("div",{className:"absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-cyan-400/10 rounded-full blur-[120px]"})]}),a.jsxs("div",{className:"w-full max-w-2xl relative",children:[a.jsxs("div",{className:"flex flex-col items-center text-center mb-10 space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-blue-100/50 rounded-full border border-blue-200",children:[a.jsx(kh,{className:"w-3.5 h-3.5 text-blue-600"}),a.jsx("span",{className:"text-[10px] font-black tracking-widest text-blue-700 uppercase",children:"HIPAA Secure Portal"})]}),a.jsxs("h1",{className:"text-4xl font-black text-slate-800 tracking-tight",children:["Analyze Medical ",a.jsx("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500",children:"Reports"})]}),a.jsx("p",{className:"text-slate-500 max-w-md font-medium",children:"Upload your documents for instant AI-powered health insights and personalized recommendations."})]}),a.jsx("div",{className:"bg-white rounded-[2.5rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.08)] border border-slate-100 overflow-hidden transition-all",children:a.jsx("div",{className:"p-8 sm:p-12",children:!x&&u.length===0?a.jsxs("div",{...k(),className:`relative group border-4 border-dashed rounded-[2rem] p-10 text-center cursor-pointer transition-all duration-500 ${q?"border-blue-500 bg-blue-50/50 scale-[1.02]":"border-slate-100 hover:border-blue-300 bg-slate-50/50"}`,children:[a.jsx("input",{...X()}),a.jsx("div",{className:"w-20 h-20 rounded-3xl bg-white shadow-xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-500",children:a.jsx(Kr,{className:"w-8 h-8 text-blue-600"})}),a.jsx("h3",{className:"text-xl font-bold text-slate-800 mb-2",children:q?"Drop your report here":"Drop report or click to browse"}),a.jsx("p",{className:"text-slate-500 font-medium mb-6 text-sm",children:"PDF, PNG, or JPG (Max 10MB)"}),a.jsx("div",{className:"flex items-center justify-center gap-4",children:["PDF","PNG","JPG"].map(ne=>a.jsx("span",{className:"px-3 py-1 bg-white border border-slate-200 rounded-lg text-[10px] font-black text-slate-400",children:ne},ne))})]}):u.length>0&&!x?a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"bg-slate-50 rounded-3xl p-6 border border-slate-100",children:u.map(ne=>a.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6",children:[a.jsxs("div",{className:"flex items-center gap-4 min-w-0 flex-1",children:[a.jsx("div",{className:"w-14 h-14 rounded-2xl bg-white shadow-md flex items-center justify-center flex-shrink-0",children:a.jsx(un,{className:"w-6 h-6 text-blue-600"})}),a.jsxs("div",{className:"min-w-0 flex-1",children:[a.jsx("p",{className:"font-bold text-slate-800 truncate text-base",children:ne.name}),a.jsxs("p",{className:"text-xs font-bold text-slate-400 uppercase",children:[(ne.size/1024/1024).toFixed(2)," MB"]})]})]}),a.jsxs("div",{className:"w-full sm:w-auto flex items-center gap-2",children:[a.jsxs("div",{className:"relative flex-1 sm:w-48",children:[a.jsx("select",{value:ne.reportType,onChange:ae=>D(ne.id,ae.target.value),className:"w-full appearance-none bg-white text-slate-800 text-sm font-bold pl-4 pr-10 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:outline-none cursor-pointer",children:yZ.map(ae=>a.jsxs("option",{value:ae.value,children:[ae.icon," ",ae.label]},ae.value))}),a.jsx(yo,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"})]}),a.jsx("button",{onClick:()=>H(ne.id),className:"p-3 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl transition-all flex-shrink-0",children:a.jsx(Bd,{className:"w-5 h-5"})})]})]},ne.id))}),a.jsxs("div",{className:"flex gap-4",children:[a.jsx("button",{onClick:()=>f([]),className:"px-6 py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition-all",children:"Cancel"}),a.jsxs("button",{onClick:B,className:"flex-1 py-4 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-all shadow-xl flex items-center justify-center gap-3 uppercase tracking-widest text-sm",children:[a.jsx(Hs,{className:"w-5 h-5 text-blue-400"}),"Analyze Report"]})]})]}):a.jsxs("div",{className:"space-y-10 py-6",children:[a.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"w-24 h-24 rounded-full border-4 border-slate-100 border-t-blue-500 animate-spin"}),a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsx(un,{className:"w-8 h-8 text-blue-500 animate-pulse"})})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-2xl font-black text-slate-800",children:"Analyzing Report"}),a.jsx("p",{className:"text-slate-500 font-medium",children:"Extracting health markers and findings..."})]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"h-4 bg-slate-100 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-blue-600 to-cyan-500 transition-all duration-500",style:{width:`${E}%`}})}),a.jsxs("div",{className:"flex justify-between text-xs font-black text-slate-400 uppercase tracking-widest",children:[a.jsx("span",{children:"Processing Data"}),a.jsxs("span",{children:[E,"%"]})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-3",children:[a.jsx(VE,{className:"w-5 h-5 text-blue-500"}),a.jsx("span",{className:"text-[10px] font-bold text-slate-500 uppercase",children:"Secure Scan"})]}),a.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-3",children:[a.jsx(kh,{className:"w-5 h-5 text-blue-500"}),a.jsx("span",{className:"text-[10px] font-bold text-slate-500 uppercase",children:"HIPAA Compliant"})]})]})]})})}),a.jsxs("div",{className:"mt-8 bg-blue-50 rounded-3xl p-6 border border-blue-100 flex gap-4",children:[a.jsx(vo,{className:"w-6 h-6 text-blue-500 flex-shrink-0"}),a.jsx("p",{className:"text-sm text-blue-700 leading-relaxed font-medium",children:"Our AI analysis provides deep insights but is for educational purposes only. Always consult with a healthcare professional before making medical decisions."})]}),R.length>0&&a.jsxs("div",{className:"mt-12 space-y-6 animate-fade-in",children:[a.jsxs("div",{className:"flex items-center justify-between px-2",children:[a.jsx("h2",{className:"text-xl font-black text-slate-800 tracking-tight",children:"Recent Tests"}),a.jsx(Rt,{to:"/reports",className:"text-sm font-bold text-blue-600 hover:text-blue-700",children:"View All"})]}),a.jsx("div",{className:"grid gap-4",children:R.map(ne=>a.jsxs("div",{className:"card p-5 relative border-none ring-1 ring-white/50",children:[a.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-[1rem] bg-indigo-50 flex items-center justify-center flex-shrink-0 shadow-inner",children:a.jsx(un,{className:"w-6 h-6 text-indigo-600"})}),a.jsxs("div",{className:"flex-1 mt-1",children:[a.jsx("div",{className:"flex items-center gap-2 mb-1.5",children:a.jsx("span",{className:`text-[9px] font-black px-2.5 py-1 rounded-lg uppercase tracking-widest ${ne.status==="completed"?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:ne.status})}),a.jsx("h3",{className:"text-base font-black text-slate-800 leading-tight uppercase mb-1",children:ne.reportType}),a.jsxs("div",{className:"flex items-center gap-2 text-slate-400 text-[10px] font-black uppercase tracking-widest font-mono",children:[a.jsx(Pn,{className:"w-3 h-3"}),new Date(ne.reportDate||ne.createdAt).toLocaleDateString()]})]})]}),a.jsxs(Rt,{to:`/reports/${ne._id}`,onClick:()=>window.scrollTo(0,0),className:"w-full py-3 bg-white border-2 border-slate-100 text-slate-800 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95",children:[a.jsx(hl,{className:"w-4 h-4"}),"Analysis Details"]})]},ne._id))})]})]})]})}function SZ(){var D,H,B,ne,ae,Z,te,ie,ue,Ne,be,Q;const{id:u}=Lh(),f=Ga(),[x,_]=j.useState(null),[E,y]=j.useState(!0);if(j.useEffect(()=>{(async()=>{try{const{data:he}=await qr.getReport(u);_(he.report)}catch{Ve.error("Failed to load report")}finally{y(!1)}})()},[u]),E)return a.jsx("div",{className:"flex items-center justify-center h-screen bg-slate-50",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-blue-500/20 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-500 font-medium",children:"Analyzing Report..."})]})});if(!x)return a.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-slate-50 px-6",children:[a.jsx(lc,{className:"w-16 h-16 text-amber-500 mb-4"}),a.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-2",children:"Report Not Found"}),a.jsx("p",{className:"text-slate-500 text-center mb-6",children:"We couldn't find the report you're looking for."}),a.jsx("button",{onClick:()=>f("/dashboard"),className:"w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg",children:"Back to Dashboard"})]});const{aiAnalysis:R}=x,P=(R==null?void 0:R.metrics)||{},U=Object.entries(P),G={good:U.filter(([pe,he])=>he.status==="normal").length,moderate:U.filter(([pe,he])=>he.status==="borderline"||he.status==="moderate").length,low:U.filter(([pe,he])=>he.status==="low"||he.status==="high").length},F=pe=>pe==="normal"||pe==="good"?"emerald":pe==="borderline"||pe==="moderate"?"amber":"red",k=()=>{const pe=`Check out my ${x.reportType} health report analysis! Health Score: ${R==null?void 0:R.healthScore}/100`,he=window.location.href;navigator.share?navigator.share({title:"Health Report Analysis",text:pe,url:he}).catch(()=>{window.open(`https://wa.me/?text=${encodeURIComponent(pe+" "+he)}`,"_blank")}):window.open(`https://wa.me/?text=${encodeURIComponent(pe+" "+he)}`,"_blank")},X=()=>{const pe=`Health Report Analysis: ${x.reportType}`,he=`Hi,

I've analyzed my ${x.reportType} report.

Summary: ${R==null?void 0:R.summary}

Health Score: ${R==null?void 0:R.healthScore}/100

View details: ${window.location.href}`;window.location.href=`mailto:?subject=${encodeURIComponent(pe)}&body=${encodeURIComponent(he)}`},q=()=>{window.print()};return a.jsxs("div",{className:"min-h-screen pb-20 font-sans",children:[a.jsx("div",{className:"px-6 pt-8 pb-4 flex items-center justify-between sticky top-0 backdrop-blur-md z-10",children:a.jsxs(Rt,{to:"/dashboard",className:"flex items-center gap-2 text-purple-600 font-bold text-xs tracking-[0.1em]",children:[a.jsx(dn,{className:"w-4 h-4"})," BACK TO REPORTS"]})}),a.jsxs("div",{className:"px-6 mb-8 flex items-center justify-between gap-4",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h1",{className:"text-2xl font-black text-[#0F172A] tracking-tight truncate whitespace-nowrap",children:"Report Analysis"}),a.jsx("p",{className:"text-slate-500 font-medium mt-0.5 text-xs",children:"AI-Powered Health Insights"})]}),a.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[a.jsx("button",{onClick:k,className:"p-2.5 bg-white rounded-xl shadow-sm border border-slate-100 text-[#25D366] hover:bg-emerald-50 transition-colors",title:"Share on WhatsApp",children:a.jsx(x2,{className:"w-5 h-5"})}),a.jsx("button",{onClick:X,className:"p-2.5 bg-white rounded-xl shadow-sm border border-slate-100 text-blue-600 hover:bg-blue-50 transition-colors",title:"Share via Email",children:a.jsx(qd,{className:"w-5 h-5"})}),a.jsx("button",{onClick:q,className:"p-2.5 bg-white rounded-xl shadow-sm border border-slate-100 text-slate-600 hover:bg-slate-50 transition-colors",title:"Download PDF",children:a.jsx(jE,{className:"w-5 h-5"})})]})]}),a.jsxs("div",{className:"px-4 space-y-6",children:[a.jsxs("div",{className:"card card-gradient p-8 text-slate-900 shadow-2xl relative overflow-hidden ring-1 ring-white/50",children:[a.jsx("div",{className:"absolute top-0 right-0 w-48 h-48 bg-white/20 rounded-full blur-3xl -mr-20 -mt-20"}),a.jsxs("div",{className:"flex items-center gap-3 mb-6 relative z-10",children:[a.jsx("div",{className:"w-10 h-10 bg-white/40 backdrop-blur-md rounded-xl flex items-center justify-center border border-white/50 shadow-inner",children:a.jsx(un,{className:"w-5 h-5 text-purple-700"})}),a.jsx("span",{className:"text-[10px] font-black tracking-[0.25em] text-slate-800 uppercase",children:"Lab Report"})]}),a.jsxs("h2",{className:"text-2xl font-black mb-4 flex items-center gap-2 overflow-hidden relative z-10",children:[a.jsx("span",{className:"truncate whitespace-nowrap",children:x.reportType}),a.jsxs("span",{className:"text-sm font-bold opacity-60 shrink-0",children:["(",new Date(x.createdAt).toLocaleDateString("en-US",{month:"short",year:"numeric"}),")"]})]}),a.jsxs("div",{className:"space-y-4 relative z-10",children:[a.jsxs("div",{className:"flex items-center gap-3 text-slate-700",children:[a.jsx(Pn,{className:"w-4 h-4 opacity-60"}),a.jsx("span",{className:"text-sm font-bold",children:new Date(x.createdAt).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})})]}),a.jsxs("div",{className:"flex items-center gap-3 text-slate-700 overflow-hidden",children:[a.jsx(eq,{className:"w-4 h-4 opacity-60 shrink-0"}),a.jsxs("span",{className:"text-sm font-bold truncate whitespace-nowrap",children:[x.patientName||"Patient Name",x.patientAge?`  ${x.patientAge}Y`:"",x.patientGender?`  ${x.patientGender}`:""]})]})]}),a.jsx("div",{className:"absolute top-6 right-6 bg-white/40 backdrop-blur-md border border-white/60 rounded-xl px-3 py-1.5 text-center shadow-lg z-10",children:a.jsxs("div",{className:"flex items-center justify-center gap-1.5",children:[a.jsx("span",{className:"w-2 h-2 bg-emerald-500 rounded-full animate-pulse"}),a.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-slate-800",children:"Analyzed"})]})}),a.jsx("div",{className:"absolute bottom-[-20px] right-8 opacity-5",children:a.jsx(un,{className:"w-32 h-32"})})]}),(R==null?void 0:R.summary)&&a.jsxs("div",{className:"card p-8 shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center",children:a.jsx(ms,{className:"w-5 h-5 text-purple-600"})}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Executive Summary"})]}),a.jsx("p",{className:"text-slate-600 leading-relaxed font-bold text-sm mb-6",children:R.summary}),a.jsxs("div",{className:"bg-purple-50/50 rounded-3xl p-6 border border-purple-100",children:[a.jsx("h4",{className:"text-purple-700 font-black text-[10px] uppercase tracking-wider mb-2",children:"Key Insight"}),a.jsx("p",{className:"text-purple-900 text-xs leading-relaxed font-bold",children:((D=R.keyFindings)==null?void 0:D[0])||"Your health markers are generally within range, but some areas require focus."})]})]}),a.jsxs("div",{className:"mt-8",children:[a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase mb-6 px-4",children:"Health Metrics"}),a.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[a.jsxs("div",{className:"bg-white rounded-3xl p-4 text-center border border-slate-100 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-3",children:a.jsx(Hs,{className:"w-5 h-5 text-emerald-500"})}),a.jsx("p",{className:"text-2xl font-black text-slate-800 mb-1",children:G.good}),a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Good"})]}),a.jsxs("div",{className:"bg-white rounded-3xl p-4 text-center border border-slate-100 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-3",children:a.jsx(hn,{className:"w-5 h-5 text-amber-500"})}),a.jsx("p",{className:"text-2xl font-black text-slate-800 mb-1",children:G.moderate}),a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Moderate"})]}),a.jsxs("div",{className:"bg-white rounded-3xl p-4 text-center border border-slate-100 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-3",children:a.jsx(lc,{className:"w-5 h-5 text-red-500"})}),a.jsx("p",{className:"text-2xl font-black text-slate-800 mb-1",children:G.low}),a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Low"})]})]}),a.jsx("div",{className:"space-y-4",children:U.map(([pe,he])=>{const Ae=F(he.status);return a.jsxs("div",{className:`card p-6 border-2 border-${Ae}-100 relative overflow-hidden`,children:[a.jsx("div",{className:`absolute top-0 right-0 w-24 h-24 bg-${Ae}-500/5 rounded-full -mr-12 -mt-12`}),a.jsxs("div",{className:"flex justify-between items-start mb-4 relative z-1",children:[a.jsxs("div",{children:[a.jsxs("h4",{className:"text-base font-black text-slate-800 flex items-center gap-2",children:[pe.replace(/([A-Z])/g," $1"),he.status!=="normal"&&a.jsx(lc,{className:`w-4 h-4 text-${Ae}-500`}),he.status==="normal"&&a.jsx(Hs,{className:"w-4 h-4 text-emerald-500"})]}),a.jsxs("p",{className:"text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1",children:["Range: ",he.normalRange," ",he.unit]})]}),a.jsx("div",{className:`px-2.5 py-1 bg-${Ae}-100/80 text-${Ae}-700 rounded-full flex items-center gap-1 border border-${Ae}-200`,children:a.jsx("span",{className:"text-[9px] font-black uppercase tracking-widest",children:he.status})})]}),a.jsxs("div",{className:"flex items-baseline gap-2 relative z-1",children:[a.jsx("span",{className:`text-3xl font-black text-${Ae}-600`,children:he.value}),a.jsx("span",{className:"text-slate-400 font-bold text-xs tracking-tight uppercase",children:he.unit})]})]},pe)})})]}),((H=R==null?void 0:R.deficiencies)==null?void 0:H.length)>0&&a.jsxs("div",{className:"mt-12 bg-[#FFF8F8] rounded-[2.5rem] p-8 border border-red-100 shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-8",children:[a.jsx(lc,{className:"w-6 h-6 text-red-500"}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Deficiencies Detected"})]}),a.jsx("div",{className:"space-y-6",children:R.deficiencies.map((pe,he)=>{var Ae;return a.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-md border-2 border-red-50 relative overflow-hidden",children:[a.jsx("div",{className:"absolute top-0 left-0 w-1.5 h-full bg-red-500"}),a.jsxs("div",{className:"flex justify-between items-start mb-4",children:[a.jsx("h4",{className:"font-black text-[#0F172A] text-lg",children:pe.name}),a.jsx("span",{className:`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${pe.severity==="severe"?"bg-red-100 text-red-600":"bg-amber-100 text-amber-600"}`,children:pe.severity||"Moderate"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[a.jsxs("div",{className:"bg-slate-50 p-2.5 rounded-2xl border border-slate-100",children:[a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1",children:"Current Level"}),a.jsx("p",{className:"text-base font-black text-slate-800",children:pe.currentValue||"N/A"})]}),a.jsxs("div",{className:"bg-slate-50 p-2.5 rounded-2xl border border-slate-100",children:[a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1",children:"Normal Range"}),a.jsx("p",{className:"text-base font-black text-slate-600",children:pe.normalRange||"N/A"})]})]}),((Ae=pe.symptoms)==null?void 0:Ae.length)>0&&a.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100",children:[a.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2",children:"Check for these symptoms"}),a.jsx("div",{className:"flex flex-wrap gap-1.5",children:pe.symptoms.map((fe,le)=>a.jsx("span",{className:"px-2 py-1 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-lg border border-blue-100",children:fe},le))})]})]},he)})})]}),(R==null?void 0:R.dietPlan)&&a.jsxs("div",{className:"mt-12 bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx(Ji,{className:"w-6 h-6 text-emerald-500"}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Personalized Diet Plan"})]}),a.jsx("p",{className:"text-slate-500 font-medium text-sm leading-relaxed mb-8",children:"Based on your deficiencies and fitness goals, we've curated a nutrition plan to help restore optimal levels through natural food sources."}),a.jsx("div",{className:"space-y-6",children:[{label:"Breakfast Recommendatons",items:((B=R.dietPlan.breakfast)==null?void 0:B.slice(0,4))||[],color:"blue"},{label:"Lunch Options",items:((ne=R.dietPlan.lunch)==null?void 0:ne.slice(0,4))||[],color:"emerald"},{label:"Dinner Suggestions",items:((ae=R.dietPlan.dinner)==null?void 0:ae.slice(0,4))||[],color:"purple"},{label:"Healthy Snacks",items:((Z=R.dietPlan.snacks)==null?void 0:Z.slice(0,4))||[],color:"amber"}].map((pe,he)=>pe.items.length>0&&a.jsxs("div",{className:"bg-slate-50 rounded-3xl p-6 border border-slate-200/50",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(tq,{className:`w-4 h-4 text-${pe.color}-500`}),a.jsx("h4",{className:"font-extrabold text-slate-800 text-sm uppercase tracking-tight",children:pe.label})]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:pe.items.map((Ae,fe)=>a.jsx("div",{className:"px-4 py-2 bg-white rounded-2xl text-xs font-bold text-slate-800 border border-slate-200/60 shadow-sm",children:Ae.meal||Ae},fe))})]},he))})]}),(((ie=(te=R==null?void 0:R.recommendations)==null?void 0:te.lifestyle)==null?void 0:ie.length)>0||((Ne=(ue=R==null?void 0:R.dietPlan)==null?void 0:ue.tips)==null?void 0:Ne.length)>0)&&a.jsxs("div",{className:"mt-12 bg-[#F0FDF4] rounded-[2.5rem] p-8 border border-emerald-100 shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-8",children:[a.jsx(ms,{className:"w-6 h-6 text-emerald-600"}),a.jsx("h3",{className:"text-lg font-black text-[#0F172A] tracking-tight uppercase",children:"Personalized Health Tips"})]}),a.jsx("div",{className:"space-y-4",children:(((be=R.recommendations)==null?void 0:be.lifestyle)||((Q=R.dietPlan)==null?void 0:Q.tips)||[]).map((pe,he)=>a.jsxs("div",{className:"bg-white rounded-3xl p-6 flex gap-4 shadow-sm border border-slate-100 group relative overflow-hidden",children:[a.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-blue-400 to-blue-600"}),a.jsx("div",{className:"w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center shrink-0",children:a.jsx(zr,{className:"w-5 h-5 text-blue-500"})}),a.jsxs("div",{children:[a.jsxs("h4",{className:"font-black text-xs uppercase tracking-[0.15em] text-slate-400 mb-1",children:["Recommendation ",he+1]}),a.jsx("p",{className:"text-sm text-slate-700 leading-relaxed font-bold",children:pe})]})]},he))})]}),a.jsx("div",{className:"mt-12 px-8 pb-8 text-center",children:a.jsx("p",{className:"text-slate-400 text-xs leading-relaxed font-medium",children:"Disclaimer: This AI analysis is for informational wellness support only and should not replace professional medical advice. Always consult with a healthcare provider."})})]})]})}const NZ=["All","General Physician","Nutritionist","Cardiologist","Dermatologist","Endocrinologist","Neurologist"];function TZ(){var Ae,fe,le,we;const u=Ga(),[f,x]=j.useState([]),[_,E]=j.useState([]),[y,R]=j.useState(!0),[P,U]=j.useState("All"),[G,F]=j.useState(""),[k,X]=j.useState(null),[q,D]=j.useState({date:"",timeSlot:"",symptoms:""}),[H,B]=j.useState(!1),[ne,ae]=j.useState("doctors"),[Z,te]=j.useState([]),[ie,ue]=j.useState(!1);j.useEffect(()=>{Ne()},[P]);const Ne=async()=>{try{const re={};P!=="All"&&(re.specialization=P);const[oe,J]=await Promise.all([sr.getAll(re),sr.getAppointments()]);x(oe.data),E(J.data)}catch(re){console.error("Failed to fetch data:",re)}finally{R(!1)}};j.useEffect(()=>{k&&q.date&&be()},[k,q.date]);const be=async()=>{var re;if(!(!k||!q.date)){ue(!0);try{const{data:oe}=await sr.getDoctorAvailableSlots(k._id);console.log("Slots response:",oe);const J=new Date(q.date).toDateString();console.log("Looking for dateKey:",J),console.log("Available keys:",Object.keys(oe.slotsByDate||{})),te(((re=oe.slotsByDate)==null?void 0:re[J])||[])}catch(oe){console.error("Failed to fetch slots:",oe),te([])}finally{ue(!1)}}},Q=f.filter(re=>{var oe,J,Oe;return((J=re.name||((oe=re.user)==null?void 0:oe.name))==null?void 0:J.toLowerCase().includes(G.toLowerCase()))||((Oe=re.specialization)==null?void 0:Oe.toLowerCase().includes(G.toLowerCase()))}),pe=async re=>{var oe,J;if(re.preventDefault(),!q.date||!q.timeSlot){Ve.error("Please select date and time");return}B(!0);try{await sr.bookAppointment({doctorId:k._id,...q,type:"video"}),Ve.success("Appointment booked successfully!"),X(null),D({date:"",timeSlot:"",symptoms:""}),te([]),Ne()}catch(Oe){Ve.error(((J=(oe=Oe.response)==null?void 0:oe.data)==null?void 0:J.message)||"Failed to book appointment")}finally{B(!1)}},he=()=>{const re=[];for(let oe=0;oe<7;oe++){const J=new Date;J.setDate(J.getDate()+oe),re.push({value:J.toISOString().split("T")[0],label:J.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),isToday:oe===0})}return re};return a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"Find Doctors"}),a.jsx("p",{className:"text-slate-500 mt-1",children:"Book video consultations with healthcare specialists"})]}),a.jsxs("div",{className:"flex gap-2 p-1 bg-slate-100 rounded-xl w-fit",children:[a.jsxs("button",{onClick:()=>ae("doctors"),className:`flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium transition-all ${ne==="doctors"?"bg-white text-slate-800 shadow-sm":"text-slate-500 hover:text-slate-700"}`,children:[a.jsx($i,{className:"w-4 h-4"})," Find Doctors"]}),a.jsxs("button",{onClick:()=>ae("appointments"),className:`flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium transition-all ${ne==="appointments"?"bg-white text-slate-800 shadow-sm":"text-slate-500 hover:text-slate-700"}`,children:[a.jsx(Pn,{className:"w-4 h-4"})," My Appointments",_.length>0&&a.jsx("span",{className:"ml-1 px-2 py-0.5 bg-cyan-100 text-cyan-600 text-xs rounded-full",children:_.length})]})]}),ne==="doctors"&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"bg-white rounded-2xl border border-slate-200 p-4 shadow-sm",children:a.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[a.jsxs("div",{className:"relative flex-1",children:[a.jsx(ng,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),a.jsx("input",{type:"text",placeholder:"Search doctors...",value:G,onChange:re=>F(re.target.value),className:"w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none"})]}),a.jsx("select",{value:P,onChange:re=>U(re.target.value),className:"px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:border-cyan-500 focus:outline-none",children:NZ.map(re=>a.jsx("option",{value:re,children:re},re))})]})}),y?a.jsxs("div",{className:"text-center py-12",children:[a.jsx("div",{className:"w-10 h-10 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto"}),a.jsx("p",{className:"text-slate-500 mt-4",children:"Loading doctors..."})]}):Q.length>0?a.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:Q.map(re=>{var J,Oe,$e;const oe=re.name||((J=re.user)==null?void 0:J.name)||"Doctor";return a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition-all",children:[a.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[a.jsx("div",{className:"w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-xl font-bold text-white",children:(Oe=oe[0])==null?void 0:Oe.toUpperCase()}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("h3",{className:"font-semibold text-slate-800",children:["Dr. ",oe]}),a.jsx("p",{className:"text-sm text-cyan-600 font-medium",children:re.specialization}),a.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[a.jsx(wo,{className:"w-4 h-4 text-amber-400 fill-amber-400"}),a.jsx("span",{className:"text-sm text-slate-600",children:(($e=re.rating)==null?void 0:$e.toFixed(1))||"4.5"}),a.jsx("span",{className:"text-slate-300",children:""}),a.jsxs("span",{className:"text-sm text-slate-500",children:[re.experience||5,"+ yrs"]})]})]})]}),a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-slate-100",children:[a.jsxs("div",{children:[a.jsxs("span",{className:"text-xl font-bold text-slate-800",children:["",re.consultationFee||500]}),a.jsx("span",{className:"text-sm text-slate-500",children:" / session"})]}),a.jsx("button",{onClick:()=>X(re),className:"px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-medium rounded-xl hover:shadow-lg transition-all",children:"Book Now"})]})]},re._id)})}):a.jsxs("div",{className:"text-center py-12 bg-white rounded-2xl border border-slate-200",children:[a.jsx(ng,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),a.jsx("p",{className:"text-slate-500",children:"No doctors found"})]})]}),ne==="appointments"&&a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-6 shadow-sm",children:[a.jsx("h2",{className:"text-lg font-semibold text-slate-800 mb-4",children:"Your Appointments"}),_.length>0?a.jsx("div",{className:"space-y-3",children:_.map(re=>{var oe,J,Oe,$e,He,ot,_t,Ke;return a.jsx("div",{className:"p-4 bg-slate-50 rounded-xl border border-slate-100",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold",children:((He=($e=((oe=re.doctor)==null?void 0:oe.name)||((Oe=(J=re.doctor)==null?void 0:J.user)==null?void 0:Oe.name))==null?void 0:$e[0])==null?void 0:He.toUpperCase())||"D"}),a.jsxs("div",{children:[a.jsxs("p",{className:"font-medium text-slate-800",children:["Dr. ",((ot=re.doctor)==null?void 0:ot.name)||((Ke=(_t=re.doctor)==null?void 0:_t.user)==null?void 0:Ke.name)]}),a.jsxs("p",{className:"text-sm text-slate-500",children:[new Date(re.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),"  ",re.timeSlot]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${re.status==="completed"?"bg-green-100 text-green-600":re.status==="scheduled"?"bg-amber-100 text-amber-600":"bg-red-100 text-red-600"}`,children:re.status}),re.status==="scheduled"&&a.jsx("button",{onClick:()=>u(`/consultation/${re._id}`),className:"px-3 py-1 bg-cyan-500 text-white text-sm font-medium rounded-lg hover:bg-cyan-600",children:"Join Call"})]})]})},re._id)})}):a.jsxs("div",{className:"text-center py-8",children:[a.jsx(Pn,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),a.jsx("p",{className:"text-slate-500",children:"No appointments yet"}),a.jsx("button",{onClick:()=>ae("doctors"),className:"mt-3 text-cyan-600 font-medium hover:text-cyan-700",children:"Book your first appointment "})]})]}),k&&a.jsx("div",{className:"fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full p-6 shadow-xl animate-slide-up max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"Book Appointment"}),a.jsx("button",{onClick:()=>{X(null),te([]),D({date:"",timeSlot:"",symptoms:""})},className:"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg",children:a.jsx(ra,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"flex items-center gap-4 p-4 bg-slate-50 rounded-xl mb-6",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold",children:(le=(fe=k.name||((Ae=k.user)==null?void 0:Ae.name))==null?void 0:fe[0])==null?void 0:le.toUpperCase()}),a.jsxs("div",{children:[a.jsxs("p",{className:"font-semibold text-slate-800",children:["Dr. ",k.name||((we=k.user)==null?void 0:we.name)]}),a.jsx("p",{className:"text-sm text-cyan-600",children:k.specialization})]})]}),a.jsxs("form",{onSubmit:pe,className:"space-y-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Select Date"}),a.jsx("div",{className:"grid grid-cols-4 gap-2",children:he().map(re=>a.jsxs("button",{type:"button",onClick:()=>D({...q,date:re.value,timeSlot:""}),className:`p-2 rounded-xl text-center transition-all ${q.date===re.value?"bg-cyan-500 text-white":"bg-slate-50 text-slate-600 hover:bg-slate-100 border border-slate-200"}`,children:[a.jsx("div",{className:"text-xs font-medium",children:re.label.split(" ")[0]}),a.jsx("div",{className:"text-sm font-bold",children:re.label.split(" ")[2]})]},re.value))})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Select Time"}),ie?a.jsxs("div",{className:"flex items-center justify-center py-6",children:[a.jsx("div",{className:"w-6 h-6 border-2 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"}),a.jsx("span",{className:"ml-2 text-slate-500 text-sm",children:"Loading slots..."})]}):Z.length>0?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:Z.map(re=>{const oe=q.timeSlot===re.timeSlot,J=re.status==="passed",Oe=re.status==="booked",$e=re.status==="blocked",He=re.status==="available";return a.jsxs("button",{type:"button",onClick:()=>He&&D({...q,timeSlot:re.timeSlot}),disabled:!He,className:`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${oe?"bg-cyan-500 text-white ring-2 ring-cyan-300":J?"bg-slate-100 text-slate-400 cursor-not-allowed line-through":Oe?"bg-red-50 text-red-400 cursor-not-allowed border border-red-200":$e?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-emerald-100 text-emerald-600 border border-emerald-200 hover:bg-emerald-200 cursor-pointer"}`,title:J?"Time passed":Oe?"Already booked":$e?"Not available":"Available",children:[re.timeSlot,Oe&&a.jsx("span",{className:"ml-1 text-xs",children:"(Booked)"})]},re.timeSlot)})}),a.jsxs("div",{className:"flex flex-wrap gap-3 text-xs text-slate-500",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 rounded-full bg-emerald-100 border border-emerald-300"})," Available"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 rounded-full bg-red-50 border border-red-200"})," Booked"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 rounded-full bg-slate-100 border border-slate-200"})," Passed/Unavailable"]})]})]}):q.date?a.jsxs("div",{className:"text-center py-6 bg-slate-50 rounded-xl",children:[a.jsx(Yr,{className:"w-8 h-8 text-slate-300 mx-auto mb-2"}),a.jsx("p",{className:"text-slate-500 text-sm",children:"No slots available for this date"})]}):a.jsxs("div",{className:"text-center py-6 bg-slate-50 rounded-xl",children:[a.jsx(Pn,{className:"w-8 h-8 text-slate-300 mx-auto mb-2"}),a.jsx("p",{className:"text-slate-500 text-sm",children:"Select a date first"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Symptoms (Optional)"}),a.jsx("textarea",{value:q.symptoms,onChange:re=>D({...q,symptoms:re.target.value}),className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:border-cyan-500 focus:outline-none resize-none",rows:3,placeholder:"Describe your symptoms..."})]}),a.jsxs("div",{className:"p-4 bg-cyan-50 border border-cyan-200 rounded-xl",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(dc,{className:"w-5 h-5 text-cyan-600"}),a.jsx("span",{className:"font-medium text-cyan-700",children:"Video Consultation"})]}),a.jsx("p",{className:"text-xs text-cyan-600 mt-1",children:"You'll receive a video call link via email"})]}),a.jsxs("div",{className:"flex gap-3 pt-2",children:[a.jsx("button",{type:"button",onClick:()=>{X(null),te([])},className:"flex-1 py-3 bg-slate-100 text-slate-700 font-medium rounded-xl hover:bg-slate-200 transition-all",children:"Cancel"}),a.jsx("button",{type:"submit",disabled:H||!q.date||!q.timeSlot,className:"flex-1 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-medium rounded-xl hover:shadow-lg transition-all disabled:opacity-50",children:H?"Booking...":`Confirm  ${k.consultationFee||500}`})]})]})]})})]})}function RZ(){var ue,Ne,be,Q,pe,he,Ae,fe,le,we,re,oe,J,Oe,$e,He,ot,_t,Ke,ht,st,ct,fs,ys,As,zs,je,Ze,Ct,zt,ts;const{user:u,updateUser:f}=ia(),[x]=c2(),[_,E]=j.useState(!1),[y,R]=j.useState(x.get("tab")||"profile"),[P,U]=j.useState(null),[G,F]=j.useState(!1),[k,X]=j.useState({goalType:"maintenance",currentWeight:((ue=u==null?void 0:u.profile)==null?void 0:ue.weight)||"",targetWeight:"",height:((Ne=u==null?void 0:u.profile)==null?void 0:Ne.height)||"",age:((be=u==null?void 0:u.profile)==null?void 0:be.age)||"",gender:((Q=u==null?void 0:u.profile)==null?void 0:Q.gender)||"male",activityLevel:"moderate",dietaryPreference:((pe=u==null?void 0:u.profile)==null?void 0:pe.dietaryPreference)||"non-vegetarian"}),[q,D]=j.useState({name:(u==null?void 0:u.name)||"",profile:{age:((he=u==null?void 0:u.profile)==null?void 0:he.age)||"",gender:((Ae=u==null?void 0:u.profile)==null?void 0:Ae.gender)||"",dietaryPreference:((fe=u==null?void 0:u.profile)==null?void 0:fe.dietaryPreference)||"non-vegetarian",height:((le=u==null?void 0:u.profile)==null?void 0:le.height)||"",weight:((we=u==null?void 0:u.profile)==null?void 0:we.weight)||"",bloodGroup:((re=u==null?void 0:u.profile)==null?void 0:re.bloodGroup)||"",medicalHistory:{conditions:((J=(oe=u==null?void 0:u.profile)==null?void 0:oe.medicalHistory)==null?void 0:J.conditions)||[]},lifestyle:{smoker:(($e=(Oe=u==null?void 0:u.profile)==null?void 0:Oe.lifestyle)==null?void 0:$e.smoker)||!1,alcohol:((ot=(He=u==null?void 0:u.profile)==null?void 0:He.lifestyle)==null?void 0:ot.alcohol)||!1,sleepHours:((Ke=(_t=u==null?void 0:u.profile)==null?void 0:_t.lifestyle)==null?void 0:Ke.sleepHours)||"7",stressLevel:((st=(ht=u==null?void 0:u.profile)==null?void 0:ht.lifestyle)==null?void 0:st.stressLevel)||"moderate",waterIntake:((fs=(ct=u==null?void 0:u.profile)==null?void 0:ct.lifestyle)==null?void 0:fs.waterIntake)||"8"},diabetesProfile:((ys=u==null?void 0:u.profile)==null?void 0:ys.diabetesProfile)||null}});j.useEffect(()=>{(async()=>{try{const We=localStorage.getItem("token"),rt=await ks.get("/api/nutrition/goals",{headers:{Authorization:`Bearer ${We}`}});rt.data.healthGoal&&(U(rt.data.healthGoal),X({goalType:rt.data.healthGoal.goalType,currentWeight:rt.data.healthGoal.currentWeight,targetWeight:rt.data.healthGoal.targetWeight,height:rt.data.healthGoal.height,age:rt.data.healthGoal.age,gender:rt.data.healthGoal.gender,activityLevel:rt.data.healthGoal.activityLevel,dietaryPreference:rt.data.healthGoal.dietaryPreference}))}catch{console.log("No health goal set yet")}})()},[]);const H=ge=>{const{name:We,value:rt,type:ws,checked:Cn}=ge.target;if(We.startsWith("profile.lifestyle.")){const Fe=We.split(".")[2];D(Je=>({...Je,profile:{...Je.profile,lifestyle:{...Je.profile.lifestyle,[Fe]:ws==="checkbox"?Cn:rt}}}))}else if(We.startsWith("profile.diabetesProfile.")){const Fe=We.split(".")[2];D(Je=>({...Je,profile:{...Je.profile,diabetesProfile:{...Je.profile.diabetesProfile,[Fe]:rt}}}))}else if(We.startsWith("profile.")){const Fe=We.split(".")[1];D(Je=>({...Je,profile:{...Je.profile,[Fe]:rt}}))}else D(Fe=>({...Fe,[We]:rt}))},B=async ge=>{var We,rt;ge.preventDefault(),E(!0);try{const ws={name:q.name,profile:{...q.profile,age:q.profile.age?Number(q.profile.age):void 0,height:q.profile.height?Number(q.profile.height):void 0,weight:q.profile.weight?Number(q.profile.weight):void 0,lifestyle:{...q.profile.lifestyle,sleepHours:Number(q.profile.lifestyle.sleepHours),waterIntake:Number(q.profile.lifestyle.waterIntake)}}},{data:Cn}=await et.put("/auth/profile",ws);f(Cn),Ve.success("Profile updated successfully!")}catch(ws){Ve.error(((rt=(We=ws.response)==null?void 0:We.data)==null?void 0:rt.message)||"Failed to update profile")}finally{E(!1)}},ne=async ge=>{var We,rt;ge.preventDefault(),F(!0);try{const ws=localStorage.getItem("token"),Cn={...k,currentWeight:Number(k.currentWeight),targetWeight:Number(k.targetWeight),height:Number(k.height),age:Number(k.age)},Fe=await ks.post("/api/nutrition/goals",Cn,{headers:{Authorization:`Bearer ${ws}`}});U(Fe.data.healthGoal),Ve.success("Fitness goal set successfully! Your daily targets have been calculated.")}catch(ws){Ve.error(((rt=(We=ws.response)==null?void 0:We.data)==null?void 0:rt.message)||"Failed to set fitness goal")}finally{F(!1)}},ae=ge=>{const{name:We,value:rt}=ge.target;X(ws=>({...ws,[We]:rt}))},Z=q.profile.height&&q.profile.weight?(q.profile.weight/Math.pow(q.profile.height/100,2)).toFixed(1):null,ie=(ge=>ge?ge<18.5?{label:"Underweight",color:"blue"}:ge<25?{label:"Normal",color:"emerald"}:ge<30?{label:"Overweight",color:"amber"}:{label:"Obese",color:"red"}:{label:"N/A",color:"slate"})(parseFloat(Z));return a.jsxs("div",{className:"w-full overflow-x-hidden space-y-6 animate-fade-in px-3 md:px-6",children:[a.jsxs("div",{className:"md:hidden flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-md flex-shrink-0",children:((zs=(As=u==null?void 0:u.name)==null?void 0:As[0])==null?void 0:zs.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const ge=new Date().getHours();return ge<12?"Good Morning":ge<18?"Good Afternoon":"Good Evening"})(),", ",((je=u==null?void 0:u.name)==null?void 0:je.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),a.jsxs("div",{className:"hidden md:block",children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"My Profile"}),a.jsx("p",{className:"text-slate-500 mt-1",children:"Manage your information and track health progress"})]}),a.jsxs("div",{className:"bg-gradient-to-r from-cyan-500 to-blue-500 rounded-2xl p-3 md:p-6 text-white relative overflow-hidden shadow-lg",children:[a.jsx("div",{className:"absolute inset-0 opacity-10",children:a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white rounded-full -translate-y-1/2 translate-x-1/2"})}),a.jsxs("div",{className:"relative flex flex-col gap-4 md:gap-6",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-4 md:gap-6",children:[a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"w-16 h-16 md:w-20 md:h-20 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-2xl md:text-3xl font-bold",children:(Ct=(Ze=u==null?void 0:u.name)==null?void 0:Ze[0])==null?void 0:Ct.toUpperCase()}),a.jsx("button",{className:"absolute -bottom-2 -right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center text-cyan-600 shadow-lg hover:scale-110 transition-transform",children:a.jsx(FE,{className:"w-4 h-4"})})]}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h2",{className:"text-xl md:text-2xl font-bold",children:u==null?void 0:u.name}),a.jsxs("div",{className:"flex flex-col gap-2 mt-2 text-white/90 text-sm md:text-base",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(qd,{className:"w-4 h-4 flex-shrink-0"})," ",u==null?void 0:u.email]}),(u==null?void 0:u.phone)&&a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(BE,{className:"w-4 h-4 flex-shrink-0"})," ",u==null?void 0:u.phone]})]})]})]}),a.jsxs("div",{className:"flex gap-3 md:gap-4",children:[a.jsxs("div",{className:"text-center p-3 md:p-4 bg-white/10 backdrop-blur-sm rounded-xl flex-1",children:[a.jsx("p",{className:"text-2xl md:text-3xl font-bold",children:((zt=u==null?void 0:u.healthMetrics)==null?void 0:zt.healthScore)||"--"}),a.jsx("p",{className:"text-xs md:text-sm text-white/80",children:"Health Score"})]}),Z&&a.jsxs("div",{className:"text-center p-3 md:p-4 bg-white/10 backdrop-blur-sm rounded-xl flex-1",children:[a.jsx("p",{className:"text-2xl md:text-3xl font-bold",children:Z}),a.jsx("p",{className:"text-xs md:text-sm text-white/80",children:"BMI"})]})]})]})]}),a.jsx(NQ,{}),a.jsx("div",{className:"flex gap-1 md:gap-2 p-1 bg-slate-100 rounded-xl w-full md:w-fit overflow-x-auto",children:[{id:"profile",label:"Profile",icon:$i},{id:"goals",label:"Set Goal",icon:vr}].map(ge=>a.jsxs("button",{onClick:()=>R(ge.id),className:`flex items-center gap-1 md:gap-2 px-3 md:px-5 py-2 md:py-2.5 rounded-lg font-medium transition-all whitespace-nowrap text-sm md:text-base ${y===ge.id?"bg-white text-slate-800 shadow-sm":"text-slate-600 hover:text-slate-800"}`,children:[a.jsx(ge.icon,{className:"w-4 h-4"}),ge.label]},ge.id))}),y==="profile"&&a.jsxs("form",{onSubmit:B,className:"grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6",children:[a.jsxs("div",{className:"lg:col-span-2 space-y-4 md:space-y-6",children:[a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsxs("h3",{className:"text-base md:text-lg font-bold text-slate-800 mb-4 md:mb-6 flex items-center gap-2",children:[a.jsx($i,{className:"w-5 h-5 text-cyan-500"}),"Basic Information"]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Full Name"}),a.jsx("input",{type:"text",name:"name",value:q.name,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",required:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Email"}),a.jsx("input",{type:"email",value:u==null?void 0:u.email,className:"w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 text-slate-500",disabled:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Age"}),a.jsx("input",{type:"number",name:"profile.age",value:q.profile.age,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",min:"1",max:"120",placeholder:"Enter your age"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Gender"}),a.jsxs("select",{name:"profile.gender",value:q.profile.gender,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",children:[a.jsx("option",{value:"",children:"Select gender"}),a.jsx("option",{value:"male",children:"Male"}),a.jsx("option",{value:"female",children:"Female"}),a.jsx("option",{value:"other",children:"Other"})]})]}),a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Dietary Preference"}),a.jsxs("select",{name:"profile.dietaryPreference",value:q.profile.dietaryPreference,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",children:[a.jsx("option",{value:"non-vegetarian",children:"Non-Vegetarian"}),a.jsx("option",{value:"vegetarian",children:"Vegetarian"}),a.jsx("option",{value:"vegan",children:"Vegan"}),a.jsx("option",{value:"eggetarian",children:"Eggetarian"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(zn,{className:"w-5 h-5 text-red-500"}),"Health Information"]}),a.jsxs("div",{className:"grid md:grid-cols-3 gap-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Height (cm)"}),a.jsx("input",{type:"number",name:"profile.height",value:q.profile.height,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",min:"50",max:"300",placeholder:"170"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Weight (kg)"}),a.jsx("input",{type:"number",name:"profile.weight",value:q.profile.weight,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",min:"10",max:"500",placeholder:"70"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Blood Group"}),a.jsxs("select",{name:"profile.bloodGroup",value:q.profile.bloodGroup,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",children:[a.jsx("option",{value:"",children:"Select"}),["A+","A-","B+","B-","AB+","AB-","O+","O-"].map(ge=>a.jsx("option",{value:ge,children:ge},ge))]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(hn,{className:"w-5 h-5 text-amber-500"}),"Medical Conditions"]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700",children:["Chronic Conditions ",a.jsx("span",{className:"text-slate-400 font-normal",children:"(comma separated)"})]}),a.jsx("input",{type:"text",name:"profile.medicalHistory.conditions",value:q.profile.medicalHistory.conditions.join(", "),onChange:ge=>{const We=ge.target.value.split(",").map(rt=>rt.trim()).filter(Boolean);D(rt=>({...rt,profile:{...rt.profile,medicalHistory:{...rt.profile.medicalHistory,conditions:We}}}))},className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none",placeholder:"e.g., Diabetes, Hypertension"})]})]}),q.profile.diabetesProfile&&a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(oc,{className:"w-5 h-5 text-purple-500"}),"Diabetes Management"]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Diabetes Type"}),a.jsxs("select",{name:"profile.diabetesProfile.type",value:q.profile.diabetesProfile.type,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4",children:[a.jsx("option",{value:"Type 1",children:"Type 1"}),a.jsx("option",{value:"Type 2",children:"Type 2"}),a.jsx("option",{value:"Prediabetes",children:"Prediabetes"}),a.jsx("option",{value:"Gestational",children:"Gestational"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"HbA1c Level (%)"}),a.jsx("input",{type:"number",step:"0.1",name:"profile.diabetesProfile.hba1c",value:q.profile.diabetesProfile.hba1c,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Diagnosis Year"}),a.jsx("input",{type:"number",name:"profile.diabetesProfile.diagnosisYear",value:q.profile.diabetesProfile.diagnosisYear,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Current Status"}),a.jsxs("select",{name:"profile.diabetesProfile.status",value:q.profile.diabetesProfile.status,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4",children:[a.jsx("option",{value:"Controlled",children:"Controlled"}),a.jsx("option",{value:"Uncontrolled",children:"Uncontrolled"}),a.jsx("option",{value:"Newly diagnosed",children:"Newly diagnosed"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(ms,{className:"w-5 h-5 text-green-500"}),"Lifestyle Habits"]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-5",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Sleep Hours"}),a.jsx("input",{type:"number",name:"profile.lifestyle.sleepHours",value:q.profile.lifestyle.sleepHours,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Water Intake (glasses)"}),a.jsx("input",{type:"number",name:"profile.lifestyle.waterIntake",value:q.profile.lifestyle.waterIntake,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Stress Level"}),a.jsxs("select",{name:"profile.lifestyle.stressLevel",value:q.profile.lifestyle.stressLevel,onChange:H,className:"w-full bg-white border border-slate-300 rounded-xl py-3 px-4 text-slate-800 focus:border-cyan-500",children:[a.jsx("option",{value:"low",children:"Low"}),a.jsx("option",{value:"moderate",children:"Moderate"}),a.jsx("option",{value:"high",children:"High"})]})]}),a.jsxs("div",{className:"flex flex-col gap-4 justify-center",children:[a.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[a.jsx("input",{type:"checkbox",name:"profile.lifestyle.smoker",checked:q.profile.lifestyle.smoker,onChange:H,className:"w-5 h-5 text-cyan-500 rounded border-slate-300 focus:ring-cyan-500"}),a.jsx("span",{className:"text-slate-700 font-medium",children:"Smoker"})]}),a.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[a.jsx("input",{type:"checkbox",name:"profile.lifestyle.alcohol",checked:q.profile.lifestyle.alcohol,onChange:H,className:"w-5 h-5 text-cyan-500 rounded border-slate-300 focus:ring-cyan-500"}),a.jsx("span",{className:"text-slate-700 font-medium",children:"Consume Alcohol"})]})]})]})]}),a.jsx("button",{type:"submit",disabled:_,className:"w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50",children:_?a.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}):a.jsxs(a.Fragment,{children:[a.jsx(b2,{className:"w-5 h-5"}),"Save Changes"]})})]}),a.jsxs("div",{className:"space-y-6",children:[Z&&a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-4",children:"BMI Calculator"}),a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:`w-24 h-24 rounded-full bg-${ie.color}-100 flex items-center justify-center mx-auto mb-4`,children:a.jsx("span",{className:`text-3xl font-bold text-${ie.color}-600`,children:Z})}),a.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium bg-${ie.color}-100 text-${ie.color}-700`,children:ie.label})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-4",children:"Quick Stats"}),a.jsx("div",{className:"space-y-3",children:a.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 rounded-xl",children:[a.jsx("span",{className:"text-slate-600",children:"Subscription"}),a.jsx("span",{className:"px-2 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-medium capitalize",children:((ts=u==null?void 0:u.subscription)==null?void 0:ts.plan)||"Free"})]})})]})]})]}),y==="goals"&&a.jsxs("form",{onSubmit:ne,className:"max-w-4xl space-y-6",children:[P&&a.jsxs("div",{className:"bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl border-2 border-blue-200 p-3 md:p-6 shadow-sm w-full overflow-hidden",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3 md:gap-4 mb-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-lg md:text-xl font-bold text-blue-900 mb-1",children:"Your Current Goal"}),a.jsx("p",{className:"text-xs md:text-sm text-blue-700",children:"Daily targets calculated based on your goal"})]}),a.jsx("div",{className:"px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold capitalize text-sm md:text-base whitespace-nowrap",children:P.goalType.replace("_"," ")})]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mt-4",children:[a.jsxs("div",{className:"bg-white p-2 md:p-4 rounded-xl",children:[a.jsx("p",{className:"text-xs md:text-sm text-slate-600 mb-1",children:"Daily Calories"}),a.jsx("p",{className:"text-lg md:text-2xl font-bold text-slate-800 truncate",children:P.dailyCalorieTarget})]}),a.jsxs("div",{className:"bg-white p-2 md:p-4 rounded-xl",children:[a.jsx("p",{className:"text-xs md:text-sm text-slate-600 mb-1",children:"Protein"}),a.jsxs("p",{className:"text-lg md:text-2xl font-bold text-slate-800 truncate",children:[P.macroTargets.protein,"g"]})]}),a.jsxs("div",{className:"bg-white p-2 md:p-4 rounded-xl",children:[a.jsx("p",{className:"text-xs md:text-sm text-slate-600 mb-1",children:"Carbs"}),a.jsxs("p",{className:"text-lg md:text-2xl font-bold text-slate-800 truncate",children:[P.macroTargets.carbs,"g"]})]}),a.jsxs("div",{className:"bg-white p-2 md:p-4 rounded-xl",children:[a.jsx("p",{className:"text-xs md:text-sm text-slate-600 mb-1",children:"Fats"}),a.jsxs("p",{className:"text-lg md:text-2xl font-bold text-slate-800 truncate",children:[P.macroTargets.fats,"g"]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-3 md:p-6 shadow-sm",children:[a.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:P?"Update Your Fitness Goal":"Set Your Fitness Goal"}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Goal Type"}),a.jsxs("select",{name:"goalType",value:k.goalType,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,children:[a.jsx("option",{value:"weight_loss",children:"Weight Loss (Fat Loss)"}),a.jsx("option",{value:"muscle_gain",children:"Muscle Gain (Bulking)"}),a.jsx("option",{value:"weight_gain",children:"Weight Gain"}),a.jsx("option",{value:"maintenance",children:"Maintenance"}),a.jsx("option",{value:"health_improvement",children:"Health Improvement"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Activity Level"}),a.jsxs("select",{name:"activityLevel",value:k.activityLevel,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,children:[a.jsx("option",{value:"sedentary",children:"Sedentary (Little or no exercise)"}),a.jsx("option",{value:"light",children:"Light (Exercise 1-3 days/week)"}),a.jsx("option",{value:"moderate",children:"Moderate (Exercise 3-5 days/week)"}),a.jsx("option",{value:"active",children:"Active (Exercise 6-7 days/week)"}),a.jsx("option",{value:"very_active",children:"Very Active (Hard exercise daily)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Current Weight (kg)"}),a.jsx("input",{type:"number",name:"currentWeight",value:k.currentWeight,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,min:"30",max:"300",step:"0.1"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Target Weight (kg)"}),a.jsx("input",{type:"number",name:"targetWeight",value:k.targetWeight,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,min:"30",max:"300",step:"0.1"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Height (cm)"}),a.jsx("input",{type:"number",name:"height",value:k.height,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,min:"100",max:"250"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Age"}),a.jsx("input",{type:"number",name:"age",value:k.age,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,min:"10",max:"120"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Gender"}),a.jsxs("select",{name:"gender",value:k.gender,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,children:[a.jsx("option",{value:"male",children:"Male"}),a.jsx("option",{value:"female",children:"Female"}),a.jsx("option",{value:"other",children:"Other"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Dietary Preference"}),a.jsxs("select",{name:"dietaryPreference",value:k.dietaryPreference,onChange:ae,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent",required:!0,children:[a.jsx("option",{value:"vegetarian",children:"Vegetarian"}),a.jsx("option",{value:"vegan",children:"Vegan"}),a.jsx("option",{value:"non-vegetarian",children:"Non-Vegetarian"}),a.jsx("option",{value:"eggetarian",children:"Eggetarian"})]})]})]}),a.jsxs("button",{type:"submit",disabled:G,className:"mt-6 w-full md:w-auto px-8 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg font-medium hover:shadow-lg disabled:opacity-50 flex items-center justify-center gap-2",children:[a.jsx(vr,{className:"w-5 h-5"}),G?"Calculating...":P?"Update Goal":"Set Goal & Calculate Targets"]})]}),a.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4",children:a.jsxs("div",{className:"flex gap-3",children:[a.jsx(hn,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-medium text-blue-900 mb-1",children:"How it works (Scientifically Backed)"}),a.jsxs("p",{className:"text-sm text-blue-700 mb-2",children:["We use the ",a.jsx("strong",{children:"Mifflin-St Jeor equation"})," (industry standard used by WHO, fitness apps, and hospitals) to calculate your BMR:"]}),a.jsxs("p",{className:"text-xs text-blue-600 font-mono mb-2",children:["Male: BMR = (10  weight) + (6.25  height)  (5  age) + 5",a.jsx("br",{}),"Female: BMR = (10  weight) + (6.25  height)  (5  age)  161"]}),a.jsx("p",{className:"text-sm text-blue-700 mb-2",children:"Then we calculate TDEE (Total Daily Energy Expenditure) by multiplying BMR with your activity level, and adjust calories based on your goal:"}),a.jsxs("ul",{className:"text-xs text-blue-600 space-y-1 ml-4",children:[a.jsx("li",{children:" Muscle Gain: +350 calories"}),a.jsx("li",{children:" Fat Loss: -400 calories"}),a.jsx("li",{children:" Maintenance: No adjustment"})]}),a.jsxs("p",{className:"text-sm text-blue-700 mt-2",children:[a.jsx("strong",{children:"Macros:"})," Protein = 1.6g per kg body weight (realistic & sustainable), Fats = 0.8g per kg, Carbs = remaining calories. These targets will be used throughout the platform to track your nutrition and provide personalized recommendations."]})]})]})})]})]})}const nE={name:"John Doe",email:"john@example.com",profile:{age:32,gender:"male",height:175,weight:72,bloodGroup:"O+",allergies:["Penicillin"],chronicConditions:["None"]}},CZ=[{date:"Jul",score:65},{date:"Aug",score:68},{date:"Sep",score:72},{date:"Oct",score:70},{date:"Nov",score:75},{date:"Dec",score:78}],_i={summary:"Overall health is good with some areas needing attention. Blood sugar levels are slightly elevated.",keyFindings:["Hemoglobin levels are normal at 14.2 g/dL","Cholesterol is borderline high at 210 mg/dL","Vitamin D deficiency detected"],riskFactors:["Pre-diabetic blood sugar levels","Sedentary lifestyle indicators"],metrics:{hemoglobin:{value:14.2,unit:"g/dL",status:"normal",normalRange:"12-16"},bloodSugar:{value:115,unit:"mg/dL",status:"borderline",normalRange:"70-100"},cholesterol:{value:210,unit:"mg/dL",status:"borderline",normalRange:"<200"}},recommendations:{diet:[{item:"Leafy Greens",reason:"Rich in iron and vitamins",priority:"high"},{item:"Fatty Fish",reason:"Omega-3 helps reduce cholesterol",priority:"high"},{item:"Nuts & Seeds",reason:"Good fats for heart health",priority:"medium"}],exercise:[{activity:"Brisk Walking",duration:"30 mins",frequency:"daily",reason:"Improves cardiovascular health"},{activity:"Strength Training",duration:"20 mins",frequency:"3x/week",reason:"Builds muscle"}]},doctorConsultation:{specializations:["Endocrinologist","Cardiologist"],reason:"Blood sugar and cholesterol need monitoring"}},OE=[{_id:"1",name:"Dr. Sarah Johnson",specialization:"Cardiologist",experience:12,fee:800,rating:4.8,reviews:124,hospital:"City Heart Hospital",available:!0,slots:["09:00 AM","10:00 AM","11:00 AM","02:00 PM","03:00 PM"]},{_id:"2",name:"Dr. Raj Patel",specialization:"Endocrinologist",experience:15,fee:900,rating:4.9,reviews:89,hospital:"Diabetes Care Center",available:!0,slots:["10:00 AM","11:00 AM","04:00 PM","05:00 PM"]},{_id:"3",name:"Dr. Emily Chen",specialization:"General Physician",experience:8,fee:500,rating:4.7,reviews:156,hospital:"Family Health Clinic",available:!0,slots:["09:00 AM","10:00 AM","02:00 PM","03:00 PM","04:00 PM"]},{_id:"4",name:"Dr. Michael Brown",specialization:"Neurologist",experience:18,fee:1200,rating:4.9,reviews:67,hospital:"Neuro Care Institute",available:!0,slots:["11:00 AM","02:00 PM","03:00 PM"]},{_id:"5",name:"Dr. Priya Sharma",specialization:"Dermatologist",experience:10,fee:600,rating:4.6,reviews:203,hospital:"Skin & Care Clinic",available:!1,slots:[]}],IZ=[{_id:"apt1",doctor:OE[1],date:"2024-12-15",timeSlot:"10:00 AM",status:"confirmed",type:"online",meetLink:"https://meet.healthai.com/apt-xyz123",amountPaid:450}],r2={summary:"Your health has improved since your last checkup.",metricChanges:[{metric:"Health Score",previous:"72",current:"78",change:"improved"},{metric:"Blood Sugar",previous:"125 mg/dL",current:"115 mg/dL",change:"improved"}]},aE={cholesterol:"Your cholesterol level of 210 mg/dL is borderline high. Focus on reducing saturated fats and increasing fiber. Regular exercise helps too.",worried:"No immediate alarm, but attention needed. Blood sugar is pre-diabetic and cholesterol borderline. Lifestyle changes can help. Follow up with specialists.",default:"Your health score is 78/100. Key areas: managing blood sugar and cholesterol through diet and exercise. Ask me anything specific!"},i2=["All","Cardiologist","Endocrinologist","General Physician","Neurologist","Dermatologist","Orthopedic","Pediatrician"],AZ=["Blood Test","X-Ray","MRI","CT Scan","ECG","General Checkup"];function OZ(){const[u,f]=j.useState("dashboard"),[x,_]=j.useState(!1),[E,y]=j.useState([]),[R,P]=j.useState(""),[U,G]=j.useState(!1),[F,k]=j.useState(!1),[X,q]=j.useState(null),[D,H]=j.useState(0),[B,ne]=j.useState({date:"",slot:"",type:"online"}),[ae,Z]=j.useState(OE),[te,ie]=j.useState(IZ),[ue,Ne]=j.useState("All"),[be,Q]=j.useState(""),[pe,he]=j.useState(0),[Ae,fe]=j.useState(null),[le,we]=j.useState(!1),[re,oe]=j.useState({name:"",specialization:"",experience:"",fee:"",hospital:""}),[J,Oe]=j.useState(!1),[$e,He]=j.useState(nE.profile),ot=j.useRef(null);j.useEffect(()=>{var ge;(ge=ot.current)==null||ge.scrollIntoView({behavior:"smooth"})},[E]);const _t=ge=>{if(ge.preventDefault(),!R.trim())return;const We=R.toLowerCase();y(rt=>[...rt,{role:"user",content:R}]),P(""),setTimeout(()=>{const rt=Object.keys(aE).find(ws=>We.includes(ws));y(ws=>[...ws,{role:"assistant",content:aE[rt]||aE.default}])},800)},Ke=()=>{if(D===0)H(1);else if(D===1&&B.date&&B.slot)H(2);else if(D===2){const ge={_id:`apt${Date.now()}`,doctor:X,date:B.date,timeSlot:B.slot,status:"confirmed",type:B.type,meetLink:`https://meet.healthai.com/apt-${Math.random().toString(36).substr(2,9)}`,amountPaid:X.fee/2};ie(We=>[ge,...We]),H(3)}},ht=()=>{q(null),H(0),ne({date:"",slot:"",type:"online"})},st=()=>{pe===0&&Ae&&(he(1),we(!0),setTimeout(()=>{we(!1),he(2)},2500))},ct=()=>{re.name&&re.specialization&&re.fee&&(Z(ge=>[...ge,{...re,_id:`doc${Date.now()}`,rating:4.5,reviews:0,available:!0,slots:["10:00 AM","02:00 PM","04:00 PM"]}]),oe({name:"",specialization:"",experience:"",fee:"",hospital:""}),Oe(!1))},fs=ae.filter(ge=>(ue==="All"||ge.specialization===ue)&&ge.name.toLowerCase().includes(be.toLowerCase())),ys=({trend:ge})=>ge==="improved"?a.jsx(Qn,{className:"w-4 h-4 text-green-600"}):ge==="declined"?a.jsx(fg,{className:"w-4 h-4 text-red-600"}):a.jsx(Xd,{className:"w-4 h-4 text-gray-400"}),As=()=>a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Welcome back, John!"}),a.jsx("p",{className:"text-gray-600",children:"Here's your health overview"})]}),a.jsxs("button",{onClick:()=>f("upload"),className:"btn-primary flex items-center gap-2",children:[a.jsx(Kr,{className:"w-4 h-4"})," Upload Report"]})]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[{icon:ms,color:"primary",label:"Health Score",value:"78/100"},{icon:un,color:"blue",label:"Total Reports",value:"6"},{icon:Qn,color:"green",label:"BMI",value:"23.5"},{icon:Pn,color:"purple",label:"Last Checkup",value:"Dec 5"}].map((ge,We)=>a.jsx("div",{className:"card",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:`w-12 h-12 bg-${ge.color}-100 rounded-xl flex items-center justify-center`,children:a.jsx(ge.icon,{className:`w-6 h-6 text-${ge.color}-600`})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500",children:ge.label}),a.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ge.value})]})]})},We))}),te.length>0&&a.jsxs("div",{className:"card border-2 border-green-200 bg-green-50/30",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx(Pn,{className:"w-5 h-5 text-green-600"})," Upcoming Appointments"]}),te.filter(ge=>ge.status==="confirmed").map(ge=>a.jsxs("div",{className:"bg-white p-4 rounded-xl flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center text-lg font-bold text-primary-600",children:ge.doctor.name[4]}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium",children:ge.doctor.name}),a.jsxs("p",{className:"text-sm text-gray-500",children:[ge.doctor.specialization,"  ",ge.date," at ",ge.timeSlot]})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[ge.type==="online"&&ge.meetLink&&a.jsxs("a",{href:ge.meetLink,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700",children:[a.jsx(dc,{className:"w-4 h-4"})," Join Call"]}),a.jsx("span",{className:"px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium",children:"Confirmed"})]})]},ge._id))]}),a.jsxs("div",{className:"card",children:[a.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Health Score Trend"}),a.jsx(jh,{width:"100%",height:200,children:a.jsxs(_2,{data:CZ,children:[a.jsx(gg,{strokeDasharray:"3 3",stroke:"#f0f0f0"}),a.jsx(xg,{dataKey:"date"}),a.jsx(bg,{domain:[0,100]}),a.jsx(ME,{}),a.jsx(v2,{type:"monotone",dataKey:"score",stroke:"#22c55e",strokeWidth:2,dot:{fill:"#22c55e"}})]})})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"card",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(Ji,{className:"w-5 h-5 text-green-600"}),a.jsx("h3",{className:"font-semibold",children:"Diet Recommendations"})]}),a.jsx("ul",{className:"space-y-2",children:_i.recommendations.diet.map((ge,We)=>a.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-green-500 rounded-full mt-2"}),a.jsxs("span",{children:[a.jsx("strong",{children:ge.item})," - ",ge.reason]})]},We))})]}),a.jsxs("div",{className:"card",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(ag,{className:"w-5 h-5 text-blue-600"}),a.jsx("h3",{className:"font-semibold",children:"Exercise Plan"})]}),a.jsx("ul",{className:"space-y-2",children:_i.recommendations.exercise.map((ge,We)=>a.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"}),a.jsxs("span",{children:[a.jsx("strong",{children:ge.activity})," - ",ge.duration,", ",ge.frequency]})]},We))})]})]}),a.jsx("div",{className:"card border-l-4 border-yellow-500 bg-yellow-50",children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(hn,{className:"w-5 h-5 text-orange-600 mt-0.5"}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold",children:"Doctor Consultation Recommended"}),a.jsx("p",{className:"text-sm text-gray-600 mt-1",children:_i.doctorConsultation.reason}),a.jsxs("p",{className:"text-sm mt-2",children:[a.jsx("strong",{children:"Specialists:"})," ",_i.doctorConsultation.specializations.join(", ")]}),a.jsx("button",{onClick:()=>f("doctors"),className:"btn-primary mt-3 text-sm",children:"Find Doctors"})]})]})})]}),zs=()=>a.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Upload Health Report"}),a.jsx("p",{className:"text-gray-600",children:"Upload your medical report for AI-powered analysis"})]}),pe===0&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Report Type"}),a.jsx("select",{className:"input",children:AZ.map(ge=>a.jsx("option",{children:ge},ge))})]}),a.jsxs("div",{className:"card",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Upload File"}),Ae?a.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-xl",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(un,{className:"w-10 h-10 text-primary-600"}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium",children:Ae.name}),a.jsxs("p",{className:"text-sm text-gray-500",children:[Ae.size," MB"]})]})]}),a.jsx("button",{onClick:()=>fe(null),className:"p-2 text-gray-400 hover:text-red-500",children:a.jsx(ra,{className:"w-5 h-5"})})]}):a.jsxs("div",{onClick:()=>fe({name:"blood_test_report.pdf",size:2.4}),className:"border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer hover:border-primary-400 transition-colors",children:[a.jsx(Kr,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600 mb-2",children:"Drag & drop or click to upload"}),a.jsx("p",{className:"text-sm text-gray-500",children:"PDF, PNG, JPG - max 10MB"})]})]}),a.jsxs("button",{onClick:st,disabled:!Ae,className:"btn-primary w-full flex items-center justify-center gap-2",children:[a.jsx(Kr,{className:"w-5 h-5"})," Analyze Report"]})]}),pe===1&&a.jsxs("div",{className:"card text-center py-12",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-semibold",children:"Analyzing Your Report..."}),a.jsx("p",{className:"text-gray-600 mt-2",children:"Our AI is extracting insights from your report"}),a.jsx("div",{className:"mt-6 space-y-2 text-left max-w-xs mx-auto",children:["Extracting text from PDF...","Analyzing health metrics...","Generating recommendations..."].map((ge,We)=>a.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[a.jsx(cc,{className:"w-4 h-4 text-green-600"}),a.jsx("span",{children:ge})]},We))})]}),pe===2&&a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"card bg-green-50 border-2 border-green-200",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(cc,{className:"w-8 h-8 text-green-600"}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-green-800",children:"Analysis Complete!"}),a.jsx("p",{className:"text-green-700",children:"Your report has been analyzed successfully"})]})]})}),a.jsx("button",{onClick:()=>f("report"),className:"btn-primary w-full",children:"View Full Analysis"})]}),a.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl text-sm text-blue-800",children:[a.jsx("strong",{children:"Note:"})," AI analysis is for informational purposes only. Always consult a healthcare provider."]})]}),je=()=>a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:x?"Manage Doctors":"Find Doctors"}),a.jsx("p",{className:"text-gray-600",children:x?"Add and manage platform doctors":"Book consultations with specialists"})]}),x&&a.jsxs("button",{onClick:()=>Oe(!0),className:"btn-primary flex items-center gap-2",children:[a.jsx(vi,{className:"w-4 h-4"})," Add Doctor"]})]}),a.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[a.jsxs("div",{className:"relative flex-1",children:[a.jsx(ng,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),a.jsx("input",{type:"text",placeholder:"Search doctors...",value:be,onChange:ge=>Q(ge.target.value),className:"input pl-12"})]}),a.jsx("div",{className:"flex gap-2 flex-wrap",children:i2.slice(0,5).map(ge=>a.jsx("button",{onClick:()=>Ne(ge),className:`px-4 py-2 rounded-xl text-sm font-medium transition-colors ${ue===ge?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:ge},ge))})]}),a.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:fs.map(ge=>{var We;return a.jsxs("div",{className:"card hover:shadow-md transition-shadow",children:[a.jsxs("div",{className:"flex items-start gap-4",children:[a.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-xl flex items-center justify-center text-2xl font-bold text-primary-600",children:((We=ge.name.split(" ")[1])==null?void 0:We[0])||ge.name[0]}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"font-semibold text-gray-900",children:ge.name}),a.jsx("p",{className:"text-sm text-primary-600",children:ge.specialization}),a.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[a.jsx(wo,{className:"w-4 h-4 text-yellow-400 fill-yellow-400"}),a.jsx("span",{className:"text-sm font-medium",children:ge.rating}),a.jsxs("span",{className:"text-sm text-gray-500",children:["(",ge.reviews,")"]})]})]})]}),a.jsxs("div",{className:"mt-4 space-y-2 text-sm text-gray-600",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Yr,{className:"w-4 h-4"}),a.jsxs("span",{children:[ge.experience," years experience"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(dE,{className:"w-4 h-4"}),a.jsx("span",{children:ge.hospital})]})]}),a.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["",ge.fee]}),a.jsx("span",{className:"text-sm text-gray-500",children:" / session"})]}),ge.available?a.jsx("button",{onClick:()=>{q(ge),H(0)},className:"btn-primary text-sm",children:"Book Now"}):a.jsx("span",{className:"px-3 py-1.5 bg-gray-100 text-gray-500 rounded-xl text-sm",children:"Unavailable"})]})]},ge._id)})}),J&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-bold",children:"Add New Doctor"}),a.jsx("button",{onClick:()=>Oe(!1),className:"p-2 hover:bg-gray-100 rounded-lg",children:a.jsx(ra,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Doctor Name"}),a.jsx("input",{type:"text",value:re.name,onChange:ge=>oe({...re,name:ge.target.value}),className:"input",placeholder:"Dr. John Smith"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Specialization"}),a.jsxs("select",{value:re.specialization,onChange:ge=>oe({...re,specialization:ge.target.value}),className:"input",children:[a.jsx("option",{value:"",children:"Select"}),i2.slice(1).map(ge=>a.jsx("option",{children:ge},ge))]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Experience (yrs)"}),a.jsx("input",{type:"number",value:re.experience,onChange:ge=>oe({...re,experience:ge.target.value}),className:"input"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fee ()"}),a.jsx("input",{type:"number",value:re.fee,onChange:ge=>oe({...re,fee:ge.target.value}),className:"input"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Hospital/Clinic"}),a.jsx("input",{type:"text",value:re.hospital,onChange:ge=>oe({...re,hospital:ge.target.value}),className:"input"})]}),a.jsx("button",{onClick:ct,className:"btn-primary w-full",children:"Add Doctor"})]})]})})]}),Ze=()=>{var ge;return X&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto",children:[D<3&&a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-bold",children:D===0?"Book Appointment":D===1?"Select Slot":"Payment"}),a.jsx("button",{onClick:ht,className:"p-2 hover:bg-gray-100 rounded-lg",children:a.jsx(ra,{className:"w-5 h-5"})})]}),D===0&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 rounded-xl",children:[a.jsx("div",{className:"w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center text-xl font-bold text-primary-600",children:(ge=X.name.split(" ")[1])==null?void 0:ge[0]}),a.jsxs("div",{children:[a.jsx("p",{className:"font-semibold",children:X.name}),a.jsx("p",{className:"text-sm text-primary-600",children:X.specialization}),a.jsx("p",{className:"text-sm text-gray-500",children:X.hospital})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Consultation Type"}),a.jsx("div",{className:"flex gap-4",children:["online","in-person"].map(We=>a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"radio",name:"type",checked:B.type===We,onChange:()=>ne({...B,type:We}),className:"text-primary-600"}),We==="online"?a.jsxs(a.Fragment,{children:[a.jsx(dc,{className:"w-4 h-4"})," Online"]}):a.jsxs(a.Fragment,{children:[a.jsx(dE,{className:"w-4 h-4"})," In-Person"]})]},We))})]}),a.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl",children:[a.jsxs("p",{className:"text-sm text-blue-800",children:[a.jsx("strong",{children:"Consultation Fee:"})," ",X.fee]}),a.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Pay ",X.fee/2," now to confirm (50% advance)"]})]}),a.jsx("button",{onClick:Ke,className:"btn-primary w-full",children:"Select Date & Time"})]}),D===1&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Date"}),a.jsx("input",{type:"date",value:B.date,onChange:We=>ne({...B,date:We.target.value}),min:new Date().toISOString().split("T")[0],className:"input"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Available Slots"}),a.jsx("div",{className:"grid grid-cols-3 gap-2",children:X.slots.map(We=>a.jsx("button",{onClick:()=>ne({...B,slot:We}),className:`py-2 px-3 rounded-lg text-sm font-medium transition-colors ${B.slot===We?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:We},We))})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:()=>H(0),className:"flex-1 py-2.5 border border-gray-300 rounded-xl font-medium",children:"Back"}),a.jsx("button",{onClick:Ke,disabled:!B.date||!B.slot,className:"flex-1 btn-primary",children:"Continue to Payment"})]})]}),D===2&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl space-y-2",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Doctor"}),a.jsx("span",{className:"font-medium",children:X.name})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Date"}),a.jsx("span",{className:"font-medium",children:B.date})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Time"}),a.jsx("span",{className:"font-medium",children:B.slot})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Type"}),a.jsx("span",{className:"font-medium capitalize",children:B.type})]}),a.jsxs("div",{className:"border-t pt-2 mt-2 flex justify-between",children:[a.jsx("span",{className:"font-semibold",children:"Amount to Pay"}),a.jsxs("span",{className:"font-bold text-primary-600",children:["",X.fee/2]})]})]}),a.jsxs("div",{className:"p-4 border border-gray-200 rounded-xl",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[a.jsx(E2,{className:"w-5 h-5 text-gray-600"}),a.jsx("span",{className:"font-medium",children:"Payment Method"})]}),a.jsx("div",{className:"space-y-2",children:["UPI","Credit/Debit Card","Net Banking"].map(We=>a.jsxs("label",{className:"flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50",children:[a.jsx("input",{type:"radio",name:"payment",defaultChecked:We==="UPI"}),a.jsx("span",{children:We})]},We))})]}),a.jsxs("button",{onClick:Ke,className:"btn-primary w-full flex items-center justify-center gap-2",children:[a.jsx(VE,{className:"w-4 h-4"})," Pay ",X.fee/2," Securely"]})]}),D===3&&a.jsxs("div",{className:"text-center py-6",children:[a.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:a.jsx(cc,{className:"w-8 h-8 text-green-600"})}),a.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Booking Confirmed!"}),a.jsx("p",{className:"text-gray-600 mb-4",children:"Your appointment has been scheduled"}),a.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl text-left space-y-2 mb-4",children:[a.jsxs("p",{children:[a.jsx("strong",{children:"Doctor:"})," ",X.name]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Date:"})," ",B.date," at ",B.slot]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Type:"})," ",B.type==="online"?"Video Consultation":"In-Person"]}),B.type==="online"&&a.jsxs("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:[a.jsxs("p",{className:"text-sm text-blue-800 font-medium flex items-center gap-2",children:[a.jsx(dc,{className:"w-4 h-4"})," Video Call Link"]}),a.jsxs("p",{className:"text-sm text-blue-600 mt-1 break-all",children:["https://meet.healthai.com/apt-",Math.random().toString(36).substr(2,6)]}),a.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Link will be available in your dashboard"})]})]}),a.jsx("button",{onClick:()=>{ht(),f("dashboard")},className:"btn-primary w-full",children:"Go to Dashboard"})]})]})})},Ct=()=>{var ge,We;return a.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Profile Settings"}),a.jsx("p",{className:"text-gray-600",children:"Manage your personal and health information"})]}),a.jsx("div",{className:"card gradient-bg text-white",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center",children:a.jsx(ms,{className:"w-8 h-8"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold",children:"Health Score"}),a.jsx("p",{className:"text-3xl font-bold",children:"78/100"})]}),a.jsxs("div",{className:"ml-auto text-right",children:[a.jsx("p",{className:"text-sm opacity-80",children:"BMI"}),a.jsx("p",{className:"text-2xl font-bold",children:"23.5"})]})]})}),a.jsxs("div",{className:"card",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx($i,{className:"w-5 h-5 text-primary-600"})," Basic Information"]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Full Name"}),a.jsx("input",{type:"text",value:nE.name,className:"input",readOnly:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),a.jsx("input",{type:"email",value:nE.email,className:"input bg-gray-50",disabled:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Age"}),a.jsx("input",{type:"number",value:$e.age,onChange:rt=>He({...$e,age:rt.target.value}),className:"input"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Gender"}),a.jsxs("select",{value:$e.gender,onChange:rt=>He({...$e,gender:rt.target.value}),className:"input",children:[a.jsx("option",{value:"male",children:"Male"}),a.jsx("option",{value:"female",children:"Female"}),a.jsx("option",{value:"other",children:"Other"})]})]})]})]}),a.jsxs("div",{className:"card",children:[a.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Health Information"}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Height (cm)"}),a.jsx("input",{type:"number",value:$e.height,onChange:rt=>He({...$e,height:rt.target.value}),className:"input"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Weight (kg)"}),a.jsx("input",{type:"number",value:$e.weight,onChange:rt=>He({...$e,weight:rt.target.value}),className:"input"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Blood Group"}),a.jsx("select",{value:$e.bloodGroup,onChange:rt=>He({...$e,bloodGroup:rt.target.value}),className:"input",children:["A+","A-","B+","B-","AB+","AB-","O+","O-"].map(rt=>a.jsx("option",{children:rt},rt))})]})]})]}),a.jsxs("div",{className:"card",children:[a.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Medical History"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Allergies"}),a.jsx("input",{type:"text",value:(ge=$e.allergies)==null?void 0:ge.join(", "),className:"input",placeholder:"e.g., Penicillin, Peanuts"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Chronic Conditions"}),a.jsx("input",{type:"text",value:(We=$e.chronicConditions)==null?void 0:We.join(", "),className:"input",placeholder:"e.g., Diabetes, Hypertension"})]})]})]}),a.jsxs("button",{className:"btn-primary w-full flex items-center justify-center gap-2",onClick:()=>alert("Profile saved!"),children:[a.jsx(cc,{className:"w-5 h-5"})," Save Changes"]})]})},zt=()=>a.jsxs("div",{className:"space-y-6",children:[a.jsxs("button",{onClick:()=>f("dashboard"),className:"inline-flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]}),a.jsxs("div",{className:"card",children:[a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-14 h-14 bg-primary-100 rounded-xl flex items-center justify-center",children:a.jsx(un,{className:"w-7 h-7 text-primary-600"})}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Blood Test Report"}),a.jsx("p",{className:"text-gray-500",children:"Analyzed on Dec 5, 2024"})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("div",{className:"text-3xl font-bold text-primary-600",children:"78"}),a.jsx("div",{className:"text-sm text-gray-500",children:"Health Score"})]})]}),a.jsxs("div",{className:"flex gap-3 mt-4 pt-4 border-t border-gray-100",children:[a.jsxs("button",{onClick:()=>G(!U),className:"flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-xl hover:bg-blue-100",children:[a.jsx(xP,{className:"w-4 h-4"}),U?"Hide":"Compare"]}),a.jsxs("button",{onClick:()=>k(!F),className:"flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-700 rounded-xl hover:bg-purple-100",children:[a.jsx(bP,{className:"w-4 h-4"}),"Ask AI"]})]})]}),U&&a.jsxs("div",{className:"card border-2 border-blue-200 bg-blue-50/50",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[a.jsx(xP,{className:"w-5 h-5 text-blue-600"})," Health Comparison"]}),a.jsx("span",{className:"px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700",children:" Improved"})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-4",children:[a.jsxs("div",{className:"bg-white p-4 rounded-xl",children:[a.jsx("p",{className:"text-sm text-gray-500",children:"Previous (Oct)"}),a.jsx("p",{className:"text-2xl font-bold text-gray-400",children:"72/100"})]}),a.jsxs("div",{className:"bg-white p-4 rounded-xl",children:[a.jsx("p",{className:"text-sm text-gray-500",children:"Current (Dec)"}),a.jsx("p",{className:"text-2xl font-bold text-primary-600",children:"78/100"})]})]}),a.jsx("p",{className:"text-gray-700 mb-4",children:r2.summary}),a.jsx("div",{className:"space-y-2 mb-4",children:r2.metricChanges.map((ge,We)=>a.jsxs("div",{className:"flex items-center justify-between bg-white p-3 rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ys,{trend:ge.change}),a.jsx("span",{className:"font-medium",children:ge.metric})]}),a.jsxs("div",{className:"text-sm",children:[a.jsx("span",{className:"text-gray-500",children:ge.previous}),"  ",a.jsx("span",{className:"font-medium",children:ge.current})]})]},We))})]}),F&&a.jsxs("div",{className:"card border-2 border-purple-200",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx(bP,{className:"w-5 h-5 text-purple-600"})," Ask About Your Report"]}),a.jsxs("div",{className:"h-48 overflow-y-auto mb-4 space-y-3 p-3 bg-gray-50 rounded-xl",children:[E.length===0&&a.jsx("p",{className:"text-gray-500 text-center py-6",children:'Try: "What does my cholesterol mean?" or "Should I be worried?"'}),E.map((ge,We)=>a.jsx("div",{className:`flex ${ge.role==="user"?"justify-end":"justify-start"}`,children:a.jsx("div",{className:`max-w-[80%] p-3 rounded-xl ${ge.role==="user"?"bg-purple-600 text-white":"bg-white border"}`,children:ge.content})},We)),a.jsx("div",{ref:ot})]}),a.jsxs("form",{onSubmit:_t,className:"flex gap-2",children:[a.jsx("input",{type:"text",value:R,onChange:ge=>P(ge.target.value),placeholder:"Ask a question...",className:"input flex-1"}),a.jsx("button",{type:"submit",className:"btn-primary px-4",children:a.jsx(Uh,{className:"w-5 h-5"})})]})]}),a.jsxs("div",{className:"card",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[a.jsx(ms,{className:"w-5 h-5 text-primary-600"})," Summary"]}),a.jsx("p",{className:"text-gray-700",children:_i.summary})]}),a.jsxs("div",{className:"card",children:[a.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Health Metrics"}),a.jsx("div",{className:"grid md:grid-cols-3 gap-4",children:Object.entries(_i.metrics).map(([ge,We])=>a.jsxs("div",{className:`p-4 rounded-xl ${We.status==="normal"?"bg-green-50":"bg-yellow-50"}`,children:[a.jsx("p",{className:"text-sm text-gray-600 capitalize",children:ge.replace(/([A-Z])/g," $1")}),a.jsxs("p",{className:"text-xl font-bold",children:[We.value," ",We.unit]}),a.jsxs("p",{className:"text-xs text-gray-500",children:["Normal: ",We.normalRange]}),a.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${We.status==="normal"?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"}`,children:We.status})]},ge))})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"card",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[a.jsx(zn,{className:"w-5 h-5 text-blue-600"})," Key Findings"]}),a.jsx("ul",{className:"space-y-2",children:_i.keyFindings.map((ge,We)=>a.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"}),ge]},We))})]}),a.jsxs("div",{className:"card border-l-4 border-orange-400",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[a.jsx(lc,{className:"w-5 h-5 text-orange-600"})," Risk Factors"]}),a.jsx("ul",{className:"space-y-2",children:_i.riskFactors.map((ge,We)=>a.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-orange-500 rounded-full mt-2"}),ge]},We))})]})]}),a.jsxs("div",{className:"card",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx(Ji,{className:"w-5 h-5 text-green-600"})," Diet"]}),a.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:_i.recommendations.diet.map((ge,We)=>a.jsxs("div",{className:"p-4 bg-green-50 rounded-xl",children:[a.jsxs("div",{className:"flex justify-between mb-2",children:[a.jsx("span",{className:"font-medium text-green-800",children:ge.item}),a.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${ge.priority==="high"?"bg-green-200 text-green-800":"bg-gray-200"}`,children:ge.priority})]}),a.jsx("p",{className:"text-sm text-green-700",children:ge.reason})]},We))})]}),a.jsxs("div",{className:"card",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx(ag,{className:"w-5 h-5 text-blue-600"})," Exercise"]}),_i.recommendations.exercise.map((ge,We)=>a.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl mb-3",children:[a.jsxs("div",{className:"flex justify-between mb-2",children:[a.jsx("span",{className:"font-medium text-blue-800",children:ge.activity}),a.jsxs("span",{className:"text-sm text-blue-600",children:[ge.duration,"  ",ge.frequency]})]}),a.jsx("p",{className:"text-sm text-blue-700",children:ge.reason})]},We))]}),a.jsxs("div",{className:"card border-2 border-primary-200 bg-primary-50/30",children:[a.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[a.jsx(Wd,{className:"w-5 h-5 text-primary-600"})," Recommended Doctors"]}),a.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:OE.filter(ge=>_i.doctorConsultation.specializations.includes(ge.specialization)).map(ge=>a.jsxs("div",{className:"bg-white p-4 rounded-xl shadow-sm",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center text-lg font-bold text-primary-600",children:ge.name.split(" ")[1][0]}),a.jsxs("div",{children:[a.jsx("p",{className:"font-medium",children:ge.name}),a.jsx("p",{className:"text-sm text-primary-600",children:ge.specialization})]})]}),a.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-2",children:[a.jsx(wo,{className:"w-4 h-4 text-yellow-400 fill-yellow-400"}),ge.rating,"  ",a.jsx(Yr,{className:"w-4 h-4"}),ge.experience," yrs"]}),a.jsxs("div",{className:"flex justify-between mt-3 pt-3 border-t",children:[a.jsxs("span",{className:"font-semibold",children:["",ge.fee]}),a.jsx("button",{onClick:()=>{q(ge),f("doctors")},className:"text-sm bg-primary-600 text-white px-3 py-1.5 rounded-lg hover:bg-primary-700",children:"Book Now"})]})]},ge._id))})]})]}),ts=()=>a.jsxs("aside",{className:"w-64 bg-white border-r border-gray-200 fixed h-full flex flex-col",children:[a.jsxs("div",{className:"p-6",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-10 h-10 gradient-bg rounded-xl flex items-center justify-center",children:a.jsx(ms,{className:"w-6 h-6 text-white"})}),a.jsx("span",{className:"text-xl font-bold text-gray-900",children:"HealthAI"})]}),a.jsx("span",{className:"inline-block mt-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full",children:"Demo Mode"})]}),a.jsx("nav",{className:"px-4 space-y-1 flex-1",children:[{id:"dashboard",icon:sq,label:"Dashboard"},{id:"upload",icon:Kr,label:"Upload Report"},{id:"report",icon:un,label:"Report & Chat"},{id:"doctors",icon:Wd,label:"Doctors"},{id:"profile",icon:$i,label:"Profile"}].map(ge=>a.jsxs("button",{onClick:()=>f(ge.id),className:`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${u===ge.id?"bg-primary-50 text-primary-600":"text-gray-600 hover:bg-gray-50"}`,children:[a.jsx(ge.icon,{className:"w-5 h-5"}),a.jsx("span",{className:"font-medium",children:ge.label})]},ge.id))}),a.jsx("div",{className:"px-4 py-3 border-t border-gray-100",children:a.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:x,onChange:ge=>_(ge.target.checked),className:"w-4 h-4 text-primary-600 rounded"}),a.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Admin Mode"}),a.jsx(Kd,{className:"w-4 h-4 text-gray-400"})]})}),a.jsx("div",{className:"p-4 border-t border-gray-100",children:a.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[a.jsx("div",{className:"w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center",children:a.jsx("span",{className:"text-primary-600 font-semibold",children:"J"})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:x?"Admin User":"John Doe"}),a.jsx("p",{className:"text-xs text-gray-500 truncate",children:x?"admin@healthai.com":"john@example.com"})]}),a.jsx(DE,{className:"w-5 h-5 text-gray-400"})]})})]});return a.jsxs("div",{className:"min-h-screen bg-gray-50 flex",children:[a.jsx(ts,{}),a.jsxs("main",{className:"flex-1 ml-64 p-8",children:[u==="dashboard"&&a.jsx(As,{}),u==="upload"&&a.jsx(zs,{}),u==="report"&&a.jsx(zt,{}),u==="doctors"&&a.jsx(je,{}),u==="profile"&&a.jsx(Ct,{})]}),a.jsx(Ze,{})]})}function DZ(){const[u,f]=j.useState(null),[x,_]=j.useState(!0),[E,y]=j.useState("overview");j.useEffect(()=>{R()},[]);const R=async()=>{try{const{data:U}=await tg.getStats();f(U)}catch{Ve.error("Failed to load stats")}finally{_(!1)}};if(x)return a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsx("div",{className:"w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"})});const P=[{id:"overview",label:"Overview",icon:ms},{id:"doctors",label:"Doctors",icon:y2}];return a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"Admin Dashboard"}),a.jsx("p",{className:"text-slate-500 mt-1",children:"Manage platform settings and monitor activity"})]}),a.jsx("div",{className:"flex gap-2 p-1 bg-slate-100 rounded-xl w-fit",children:P.map(({id:U,label:G,icon:F})=>a.jsxs("button",{onClick:()=>y(U),className:`flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium transition-all ${E===U?"bg-white text-slate-800 shadow-sm":"text-slate-500 hover:text-slate-700"}`,children:[a.jsx(F,{className:"w-4 h-4"}),a.jsx("span",{children:G})]},U))}),E==="overview"&&a.jsx(kZ,{stats:u}),E==="doctors"&&a.jsx(jZ,{})]})}function kZ({stats:u}){var f,x,_,E;return u?a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center mb-3",children:a.jsx(Wd,{className:"w-5 h-5 text-blue-600"})}),a.jsx("p",{className:"text-sm text-slate-500",children:"Total Patients"}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:((f=u.stats)==null?void 0:f.totalUsers)||0})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center mb-3",children:a.jsx(Hs,{className:"w-5 h-5 text-green-600"})}),a.jsx("p",{className:"text-sm text-slate-500",children:"Active Users"}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:((x=u.stats)==null?void 0:x.activeUsers)||0})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center mb-3",children:a.jsx(un,{className:"w-5 h-5 text-purple-600"})}),a.jsx("p",{className:"text-sm text-slate-500",children:"Total Reports"}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:((_=u.stats)==null?void 0:_.totalReports)||0})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center mb-3",children:a.jsx(hn,{className:"w-5 h-5 text-amber-600"})}),a.jsx("p",{className:"text-sm text-slate-500",children:"Pending Doctors"}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:((E=u.stats)==null?void 0:E.pendingDoctors)||0})]})]}):null}function jZ(){const[u,f]=j.useState([]),[x,_]=j.useState(!0),[E,y]=j.useState("all");j.useEffect(()=>{R()},[]);const R=async()=>{try{const{data:k}=await tg.getDoctors();f(k.doctors||[])}catch{Ve.error("Failed to load doctors")}finally{_(!1)}},P=async k=>{try{await tg.approveDoctor(k),f(u.map(X=>X._id===k?{...X,approvalStatus:"approved",isListed:!0}:X)),Ve.success("Doctor approved!")}catch{Ve.error("Failed to approve")}},U=async k=>{try{await tg.rejectDoctor(k),f(u.map(X=>X._id===k?{...X,approvalStatus:"rejected",isListed:!1}:X)),Ve.success("Doctor rejected")}catch{Ve.error("Failed to reject")}},G=u.filter(k=>E==="all"?!0:k.approvalStatus===E),F=u.filter(k=>k.approvalStatus==="pending").length;return x?a.jsx(No,{}):a.jsxs("div",{className:"space-y-4",children:[F>0&&a.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-4",children:[a.jsx(hn,{className:"w-6 h-6 text-amber-500"}),a.jsx("div",{className:"flex-1",children:a.jsxs("p",{className:"font-medium text-amber-800",children:[F," Doctor(s) Pending Approval"]})}),a.jsx("button",{onClick:()=>y("pending"),className:"px-4 py-2 bg-amber-500 text-white font-medium rounded-lg hover:bg-amber-600",children:"Review"})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-6 shadow-sm",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:"Doctor Management"}),a.jsx("div",{className:"flex gap-2",children:["all","pending","approved","rejected"].map(k=>a.jsx("button",{onClick:()=>y(k),className:`px-3 py-1.5 rounded-lg text-sm font-medium capitalize ${E===k?"bg-cyan-500 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:k},k))})]}),a.jsxs("div",{className:"space-y-3",children:[G.map(k=>{var X,q;return a.jsx("div",{className:`p-4 rounded-xl border ${k.approvalStatus==="pending"?"bg-amber-50 border-amber-200":k.approvalStatus==="rejected"?"bg-red-50 border-red-200":"bg-slate-50 border-slate-200"}`,children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold",children:(q=(X=k.name)==null?void 0:X[0])==null?void 0:q.toUpperCase()}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("h3",{className:"font-semibold text-slate-800",children:["Dr. ",k.name]}),a.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${k.approvalStatus==="approved"?"bg-green-100 text-green-700":k.approvalStatus==="rejected"?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}`,children:k.approvalStatus})]}),a.jsx("p",{className:"text-sm text-cyan-600",children:k.specialization}),a.jsxs("p",{className:"text-xs text-slate-500",children:[k.experience," yrs  ",k.consultationFee||0]})]})]}),a.jsx("div",{className:"flex items-center gap-2",children:k.approvalStatus==="pending"&&a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:()=>P(k._id),className:"px-3 py-1.5 bg-green-500 text-white text-sm font-medium rounded-lg hover:bg-green-600 flex items-center gap-1",children:[a.jsx(Hs,{className:"w-4 h-4"})," Approve"]}),a.jsxs("button",{onClick:()=>U(k._id),className:"px-3 py-1.5 bg-slate-200 text-red-600 text-sm font-medium rounded-lg hover:bg-slate-300 flex items-center gap-1",children:[a.jsx(g2,{className:"w-4 h-4"})," Reject"]})]})})]})},k._id)}),G.length===0&&a.jsxs("div",{className:"text-center py-8 text-slate-500",children:[a.jsx(y2,{className:"w-10 h-10 mx-auto mb-2 text-slate-300"}),a.jsx("p",{children:"No doctors found"})]})]})]})]})}const PZ=[{id:"free",name:"Free",price:0,period:"forever",features:["1 Report analysis per month","Basic AI insights","View doctor listings","Email support"],color:"slate",icon:wo},{id:"basic",name:"Basic",price:0,period:"month",features:["5 Report analyses per month","Full AI analysis with deficiencies","Personalized diet plans","Supplement recommendations","Health trend tracking","Priority support"],color:"cyan",icon:zr,popular:!0},{id:"premium",name:"Premium",price:0,period:"month",features:["Unlimited report analyses","Advanced AI insights","Personalized diet & exercise plans","Supplement recommendations","Health trend analytics","Chat with AI about reports","Doctor recommendations","24/7 Priority support"],color:"violet",icon:uE}];function LZ(){var G;const{user:u}=ia(),[f,x]=j.useState(null),[_,E]=j.useState(!0),[y,R]=j.useState("monthly");j.useEffect(()=>{P()},[]);const P=async()=>{try{const{data:F}=await GJ.getSubscription();x(F)}catch{console.error("Failed to fetch subscription")}finally{E(!1)}},U=(f==null?void 0:f.plan)||((G=u==null?void 0:u.subscription)==null?void 0:G.plan)||"free";return _?a.jsx(No,{}):a.jsxs("div",{className:"max-w-6xl mx-auto space-y-8 animate-fade-in",children:[a.jsxs("div",{className:"text-center",children:[a.jsxs("div",{className:"inline-flex items-center gap-2 bg-violet-500/20 text-violet-400 px-4 py-2 rounded-full text-sm font-semibold mb-4",children:[a.jsx(uE,{className:"w-4 h-4"}),"Subscription Plans"]}),a.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Choose Your Plan"}),a.jsx("p",{className:"text-slate-400 max-w-lg mx-auto",children:"Unlock the full potential of AI-powered health insights with our premium plans"})]}),a.jsxs("div",{className:"bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl p-6 text-white relative overflow-hidden",children:[a.jsx("div",{className:"absolute inset-0 opacity-10",children:a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white rounded-full -translate-y-1/2 translate-x-1/2"})}),a.jsxs("div",{className:"relative flex flex-col md:flex-row md:items-center justify-between gap-4",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center",children:a.jsx(uE,{className:"w-7 h-7"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white/70 text-sm",children:"Current Plan"}),a.jsx("h2",{className:"text-2xl font-bold capitalize",children:U})]})]}),a.jsxs("div",{className:"flex items-center gap-6",children:[(f==null?void 0:f.endDate)&&a.jsxs("div",{className:"text-right",children:[a.jsx("p",{className:"text-white/70 text-sm",children:"Renewal Date"}),a.jsx("p",{className:"font-semibold",children:new Date(f.endDate).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})})]}),a.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl",children:[a.jsx(Pn,{className:"w-4 h-4"}),a.jsx("span",{className:"font-medium capitalize",children:(f==null?void 0:f.status)||"Active"})]})]})]})]}),a.jsx("div",{className:"flex justify-center",children:a.jsxs("div",{className:"flex items-center gap-3 p-1 bg-slate-800 rounded-xl",children:[a.jsx("button",{onClick:()=>R("monthly"),className:`px-6 py-2.5 rounded-lg font-medium transition-all ${y==="monthly"?"bg-slate-700 text-white":"text-slate-400"}`,children:"Monthly"}),a.jsxs("button",{onClick:()=>R("yearly"),className:`px-6 py-2.5 rounded-lg font-medium transition-all flex items-center gap-2 ${y==="yearly"?"bg-slate-700 text-white":"text-slate-400"}`,children:["Yearly",a.jsx("span",{className:"text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full",children:"Save 20%"})]})]})}),a.jsx("div",{className:"grid md:grid-cols-3 gap-6",children:PZ.map(F=>{const k=F.icon,X=U===F.id,q=y==="yearly"?Math.round(F.price*12*.8):F.price;return a.jsxs("div",{className:`bg-[#111827] rounded-2xl border p-6 relative ${F.popular?"border-cyan-500":"border-slate-700"} ${X?"ring-2 ring-cyan-500 ring-offset-2 ring-offset-[#0a0f1a]":""}`,children:[F.popular&&a.jsx("div",{className:"absolute -top-4 left-1/2 -translate-x-1/2",children:a.jsx("span",{className:"bg-cyan-500 text-white text-xs font-bold px-4 py-1.5 rounded-full shadow-lg",children:"Most Popular"})}),a.jsxs("div",{className:"text-center mb-6 pt-2",children:[a.jsx("div",{className:`w-14 h-14 rounded-2xl mx-auto mb-4 flex items-center justify-center bg-${F.color}-500/20`,children:a.jsx(k,{className:`w-7 h-7 text-${F.color}-400`})}),a.jsx("h3",{className:"text-xl font-bold text-white",children:F.name}),a.jsxs("div",{className:"mt-4",children:[a.jsxs("span",{className:"text-4xl font-bold text-white",children:["",q]}),a.jsxs("span",{className:"text-slate-400",children:["/",y==="yearly"?"year":F.period]})]})]}),a.jsx("ul",{className:"space-y-3 mb-8",children:F.features.map((D,H)=>a.jsxs("li",{className:"flex items-start gap-3 text-sm",children:[a.jsx("div",{className:`w-5 h-5 rounded-full bg-${F.color}-500/20 flex items-center justify-center flex-shrink-0 mt-0.5`,children:a.jsx(cc,{className:`w-3 h-3 text-${F.color}-400`})}),a.jsx("span",{className:"text-slate-400",children:D})]},H))}),a.jsx("button",{className:`w-full py-3 rounded-xl font-semibold transition-all ${X?"bg-slate-800 text-slate-500 cursor-default":F.popular?"bg-gradient-to-r from-cyan-500 to-blue-500 text-white hover:opacity-90":"border-2 border-slate-700 text-slate-300 hover:border-cyan-500 hover:text-cyan-400"}`,disabled:X,children:X?"Current Plan":F.price===0?"Downgrade":"Upgrade Now"})]},F.id)})}),a.jsx("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:a.jsxs("div",{className:"flex items-start gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0",children:a.jsx(E2,{className:"w-6 h-6 text-blue-400"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-bold text-white mb-2",children:"Secure Payment"}),a.jsx("p",{className:"text-slate-400 text-sm",children:"All payments are processed securely. You can upgrade, downgrade, or cancel your subscription at any time. Changes take effect immediately and unused time is prorated."})]})]})})]})}const Ih=[{id:"apple_watch",name:"Apple Watch",icon:_o,description:"Sync health data from your Apple Watch and iPhone",tags:["Heart Rate","Activity","Sleep"],color:"bg-slate-800",textColor:"text-slate-800"},{id:"google_fit",name:"Google Fit",icon:ms,description:"Aggregates data from Android devices and apps",tags:["Activity","Nutrition","Weight"],color:"bg-blue-500",textColor:"text-blue-600"},{id:"fitbit",name:"Fitbit",icon:zr,description:"Track steps, heart rate, and sleep patterns",tags:["Steps","Heart","Sleep"],color:"bg-cyan-500",textColor:"text-cyan-600"},{id:"garmin",name:"Garmin Connect",icon:Qn,description:"High-fidelity GPS and heart rate data",tags:["Cardio","GPS","Training"],color:"bg-indigo-600",textColor:"text-indigo-600"},{id:"samsung",name:"Samsung Health",icon:kE,description:"Galaxy Watch and phone health data",tags:["Activity","Sleep","Stress"],color:"bg-purple-600",textColor:"text-purple-600"},{id:"oura",name:"Oura Ring",icon:Yd,description:"Advanced sleep and recovery tracking",tags:["Sleep","Recovery","HRV"],color:"bg-slate-700",textColor:"text-slate-700"}];function MZ(){const[u,f]=j.useState([]),[x,_]=j.useState(!0),[E,y]=j.useState(!1),[R,P]=j.useState(!1),[U,G]=j.useState(null);j.useEffect(()=>{F()},[]);const F=async()=>{try{const{data:B}=await Ud.getDashboard();B.devices&&f(B.devices)}catch(B){console.error("Failed to fetch devices:",B)}finally{_(!1)}},k=async()=>{y(!0);try{u.length>0?(await Ud.generateDemoData(u[0].type),await F(),Ve.success("All devices synced successfully!")):Ve.error("No devices connected")}catch(B){console.error("Sync failed:",B),Ve.error("Failed to sync devices")}finally{y(!1)}},X=async B=>{try{const ne=Ih.find(ae=>ae.id===B);await Ud.connectDevice(B,ne==null?void 0:ne.name),await Ud.generateDemoData(B),await F(),P(!1),Ve.success(`${ne==null?void 0:ne.name} connected successfully!`)}catch(ne){console.error("Failed to connect:",ne),Ve.error("Failed to connect device")}},q=async B=>{try{await Ud.disconnectDevice(B),await F(),Ve.success("Device disconnected")}catch(ne){console.error("Failed to disconnect:",ne),Ve.error("Failed to disconnect device")}},D=B=>{const ne=Ih.find(ae=>ae.id===B);return(ne==null?void 0:ne.icon)||_o},H=B=>{const ne=Ih.find(ae=>ae.id===B);return(ne==null?void 0:ne.color)||"bg-slate-600"};return x?a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-500",children:"Loading devices..."})]})}):a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"Connected Devices"}),a.jsxs("p",{className:"text-slate-500 mt-1 flex items-center gap-2",children:[a.jsx(Yr,{className:"w-4 h-4"}),"Last synced: ",new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})]})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsxs("button",{onClick:k,disabled:E||u.length===0,className:"flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl hover:bg-slate-50 transition-all disabled:opacity-50",children:[a.jsx(nq,{className:`w-4 h-4 ${E?"animate-spin":""}`}),"Sync All"]}),a.jsxs("button",{onClick:()=>P(!0),className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl hover:shadow-lg transition-all",children:[a.jsx(vi,{className:"w-4 h-4"}),"Add Device"]})]})]}),u.length===0&&a.jsxs("div",{className:"bg-cyan-50 border border-cyan-200 rounded-xl p-4 flex items-start gap-3",children:[a.jsx("div",{className:"w-6 h-6 rounded-full bg-cyan-100 flex items-center justify-center shrink-0 mt-0.5",children:a.jsx(hn,{className:"w-4 h-4 text-cyan-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-cyan-900 font-medium",children:"No devices connected yet"}),a.jsx("p",{className:"text-cyan-700 text-sm mt-1",children:"Connect your wearable devices to automatically track your health metrics and get personalized insights."})]})]}),u.length>0&&a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(aq,{className:"w-5 h-5 text-slate-600"}),a.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:"Your Devices"}),a.jsxs("span",{className:"px-2 py-0.5 bg-cyan-100 text-cyan-700 rounded-full text-xs font-medium",children:[u.length," connected"]})]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map((B,ne)=>{const ae=D(B.type),Z=H(B.type),te=Math.floor(Math.random()*50)+50;return a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition-all",children:[a.jsxs("div",{className:"flex items-start justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-12 h-12 rounded-xl ${Z} flex items-center justify-center`,children:a.jsx(ae,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-slate-800 font-semibold",children:B.name}),a.jsx("p",{className:"text-slate-500 text-sm",children:B.type})]})]}),a.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium",children:[a.jsx(Hs,{className:"w-3 h-3"}),"Active"]})]}),a.jsx("div",{className:"flex gap-1 mb-4 h-16 bg-slate-50 rounded-lg p-2",children:[...Array(7)].map((ie,ue)=>{const Ne=30+Math.random()*70;return a.jsx("div",{className:"flex-1 bg-gradient-to-t from-cyan-500 to-blue-500 rounded-sm",style:{height:`${Ne}%`,marginTop:"auto"}},ue)})}),a.jsxs("div",{className:"flex items-center justify-between pt-3 border-t border-slate-200",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-1 text-slate-600",children:[a.jsx(zn,{className:"w-4 h-4"}),a.jsx("span",{className:"text-xs",children:"Heart"})]}),a.jsxs("div",{className:"flex items-center gap-1 text-slate-600",children:[a.jsx(rq,{className:"w-4 h-4"}),a.jsx("span",{className:"text-xs",children:"Steps"})]}),a.jsxs("div",{className:"flex items-center gap-1 text-slate-600",children:[a.jsx(Yd,{className:"w-4 h-4"}),a.jsx("span",{className:"text-xs",children:"Sleep"})]})]}),a.jsxs("div",{className:"flex items-center gap-1 text-slate-500 text-xs",children:[a.jsx(iq,{className:"w-4 h-4"}),te,"%"]})]}),a.jsxs("div",{className:"mt-4 flex gap-2",children:[a.jsx("button",{onClick:()=>k(),className:"flex-1 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium",children:"Sync Now"}),a.jsx("button",{onClick:()=>q(B.type),className:"px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors text-sm",children:"Disconnect"})]})]},ne)})})]}),a.jsxs("div",{children:[a.jsx("div",{className:"flex items-center justify-between mb-4",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(_o,{className:"w-5 h-5 text-slate-600"}),a.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:"Available Integrations"})]})}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Ih.map(B=>{const ne=B.icon,ae=u.some(Z=>Z.type===B.id);return a.jsx("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition-all",children:a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{className:"flex items-start gap-4 flex-1",children:[a.jsx("div",{className:`w-12 h-12 rounded-xl ${B.color} flex items-center justify-center shrink-0`,children:a.jsx(ne,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("p",{className:"text-slate-800 font-semibold",children:B.name}),ae&&a.jsx("span",{className:"px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium",children:"Connected"})]}),a.jsx("p",{className:"text-slate-500 text-sm mb-3",children:B.description}),a.jsx("div",{className:"flex flex-wrap gap-2",children:B.tags.map(Z=>a.jsx("span",{className:"px-2 py-1 bg-slate-100 rounded-lg text-slate-600 text-xs",children:Z},Z))})]})]}),a.jsx("button",{onClick:()=>ae?q(B.id):X(B.id),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all ${ae?"bg-slate-100 text-slate-700 hover:bg-slate-200":"bg-gradient-to-r from-cyan-500 to-blue-500 text-white hover:shadow-lg"}`,children:ae?"Disconnect":"Connect"})]})},B.id)})})]}),R&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in",children:a.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full p-6 shadow-xl animate-slide-up",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"Connect a Device"}),a.jsx("button",{onClick:()=>P(!1),className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors",children:a.jsx(ra,{className:"w-5 h-5"})})]}),a.jsx("p",{className:"text-slate-500 mb-6",children:"Select a device or service to connect"}),a.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto",children:Ih.map(B=>{const ne=B.icon,ae=u.some(Z=>Z.type===B.id);return a.jsxs("button",{onClick:()=>!ae&&X(B.id),disabled:ae,className:`w-full p-4 border rounded-xl transition-all flex items-center gap-4 text-left ${ae?"bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed":"bg-white border-slate-200 hover:border-cyan-500 hover:shadow-sm"}`,children:[a.jsx("div",{className:`w-10 h-10 rounded-xl ${B.color} flex items-center justify-center shrink-0`,children:a.jsx(ne,{className:"w-5 h-5 text-white"})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("p",{className:"text-slate-800 font-medium",children:B.name}),ae&&a.jsx(Hs,{className:"w-4 h-4 text-emerald-500"})]}),a.jsx("p",{className:"text-slate-500 text-sm",children:B.description})]})]},B.id)})})]})})]})}function UZ(){var H,B,ne,ae,Z,te,ie,ue,Ne,be,Q,pe,he,Ae,fe,le,we,re,oe;const{patientId:u}=Lh(),[f]=c2(),x=f.get("appointmentId"),[_,E]=j.useState(null),[y,R]=j.useState(!0),[P,U]=j.useState("overview");if(j.useEffect(()=>{(async()=>{try{const{data:Oe}=await sr.getPatientProfile(u,x);E(Oe)}catch(Oe){console.error("Failed to fetch patient profile:",Oe)}finally{R(!1)}})()},[u,x]),y)return a.jsx(No,{});if(!_)return a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6 text-center py-16",children:[a.jsx("p",{className:"text-slate-400",children:"Patient not found or access denied."}),a.jsx(Rt,{to:"/doctors",className:"mt-4 inline-block px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl",children:"Go Back"})]});const{patient:G,healthSummary:F,healthReports:k,wearableSummary:X,appointmentHistory:q}=_,D=[{id:"overview",label:"Overview",icon:$i},{id:"reports",label:"Health Reports",icon:un},{id:"wearables",label:"Wearable Data",icon:_o},{id:"history",label:"Appointment History",icon:Pn}];return a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs(Rt,{to:"/doctor/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 transition-colors",children:[a.jsx(dn,{className:"w-4 h-4"}),"Back to Dashboard"]}),a.jsx("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-6",children:[a.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-white text-3xl font-bold",children:(B=(H=G.name)==null?void 0:H.charAt(0))==null?void 0:B.toUpperCase()}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h1",{className:"text-2xl font-bold text-white",children:G.name}),a.jsxs("div",{className:"flex flex-wrap gap-4 mt-2 text-sm text-slate-400",children:[G.email&&a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(qd,{className:"w-4 h-4"})," ",G.email]}),G.phone&&a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(BE,{className:"w-4 h-4"})," ",G.phone]}),((ne=G.profile)==null?void 0:ne.age)&&a.jsxs("span",{children:[G.profile.age," years old"]}),((ae=G.profile)==null?void 0:ae.gender)&&a.jsx("span",{className:"capitalize",children:G.profile.gender})]})]}),(F==null?void 0:F.healthScore)&&a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:`text-4xl font-bold ${F.healthScore>=80?"text-emerald-400":F.healthScore>=60?"text-amber-400":"text-red-400"}`,children:F.healthScore}),a.jsx("p",{className:"text-sm text-slate-400",children:"Health Score"})]})]})}),a.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:D.map(J=>a.jsxs("button",{onClick:()=>U(J.id),className:`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition-all whitespace-nowrap ${P===J.id?"bg-cyan-500 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700"}`,children:[a.jsx(J.icon,{className:"w-4 h-4"}),J.label]},J.id))}),P==="overview"&&a.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("h2",{className:"text-lg font-bold text-white mb-4 flex items-center gap-2",children:[a.jsx($i,{className:"w-5 h-5 text-cyan-400"})," Basic Information"]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[((Z=G.profile)==null?void 0:Z.height)&&a.jsxs("div",{className:"p-3 bg-slate-800 rounded-xl",children:[a.jsx("p",{className:"text-sm text-slate-400",children:"Height"}),a.jsxs("p",{className:"font-semibold text-white",children:[G.profile.height," cm"]})]}),((te=G.profile)==null?void 0:te.weight)&&a.jsxs("div",{className:"p-3 bg-slate-800 rounded-xl",children:[a.jsx("p",{className:"text-sm text-slate-400",children:"Weight"}),a.jsxs("p",{className:"font-semibold text-white",children:[G.profile.weight," kg"]})]}),((ie=G.profile)==null?void 0:ie.bloodGroup)&&a.jsxs("div",{className:"p-3 bg-slate-800 rounded-xl",children:[a.jsx("p",{className:"text-sm text-slate-400",children:"Blood Group"}),a.jsx("p",{className:"font-semibold text-white",children:G.profile.bloodGroup})]}),((ue=G.healthMetrics)==null?void 0:ue.bmi)&&a.jsxs("div",{className:"p-3 bg-slate-800 rounded-xl",children:[a.jsx("p",{className:"text-sm text-slate-400",children:"BMI"}),a.jsx("p",{className:"font-semibold text-white",children:G.healthMetrics.bmi.toFixed(1)})]})]}),((be=(Ne=G.profile)==null?void 0:Ne.allergies)==null?void 0:be.length)>0&&a.jsxs("div",{className:"mt-4",children:[a.jsx("p",{className:"text-sm text-slate-400 mb-2",children:"Allergies"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:G.profile.allergies.map((J,Oe)=>a.jsx("span",{className:"px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm",children:J},Oe))})]}),((pe=(Q=G.profile)==null?void 0:Q.chronicConditions)==null?void 0:pe.length)>0&&a.jsxs("div",{className:"mt-4",children:[a.jsx("p",{className:"text-sm text-slate-400 mb-2",children:"Chronic Conditions"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:G.profile.chronicConditions.map((J,Oe)=>a.jsx("span",{className:"px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-sm",children:J},Oe))})]})]}),F&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("h2",{className:"text-lg font-bold text-white mb-4 flex items-center gap-2",children:[a.jsx(zn,{className:"w-5 h-5 text-red-400"})," Health Summary"]}),((he=F.deficiencies)==null?void 0:he.length)>0&&a.jsxs("div",{className:"mb-4",children:[a.jsxs("p",{className:"text-sm text-slate-400 mb-2",children:["Deficiencies (",F.deficiencies.length,")"]}),a.jsx("div",{className:"space-y-2",children:F.deficiencies.slice(0,3).map((J,Oe)=>{var ot,_t,Ke;const $e=typeof J.currentValue=="object"?((ot=J.currentValue)==null?void 0:ot.value)||JSON.stringify(J.currentValue):J.currentValue,He=typeof J.normalRange=="object"?((_t=J.normalRange)==null?void 0:_t.value)||JSON.stringify(J.normalRange):J.normalRange;return a.jsxs("div",{className:`p-3 rounded-xl ${J.severity==="severe"?"bg-red-500/10 border border-red-500/30":J.severity==="moderate"?"bg-amber-500/10 border border-amber-500/30":"bg-yellow-500/10 border border-yellow-500/30"}`,children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"font-medium text-white",children:typeof J.name=="object"?((Ke=J.name)==null?void 0:Ke.value)||"Unknown":J.name}),a.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${J.severity==="severe"?"bg-red-500/20 text-red-400":J.severity==="moderate"?"bg-amber-500/20 text-amber-400":"bg-yellow-500/20 text-yellow-400"}`,children:J.severity})]}),a.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:["Current: ",$e," | Normal: ",He]})]},Oe)})})]}),((Ae=F.riskFactors)==null?void 0:Ae.length)>0&&a.jsxs("div",{className:"mb-4",children:[a.jsx("p",{className:"text-sm text-slate-400 mb-2",children:"Risk Factors"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:F.riskFactors.map((J,Oe)=>a.jsx("span",{className:"px-3 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm",children:typeof J=="object"?(J==null?void 0:J.name)||(J==null?void 0:J.value)||JSON.stringify(J):J},Oe))})]}),((fe=F.keyFindings)==null?void 0:fe.length)>0&&a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-slate-400 mb-2",children:"Key Findings"}),a.jsx("ul",{className:"space-y-1",children:F.keyFindings.slice(0,4).map((J,Oe)=>{const $e=typeof J=="object"?(J==null?void 0:J.title)||(J==null?void 0:J.finding)||(J==null?void 0:J.value)||JSON.stringify(J):J;return a.jsxs("li",{className:"text-sm text-slate-300 flex items-start gap-2",children:[a.jsx("span",{className:"text-cyan-400 mt-1",children:""}),$e]},Oe)})})]})]}),X&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6 lg:col-span-2",children:[a.jsxs("h2",{className:"text-lg font-bold text-white mb-4 flex items-center gap-2",children:[a.jsx(_o,{className:"w-5 h-5 text-blue-400"})," Wearable Data Summary"]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"p-4 bg-blue-500/10 rounded-xl text-center border border-blue-500/20",children:[a.jsx(ms,{className:"w-6 h-6 text-blue-400 mx-auto mb-2"}),a.jsx("p",{className:"text-2xl font-bold text-white",children:((le=X.avgSteps)==null?void 0:le.toLocaleString())||"N/A"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Avg Steps/Day"})]}),a.jsxs("div",{className:"p-4 bg-red-500/10 rounded-xl text-center border border-red-500/20",children:[a.jsx(zn,{className:"w-6 h-6 text-red-400 mx-auto mb-2"}),a.jsx("p",{className:"text-2xl font-bold text-white",children:X.avgHeartRate||"N/A"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Avg Heart Rate"})]}),a.jsxs("div",{className:"p-4 bg-indigo-500/10 rounded-xl text-center border border-indigo-500/20",children:[a.jsx(Yr,{className:"w-6 h-6 text-indigo-400 mx-auto mb-2"}),a.jsx("p",{className:"text-2xl font-bold text-white",children:X.avgSleepHours||"N/A"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Avg Sleep (hrs)"})]}),a.jsxs("div",{className:"p-4 bg-emerald-500/10 rounded-xl text-center border border-emerald-500/20",children:[a.jsx(_o,{className:"w-6 h-6 text-emerald-400 mx-auto mb-2"}),a.jsx("p",{className:"text-2xl font-bold text-white",children:((we=X.devices)==null?void 0:we.length)||0}),a.jsx("p",{className:"text-sm text-slate-400",children:"Connected Devices"})]})]})]})]}),P==="reports"&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h2",{className:"text-lg font-bold text-white mb-4",children:"Health Reports"}),(k==null?void 0:k.length)>0?a.jsx("div",{className:"space-y-3",children:k.map(J=>a.jsxs("div",{className:"p-4 bg-slate-800 rounded-xl flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-slate-700 flex items-center justify-center",children:a.jsx(un,{className:"w-6 h-6 text-slate-400"})}),a.jsxs("div",{children:[a.jsx("p",{className:"font-semibold text-white",children:J.reportType}),a.jsx("p",{className:"text-sm text-slate-400",children:new Date(J.createdAt).toLocaleDateString()})]})]}),a.jsxs("div",{className:"flex items-center gap-4",children:[J.healthScore&&a.jsxs("span",{className:`font-bold ${J.healthScore>=80?"text-emerald-400":J.healthScore>=60?"text-amber-400":"text-red-400"}`,children:["Score: ",J.healthScore]}),a.jsx("span",{className:`px-2 py-1 rounded-lg text-xs font-medium ${J.status==="completed"?"bg-emerald-500/20 text-emerald-400":"bg-amber-500/20 text-amber-400"}`,children:J.status})]})]},J._id))}):a.jsx("p",{className:"text-slate-400 text-center py-8",children:"No health reports available"})]}),P==="wearables"&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h2",{className:"text-lg font-bold text-white mb-4",children:"Wearable Device Data"}),X?a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-slate-400 mb-3",children:"Connected Devices"}),a.jsx("div",{className:"flex flex-wrap gap-3",children:(re=X.devices)==null?void 0:re.map((J,Oe)=>a.jsxs("div",{className:"px-4 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-xl flex items-center gap-2",children:[a.jsx(_o,{className:"w-4 h-4 text-cyan-400"}),a.jsx("span",{className:"font-medium text-cyan-300",children:J.name||J.type})]},Oe))})]}),((oe=X.recentMetrics)==null?void 0:oe.length)>0&&a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-slate-400 mb-3",children:"Recent Activity (Last 7 Days)"}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"w-full text-sm",children:[a.jsx("thead",{children:a.jsxs("tr",{className:"border-b border-slate-700",children:[a.jsx("th",{className:"text-left py-2 text-slate-400 font-medium",children:"Date"}),a.jsx("th",{className:"text-right py-2 text-slate-400 font-medium",children:"Steps"}),a.jsx("th",{className:"text-right py-2 text-slate-400 font-medium",children:"Calories"}),a.jsx("th",{className:"text-right py-2 text-slate-400 font-medium",children:"Active Min"}),a.jsx("th",{className:"text-right py-2 text-slate-400 font-medium",children:"Distance"})]})}),a.jsx("tbody",{children:X.recentMetrics.map((J,Oe)=>{var $e,He;return a.jsxs("tr",{className:"border-b border-slate-700/50",children:[a.jsx("td",{className:"py-2 text-white",children:new Date(J.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}),a.jsx("td",{className:"py-2 text-right text-slate-300",children:($e=J.steps)==null?void 0:$e.toLocaleString()}),a.jsx("td",{className:"py-2 text-right text-slate-300",children:J.caloriesBurned}),a.jsx("td",{className:"py-2 text-right text-slate-300",children:J.activeMinutes}),a.jsxs("td",{className:"py-2 text-right text-slate-300",children:[(He=J.distance)==null?void 0:He.toFixed(1)," km"]})]},Oe)})})]})})]})]}):a.jsx("p",{className:"text-slate-400 text-center py-8",children:"No wearable data available"})]}),P==="history"&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h2",{className:"text-lg font-bold text-white mb-4",children:"Appointment History"}),(q==null?void 0:q.length)>0?a.jsx("div",{className:"space-y-3",children:q.map(J=>a.jsxs("div",{className:"p-4 bg-slate-800 rounded-xl",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(Pn,{className:"w-5 h-5 text-slate-400"}),a.jsx("span",{className:"font-semibold text-white",children:new Date(J.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),a.jsx("span",{className:`px-2 py-1 rounded-lg text-xs font-medium ${J.status==="completed"?"bg-emerald-500/20 text-emerald-400":J.status==="scheduled"?"bg-amber-500/20 text-amber-400":"bg-red-500/20 text-red-400"}`,children:J.status})]}),J.doctor&&a.jsxs("p",{className:"text-sm text-slate-400",children:["Dr. ",J.doctor.name," - ",J.doctor.specialization]}),J.symptoms&&a.jsxs("p",{className:"text-sm text-slate-500 mt-2",children:[a.jsx("span",{className:"font-medium text-slate-400",children:"Symptoms:"})," ",J.symptoms]}),J.notes&&a.jsxs("p",{className:"text-sm text-slate-500 mt-1",children:[a.jsx("span",{className:"font-medium text-slate-400",children:"Notes:"})," ",J.notes]})]},J._id))}):a.jsx("p",{className:"text-slate-400 text-center py-8",children:"No appointment history"})]})]})}var DL={exports:{}};(function(u,f){(function(x,_){u.exports=_()})(zf,function(){function x(e,t){return t.forEach(function(s){s&&typeof s!="string"&&!Array.isArray(s)&&Object.keys(s).forEach(function(n){if(n!=="default"&&!(n in e)){var r=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return s[n]}})}})}),Object.freeze(e)}var _=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof zf<"u"?zf:typeof self<"u"?self:{};function E(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var y=function(e){try{return!!e()}catch{return!0}},R=!y(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),P=R,U=Function.prototype,G=U.call,F=P&&U.bind.bind(G,G),k=P?F:function(e){return function(){return G.apply(e,arguments)}},X=k({}.isPrototypeOf),q=function(e){return e&&e.Math===Math&&e},D=q(typeof globalThis=="object"&&globalThis)||q(typeof window=="object"&&window)||q(typeof self=="object"&&self)||q(typeof _=="object"&&_)||q(typeof _=="object"&&_)||function(){return this}()||Function("return this")(),H=R,B=Function.prototype,ne=B.apply,ae=B.call,Z=typeof Reflect=="object"&&Reflect.apply||(H?ae.bind(ne):function(){return ae.apply(ne,arguments)}),te=k,ie=te({}.toString),ue=te("".slice),Ne=function(e){return ue(ie(e),8,-1)},be=Ne,Q=k,pe=function(e){if(be(e)==="Function")return Q(e)},he=typeof document=="object"&&document.all,Ae=he===void 0&&he!==void 0?function(e){return typeof e=="function"||e===he}:function(e){return typeof e=="function"},fe={},le=!y(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),we=R,re=Function.prototype.call,oe=we?re.bind(re):function(){return re.apply(re,arguments)},J={},Oe={}.propertyIsEnumerable,$e=Object.getOwnPropertyDescriptor,He=$e&&!Oe.call({1:2},1);J.f=He?function(e){var t=$e(this,e);return!!t&&t.enumerable}:Oe;var ot,_t,Ke=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},ht=y,st=Ne,ct=Object,fs=k("".split),ys=ht(function(){return!ct("z").propertyIsEnumerable(0)})?function(e){return st(e)==="String"?fs(e,""):ct(e)}:ct,As=function(e){return e==null},zs=As,je=TypeError,Ze=function(e){if(zs(e))throw new je("Can't call method on "+e);return e},Ct=ys,zt=Ze,ts=function(e){return Ct(zt(e))},ge=Ae,We=function(e){return typeof e=="object"?e!==null:ge(e)},rt={},ws=rt,Cn=D,Fe=Ae,Je=function(e){return Fe(e)?e:void 0},De=function(e,t){return arguments.length<2?Je(ws[e])||Je(Cn[e]):ws[e]&&ws[e][t]||Cn[e]&&Cn[e][t]},it=D.navigator,gs=it&&it.userAgent,Gt=gs?String(gs):"",Ss=D,pn=Gt,Zn=Ss.process,tn=Ss.Deno,mn=Zn&&Zn.versions||tn&&tn.version,hs=mn&&mn.v8;hs&&(_t=(ot=hs.split("."))[0]>0&&ot[0]<4?1:+(ot[0]+ot[1])),!_t&&pn&&(!(ot=pn.match(/Edge\/(\d+)/))||ot[1]>=74)&&(ot=pn.match(/Chrome\/(\d+)/))&&(_t=+ot[1]);var ze=_t,It=ze,wt=y,ft=D.String,Os=!!Object.getOwnPropertySymbols&&!wt(function(){var e=Symbol("symbol detection");return!ft(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&It&&It<41}),Kn=Os&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Ye=De,Pt=Ae,oa=X,Js=Object,En=Kn?function(e){return typeof e=="symbol"}:function(e){var t=Ye("Symbol");return Pt(t)&&oa(t.prototype,Js(e))},Ln=String,ln=function(e){try{return Ln(e)}catch{return"Object"}},ca=Ae,yr=ln,rr=TypeError,Bn=function(e){if(ca(e))return e;throw new rr(yr(e)+" is not a function")},gl=Bn,Hh=As,To=function(e,t){var s=e[t];return Hh(s)?void 0:gl(s)},eu=oe,XE=Ae,JE=We,LL=TypeError,$E={exports:{}},QE=D,ML=Object.defineProperty,UL=D,VL=function(e,t){try{ML(QE,e,{value:t,configurable:!0,writable:!0})}catch{QE[e]=t}return t},ZE="__core-js_shared__",ey=$E.exports=UL[ZE]||VL(ZE,{});(ey.versions||(ey.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Rg=$E.exports,ty=Rg,xl=function(e,t){return ty[e]||(ty[e]=t||{})},FL=Ze,BL=Object,yi=function(e){return BL(FL(e))},GL=yi,WL=k({}.hasOwnProperty),Yn=Object.hasOwn||function(e,t){return WL(GL(e),t)},HL=k,zL=0,KL=Math.random(),YL=HL(1.1.toString),Cg=function(e){return"Symbol("+(e===void 0?"":e)+")_"+YL(++zL+KL,36)},qL=xl,sy=Yn,XL=Cg,JL=Os,$L=Kn,bl=D.Symbol,Ig=qL("wks"),QL=$L?bl.for||bl:bl&&bl.withoutSetter||XL,$s=function(e){return sy(Ig,e)||(Ig[e]=JL&&sy(bl,e)?bl[e]:QL("Symbol."+e)),Ig[e]},ZL=oe,ny=We,ay=En,eM=To,tM=function(e,t){var s,n;if(XE(s=e.toString)&&!JE(n=eu(s,e))||XE(s=e.valueOf)&&!JE(n=eu(s,e)))return n;throw new LL("Can't convert object to primitive value")},sM=TypeError,nM=$s("toPrimitive"),aM=function(e,t){if(!ny(e)||ay(e))return e;var s,n=eM(e,nM);if(n){if(s=ZL(n,e,t),!ny(s)||ay(s))return s;throw new sM("Can't convert object to primitive value")}return tM(e)},rM=En,Ag=function(e){var t=aM(e,"string");return rM(t)?t:t+""},ry=We,Og=D.document,iM=ry(Og)&&ry(Og.createElement),Dg=function(e){return iM?Og.createElement(e):{}},oM=Dg,iy=!le&&!y(function(){return Object.defineProperty(oM("div"),"a",{get:function(){return 7}}).a!==7}),cM=le,lM=oe,dM=J,uM=Ke,hM=ts,pM=Ag,mM=Yn,fM=iy,oy=Object.getOwnPropertyDescriptor;fe.f=cM?oy:function(e,t){if(e=hM(e),t=pM(t),fM)try{return oy(e,t)}catch{}if(mM(e,t))return uM(!lM(dM.f,e,t),e[t])};var gM=y,xM=Ae,bM=/#|\.prototype\./,tu=function(e,t){var s=vM[_M(e)];return s===yM||s!==EM&&(xM(t)?gM(t):!!t)},_M=tu.normalize=function(e){return String(e).replace(bM,".").toLowerCase()},vM=tu.data={},EM=tu.NATIVE="N",yM=tu.POLYFILL="P",cy=tu,wM=Bn,SM=R,NM=pe(pe.bind),Ro=function(e,t){return wM(e),t===void 0?e:SM?NM(e,t):function(){return e.apply(t,arguments)}},wr={},ly=le&&y(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),TM=We,RM=String,CM=TypeError,ka=function(e){if(TM(e))return e;throw new CM(RM(e)+" is not an object")},IM=le,AM=iy,OM=ly,zh=ka,dy=Ag,DM=TypeError,kg=Object.defineProperty,kM=Object.getOwnPropertyDescriptor,jg="enumerable",Pg="configurable",Lg="writable";wr.f=IM?OM?function(e,t,s){if(zh(e),t=dy(t),zh(s),typeof e=="function"&&t==="prototype"&&"value"in s&&Lg in s&&!s[Lg]){var n=kM(e,t);n&&n[Lg]&&(e[t]=s.value,s={configurable:Pg in s?s[Pg]:n[Pg],enumerable:jg in s?s[jg]:n[jg],writable:!1})}return kg(e,t,s)}:kg:function(e,t,s){if(zh(e),t=dy(t),zh(s),AM)try{return kg(e,t,s)}catch{}if("get"in s||"set"in s)throw new DM("Accessors not supported");return"value"in s&&(e[t]=s.value),e};var jM=wr,PM=Ke,pc=le?function(e,t,s){return jM.f(e,t,PM(1,s))}:function(e,t,s){return e[t]=s,e},su=D,LM=Z,MM=pe,UM=Ae,VM=fe.f,FM=cy,_l=rt,BM=Ro,vl=pc,uy=Yn,GM=function(e){var t=function(s,n,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(s);case 2:return new e(s,n)}return new e(s,n,r)}return LM(e,this,arguments)};return t.prototype=e.prototype,t},Xt=function(e,t){var s,n,r,i,o,c,l,d,h,p=e.target,m=e.global,g=e.stat,T=e.proto,w=m?su:g?su[p]:su[p]&&su[p].prototype,S=m?_l:_l[p]||vl(_l,p,{})[p],I=S.prototype;for(i in t)n=!(s=FM(m?i:p+(g?".":"#")+i,e.forced))&&w&&uy(w,i),c=S[i],n&&(l=e.dontCallGetSet?(h=VM(w,i))&&h.value:w[i]),o=n&&l?l:t[i],(s||T||typeof c!=typeof o)&&(d=e.bind&&n?BM(o,su):e.wrap&&n?GM(o):T&&UM(o)?MM(o):o,(e.sham||o&&o.sham||c&&c.sham)&&vl(d,"sham",!0),vl(S,i,d),T&&(uy(_l,r=p+"Prototype")||vl(_l,r,{}),vl(_l[r],i,o),e.real&&I&&(s||!I[i])&&vl(I,i,o)))},WM=Math.ceil,HM=Math.floor,zM=Math.trunc||function(e){var t=+e;return(t>0?HM:WM)(t)},KM=zM,Mg=function(e){var t=+e;return t!=t||t===0?0:KM(t)},YM=Mg,qM=Math.max,XM=Math.min,Ug=function(e,t){var s=YM(e);return s<0?qM(s+t,0):XM(s,t)},JM=Mg,$M=Math.min,hy=function(e){var t=JM(e);return t>0?$M(t,9007199254740991):0},QM=hy,Co=function(e){return QM(e.length)},ZM=ts,eU=Ug,tU=Co,py=function(e){return function(t,s,n){var r=ZM(t),i=tU(r);if(i===0)return!e&&-1;var o,c=eU(n,i);if(e&&s!=s){for(;i>c;)if((o=r[c++])!=o)return!0}else for(;i>c;c++)if((e||c in r)&&r[c]===s)return e||c||0;return!e&&-1}},Vg={includes:py(!0),indexOf:py(!1)},sU=Vg.includes;Xt({target:"Array",proto:!0,forced:y(function(){return!Array(1).includes()})},{includes:function(e){return sU(this,e,arguments.length>1?arguments[1]:void 0)}});var nU=D,aU=rt,ir=function(e,t){var s=aU[e+"Prototype"],n=s&&s[t];if(n)return n;var r=nU[e],i=r&&r.prototype;return i&&i[t]},rU=ir("Array","includes"),iU=We,oU=Ne,cU=$s("match"),Fg=function(e){var t;return iU(e)&&((t=e[cU])!==void 0?!!t:oU(e)==="RegExp")},lU=Fg,dU=TypeError,my={};my[$s("toStringTag")]="z";var Bg=String(my)==="[object z]",uU=Bg,hU=Ae,Kh=Ne,pU=$s("toStringTag"),mU=Object,fU=Kh(function(){return arguments}())==="Arguments",Io=uU?Kh:function(e){var t,s,n;return e===void 0?"Undefined":e===null?"Null":typeof(s=function(r,i){try{return r[i]}catch{}}(t=mU(e),pU))=="string"?s:fU?Kh(t):(n=Kh(t))==="Object"&&hU(t.callee)?"Arguments":n},gU=Io,xU=String,ja=function(e){if(gU(e)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return xU(e)},bU=$s("match"),_U=Xt,vU=function(e){if(lU(e))throw new dU("The method doesn't accept regular expressions");return e},EU=Ze,fy=ja,yU=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[bU]=!1,"/./"[e](t)}catch{}}return!1},wU=k("".indexOf);_U({target:"String",proto:!0,forced:!yU("includes")},{includes:function(e){return!!~wU(fy(EU(this)),fy(vU(e)),arguments.length>1?arguments[1]:void 0)}});var SU=ir("String","includes"),gy=X,NU=rU,TU=SU,Gg=Array.prototype,Wg=String.prototype,RU=function(e){var t=e.includes;return e===Gg||gy(Gg,e)&&t===Gg.includes?NU:typeof e=="string"||e===Wg||gy(Wg,e)&&t===Wg.includes?TU:t},_e=E(RU),CU=Bn,IU=yi,AU=ys,OU=Co,xy=TypeError,by="Reduce of empty array with no initial value",DU=function(e){return function(t,s,n,r){var i=IU(t),o=AU(i),c=OU(i);if(CU(s),c===0&&n<2)throw new xy(by);var l=e?c-1:0,d=e?-1:1;if(n<2)for(;;){if(l in o){r=o[l],l+=d;break}if(l+=d,e?l<0:c<=l)throw new xy(by)}for(;e?l>=0:c>l;l+=d)l in o&&(r=s(r,o[l],l,i));return r}},kU={left:DU(!1)},jU=y,Yh=function(e,t){var s=[][e];return!!s&&jU(function(){s.call(null,t||function(){return 1},1)})},nu=D,PU=Gt,LU=Ne,qh=function(e){return PU.slice(0,e.length)===e},Hg=qh("Bun/")?"BUN":qh("Cloudflare-Workers")?"CLOUDFLARE":qh("Deno/")?"DENO":qh("Node.js/")?"NODE":nu.Bun&&typeof Bun.version=="string"?"BUN":nu.Deno&&typeof Deno.version=="object"?"DENO":LU(nu.process)==="process"?"NODE":nu.window&&nu.document?"BROWSER":"REST",Xh=Hg==="NODE",MU=kU.left;Xt({target:"Array",proto:!0,forced:!Xh&&ze>79&&ze<83||!Yh("reduce")},{reduce:function(e){var t=arguments.length;return MU(this,e,t,t>1?arguments[1]:void 0)}});var UU=ir("Array","reduce"),VU=X,FU=UU,zg=Array.prototype,BU=function(e){var t=e.reduce;return e===zg||VU(zg,e)&&t===zg.reduce?FU:t},_y=BU,or=E(_y),GU=Ne,au=Array.isArray||function(e){return GU(e)==="Array"},WU=Xt,HU=au,zU=k([].reverse),vy=[1,2];WU({target:"Array",proto:!0,forced:String(vy)===String(vy.reverse())},{reverse:function(){return HU(this)&&(this.length=this.length),zU(this)}});var KU=ir("Array","reverse"),YU=X,qU=KU,Kg=Array.prototype,XU=function(e){var t=e.reverse;return e===Kg||YU(Kg,e)&&t===Kg.reverse?qU:t},Ey=XU,yy=E(Ey),JU=Cg,wy=xl("keys"),Jh=function(e){return wy[e]||(wy[e]=JU(e))},$U=!y(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),QU=Yn,ZU=Ae,e5=yi,t5=$U,Sy=Jh("IE_PROTO"),Yg=Object,s5=Yg.prototype,qg=t5?Yg.getPrototypeOf:function(e){var t=e5(e);if(QU(t,Sy))return t[Sy];var s=t.constructor;return ZU(s)&&t instanceof s?s.prototype:t instanceof Yg?s5:null},n5=k,a5=Bn,r5=We,i5=function(e){return r5(e)||e===null},o5=String,c5=TypeError,l5=function(e,t,s){try{return n5(a5(Object.getOwnPropertyDescriptor(e,t)[s]))}catch{}},d5=We,u5=Ze,h5=function(e){if(i5(e))return e;throw new c5("Can't set "+o5(e)+" as a prototype")},p5=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,s={};try{(e=l5(Object.prototype,"__proto__","set"))(s,[]),t=s instanceof Array}catch{}return function(n,r){return u5(n),h5(r),d5(n)&&(t?e(n,r):n.__proto__=r),n}}():void 0),$h={},Qh={},Xg=Yn,m5=ts,f5=Vg.indexOf,g5=Qh,Ny=k([].push),Ty=function(e,t){var s,n=m5(e),r=0,i=[];for(s in n)!Xg(g5,s)&&Xg(n,s)&&Ny(i,s);for(;t.length>r;)Xg(n,s=t[r++])&&(~f5(i,s)||Ny(i,s));return i},Jg=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],x5=Ty,b5=Jg.concat("length","prototype");$h.f=Object.getOwnPropertyNames||function(e){return x5(e,b5)};var ru={};ru.f=Object.getOwnPropertySymbols;var _5=De,v5=$h,E5=ru,y5=ka,w5=k([].concat),S5=_5("Reflect","ownKeys")||function(e){var t=v5.f(y5(e)),s=E5.f;return s?w5(t,s(e)):t},Ry=Yn,N5=S5,T5=fe,R5=wr,$g={},C5=Ty,I5=Jg,Zh=Object.keys||function(e){return C5(e,I5)},A5=le,O5=ly,D5=wr,k5=ka,j5=ts,P5=Zh;$g.f=A5&&!O5?Object.defineProperties:function(e,t){k5(e);for(var s,n=j5(t),r=P5(t),i=r.length,o=0;i>o;)D5.f(e,s=r[o++],n[s]);return e};var ep,Cy=De("document","documentElement"),L5=ka,M5=$g,Iy=Jg,U5=Qh,V5=Cy,F5=Dg,Qg="prototype",Zg="script",Ay=Jh("IE_PROTO"),e0=function(){},Oy=function(e){return"<"+Zg+">"+e+"</"+Zg+">"},Dy=function(e){e.write(Oy("")),e.close();var t=e.parentWindow.Object;return e=null,t},tp=function(){try{ep=new ActiveXObject("htmlfile")}catch{}var e,t,s;tp=typeof document<"u"?document.domain&&ep?Dy(ep):(t=F5("iframe"),s="java"+Zg+":",t.style.display="none",V5.appendChild(t),t.src=String(s),(e=t.contentWindow.document).open(),e.write(Oy("document.F=Object")),e.close(),e.F):Dy(ep);for(var n=Iy.length;n--;)delete tp[Qg][Iy[n]];return tp()};U5[Ay]=!0;var iu=Object.create||function(e,t){var s;return e!==null?(e0[Qg]=L5(e),s=new e0,e0[Qg]=null,s[Ay]=e):s=tp(),t===void 0?s:M5.f(s,t)},B5=We,G5=pc,ky=Error,W5=k("".replace),H5=String(new ky("zxcasd").stack),jy=/\n\s*at [^:]*:[^\n]*/,z5=jy.test(H5),K5=Ke,Y5=!y(function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",K5(1,7)),e.stack!==7)}),q5=pc,X5=function(e,t){if(z5&&typeof e=="string"&&!ky.prepareStackTrace)for(;t--;)e=W5(e,jy,"");return e},J5=Y5,Py=Error.captureStackTrace,El={},$5=El,Q5=$s("iterator"),Z5=Array.prototype,Ly=function(e){return e!==void 0&&($5.Array===e||Z5[Q5]===e)},e4=Io,My=To,t4=As,s4=El,n4=$s("iterator"),sp=function(e){if(!t4(e))return My(e,n4)||My(e,"@@iterator")||s4[e4(e)]},a4=oe,r4=Bn,i4=ka,o4=ln,c4=sp,l4=TypeError,t0=function(e,t){var s=arguments.length<2?c4(e):t;if(r4(s))return i4(a4(s,e));throw new l4(o4(e)+" is not iterable")},d4=oe,Uy=ka,u4=To,Vy=function(e,t,s){var n,r;Uy(e);try{if(!(n=u4(e,"return"))){if(t==="throw")throw s;return s}n=d4(n,e)}catch(i){r=!0,n=i}if(t==="throw")throw s;if(r)throw n;return Uy(n),s},h4=Ro,p4=oe,m4=ka,f4=ln,g4=Ly,x4=Co,Fy=X,b4=t0,_4=sp,By=Vy,v4=TypeError,np=function(e,t){this.stopped=e,this.result=t},Gy=np.prototype,ou=function(e,t,s){var n,r,i,o,c,l,d,h=s&&s.that,p=!(!s||!s.AS_ENTRIES),m=!(!s||!s.IS_RECORD),g=!(!s||!s.IS_ITERATOR),T=!(!s||!s.INTERRUPTED),w=h4(t,h),S=function(O){return n&&By(n,"normal"),new np(!0,O)},I=function(O){return p?(m4(O),T?w(O[0],O[1],S):w(O[0],O[1])):T?w(O,S):w(O)};if(m)n=e.iterator;else if(g)n=e;else{if(!(r=_4(e)))throw new v4(f4(e)+" is not iterable");if(g4(r)){for(i=0,o=x4(e);o>i;i++)if((c=I(e[i]))&&Fy(Gy,c))return c;return new np(!1)}n=b4(e,r)}for(l=m?e.next:n.next;!(d=p4(l,n)).done;){try{c=I(d.value)}catch(O){By(n,"throw",O)}if(typeof c=="object"&&c&&Fy(Gy,c))return c}return new np(!1)},E4=ja,y4=Xt,w4=X,S4=qg,ap=p5,N4=function(e,t,s){for(var n=N5(t),r=R5.f,i=T5.f,o=0;o<n.length;o++){var c=n[o];Ry(e,c)||s&&Ry(s,c)||r(e,c,i(t,c))}},Wy=iu,s0=pc,n0=Ke,T4=function(e,t){B5(t)&&"cause"in t&&G5(e,"cause",t.cause)},R4=function(e,t,s,n){J5&&(Py?Py(e,t):q5(e,"stack",X5(s,n)))},C4=ou,I4=function(e,t){return e===void 0?arguments.length<2?"":t:E4(e)},A4=$s("toStringTag"),rp=Error,O4=[].push,yl=function(e,t){var s,n=w4(a0,this);ap?s=ap(new rp,n?S4(this):a0):(s=n?this:Wy(a0),s0(s,A4,"Error")),t!==void 0&&s0(s,"message",I4(t)),R4(s,yl,s.stack,1),arguments.length>2&&T4(s,arguments[2]);var r=[];return C4(e,O4,{that:r}),s0(s,"errors",r),s};ap?ap(yl,rp):N4(yl,rp,{name:!0});var a0=yl.prototype=Wy(rp.prototype,{constructor:n0(1,yl),message:n0(1,""),name:n0(1,"AggregateError")});y4({global:!0},{AggregateError:yl});var ip,cu,op,D4=Ae,Hy=D.WeakMap,k4=D4(Hy)&&/native code/.test(String(Hy)),zy=D,j4=We,P4=pc,r0=Yn,i0=Rg,L4=Jh,M4=Qh,Ky="Object already initialized",o0=zy.TypeError,U4=zy.WeakMap;if(k4||i0.state){var wi=i0.state||(i0.state=new U4);wi.get=wi.get,wi.has=wi.has,wi.set=wi.set,ip=function(e,t){if(wi.has(e))throw new o0(Ky);return t.facade=e,wi.set(e,t),t},cu=function(e){return wi.get(e)||{}},op=function(e){return wi.has(e)}}else{var wl=L4("state");M4[wl]=!0,ip=function(e,t){if(r0(e,wl))throw new o0(Ky);return t.facade=e,P4(e,wl,t),t},cu=function(e){return r0(e,wl)?e[wl]:{}},op=function(e){return r0(e,wl)}}var mc,Yy,qy,fc={set:ip,get:cu,has:op,enforce:function(e){return op(e)?cu(e):ip(e,{})},getterFor:function(e){return function(t){var s;if(!j4(t)||(s=cu(t)).type!==e)throw new o0("Incompatible receiver, "+e+" required");return s}}},c0=le,V4=Yn,Xy=Function.prototype,F4=c0&&Object.getOwnPropertyDescriptor,Jy=V4(Xy,"name"),$y={PROPER:Jy&&(function(){}).name==="something",CONFIGURABLE:Jy&&(!c0||c0&&F4(Xy,"name").configurable)},B4=pc,Ao=function(e,t,s,n){return n&&n.enumerable?e[t]=s:B4(e,t,s),e},G4=y,W4=Ae,H4=We,z4=iu,Qy=qg,K4=Ao,l0=$s("iterator"),Zy=!1;[].keys&&("next"in(qy=[].keys())?(Yy=Qy(Qy(qy)))!==Object.prototype&&(mc=Yy):Zy=!0);var Y4=!H4(mc)||G4(function(){var e={};return mc[l0].call(e)!==e});W4((mc=Y4?{}:z4(mc))[l0])||K4(mc,l0,function(){return this});var ew={IteratorPrototype:mc,BUGGY_SAFARI_ITERATORS:Zy},q4=Io,X4=Bg?{}.toString:function(){return"[object "+q4(this)+"]"},J4=Bg,$4=wr.f,Q4=pc,Z4=Yn,eV=X4,tw=$s("toStringTag"),Qi=function(e,t,s,n){var r=s?e:e&&e.prototype;r&&(Z4(r,tw)||$4(r,tw,{configurable:!0,value:t}),n&&!J4&&Q4(r,"toString",eV))},tV=ew.IteratorPrototype,sV=iu,nV=Ke,aV=Qi,rV=El,iV=function(){return this},d0=function(e,t,s,n){var r=t+" Iterator";return e.prototype=sV(tV,{next:nV(+!n,s)}),aV(e,r,!1,!0),rV[r]=iV,e},oV=Xt,cV=oe,lV=$y,dV=d0,uV=qg,hV=Qi,sw=Ao,nw=El,pV=ew,mV=lV.PROPER,cp=pV.BUGGY_SAFARI_ITERATORS,u0=$s("iterator"),aw="keys",lp="values",rw="entries",fV=function(){return this},iw=function(e,t,s,n,r,i,o){dV(s,t,n);var c,l,d,h=function(I){if(I===r&&w)return w;if(!cp&&I&&I in g)return g[I];switch(I){case aw:case lp:case rw:return function(){return new s(this,I)}}return function(){return new s(this)}},p=t+" Iterator",m=!1,g=e.prototype,T=g[u0]||g["@@iterator"]||r&&g[r],w=!cp&&T||h(r),S=t==="Array"&&g.entries||T;if(S&&(c=uV(S.call(new e)))!==Object.prototype&&c.next&&(hV(c,p,!0,!0),nw[p]=fV),mV&&r===lp&&T&&T.name!==lp&&(m=!0,w=function(){return cV(T,this)}),r)if(l={values:h(lp),keys:i?w:h(aw),entries:h(rw)},o)for(d in l)(cp||m||!(d in g))&&sw(g,d,l[d]);else oV({target:t,proto:!0,forced:cp||m},l);return o&&g[u0]!==w&&sw(g,u0,w,{}),nw[t]=w,l},dp=function(e,t){return{value:e,done:t}},gV=ts,ow=El,cw=fc;wr.f;var xV=iw,up=dp,lw="Array Iterator",bV=cw.set,_V=cw.getterFor(lw);xV(Array,"Array",function(e,t){bV(this,{type:lw,target:gV(e),index:0,kind:t})},function(){var e=_V(this),t=e.target,s=e.index++;if(!t||s>=t.length)return e.target=null,up(void 0,!0);switch(e.kind){case"keys":return up(s,!1);case"values":return up(t[s],!1)}return up([s,t[s]],!1)},"values"),ow.Arguments=ow.Array;var vV=wr,hp=function(e,t,s){return vV.f(e,t,s)},EV=De,yV=hp,wV=le,dw=$s("species"),SV=X,NV=TypeError,h0=function(e,t){if(SV(t,e))return e;throw new NV("Incorrect invocation")},TV=Ae,p0=Rg,RV=k(Function.toString);TV(p0.inspectSource)||(p0.inspectSource=function(e){return RV(e)});var uw=p0.inspectSource,CV=k,IV=y,hw=Ae,AV=Io,OV=uw,pw=function(){},mw=De("Reflect","construct"),m0=/^\s*(?:class|function)\b/,DV=CV(m0.exec),kV=!m0.test(pw),lu=function(e){if(!hw(e))return!1;try{return mw(pw,[],e),!0}catch{return!1}},fw=function(e){if(!hw(e))return!1;switch(AV(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return kV||!!DV(m0,OV(e))}catch{return!0}};fw.sham=!0;var du,Sl,gw,f0,pp=!mw||IV(function(){var e;return lu(lu.call)||!lu(Object)||!lu(function(){e=!0})||e})?fw:lu,jV=pp,PV=ln,LV=TypeError,xw=ka,MV=function(e){if(jV(e))return e;throw new LV(PV(e)+" is not a constructor")},UV=As,VV=$s("species"),g0=function(e,t){var s,n=xw(e).constructor;return n===void 0||UV(s=xw(n)[VV])?t:MV(s)},Oo=k([].slice),FV=TypeError,gc=function(e,t){if(e<t)throw new FV("Not enough arguments");return e},bw=/(?:ipad|iphone|ipod).*applewebkit/i.test(Gt),cr=D,BV=Z,GV=Ro,_w=Ae,WV=Yn,vw=y,Ew=Cy,HV=Oo,yw=Dg,zV=gc,KV=bw,YV=Xh,x0=cr.setImmediate,b0=cr.clearImmediate,qV=cr.process,_0=cr.Dispatch,XV=cr.Function,ww=cr.MessageChannel,JV=cr.String,v0=0,uu={},Sw="onreadystatechange";vw(function(){du=cr.location});var E0=function(e){if(WV(uu,e)){var t=uu[e];delete uu[e],t()}},y0=function(e){return function(){E0(e)}},Nw=function(e){E0(e.data)},Tw=function(e){cr.postMessage(JV(e),du.protocol+"//"+du.host)};x0&&b0||(x0=function(e){zV(arguments.length,1);var t=_w(e)?e:XV(e),s=HV(arguments,1);return uu[++v0]=function(){BV(t,void 0,s)},Sl(v0),v0},b0=function(e){delete uu[e]},YV?Sl=function(e){qV.nextTick(y0(e))}:_0&&_0.now?Sl=function(e){_0.now(y0(e))}:ww&&!KV?(f0=(gw=new ww).port2,gw.port1.onmessage=Nw,Sl=GV(f0.postMessage,f0)):cr.addEventListener&&_w(cr.postMessage)&&!cr.importScripts&&du&&du.protocol!=="file:"&&!vw(Tw)?(Sl=Tw,cr.addEventListener("message",Nw,!1)):Sl=Sw in yw("script")?function(e){Ew.appendChild(yw("script"))[Sw]=function(){Ew.removeChild(this),E0(e)}}:function(e){setTimeout(y0(e),0)});var mp={set:x0,clear:b0},Rw=D,$V=le,QV=Object.getOwnPropertyDescriptor,Cw=function(e){if(!$V)return Rw[e];var t=QV(Rw,e);return t&&t.value},Iw=function(){this.head=null,this.tail=null};Iw.prototype={add:function(e){var t={item:e,next:null},s=this.tail;s?s.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var Nl,w0,S0,N0,Aw,Ow=Iw,ZV=/ipad|iphone|ipod/i.test(Gt)&&typeof Pebble<"u",e3=/web0s(?!.*chrome)/i.test(Gt),Tl=D,t3=Cw,Dw=Ro,T0=mp.set,s3=Ow,n3=bw,a3=ZV,r3=e3,R0=Xh,kw=Tl.MutationObserver||Tl.WebKitMutationObserver,jw=Tl.document,Pw=Tl.process,fp=Tl.Promise,C0=t3("queueMicrotask");if(!C0){var gp=new s3,xp=function(){var e,t;for(R0&&(e=Pw.domain)&&e.exit();t=gp.get();)try{t()}catch(s){throw gp.head&&Nl(),s}e&&e.enter()};n3||R0||r3||!kw||!jw?!a3&&fp&&fp.resolve?((N0=fp.resolve(void 0)).constructor=fp,Aw=Dw(N0.then,N0),Nl=function(){Aw(xp)}):R0?Nl=function(){Pw.nextTick(xp)}:(T0=Dw(T0,Tl),Nl=function(){T0(xp)}):(w0=!0,S0=jw.createTextNode(""),new kw(xp).observe(S0,{characterData:!0}),Nl=function(){S0.data=w0=!w0}),C0=function(e){gp.head||Nl(),gp.add(e)}}var Lw=C0,Rl=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},xc=D.Promise,i3=D,hu=xc,o3=Ae,c3=cy,l3=uw,d3=$s,Mw=Hg,I0=ze,Uw=hu&&hu.prototype,u3=d3("species"),Vw=o3(i3.PromiseRejectionEvent),h3=c3("Promise",function(){var e=l3(hu),t=e!==String(hu);if(!t&&I0===66||!Uw.catch||!Uw.finally)return!0;if(!I0||I0<51||!/native code/.test(e)){var s=new hu(function(r){r(1)}),n=function(r){r(function(){},function(){})};if((s.constructor={})[u3]=n,!(s.then(function(){})instanceof n))return!0}return!(t||Mw!=="BROWSER"&&Mw!=="DENO"||Vw)}),pu={CONSTRUCTOR:h3,REJECTION_EVENT:Vw},Si={},Fw=Bn,p3=TypeError,m3=function(e){var t,s;this.promise=new e(function(n,r){if(t!==void 0||s!==void 0)throw new p3("Bad Promise constructor");t=n,s=r}),this.resolve=Fw(t),this.reject=Fw(s)};Si.f=function(e){return new m3(e)};var A0,Bw,Gw,f3=Xt,bp=Xh,Do=D,g3=rt,mu=oe,x3=Ao,b3=Qi,_3=function(e){var t=EV(e);wV&&t&&!t[dw]&&yV(t,dw,{configurable:!0,get:function(){return this}})},v3=Bn,O0=Ae,E3=We,y3=h0,w3=g0,Ww=mp.set,D0=Lw,S3=function(e,t){try{arguments.length===1?console.error(e):console.error(e,t)}catch{}},N3=Rl,T3=Ow,Hw=fc,k0=xc,zw=pu,Kw=Si,_p="Promise",Yw=zw.CONSTRUCTOR,R3=zw.REJECTION_EVENT,j0=Hw.getterFor(_p),C3=Hw.set,I3=k0&&k0.prototype,fu=k0,P0=I3,qw=Do.TypeError,L0=Do.document,M0=Do.process,U0=Kw.f,A3=U0,O3=!!(L0&&L0.createEvent&&Do.dispatchEvent),Xw="unhandledrejection",Jw=function(e){var t;return!(!E3(e)||!O0(t=e.then))&&t},$w=function(e,t){var s,n,r,i=t.value,o=t.state===1,c=o?e.ok:e.fail,l=e.resolve,d=e.reject,h=e.domain;try{c?(o||(t.rejection===2&&k3(t),t.rejection=1),c===!0?s=i:(h&&h.enter(),s=c(i),h&&(h.exit(),r=!0)),s===e.promise?d(new qw("Promise-chain cycle")):(n=Jw(s))?mu(n,s,l,d):l(s)):d(i)}catch(p){h&&!r&&h.exit(),d(p)}},Qw=function(e,t){e.notified||(e.notified=!0,D0(function(){for(var s,n=e.reactions;s=n.get();)$w(s,e);e.notified=!1,t&&!e.rejection&&D3(e)}))},Zw=function(e,t,s){var n,r;O3?((n=L0.createEvent("Event")).promise=t,n.reason=s,n.initEvent(e,!1,!0),Do.dispatchEvent(n)):n={promise:t,reason:s},!R3&&(r=Do["on"+e])?r(n):e===Xw&&S3("Unhandled promise rejection",s)},D3=function(e){mu(Ww,Do,function(){var t,s=e.facade,n=e.value;if(eS(e)&&(t=N3(function(){bp?M0.emit("unhandledRejection",n,s):Zw(Xw,s,n)}),e.rejection=bp||eS(e)?2:1,t.error))throw t.value})},eS=function(e){return e.rejection!==1&&!e.parent},k3=function(e){mu(Ww,Do,function(){var t=e.facade;bp?M0.emit("rejectionHandled",t):Zw("rejectionhandled",t,e.value)})},Cl=function(e,t,s){return function(n){e(t,n,s)}},Il=function(e,t,s){e.done||(e.done=!0,s&&(e=s),e.value=t,e.state=2,Qw(e,!0))},V0=function(e,t,s){if(!e.done){e.done=!0,s&&(e=s);try{if(e.facade===t)throw new qw("Promise can't be resolved itself");var n=Jw(t);n?D0(function(){var r={done:!1};try{mu(n,t,Cl(V0,r,e),Cl(Il,r,e))}catch(i){Il(r,i,e)}}):(e.value=t,e.state=1,Qw(e,!1))}catch(r){Il({done:!1},r,e)}}};Yw&&(P0=(fu=function(e){y3(this,P0),v3(e),mu(A0,this);var t=j0(this);try{e(Cl(V0,t),Cl(Il,t))}catch(s){Il(t,s)}}).prototype,(A0=function(e){C3(this,{type:_p,done:!1,notified:!1,parent:!1,reactions:new T3,rejection:!1,state:0,value:null})}).prototype=x3(P0,"then",function(e,t){var s=j0(this),n=U0(w3(this,fu));return s.parent=!0,n.ok=!O0(e)||e,n.fail=O0(t)&&t,n.domain=bp?M0.domain:void 0,s.state===0?s.reactions.add(n):D0(function(){$w(n,s)}),n.promise}),Bw=function(){var e=new A0,t=j0(e);this.promise=e,this.resolve=Cl(V0,t),this.reject=Cl(Il,t)},Kw.f=U0=function(e){return e===fu||e===Gw?new Bw(e):A3(e)}),f3({global:!0,wrap:!0,forced:Yw},{Promise:fu}),Gw=g3.Promise,b3(fu,_p,!1,!0),_3(_p);var tS=$s("iterator"),sS=!1;try{var j3=0,nS={next:function(){return{done:!!j3++}},return:function(){sS=!0}};nS[tS]=function(){return this},Array.from(nS,function(){throw 2})}catch{}var P3=xc,L3=function(e,t){try{if(!t&&!sS)return!1}catch{return!1}var s=!1;try{var n={};n[tS]=function(){return{next:function(){return{done:s=!0}}}},e(n)}catch{}return s},vp=pu.CONSTRUCTOR||!L3(function(e){P3.all(e).then(void 0,function(){})}),M3=oe,U3=Bn,V3=Si,F3=Rl,B3=ou;Xt({target:"Promise",stat:!0,forced:vp},{all:function(e){var t=this,s=V3.f(t),n=s.resolve,r=s.reject,i=F3(function(){var o=U3(t.resolve),c=[],l=0,d=1;B3(e,function(h){var p=l++,m=!1;d++,M3(o,t,h).then(function(g){m||(m=!0,c[p]=g,--d||n(c))},r)}),--d||n(c)});return i.error&&r(i.value),s.promise}});var G3=Xt,W3=pu.CONSTRUCTOR;xc&&xc.prototype,G3({target:"Promise",proto:!0,forced:W3,real:!0},{catch:function(e){return this.then(void 0,e)}});var H3=oe,z3=Bn,K3=Si,Y3=Rl,q3=ou;Xt({target:"Promise",stat:!0,forced:vp},{race:function(e){var t=this,s=K3.f(t),n=s.reject,r=Y3(function(){var i=z3(t.resolve);q3(e,function(o){H3(i,t,o).then(s.resolve,n)})});return r.error&&n(r.value),s.promise}});var X3=Si;Xt({target:"Promise",stat:!0,forced:pu.CONSTRUCTOR},{reject:function(e){var t=X3.f(this);return(0,t.reject)(e),t.promise}});var J3=ka,$3=We,Q3=Si,aS=function(e,t){if(J3(e),$3(t)&&t.constructor===e)return t;var s=Q3.f(e);return(0,s.resolve)(t),s.promise},Z3=Xt,eF=xc,tF=pu.CONSTRUCTOR,sF=aS,nF=De("Promise"),aF=!tF;Z3({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return sF(aF&&this===nF?eF:this,e)}});var rF=oe,iF=Bn,oF=Si,cF=Rl,lF=ou;Xt({target:"Promise",stat:!0,forced:vp},{allSettled:function(e){var t=this,s=oF.f(t),n=s.resolve,r=s.reject,i=cF(function(){var o=iF(t.resolve),c=[],l=0,d=1;lF(e,function(h){var p=l++,m=!1;d++,rF(o,t,h).then(function(g){m||(m=!0,c[p]={status:"fulfilled",value:g},--d||n(c))},function(g){m||(m=!0,c[p]={status:"rejected",reason:g},--d||n(c))})}),--d||n(c)});return i.error&&r(i.value),s.promise}});var dF=oe,uF=Bn,hF=De,pF=Si,mF=Rl,fF=ou,rS="No one promise resolved";Xt({target:"Promise",stat:!0,forced:vp},{any:function(e){var t=this,s=hF("AggregateError"),n=pF.f(t),r=n.resolve,i=n.reject,o=mF(function(){var c=uF(t.resolve),l=[],d=0,h=1,p=!1;fF(e,function(m){var g=d++,T=!1;h++,dF(c,t,m).then(function(w){T||p||(p=!0,r(w))},function(w){T||p||(T=!0,l[g]=w,--h||i(new s(l,rS)))})}),--h||i(new s(l,rS))});return o.error&&i(o.value),n.promise}});var gF=Xt,xF=Z,bF=Oo,_F=Si,vF=Bn,iS=Rl,F0=D.Promise,oS=!1;gF({target:"Promise",stat:!0,forced:!F0||!F0.try||iS(function(){F0.try(function(e){oS=e===8},8)}).error||!oS},{try:function(e){var t=arguments.length>1?bF(arguments,1):[],s=_F.f(this),n=iS(function(){return xF(vF(e),void 0,t)});return(n.error?s.reject:s.resolve)(n.value),s.promise}});var EF=Si;Xt({target:"Promise",stat:!0},{withResolvers:function(){var e=EF.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var yF=Xt,B0=xc,wF=y,SF=De,NF=Ae,TF=g0,cS=aS,RF=B0&&B0.prototype;yF({target:"Promise",proto:!0,real:!0,forced:!!B0&&wF(function(){RF.finally.call({then:function(){}},function(){})})},{finally:function(e){var t=TF(this,SF("Promise")),s=NF(e);return this.then(s?function(n){return cS(t,e()).then(function(){return n})}:e,s?function(n){return cS(t,e()).then(function(){throw n})}:e)}});var G0=k,CF=Mg,IF=ja,AF=Ze,OF=G0("".charAt),lS=G0("".charCodeAt),DF=G0("".slice),dS=function(e){return function(t,s){var n,r,i=IF(AF(t)),o=CF(s),c=i.length;return o<0||o>=c?e?"":void 0:(n=lS(i,o))<55296||n>56319||o+1===c||(r=lS(i,o+1))<56320||r>57343?e?OF(i,o):n:e?DF(i,o,o+2):r-56320+(n-55296<<10)+65536}},W0={codeAt:dS(!1),charAt:dS(!0)},kF=W0.charAt,jF=ja,uS=fc,PF=iw,hS=dp,pS="String Iterator",LF=uS.set,MF=uS.getterFor(pS);PF(String,"String",function(e){LF(this,{type:pS,string:jF(e),index:0})},function(){var e,t=MF(this),s=t.string,n=t.index;return n>=s.length?hS(void 0,!0):(e=kF(s,n),t.index+=e.length,hS(e,!1))});var UF=rt.Promise,VF={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},FF=D,BF=Qi,mS=El;for(var H0 in VF)BF(FF[H0],H0),mS[H0]=mS.Array;var fS=UF,Te=E(fS),GF=ir("Array","values"),WF=Io,HF=Yn,zF=X,KF=GF,z0=Array.prototype,YF={DOMTokenList:!0,NodeList:!0},qF=function(e){var t=e.values;return e===z0||zF(z0,e)&&t===z0.values||HF(YF,WF(e))?KF:t},Pa=E(qF),gS=ln,XF=TypeError,xS=Oo,JF=Math.floor,K0=function(e,t){var s=e.length;if(s<8)for(var n,r,i=1;i<s;){for(r=i,n=e[i];r&&t(e[r-1],n)>0;)e[r]=e[--r];r!==i++&&(e[r]=n)}else for(var o=JF(s/2),c=K0(xS(e,0,o),t),l=K0(xS(e,o),t),d=c.length,h=l.length,p=0,m=0;p<d||m<h;)e[p+m]=p<d&&m<h?t(c[p],l[m])<=0?c[p++]:l[m++]:p<d?c[p++]:l[m++];return e},bS=K0,_S=Gt.match(/firefox\/(\d+)/i),$F=!!_S&&+_S[1],QF=/MSIE|Trident/.test(Gt),vS=Gt.match(/AppleWebKit\/(\d+)\./),ZF=!!vS&&+vS[1],e6=Xt,ES=k,t6=Bn,s6=yi,yS=Co,n6=function(e,t){if(!delete e[t])throw new XF("Cannot delete property "+gS(t)+" of "+gS(e))},wS=ja,Y0=y,a6=bS,r6=Yh,SS=$F,i6=QF,NS=ze,TS=ZF,ko=[],RS=ES(ko.sort),o6=ES(ko.push),c6=Y0(function(){ko.sort(void 0)}),l6=Y0(function(){ko.sort(null)}),d6=r6("sort"),CS=!Y0(function(){if(NS)return NS<70;if(!(SS&&SS>3)){if(i6)return!0;if(TS)return TS<603;var e,t,s,n,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:s=3;break;case 68:case 71:s=4;break;default:s=2}for(n=0;n<47;n++)ko.push({k:t+n,v:s})}for(ko.sort(function(i,o){return o.v-i.v}),n=0;n<ko.length;n++)t=ko[n].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return r!=="DGBEFHACIJK"}});e6({target:"Array",proto:!0,forced:c6||!l6||!d6||!CS},{sort:function(e){e!==void 0&&t6(e);var t=s6(this);if(CS)return e===void 0?RS(t):RS(t,e);var s,n,r=[],i=yS(t);for(n=0;n<i;n++)n in t&&o6(r,t[n]);for(a6(r,function(o){return function(c,l){return l===void 0?-1:c===void 0?1:o!==void 0?+o(c,l)||0:wS(c)>wS(l)?1:-1}}(e)),s=yS(r),n=0;n<s;)t[n]=r[n++];for(;n<i;)n6(t,n++);return t}});var u6=ir("Array","sort"),h6=X,p6=u6,q0=Array.prototype,m6=function(e){var t=e.sort;return e===q0||h6(q0,e)&&t===q0.sort?p6:t},bc=E(m6),f6=Xt,g6=k,x6=Ug,b6=RangeError,IS=String.fromCharCode,AS=String.fromCodePoint,_6=g6([].join);f6({target:"String",stat:!0,forced:!!AS&&AS.length!==1},{fromCodePoint:function(e){for(var t,s=[],n=arguments.length,r=0;n>r;){if(t=+arguments[r++],x6(t,1114111)!==t)throw new b6(t+" is not a valid code point");s[r]=t<65536?IS(t):IS(55296+((t-=65536)>>10),t%1024+56320)}return _6(s,"")}});var v6=y,E6=$s("iterator"),Ep=!v6(function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,s=new URLSearchParams("a=1&a=2&b=3"),n="";return e.pathname="c%20d",t.forEach(function(r,i){t.delete("b"),n+=i+r}),s.delete("a",2),s.delete("b",void 0),!e.toJSON||!s.has("a",1)||s.has("a",2)||!s.has("a",void 0)||s.has("b")||!t.size&&!0||!t.sort||e.href!=="https://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[E6]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||n!=="a1c3"||new URL("https://x",void 0).host!=="x"}),y6=Ao,X0=Xt,OS=D,J0=Cw,w6=De,yp=oe,Xr=k,gu=le,DS=Ep,kS=Ao,S6=hp,N6=function(e,t,s){for(var n in t)s&&s.unsafe&&e[n]?e[n]=t[n]:y6(e,n,t[n],s);return e},T6=Qi,R6=d0,$0=fc,jS=h0,Q0=Ae,C6=Yn,I6=Ro,A6=Io,O6=ka,PS=We,La=ja,D6=iu,LS=Ke,MS=t0,k6=sp,wp=dp,Al=gc,j6=bS,P6=$s("iterator"),Ol="URLSearchParams",US=Ol+"Iterator",VS=$0.set,Sr=$0.getterFor(Ol),L6=$0.getterFor(US),FS=J0("fetch"),Sp=J0("Request"),xu=J0("Headers"),Z0=Sp&&Sp.prototype,BS=xu&&xu.prototype,M6=OS.TypeError,U6=OS.encodeURIComponent,V6=String.fromCharCode,F6=w6("String","fromCodePoint"),B6=parseInt,Np=Xr("".charAt),GS=Xr([].join),jo=Xr([].push),WS=Xr("".replace),G6=Xr([].shift),HS=Xr([].splice),zS=Xr("".split),KS=Xr("".slice),W6=Xr(/./.exec),H6=/\+/g,z6=/^[0-9a-f]+$/i,YS=function(e,t){var s=KS(e,t,t+2);return W6(z6,s)?B6(s,16):NaN},K6=function(e){for(var t=0,s=128;s>0&&e&s;s>>=1)t++;return t},Y6=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},qS=function(e){for(var t=(e=WS(e,H6," ")).length,s="",n=0;n<t;){var r=Np(e,n);if(r==="%"){if(Np(e,n+1)==="%"||n+3>t){s+="%",n++;continue}var i=YS(e,n+1);if(i!=i){s+=r,n++;continue}n+=2;var o=K6(i);if(o===0)r=V6(i);else{if(o===1||o>4){s+="",n++;continue}for(var c=[i],l=1;l<o&&!(++n+3>t||Np(e,n)!=="%");){var d=YS(e,n+1);if(d!=d){n+=3;break}if(d>191||d<128)break;jo(c,d),n+=2,l++}if(c.length!==o){s+="";continue}var h=Y6(c);h===null?s+="":r=F6(h)}}s+=r,n++}return s},q6=/[!'()~]|%20/g,X6={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},J6=function(e){return X6[e]},XS=function(e){return WS(U6(e),q6,J6)},ex=R6(function(e,t){VS(this,{type:US,target:Sr(e).entries,index:0,kind:t})},Ol,function(){var e=L6(this),t=e.target,s=e.index++;if(!t||s>=t.length)return e.target=null,wp(void 0,!0);var n=t[s];switch(e.kind){case"keys":return wp(n.key,!1);case"values":return wp(n.value,!1)}return wp([n.key,n.value],!1)},!0),JS=function(e){this.entries=[],this.url=null,e!==void 0&&(PS(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?Np(e,0)==="?"?KS(e,1):e:La(e)))};JS.prototype={type:Ol,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,s,n,r,i,o,c,l=this.entries,d=k6(e);if(d)for(s=(t=MS(e,d)).next;!(n=yp(s,t)).done;){if(i=(r=MS(O6(n.value))).next,(o=yp(i,r)).done||(c=yp(i,r)).done||!yp(i,r).done)throw new M6("Expected sequence with length 2");jo(l,{key:La(o.value),value:La(c.value)})}else for(var h in e)C6(e,h)&&jo(l,{key:h,value:La(e[h])})},parseQuery:function(e){if(e)for(var t,s,n=this.entries,r=zS(e,"&"),i=0;i<r.length;)(t=r[i++]).length&&(s=zS(t,"="),jo(n,{key:qS(G6(s)),value:qS(GS(s,"="))}))},serialize:function(){for(var e,t=this.entries,s=[],n=0;n<t.length;)e=t[n++],jo(s,XS(e.key)+"="+XS(e.value));return GS(s,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Tp=function(){jS(this,Dl);var e=VS(this,new JS(arguments.length>0?arguments[0]:void 0));gu||(this.size=e.entries.length)},Dl=Tp.prototype;if(N6(Dl,{append:function(e,t){var s=Sr(this);Al(arguments.length,2),jo(s.entries,{key:La(e),value:La(t)}),gu||this.length++,s.updateURL()},delete:function(e){for(var t=Sr(this),s=Al(arguments.length,1),n=t.entries,r=La(e),i=s<2?void 0:arguments[1],o=i===void 0?i:La(i),c=0;c<n.length;){var l=n[c];if(l.key!==r||o!==void 0&&l.value!==o)c++;else if(HS(n,c,1),o!==void 0)break}gu||(this.size=n.length),t.updateURL()},get:function(e){var t=Sr(this).entries;Al(arguments.length,1);for(var s=La(e),n=0;n<t.length;n++)if(t[n].key===s)return t[n].value;return null},getAll:function(e){var t=Sr(this).entries;Al(arguments.length,1);for(var s=La(e),n=[],r=0;r<t.length;r++)t[r].key===s&&jo(n,t[r].value);return n},has:function(e){for(var t=Sr(this).entries,s=Al(arguments.length,1),n=La(e),r=s<2?void 0:arguments[1],i=r===void 0?r:La(r),o=0;o<t.length;){var c=t[o++];if(c.key===n&&(i===void 0||c.value===i))return!0}return!1},set:function(e,t){var s=Sr(this);Al(arguments.length,1);for(var n,r=s.entries,i=!1,o=La(e),c=La(t),l=0;l<r.length;l++)(n=r[l]).key===o&&(i?HS(r,l--,1):(i=!0,n.value=c));i||jo(r,{key:o,value:c}),gu||(this.size=r.length),s.updateURL()},sort:function(){var e=Sr(this);j6(e.entries,function(t,s){return t.key>s.key?1:-1}),e.updateURL()},forEach:function(e){for(var t,s=Sr(this).entries,n=I6(e,arguments.length>1?arguments[1]:void 0),r=0;r<s.length;)n((t=s[r++]).value,t.key,this)},keys:function(){return new ex(this,"keys")},values:function(){return new ex(this,"values")},entries:function(){return new ex(this,"entries")}},{enumerable:!0}),kS(Dl,P6,Dl.entries,{}),kS(Dl,"toString",function(){return Sr(this).serialize()},{enumerable:!0}),gu&&S6(Dl,"size",{get:function(){return Sr(this).entries.length},configurable:!0,enumerable:!0}),T6(Tp,Ol),X0({global:!0,forced:!DS},{URLSearchParams:Tp}),!DS&&Q0(xu)){var $6=Xr(BS.has),Q6=Xr(BS.set),$S=function(e){if(PS(e)){var t,s=e.body;if(A6(s)===Ol)return t=e.headers?new xu(e.headers):new xu,$6(t,"content-type")||Q6(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),D6(e,{body:LS(0,La(s)),headers:LS(0,t)})}return e};if(Q0(FS)&&X0({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return FS(e,arguments.length>1?$S(arguments[1]):{})}}),Q0(Sp)){var tx=function(e){return jS(this,Z0),new Sp(e,arguments.length>1?$S(arguments[1]):{})};Z0.constructor=tx,tx.prototype=Z0,X0({global:!0,dontCallGetSet:!0,forced:!0},{Request:tx})}}var Nr,Z6={URLSearchParams:Tp,getState:Sr},eB=rt.URLSearchParams,QS=le,tB=k,sB=oe,nB=y,sx=Zh,aB=ru,rB=J,iB=yi,oB=ys,kl=Object.assign,ZS=Object.defineProperty,cB=tB([].concat),lB=!kl||nB(function(){if(QS&&kl({b:1},kl(ZS({},"a",{enumerable:!0,get:function(){ZS(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},s=Symbol("assign detection"),n="abcdefghijklmnopqrst";return e[s]=7,n.split("").forEach(function(r){t[r]=r}),kl({},e)[s]!==7||sx(kl({},t)).join("")!==n})?function(e,t){for(var s=iB(e),n=arguments.length,r=1,i=aB.f,o=rB.f;n>r;)for(var c,l=oB(arguments[r++]),d=i?cB(sx(l),i(l)):sx(l),h=d.length,p=0;h>p;)c=d[p++],QS&&!sB(o,l,c)||(s[c]=l[c]);return s}:kl,dB=ka,uB=Vy,hB=le,pB=wr,mB=Ke,nx=function(e,t,s){hB?pB.f(e,t,mB(0,s)):e[t]=s},fB=Ro,gB=oe,xB=yi,bB=function(e,t,s,n){try{return n?t(dB(s)[0],s[1]):t(s)}catch(r){uB(e,"throw",r)}},_B=Ly,vB=pp,EB=Co,eN=nx,yB=t0,wB=sp,tN=Array,_c=k,ax=2147483647,SB=/[^\0-\u007E]/,sN=/[.\u3002\uFF0E\uFF61]/g,nN="Overflow: input needs wider integers to process",aN=RangeError,NB=_c(sN.exec),jl=Math.floor,rx=String.fromCharCode,rN=_c("".charCodeAt),iN=_c([].join),Po=_c([].push),TB=_c("".replace),RB=_c("".split),CB=_c("".toLowerCase),oN=function(e){return e+22+75*(e<26)},IB=function(e,t,s){var n=0;for(e=s?jl(e/700):e>>1,e+=jl(e/t);e>455;)e=jl(e/35),n+=36;return jl(n+36*e/(e+38))},AB=function(e){var t=[];e=function(I){for(var O=[],M=0,z=I.length;M<z;){var K=rN(I,M++);if(K>=55296&&K<=56319&&M<z){var V=rN(I,M++);(64512&V)==56320?Po(O,((1023&K)<<10)+(1023&V)+65536):(Po(O,K),M--)}else Po(O,K)}return O}(e);var s,n,r=e.length,i=128,o=0,c=72;for(s=0;s<e.length;s++)(n=e[s])<128&&Po(t,rx(n));var l=t.length,d=l;for(l&&Po(t,"-");d<r;){var h=ax;for(s=0;s<e.length;s++)(n=e[s])>=i&&n<h&&(h=n);var p=d+1;if(h-i>jl((ax-o)/p))throw new aN(nN);for(o+=(h-i)*p,i=h,s=0;s<e.length;s++){if((n=e[s])<i&&++o>ax)throw new aN(nN);if(n===i){for(var m=o,g=36;;){var T=g<=c?1:g>=c+26?26:g-c;if(m<T)break;var w=m-T,S=36-T;Po(t,rx(oN(T+w%S))),m=jl(w/S),g+=36}Po(t,rx(oN(m))),c=IB(o,p,d===l),o=0,d++}}o++,i++}return iN(t,"")},OB=Xt,ix=le,DB=Ep,ox=D,cN=Ro,Tr=k,Rp=Ao,Rr=hp,kB=h0,cx=Yn,lx=lB,Pl=function(e){var t=xB(e),s=vB(this),n=arguments.length,r=n>1?arguments[1]:void 0,i=r!==void 0;i&&(r=fB(r,n>2?arguments[2]:void 0));var o,c,l,d,h,p,m=wB(t),g=0;if(!m||this===tN&&_B(m))for(o=EB(t),c=s?new this(o):tN(o);o>g;g++)p=i?r(t[g],g):t[g],eN(c,g,p);else for(c=s?new this:[],h=(d=yB(t,m)).next;!(l=gB(h,d)).done;g++)p=i?bB(d,r,[l.value,g],!0):l.value,eN(c,g,p);return c.length=g,c},Jr=Oo,jB=W0.codeAt,PB=function(e){var t,s,n=[],r=RB(TB(CB(e),sN,"."),".");for(t=0;t<r.length;t++)s=r[t],Po(n,NB(SB,s)?"xn--"+AB(s):s);return iN(n,".")},Zi=ja,LB=Qi,MB=gc,lN=Z6,dN=fc,UB=dN.set,Cp=dN.getterFor("URL"),VB=lN.URLSearchParams,FB=lN.getState,bu=ox.URL,dx=ox.TypeError,Ip=ox.parseInt,BB=Math.floor,uN=Math.pow,Cr=Tr("".charAt),$r=Tr(/./.exec),_u=Tr([].join),GB=Tr(1.1.toString),WB=Tr([].pop),Ll=Tr([].push),ux=Tr("".replace),HB=Tr([].shift),zB=Tr("".split),vu=Tr("".slice),Ap=Tr("".toLowerCase),KB=Tr([].unshift),hx="Invalid scheme",vc="Invalid host",hN="Invalid port",pN=/[a-z]/i,YB=/[\d+-.a-z]/i,px=/\d/,qB=/^0x/i,XB=/^[0-7]+$/,JB=/^\d+$/,mN=/^[\da-f]+$/i,$B=/[\0\t\n\r #%/:<>?@[\\\]^|]/,QB=/[\0\t\n\r #/:<>?@[\\\]^|]/,ZB=/^[\u0000-\u0020]+/,e8=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,t8=/[\t\n\r]/g,Eu=function(e){var t,s,n,r;if(typeof e=="number"){for(t=[],s=0;s<4;s++)KB(t,e%256),e=BB(e/256);return _u(t,".")}if(typeof e=="object"){for(t="",n=function(i){for(var o=null,c=1,l=null,d=0,h=0;h<8;h++)i[h]!==0?(d>c&&(o=l,c=d),l=null,d=0):(l===null&&(l=h),++d);return d>c?l:o}(e),s=0;s<8;s++)r&&e[s]===0||(r&&(r=!1),n===s?(t+=s?":":"::",r=!0):(t+=GB(e[s],16),s<7&&(t+=":")));return"["+t+"]"}return e},Op={},fN=lx({},Op,{" ":1,'"':1,"<":1,">":1,"`":1}),gN=lx({},fN,{"#":1,"?":1,"{":1,"}":1}),mx=lx({},gN,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Lo=function(e,t){var s=jB(e,0);return s>32&&s<127&&!cx(t,e)?e:encodeURIComponent(e)},Dp={ftp:21,file:null,http:80,https:443,ws:80,wss:443},yu=function(e,t){var s;return e.length===2&&$r(pN,Cr(e,0))&&((s=Cr(e,1))===":"||!t&&s==="|")},xN=function(e){var t;return e.length>1&&yu(vu(e,0,2))&&(e.length===2||(t=Cr(e,2))==="/"||t==="\\"||t==="?"||t==="#")},s8=function(e){return e==="."||Ap(e)==="%2e"},fx={},bN={},gx={},_N={},vN={},xx={},EN={},yN={},kp={},jp={},bx={},_x={},vx={},Ex={},wN={},yx={},Ml={},Ni={},SN={},Ec={},eo={},wx=function(e,t,s){var n,r,i,o=Zi(e);if(t){if(r=this.parse(o))throw new dx(r);this.searchParams=null}else{if(s!==void 0&&(n=new wx(s,!0)),r=this.parse(o,null,n))throw new dx(r);(i=FB(new VB)).bindURL(this),this.searchParams=i}};wx.prototype={type:"URL",parse:function(e,t,s){var n,r,i,o,c,l=this,d=t||fx,h=0,p="",m=!1,g=!1,T=!1;for(e=Zi(e),t||(l.scheme="",l.username="",l.password="",l.host=null,l.port=null,l.path=[],l.query=null,l.fragment=null,l.cannotBeABaseURL=!1,e=ux(e,ZB,""),e=ux(e,e8,"$1")),e=ux(e,t8,""),n=Pl(e);h<=n.length;){switch(r=n[h],d){case fx:if(!r||!$r(pN,r)){if(t)return hx;d=gx;continue}p+=Ap(r),d=bN;break;case bN:if(r&&($r(YB,r)||r==="+"||r==="-"||r==="."))p+=Ap(r);else{if(r!==":"){if(t)return hx;p="",d=gx,h=0;continue}if(t&&(l.isSpecial()!==cx(Dp,p)||p==="file"&&(l.includesCredentials()||l.port!==null)||l.scheme==="file"&&!l.host))return;if(l.scheme=p,t)return void(l.isSpecial()&&Dp[l.scheme]===l.port&&(l.port=null));p="",l.scheme==="file"?d=Ex:l.isSpecial()&&s&&s.scheme===l.scheme?d=_N:l.isSpecial()?d=yN:n[h+1]==="/"?(d=vN,h++):(l.cannotBeABaseURL=!0,Ll(l.path,""),d=SN)}break;case gx:if(!s||s.cannotBeABaseURL&&r!=="#")return hx;if(s.cannotBeABaseURL&&r==="#"){l.scheme=s.scheme,l.path=Jr(s.path),l.query=s.query,l.fragment="",l.cannotBeABaseURL=!0,d=eo;break}d=s.scheme==="file"?Ex:xx;continue;case _N:if(r!=="/"||n[h+1]!=="/"){d=xx;continue}d=kp,h++;break;case vN:if(r==="/"){d=jp;break}d=Ni;continue;case xx:if(l.scheme=s.scheme,r===Nr)l.username=s.username,l.password=s.password,l.host=s.host,l.port=s.port,l.path=Jr(s.path),l.query=s.query;else if(r==="/"||r==="\\"&&l.isSpecial())d=EN;else if(r==="?")l.username=s.username,l.password=s.password,l.host=s.host,l.port=s.port,l.path=Jr(s.path),l.query="",d=Ec;else{if(r!=="#"){l.username=s.username,l.password=s.password,l.host=s.host,l.port=s.port,l.path=Jr(s.path),l.path.length--,d=Ni;continue}l.username=s.username,l.password=s.password,l.host=s.host,l.port=s.port,l.path=Jr(s.path),l.query=s.query,l.fragment="",d=eo}break;case EN:if(!l.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){l.username=s.username,l.password=s.password,l.host=s.host,l.port=s.port,d=Ni;continue}d=jp}else d=kp;break;case yN:if(d=kp,r!=="/"||Cr(p,h+1)!=="/")continue;h++;break;case kp:if(r!=="/"&&r!=="\\"){d=jp;continue}break;case jp:if(r==="@"){m&&(p="%40"+p),m=!0,i=Pl(p);for(var w=0;w<i.length;w++){var S=i[w];if(S!==":"||T){var I=Lo(S,mx);T?l.password+=I:l.username+=I}else T=!0}p=""}else if(r===Nr||r==="/"||r==="?"||r==="#"||r==="\\"&&l.isSpecial()){if(m&&p==="")return"Invalid authority";h-=Pl(p).length+1,p="",d=bx}else p+=r;break;case bx:case _x:if(t&&l.scheme==="file"){d=yx;continue}if(r!==":"||g){if(r===Nr||r==="/"||r==="?"||r==="#"||r==="\\"&&l.isSpecial()){if(l.isSpecial()&&p==="")return vc;if(t&&p===""&&(l.includesCredentials()||l.port!==null))return;if(o=l.parseHost(p))return o;if(p="",d=Ml,t)return;continue}r==="["?g=!0:r==="]"&&(g=!1),p+=r}else{if(p==="")return vc;if(o=l.parseHost(p))return o;if(p="",d=vx,t===_x)return}break;case vx:if(!$r(px,r)){if(r===Nr||r==="/"||r==="?"||r==="#"||r==="\\"&&l.isSpecial()||t){if(p!==""){var O=Ip(p,10);if(O>65535)return hN;l.port=l.isSpecial()&&O===Dp[l.scheme]?null:O,p=""}if(t)return;d=Ml;continue}return hN}p+=r;break;case Ex:if(l.scheme="file",r==="/"||r==="\\")d=wN;else{if(!s||s.scheme!=="file"){d=Ni;continue}switch(r){case Nr:l.host=s.host,l.path=Jr(s.path),l.query=s.query;break;case"?":l.host=s.host,l.path=Jr(s.path),l.query="",d=Ec;break;case"#":l.host=s.host,l.path=Jr(s.path),l.query=s.query,l.fragment="",d=eo;break;default:xN(_u(Jr(n,h),""))||(l.host=s.host,l.path=Jr(s.path),l.shortenPath()),d=Ni;continue}}break;case wN:if(r==="/"||r==="\\"){d=yx;break}s&&s.scheme==="file"&&!xN(_u(Jr(n,h),""))&&(yu(s.path[0],!0)?Ll(l.path,s.path[0]):l.host=s.host),d=Ni;continue;case yx:if(r===Nr||r==="/"||r==="\\"||r==="?"||r==="#"){if(!t&&yu(p))d=Ni;else if(p===""){if(l.host="",t)return;d=Ml}else{if(o=l.parseHost(p))return o;if(l.host==="localhost"&&(l.host=""),t)return;p="",d=Ml}continue}p+=r;break;case Ml:if(l.isSpecial()){if(d=Ni,r!=="/"&&r!=="\\")continue}else if(t||r!=="?")if(t||r!=="#"){if(r!==Nr&&(d=Ni,r!=="/"))continue}else l.fragment="",d=eo;else l.query="",d=Ec;break;case Ni:if(r===Nr||r==="/"||r==="\\"&&l.isSpecial()||!t&&(r==="?"||r==="#")){if((c=Ap(c=p))===".."||c==="%2e."||c===".%2e"||c==="%2e%2e"?(l.shortenPath(),r==="/"||r==="\\"&&l.isSpecial()||Ll(l.path,"")):s8(p)?r==="/"||r==="\\"&&l.isSpecial()||Ll(l.path,""):(l.scheme==="file"&&!l.path.length&&yu(p)&&(l.host&&(l.host=""),p=Cr(p,0)+":"),Ll(l.path,p)),p="",l.scheme==="file"&&(r===Nr||r==="?"||r==="#"))for(;l.path.length>1&&l.path[0]==="";)HB(l.path);r==="?"?(l.query="",d=Ec):r==="#"&&(l.fragment="",d=eo)}else p+=Lo(r,gN);break;case SN:r==="?"?(l.query="",d=Ec):r==="#"?(l.fragment="",d=eo):r!==Nr&&(l.path[0]+=Lo(r,Op));break;case Ec:t||r!=="#"?r!==Nr&&(r==="'"&&l.isSpecial()?l.query+="%27":l.query+=r==="#"?"%23":Lo(r,Op)):(l.fragment="",d=eo);break;case eo:r!==Nr&&(l.fragment+=Lo(r,fN))}h++}},parseHost:function(e){var t,s,n;if(Cr(e,0)==="["){if(Cr(e,e.length-1)!=="]"||(t=function(r){var i,o,c,l,d,h,p,m=[0,0,0,0,0,0,0,0],g=0,T=null,w=0,S=function(){return Cr(r,w)};if(S()===":"){if(Cr(r,1)!==":")return;w+=2,T=++g}for(;S();){if(g===8)return;if(S()!==":"){for(i=o=0;o<4&&$r(mN,S());)i=16*i+Ip(S(),16),w++,o++;if(S()==="."){if(o===0||(w-=o,g>6))return;for(c=0;S();){if(l=null,c>0){if(!(S()==="."&&c<4))return;w++}if(!$r(px,S()))return;for(;$r(px,S());){if(d=Ip(S(),10),l===null)l=d;else{if(l===0)return;l=10*l+d}if(l>255)return;w++}m[g]=256*m[g]+l,++c!=2&&c!==4||g++}if(c!==4)return;break}if(S()===":"){if(w++,!S())return}else if(S())return;m[g++]=i}else{if(T!==null)return;w++,T=++g}}if(T!==null)for(h=g-T,g=7;g!==0&&h>0;)p=m[g],m[g--]=m[T+h-1],m[T+--h]=p;else if(g!==8)return;return m}(vu(e,1,-1)),!t))return vc;this.host=t}else if(this.isSpecial()){if(e=PB(e),$r($B,e)||(t=function(r){var i,o,c,l,d,h,p,m=zB(r,".");if(m.length&&m[m.length-1]===""&&m.length--,(i=m.length)>4)return r;for(o=[],c=0;c<i;c++){if((l=m[c])==="")return r;if(d=10,l.length>1&&Cr(l,0)==="0"&&(d=$r(qB,l)?16:8,l=vu(l,d===8?1:2)),l==="")h=0;else{if(!$r(d===10?JB:d===8?XB:mN,l))return r;h=Ip(l,d)}Ll(o,h)}for(c=0;c<i;c++)if(h=o[c],c===i-1){if(h>=uN(256,5-i))return null}else if(h>255)return null;for(p=WB(o),c=0;c<o.length;c++)p+=o[c]*uN(256,3-c);return p}(e),t===null))return vc;this.host=t}else{if($r(QB,e))return vc;for(t="",s=Pl(e),n=0;n<s.length;n++)t+=Lo(s[n],Op);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return cx(Dp,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme==="file"&&t===1&&yu(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,s=e.username,n=e.password,r=e.host,i=e.port,o=e.path,c=e.query,l=e.fragment,d=t+":";return r!==null?(d+="//",e.includesCredentials()&&(d+=s+(n?":"+n:"")+"@"),d+=Eu(r),i!==null&&(d+=":"+i)):t==="file"&&(d+="//"),d+=e.cannotBeABaseURL?o[0]:o.length?"/"+_u(o,"/"):"",c!==null&&(d+="?"+c),l!==null&&(d+="#"+l),d},setHref:function(e){var t=this.parse(e);if(t)throw new dx(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e==="blob")try{return new Ul(e.path[0]).origin}catch{return"null"}return e!=="file"&&this.isSpecial()?e+"://"+Eu(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(Zi(e)+":",fx)},getUsername:function(){return this.username},setUsername:function(e){var t=Pl(Zi(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var s=0;s<t.length;s++)this.username+=Lo(t[s],mx)}},getPassword:function(){return this.password},setPassword:function(e){var t=Pl(Zi(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var s=0;s<t.length;s++)this.password+=Lo(t[s],mx)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?Eu(e):Eu(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,bx)},getHostname:function(){var e=this.host;return e===null?"":Eu(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,_x)},getPort:function(){var e=this.port;return e===null?"":Zi(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=Zi(e))===""?this.port=null:this.parse(e,vx))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+_u(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,Ml))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=Zi(e))===""?this.query=null:(Cr(e,0)==="?"&&(e=vu(e,1)),this.query="",this.parse(e,Ec)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=Zi(e))!==""?(Cr(e,0)==="#"&&(e=vu(e,1)),this.fragment="",this.parse(e,eo)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Ul=function(e){var t=kB(this,Ma),s=MB(arguments.length,1)>1?arguments[1]:void 0,n=UB(t,new wx(e,!1,s));ix||(t.href=n.serialize(),t.origin=n.getOrigin(),t.protocol=n.getProtocol(),t.username=n.getUsername(),t.password=n.getPassword(),t.host=n.getHost(),t.hostname=n.getHostname(),t.port=n.getPort(),t.pathname=n.getPathname(),t.search=n.getSearch(),t.searchParams=n.getSearchParams(),t.hash=n.getHash())},Ma=Ul.prototype,Ir=function(e,t){return{get:function(){return Cp(this)[e]()},set:t&&function(s){return Cp(this)[t](s)},configurable:!0,enumerable:!0}};if(ix&&(Rr(Ma,"href",Ir("serialize","setHref")),Rr(Ma,"origin",Ir("getOrigin")),Rr(Ma,"protocol",Ir("getProtocol","setProtocol")),Rr(Ma,"username",Ir("getUsername","setUsername")),Rr(Ma,"password",Ir("getPassword","setPassword")),Rr(Ma,"host",Ir("getHost","setHost")),Rr(Ma,"hostname",Ir("getHostname","setHostname")),Rr(Ma,"port",Ir("getPort","setPort")),Rr(Ma,"pathname",Ir("getPathname","setPathname")),Rr(Ma,"search",Ir("getSearch","setSearch")),Rr(Ma,"searchParams",Ir("getSearchParams")),Rr(Ma,"hash",Ir("getHash","setHash"))),Rp(Ma,"toJSON",function(){return Cp(this).serialize()},{enumerable:!0}),Rp(Ma,"toString",function(){return Cp(this).serialize()},{enumerable:!0}),bu){var NN=bu.createObjectURL,TN=bu.revokeObjectURL;NN&&Rp(Ul,"createObjectURL",cN(NN,bu)),TN&&Rp(Ul,"revokeObjectURL",cN(TN,bu))}LB(Ul,"URL"),OB({global:!0,forced:!DB,sham:!ix},{URL:Ul});var n8=Xt,RN=y,a8=gc,CN=ja,r8=Ep,Sx=De("URL"),i8=r8&&RN(function(){Sx.canParse()}),o8=RN(function(){return Sx.canParse.length!==1});n8({target:"URL",stat:!0,forced:!i8||o8},{canParse:function(e){var t=a8(arguments.length,1),s=CN(e),n=t<2||arguments[1]===void 0?void 0:CN(arguments[1]);try{return!!new Sx(s,n)}catch{return!1}}});var c8=Xt,l8=gc,IN=ja,d8=Ep,u8=De("URL");c8({target:"URL",stat:!0,forced:!d8},{parse:function(e){var t=l8(arguments.length,1),s=IN(e),n=t<2||arguments[1]===void 0?void 0:IN(arguments[1]);try{return new u8(s,n)}catch{return null}}});var Pp=E(rt.URL);let AN=!0,ON=!0;function Lp(e,t,s){const n=e.match(t);return n&&n.length>=s&&parseInt(n[s],10)}function yc(e,t,s){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(o,c){if(o!==t)return r.apply(this,arguments);const l=d=>{const h=s(d);h&&(c.handleEvent?c.handleEvent(h):c(h))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(c,l),r.apply(this,[o,l])};const i=n.removeEventListener;n.removeEventListener=function(o,c){if(o!==t||!this._eventMap||!this._eventMap[t])return i.apply(this,arguments);if(!this._eventMap[t].has(c))return i.apply(this,arguments);const l=this._eventMap[t].get(c);return this._eventMap[t].delete(c),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,i.apply(this,[o,l])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(o){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),o&&this.addEventListener(t,this["_on"+t]=o)},enumerable:!0,configurable:!0})}function h8(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(AN=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function p8(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(ON=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function DN(){if(typeof window=="object"){if(AN)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Nx(e,t){ON&&console.warn(e+" is deprecated, please use "+t+" instead.")}function kN(e){return Object.prototype.toString.call(e)==="[object Object]"}function jN(e){var t;return kN(e)?or(t=Object.keys(e)).call(t,function(s,n){const r=kN(e[n]),i=r?jN(e[n]):e[n],o=r&&!Object.keys(i).length;return i===void 0||o?s:Object.assign(s,{[n]:i})},{}):e}function Tx(e,t,s){t&&!s.has(t.id)&&(s.set(t.id,t),Object.keys(t).forEach(n=>{n.endsWith("Id")?Tx(e,e.get(t[n]),s):n.endsWith("Ids")&&t[n].forEach(r=>{Tx(e,e.get(r),s)})}))}function PN(e,t,s){const n=s?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;const i=[];return e.forEach(o=>{o.type==="track"&&o.trackIdentifier===t.id&&i.push(o)}),i.forEach(o=>{e.forEach(c=>{c.type===n&&c.trackId===o.id&&Tx(e,c,r)})}),r}const LN=DN;function MN(e,t){const s=e&&e.navigator;if(!s.mediaDevices)return;const n=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const c={};return Object.keys(o).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const d=typeof o[l]=="object"?o[l]:{ideal:o[l]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const h=function(p,m){return p?p+m.charAt(0).toUpperCase()+m.slice(1):m==="deviceId"?"sourceId":m};if(d.ideal!==void 0){c.optional=c.optional||[];let p={};typeof d.ideal=="number"?(p[h("min",l)]=d.ideal,c.optional.push(p),p={},p[h("max",l)]=d.ideal,c.optional.push(p)):(p[h("",l)]=d.ideal,c.optional.push(p))}d.exact!==void 0&&typeof d.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[h("",l)]=d.exact):["min","max"].forEach(p=>{d[p]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[h(p,l)]=d[p])})}),o.advanced&&(c.optional=(c.optional||[]).concat(o.advanced)),c},r=function(o,c){if(t.version>=61)return c(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const l=function(d,h,p){h in d&&!(p in d)&&(d[p]=d[h],delete d[h])};l((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),l(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=n(o.audio)}if(o&&typeof o.video=="object"){let l=o.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const d=t.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&(!s.mediaDevices.getSupportedConstraints||!s.mediaDevices.getSupportedConstraints().facingMode||d)){let h;if(delete o.video.facingMode,l.exact==="environment"||l.ideal==="environment"?h=["back","rear"]:l.exact!=="user"&&l.ideal!=="user"||(h=["front"]),h)return s.mediaDevices.enumerateDevices().then(p=>{p=p.filter(g=>g.kind==="videoinput");let m=p.find(g=>h.some(T=>{var w;return _e(w=g.label.toLowerCase()).call(w,T)}));return!m&&p.length&&_e(h).call(h,"back")&&(m=p[p.length-1]),m&&(o.video.deviceId=l.exact?{exact:m.deviceId}:{ideal:m.deviceId}),o.video=n(o.video),LN("chrome: "+JSON.stringify(o)),c(o)})}o.video=n(o.video)}return LN("chrome: "+JSON.stringify(o)),c(o)},i=function(o){return t.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(s.getUserMedia=(function(o,c,l){r(o,d=>{s.webkitGetUserMedia(d,c,h=>{l&&l(i(h))})})}).bind(s),s.mediaDevices.getUserMedia){const o=s.mediaDevices.getUserMedia.bind(s.mediaDevices);s.mediaDevices.getUserMedia=function(c){return r(c,l=>o(l).then(d=>{if(l.audio&&!d.getAudioTracks().length||l.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(h=>{h.stop()}),new DOMException("","NotFoundError");return d},d=>Te.reject(i(d))))}}}function UN(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function VN(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(s){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=s)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=s=>{s.stream.addEventListener("addtrack",n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.track.id):{track:n.track};const i=new Event("track");i.track=n.track,i.receiver=r,i.transceiver={receiver:r},i.streams=[s.stream],this.dispatchEvent(i)}),s.stream.getTracks().forEach(n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.id):{track:n};const i=new Event("track");i.track=n,i.receiver=r,i.transceiver={receiver:r},i.streams=[s.stream],this.dispatchEvent(i)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else yc(e,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function FN(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(r,i){return{track:i,get dtmf(){return this._dtmf===void 0&&(i.kind==="audio"?this._dtmf=r.createDTMFSender(i):this._dtmf=null),this._dtmf},_pc:r}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(o,c){let l=r.apply(this,arguments);return l||(l=t(this,o),this._senders.push(l)),l};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(o){i.apply(this,arguments);const c=this._senders.indexOf(o);c!==-1&&this._senders.splice(c,1)}}const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],s.apply(this,[r]),r.getTracks().forEach(i=>{this._senders.push(t(this,i))})};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(i=>{const o=this._senders.find(c=>c.track===i);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(n=>n._pc=this),s},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function BN(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[s,n,r]=arguments;if(arguments.length>0&&typeof s=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof s!="function"))return t.apply(this,[]);const i=function(c){const l={};return c.result().forEach(d=>{const h={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(p=>{h[p]=d.stat(p)}),l[h.id]=h}),l},o=function(c){return new Map(Object.keys(c).map(l=>[l,c[l]]))};if(arguments.length>=2){const c=function(l){n(o(i(l)))};return t.apply(this,[c,s])}return new Te((c,l)=>{t.apply(this,[function(d){c(o(i(d)))},l])}).then(n,r)}}function GN(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const s=e.RTCPeerConnection.prototype.getSenders;s&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=s.apply(this,[]);return r.forEach(i=>i._pc=this),r});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then(i=>PN(i,r.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const s=e.RTCPeerConnection.prototype.getReceivers;s&&(e.RTCPeerConnection.prototype.getReceivers=function(){const n=s.apply(this,[]);return n.forEach(r=>r._pc=this),n}),yc(e,"track",n=>(n.receiver._pc=n.srcElement,n)),e.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(r=>PN(r,n.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const s=arguments[0];let n,r,i;return this.getSenders().forEach(o=>{o.track===s&&(n?i=!0:n=o)}),this.getReceivers().forEach(o=>(o.track===s&&(r?i=!0:r=o),o.track===s)),i||n&&r?Te.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():Te.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function WN(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(i=>this._shimmedLocalStreams[i][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(i,o){if(!o)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(c)===-1&&this._shimmedLocalStreams[o.id].push(c):this._shimmedLocalStreams[o.id]=[o,c],c};const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(i){this._shimmedLocalStreams=this._shimmedLocalStreams||{},i.getTracks().forEach(l=>{if(this.getSenders().find(h=>h.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();s.apply(this,arguments);const c=this.getSenders().filter(l=>o.indexOf(l)===-1);this._shimmedLocalStreams[i.id]=[i].concat(c)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(i){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[i.id],n.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(i){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},i&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const c=this._shimmedLocalStreams[o].indexOf(i);c!==-1&&this._shimmedLocalStreams[o].splice(c,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),r.apply(this,arguments)}}function HN(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return WN(e);const s=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const l=s.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(d=>this._reverseStreams[d.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(l){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.getTracks().forEach(d=>{if(this.getSenders().find(p=>p.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[l.id]){const d=new e.MediaStream(l.getTracks());this._streams[l.id]=d,this._reverseStreams[d.id]=l,l=d}n.apply(this,[l])};const r=e.RTCPeerConnection.prototype.removeStream;function i(l,d){let h=d.sdp;return Object.keys(l._reverseStreams||[]).forEach(p=>{const m=l._reverseStreams[p],g=l._streams[m.id];h=h.replace(new RegExp(g.id,"g"),m.id)}),new RTCSessionDescription({type:d.type,sdp:h})}e.RTCPeerConnection.prototype.removeStream=function(l){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[l.id]||l]),delete this._reverseStreams[this._streams[l.id]?this._streams[l.id].id:l.id],delete this._streams[l.id]},e.RTCPeerConnection.prototype.addTrack=function(l,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(g=>g===l))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(g=>g.track===l))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const m=this._streams[d.id];if(m)m.addTrack(l),Te.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const g=new e.MediaStream([l]);this._streams[d.id]=g,this._reverseStreams[g.id]=d,this.addStream(g)}return this.getSenders().find(g=>g.track===l)},["createOffer","createAnswer"].forEach(function(l){const d=e.RTCPeerConnection.prototype[l],h={[l](){const p=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[m=>{const g=i(this,m);p[0].apply(null,[g])},m=>{p[1]&&p[1].apply(null,m)},arguments[2]]):d.apply(this,arguments).then(m=>i(this,m))}};e.RTCPeerConnection.prototype[l]=h[l]});const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(l,d){let h=d.sdp;return Object.keys(l._reverseStreams||[]).forEach(p=>{const m=l._reverseStreams[p],g=l._streams[m.id];h=h.replace(new RegExp(m.id,"g"),g.id)}),new RTCSessionDescription({type:d.type,sdp:h})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:i(this,l)}}),e.RTCPeerConnection.prototype.removeTrack=function(l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!l._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(l._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(h=>{this._streams[h].getTracks().find(p=>l.track===p)&&(d=this._streams[h])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(l.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Rx(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(s){const n=e.RTCPeerConnection.prototype[s],r={[s](){return arguments[0]=new(s==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[s]=r[s]})}function zN(e,t){yc(e,"negotiationneeded",s=>{const n=s.target;if(!(t.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")||n.signalingState==="stable")return s})}var KN=Object.freeze({__proto__:null,fixNegotiationNeeded:zN,shimAddTrackRemoveTrack:HN,shimAddTrackRemoveTrackWithNative:WN,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(s){return t(s).then(n=>{const r=s.video&&s.video.width,i=s.video&&s.video.height,o=s.video&&s.video.frameRate;return s.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:o||3}},r&&(s.video.mandatory.maxWidth=r),i&&(s.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(s)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:FN,shimGetStats:BN,shimGetUserMedia:MN,shimMediaStream:UN,shimOnTrack:VN,shimPeerConnection:Rx,shimSenderReceiverGetStats:GN});function YN(e,t){const s=e&&e.navigator,n=e&&e.MediaStreamTrack;if(s.getUserMedia=function(r,i,o){Nx("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),s.mediaDevices.getUserMedia(r).then(i,o)},!(t.version>55&&"autoGainControl"in s.mediaDevices.getSupportedConstraints())){const r=function(o,c,l){c in o&&!(l in o)&&(o[l]=o[c],delete o[c])},i=s.mediaDevices.getUserMedia.bind(s.mediaDevices);if(s.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),i(o)},n&&n.prototype.getSettings){const o=n.prototype.getSettings;n.prototype.getSettings=function(){const c=o.apply(this,arguments);return r(c,"mozAutoGainControl","autoGainControl"),r(c,"mozNoiseSuppression","noiseSuppression"),c}}if(n&&n.prototype.applyConstraints){const o=n.prototype.applyConstraints;n.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),r(c,"autoGainControl","mozAutoGainControl"),r(c,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[c])}}}}function qN(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Cx(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const i=e.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[r]=o[r]});const s={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[r,i,o]=arguments;return n.apply(this,[r||null]).then(c=>{if(t.version<53&&!i)try{c.forEach(l=>{l.type=s[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((d,h)=>{c.set(h,Object.assign({},d,{type:s[d.type]||d.type}))})}return c}).then(i,o)}}function XN(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(r=>r._pc=this),n});const s=e.RTCPeerConnection.prototype.addTrack;s&&(e.RTCPeerConnection.prototype.addTrack=function(){const n=s.apply(this,arguments);return n._pc=this,n}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Te.resolve(new Map)}}function JN(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const s=t.apply(this,[]);return s.forEach(n=>n._pc=this),s}),yc(e,"track",s=>(s.receiver._pc=s.srcElement,s)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function $N(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){Nx("removeStream","removeTrack"),this.getSenders().forEach(s=>{var n;s.track&&_e(n=t.getTracks()).call(n,s.track)&&this.removeTrack(s)})})}function QN(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function ZN(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let s=arguments[1]&&arguments[1].sendEncodings;s===void 0&&(s=[]),s=[...s];const n=s.length>0;n&&s.forEach(i=>{if("rid"in i&&!/^[a-z0-9]{0,16}$/i.test(i.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in i&&!(parseFloat(i.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in i&&!(parseFloat(i.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const r=t.apply(this,arguments);if(n){const{sender:i}=r,o=i.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=s,i.sendEncodings=s,this.setParametersPromises.push(i.setParameters(o).then(()=>{delete i.sendEncodings}).catch(()=>{delete i.sendEncodings})))}return r})}function eT(e){if(typeof e!="object"||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const s=t.apply(this,arguments);return"encodings"in s||(s.encodings=[].concat(this.sendEncodings||[{}])),s})}function tT(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Te.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function sT(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Te.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var nT=Object.freeze({__proto__:null,shimAddTransceiver:ZN,shimCreateAnswer:sT,shimCreateOffer:tT,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(s){if(!s||!s.video){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Te.reject(n)}return s.video===!0?s.video={mediaSource:t}:s.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(s)})},shimGetParameters:eT,shimGetUserMedia:YN,shimOnTrack:qN,shimPeerConnection:Cx,shimRTCDataChannel:QN,shimReceiverGetStats:JN,shimRemoveStream:$N,shimSenderGetStats:XN});function aT(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(s){var n;this._localStreams||(this._localStreams=[]),_e(n=this._localStreams).call(n,s)||this._localStreams.push(s),s.getAudioTracks().forEach(r=>t.call(this,r,s)),s.getVideoTracks().forEach(r=>t.call(this,r,s))},e.RTCPeerConnection.prototype.addTrack=function(s){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r&&r.forEach(o=>{var c;this._localStreams?_e(c=this._localStreams).call(c,o)||this._localStreams.push(o):this._localStreams=[o]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const s=this._localStreams.indexOf(t);if(s===-1)return;this._localStreams.splice(s,1);const n=t.getTracks();this.getSenders().forEach(r=>{_e(n).call(n,r.track)&&this.removeTrack(r)})})}}function rT(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(s){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=s),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(r=>{var i;if(this._remoteStreams||(this._remoteStreams=[]),_e(i=this._remoteStreams).call(i,r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const s=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(r=>{if(s._remoteStreams||(s._remoteStreams=[]),s._remoteStreams.indexOf(r)>=0)return;s._remoteStreams.push(r);const i=new Event("addstream");i.stream=r,s.dispatchEvent(i)})}),t.apply(s,arguments)}}}function iT(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,s=t.createOffer,n=t.createAnswer,r=t.setLocalDescription,i=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(l,d){const h=arguments.length>=2?arguments[2]:arguments[0],p=s.apply(this,[h]);return d?(p.then(l,d),Te.resolve()):p},t.createAnswer=function(l,d){const h=arguments.length>=2?arguments[2]:arguments[0],p=n.apply(this,[h]);return d?(p.then(l,d),Te.resolve()):p};let c=function(l,d,h){const p=r.apply(this,[l]);return h?(p.then(d,h),Te.resolve()):p};t.setLocalDescription=c,c=function(l,d,h){const p=i.apply(this,[l]);return h?(p.then(d,h),Te.resolve()):p},t.setRemoteDescription=c,c=function(l,d,h){const p=o.apply(this,[l]);return h?(p.then(d,h),Te.resolve()):p},t.addIceCandidate=c}function oT(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const s=t.mediaDevices,n=s.getUserMedia.bind(s);t.mediaDevices.getUserMedia=r=>n(cT(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(s,n,r){t.mediaDevices.getUserMedia(s).then(n,r)}).bind(t))}function cT(e){return e&&e.video!==void 0?Object.assign({},e,{video:jN(e.video)}):e}function lT(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(s,n){if(s&&s.iceServers){const r=[];for(let i=0;i<s.iceServers.length;i++){let o=s.iceServers[i];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(Nx("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(s.iceServers[i])}s.iceServers=r}return new t(s,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function dT(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function uT(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(s){if(s){s.offerToReceiveAudio!==void 0&&(s.offerToReceiveAudio=!!s.offerToReceiveAudio);const n=this.getTransceivers().find(i=>i.receiver.track.kind==="audio");s.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):s.offerToReceiveAudio!==!0||n||this.addTransceiver("audio",{direction:"recvonly"}),s.offerToReceiveVideo!==void 0&&(s.offerToReceiveVideo=!!s.offerToReceiveVideo);const r=this.getTransceivers().find(i=>i.receiver.track.kind==="video");s.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):s.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function hT(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var pT=Object.freeze({__proto__:null,shimAudioContext:hT,shimCallbacksAPI:iT,shimConstraints:cT,shimCreateOfferLegacy:uT,shimGetUserMedia:oT,shimLocalStreamsAPI:aT,shimRTCIceServerUrls:lT,shimRemoteStreamsAPI:rT,shimTrackEventTransceiver:dT}),mT=`	
\v\f\r \u2028\u2029\uFEFF`,m8=Ze,f8=ja,Ix=mT,fT=k("".replace),g8=RegExp("^["+Ix+"]+"),x8=RegExp("(^|[^"+Ix+"])["+Ix+"]+$"),b8=function(e){return function(t){var s=f8(m8(t));return 1&e&&(s=fT(s,g8,"")),2&e&&(s=fT(s,x8,"$1")),s}},_8={trim:b8(3)},v8=$y.PROPER,E8=y,gT=mT,y8=_8.trim;Xt({target:"String",proto:!0,forced:function(e){return E8(function(){return!!gT[e]()||""[e]()!==""||v8&&gT[e].name!==e})}("trim")},{trim:function(){return y8(this)}});var w8=ir("String","trim"),S8=X,N8=w8,Ax=String.prototype,T8=function(e){var t=e.trim;return typeof e=="string"||e===Ax||S8(Ax,e)&&t===Ax.trim?N8:t},la=E(T8),xT={exports:{}};(function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(s){return s.trim().split(`
`).map(n=>n.trim())},t.splitSections=function(s){return s.split(`
m=`).map((n,r)=>(r>0?"m="+n:n).trim()+`\r
`)},t.getDescription=function(s){const n=t.splitSections(s);return n&&n[0]},t.getMediaSections=function(s){const n=t.splitSections(s);return n.shift(),n},t.matchPrefix=function(s,n){return t.splitLines(s).filter(r=>r.indexOf(n)===0)},t.parseCandidate=function(s){let n;n=s.indexOf("a=candidate:")===0?s.substring(12).split(" "):s.substring(10).split(" ");const r={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let i=8;i<n.length;i+=2)switch(n[i]){case"raddr":r.relatedAddress=n[i+1];break;case"rport":r.relatedPort=parseInt(n[i+1],10);break;case"tcptype":r.tcpType=n[i+1];break;case"ufrag":r.ufrag=n[i+1],r.usernameFragment=n[i+1];break;default:r[n[i]]===void 0&&(r[n[i]]=n[i+1])}return r},t.writeCandidate=function(s){const n=[];n.push(s.foundation);const r=s.component;r==="rtp"?n.push(1):r==="rtcp"?n.push(2):n.push(r),n.push(s.protocol.toUpperCase()),n.push(s.priority),n.push(s.address||s.ip),n.push(s.port);const i=s.type;return n.push("typ"),n.push(i),i!=="host"&&s.relatedAddress&&s.relatedPort&&(n.push("raddr"),n.push(s.relatedAddress),n.push("rport"),n.push(s.relatedPort)),s.tcpType&&s.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(s.tcpType)),(s.usernameFragment||s.ufrag)&&(n.push("ufrag"),n.push(s.usernameFragment||s.ufrag)),"candidate:"+n.join(" ")},t.parseIceOptions=function(s){return s.substring(14).split(" ")},t.parseRtpMap=function(s){let n=s.substring(9).split(" ");const r={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),r.name=n[0],r.clockRate=parseInt(n[1],10),r.channels=n.length===3?parseInt(n[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(s){let n=s.payloadType;s.preferredPayloadType!==void 0&&(n=s.preferredPayloadType);const r=s.channels||s.numChannels||1;return"a=rtpmap:"+n+" "+s.name+"/"+s.clockRate+(r!==1?"/"+r:"")+`\r
`},t.parseExtmap=function(s){const n=s.substring(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1],attributes:n.slice(2).join(" ")}},t.writeExtmap=function(s){return"a=extmap:"+(s.id||s.preferredId)+(s.direction&&s.direction!=="sendrecv"?"/"+s.direction:"")+" "+s.uri+(s.attributes?" "+s.attributes:"")+`\r
`},t.parseFmtp=function(s){const n={};let r;const i=s.substring(s.indexOf(" ")+1).split(";");for(let o=0;o<i.length;o++)r=i[o].trim().split("="),n[r[0].trim()]=r[1];return n},t.writeFmtp=function(s){let n="",r=s.payloadType;if(s.preferredPayloadType!==void 0&&(r=s.preferredPayloadType),s.parameters&&Object.keys(s.parameters).length){const i=[];Object.keys(s.parameters).forEach(o=>{s.parameters[o]!==void 0?i.push(o+"="+s.parameters[o]):i.push(o)}),n+="a=fmtp:"+r+" "+i.join(";")+`\r
`}return n},t.parseRtcpFb=function(s){const n=s.substring(s.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},t.writeRtcpFb=function(s){let n="",r=s.payloadType;return s.preferredPayloadType!==void 0&&(r=s.preferredPayloadType),s.rtcpFeedback&&s.rtcpFeedback.length&&s.rtcpFeedback.forEach(i=>{n+="a=rtcp-fb:"+r+" "+i.type+(i.parameter&&i.parameter.length?" "+i.parameter:"")+`\r
`}),n},t.parseSsrcMedia=function(s){const n=s.indexOf(" "),r={ssrc:parseInt(s.substring(7,n),10)},i=s.indexOf(":",n);return i>-1?(r.attribute=s.substring(n+1,i),r.value=s.substring(i+1)):r.attribute=s.substring(n+1),r},t.parseSsrcGroup=function(s){const n=s.substring(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(r=>parseInt(r,10))}},t.getMid=function(s){const n=t.matchPrefix(s,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(s){const n=s.substring(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},t.getDtlsParameters=function(s,n){return{role:"auto",fingerprints:t.matchPrefix(s+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(s,n){let r="a=setup:"+n+`\r
`;return s.fingerprints.forEach(i=>{r+="a=fingerprint:"+i.algorithm+" "+i.value+`\r
`}),r},t.parseCryptoLine=function(s){const n=s.substring(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},t.writeCryptoLine=function(s){return"a=crypto:"+s.tag+" "+s.cryptoSuite+" "+(typeof s.keyParams=="object"?t.writeCryptoKeyParams(s.keyParams):s.keyParams)+(s.sessionParams?" "+s.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(s){if(s.indexOf("inline:")!==0)return null;const n=s.substring(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(s){return s.keyMethod+":"+s.keySalt+(s.lifeTime?"|"+s.lifeTime:"")+(s.mkiValue&&s.mkiLength?"|"+s.mkiValue+":"+s.mkiLength:"")},t.getCryptoParameters=function(s,n){return t.matchPrefix(s+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(s,n){const r=t.matchPrefix(s+n,"a=ice-ufrag:")[0],i=t.matchPrefix(s+n,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substring(12),password:i.substring(10)}:null},t.writeIceParameters=function(s){let n="a=ice-ufrag:"+s.usernameFragment+`\r
a=ice-pwd:`+s.password+`\r
`;return s.iceLite&&(n+=`a=ice-lite\r
`),n},t.parseRtpParameters=function(s){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(s)[0].split(" ");n.profile=r[2];for(let o=3;o<r.length;o++){const c=r[o],l=t.matchPrefix(s,"a=rtpmap:"+c+" ")[0];if(l){const d=t.parseRtpMap(l),h=t.matchPrefix(s,"a=fmtp:"+c+" ");switch(d.parameters=h.length?t.parseFmtp(h[0]):{},d.rtcpFeedback=t.matchPrefix(s,"a=rtcp-fb:"+c+" ").map(t.parseRtcpFb),n.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(d.name.toUpperCase())}}}t.matchPrefix(s,"a=extmap:").forEach(o=>{n.headerExtensions.push(t.parseExtmap(o))});const i=t.matchPrefix(s,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach(o=>{i.forEach(c=>{o.rtcpFeedback.find(l=>l.type===c.type&&l.parameter===c.parameter)||o.rtcpFeedback.push(c)})}),n},t.writeRtpDescription=function(s,n){let r="";r+="m="+s+" ",r+=n.codecs.length>0?"9":"0",r+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=n.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(o=>{r+=t.writeRtpMap(o),r+=t.writeFmtp(o),r+=t.writeRtcpFb(o)});let i=0;return n.codecs.forEach(o=>{o.maxptime>i&&(i=o.maxptime)}),i>0&&(r+="a=maxptime:"+i+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(o=>{r+=t.writeExtmap(o)}),r},t.parseRtpEncodingParameters=function(s){const n=[],r=t.parseRtpParameters(s),i=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,c=t.matchPrefix(s,"a=ssrc:").map(m=>t.parseSsrcMedia(m)).filter(m=>m.attribute==="cname"),l=c.length>0&&c[0].ssrc;let d;const h=t.matchPrefix(s,"a=ssrc-group:FID").map(m=>m.substring(17).split(" ").map(g=>parseInt(g,10)));h.length>0&&h[0].length>1&&h[0][0]===l&&(d=h[0][1]),r.codecs.forEach(m=>{if(m.name.toUpperCase()==="RTX"&&m.parameters.apt){let g={ssrc:l,codecPayloadType:parseInt(m.parameters.apt,10)};l&&d&&(g.rtx={ssrc:d}),n.push(g),i&&(g=JSON.parse(JSON.stringify(g)),g.fec={ssrc:l,mechanism:o?"red+ulpfec":"red"},n.push(g))}}),n.length===0&&l&&n.push({ssrc:l});let p=t.matchPrefix(s,"b=");return p.length&&(p=p[0].indexOf("b=TIAS:")===0?parseInt(p[0].substring(7),10):p[0].indexOf("b=AS:")===0?1e3*parseInt(p[0].substring(5),10)*.95-16e3:void 0,n.forEach(m=>{m.maxBitrate=p})),n},t.parseRtcpParameters=function(s){const n={},r=t.matchPrefix(s,"a=ssrc:").map(c=>t.parseSsrcMedia(c)).filter(c=>c.attribute==="cname")[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);const i=t.matchPrefix(s,"a=rtcp-rsize");n.reducedSize=i.length>0,n.compound=i.length===0;const o=t.matchPrefix(s,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(s){let n="";return s.reducedSize&&(n+=`a=rtcp-rsize\r
`),s.mux&&(n+=`a=rtcp-mux\r
`),s.ssrc!==void 0&&s.cname&&(n+="a=ssrc:"+s.ssrc+" cname:"+s.cname+`\r
`),n},t.parseMsid=function(s){let n;const r=t.matchPrefix(s,"a=msid:");if(r.length===1)return n=r[0].substring(7).split(" "),{stream:n[0],track:n[1]};const i=t.matchPrefix(s,"a=ssrc:").map(o=>t.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");return i.length>0?(n=i[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(s){const n=t.parseMLine(s),r=t.matchPrefix(s,"a=max-message-size:");let i;r.length>0&&(i=parseInt(r[0].substring(19),10)),isNaN(i)&&(i=65536);const o=t.matchPrefix(s,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:i};const c=t.matchPrefix(s,"a=sctpmap:");if(c.length>0){const l=c[0].substring(10).split(" ");return{port:parseInt(l[0],10),protocol:l[1],maxMessageSize:i}}},t.writeSctpDescription=function(s,n){let r=[];return r=s.protocol!=="DTLS/SCTP"?["m="+s.kind+" 9 "+s.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:["m="+s.kind+" 9 "+s.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&r.push("a=max-message-size:"+n.maxMessageSize+`\r
`),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(s,n,r){let i;const o=n!==void 0?n:2;return i=s||t.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+i+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(s,n){const r=t.splitLines(s);for(let i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(s){return t.splitLines(s)[0].split(" ")[0].substring(2)},t.isRejected=function(s){return s.split(" ",2)[1]==="0"},t.parseMLine=function(s){const n=t.splitLines(s)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(s){const n=t.matchPrefix(s,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(s){if(typeof s!="string"||s.length===0)return!1;const n=t.splitLines(s);for(let r=0;r<n.length;r++)if(n[r].length<2||n[r].charAt(1)!=="=")return!1;return!0},e.exports=t})(xT);var bT=xT.exports,Vl=E(bT),R8=x({__proto__:null,default:Vl},[bT]);function Mp(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(s){if(typeof s=="object"&&s.candidate&&s.candidate.indexOf("a=")===0&&((s=JSON.parse(JSON.stringify(s))).candidate=s.candidate.substr(2)),s.candidate&&s.candidate.length){const n=new t(s),r=Vl.parseCandidate(s.candidate),i=Object.assign(n,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(s)},e.RTCIceCandidate.prototype=t.prototype,yc(e,"icecandidate",s=>(s.candidate&&Object.defineProperty(s,"candidate",{value:new e.RTCIceCandidate(s.candidate),writable:"false"}),s))}function Ox(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||yc(e,"icecandidate",t=>{if(t.candidate){const s=Vl.parseCandidate(t.candidate.candidate);s.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[s.priority>>24])}return t})}function Up(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const s=function(c){if(!c||!c.sdp)return!1;const l=Vl.splitSections(c.sdp);return l.shift(),l.some(d=>{const h=Vl.parseMLine(d);return h&&h.kind==="application"&&h.protocol.indexOf("SCTP")!==-1})},n=function(c){const l=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(l===null||l.length<2)return-1;const d=parseInt(l[1],10);return d!=d?-1:d},r=function(c){let l=65536;return t.browser==="firefox"&&(l=t.version<57?c===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),l},i=function(c,l){let d=65536;t.browser==="firefox"&&t.version===57&&(d=65535);const h=Vl.matchPrefix(c.sdp,"a=max-message-size:");return h.length>0?d=parseInt(h[0].substr(19),10):t.browser==="firefox"&&l!==-1&&(d=2147483637),d},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(s(arguments[0])){const c=n(arguments[0]),l=r(c),d=i(arguments[0],c);let h;h=l===0&&d===0?Number.POSITIVE_INFINITY:l===0||d===0?Math.max(l,d):Math.min(l,d);const p={};Object.defineProperty(p,"maxMessageSize",{get:()=>h}),this._sctp=p}return o.apply(this,arguments)}}function Vp(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(n,r){const i=n.send;n.send=function(){const o=arguments[0],c=o.length||o.size||o.byteLength;if(n.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return i.apply(n,arguments)}}const s=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const n=s.apply(this,arguments);return t(n,this),n},yc(e,"datachannel",n=>(t(n.channel,n.target),n))}function Dx(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(s){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),s&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=s)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(s=>{const n=t[s];t[s]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const i=r.target;if(i._lastConnectionState!==i.connectionState){i._lastConnectionState=i.connectionState;const o=new Event("connectionstatechange",r);i.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function kx(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=n.sdp.split(`
`).filter(i=>la(i).call(i)!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&n instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:n.type,sdp:r}):n.sdp=r}return s.apply(this,arguments)}}function Fp(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const s=e.RTCPeerConnection.prototype.addIceCandidate;s&&s.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Te.resolve():s.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Te.resolve())})}function Bp(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const s=e.RTCPeerConnection.prototype.setLocalDescription;s&&s.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let n=arguments[0]||{};if(typeof n!="object"||n.type&&n.sdp)return s.apply(this,arguments);if(n={type:n.type,sdp:n.sdp},!n.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":n.type="offer";break;default:n.type="answer"}return n.sdp||n.type!=="offer"&&n.type!=="answer"?s.apply(this,[n]):(n.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>s.apply(this,[r]))})}var C8=Object.freeze({__proto__:null,removeExtmapAllowMixed:kx,shimAddIceCandidateNullOrEmpty:Fp,shimConnectionState:Dx,shimMaxMessageSize:Up,shimParameterlessSetLocalDescription:Bp,shimRTCIceCandidate:Mp,shimRTCIceCandidateRelayProtocol:Ox,shimSendThrowTypeError:Vp});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const s=DN,n=function(i){const o={browser:null,version:null};if(i===void 0||!i.navigator)return o.browser="Not a browser.",o;const{navigator:c}=i;if(c.mozGetUserMedia)o.browser="firefox",o.version=Lp(c.userAgent,/Firefox\/(\d+)\./,1);else if(c.webkitGetUserMedia||i.isSecureContext===!1&&i.webkitRTCPeerConnection)o.browser="chrome",o.version=Lp(c.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!i.RTCPeerConnection||!c.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=Lp(c.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=i.RTCRtpTransceiver&&"currentDirection"in i.RTCRtpTransceiver.prototype}return o}(e),r={browserDetails:n,commonShim:C8,extractVersion:Lp,disableLog:h8,disableWarnings:p8,sdp:R8};switch(n.browser){case"chrome":if(!KN||!Rx||!t.shimChrome)return s("Chrome shim is not included in this adapter release."),r;if(n.version===null)return s("Chrome shim can not determine version, not shimming."),r;s("adapter.js shimming chrome."),r.browserShim=KN,Fp(e,n),Bp(e),MN(e,n),UN(e),Rx(e,n),VN(e),HN(e,n),FN(e),BN(e),GN(e),zN(e,n),Mp(e),Ox(e),Dx(e),Up(e,n),Vp(e),kx(e,n);break;case"firefox":if(!nT||!Cx||!t.shimFirefox)return s("Firefox shim is not included in this adapter release."),r;s("adapter.js shimming firefox."),r.browserShim=nT,Fp(e,n),Bp(e),YN(e,n),Cx(e,n),qN(e),$N(e),XN(e),JN(e),QN(e),ZN(e),eT(e),tT(e),sT(e),Mp(e),Dx(e),Up(e,n),Vp(e);break;case"safari":if(!pT||!t.shimSafari)return s("Safari shim is not included in this adapter release."),r;s("adapter.js shimming safari."),r.browserShim=pT,Fp(e,n),Bp(e),lT(e),uT(e),iT(e),aT(e),rT(e),dT(e),oT(e),hT(e),Mp(e),Ox(e),Up(e,n),Vp(e),kx(e,n);break;default:s("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var I8=y,_T=D.RegExp,A8=!I8(function(){var e=!0;try{_T(".","d")}catch{e=!1}var t={},s="",n=e?"dgimsy":"gimsy",r=function(c,l){Object.defineProperty(t,c,{get:function(){return s+=l,!0}})},i={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var o in e&&(i.hasIndices="d"),i)r(o,i[o]);return Object.getOwnPropertyDescriptor(_T.prototype,"flags").get.call(t)!==n||s!==n}),O8=ka,D8=oe,k8=Yn,j8=X,vT={correct:A8},P8=function(){var e=O8(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},L8=RegExp.prototype,jx=vT.correct?function(e){return e.flags}:function(e){return vT.correct||!j8(L8,e)||k8(e,"flags")?e.flags:D8(P8,e)},Px=k,M8=Math.floor,Lx=Px("".charAt),U8=Px("".replace),Mx=Px("".slice),V8=/\$([$&'`]|\d{1,2})/g,F8=Xt,B8=oe,Ux=k,ET=Ze,G8=Ae,W8=We,H8=Fg,Fl=ja,z8=To,K8=jx,Y8=function(e,t,s,n,r,i){var o=s+e.length,c=n.length,l=V8;return U8(i,l,function(d,h){var p;switch(Lx(h,0)){case"$":return"$";case"&":return e;case"`":return Mx(t,0,s);case"'":return Mx(t,o);case"<":p=r[Mx(h,1,-1)];break;default:var m=+h;if(m===0)return d;if(m>c){var g=M8(m/10);return g===0?d:g<=c?n[g-1]===void 0?Lx(h,1):n[g-1]+Lx(h,1):d}p=n[m-1]}return p===void 0?"":p})},q8=$s("replace"),X8=TypeError,Vx=Ux("".indexOf),J8=Ux("".replace),yT=Ux("".slice),$8=Math.max;F8({target:"String",proto:!0},{replaceAll:function(e,t){var s,n,r,i,o,c,l,d,h,p,m=ET(this),g=0,T="";if(W8(e)){if((s=H8(e))&&(n=Fl(ET(K8(e))),!~Vx(n,"g")))throw new X8("`.replaceAll` does not allow non-global regexes");if(r=z8(e,q8))return B8(r,e,m,t);if(s)return J8(Fl(m),e,t)}for(i=Fl(m),o=Fl(e),(c=G8(t))||(t=Fl(t)),l=o.length,d=$8(1,l),h=Vx(i,o);h!==-1;)p=c?Fl(t(o,h,i)):Y8(o,i,h,[],void 0,t),T+=yT(i,g,h)+p,g=h+l,h=h+d>i.length?-1:Vx(i,o,h+d);return g<i.length&&(T+=yT(i,g)),T}});var Q8=ir("String","replaceAll"),Z8=X,eG=Q8,Fx=String.prototype,tG=function(e){var t=e.replaceAll;return typeof e=="string"||e===Fx||Z8(Fx,e)&&t===Fx.replaceAll?eG:t},sG=E(tG),Bx=D;Xt({global:!0,forced:Bx.globalThis!==Bx},{globalThis:Bx});var wT=E(D),Gx={exports:{}};(function(e,t){(function(s,n){var r="function",i="undefined",o="object",c="string",l="major",d="model",h="name",p="type",m="vendor",g="version",T="architecture",w="console",S="mobile",I="tablet",O="smarttv",M="wearable",z="embedded",K="Amazon",V="Apple",Y="ASUS",ce="BlackBerry",xe="Browser",ke="Chrome",lt="Firefox",at="Google",Et="Honor",xt="Huawei",Ht="LG",Rs="Microsoft",de="Motorola",Se="Nvidia",Me="OnePlus",me="Opera",v="OPPO",L="Samsung",W="Sharp",Ee="Sony",pt="Xiaomi",us="Zebra",vn="Facebook",br="Chromium OS",nc="Mac OS",Gf=" Browser",Pd=function(en){for(var on={},Es=0;Es<en.length;Es++)on[en[Es].toUpperCase()]=en[Es];return on},Wf=function(en,on){return typeof en===c&&rl(on).indexOf(rl(en))!==-1},rl=function(en){return en.toLowerCase()},Nh=function(en,on){if(typeof en===c)return en=en.replace(/^\s\s*/,""),typeof on===i?en:en.substring(0,500)},il=function(en,on){for(var Es,Oa,xi,Ws,po,Vt,bi=0;bi<on.length&&!po;){var ol=on[bi],Hi=on[bi+1];for(Es=Oa=0;Es<ol.length&&!po&&ol[Es];)if(po=ol[Es++].exec(en))for(xi=0;xi<Hi.length;xi++)Vt=po[++Oa],typeof(Ws=Hi[xi])===o&&Ws.length>0?Ws.length===2?typeof Ws[1]==r?this[Ws[0]]=Ws[1].call(this,Vt):this[Ws[0]]=Ws[1]:Ws.length===3?typeof Ws[1]!==r||Ws[1].exec&&Ws[1].test?this[Ws[0]]=Vt?Vt.replace(Ws[1],Ws[2]):n:this[Ws[0]]=Vt?Ws[1].call(this,Vt,Ws[2]):n:Ws.length===4&&(this[Ws[0]]=Vt?Ws[3].call(this,Vt.replace(Ws[1],Ws[2])):n):this[Ws]=Vt||n;bi+=2}},ac=function(en,on){for(var Es in on)if(typeof on[Es]===o&&on[Es].length>0){for(var Oa=0;Oa<on[Es].length;Oa++)if(Wf(on[Es][Oa],en))return Es==="?"?n:Es}else if(Wf(on[Es],en))return Es==="?"?n:Es;return on.hasOwnProperty("*")?on["*"]:en},hP={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},pP={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,g],[/opios[\/ ]+([\w\.]+)/i],[g,[h,me+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[g,[h,me+" GX"]],[/\bopr\/([\w\.]+)/i],[g,[h,me]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[g,[h,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[g,[h,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,g],[/quark(?:pc)?\/([-\w\.]+)/i],[g,[h,"Quark"]],[/\bddg\/([\w\.]+)/i],[g,[h,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[h,"UC"+xe]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[g,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[g,[h,"Smart Lenovo "+xe]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+xe],g],[/\bfocus\/([\w\.]+)/i],[g,[h,lt+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[h,me+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[h,me+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[h,"MIUI"+Gf]],[/fxios\/([\w\.-]+)/i],[g,[h,lt]],[/\bqihoobrowser\/?([\w\.]*)/i],[g,[h,"360"]],[/\b(qq)\/([\w\.]+)/i],[[h,/(.+)/,"$1Browser"],g],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1"+Gf],g],[/samsungbrowser\/([\w\.]+)/i],[g,[h,L+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[g,[h,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,"Sogou Mobile"],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[h,g],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[h],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[g,h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,vn],g],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[h,ke+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,ke+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[h,"Android "+xe]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[g,ac,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[h,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],g],[/(wolvic|librewolf)\/([\w\.]+)/i],[h,g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[h,lt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[h,[g,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[h,[g,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[T,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[T,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[T,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[T,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[T,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[T,/ower/,"",rl]],[/ sun4\w[;\)]/i],[[T,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[T,rl]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[m,L],[p,I]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[m,L],[p,S]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[m,V],[p,S]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[m,V],[p,I]],[/(macintosh);/i],[d,[m,V]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[m,W],[p,S]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[d,[m,Et],[p,I]],[/honor([-\w ]+)[;\)]/i],[d,[m,Et],[p,S]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[d,[m,xt],[p,I]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[m,xt],[p,S]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[d,/_/g," "],[m,pt],[p,I]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[d,/_/g," "],[m,pt],[p,S]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[m,v],[p,S]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[d,[m,ac,{OnePlus:["304","403","203"],"*":v}],[p,I]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[m,"Vivo"],[p,S]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[m,"Realme"],[p,S]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[m,de],[p,S]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[m,de],[p,I]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[m,Ht],[p,I]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[m,Ht],[p,S]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[d,[m,"Lenovo"],[p,I]],[/(nokia) (t[12][01])/i],[m,d,[p,I]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[d,/_/g," "],[p,S],[m,"Nokia"]],[/(pixel (c|tablet))\b/i],[d,[m,at],[p,I]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[m,at],[p,S]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[m,Ee],[p,S]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[m,Ee],[p,I]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[m,Me],[p,S]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[m,K],[p,I]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[m,K],[p,S]],[/(playbook);[-\w\),; ]+(rim)/i],[d,m,[p,I]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[m,ce],[p,S]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[m,Y],[p,I]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[m,Y],[p,S]],[/(nexus 9)/i],[d,[m,"HTC"],[p,I]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[m,[d,/_/g," "],[p,S]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[m,"TCL"],[p,I]],[/(itel) ((\w+))/i],[[m,rl],d,[p,ac,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[m,"Acer"],[p,I]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[m,"Meizu"],[p,S]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[m,"Ulefone"],[p,S]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[m,"Energizer"],[p,S]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[m,"Cat"],[p,S]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[m,"Smartfren"],[p,S]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[m,"Nothing"],[p,S]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[d,[m,"Archos"],[p,I]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[d,[m,"Archos"],[p,S]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[m,d,[p,I]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[m,d,[p,S]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[m,d,[p,I]],[/(surface duo)/i],[d,[m,Rs],[p,I]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[m,"Fairphone"],[p,S]],[/(u304aa)/i],[d,[m,"AT&T"],[p,S]],[/\bsie-(\w*)/i],[d,[m,"Siemens"],[p,S]],[/\b(rct\w+) b/i],[d,[m,"RCA"],[p,I]],[/\b(venue[\d ]{2,7}) b/i],[d,[m,"Dell"],[p,I]],[/\b(q(?:mv|ta)\w+) b/i],[d,[m,"Verizon"],[p,I]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[m,"Barnes & Noble"],[p,I]],[/\b(tm\d{3}\w+) b/i],[d,[m,"NuVision"],[p,I]],[/\b(k88) b/i],[d,[m,"ZTE"],[p,I]],[/\b(nx\d{3}j) b/i],[d,[m,"ZTE"],[p,S]],[/\b(gen\d{3}) b.+49h/i],[d,[m,"Swiss"],[p,S]],[/\b(zur\d{3}) b/i],[d,[m,"Swiss"],[p,I]],[/\b((zeki)?tb.*\b) b/i],[d,[m,"Zeki"],[p,I]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[m,"Dragon Touch"],d,[p,I]],[/\b(ns-?\w{0,9}) b/i],[d,[m,"Insignia"],[p,I]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[m,"NextBook"],[p,I]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[m,"Voice"],d,[p,S]],[/\b(lvtel\-)?(v1[12]) b/i],[[m,"LvTel"],d,[p,S]],[/\b(ph-1) /i],[d,[m,"Essential"],[p,S]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[m,"Envizen"],[p,I]],[/\b(trio[-\w\. ]+) b/i],[d,[m,"MachSpeed"],[p,I]],[/\btu_(1491) b/i],[d,[m,"Rotor"],[p,I]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[d,[m,Se],[p,I]],[/(sprint) (\w+)/i],[m,d,[p,S]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[m,Rs],[p,S]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[m,us],[p,I]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[m,us],[p,S]],[/smart-tv.+(samsung)/i],[m,[p,O]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[m,L],[p,O]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[m,Ht],[p,O]],[/(apple) ?tv/i],[m,[d,V+" TV"],[p,O]],[/crkey/i],[[d,ke+"cast"],[m,at],[p,O]],[/droid.+aft(\w+)( bui|\))/i],[d,[m,K],[p,O]],[/(shield \w+ tv)/i],[d,[m,Se],[p,O]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[m,W],[p,O]],[/(bravia[\w ]+)( bui|\))/i],[d,[m,Ee],[p,O]],[/(mi(tv|box)-?\w+) bui/i],[d,[m,pt],[p,O]],[/Hbbtv.*(technisat) (.*);/i],[m,d,[p,O]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[m,Nh],[d,Nh],[p,O]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[d,[p,O]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,O]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[m,d,[p,w]],[/droid.+; (shield)( bui|\))/i],[d,[m,Se],[p,w]],[/(playstation \w+)/i],[d,[m,Ee],[p,w]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[m,Rs],[p,w]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[d,[m,L],[p,M]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[m,d,[p,M]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[d,[m,v],[p,M]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[m,V],[p,M]],[/(opwwe\d{3})/i],[d,[m,Me],[p,M]],[/(moto 360)/i],[d,[m,de],[p,M]],[/(smartwatch 3)/i],[d,[m,Ee],[p,M]],[/(g watch r)/i],[d,[m,Ht],[p,M]],[/droid.+; (wt63?0{2,3})\)/i],[d,[m,us],[p,M]],[/droid.+; (glass) \d/i],[d,[m,at],[p,M]],[/(pico) (4|neo3(?: link|pro)?)/i],[m,d,[p,M]],[/; (quest( \d| pro)?)/i],[d,[m,vn],[p,M]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[m,[p,z]],[/(aeobc)\b/i],[d,[m,K],[p,z]],[/(homepod).+mac os/i],[d,[m,V],[p,z]],[/windows iot/i],[[p,z]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[p,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[p,I]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,I]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,S]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[d,[m,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[h,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[h,g],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,g],[/ladybird\//i],[[h,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,g],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[h,[g,ac,hP]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[g,ac,hP],[h,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,nc],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,h],[/(ubuntu) ([\w\.]+) like android/i],[[h,/(.+)/,"$1 Touch"],g],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[h,g],[/\(bb(10);/i],[g,[h,ce]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[g,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[h,lt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[h,ke+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,br],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,g],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,g]]},gi=function(en,on){if(typeof en===o&&(on=en,en=n),!(this instanceof gi))return new gi(en,on).getResult();var Es=typeof s!==i&&s.navigator?s.navigator:n,Oa=en||(Es&&Es.userAgent?Es.userAgent:""),xi=Es&&Es.userAgentData?Es.userAgentData:n,Ws=on?function(Vt,bi){var ol={};for(var Hi in Vt)bi[Hi]&&bi[Hi].length%2==0?ol[Hi]=bi[Hi].concat(Vt[Hi]):ol[Hi]=Vt[Hi];return ol}(pP,on):pP,po=Es&&Es.userAgent==Oa;return this.getBrowser=function(){var Vt={};return Vt[h]=n,Vt[g]=n,il.call(Vt,Oa,Ws.browser),Vt[l]=function(bi){return typeof bi===c?bi.replace(/[^\d\.]/g,"").split(".")[0]:n}(Vt[g]),po&&Es&&Es.brave&&typeof Es.brave.isBrave==r&&(Vt[h]="Brave"),Vt},this.getCPU=function(){var Vt={};return Vt[T]=n,il.call(Vt,Oa,Ws.cpu),Vt},this.getDevice=function(){var Vt={};return Vt[m]=n,Vt[d]=n,Vt[p]=n,il.call(Vt,Oa,Ws.device),po&&!Vt[p]&&xi&&xi.mobile&&(Vt[p]=S),po&&Vt[d]=="Macintosh"&&Es&&typeof Es.standalone!==i&&Es.maxTouchPoints&&Es.maxTouchPoints>2&&(Vt[d]="iPad",Vt[p]=I),Vt},this.getEngine=function(){var Vt={};return Vt[h]=n,Vt[g]=n,il.call(Vt,Oa,Ws.engine),Vt},this.getOS=function(){var Vt={};return Vt[h]=n,Vt[g]=n,il.call(Vt,Oa,Ws.os),po&&!Vt[h]&&xi&&xi.platform&&xi.platform!="Unknown"&&(Vt[h]=xi.platform.replace(/chrome os/i,br).replace(/macos/i,nc)),Vt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Oa},this.setUA=function(Vt){return Oa=typeof Vt===c&&Vt.length>500?Nh(Vt,500):Vt,this},this.setUA(Oa),this};gi.VERSION="0.7.41",gi.BROWSER=Pd([h,g,l]),gi.CPU=Pd([T]),gi.DEVICE=Pd([d,m,p,w,S,O,I,M,z]),gi.ENGINE=gi.OS=Pd([h,g]),e.exports&&(t=e.exports=gi),t.UAParser=gi;var Ld=typeof s!==i&&(s.jQuery||s.Zepto);if(Ld&&!Ld.ua){var Hf=new gi;Ld.ua=Hf.getResult(),Ld.ua.get=function(){return Hf.getUA()},Ld.ua.set=function(en){Hf.setUA(en);var on=Hf.getResult();for(var Es in on)Ld.ua[Es]=on[Es]}}})(typeof window=="object"?window:_)})(Gx,Gx.exports);var nG=E(Gx.exports),ST=mp.clear;Xt({global:!0,bind:!0,forced:D.clearImmediate!==ST},{clearImmediate:ST});var NT=D,aG=Z,rG=Ae,iG=Hg,oG=Gt,cG=Oo,lG=gc,dG=NT.Function,uG=/MSIE .\./.test(oG)||iG==="BUN"&&function(){var e=NT.Bun.version.split(".");return e.length<3||e[0]==="0"&&(e[1]<3||e[1]==="3"&&e[2]==="0")}(),hG=Xt,TT=D,RT=mp.set,pG=function(e,t){var s=1;return uG?function(n,r){var i=lG(arguments.length,1)>s,o=rG(n)?n:dG(n),c=i?cG(arguments,s):[],l=i?function(){aG(o,this,c)}:o;return e(l)}:e},CT=TT.setImmediate?pG(RT):RT;hG({global:!0,bind:!0,forced:TT.setImmediate!==CT},{setImmediate:CT});var IT=E(rt.setImmediate),mG=D,fG=Lw,gG=Bn,xG=gc,bG=le;Xt({global:!0,dontCallGetSet:!0,forced:y(function(){return bG&&Object.getOwnPropertyDescriptor(mG,"queueMicrotask").value.length!==1})},{queueMicrotask:function(e){xG(arguments.length,1),fG(gG(e))}});var AT=E(rt.queueMicrotask);function OT(e,t){return function(){return e.apply(t,arguments)}}const{toString:_G}=Object.prototype,{getPrototypeOf:Wx}=Object,{iterator:Gp,toStringTag:DT}=Symbol,Wp=(Hx=Object.create(null),e=>{const t=_G.call(e);return Hx[t]||(Hx[t]=t.slice(8,-1).toLowerCase())});var Hx;const Qr=e=>(e=e.toLowerCase(),t=>Wp(t)===e),Hp=e=>t=>typeof t===e,{isArray:Bl}=Array,Gl=Hp("undefined");function wu(e){return e!==null&&!Gl(e)&&e.constructor!==null&&!Gl(e.constructor)&&Wa(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const kT=Qr("ArrayBuffer"),vG=Hp("string"),Wa=Hp("function"),jT=Hp("number"),Su=e=>e!==null&&typeof e=="object",zp=e=>{if(Wp(e)!=="object")return!1;const t=Wx(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||DT in e||Gp in e)},EG=Qr("Date"),yG=Qr("File"),wG=Qr("Blob"),SG=Qr("FileList"),NG=Qr("URLSearchParams"),[TG,RG,CG,IG]=["ReadableStream","Request","Response","Headers"].map(Qr);function Nu(e,t){let s,n,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),Bl(e))for(s=0,n=e.length;s<n;s++)t.call(null,e[s],s,e);else{if(wu(e))return;const i=r?Object.getOwnPropertyNames(e):Object.keys(e),o=i.length;let c;for(s=0;s<o;s++)c=i[s],t.call(null,e[c],c,e)}}function PT(e,t){if(wu(e))return null;t=t.toLowerCase();const s=Object.keys(e);let n,r=s.length;for(;r-- >0;)if(n=s[r],t===n.toLowerCase())return n;return null}const wc=wT!==void 0?wT:typeof self<"u"?self:typeof window<"u"?window:zf,LT=e=>!Gl(e)&&e!==wc,AG=(zx=typeof Uint8Array<"u"&&Wx(Uint8Array),e=>zx&&e instanceof zx);var zx;const OG=Qr("HTMLFormElement"),MT=(e=>{let{hasOwnProperty:t}=e;return(s,n)=>t.call(s,n)})(Object.prototype),DG=Qr("RegExp"),UT=(e,t)=>{const s=Object.getOwnPropertyDescriptors(e),n={};Nu(s,(r,i)=>{let o;(o=t(r,i,e))!==!1&&(n[i]=o||r)}),Object.defineProperties(e,n)},kG=Qr("AsyncFunction"),VT=(FT=typeof IT=="function",BT=Wa(wc.postMessage),FT?IT:BT?(Kx="axios@".concat(Math.random()),Kp=[],wc.addEventListener("message",e=>{let{source:t,data:s}=e;t===wc&&s===Kx&&Kp.length&&Kp.shift()()},!1),e=>{Kp.push(e),wc.postMessage(Kx,"*")}):e=>setTimeout(e));var FT,BT,Kx,Kp;const jG=AT!==void 0?AT.bind(wc):typeof process<"u"&&process.nextTick||VT;var Ce={isArray:Bl,isArrayBuffer:kT,isBuffer:wu,isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||Wa(e.append)&&((t=Wp(e))==="formdata"||t==="object"&&Wa(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&kT(e.buffer),t},isString:vG,isNumber:jT,isBoolean:e=>e===!0||e===!1,isObject:Su,isPlainObject:zp,isEmptyObject:e=>{if(!Su(e)||wu(e))return!1;try{return Object.keys(e).length===0&&Object.getPrototypeOf(e)===Object.prototype}catch{return!1}},isReadableStream:TG,isRequest:RG,isResponse:CG,isHeaders:IG,isUndefined:Gl,isDate:EG,isFile:yG,isBlob:wG,isRegExp:DG,isFunction:Wa,isStream:e=>Su(e)&&Wa(e.pipe),isURLSearchParams:NG,isTypedArray:AG,isFileList:SG,forEach:Nu,merge:function e(){const{caseless:t,skipUndefined:s}=LT(this)&&this||{},n={},r=(i,o)=>{const c=t&&PT(n,o)||o;zp(n[c])&&zp(i)?n[c]=e(n[c],i):zp(i)?n[c]=e({},i):Bl(i)?n[c]=i.slice():s&&Gl(i)||(n[c]=i)};for(let i=0,o=arguments.length;i<o;i++)arguments[i]&&Nu(arguments[i],r);return n},extend:function(e,t,s){let{allOwnKeys:n}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Nu(t,(r,i)=>{s&&Wa(r)?e[i]=OT(r,s):e[i]=r},{allOwnKeys:n}),e},trim:e=>la(e)?la(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,s,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),s&&Object.assign(e.prototype,s)},toFlatObject:(e,t,s,n)=>{let r,i,o;const c={};if(t=t||{},e==null)return t;do{for(r=Object.getOwnPropertyNames(e),i=r.length;i-- >0;)o=r[i],n&&!n(o,e,t)||c[o]||(t[o]=e[o],c[o]=!0);e=s!==!1&&Wx(e)}while(e&&(!s||s(e,t))&&e!==Object.prototype);return t},kindOf:Wp,kindOfTest:Qr,endsWith:(e,t,s)=>{e=String(e),(s===void 0||s>e.length)&&(s=e.length),s-=t.length;const n=e.indexOf(t,s);return n!==-1&&n===s},toArray:e=>{if(!e)return null;if(Bl(e))return e;let t=e.length;if(!jT(t))return null;const s=new Array(t);for(;t-- >0;)s[t]=e[t];return s},forEachEntry:(e,t)=>{const s=(e&&e[Gp]).call(e);let n;for(;(n=s.next())&&!n.done;){const r=n.value;t.call(e,r[0],r[1])}},matchAll:(e,t)=>{let s;const n=[];for(;(s=e.exec(t))!==null;)n.push(s);return n},isHTMLForm:OG,hasOwnProperty:MT,hasOwnProp:MT,reduceDescriptors:UT,freezeMethods:e=>{UT(e,(t,s)=>{if(Wa(e)&&["arguments","caller","callee"].indexOf(s)!==-1)return!1;const n=e[s];Wa(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+s+"'")}))})},toObjectSet:(e,t)=>{const s={},n=r=>{r.forEach(i=>{s[i]=!0})};return Bl(e)?n(e):n(String(e).split(t)),s},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,s,n){return s.toUpperCase()+n}),noop:()=>{},toFiniteNumber:(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,findKey:PT,global:wc,isContextDefined:LT,isSpecCompliantForm:function(e){return!!(e&&Wa(e.append)&&e[DT]==="FormData"&&e[Gp])},toJSONObject:e=>{const t=new Array(10),s=(n,r)=>{if(Su(n)){if(t.indexOf(n)>=0)return;if(wu(n))return n;if(!("toJSON"in n)){t[r]=n;const i=Bl(n)?[]:{};return Nu(n,(o,c)=>{const l=s(o,r+1);!Gl(l)&&(i[c]=l)}),t[r]=void 0,i}}return n};return s(e,0)},isAsyncFn:kG,isThenable:e=>e&&(Su(e)||Wa(e))&&Wa(e.then)&&Wa(e.catch),setImmediate:VT,asap:jG,isIterable:e=>e!=null&&Wa(e[Gp])};function as(e,t,s,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),s&&(this.config=s),n&&(this.request=n),r&&(this.response=r,this.status=r.status?r.status:null)}Ce.inherits(as,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Ce.toJSONObject(this.config),code:this.code,status:this.status}}});const GT=as.prototype,WT={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{WT[e]={value:e}}),Object.defineProperties(as,WT),Object.defineProperty(GT,"isAxiosError",{value:!0}),as.from=(e,t,s,n,r,i)=>{const o=Object.create(GT);Ce.toFlatObject(e,o,function(d){return d!==Error.prototype},d=>d!=="isAxiosError");const c=e&&e.message?e.message:"Error",l=t==null&&e?e.code:t;return as.call(o,c,l,s,n,r),e&&o.cause==null&&Object.defineProperty(o,"cause",{value:e,configurable:!0}),o.name=e&&e.name||"Error",i&&Object.assign(o,i),o};function Yx(e){return Ce.isPlainObject(e)||Ce.isArray(e)}function HT(e){return Ce.endsWith(e,"[]")?e.slice(0,-2):e}function zT(e,t,s){return e?e.concat(t).map(function(n,r){return n=HT(n),!s&&r?"["+n+"]":n}).join(s?".":""):t}const PG=Ce.toFlatObject(Ce,{},null,function(e){return/^is[A-Z]/.test(e)});function Yp(e,t,s){if(!Ce.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const n=(s=Ce.toFlatObject(s,{metaTokens:!0,dots:!1,indexes:!1},!1,function(m,g){return!Ce.isUndefined(g[m])})).metaTokens,r=s.visitor||d,i=s.dots,o=s.indexes,c=(s.Blob||typeof Blob<"u"&&Blob)&&Ce.isSpecCompliantForm(t);if(!Ce.isFunction(r))throw new TypeError("visitor must be a function");function l(m){if(m===null)return"";if(Ce.isDate(m))return m.toISOString();if(Ce.isBoolean(m))return m.toString();if(!c&&Ce.isBlob(m))throw new as("Blob is not supported. Use a Buffer instead.");return Ce.isArrayBuffer(m)||Ce.isTypedArray(m)?c&&typeof Blob=="function"?new Blob([m]):Buffer.from(m):m}function d(m,g,T){let w=m;if(m&&!T&&typeof m=="object"){if(Ce.endsWith(g,"{}"))g=n?g:g.slice(0,-2),m=JSON.stringify(m);else if(Ce.isArray(m)&&function(S){return Ce.isArray(S)&&!S.some(Yx)}(m)||(Ce.isFileList(m)||Ce.endsWith(g,"[]"))&&(w=Ce.toArray(m)))return g=HT(g),w.forEach(function(S,I){!Ce.isUndefined(S)&&S!==null&&t.append(o===!0?zT([g],I,i):o===null?g:g+"[]",l(S))}),!1}return!!Yx(m)||(t.append(zT(T,g,i),l(m)),!1)}const h=[],p=Object.assign(PG,{defaultVisitor:d,convertValue:l,isVisitable:Yx});if(!Ce.isObject(e))throw new TypeError("data must be an object");return function m(g,T){if(!Ce.isUndefined(g)){if(h.indexOf(g)!==-1)throw Error("Circular reference detected in "+T.join("."));h.push(g),Ce.forEach(g,function(w,S){(!(Ce.isUndefined(w)||w===null)&&r.call(t,w,Ce.isString(S)?la(S).call(S):S,T,p))===!0&&m(w,T?T.concat(S):[S])}),h.pop()}}(e),t}function KT(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(s){return t[s]})}function qx(e,t){this._pairs=[],e&&Yp(e,this,t)}const YT=qx.prototype;function LG(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function qT(e,t,s){if(!t)return e;const n=s&&s.encode||LG;Ce.isFunction(s)&&(s={serialize:s});const r=s&&s.serialize;let i;if(i=r?r(t,s):Ce.isURLSearchParams(t)?t.toString():new qx(t,s).toString(n),i){const o=e.indexOf("#");o!==-1&&(e=e.slice(0,o)),e+=(e.indexOf("?")===-1?"?":"&")+i}return e}YT.append=function(e,t){this._pairs.push([e,t])},YT.toString=function(e){const t=e?function(s){return e.call(this,s,KT)}:KT;return this._pairs.map(function(s){return t(s[0])+"="+t(s[1])},"").join("&")};var XT=class{constructor(){this.handlers=[]}use(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!s&&s.synchronous,runWhen:s?s.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){Ce.forEach(this.handlers,function(t){t!==null&&e(t)})}},JT={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},$T={exports:{}},MG=Xt,UG=le,QT=wr.f;MG({target:"Object",stat:!0,forced:Object.defineProperty!==QT,sham:!UG},{defineProperty:QT});var ZT=rt.Object,VG=$T.exports=function(e,t,s){return ZT.defineProperty(e,t,s)};ZT.defineProperty.sham&&(VG.sham=!0);var eR=E($T.exports),FG=TypeError,tR=au,BG=pp,GG=We,WG=$s("species"),sR=Array,HG=function(e){var t;return tR(e)&&(t=e.constructor,(BG(t)&&(t===sR||tR(t.prototype))||GG(t)&&(t=t[WG])===null)&&(t=void 0)),t===void 0?sR:t},nR=function(e,t){return new(HG(e))(t===0?0:t)},zG=y,KG=ze,YG=$s("species"),aR=function(e){return KG>=51||!zG(function(){var t=[];return(t.constructor={})[YG]=function(){return{foo:1}},t[e](Boolean).foo!==1})},qG=Xt,XG=y,JG=au,$G=We,QG=yi,ZG=Co,rR=function(e){if(e>9007199254740991)throw FG("Maximum allowed index exceeded");return e},iR=nx,eW=nR,tW=aR,sW=ze,oR=$s("isConcatSpreadable"),nW=sW>=51||!XG(function(){var e=[];return e[oR]=!1,e.concat()[0]!==e}),aW=function(e){if(!$G(e))return!1;var t=e[oR];return t!==void 0?!!t:JG(e)};qG({target:"Array",proto:!0,forced:!nW||!tW("concat")},{concat:function(e){var t,s,n,r,i,o=QG(this),c=eW(o,0),l=0;for(t=-1,n=arguments.length;t<n;t++)if(aW(i=t===-1?o:arguments[t]))for(r=ZG(i),rR(l+r),s=0;s<r;s++,l++)s in i&&iR(c,l,i[s]);else rR(l+1),iR(c,l++,i);return c.length=l,c}});var cR={},rW=Ne,iW=ts,lR=$h.f,oW=Oo,dR=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];cR.f=function(e){return dR&&rW(e)==="Window"?function(t){try{return lR(t)}catch{return oW(dR)}}(e):lR(iW(e))};var Wl={},cW=$s;Wl.f=cW;var uR=rt,lW=Yn,dW=Wl,uW=wr.f,In=function(e){var t=uR.Symbol||(uR.Symbol={});lW(t,e)||uW(t,e,{value:dW.f(e)})},hW=oe,pW=De,mW=$s,fW=Ao,hR=function(){var e=pW("Symbol"),t=e&&e.prototype,s=t&&t.valueOf,n=mW("toPrimitive");t&&!t[n]&&fW(t,n,function(r){return hW(s,this)},{})},gW=Ro,xW=ys,bW=yi,_W=Co,vW=nR,pR=k([].push),EW=function(e){var t=e===1,s=e===2,n=e===3,r=e===4,i=e===6,o=e===7,c=e===5||i;return function(l,d,h,p){for(var m,g,T=bW(l),w=xW(T),S=_W(w),I=gW(d,h),O=0,M=p||vW,z=t?M(l,S):s||o?M(l,0):void 0;S>O;O++)if((c||O in w)&&(g=I(m=w[O],O,T),e))if(t)z[O]=g;else if(g)switch(e){case 3:return!0;case 5:return m;case 6:return O;case 2:pR(z,m)}else switch(e){case 4:return!1;case 7:pR(z,m)}return i?-1:n||r?r:z}},mR={forEach:EW(0)},qp=Xt,Tu=D,Xx=oe,yW=k,Hl=le,zl=Os,wW=y,da=Yn,SW=X,Jx=ka,Xp=ts,$x=Ag,NW=ja,Qx=Ke,Kl=iu,fR=Zh,TW=$h,gR=cR,RW=ru,xR=fe,bR=wr,CW=$g,_R=J,vR=Ao,IW=hp,Zx=xl,ER=Qh,yR=Cg,AW=$s,OW=Wl,DW=In,kW=hR,jW=Qi,wR=fc,Jp=mR.forEach,Ha=Jh("hidden"),$p="Symbol",Ru="prototype",PW=wR.set,SR=wR.getterFor($p),Zr=Object[Ru],Sc=Tu.Symbol,Qp=Sc&&Sc[Ru],LW=Tu.RangeError,MW=Tu.TypeError,eb=Tu.QObject,NR=xR.f,Nc=bR.f,TR=gR.f,UW=_R.f,RR=yW([].push),to=Zx("symbols"),Cu=Zx("op-symbols"),VW=Zx("wks"),tb=!eb||!eb[Ru]||!eb[Ru].findChild,CR=function(e,t,s){var n=NR(Zr,t);n&&delete Zr[t],Nc(e,t,s),n&&e!==Zr&&Nc(Zr,t,n)},sb=Hl&&wW(function(){return Kl(Nc({},"a",{get:function(){return Nc(this,"a",{value:7}).a}})).a!==7})?CR:Nc,nb=function(e,t){var s=to[e]=Kl(Qp);return PW(s,{type:$p,tag:e,description:t}),Hl||(s.description=t),s},Zp=function(e,t,s){e===Zr&&Zp(Cu,t,s),Jx(e);var n=$x(t);return Jx(s),da(to,n)?(s.enumerable?(da(e,Ha)&&e[Ha][n]&&(e[Ha][n]=!1),s=Kl(s,{enumerable:Qx(0,!1)})):(da(e,Ha)||Nc(e,Ha,Qx(1,Kl(null))),e[Ha][n]=!0),sb(e,n,s)):Nc(e,n,s)},ab=function(e,t){Jx(e);var s=Xp(t),n=fR(s).concat(DR(s));return Jp(n,function(r){Hl&&!Xx(IR,s,r)||Zp(e,r,s[r])}),e},IR=function(e){var t=$x(e),s=Xx(UW,this,t);return!(this===Zr&&da(to,t)&&!da(Cu,t))&&(!(s||!da(this,t)||!da(to,t)||da(this,Ha)&&this[Ha][t])||s)},AR=function(e,t){var s=Xp(e),n=$x(t);if(s!==Zr||!da(to,n)||da(Cu,n)){var r=NR(s,n);return!r||!da(to,n)||da(s,Ha)&&s[Ha][n]||(r.enumerable=!0),r}},OR=function(e){var t=TR(Xp(e)),s=[];return Jp(t,function(n){da(to,n)||da(ER,n)||RR(s,n)}),s},DR=function(e){var t=e===Zr,s=TR(t?Cu:Xp(e)),n=[];return Jp(s,function(r){!da(to,r)||t&&!da(Zr,r)||RR(n,to[r])}),n};zl||(Sc=function(){if(SW(Qp,this))throw new MW("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?NW(arguments[0]):void 0,t=yR(e),s=function(n){var r=this===void 0?Tu:this;r===Zr&&Xx(s,Cu,n),da(r,Ha)&&da(r[Ha],t)&&(r[Ha][t]=!1);var i=Qx(1,n);try{sb(r,t,i)}catch(o){if(!(o instanceof LW))throw o;CR(r,t,i)}};return Hl&&tb&&sb(Zr,t,{configurable:!0,set:s}),nb(t,e)},vR(Qp=Sc[Ru],"toString",function(){return SR(this).tag}),vR(Sc,"withoutSetter",function(e){return nb(yR(e),e)}),_R.f=IR,bR.f=Zp,CW.f=ab,xR.f=AR,TW.f=gR.f=OR,RW.f=DR,OW.f=function(e){return nb(AW(e),e)},Hl&&IW(Qp,"description",{configurable:!0,get:function(){return SR(this).description}})),qp({global:!0,wrap:!0,forced:!zl,sham:!zl},{Symbol:Sc}),Jp(fR(VW),function(e){DW(e)}),qp({target:$p,stat:!0,forced:!zl},{useSetter:function(){tb=!0},useSimple:function(){tb=!1}}),qp({target:"Object",stat:!0,forced:!zl,sham:!Hl},{create:function(e,t){return t===void 0?Kl(e):ab(Kl(e),t)},defineProperty:Zp,defineProperties:ab,getOwnPropertyDescriptor:AR}),qp({target:"Object",stat:!0,forced:!zl},{getOwnPropertyNames:OR}),kW(),jW(Sc,$p),ER[Ha]=!0;var kR=Os&&!!Symbol.for&&!!Symbol.keyFor,FW=Xt,BW=De,GW=Yn,WW=ja,jR=xl,HW=kR,rb=jR("string-to-symbol-registry"),zW=jR("symbol-to-string-registry");FW({target:"Symbol",stat:!0,forced:!HW},{for:function(e){var t=WW(e);if(GW(rb,t))return rb[t];var s=BW("Symbol")(t);return rb[t]=s,zW[s]=t,s}});var KW=Xt,YW=Yn,qW=En,XW=ln,JW=kR,PR=xl("symbol-to-string-registry");KW({target:"Symbol",stat:!0,forced:!JW},{keyFor:function(e){if(!qW(e))throw new TypeError(XW(e)+" is not a symbol");if(YW(PR,e))return PR[e]}});var LR=au,$W=Ae,MR=Ne,QW=ja,UR=k([].push),ZW=Xt,VR=De,FR=Z,eH=oe,Iu=k,BR=y,GR=Ae,WR=En,HR=Oo,tH=function(e){if($W(e))return e;if(LR(e)){for(var t=e.length,s=[],n=0;n<t;n++){var r=e[n];typeof r=="string"?UR(s,r):typeof r!="number"&&MR(r)!=="Number"&&MR(r)!=="String"||UR(s,QW(r))}var i=s.length,o=!0;return function(c,l){if(o)return o=!1,l;if(LR(this))return l;for(var d=0;d<i;d++)if(s[d]===c)return l}}},sH=Os,nH=String,Mo=VR("JSON","stringify"),em=Iu(/./.exec),zR=Iu("".charAt),aH=Iu("".charCodeAt),rH=Iu("".replace),iH=Iu(1.1.toString),oH=/[\uD800-\uDFFF]/g,KR=/^[\uD800-\uDBFF]$/,YR=/^[\uDC00-\uDFFF]$/,qR=!sH||BR(function(){var e=VR("Symbol")("stringify detection");return Mo([e])!=="[null]"||Mo({a:e})!=="{}"||Mo(Object(e))!=="{}"}),XR=BR(function(){return Mo("\uDF06\uD834")!=='"\\udf06\\ud834"'||Mo("\uDEAD")!=='"\\udead"'}),cH=function(e,t){var s=HR(arguments),n=tH(t);if(GR(n)||e!==void 0&&!WR(e))return s[1]=function(r,i){if(GR(n)&&(i=eH(n,this,nH(r),i)),!WR(i))return i},FR(Mo,null,s)},lH=function(e,t,s){var n=zR(s,t-1),r=zR(s,t+1);return em(KR,e)&&!em(YR,r)||em(YR,e)&&!em(KR,n)?"\\u"+iH(aH(e,0),16):e};Mo&&ZW({target:"JSON",stat:!0,forced:qR||XR},{stringify:function(e,t,s){var n=HR(arguments),r=FR(qR?cH:Mo,null,n);return XR&&typeof r=="string"?rH(r,oH,lH):r}});var JR=ru,dH=yi;Xt({target:"Object",stat:!0,forced:!Os||y(function(){JR.f(1)})},{getOwnPropertySymbols:function(e){var t=JR.f;return t?t(dH(e)):[]}}),In("asyncDispose"),In("asyncIterator"),In("dispose"),In("hasInstance"),In("isConcatSpreadable"),In("iterator"),In("match"),In("matchAll"),In("replace"),In("search"),In("species"),In("split");var uH=hR;In("toPrimitive"),uH();var hH=De,pH=Qi;In("toStringTag"),pH(hH("Symbol"),"Symbol"),In("unscopables"),Qi(D.JSON,"JSON",!0);var mH=rt.Symbol,fH=$s,gH=wr.f,$R=fH("metadata"),QR=Function.prototype;QR[$R]===void 0&&gH(QR,$R,{value:null}),In("metadata");var xH=mH,bH=k,ib=De("Symbol"),_H=ib.keyFor,vH=bH(ib.prototype.valueOf),ZR=ib.isRegisteredSymbol||function(e){try{return _H(vH(e))!==void 0}catch{return!1}};Xt({target:"Symbol",stat:!0},{isRegisteredSymbol:ZR});for(var EH=xl,eC=De,yH=k,wH=En,SH=$s,tm=eC("Symbol"),tC=tm.isWellKnownSymbol,sC=eC("Object","getOwnPropertyNames"),NH=yH(tm.prototype.valueOf),nC=EH("wks"),ob=0,aC=sC(tm),TH=aC.length;ob<TH;ob++)try{var rC=aC[ob];wH(tm[rC])&&SH(rC)}catch{}var iC=function(e){if(tC&&tC(e))return!0;try{for(var t=NH(e),s=0,n=sC(nC),r=n.length;s<r;s++)if(nC[n[s]]==t)return!0}catch{}return!1};Xt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:iC}),In("customMatcher"),In("observable"),Xt({target:"Symbol",stat:!0},{isRegistered:ZR}),Xt({target:"Symbol",stat:!0,forced:!0},{isWellKnown:iC}),In("matcher"),In("metadataKey"),In("patternMatch"),In("replaceAll");var Yl=E(xH),oC=E(Wl.f("iterator"));function Au(e){return Au=typeof Yl=="function"&&typeof oC=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Yl=="function"&&t.constructor===Yl&&t!==Yl.prototype?"symbol":typeof t},Au(e)}var RH=E(Wl.f("toPrimitive"));function CH(e){var t=function(s,n){if(Au(s)!="object"||!s)return s;var r=s[RH];if(r!==void 0){var i=r.call(s,n);if(Au(i)!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(s)}(e,"string");return Au(t)=="symbol"?t:t+""}function N(e,t,s){return(t=CH(t))in e?eR(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var cC=E(eB),IH={isBrowser:!0,classes:{URLSearchParams:cC!==void 0?cC:qx,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const cb=typeof window<"u"&&typeof document<"u",lb=typeof navigator=="object"&&navigator||void 0,AH=cb&&(!lb||["ReactNative","NativeScript","NS"].indexOf(lb.product)<0),OH=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",DH=cb&&window.location.href||"http://localhost";function lC(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function dC(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?lC(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):lC(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}var Ta=dC(dC({},Object.freeze({__proto__:null,hasBrowserEnv:cb,hasStandardBrowserEnv:AH,hasStandardBrowserWebWorkerEnv:OH,navigator:lb,origin:DH})),IH);function uC(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function kH(e,t){return Yp(e,new Ta.classes.URLSearchParams,function(s){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?uC(Object(r),!0).forEach(function(i){N(s,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(r)):uC(Object(r)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(r,i))})}return s}({visitor:function(s,n,r,i){return Ta.isNode&&Ce.isBuffer(s)?(this.append(n,s.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)}},t))}var jH=W0.charAt,hC=oe,PH=ka,LH=Ae,MH=Ne,UH=/./.exec,VH=TypeError,FH=Xt,pC=oe,mC=pe,BH=d0,sm=dp,fC=Ze,gC=hy,Ou=ja,GH=ka,WH=We,HH=Ne,zH=Fg,xC=jx,KH=To,YH=y,qH=g0,XH=function(e,t,s){return t+(s?jH(e,t).length:1)},JH=function(e,t){var s=e.exec;if(LH(s)){var n=hC(s,e,t);return n!==null&&PH(n),n}if(MH(e)==="RegExp")return hC(UH,e,t);throw new VH("RegExp#exec called on incompatible receiver")},bC=fc,$H=$s("matchAll"),_C="RegExp String",vC=_C+" Iterator",QH=bC.set,ZH=bC.getterFor(vC),ez=TypeError,db=mC("".indexOf),nm=mC("".matchAll),ub=!!nm&&!YH(function(){nm("a",/./)}),tz=BH(function(e,t,s,n){QH(this,{type:vC,regexp:e,string:t,global:s,unicode:n,done:!1})},_C,function(){var e=ZH(this);if(e.done)return sm(void 0,!0);var t=e.regexp,s=e.string,n=JH(t,s);return n===null?(e.done=!0,sm(void 0,!0)):e.global?(Ou(n[0])===""&&(t.lastIndex=XH(s,gC(t.lastIndex),e.unicode)),sm(n,!1)):(e.done=!0,sm(n,!1))}),EC=function(e){var t,s,n,r=GH(this),i=Ou(e),o=qH(r,RegExp),c=Ou(xC(r));return t=new o(o===RegExp?r.source:r,c),s=!!~db(c,"g"),n=!!~db(c,"u"),t.lastIndex=gC(r.lastIndex),new tz(t,i,s,n)};FH({target:"String",proto:!0,forced:ub},{matchAll:function(e){var t,s,n,r,i=fC(this);if(WH(e)){if(zH(e)&&(t=Ou(fC(xC(e))),!~db(t,"g")))throw new ez("`.matchAll` does not allow non-global regexes");if(ub)return nm(i,e);if((n=KH(e,$H))===void 0&&HH(e)==="RegExp"&&(n=EC),n)return pC(n,e,i)}else if(ub)return nm(i,e);return s=Ou(i),r=new RegExp(e,"g"),pC(EC,r,s)}});var sz=ir("String","matchAll"),nz=X,az=sz,hb=String.prototype,rz=function(e){var t=e.matchAll;return typeof e=="string"||e===hb||nz(hb,e)&&t===hb.matchAll?az:t},iz=E(rz);function yC(e){function t(s,n,r,i){let o=s[i++];if(o==="__proto__")return!0;const c=Number.isFinite(+o),l=i>=s.length;return o=!o&&Ce.isArray(r)?r.length:o,l?(Ce.hasOwnProp(r,o)?r[o]=[r[o],n]:r[o]=n,!c):(r[o]&&Ce.isObject(r[o])||(r[o]=[]),t(s,n,r[o],i)&&Ce.isArray(r[o])&&(r[o]=function(d){const h={},p=Object.keys(d);let m;const g=p.length;let T;for(m=0;m<g;m++)T=p[m],h[T]=d[T];return h}(r[o])),!c)}if(Ce.isFormData(e)&&Ce.isFunction(e.entries)){const s={};return Ce.forEachEntry(e,(n,r)=>{t(function(i){return iz(Ce).call(Ce,/\w+|\[(\w*)]/g,i).map(o=>o[0]==="[]"?"":o[1]||o[0])}(n),r,s,0)}),s}return null}const pb={transitional:JT,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const s=t.getContentType()||"",n=s.indexOf("application/json")>-1,r=Ce.isObject(e);if(r&&Ce.isHTMLForm(e)&&(e=new FormData(e)),Ce.isFormData(e))return n?JSON.stringify(yC(e)):e;if(Ce.isArrayBuffer(e)||Ce.isBuffer(e)||Ce.isStream(e)||Ce.isFile(e)||Ce.isBlob(e)||Ce.isReadableStream(e))return e;if(Ce.isArrayBufferView(e))return e.buffer;if(Ce.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let i;if(r){if(s.indexOf("application/x-www-form-urlencoded")>-1)return kH(e,this.formSerializer).toString();if((i=Ce.isFileList(e))||s.indexOf("multipart/form-data")>-1){const o=this.env&&this.env.FormData;return Yp(i?{"files[]":e}:e,o&&new o,this.formSerializer)}}return r||n?(t.setContentType("application/json",!1),function(o,c,l){if(Ce.isString(o))try{return(c||JSON.parse)(o),la(Ce).call(Ce,o)}catch(d){if(d.name!=="SyntaxError")throw d}return(l||JSON.stringify)(o)}(e)):e}],transformResponse:[function(e){const t=this.transitional||pb.transitional,s=t&&t.forcedJSONParsing,n=this.responseType==="json";if(Ce.isResponse(e)||Ce.isReadableStream(e))return e;if(e&&Ce.isString(e)&&(s&&!this.responseType||n)){const r=!(t&&t.silentJSONParsing)&&n;try{return JSON.parse(e,this.parseReviver)}catch(i){if(r)throw i.name==="SyntaxError"?as.from(i,as.ERR_BAD_RESPONSE,this,null,this.response):i}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Ta.classes.FormData,Blob:Ta.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Ce.forEach(["delete","get","head","post","put","patch"],e=>{pb.headers[e]={}});var mb=pb;const oz=Ce.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),wC=Symbol("internals");function Du(e){var t;return e&&la(t=String(e)).call(t).toLowerCase()}function am(e){return e===!1||e==null?e:Ce.isArray(e)?e.map(am):String(e)}function fb(e,t,s,n,r){return Ce.isFunction(n)?n.call(this,t,s):(r&&(t=s),Ce.isString(t)?Ce.isString(n)?t.indexOf(n)!==-1:Ce.isRegExp(n)?n.test(t):void 0:void 0)}class rm{constructor(t){t&&this.set(t)}set(t,s,n){const r=this;function i(l,d,h){const p=Du(d);if(!p)throw new Error("header name must be a non-empty string");const m=Ce.findKey(r,p);(!m||r[m]===void 0||h===!0||h===void 0&&r[m]!==!1)&&(r[m||d]=am(l))}const o=(l,d)=>Ce.forEach(l,(h,p)=>i(h,p,d));if(Ce.isPlainObject(t)||t instanceof this.constructor)o(t,s);else if(Ce.isString(t)&&(t=la(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(la(c=t).call(c)))o((l=>{const d={};let h,p,m;return l&&l.split(`
`).forEach(function(g){var T,w;m=g.indexOf(":"),h=la(T=g.substring(0,m)).call(T).toLowerCase(),p=la(w=g.substring(m+1)).call(w),!h||d[h]&&oz[h]||(h==="set-cookie"?d[h]?d[h].push(p):d[h]=[p]:d[h]=d[h]?d[h]+", "+p:p)}),d})(t),s);else if(Ce.isObject(t)&&Ce.isIterable(t)){let l,d,h={};for(const p of t){if(!Ce.isArray(p))throw TypeError("Object iterator must return a key-value pair");h[d=p[0]]=(l=h[d])?Ce.isArray(l)?[...l,p[1]]:[l,p[1]]:p[1]}o(h,s)}else t!=null&&i(s,t,n);var c;return this}get(t,s){if(t=Du(t)){const n=Ce.findKey(this,t);if(n){const r=this[n];if(!s)return r;if(s===!0)return function(i){const o=Object.create(null),c=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let l;for(;l=c.exec(i);)o[l[1]]=l[2];return o}(r);if(Ce.isFunction(s))return s.call(this,r,n);if(Ce.isRegExp(s))return s.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,s){if(t=Du(t)){const n=Ce.findKey(this,t);return!(!n||this[n]===void 0||s&&!fb(0,this[n],n,s))}return!1}delete(t,s){const n=this;let r=!1;function i(o){if(o=Du(o)){const c=Ce.findKey(n,o);!c||s&&!fb(0,n[c],c,s)||(delete n[c],r=!0)}}return Ce.isArray(t)?t.forEach(i):i(t),r}clear(t){const s=Object.keys(this);let n=s.length,r=!1;for(;n--;){const i=s[n];t&&!fb(0,this[i],i,t,!0)||(delete this[i],r=!0)}return r}normalize(t){const s=this,n={};return Ce.forEach(this,(r,i)=>{var o;const c=Ce.findKey(n,i);if(c)return s[c]=am(r),void delete s[i];const l=t?function(d){return la(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(h,p,m)=>p.toUpperCase()+m)}(i):la(o=String(i)).call(o);l!==i&&delete s[i],s[l]=am(r),n[l]=!0}),this}concat(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];return this.constructor.concat(this,...s)}toJSON(t){const s=Object.create(null);return Ce.forEach(this,(n,r)=>{n!=null&&n!==!1&&(s[r]=t&&Ce.isArray(n)?n.join(", "):n)}),s}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(t=>{let[s,n]=t;return s+": "+n}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){const s=new this(t);for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r.forEach(o=>s.set(o)),s}static accessor(t){const s=(this[wC]=this[wC]={accessors:{}}).accessors,n=this.prototype;function r(i){const o=Du(i);s[o]||(function(c,l){const d=Ce.toCamelCase(" "+l);["get","set","has"].forEach(h=>{Object.defineProperty(c,h+d,{value:function(p,m,g){return this[h].call(this,l,p,m,g)},configurable:!0})})}(n,i),s[o]=!0)}return Ce.isArray(t)?t.forEach(r):r(t),this}}rm.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Ce.reduceDescriptors(rm.prototype,(e,t)=>{let{value:s}=e,n=t[0].toUpperCase()+t.slice(1);return{get:()=>s,set(r){this[n]=r}}}),Ce.freezeMethods(rm);var ei=rm;function gb(e,t){const s=this||mb,n=t||s,r=ei.from(n.headers);let i=n.data;return Ce.forEach(e,function(o){i=o.call(s,i,r.normalize(),t?t.status:void 0)}),r.normalize(),i}function SC(e){return!(!e||!e.__CANCEL__)}function ql(e,t,s){as.call(this,e??"canceled",as.ERR_CANCELED,t,s),this.name="CanceledError"}function NC(e,t,s){const n=s.config.validateStatus;s.status&&n&&!n(s.status)?t(new as("Request failed with status code "+s.status,[as.ERR_BAD_REQUEST,as.ERR_BAD_RESPONSE][Math.floor(s.status/100)-4],s.config,s.request,s)):e(s)}Ce.inherits(ql,as,{__CANCEL__:!0});const im=function(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,n=0;const r=function(i,o){i=i||10;const c=new Array(i),l=new Array(i);let d,h=0,p=0;return o=o!==void 0?o:1e3,function(m){const g=Date.now(),T=l[p];d||(d=g),c[h]=m,l[h]=g;let w=p,S=0;for(;w!==h;)S+=c[w++],w%=i;if(h=(h+1)%i,h===p&&(p=(p+1)%i),g-d<o)return;const I=T&&g-T;return I?Math.round(1e3*S/I):void 0}}(50,250);return function(i,o){let c,l,d=0,h=1e3/o;const p=function(m){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),c=null,l&&(clearTimeout(l),l=null),i(...m)};return[function(){const m=Date.now(),g=m-d;for(var T=arguments.length,w=new Array(T),S=0;S<T;S++)w[S]=arguments[S];g>=h?p(w,m):(c=w,l||(l=setTimeout(()=>{l=null,p(c)},h-g)))},()=>c&&p(c)]}(i=>{const o=i.loaded,c=i.lengthComputable?i.total:void 0,l=o-n,d=r(l);n=o,e({loaded:o,total:c,progress:c?o/c:void 0,bytes:l,rate:d||void 0,estimated:d&&c&&o<=c?(c-o)/d:void 0,event:i,lengthComputable:c!=null,[t?"download":"upload"]:!0})},s)},TC=(e,t)=>{const s=e!=null;return[n=>t[0]({lengthComputable:s,total:e,loaded:n}),t[1]]},RC=e=>function(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];return Ce.asap(()=>e(...s))};var cz=Ta.hasStandardBrowserEnv?((e,t)=>s=>(s=new Pp(s,Ta.origin),e.protocol===s.protocol&&e.host===s.host&&(t||e.port===s.port)))(new Pp(Ta.origin),Ta.navigator&&/(msie|trident)/i.test(Ta.navigator.userAgent)):()=>!0,lz=Ta.hasStandardBrowserEnv?{write(e,t,s,n,r,i,o){if(typeof document>"u")return;const c=["".concat(e,"=").concat(encodeURIComponent(t))];Ce.isNumber(s)&&c.push("expires=".concat(new Date(s).toUTCString())),Ce.isString(n)&&c.push("path=".concat(n)),Ce.isString(r)&&c.push("domain=".concat(r)),i===!0&&c.push("secure"),Ce.isString(o)&&c.push("SameSite=".concat(o)),document.cookie=c.join("; ")},read(e){if(typeof document>"u")return null;const t=document.cookie.match(new RegExp("(?:^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},remove(e){this.write(e,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function CC(e,t,s){let n=!function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}(t);return e&&(n||s==0)?function(r,i){return i?r.replace(/\/?\/$/,"")+"/"+i.replace(/^\/+/,""):r}(e,t):t}function IC(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function xb(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?IC(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):IC(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const AC=e=>e instanceof ei?xb({},e):e;function Tc(e,t){t=t||{};const s={};function n(d,h,p,m){return Ce.isPlainObject(d)&&Ce.isPlainObject(h)?Ce.merge.call({caseless:m},d,h):Ce.isPlainObject(h)?Ce.merge({},h):Ce.isArray(h)?h.slice():h}function r(d,h,p,m){return Ce.isUndefined(h)?Ce.isUndefined(d)?void 0:n(void 0,d,0,m):n(d,h,0,m)}function i(d,h){if(!Ce.isUndefined(h))return n(void 0,h)}function o(d,h){return Ce.isUndefined(h)?Ce.isUndefined(d)?void 0:n(void 0,d):n(void 0,h)}function c(d,h,p){return p in t?n(d,h):p in e?n(void 0,d):void 0}const l={url:i,method:i,data:i,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:c,headers:(d,h,p)=>r(AC(d),AC(h),0,!0)};return Ce.forEach(Object.keys(xb(xb({},e),t)),function(d){const h=l[d]||r,p=h(e[d],t[d],d);Ce.isUndefined(p)&&h!==c||(s[d]=p)}),s}var OC=e=>{const t=Tc({},e);let{data:s,withXSRFToken:n,xsrfHeaderName:r,xsrfCookieName:i,headers:o,auth:c}=t;if(t.headers=o=ei.from(o),t.url=qT(CC(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),c&&o.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),Ce.isFormData(s)){if(Ta.hasStandardBrowserEnv||Ta.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(Ce.isFunction(s.getHeaders)){const l=s.getHeaders(),d=["content-type","content-length"];Object.entries(l).forEach(h=>{let[p,m]=h;_e(d).call(d,p.toLowerCase())&&o.set(p,m)})}}if(Ta.hasStandardBrowserEnv&&(n&&Ce.isFunction(n)&&(n=n(t)),n||n!==!1&&cz(t.url))){const l=r&&i&&lz.read(i);l&&o.set(r,l)}return t},dz=typeof XMLHttpRequest<"u"&&function(e){return new Te(function(t,s){const n=OC(e);let r=n.data;const i=ei.from(n.headers).normalize();let o,c,l,d,h,{responseType:p,onUploadProgress:m,onDownloadProgress:g}=n;function T(){d&&d(),h&&h(),n.cancelToken&&n.cancelToken.unsubscribe(o),n.signal&&n.signal.removeEventListener("abort",o)}let w=new XMLHttpRequest;function S(){if(!w)return;const O=ei.from("getAllResponseHeaders"in w&&w.getAllResponseHeaders());NC(function(M){t(M),T()},function(M){s(M),T()},{data:p&&p!=="text"&&p!=="json"?w.response:w.responseText,status:w.status,statusText:w.statusText,headers:O,config:e,request:w}),w=null}w.open(n.method.toUpperCase(),n.url,!0),w.timeout=n.timeout,"onloadend"in w?w.onloadend=S:w.onreadystatechange=function(){w&&w.readyState===4&&(w.status!==0||w.responseURL&&w.responseURL.indexOf("file:")===0)&&setTimeout(S)},w.onabort=function(){w&&(s(new as("Request aborted",as.ECONNABORTED,e,w)),w=null)},w.onerror=function(O){const M=new as(O&&O.message?O.message:"Network Error",as.ERR_NETWORK,e,w);M.event=O||null,s(M),w=null},w.ontimeout=function(){let O=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const M=n.transitional||JT;n.timeoutErrorMessage&&(O=n.timeoutErrorMessage),s(new as(O,M.clarifyTimeoutError?as.ETIMEDOUT:as.ECONNABORTED,e,w)),w=null},r===void 0&&i.setContentType(null),"setRequestHeader"in w&&Ce.forEach(i.toJSON(),function(O,M){w.setRequestHeader(M,O)}),Ce.isUndefined(n.withCredentials)||(w.withCredentials=!!n.withCredentials),p&&p!=="json"&&(w.responseType=n.responseType),g&&([l,h]=im(g,!0),w.addEventListener("progress",l)),m&&w.upload&&([c,d]=im(m),w.upload.addEventListener("progress",c),w.upload.addEventListener("loadend",d)),(n.cancelToken||n.signal)&&(o=O=>{w&&(s(!O||O.type?new ql(null,e,w):O),w.abort(),w=null)},n.cancelToken&&n.cancelToken.subscribe(o),n.signal&&(n.signal.aborted?o():n.signal.addEventListener("abort",o)));const I=function(O){const M=/^([-+\w]{1,25})(:?\/\/|:)/.exec(O);return M&&M[1]||""}(n.url);I&&Ta.protocols.indexOf(I)===-1?s(new as("Unsupported protocol "+I+":",as.ERR_BAD_REQUEST,e)):w.send(r||null)})},uz=(e,t)=>{const{length:s}=e=e?e.filter(Boolean):[];if(t||s){let n,r=new AbortController;const i=function(d){if(!n){n=!0,c();const h=d instanceof Error?d:this.reason;r.abort(h instanceof as?h:new ql(h instanceof Error?h.message:h))}};let o=t&&setTimeout(()=>{o=null,i(new as("timeout ".concat(t," of ms exceeded"),as.ETIMEDOUT))},t);const c=()=>{e&&(o&&clearTimeout(o),o=null,e.forEach(d=>{d.unsubscribe?d.unsubscribe(i):d.removeEventListener("abort",i)}),e=null)};e.forEach(d=>d.addEventListener("abort",i));const{signal:l}=r;return l.unsubscribe=()=>Ce.asap(c),l}},bb=E(fS),DC=Wl.f("asyncIterator"),hz=E(DC);function _b(e,t){this.v=e,this.k=t}function xa(e){return function(){return new ku(e.apply(this,arguments))}}function ku(e){var t,s;function n(i,o){try{var c=e[i](o),l=c.value,d=l instanceof _b;bb.resolve(d?l.v:l).then(function(h){if(d){var p=i==="return"?"return":"next";if(!l.k||h.done)return n(p,h);h=e[p](h).value}r(c.done?"return":"normal",h)},function(h){n("throw",h)})}catch(h){r("throw",h)}}function r(i,o){switch(i){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?n(t.key,t.arg):s=null}this._invoke=function(i,o){return new bb(function(c,l){var d={key:i,arg:o,resolve:c,reject:l,next:null};s?s=s.next=d:(t=s=d,n(i,o))})},typeof e.return!="function"&&(this.return=void 0)}function yt(e){return new _b(e,0)}function Xl(e){var t={},s=!1;function n(r,i){return s=!0,i=new bb(function(o){o(e[r](i))}),{done:!1,value:new _b(i,1)}}return t[Yl!==void 0&&oC||"@@iterator"]=function(){return this},t.next=function(r){return s?(s=!1,r):n("next",r)},typeof e.throw=="function"&&(t.throw=function(r){if(s)throw s=!1,r;return n("throw",r)}),typeof e.return=="function"&&(t.return=function(r){return s?(s=!1,r):n("return",r)}),t}ku.prototype[typeof Yl=="function"&&hz||"@@asyncIterator"]=function(){return this},ku.prototype.next=function(e){return this._invoke("next",e)},ku.prototype.throw=function(e){return this._invoke("throw",e)},ku.prototype.return=function(e){return this._invoke("return",e)};var om=E(DC);function vb(e){var t,s,n,r=2;for(typeof Symbol<"u"&&(s=om,n=Symbol.iterator);r--;){if(s&&(t=e[s])!=null)return t.call(e);if(n&&(t=e[n])!=null)return new cm(t.call(e));s="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function cm(e){function t(s){if(Object(s)!==s)return Te.reject(new TypeError(s+" is not an object."));var n=s.done;return Te.resolve(s.value).then(function(r){return{value:r,done:n}})}return cm=function(s){this.s=s,this.n=s.next},cm.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(s){var n=this.s.return;return n===void 0?Te.resolve({value:s,done:!0}):t(n.apply(this.s,arguments))},throw:function(s){var n=this.s.return;return n===void 0?Te.reject(s):t(n.apply(this.s,arguments))}},new cm(e)}const pz=function*(e,t){let s=e.byteLength;if(!t||s<t)return void(yield e);let n,r=0;for(;r<s;)n=r+t,yield e.slice(r,n),r=n},mz=function(){var e=xa(function*(t,s){var n,r=!1,i=!1;try{for(var o,c=vb(fz(t));r=!(o=yield yt(c.next())).done;r=!1){const l=o.value;yield*Xl(vb(pz(l,s)))}}catch(l){i=!0,n=l}finally{try{r&&c.return!=null&&(yield yt(c.return()))}finally{if(i)throw n}}});return function(t,s){return e.apply(this,arguments)}}(),fz=function(){var e=xa(function*(t){if(t[om])return void(yield*Xl(vb(t)));const s=t.getReader();try{for(;;){const{done:n,value:r}=yield yt(s.read());if(n)break;yield r}}finally{yield yt(s.cancel())}});return function(t){return e.apply(this,arguments)}}(),kC=(e,t,s,n)=>{const r=mz(e,t);let i,o=0,c=l=>{i||(i=!0,n&&n(l))};return new ReadableStream({async pull(l){try{const{done:d,value:h}=await r.next();if(d)return c(),void l.close();let p=h.byteLength;if(s){let m=o+=p;s(m)}l.enqueue(new Uint8Array(h))}catch(d){throw c(d),d}},cancel:l=>(c(l),r.return())},{highWaterMark:2})};function jC(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function PC(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?jC(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):jC(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const{isFunction:lm}=Ce,gz=(e=>{let{Request:t,Response:s}=e;return{Request:t,Response:s}})(Ce.global),{ReadableStream:LC,TextEncoder:MC}=Ce.global,UC=function(e){try{for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];return!!e(...s)}catch{return!1}},xz=e=>{e=Ce.merge.call({skipUndefined:!0},gz,e);const{fetch:t,Request:s,Response:n}=e,r=t?lm(t):typeof fetch=="function",i=lm(s),o=lm(n);if(!r)return!1;const c=r&&lm(LC),l=r&&(typeof MC=="function"?(d=new MC,T=>d.encode(T)):async T=>new Uint8Array(await new s(T).arrayBuffer()));var d;const h=i&&c&&UC(()=>{let T=!1;const w=new s(Ta.origin,{body:new LC,method:"POST",get duplex(){return T=!0,"half"}}).headers.has("Content-Type");return T&&!w}),p=o&&c&&UC(()=>Ce.isReadableStream(new n("").body)),m={stream:p&&(T=>T.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach(T=>{!m[T]&&(m[T]=(w,S)=>{let I=w&&w[T];if(I)return I.call(w);throw new as("Response type '".concat(T,"' is not supported"),as.ERR_NOT_SUPPORT,S)})});const g=async(T,w)=>{const S=Ce.toFiniteNumber(T.getContentLength());return S??(async I=>I==null?0:Ce.isBlob(I)?I.size:Ce.isSpecCompliantForm(I)?(await new s(Ta.origin,{method:"POST",body:I}).arrayBuffer()).byteLength:Ce.isArrayBufferView(I)||Ce.isArrayBuffer(I)?I.byteLength:(Ce.isURLSearchParams(I)&&(I+=""),Ce.isString(I)?(await l(I)).byteLength:void 0))(w)};return async T=>{let{url:w,method:S,data:I,signal:O,cancelToken:M,timeout:z,onDownloadProgress:K,onUploadProgress:V,responseType:Y,headers:ce,withCredentials:xe="same-origin",fetchOptions:ke}=OC(T),lt=t||fetch;Y=Y?(Y+"").toLowerCase():"text";let at=uz([O,M&&M.toAbortSignal()],z),Et=null;const xt=at&&at.unsubscribe&&(()=>{at.unsubscribe()});let Ht;try{if(V&&h&&S!=="get"&&S!=="head"&&(Ht=await g(ce,I))!==0){let v,L=new s(w,{method:"POST",body:I,duplex:"half"});if(Ce.isFormData(I)&&(v=L.headers.get("content-type"))&&ce.setContentType(v),L.body){const[W,Ee]=TC(Ht,im(RC(V)));I=kC(L.body,65536,W,Ee)}}Ce.isString(xe)||(xe=xe?"include":"omit");const Rs=i&&"credentials"in s.prototype,de=PC(PC({},ke),{},{signal:at,method:S.toUpperCase(),headers:ce.normalize().toJSON(),body:I,duplex:"half",credentials:Rs?xe:void 0});Et=i&&new s(w,de);let Se=await(i?lt(Et,ke):lt(w,de));const Me=p&&(Y==="stream"||Y==="response");if(p&&(K||Me&&xt)){const v={};["status","statusText","headers"].forEach(pt=>{v[pt]=Se[pt]});const L=Ce.toFiniteNumber(Se.headers.get("content-length")),[W,Ee]=K&&TC(L,im(RC(K),!0))||[];Se=new n(kC(Se.body,65536,W,()=>{Ee&&Ee(),xt&&xt()}),v)}Y=Y||"text";let me=await m[Ce.findKey(m,Y)||"text"](Se,T);return!Me&&xt&&xt(),await new Te((v,L)=>{NC(v,L,{data:me,headers:ei.from(Se.headers),status:Se.status,statusText:Se.statusText,config:T,request:Et})})}catch(Rs){throw xt&&xt(),Rs&&Rs.name==="TypeError"&&/Load failed|fetch/i.test(Rs.message)?Object.assign(new as("Network Error",as.ERR_NETWORK,T,Et),{cause:Rs.cause||Rs}):as.from(Rs,Rs&&Rs.code,T,Et)}}},bz=new Map,VC=e=>{let t=e&&e.env||{};const{fetch:s,Request:n,Response:r}=t,i=[n,r,s];let o,c,l=i.length,d=bz;for(;l--;)o=i[l],c=d.get(o),c===void 0&&d.set(o,c=l?new Map:xz(t)),d=c;return c};VC();const Eb={http:null,xhr:dz,fetch:{get:VC}};Ce.forEach(Eb,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});const FC=e=>"- ".concat(e),_z=e=>Ce.isFunction(e)||e===null||e===!1;var BC={getAdapter:function(e,t){e=Ce.isArray(e)?e:[e];const{length:s}=e;let n,r;const i={};for(let o=0;o<s;o++){let c;if(n=e[o],r=n,!_z(n)&&(r=Eb[(c=String(n)).toLowerCase()],r===void 0))throw new as("Unknown adapter '".concat(c,"'"));if(r&&(Ce.isFunction(r)||(r=r.get(t))))break;i[c||"#"+o]=r}if(!r){const o=Object.entries(i).map(c=>{let[l,d]=c;return"adapter ".concat(l," ")+(d===!1?"is not supported by the environment":"is not available in the build")});throw new as("There is no suitable adapter to dispatch the request "+(s?o.length>1?`since :
`+o.map(FC).join(`
`):" "+FC(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:Eb};function yb(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new ql(null,e)}function GC(e){return yb(e),e.headers=ei.from(e.headers),e.data=gb.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),BC.getAdapter(e.adapter||mb.adapter,e)(e).then(function(t){return yb(e),t.data=gb.call(e,e.transformResponse,t),t.headers=ei.from(t.headers),t},function(t){return SC(t)||(yb(e),t&&t.response&&(t.response.data=gb.call(e,e.transformResponse,t.response),t.response.headers=ei.from(t.response.headers))),Te.reject(t)})}const WC="1.13.2",dm={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{dm[e]=function(s){return typeof s===e||"a"+(t<1?"n ":" ")+e}});const HC={};dm.transitional=function(e,t,s){function n(r,i){return"[Axios v"+WC+"] Transitional option '"+r+"'"+i+(s?". "+s:"")}return(r,i,o)=>{if(e===!1)throw new as(n(i," has been removed"+(t?" in "+t:"")),as.ERR_DEPRECATED);return t&&!HC[i]&&(HC[i]=!0,console.warn(n(i," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,i,o)}},dm.spelling=function(e){return(t,s)=>(console.warn("".concat(s," is likely a misspelling of ").concat(e)),!0)};var um={assertOptions:function(e,t,s){if(typeof e!="object")throw new as("options must be an object",as.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let r=n.length;for(;r-- >0;){const i=n[r],o=t[i];if(o){const c=e[i],l=c===void 0||o(c,i,e);if(l!==!0)throw new as("option "+i+" must be "+l,as.ERR_BAD_OPTION_VALUE)}else if(s!==!0)throw new as("Unknown option "+i,as.ERR_BAD_OPTION)}},validators:dm};const Ti=um.validators;let hm=class{constructor(e){this.defaults=e||{},this.interceptors={request:new XT,response:new XT}}async request(e,t){try{return await this._request(e,t)}catch(s){if(s instanceof Error){let n={};Error.captureStackTrace?Error.captureStackTrace(n):n=new Error;const r=n.stack?n.stack.replace(/^.+\n/,""):"";try{s.stack?r&&!String(s.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(s.stack+=`
`+r):s.stack=r}catch{}}throw s}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=Tc(this.defaults,t);const{transitional:s,paramsSerializer:n,headers:r}=t;s!==void 0&&um.assertOptions(s,{silentJSONParsing:Ti.transitional(Ti.boolean),forcedJSONParsing:Ti.transitional(Ti.boolean),clarifyTimeoutError:Ti.transitional(Ti.boolean)},!1),n!=null&&(Ce.isFunction(n)?t.paramsSerializer={serialize:n}:um.assertOptions(n,{encode:Ti.function,serialize:Ti.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),um.assertOptions(t,{baseUrl:Ti.spelling("baseURL"),withXsrfToken:Ti.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let i=r&&Ce.merge(r.common,r[t.method]);r&&Ce.forEach(["delete","get","head","post","put","patch","common"],g=>{delete r[g]}),t.headers=ei.concat(i,r);const o=[];let c=!0;this.interceptors.request.forEach(function(g){typeof g.runWhen=="function"&&g.runWhen(t)===!1||(c=c&&g.synchronous,o.unshift(g.fulfilled,g.rejected))});const l=[];let d;this.interceptors.response.forEach(function(g){l.push(g.fulfilled,g.rejected)});let h,p=0;if(!c){const g=[GC.bind(this),void 0];for(g.unshift(...o),g.push(...l),h=g.length,d=Te.resolve(t);p<h;)d=d.then(g[p++],g[p++]);return d}h=o.length;let m=t;for(;p<h;){const g=o[p++],T=o[p++];try{m=g(m)}catch(w){T.call(this,w);break}}try{d=GC.call(this,m)}catch(g){return Te.reject(g)}for(p=0,h=l.length;p<h;)d=d.then(l[p++],l[p++]);return d}getUri(e){return qT(CC((e=Tc(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};Ce.forEach(["delete","get","head","options"],function(e){hm.prototype[e]=function(t,s){return this.request(Tc(s||{},{method:e,url:t,data:(s||{}).data}))}}),Ce.forEach(["post","put","patch"],function(e){function t(s){return function(n,r,i){return this.request(Tc(i||{},{method:e,headers:s?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}hm.prototype[e]=t(),hm.prototype[e+"Form"]=t(!0)});var pm=hm;class wb{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let s;this.promise=new Te(function(r){s=r});const n=this;this.promise.then(r=>{if(!n._listeners)return;let i=n._listeners.length;for(;i-- >0;)n._listeners[i](r);n._listeners=null}),this.promise.then=r=>{let i;const o=new Te(c=>{n.subscribe(c),i=c}).then(r);return o.cancel=function(){n.unsubscribe(i)},o},t(function(r,i,o){n.reason||(n.reason=new ql(r,i,o),s(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const s=this._listeners.indexOf(t);s!==-1&&this._listeners.splice(s,1)}toAbortSignal(){const t=new AbortController,s=n=>{t.abort(n)};return this.subscribe(s),t.signal.unsubscribe=()=>this.unsubscribe(s),t.signal}static source(){let t;return{token:new wb(function(n){t=n}),cancel:t}}}var vz=wb;const Sb={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(Sb).forEach(e=>{let[t,s]=e;Sb[s]=t});var Ez=Sb;const qn=function e(t){const s=new pm(t),n=OT(pm.prototype.request,s);return Ce.extend(n,pm.prototype,s,{allOwnKeys:!0}),Ce.extend(n,s,null,{allOwnKeys:!0}),n.create=function(r){return e(Tc(t,r))},n}(mb);qn.Axios=pm,qn.CanceledError=ql,qn.CancelToken=vz,qn.isCancel=SC,qn.VERSION=WC,qn.toFormData=Yp,qn.AxiosError=as,qn.Cancel=qn.CanceledError,qn.all=function(e){return Te.all(e)},qn.spread=function(e){return function(t){return e.apply(null,t)}},qn.isAxiosError=function(e){return Ce.isObject(e)&&e.isAxiosError===!0},qn.mergeConfig=Tc,qn.AxiosHeaders=ei,qn.formToJSON=e=>yC(Ce.isHTMLForm(e)?new FormData(e):e),qn.getAdapter=BC.getAdapter,qn.HttpStatusCode=Ez,qn.default=qn;var ba=qn;const yz=()=>{};function ju(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:yz};return e.promise=new Te((t,s)=>{e.resolve=n=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(n),e.value=n)},e.reject=n=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,s(n))}}),e}const mm=new Map,fm=new Map,Ri=new Map;let fn=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),Wt=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const zC=new nG;let ti=zC.getResult(),Nb=null;function Ft(e){if(!Nb){ti=zC.getResult();const t=function(c){if(c.engine.name==="Blink"&&c.browser.name!=="WeChat")return Wt.CHROME;switch(c.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Wt.CHROME;case"Safari":case"Mobile Safari":return Wt.SAFARI;case"Edge":return Wt.EDGE;case"Firefox":return Wt.FIREFOX;case"QQ":case"QQBrowser":return Wt.QQ;case"Opera":return Wt.OPERA;case"WeChat":return Wt.WECHAT;default:return c.browser.name||""}}(ti),s=KC(ti),n=function(c){return c.os.name==="Windows"?c.os.version?c.os.name+" "+c.os.version:c.os.name:c.os.name||""}(ti),r=ti.os.version,i=KC(ti,!1),o=ti.device.type;if(!(t&&s&&n&&r))return{name:t,version:s,os:n,osVersion:r,browserVersion:i,deviceType:o};Nb={name:t,version:s,os:n,osVersion:r,browserVersion:i,deviceType:o}}return Nb}function KC(e){let t,s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",s?t.split(".")[0]:t}function gm(){return Ft().os}function YC(){const e=Ft();return"".concat(e.os," ").concat(e.osVersion)}function xm(){const e=Ft();return!!(ti.engine.name==="WebKit"&&e.os===fn.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==Wt.SAFARI||Xn()&&e.name!==Wt.SAFARI)}function so(){return Ft().name===Wt.CHROME}function yn(){return Ft().name===Wt.SAFARI}function qC(){const e=Ft();if(e.name!==Wt.SAFARI||!e.browserVersion)return!1;const t=e.browserVersion.split(".");return Number(t[0])>15||Number(t[0])===15&&Number(t[1])>=4}function XC(){return Ft().name===Wt.EDGE}function bs(){return Ft().name===Wt.FIREFOX}function Xn(){return Ft().os===fn.IOS}function si(e){const t=Ft();return!(t.name!==Wt.CHROME||!t.osVersion)&&Number(t.version)>=e}function JC(e){const t=Ft();return!(t.name!==Wt.CHROME||!t.osVersion)&&Number(t.version)<e}function Tb(e,t,s){const n=Ft();return!(n.name!==e||!n.osVersion)&&(s?Number(n.version)>=t&&Number(n.version)<=s:Number(n.version)===t)}function Uo(e){const t=Ft();return!(t.name!==Wt.EDGE||!t.osVersion)&&Number(t.version)>=e}function Rb(e){const t=Ft();return!(t.name!==Wt.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function $C(e){const t=Ft();return!(t.name!==Wt.SAFARI||!t.osVersion)&&Number(t.version)>=e}function QC(e,t,s){const n=Ft();if(n.os!==fn.IOS||!n.osVersion)return!1;const r=n.osVersion.split(".");return s?t&&Number(r[0])===e&&Number(r[1])>t||Number(r[0])>e:t?Number(r[0])===e&&Number(r[1])>=t||Number(r[0])>e:Number(r[0])>=e}function ZC(e,t,s){const n=Ft();if(n.os!==fn.IOS||!n.osVersion)return!1;const r=n.osVersion.split(".");return s?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function Cb(e,t,s){const n=Ft();if(n.name!==Wt.SAFARI||!n.osVersion||!n.browserVersion)return!1;const r=n.browserVersion.split(".");return s?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function Rc(e){const t=Ft();return!(t.name!==Wt.OPERA||!t.osVersion)&&Number(t.version)>=e}function eI(){const e=Ft();if(e.os!==fn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function Jl(){const e=Ft();if(e.os!==fn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function Ib(){const e=Ft();if(e.os!==fn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function tI(){const e=Ft();if(e.os!==fn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function Ar(){return yn()&&navigator.maxTouchPoints>0}function sI(){return Ft().name===Wt.WECHAT}function nI(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function aI(){const e=gm();return function(){const{deviceType:t}=Ft();return t==="mobile"||t==="tablet"}()||e===fn.ANDROID||e===fn.IOS||e===fn.HARMONY_OS}function Ci(){const e=Ft();return e.name!==Wt.EDGE&&e.name!==Wt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Pu(){return gm()===fn.ANDROID}function Lu(){const e=Ft();return Pu()&&(e.name===Wt.CHROME||e.name===Wt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function mt(e,t,s){return(t=function(n){var r=function(i,o){if(typeof i!="object"||!i)return i;var c=i[Symbol.toPrimitive];if(c!==void 0){var l=c.call(i,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(i)}(n);return typeof r=="symbol"?r:r+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function rI(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function ye(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?rI(Object(s),!0).forEach(function(n){mt(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):rI(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let A=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({}),se=class extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",s=arguments.length>2?arguments[2]:void 0;super(t),mt(this,"code",void 0),mt(this,"message",void 0),mt(this,"data",void 0),mt(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=s}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return e==="error"&&(t||console).error(this.toString()),e==="warning"&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function Or(e,t){if(typeof e!="boolean")throw new se(A.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Ks(e,t,s){if(!_e(s).call(s,e))throw new se(A.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(s)))}function rs(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<s||e>n||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(e))throw new se(A.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(s,", ").concat(n,"]. integer only"))}function Ab(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new se(A.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&rs(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&rs(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&rs(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&rs(e.ideal,"".concat(t,".ideal"),1,1/0)}else rs(e,t,1,1/0)}function An(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new se(A.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!iI(e,s,n,r))throw new se(A.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(s,",").concat(n,"].").concat(r?" ASCII characters only.":""))}function no(e,t){if(!Array.isArray(e))throw new se(A.INVALID_PARAMS,"".concat(t," should be an array"))}function js(e){return e==null}function iI(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,n=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=s&&e.length>=t&&(!n||function(r){if(typeof r!="string")return!1;for(let i=0;i<r.length;i+=1){const o=r.charCodeAt(i);if(o<0||o>255)return!1}return!0}(e))}function oI(e,t,s){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,s);const n=e.getUint32(t,s),r=e.getUint32(t+4,s),i=0,o=+!s;return BigInt(n*o+r*i)<<BigInt(32)|BigInt(n*i+r*o)}function cI(e,t,s,n){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,s,n);const r=Number(s>>BigInt(32)),i=Number(s&BigInt(4294967295));e.setUint32(t,r,n),e.setUint32(t+4,i,n)}var Mu=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(Mu||{}),Ob=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(Ob||{});const lI=new class{constructor(){mt(this,"_clientSize",null),mt(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),mt(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),mt(this,"getStyle",e=>window.getComputedStyle(e,null)),mt(this,"checkCssVisibleProperty",e=>{var t;let s=!0;const n=this.getStyle(e),{display:r,visibility:i,opacity:o,filter:c}=n;return(r==="none"||_e(t=["hidden","collapse"]).call(t,i)||Number(o)<.1)&&(s=!1),!!s&&(c&&c.split(" ").filter(l=>{var d;const h=l.split("(")[0];return _e(d=["brightness","blur","opacity"]).call(d,h)}).map(l=>{const[d,h]=l.split(/\(|\)/);return[d,Number(h.match(/^[0-9\.]+/))]}).forEach(l=>{const[d,h]=l;switch(d){case"brightness":(h<.1||h>3)&&(s=!1);break;case"blur":h>3&&(s=!1);break;case"opacity":h<.1&&(s=!1)}}),s)}),mt(this,"checkPropertyUpToAllParentNodes",(e,t)=>{let s=!0,n=!0;const r=o=>t(o);let i=e;for(;i&&n;)r(i)||(s=!1,n=!1),i=i.parentElement,i||(n=!1);return s}),mt(this,"checkActualCssVisibleIncludeInherit",e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty)),mt(this,"getSizeAboutClient",e=>{const{width:t,height:s,left:n,right:r,top:i,bottom:o}=e.getBoundingClientRect(),c=this.getClientWidth(),l=this.getClientHeight();return{width:t,height:s,left:n,right:r,top:i,bottom:o,clientWidth:c,clientHeight:l,clientMin:Math.min(c,l)}}),mt(this,"checkActualSize",()=>{const{width:e,height:t,clientMin:s}=this._clientSize;return this.checkSizeIsVisible(e,t,s)}),mt(this,"elementFromPoint",(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null),mt(this,"checkCoverForAPoint",(e,t,s)=>{const n=this.elementFromPoint(e,t);return n!==null&&n!==s}),mt(this,"getPointPositionList",()=>{const{width:e,height:t,left:s,top:n}=this._clientSize,r=e/6,i=t/6,o=[],c=10**6;for(let l=0;l<5;l++)for(let d=0;d<5;d++){const h=(s*c+(l===0?.1:l===4?(r*l*c-1e5)/c:r*l)*c)/c,p=(n*c+(d===0?.1:d===4?(i*d*c-1e5)/c:i*d)*c)/c;o.push({x:h,y:p})}return[...o]}),mt(this,"checkElementCover",e=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,e)).filter(t=>!!t).length>6),mt(this,"checkSizeIsVisible",(e,t,s)=>(e>50||s/e<=10)&&(t>50||s/t<=10)),mt(this,"checkSizeOfPartInClient",()=>{const{left:e,right:t,top:s,bottom:n,clientHeight:r,clientWidth:i,clientMin:o}=this._clientSize;let c,l,d,h;if(e<0)c=0;else{if(!(e<i))return!1;c=e}if(t<0)return!1;if(l=t<i?t:i,s<0)d=0;else{if(!(s<r))return!1;d=s}if(n<0)return!1;h=n<r?n:r;const p=l-c,m=h-d;return this.checkSizeIsVisible(p,m,o)}),mt(this,"returnHiddenResult",e=>(this._clientSize=null,{visible:!1,reason:e})),mt(this,"checkOneElementVisible",e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(Mu.COVERED);{const t=this.checkActualSize(),s=this.checkSizeOfPartInClient();return t&&!s?this.returnHiddenResult(Mu.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Mu.SIZE)}}return this.returnHiddenResult(Mu.STYLE)}return this.returnHiddenResult(Ob.UNMOUNTED)}return this.returnHiddenResult(Ob.INVALID_HTML_ELEMENT)}),mt(this,"checkElementIsMountedOnDom",e=>this.checkPropertyUpToAllParentNodes(e,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function Db(e){return new TextEncoder().encode(e)}const dI=function(e,t){const s=new Uint8Array(e.byteLength+t.byteLength);return s.set(new Uint8Array(e),0),s.set(new Uint8Array(t),e.byteLength),s},kb=async e=>function(t,s){let n="";return new Uint8Array(t).forEach(r=>{n+=r.toString(s).padStart(2,"0")}),n}(await crypto.subtle.digest("SHA-256",Db(e)),16);let Cs=class{constructor(){mt(this,"_events",{}),mt(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(t=>t.listener):[]}on(e,t){this._events[e]||(this._events[e]=[]);const s=this._events[e];this._indexOfListener(s,t)===-1&&s.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const s=this._events[e];this._indexOfListener(s,t)===-1&&s.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const s=this._events[e],n=this._indexOfListener(s,t);n!==-1&&s.splice(n,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map(i=>i);for(var s=arguments.length,n=new Array(s>1?s-1:0),r=1;r<s;r++)n[r-1]=arguments[r];for(let i=0;i<t.length;i+=1){const o=t[i];o.once&&this.off(e,o.listener),o.listener.apply(this,n||[])}}safeEmit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];[...this._events[e]||[]].forEach(r=>{r.once&&this.off(e,r.listener);try{r.listener.apply(this,s)}catch(i){console.error("safeEmit event:".concat(e," error ").concat(i==null?void 0:i.toString()))}})}_indexOfListener(e,t){let s=e.length;for(;s--;)if(e[s].listener===t)return s;return-1}},Uu=null;function uI(){if(Uu)return Uu;if(window.electron)return Uu=window.electron;if(!window.require)return null;try{return Uu=window.require("electron"),Uu}catch{return null}}let Ns=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",e.PRELOAD_MEDIA_FAILED="preloadMediaFailed",e.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",e.VOS_FALLBACK_CN="vosFallbackCN",e.DATACHANNEL_FAILBACK="datachannelFailback",e}({}),is=function(e){return e.TRACER="tracer",e}({});function hI(e){return rs(e.timeout,"config.timeout",0,1e5),rs(e.timeoutFactor,"config.timeoutFactor",0,100,!1),rs(e.maxRetryCount,"config.maxRetryConfig",0,1/0),rs(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let wz=function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e}({}),kt=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.FALLBACK="FALLBACK",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.FALLBACK_TO_HLS="FALLBACK_TO_HLS",e.UID_CONFLICT="UID_CONFLICT",e}({});function Cc(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function pI(e){return An(e.turnServerURL,"turnServerURL"),An(e.username,"username"),An(e.password,"password"),e.udpport&&rs(e.udpport,"udpport",1,99999,!0),e.forceturn&&Or(e.forceturn,"forceturn"),e.security&&Or(e.security,"security"),e.tcpport&&rs(e.tcpport,"tcpport",1,99999,!0),!0}let $l=function(e){return e[e.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",e[e.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",e[e.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",e}({});function jb(e){return e.level!==void 0&&Ks(e.level,"level",[1,2,3]),e.delay!==void 0&&rs(e.delay,"delay",0,3e3,!0),!0}let St=function(e){return e.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",e.AUDIO_METADATA="audio-metadata",e.AUDIO_PTS="audio-pts",e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e.FALLBACK_TO_HLS="fallback-to-hls",e.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",e.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",e.AV1_DECODABLE_RESULT="av1-decodable-result",e}({}),Pb=function(e){return e.CONFIG="config",e.VOSERROR="vos_error",e.AP_ERROR="ap_error",e}({}),Mn=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",e}({}),ua=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),Ic=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function Qs(e,t){for(var s=arguments.length,n=new Array(s>2?s-2:0),r=2;r<s;r++)n[r-2]=arguments[r];return e.getListeners(t).length===0?Te.reject(new se(A.UNEXPECTED_ERROR,"can not emit promise")):new Te((i,o)=>{e.emit(t,...n,i,o)})}function ls(e,t){if(e.getListeners(t).length===0)return Te.resolve();for(var s=arguments.length,n=new Array(s>2?s-2:0),r=2;r<s;r++)n[r-2]=arguments[r];return Qs(e,t,...n)}function Ua(e,t){if(e.getListeners(t).length===0)return null;for(var s=arguments.length,n=new Array(s>2?s-2:0),r=2;r<s;r++)n[r-2]=arguments[r];return Ac(e,t,...n)}function Ac(e,t){let s=null,n=null;for(var r=arguments.length,i=new Array(r>2?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];if(e.emit(t,...i,c=>{s=c},c=>{n=c}),n!==null)throw n;if(s===null)throw new se(A.UNEXPECTED_ERROR,"handler is not sync");return s}const Ps=new class extends Cs{set networkState(e){this.emit(Ic.NETWORK_STATE_CHANGE,e,this._networkState),e===ua.ONLINE?this.emit(Ic.ONLINE):e===ua.OFFLINE&&(this.onlineWaiter=new Te(t=>{this.once(Ic.ONLINE,()=>{this.onlineWaiter=void 0,t(ua.ONLINE)})}),this.emit(Ic.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===ua.ONLINE}constructor(){super(),mt(this,"_moduleName","network-indicator"),mt(this,"_networkState",ua.ONLINE),mt(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=ua.ONLINE}),window.addEventListener("offline",()=>{this.networkState=ua.OFFLINE})}},_a=[];for(let e=0;e<256;++e)_a.push((e+256).toString(16).slice(1));const mI=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let Lb;const Sz=new Uint8Array(16);function Nz(){return mI?mI():function(s,n,r){var i,o,c,l;const d=(i=(o=(s=s||{}).random)!==null&&o!==void 0?o:(c=(l=s).rng)===null||c===void 0?void 0:c.call(l))!==null&&i!==void 0?i:function(){if(!Lb){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Lb=crypto.getRandomValues.bind(crypto)}return Lb(Sz)}();if(d.length<16)throw new Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,n){if((r=r||0)<0||r+16>n.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let h=0;h<16;++h)n[r+h]=d[h];return n}return function(h){let p=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(_a[h[p+0]]+_a[h[p+1]]+_a[h[p+2]]+_a[h[p+3]]+"-"+_a[h[p+4]]+_a[h[p+5]]+"-"+_a[h[p+6]]+_a[h[p+7]]+"-"+_a[h[p+8]]+_a[h[p+9]]+"-"+_a[h[p+10]]+_a[h[p+11]]+_a[h[p+12]]+_a[h[p+13]]+_a[h[p+14]]+_a[h[p+15]]).toLowerCase()}(d)}(e,t,void 0);var e,t}function bm(e,t){const s=e.indexOf(t);s!==-1&&e.splice(s,1)}function Ql(e){const t=[];return e.forEach(s=>{t.indexOf(s)===-1&&t.push(s)}),t}function _m(e){Te!==void 0?Te.resolve().then(e):setTimeout(e,0)}function _s(e){return JSON.parse(JSON.stringify(e))}function Oc(e){try{return _s(e)}catch{return e}}const fI={};function Vo(e,t){fI[t]||(fI[t]=!0,e())}function Dc(e){const t=window.atob(e),s=new Uint8Array(new ArrayBuffer(t.length));for(let n=0;n<t.length;n+=1)s[n]=t.charCodeAt(n);return s}function Fo(e){let t="";for(let s=0;s<e.length;s+=1)t+=String.fromCharCode(e[s]);return window.btoa(t)}function gI(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,s=new TextEncoder().encode(e);if(s.length>t)s=s.slice(0,t);else if(s.length<t){const n=new Uint8Array(t);n.set(s),s=n}return s}function xI(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=or(t).call(t,(o,c)=>o+c.length,0),r=new Uint8Array(new ArrayBuffer(n));let i=0;return t.forEach(o=>{r.set(o,i),i+=o.length}),r}function Ii(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function bI(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach(s=>{t+=typeof s=="string"?Ii(s):s.size}),t+138}function Tz(e){const t=new se(A.TIMEOUT,"timeout");return new Te((s,n)=>{window.setTimeout(()=>n(t),e)})}function gn(e){return new Te(t=>{window.setTimeout(t,e)})}function Jt(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const s=Math.random().toString(16).substr(2,e).toLowerCase();return s.length===e?"".concat(t).concat(s):"".concat(t).concat(s)+Jt(e-s.length,"")}function kc(){let e,t=!1;try{var s;e=sG(s=Nz()).call(s,"-","")}catch{t=!0}return!t&&e&&e.length===32||(e=Jt(32,"")),e.toUpperCase()}const Vu=()=>{},_I=new class{constructor(){mt(this,"fnMap",new Map)}throttleByKey(e,t,s,n){for(var r=arguments.length,i=new Array(r>4?r-4:0),o=4;o<r;o++)i[o-4]=arguments[o];if(this.fnMap.has(t)){const c=this.fnMap.get(t);if(c.threshold!==s){c.fn(...c.args),clearTimeout(c.timer);const l=window.setTimeout(()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},s);this.fnMap.set(t,{fn:e,threshold:s,timer:l,args:i,skipFn:n})}else c.skipFn&&c.skipFn(...c.args),this.fnMap.set(t,ye(ye({},c),{},{fn:e,args:i,skipFn:n}))}else{const c=window.setTimeout(()=>{const l=this.fnMap.get(t);l&&l.fn(...l.args),this.fnMap.delete(t)},s);this.fnMap.set(t,{fn:e,threshold:s,timer:c,args:i,skipFn:n})}}},vI=_I.throttleByKey.bind(_I);function EI(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function Mb(e,t){if(!EI(e)||!EI(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const s=[...e];for(let n=0;n<t.length;n++)s[n]=Mb(e[n],t[n]);return s}{const s=ye({},e);for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)?s[n]=Mb(e[n],t[n]):s[n]=t[n]);return s}}function yI(e,t){let s=[0];if(s=new Array(t).fill(0),e===0)return s;let n=0;for(;e>0&&(s[n]=255&e,e>>=8,n++,n!==t););return s}function Zl(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function Ub(e,t){try{return typeof e=="object"&&typeof t=="object"&&JSON.stringify(e)===JSON.stringify(t)}catch{return!1}}function Vb(e){return or(e).call(e,(t,s)=>t+s,0)}function wI(e){const t="0123456789abcdef";function s(M){let z,K="";for(z=0;z<=3;z++)K+=t.charAt(M>>8*z+4&15)+t.charAt(M>>8*z&15);return K}function n(M,z){const K=(65535&M)+(65535&z);return(M>>16)+(z>>16)+(K>>16)<<16|65535&K}function r(M,z,K,V,Y,ce){return n(function(xe,ke){return xe<<ke|xe>>>32-ke}(n(n(z,M),n(V,ce)),Y),K)}function i(M,z,K,V,Y,ce,xe){return r(z&K|~z&V,M,z,Y,ce,xe)}function o(M,z,K,V,Y,ce,xe){return r(z&V|K&~V,M,z,Y,ce,xe)}function c(M,z,K,V,Y,ce,xe){return r(z^K^V,M,z,Y,ce,xe)}function l(M,z,K,V,Y,ce,xe){return r(K^(z|~V),M,z,Y,ce,xe)}const d=function(M){let z;const K=1+(M.length+8>>6),V=new Array(16*K);for(z=0;z<16*K;z++)V[z]=0;for(z=0;z<M.length;z++)V[z>>2]|=M.charCodeAt(z)<<z%4*8;return V[z>>2]|=128<<z%4*8,V[16*K-2]=8*M.length,V}(e);let h,p,m,g,T,w=1732584193,S=-271733879,I=-1732584194,O=271733878;for(h=0;h<d.length;h+=16)p=w,m=S,g=I,T=O,w=i(w,S,I,O,d[h+0],7,-680876936),O=i(O,w,S,I,d[h+1],12,-389564586),I=i(I,O,w,S,d[h+2],17,606105819),S=i(S,I,O,w,d[h+3],22,-1044525330),w=i(w,S,I,O,d[h+4],7,-176418897),O=i(O,w,S,I,d[h+5],12,1200080426),I=i(I,O,w,S,d[h+6],17,-1473231341),S=i(S,I,O,w,d[h+7],22,-45705983),w=i(w,S,I,O,d[h+8],7,1770035416),O=i(O,w,S,I,d[h+9],12,-1958414417),I=i(I,O,w,S,d[h+10],17,-42063),S=i(S,I,O,w,d[h+11],22,-1990404162),w=i(w,S,I,O,d[h+12],7,1804603682),O=i(O,w,S,I,d[h+13],12,-40341101),I=i(I,O,w,S,d[h+14],17,-1502002290),S=i(S,I,O,w,d[h+15],22,1236535329),w=o(w,S,I,O,d[h+1],5,-165796510),O=o(O,w,S,I,d[h+6],9,-1069501632),I=o(I,O,w,S,d[h+11],14,643717713),S=o(S,I,O,w,d[h+0],20,-373897302),w=o(w,S,I,O,d[h+5],5,-701558691),O=o(O,w,S,I,d[h+10],9,38016083),I=o(I,O,w,S,d[h+15],14,-660478335),S=o(S,I,O,w,d[h+4],20,-405537848),w=o(w,S,I,O,d[h+9],5,568446438),O=o(O,w,S,I,d[h+14],9,-1019803690),I=o(I,O,w,S,d[h+3],14,-187363961),S=o(S,I,O,w,d[h+8],20,1163531501),w=o(w,S,I,O,d[h+13],5,-1444681467),O=o(O,w,S,I,d[h+2],9,-51403784),I=o(I,O,w,S,d[h+7],14,1735328473),S=o(S,I,O,w,d[h+12],20,-1926607734),w=c(w,S,I,O,d[h+5],4,-378558),O=c(O,w,S,I,d[h+8],11,-2022574463),I=c(I,O,w,S,d[h+11],16,1839030562),S=c(S,I,O,w,d[h+14],23,-35309556),w=c(w,S,I,O,d[h+1],4,-1530992060),O=c(O,w,S,I,d[h+4],11,1272893353),I=c(I,O,w,S,d[h+7],16,-155497632),S=c(S,I,O,w,d[h+10],23,-1094730640),w=c(w,S,I,O,d[h+13],4,681279174),O=c(O,w,S,I,d[h+0],11,-358537222),I=c(I,O,w,S,d[h+3],16,-722521979),S=c(S,I,O,w,d[h+6],23,76029189),w=c(w,S,I,O,d[h+9],4,-640364487),O=c(O,w,S,I,d[h+12],11,-421815835),I=c(I,O,w,S,d[h+15],16,530742520),S=c(S,I,O,w,d[h+2],23,-995338651),w=l(w,S,I,O,d[h+0],6,-198630844),O=l(O,w,S,I,d[h+7],10,1126891415),I=l(I,O,w,S,d[h+14],15,-1416354905),S=l(S,I,O,w,d[h+5],21,-57434055),w=l(w,S,I,O,d[h+12],6,1700485571),O=l(O,w,S,I,d[h+3],10,-1894986606),I=l(I,O,w,S,d[h+10],15,-1051523),S=l(S,I,O,w,d[h+1],21,-2054922799),w=l(w,S,I,O,d[h+8],6,1873313359),O=l(O,w,S,I,d[h+15],10,-30611744),I=l(I,O,w,S,d[h+6],15,-1560198380),S=l(S,I,O,w,d[h+13],21,1309151649),w=l(w,S,I,O,d[h+4],6,-145523070),O=l(O,w,S,I,d[h+11],10,-1120210379),I=l(I,O,w,S,d[h+2],15,718787259),S=l(S,I,O,w,d[h+9],21,-343485551),w=n(w,p),S=n(S,m),I=n(I,g),O=n(O,T);return s(w)+s(S)+s(I)+s(O)}let Rz=1,SI=console,wn=class{static setLogger(e){SI=e}constructor(e,t){mt(this,"id",void 0),mt(this,"lockingPromise",Te.resolve()),mt(this,"locks",0),mt(this,"name",""),mt(this,"lockId",void 0),this.lockId=Rz++,e&&(this.name=e),t&&(this.id=t),this.logger("created")}logger(e,t){const s=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),n=e==="created"?"is ".concat(e,"."):"is ".concat(e,", current queue ").concat(this.locks,". ").concat(t??"");SI.debug("".concat(s," ").concat(n))}setId(e){this.id=e}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,this.logger("locked",e);const s=new Te(r=>{t=()=>{this.locks-=1,this.logger("unlocked",e),r()}}),n=this.lockingPromise.then(()=>t);return this.lockingPromise=this.lockingPromise.then(()=>s),n}};function ed(e,t){return function(s,n,r){const i=r.value;if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[t];if(!o)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const c=await o.lock("From ".concat(e,".").concat(n));try{for(var l=arguments.length,d=new Array(l),h=0;h<l;h++)d[h]=arguments[h];return await i.apply(this,d)}finally{c()}},r}}const Ys={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function vm(e,t){const s=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,s)}function ni(e,t,s,n){const r=Object.assign({},Ys,n);let i=r.timeout;const o=async()=>{await function(d){return new Te(h=>{window.setTimeout(h,d)})}(i),i*=r.timeoutFactor,i=Math.min(r.maxRetryTimeout,i)};let c=!1;const l=new Te(async(d,h)=>{t=t||(()=>!1),s=s||(()=>!0);for(let p=0;p<r.maxRetryCount;p+=1){if(c)return h(new se(A.OPERATION_ABORTED));try{const m=await e();if(!t(m,p)||p+1===r.maxRetryCount)return d(m);await o()}catch(m){if(!s(m,p)||p+1===r.maxRetryCount)return h(m);await o()}}});return l.cancel=()=>c=!0,l}let Em,Fb=class{constructor(e){mt(this,"input",[]),mt(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:or(e=this.input).call(e,(t,s)=>t+s)/this.input.length}},ym=0,Bb=0;function Gb(e,t,s,n){return new Te((r,i)=>{t.responseType=t.responseType||"json",t.data&&!s?(t.data=JSON.stringify(t.data),ym+=Ii(t.data)):s&&(t.data.size?ym+=t.data.size:t.data instanceof FormData?ym+=bI(t.data):ym+=Ii(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ba.request(t).then(o=>{typeof o.data=="string"?Bb+=Ii(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?Bb+=o.data.byteLength:Bb+=Ii(JSON.stringify(o.data)),r(o.data)}).catch(o=>{ba.isCancel(o)?i(new se(A.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?i(new se(A.NETWORK_TIMEOUT,o.message)):o.response?i(new se(A.NETWORK_RESPONSE_ERROR,o.response.status)):i(new se(A.NETWORK_ERROR,o.message))})})}async function Cz(e,t){const s=new Blob([t.data],{type:"buffer"});return await Gb(e,ye(ye({},t),{},{data:s,headers:{"Content-Type":"application/octet-stream"}}),!0)}const NI=()=>window.isSecureContext!==void 0;function Dr(e){if(Array.isArray(e))return e.map(s=>s);if(!TI(e))return e;const t={};for(const s in e){const n=e[s];TI(n)||Array.isArray(n)?t[s]=Dr(n):t[s]=n}return t}function TI(e){return!(typeof e!="object"||Array.isArray(e)||!e)}let Wb=class{constructor(e){mt(this,"input",[]),mt(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const kr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Fu={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:kr,remoteCandidate:kr},updateInterval:0},RI={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},CI={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},II={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},AI={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let Hb=class{constructor(e,t){mt(this,"onFirstVideoReceived",void 0),mt(this,"onFirstVideoDecoded",void 0),mt(this,"onFirstAudioReceived",void 0),mt(this,"onFirstVideoDecodedTimeout",void 0),mt(this,"onFirstAudioDecoded",void 0),mt(this,"onSelectedLocalCandidateChanged",void 0),mt(this,"onSelectedRemoteCandidateChanged",void 0),mt(this,"videoIsReady",!1),mt(this,"videoIsReady2",{}),mt(this,"pc",void 0),mt(this,"options",void 0),mt(this,"intervalTimer",void 0),mt(this,"stats",Dr(Fu)),mt(this,"isFirstVideoReceived",{}),mt(this,"isFirstVideoDecoded",{}),mt(this,"isFirstAudioReceived",{}),mt(this,"isFirstAudioDecoded",{}),mt(this,"isFirstVideoDecodedTimeout",{}),mt(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Te(e=>{e({local:ye({},kr),remote:ye({},kr)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,s=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,r=0,i=0,o=0;for(const c of s)e[c].forEach((l,d)=>{if(!this.lossRateWindowStats[t-1][c][d]||!this.lossRateWindowStats[0][c][d])return;const h=this.lossRateWindowStats[t-1][c][d].packets-this.lossRateWindowStats[0][c][d].packets,p=this.lossRateWindowStats[t-1][c][d].packetsLost-this.lossRateWindowStats[0][c][d].packetsLost;c==="videoSend"||c==="audioSend"?(n+=h,i+=p):(r+=h,o+=p),Number.isNaN(h)||Number.isNaN(h)?l.packetLostRate=0:l.packetLostRate=h<=0||p<=0?0:p/(h+p)});e.sendPacketLossRate=n<=0||i<=0?0:i/(n+i),e.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}},Iz=class extends Hb{constructor(){super(...arguments),mt(this,"_stats",Fu),mt(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=Dr(Fu);const s=t.filter(r=>r.type==="ssrc");this.processSSRCStats(s);const n=t.find(r=>r.type==="VideoBwe");n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(t=>{var s;const n=_e(s=t.id).call(s,"send");switch("".concat(t.mediaType,"_").concat(n?"send":"recv")){case"video_send":{const r=Dr(CI);r.codec=t.googCodecName,r.adaptionChangeReason="none",t.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(t.googAvgEncodeMs),r.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.firsCount=Number(t.googFirReceived),r.nacksCount=Number(t.googNacksReceived),r.plisCount=Number(t.googPlisReceived),r.frameCount=Number(t.framesEncoded),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=Dr(RI),i=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(r.codec=t.googCodecName,r.targetDelayMs=Number(t.googTargetDelayMs),r.renderDelayMs=Number(t.googRenderDelayMs),r.currentDelayMs=Number(t.googCurrentDelayMs),r.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),r.decodeMs=Number(t.googDecodeMs),r.maxDecodeMs=Number(t.googMaxDecodeMs),r.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},r.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},r.decodeFrameRate=Number(t.googFrameRateDecoded),r.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},r.jitterBufferMs=Number(t.googJitterBufferMs),r.firsCount=Number(t.googFirsSent),r.nacksCount=Number(t.googNacksSent),r.plisCount=Number(t.googPlisSent),r.framesDecodeCount=Number(t.framesDecoded),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),i){const o=i.stats,c=Date.now()-i.lts;r.framesDecodeFreezeTime=o.framesDecodeFreezeTime,r.framesDecodeInterval=o.framesDecodeInterval,r.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(i.lts=Date.now(),r.framesDecodeInterval=c,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):r.framesDecodeCount<i.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:ye({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=Dr(AI);r.codec=t.googCodecName,r.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,r.decodingCNG=Number(t.googDecodingCNG),r.decodingCTN=Number(t.googDecodingCTN),r.decodingCTSG=Number(t.googDecodingCTSG),r.decodingNormal=Number(t.googDecodingNormal),r.decodingPLC=Number(t.googDecodingPLC),r.decodingPLCCNG=Number(t.googDecodingPLCCNG),r.expandRate=Number(t.googExpandRate),r.accelerateRate=Number(t.googAccelerateRate),r.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),r.speechExpandRate=Number(t.googSpeechExpandRate),r.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),r.jitterBufferMs=Number(t.googJitterBufferMs),r.jitterMs=Number(t.googJitterReceived),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),r.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=Dr(II);r.codec=t.googCodecName,r.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,r.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new Te((e,t)=>{this.pc.getStats(e,t)})}statsResponsesToObjects(e){const t=[];return e.result().forEach(s=>{const n={id:s.id,timestamp:s.timestamp.valueOf().toString(),type:s.type};s.names().forEach(r=>{n[r]=s.stat(r)}),t.push(n)}),t}},td=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({}),wm=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),zb=function(e){return e[e.new=0]="new",e[e.connecting=1]="connecting",e[e.connected=2]="connected",e[e.disconnected=3]="disconnected",e[e.failed=4]="failed",e[e.closed=5]="closed",e}({}),za=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({});var sd=function(e){return e[e.kNone=1]="kNone",e[e.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",e[e.kBytesToBits=8]="kBytesToBits",e}(sd||{});function Bu(e,t,s,n){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:sd.kNone;if(!t)return;const i=Number(t[s]);if(typeof i!="number")return;const o=Number(t[n]);if(typeof o!="number")return;if(!e)return o?i/o*r:void 0;const c=Number(e[s]);if(typeof c!="number")return;const l=Number(e[n]);if(typeof l!="number")return;const d=o-l;return d?(i-c)/d*r:void 0}let OI=class extends Hb{constructor(){super(...arguments),mt(this,"_stats",Fu),mt(this,"report",void 0),mt(this,"lastDecodeVideoReceiverStats",new Map),mt(this,"lastVideoFramesRecv",new Map),mt(this,"lastVideoFramesSent",new Map),mt(this,"lastVideoFramesDecode",new Map),mt(this,"lastVideoFramesOutput",new Map),mt(this,"lastVideoJBDelay",new Map),mt(this,"lastAudioJBDelay",new Map),mt(this,"mediaBytesSent",new Map),mt(this,"mediaBytesRetransmit",new Map),mt(this,"mediaBytesTargetEncode",new Map),mt(this,"lastDecodeAudioReceiverStats",new Map),mt(this,"lastAudioConcealment",new Map),mt(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Dr(Fu),this.report.forEach(e=>{switch(e.type){case za.OUTBOUND:case za.INBOUND:{const t=e.mediaType||e.kind,s=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===za.OUTBOUND?t==="audio"||n?this.processAudioOutboundStats(e):(t==="video"||s)&&this.processVideoOutboundStats(e):e.type===za.INBOUND&&(t==="audio"||n?this.processAudioInboundStats(e):(t==="video"||s)&&this.processVideoInboundStats(e));break}case za.TRANSPORT:{this.processTransportStats(e);const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case za.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:ye({},kr),remote:ye({},kr)};return e.forEach(s=>{let n;if(s.type===za.TRANSPORT&&(n=e.get(s.selectedCandidatePairId)),s.type===za.CANDIDATE_PAIR&&s.selected&&(n=s),n){const r=(i,o)=>{i.type=o.type,i.id=o.id,o.address&&(i.address=o.address),o.candidateType&&(i.candidateType=o.candidateType),o.port&&(i.port=o.port),o.priority&&(i.priority=o.priority),o.protocol&&(i.protocol=o.protocol),o.relayProtocol&&(i.relayProtocol=o.relayProtocol)};if(n.localCandidateId){const i=e.get(n.localCandidateId);i&&r(t.local,i)}if(n.remoteCandidateId){const i=e.get(n.remoteCandidateId);i&&r(t.remote,i)}}}),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===za.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===za.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===za.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(ye({},t),ye({},this.stats.selectedCandidatePair.localCandidate)),e.type===za.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(ye({},t),ye({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find(n=>n.ssrc===e.ssrc);t||(t=Dr(AI),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.totalProcessingDelay=e.totalProcessingDelay,t.jitterBufferEmittedCount=e.jitterBufferEmittedCount,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const s=this.lastDecodeAudioReceiverStats.get(t.ssrc);t.avgProcessingDelayMs=Bu(s,t,"totalProcessingDelay","jitterBufferEmittedCount",sd.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,t),this.calculateAudioFreeze(t,s,e),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(t.ssrc,ye({},t))}calculateAudioFreeze(e,t,s){const n=this.lastAudioConcealment.get(e.ssrc);if(t!=null&&n!=null){const r=n.lts,i=s.timestamp,o=i-r;if(o<=0)return;const c=e.concealedSamples-t.concealedSamples-0,l=n.nonSilent+c,d=e.totalSamplesReceived-t.totalSamplesReceived;if(d<=0)return;const h=80*d/o,p=200*d/o,m=o/d;let g=0;e.freezeSamples80=t.freezeSamples80,e.freezeMs80=t.freezeMs80,l>h&&(n.plc80>0?(e.freezeSamples80+=c,e.freezeMs80+=Math.round(c*m)):(e.freezeSamples80+=l,e.freezeMs80+=Math.round(l*m)),g=n.plc80+1);let T=0;e.freezeSamples200=t.freezeSamples200,e.freezeMs200=t.freezeMs200,l>p&&(n.plc200>0?(e.freezeSamples200+=c,e.freezeMs200+=Math.round(c*m)):(e.freezeSamples200+=l,e.freezeMs200+=Math.round(l*m)),T=n.plc200+1),this.lastAudioConcealment.set(e.ssrc,{nonSilent:c,lts:i,plc80:g,plc200:T})}else e.freezeSamples80=0,e.freezeSamples200=0,e.freezeMs80=0,e.freezeMs200=0,this.lastAudioConcealment.set(e.ssrc,{nonSilent:0,lts:s.timestamp,plc80:0,plc200:0})}processVideoInboundStats(e){let t=this._stats.videoRecv.find(o=>o.ssrc===e.ssrc);t||(t=Dr(RI),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration,t.totalProcessingDelay=e.totalProcessingDelay,t.packetsDiscarded=e.packetsDiscarded,t.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,t.totalAssemblyTime=e.totalAssemblyTime,t.keyFramesDecoded=e.keyFramesDecoded,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const s=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),r=this.lastVideoFramesOutput.get(t.ssrc),i=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const o=t.decodedFrame?t.decodedFrame.width:0,c=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,o,c),this.isFirstVideoDecoded[t.ssrc]=!0}if(s){const o=s.stats,c=i-s.lts;t.framesDecodeFreezeTime=o.framesDecodeFreezeTime,t.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(s.lts=Date.now(),t.framesDecodeInterval=c,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<o.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(s.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-s.qpSum)/(e.framesDecoded-s.stats.framesDecodeCount))}e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime,t.avgDecodeMs=Bu(s==null?void 0:s.stats,t,"decodeMs","framesDecodeCount")),t.avgProcessingDelayMs=Bu(s==null?void 0:s.stats,t,"totalProcessingDelay","framesDecodeCount",sd.kMillisecondsFromSeconds),t.avgFramesAssembledFromMultiplePacketsMs=Bu(s==null?void 0:s.stats,t,"totalAssemblyTime","framesAssembledFromMultiplePackets",sd.kMillisecondsFromSeconds),t.avgInterFrameDelayMs=Bu(s==null?void 0:s.stats,t,"totalInterFrameDelay","framesDecodeCount",sd.kMillisecondsFromSeconds),n&&i-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((i-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:i,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:i,rate:0}),t.framesDroppedCount&&e.framesReceived&&(r&&i-r.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-r.count)/((i-r.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:i,rate:Math.max(t.outputFrameRate,0)})):r?t.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:i,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:ye({},t),lts:s?s.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find(n=>n.ssrc===e.ssrc);t||(t=Dr(CI),this._stats.videoSend.push(t));const s=this.mediaBytesSent.get(e.ssrc);if(s)s.add(e.bytesSent);else{const n=new Wb(10);n.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,n)}if(e.retransmittedBytesSent!==void 0){const n=this.mediaBytesRetransmit.get(e.ssrc);if(n)n.add(e.retransmittedBytesSent);else{const r=new Wb(10);r.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,r)}}if(e.totalEncodedBytesTarget){const n=this.mediaBytesTargetEncode.get(e.ssrc);if(n)n.add(e.totalEncodedBytesTarget);else{const r=new Wb(10);r.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,r)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,t.hugeFramesSent=e.hugeFramesSent,t.keyFramesEncoded=e.keyFramesEncoded,t.targetBitrate=e.targetBitrate,e.totalEncodeTime&&e.framesEncoded){const n=this.lastEncoderMs.get(e.ssrc);if(!n||n.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const r=e.framesEncoded-n.lastFrameCount,i=e.totalEncodeTime-n.lastEncoderTime;t.avgEncodeMs=1e3*i/r}}if(e.framesEncoded&&e.qpSum){const n=this.lastEncoderMs.get(e.ssrc);!n||n.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-n.lastQpSum)/(e.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,za.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find(s=>s.ssrc===e.ssrc);if(t||(t=Dr(II),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const s=this.findRemoteStatsId(e.ssrc,za.REMOTE_INBOUND);s&&this.processRemoteInboundStats(s,t)}}processTransportStats(e){this._stats.transport.bytesReceived=e.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=e.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=e.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=e.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(e,t){var s;const n=Array.from(Pa(s=this.report).call(s)).find(r=>r.type===t&&r.ssrc===e);return n?n.id:null}processVideoMediaSource(e,t){const s=this.report.get(e);s&&s.width&&s.height&&s.framesPerSecond&&(t.inputFrame={width:s.width,height:s.height,frameRate:s.framesPerSecond})}processAudioMediaSource(e,t){const s=this.report.get(e);s&&(t.inputLevel=s.audioLevel)}processVideoTrackSenderStats(e,t,s){var n,r,i,o;const c=t?this.report.get(t):void 0,l=(n=c==null?void 0:c.framesSent)!==null&&n!==void 0?n:e.framesSent;if(typeof l!="number")return;let d=(r=c==null?void 0:c.frameWidth)!==null&&r!==void 0?r:e.frameWidth,h=(i=c==null?void 0:c.frameHeight)!==null&&i!==void 0?i:e.frameHeight,p=(o=c==null?void 0:c.framesPerSecond)!==null&&o!==void 0?o:e.framesPerSecond;if(typeof d=="number"&&typeof h=="number"||(d=0,h=0),p==null){const m=Date.now(),g=this.lastVideoFramesSent.get(s.ssrc);g&&m-g.lts>=800?(p=Math.round((l-g.count)/((m-g.lts)/1e3)),this.lastVideoFramesSent.set(s.ssrc,{count:l,lts:m,rate:p})):g?p=g.rate:this.lastVideoFramesSent.set(s.ssrc,{count:l,lts:m,rate:0})}s.sentFrame={width:d,height:h,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(e,t,s){var n,r,i,o,c;const l=t?this.report.get(t):void 0,d=(n=l==null?void 0:l.framesReceived)!==null&&n!==void 0?n:e.framesReceived,h=(r=l==null?void 0:l.frameWidth)!==null&&r!==void 0?r:e.frameWidth,p=(i=l==null?void 0:l.frameHeight)!==null&&i!==void 0?i:e.frameHeight,m=(o=l==null?void 0:l.jitterBufferDelay)!==null&&o!==void 0?o:e.jitterBufferDelay,g=(c=l==null?void 0:l.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof d=="number"){const T=this.lastVideoFramesRecv.get(s.ssrc),w=Date.now();s.framesReceivedCount=d;let S=0;T&&w-T.lts>=800?(S=Math.round((d-T.count)/((w-T.lts)/1e3)),this.lastVideoFramesRecv.set(s.ssrc,{count:d,lts:w,rate:S})):T?S=T.rate:this.lastVideoFramesRecv.set(s.ssrc,{count:d,lts:w,rate:0}),s.receivedFrame={width:h||0,height:p||0,frameRate:S||0},s.decodedFrame={width:h||0,height:p||0,frameRate:s.decodeFrameRate||0},s.outputFrame={width:h||0,height:p||0,frameRate:s.outputFrameRate||s.decodeFrameRate||0}}if(m&&g){const T=this.lastVideoJBDelay.get(s.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let w=T.jitterBufferMs;const S=g-T.jitterBufferEmittedCount;S>0&&(w=1e3*(m-T.jitterBufferDelay)/S),s.jitterBufferMs=w,s.currentDelayMs=Math.round(w),this.lastVideoJBDelay.set(s.ssrc,{jitterBufferDelay:m,jitterBufferEmittedCount:g,jitterBufferMs:s.currentDelayMs})}}processAudioTrackSenderStats(e,t,s){var n,r,i,o;const c=t?this.report.get(t):void 0,l=(n=(r=c==null?void 0:c.echoReturnLoss)!==null&&r!==void 0?r:e.echoReturnLoss)!==null&&n!==void 0?n:0,d=(i=(o=c==null?void 0:c.echoReturnLossEnhancement)!==null&&o!==void 0?o:e.echoReturnLossEnhancement)!==null&&i!==void 0?i:0;s.aecReturnLoss=l,s.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,s){var n,r,i,o,c,l,d,h,p;const m=t?this.report.get(t):void 0,g=(n=m==null?void 0:m.removedSamplesForAcceleration)!==null&&n!==void 0?n:e.removedSamplesForAcceleration,T=(r=m==null?void 0:m.totalSamplesReceived)!==null&&r!==void 0?r:e.totalSamplesReceived,w=(i=m==null?void 0:m.jitterBufferDelay)!==null&&i!==void 0?i:e.jitterBufferDelay,S=(o=m==null?void 0:m.jitterBufferEmittedCount)!==null&&o!==void 0?o:e.jitterBufferEmittedCount,I=(c=m==null?void 0:m.audioLevel)!==null&&c!==void 0?c:e==null?void 0:e.audioLevel,O=(l=m==null?void 0:m.totalSamplesDuration)!==null&&l!==void 0?l:e==null?void 0:e.totalSamplesDuration,M=(d=m==null?void 0:m.concealedSamples)!==null&&d!==void 0?d:e.concealedSamples,z=(h=m==null?void 0:m.silentConcealedSamples)!==null&&h!==void 0?h:e.silentConcealedSamples,K=(p=m==null?void 0:m.concealmentEvents)!==null&&p!==void 0?p:e.concealmentEvents;if(typeof T=="number"&&(s.totalSamplesReceived=T),typeof z=="number"&&(s.silentConcealedSamples=z),typeof K=="number"&&(s.concealmentEvents=K),typeof M=="number"&&(s.concealedSamples=M),g&&T&&(s.accelerateRate=g/T),w&&S){const Y=this.lastAudioJBDelay.get(s.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let ce=Y.jitterBufferMs;const xe=S-Y.jitterBufferEmittedCount;xe>0&&(ce=1e3*(w-Y.jitterBufferDelay)/xe),s.jitterBufferMs=Math.round(ce),this.lastAudioJBDelay.set(s.ssrc,{jitterBufferDelay:w,jitterBufferEmittedCount:S,jitterBufferMs:s.jitterBufferMs})}s.outputLevel=I;let V=1920;O&&T&&(V=T/O/50,s.receivedFrames=Math.round(T/V)),M&&(s.droppedFrames=Math.round(M/V))}processRemoteInboundStats(e,t){const s=this.report.get(e);s&&(t.packetsLost=s.packetsLost,s.roundTripTime&&(t.rttMs=1e3*s.roundTripTime),s.jitter&&(t.jitterMs=1e3*s.jitter),s.timestamp&&(t.timestamp=s.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const s=t.mimeType.match(/\/(.*)$/);return s&&s[1]?s[1]:""}updateSendBitrate(){let e=0,t=null,s=null;this.mediaBytesSent.forEach(r=>{e+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{t=t===null?r.diffMean():t+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{s=s===null?r.diffMean():s+r.diffMean()});const n=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),s!==null&&(this._stats.bitrate.targetEncoded=8*s/(this.options.updateInterval/1e3))}},Az=class extends Hb{updateStats(){return Te.resolve()}};function Sm(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const i=function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null}();return i?i<76?new Iz(e,{updateInterval:t,lossRateInterval:s,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new OI(e,{updateInterval:t,lossRateInterval:s,freezeRateLimit:n,firstVideoDecodedTimeout:r}):function(o){if(!window.RTCStatsReport)return!1;const c=o.getStats();return!!(c instanceof Te||function(l){return!!l&&(typeof l=="object"||typeof l=="function")&&typeof l.then=="function"}(c))}(e)?new OI(e,{updateInterval:t,lossRateInterval:s,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new Az(e,{updateInterval:t,lossRateInterval:s,freezeRateLimit:n,firstVideoDecodedTimeout:r})}const DI="websdk_ng_install_id";function Kb(){try{if(C("INSTALL_ID"))return C("INSTALL_ID");let e=window.localStorage.getItem(DI);return e||(e=kc(),window.localStorage.setItem(DI,e)),ss("INSTALL_ID",e),e}catch{return}}const lr=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(t&&t[1]&&t[2]){const s=t[1],n=t[2];return"".concat(s,".").concat(n)}return"4.0.0.999"}("4.24.2"),Yb=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let jc=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const Un=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),s=["t","s","t"];s.splice(1,0,"e");const n=s.join(""),r=[];for(let c=0;c<6;c++)r.push("1");const i=r.join(""),o={};return o[e]=n,o[t]=i,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Un;const Nm={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},qb={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Xb="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",Jb={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},$t=ye(ye(ye(ye({},Jb),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:qb,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},Nm),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function ss(e,t,s){var n,r,i;_e(n=Object.keys($t)).call(n,e)&&(!s&&_e(r=Object.keys(Ka)).call(r,e)||($t[e]=t,e!=="ENABLE_VIDEO_SEI"&&e!=="ENABLE_AUDIO_TOPN"&&e!=="ENABLE_AUDIO_METADATA"&&e!=="ENABLE_AUDIO_PTS"||t!==!0||($t.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(i=!!t,$t.USE_NEW_NETWORK_CONFIG=i,i&&($t.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],$t.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],$t.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],$t.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],$t.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",$t.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",$t.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),e==="ENABLE_PRE_SUB"&&t&&($t.ENABLE_INSTANT_VIDEO=!0,$t.ENABLE_PREALLOC_PC=!0),e==="ENABLE_SVC"&&t&&($t.ENABLE_AUT_CC=!0),e==="NEW_FORCE_TURN"&&t&&($t.NEW_TURN_MODE||($t.NEW_TURN_MODE=4))))}function C(e){if(e==="TURN_DOMAINS"){const t=$t.TURN_DOMAINS;return _e(t).call(t,C("TURN_DOMAIN"))?t:[C("TURN_DOMAIN")].concat(t)}return $t[e]}Yb||($t.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],$t.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],$t.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],$t.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],$t.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],$t.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],$t.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",$t.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",$t.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",$t.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",$t.AREAS=["NORTH_AMERICA","OVERSEA"]);let kI=function(e){return e[e.REALTIME=1]="REALTIME",e}({});const Ka={};var dt=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_RTE_URL="SET_RTE_URL",e.SET_RTE_SID="SET_RTE_SID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",e.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",e.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",e.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",e.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",e.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",e.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(dt||{});let Pc=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});const jI=128,Oz=96,PI=1e3,nd=10;let Dz=0;var LI=(()=>{var e={8:(n,r,i)=>{i.r(r),i.d(r,{Parser:()=>xe,Printer:()=>xt,parse:()=>Se,print:()=>Me});const o=`
`,c="".concat("\r").concat(o),l=" ";let d;function h(me){return me>="0"&&me<="9"}function p(me){return me>="!"&&me<="~"}function m(me){return p(me)||me>=""&&me<=""}function g(me){return me==="!"||me>="#"&&me<="'"||me>="*"&&me<="+"||me>="-"&&me<="."||me>="0"&&me<="9"||me>="A"&&me<="Z"||me>="^"&&me<="~"}function T(me){return me>="1"&&me<="9"}function w(me){return me>="A"&&me<="Z"||me>="a"&&me<="z"}function S(me){return me==="d"||me==="h"||me==="m"||me==="s"}function I(me){return me>""&&me<"	"||me>"\v"&&me<"\f"||me>""&&me<""}function O(me){return w(me)||h(me)||me==="+"||me==="/"}function M(me){return h(me)||w(me)||me==="+"||me==="/"||me==="-"||me==="_"}function z(me){return w(me)||h(me)||me==="+"||me==="/"}function K(me,v){var L=Object.keys(me);if(Object.getOwnPropertySymbols){var W=Object.getOwnPropertySymbols(me);v&&(W=W.filter(function(Ee){return Object.getOwnPropertyDescriptor(me,Ee).enumerable})),L.push.apply(L,W)}return L}function V(me){for(var v=1;v<arguments.length;v++){var L=arguments[v]!=null?arguments[v]:{};v%2?K(Object(L),!0).forEach(function(W){Y(me,W,L[W])}):Object.getOwnPropertyDescriptors?Object.defineProperties(me,Object.getOwnPropertyDescriptors(L)):K(Object(L)).forEach(function(W){Object.defineProperty(me,W,Object.getOwnPropertyDescriptor(L,W))})}return me}function Y(me,v,L){return v in me?Object.defineProperty(me,v,{value:L,enumerable:!0,configurable:!0,writable:!0}):me[v]=L,me}(function(me){me.VERSION="v",me.ORIGIN="o",me.SESSION_NAME="s",me.INFORMATION="i",me.URI="u",me.EMAIL="e",me.PHONE="p",me.CONNECTION="c",me.BANDWIDTH="b",me.TIME="t",me.REPEAT="r",me.ZONE_ADJUSTMENTS="z",me.KEY="k",me.ATTRIBUTE="a",me.MEDIA="m"})(d||(d={}));class ce{consumeText(v,L){let W=L;for(;W<v.length;){const Ee=v[W];if(Ee==="\0"||Ee==="\r"||Ee===o)break;W+=1}if(W-L==0)throw new Error("Invalid text, at ".concat(v));return W}consumeUnicastAddress(v,L,W){return this.consumeTill(v,L,l)}consumeOneOrMore(v,L,W){let Ee=L;for(;W(v[Ee]);)Ee++;if(Ee-L==0)throw new Error("Invalid rule at ".concat(L,"."));return Ee}consumeSpace(v,L){if(v[L]===l)return L+1;throw new Error("Invalid space at ".concat(L,"."))}consumeIP4Address(v,L){let W=L;for(let Ee=0;Ee<4;Ee++)if(W=this.consumeDecimalUChar(v,W),Ee!==3){if(v[W]!==".")throw new Error("Invalid IP4 address.");W++}return W}consumeDecimalUChar(v,L){let W=L;for(let pt=0;pt<3&&h(v[W]);pt++,W++);if(W-L==0)throw new Error("Invalid decimal uchar.");const Ee=parseInt(v.slice(L,W));if(Ee>=0&&Ee<=255)return W;throw new Error("Invalid decimal uchar")}consumeIP6Address(v,L){let W=this.consumeHexpart(v,L);return v[W]===":"&&(W+=1,W=this.consumeIP4Address(v,W)),W}consumeHexpart(v,L){let W=L;if(v[W]===":"&&v[W+1]===":"){W+=2;try{W=this.consumeHexseq(v,W)}catch{}return W}if(W=this.consumeHexseq(v,W),v[W]===":"&&v[W+1]===":"){W+=2;try{W=this.consumeHexseq(v,W)}catch{}return W}return W}consumeHexseq(v,L){let W=L;for(;W=this.consumeHex4(v,W),v[W]===":"&&v[W+1]!==":";)W+=1;return W}consumeHex4(v,L){let W=0;for(;W<4;W++)if(!((Ee=v[L+W])>="0"&&Ee<="9"||Ee>="a"&&Ee<="f"||Ee>="A"&&Ee<="F")){if(W===0)throw new Error("Invalid hex 4");break}var Ee;return L+W}consumeFQDN(v,L){let W=L;for(;h(v[W])||w(v[W])||v[W]==="-"||v[W]===".";)W+=1;if(W-L<4)throw new Error("Invalid FQDN");return W}consumeExtnAddr(v,L){return this.consumeOneOrMore(v,L,m)}consumeMulticastAddress(v,L,W){switch(W){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(v,L);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(v,L);default:try{return this.consumeFQDN(v,L)}catch{return this.consumeExtnAddr(v,L)}}}consumeIP6MulticastAddress(v,L){const W=this.consumeHexpart(v,L);return v[W]==="/"?this.consumeInteger(v,W+1):W}consumeIP4MulticastAddress(v,L){let W=L+3;const Ee=v.slice(L,W),pt=parseInt(Ee);if(pt<224||pt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let us=0;us<3;us++){if(v[W]!==".")throw new Error("Invalid IP4 multicast address.");W+=1,W=this.consumeDecimalUChar(v,W)}return v[W]==="/"&&(W+=1),W=this.consumeTTL(v,W),v[W]==="/"&&(W=this.consumeInteger(v,W)),W}consumeInteger(v,L){if(!T(v[L]))throw new Error("Invalid integer.");for(L+=1;h(v[L]);)L+=1;return L}consumeTTL(v,L){if(v[L]==="0")return L+1;if(!T(v[L]))throw new Error("Invalid TTL.");L+=1;for(let W=0;W<2&&h(v[L]);W++)L+=1;return L}consumeToken(v,L){return this.consumeOneOrMore(v,L,g)}consumeTime(v,L){let W=L;if(v[W]==="0")return W+1;for(T(v[W])&&(W+=1);h(v[W]);)W++;if(W-L<10)throw new Error("Invalid time");return W}consumeAddress(v,L){return this.consumeTill(v,L,l)}consumeTypedTime(v,L){let W=L;return W=this.consumeOneOrMore(v,W,h),S(v[W])?W+1:W}consumeRepeatInterval(v,L){if(!T(v[L]))throw new Error("Invalid repeat interval");for(L+=1;h(v[L]);)L+=1;return S(v[L])&&(L+=1),L}consumePort(v,L){return this.consumeOneOrMore(v,L,h)}consume(v,L,W){for(let Ee=0;Ee<W.length;Ee++){if(L+Ee>=v.length)throw new Error("consume exceeding value length");if(v[L+Ee]!==W[Ee])throw new Error("consume ".concat(W," failed at ").concat(Ee))}return L+W.length}consumeTill(v,L,W){let Ee=L;for(;Ee<v.length&&(typeof W!="string"||v[Ee]!==W)&&(typeof W!="function"||!W(v[Ee]));)Ee++;return Ee}}class xe extends ce{constructor(){super(),Y(this,"records",[]),Y(this,"currentLine",0)}parse(v){const L=this.probeEOL(v);this.records=v.split(L).filter(ac=>!!la(ac).call(ac)).map(this.parseLine),this.currentLine=0;const W=this.parseVersion(),Ee=this.parseOrigin(),pt=this.parseSessionName(),us=this.parseInformation(),vn=this.parseUri(),br=this.parseEmail(),nc=this.parsePhone(),Gf=this.parseConnection(),Pd=this.parseBandWidth(),Wf=this.parseTimeFields(),rl=this.parseKey(),Nh=this.parseSessionAttribute(),il=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:W,origin:Ee,sessionName:pt,information:us,uri:vn,emails:br,phones:nc,connection:Gf,bandwidths:Pd,timeFields:Wf,key:rl,attributes:Nh,mediaDescriptions:il}}getCurrentRecord(){const v=this.records[this.currentLine];if(!v)throw new Error("Record doesn't exit.");return v}probeEOL(v){for(let L=0;L<v.length;L++)if(v[L]===o)return v[L-1]==="\r"?c:o;throw new Error("Invalid newline character.")}parseLine(v,L){if(v.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const W=v[0];if(v[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:W,value:v.slice(2),line:L,cur:0}}parseSessionAttribute(){const v=new lt;for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==d.ATTRIBUTE)break;const W={attField:this.extractOneOrMore(L,Ee=>g(Ee)&&Ee!==":"),_cur:0};L.value[L.cur]===":"&&(L.cur+=1,W.attValue=this.extractOneOrMore(L,I)),v.parse(W),this.currentLine++}return v.digest()}parseMediaAttributes(v){const L=new at(v);for(;this.currentLine<this.records.length;){const W=this.getCurrentRecord();if(W.type!==d.ATTRIBUTE)break;const Ee={attField:this.extractOneOrMore(W,pt=>g(pt)&&pt!==":"),_cur:0};W.value[W.cur]===":"&&(W.cur+=1,Ee.attValue=this.extractOneOrMore(W,I)),L.parse(Ee),this.currentLine++}return L.digest()}parseKey(){const v=this.getCurrentRecord();if(v.type===d.KEY){if(v.value==="prompt"||v.value==="clear:"||v.value==="base64:"||v.value==="uri:")return v.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const v=this.getCurrentRecord();if(v.type===d.ZONE_ADJUSTMENTS){const L=[];for(;;)try{const W=this.extract(v,this.consumeTime);this.consumeSpaceForRecord(v);let Ee=!1;v.value[v.cur]==="-"&&(Ee=!0,v.cur+=1);const pt=this.extract(v,this.consumeTypedTime);L.push({time:W,typedTime:pt,back:Ee})}catch{break}if(L.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,L}return[]}parseRepeat(){const v=[];for(;;){const L=this.getCurrentRecord();if(L.type!==d.REPEAT)break;{const W=this.extract(L,this.consumeRepeatInterval),Ee=this.parseTypedTime(L);v.push({repeatInterval:W,typedTimes:Ee}),this.currentLine++}}return v}parseTypedTime(v){const L=[];for(;;)try{this.consumeSpaceForRecord(v),L.push(this.extract(v,this.consumeTypedTime))}catch{break}if(L.length===0)throw new Error("Invalid typed time.");return L}parseTime(){const v=this.getCurrentRecord(),L=this.extract(v,this.consumeTime);this.consumeSpaceForRecord(v);const W=this.extract(v,this.consumeTime);return this.currentLine++,{startTime:L,stopTime:W}}parseBandWidth(){const v=[];for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==d.BANDWIDTH)break;{const W=this.extractOneOrMore(L,g);if(L.value[L.cur]!==":")throw new Error("Invalid bandwidth field.");L.cur++;const Ee=this.extractOneOrMore(L,h);v.push({bwtype:W,bandwidth:Ee}),this.currentLine++}}return v}parseVersion(){const v=this.getCurrentRecord();if(v.type!==d.VERSION)throw new Error("first sdp record must be version");const L=v.value.slice(0,this.consumeOneOrMore(v.value,0,h));if(L.length!==v.value.length)throw new Error('invalid proto version, "v='.concat(v.value,'"'));return this.currentLine++,L}parseOrigin(){const v=this.getCurrentRecord();if(v.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");const L=this.extractOneOrMore(v,m);this.consumeSpaceForRecord(v);const W=this.extractOneOrMore(v,h);this.consumeSpaceForRecord(v);const Ee=this.extractOneOrMore(v,h);this.consumeSpaceForRecord(v);const pt=this.extractOneOrMore(v,g);this.consumeSpaceForRecord(v);const us=this.extractOneOrMore(v,g);this.consumeSpaceForRecord(v);const vn=this.extract(v,this.consumeUnicastAddress);return this.currentLine++,{username:L,sessId:W,sessVersion:Ee,nettype:pt,addrtype:us,unicastAddress:vn}}parseSessionName(){const v=this.getCurrentRecord();if(v.type===d.SESSION_NAME){const L=this.extract(v,this.consumeText);return this.currentLine++,L}}parseInformation(){const v=this.getCurrentRecord();if(v.type!==d.INFORMATION)return;const L=this.extract(v,this.consumeText);return this.currentLine++,L}parseUri(){const v=this.getCurrentRecord();if(v.type===d.URI)return this.currentLine++,v.value}parseEmail(){const v=[];for(;;){const L=this.getCurrentRecord();if(L.type!==d.EMAIL)break;v.push(L.value),this.currentLine++}return v}parsePhone(){const v=[];for(;;){const L=this.getCurrentRecord();if(L.type!==d.PHONE)break;v.push(L.value),this.currentLine++}return v}parseConnection(){const v=this.getCurrentRecord();if(v.type===d.CONNECTION){const L=this.extractOneOrMore(v,g);this.consumeSpaceForRecord(v);const W=this.extractOneOrMore(v,g);this.consumeSpaceForRecord(v);const Ee=this.extract(v,this.consumeAddress);return this.currentLine++,{nettype:L,addrtype:W,address:Ee}}}parseMedia(){const v=this.getCurrentRecord(),L=this.extract(v,this.consumeToken);this.consumeSpaceForRecord(v);let W=this.extract(v,this.consumePort);v.value[v.cur]==="/"&&(v.cur+=1,W+=this.extract(v,this.consumeInteger)),this.consumeSpaceForRecord(v);const Ee=[];for(Ee.push(this.extract(v,this.consumeToken));v.value[v.cur]==="/";)v.cur+=1,Ee.push(this.extract(v,this.consumeToken));if(Ee.length===0)throw new Error("Invalid proto");const pt=this.parseFmt(v);return this.currentLine++,{mediaType:L,port:W,protos:Ee,fmts:pt}}parseTimeFields(){const v=[];for(;this.getCurrentRecord().type===d.TIME;){const L=this.parseTime(),W=this.parseRepeat(),Ee=this.parseZone();v.push({time:L,repeats:W,zones:Ee})}return v}parseMediaDescription(){const v=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){const L=this.parseMedia(),W=this.parseInformation(),Ee=this.parseConnections(),pt=this.parseBandWidth(),us=this.parseKey(),vn=this.parseMediaAttributes(L);v.push({media:L,information:W,connections:Ee,bandwidths:pt,key:us,attributes:vn})}return v}parseConnections(){const v=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)v.push(this.parseConnection());return v}parseFmt(v){const L=[];for(;;)try{this.consumeSpaceForRecord(v),L.push(this.extract(v,this.consumeToken))}catch{break}if(L.length===0)throw new Error("Invalid fmts");return L}extract(v,L){for(var W=arguments.length,Ee=new Array(W>2?W-2:0),pt=2;pt<W;pt++)Ee[pt-2]=arguments[pt];const us=L.call(this,v.value,v.cur,...Ee),vn=v.value.slice(v.cur,us);return v.cur=us,vn}extractOneOrMore(v,L){const W=this.consumeOneOrMore(v.value,v.cur,L),Ee=v.value.slice(v.cur,W);return v.cur=W,Ee}consumeSpaceForRecord(v){if(v.value[v.cur]!==l)throw new Error("Invalid space at ".concat(v.cur,"."));v.cur+=1}}class ke extends ce{constructor(){super(...arguments),Y(this,"attributes",void 0),Y(this,"digested",!1)}extractOneOrMore(v,L,W){const Ee=this.consumeOneOrMore(v.attValue,v._cur,L),pt=v.attValue.slice(v._cur,Ee),[us,vn]=W||[];if(typeof us=="number"&&pt.length<us)throw new Error("error in length, should be more or equal than ".concat(us," characters."));if(typeof vn=="number"&&pt.length>vn)throw new Error("error in length, should be less or equal than ".concat(vn," characters."));return v._cur=Ee,pt}consumeAttributeSpace(v){if(v.attValue[v._cur]!==l)throw new Error("Invalid space at ".concat(v._cur,"."));v._cur+=1}extract(v,L){if(!v.attValue)throw new Error("Nothing to extract from attValue.");for(var W=arguments.length,Ee=new Array(W>2?W-2:0),pt=2;pt<W;pt++)Ee[pt-2]=arguments[pt];const us=L.call(this,v.attValue,v._cur,...Ee),vn=v.attValue.slice(v._cur,us);return v._cur=us,vn}atEnd(v){if(!v.attValue)throw new Error;return v._cur>=v.attValue.length}peekChar(v){if(!v.attValue)throw new Error;return v.attValue[v._cur]}peek(v,L){if(!v.attValue)throw new Error;for(let W=0;W<L.length;W++)if(L[W]!==v.attValue[v._cur+W])return!1;return!0}parseIceUfrag(v){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(v,O,[4,256])}parseIcePwd(v){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(v,O,[22,256])}parseIceOptions(v){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const L=[];for(;!this.atEnd(v);){L.push(this.extractOneOrMore(v,O));try{this.consumeAttributeSpace(v)}catch(W){if(this.atEnd(v))break;throw W}}this.attributes.iceOptions=L}parseFingerprint(v){const L=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const W=this.extract(v,this.consumeTill);this.attributes.fingerprints.push({hashFunction:L,fingerprint:W})}parseExtmap(v){const L=this.extractOneOrMore(v,h);let W;this.peekChar(v)==="/"&&(this.extract(v,this.consume,"/"),W=this.extract(v,this.consumeToken)),this.consumeAttributeSpace(v);const Ee=this.extract(v,this.consumeTill,l),pt=V(V({entry:parseInt(L,10)},W&&{direction:W}),{},{extensionName:Ee});this.peekChar(v)===l&&(this.consumeAttributeSpace(v),pt.extensionAttributes=this.extract(v,this.consumeTill)),this.attributes.extmaps.push(pt)}parseSetup(v){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const L=this.extract(v,this.consumeTill);if(L!=="active"&&L!=="passive"&&L!=="actpass"&&L!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=L}}class lt extends ke{constructor(){super(...arguments),Y(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(v){if(this.digested)throw new Error("already digested");try{switch(v.attField){case"group":this.parseGroup(v);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(v);break;case"ice-pwd":this.parseIcePwd(v);break;case"ice-options":this.parseIceOptions(v);break;case"fingerprint":this.parseFingerprint(v);break;case"setup":this.parseSetup(v);break;case"tls-id":this.parseTlsId(v);break;case"identity":this.parseIdentity(v);break;case"extmap":this.parseExtmap(v);break;case"msid-semantic":this.parseMsidSemantic(v);break;default:v.ignored=!0,this.attributes.unrecognized.push(v)}}catch(L){throw console.error("parsing session attribute ".concat(v.attField,' error, "a=').concat(v.attField,":").concat(v.attValue,'"')),L}if(!v.ignored&&v.attValue&&!this.atEnd(v))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(v){const L=this.extract(v,this.consumeToken),W=[];for(;!this.atEnd(v)&&this.peekChar(v)===l;)this.consumeAttributeSpace(v),W.push(this.extract(v,this.consumeToken));this.attributes.groups.push({semantic:L,identificationTag:W})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(v){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(v,M)}parseIdentity(v){const L=this.extractOneOrMore(v,z),W=[];for(;!this.atEnd(v)&&this.peekChar(v)===l;){this.consumeAttributeSpace(v);const Ee=this.extract(v,this.consumeToken);this.extract(v,this.consume,"=");const pt=this.extractOneOrMore(v,us=>us!==l&&I(us));W.push({name:Ee,value:pt})}this.attributes.identities.push({assertionValue:L,extensions:W})}parseMsidSemantic(v){this.peekChar(v)===l&&this.consumeAttributeSpace(v);const L={semantic:this.extract(v,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(v)}catch{break}if(this.peekChar(v)==="*"){this.extract(v,this.consume,"*"),L.applyForAll=!0;break}{const W=this.extract(v,this.consumeTill,l);L.identifierList.push(W)}}this.attributes.msidSemantic=L}}class at extends ke{constructor(v){super(),Y(this,"attributes",void 0),v.protos.indexOf("RTP")!==-1||v.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(v){if(this.digested)throw new Error("already digested");try{switch(v.attField){case"extmap":this.parseExtmap(v);break;case"setup":this.parseSetup(v);break;case"ice-ufrag":this.parseIceUfrag(v);break;case"ice-pwd":this.parseIcePwd(v);break;case"ice-options":this.parseIceOptions(v);break;case"candidate":this.parseCandidate(v);break;case"remote-candidate":this.parseRemoteCandidate(v);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(v);break;case"rtpmap":this.parseRtpmap(v);break;case"ptime":this.parsePtime(v);break;case"maxptime":this.parseMaxPtime(v);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(v);break;case"ssrc":this.parseSSRC(v);break;case"fmtp":this.parseFmtp(v);break;case"rtcp-fb":this.parseRtcpFb(v);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(v);break;case"mid":this.parseMid(v);break;case"msid":this.parseMsid(v);break;case"imageattr":this.parseImageAttr(v);break;case"rid":this.parseRid(v);break;case"simulcast":this.parseSimulcast(v);break;case"sctp-port":this.parseSctpPort(v);break;case"max-message-size":this.parseMaxMessageSize(v);break;case"ssrc-group":this.parseSSRCGroup(v);break;default:v.ignored=!0,this.attributes.unrecognized.push(v)}}catch(L){throw console.error("parsing media attribute ".concat(v.attField,' error, "a=').concat(v.attField,":").concat(v.attValue,'"')),L}if(!v.ignored&&v.attValue&&!this.atEnd(v))throw new Error("attribute parsing error")}parseCandidate(v){const L=this.extractOneOrMore(v,O,[1,32]);this.consumeAttributeSpace(v);const W=this.extractOneOrMore(v,h,[1,5]);this.consumeAttributeSpace(v);const Ee=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const pt=this.extractOneOrMore(v,h,[1,10]);this.consumeAttributeSpace(v);const us=this.extract(v,this.consumeAddress);this.consumeAttributeSpace(v);const vn=this.extract(v,this.consumePort);this.consumeAttributeSpace(v),this.extract(v,this.consume,"typ"),this.consumeAttributeSpace(v);const br={foundation:L,componentId:W,transport:Ee,priority:pt,connectionAddress:us,port:vn,type:this.extract(v,this.consumeToken),extension:{}};for(this.peek(v," raddr")&&(this.extract(v,this.consume," raddr"),this.consumeAttributeSpace(v),br.relAddr=this.extract(v,this.consumeAddress)),this.peek(v," rport")&&(this.extract(v,this.consume," rport"),this.consumeAttributeSpace(v),br.relPort=this.extract(v,this.consumePort));this.peekChar(v)===l;){this.consumeAttributeSpace(v);const nc=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v),br.extension[nc]=this.extractOneOrMore(v,p)}this.attributes.candidates.push(br)}parseRemoteCandidate(v){const L=[];for(;;){const W=this.extractOneOrMore(v,h,[1,5]);this.consumeAttributeSpace(v);const Ee=this.extract(v,this.consumeAddress);this.consumeAttributeSpace(v);const pt=this.extract(v,this.consumePort);L.push({componentId:W,connectionAddress:Ee,port:pt});try{this.consumeAttributeSpace(v)}catch{break}}this.attributes.remoteCandidatesList.push(L)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(v){const L=this.extract(v,this.consumeToken);this.consumeAttributeSpace(v);const W=this.extract(v,this.consumeTill,"/");this.extract(v,this.consume,"/");const Ee={encodingName:W,clockRate:this.extractOneOrMore(v,h)};this.atEnd(v)||this.peekChar(v)!=="/"||(this.extract(v,this.consume,"/"),Ee.encodingParameters=parseInt(this.extract(v,this.consumeTill),10));const pt=this.attributes.payloads.find(us=>us.payloadType===parseInt(L,10));pt?pt.rtpMap=Ee:this.attributes.payloads.push({payloadType:parseInt(L,10),rtpMap:Ee,rtcpFeedbacks:[]})}parsePtime(v){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(v,this.consumeTill)}parseMaxPtime(v){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(v,this.consumeTill)}parseDirection(v){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=v.attField}parseSSRC(v){const L=this.extractOneOrMore(v,h);this.consumeAttributeSpace(v);const W=this.extract(v,this.consumeTill,":");let Ee;this.peekChar(v)===":"&&(this.extract(v,this.consume,":"),Ee=this.extract(v,this.consumeTill));const pt=this.attributes.ssrcs.find(us=>us.ssrcId===parseInt(L,10));pt?pt.attributes[W]=Ee:this.attributes.ssrcs.push({ssrcId:parseInt(L,10),attributes:{[W]:Ee}})}parseFmtp(v){const L=this.extract(v,this.consumeTill,l);this.consumeAttributeSpace(v);const W=this.extract(v,this.consumeTill),Ee={};W.split(";").forEach(us=>{let[vn,br]=us.split("=");vn=la(vn).call(vn);const nc=typeof br=="string"?la(br).call(br):null;typeof vn=="string"&&vn.length>0&&(Ee[vn]=nc)});const pt=this.attributes.payloads.find(us=>us.payloadType===parseInt(L,10));pt?pt.fmtp={parameters:Ee}:this.attributes.payloads.push({payloadType:parseInt(L,10),rtcpFeedbacks:[],fmtp:{parameters:Ee}})}parseFmtParameters(v){const L={},W=this.extract(v,this.consumeTill,"=");v._cur++;const Ee=this.extract(v,this.consumeTill,";");for(L[W]=Ee;v.attValue[v._cur]===";";){const pt=this.extract(v,this.consumeTill,"=");v._cur++;const us=this.extract(v,this.consumeTill,";");L[pt]=us}return L}parseRtcpFb(v){let L="";L=this.peekChar(v)==="*"?this.extract(v,this.consume,"*"):this.extract(v,this.consumeTill,l),this.consumeAttributeSpace(v);const W=this.extract(v,this.consumeTill,l);let Ee;if(W==="trr-int")Ee={type:W,interval:this.extract(v,this.consumeTill)};else{const pt={type:W};this.peekChar(v)===l&&(this.consumeAttributeSpace(v),pt.parameter=this.extract(v,this.consumeToken),this.peekChar(v)===l&&(pt.additional=this.extract(v,this.consumeTill))),Ee=pt}if(L==="*")this.attributes.rtcpFeedbackWildcards.push(Ee);else{const pt=this.attributes.payloads.find(us=>us.payloadType===parseInt(L,10));pt?pt.rtcpFeedbacks.push(Ee):this.attributes.payloads.push({payloadType:parseInt(L,10),rtcpFeedbacks:[Ee]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(v){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const L={port:this.extract(v,this.consumePort)};this.peekChar(v)===l&&(this.consumeAttributeSpace(v),L.netType=this.extractOneOrMore(v,g),this.consumeAttributeSpace(v),L.addressType=this.extractOneOrMore(v,g),this.consumeAttributeSpace(v),L.address=this.extract(v,this.consumeAddress)),this.attributes.rtcp=L}parseMsid(v){const L={id:this.extractOneOrMore(v,g,[1,64])};this.peekChar(v)===l&&(this.consumeAttributeSpace(v),L.appdata=this.extractOneOrMore(v,g,[1,64])),this.attributes.msids.push(L)}parseImageAttr(v){this.attributes.imageattr.push(v.attValue)}parseRid(v){const L=this.extractOneOrMore(v,Ee=>w(Ee)||h(Ee)||Ee==="_"||Ee==="-");this.consumeAttributeSpace(v);const W={id:L,direction:this.extract(v,this.consumeToken),params:[]};if(this.peekChar(v)===l){if(this.consumeAttributeSpace(v),this.peek(v,"pt=")){this.extract(v,this.consume,"pt=");const Ee=[];for(;;){const pt=this.extract(v,this.consumeToken);Ee.push(pt);try{this.extract(v,this.consume,",")}catch{break}}W.payloads=Ee,this.peekChar(v)===l&&this.extract(v,this.consume,l)}for(;;){const Ee=this.extract(v,this.consumeToken);switch(Ee){case"depend":{const pt={type:Ee,rids:this.extract(v,this.consume,"=").split(",")};W.params.push(pt);break}default:{const pt={type:Ee};this.peekChar(v)==="="&&(this.extract(v,this.consume,"="),pt.val=this.extract(v,this.consumeTill,";")),W.params.push(pt)}}try{this.extract(v,this.consume,";")}catch{break}}}this.attributes.rids.push(W)}parseSimulcast(v){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=v.attValue,this.extract(v,this.consumeTill)}parseSctpPort(v){this.attributes.sctpPort=this.extractOneOrMore(v,h,[1,5])}parseMaxMessageSize(v){this.attributes.maxMessageSize=this.extractOneOrMore(v,h,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(v){this.attributes.mid=this.extract(v,this.consumeToken)}parseSSRCGroup(v){const L=this.extract(v,this.consumeToken),W=[];for(;;)try{this.consumeAttributeSpace(v);const Ee=this.extract(v,this.consumeInteger);W.push(parseInt(Ee,10))}catch{break}this.attributes.ssrcGroups.push({semantic:L,ssrcIds:W})}}function Et(me,v,L){return v in me?Object.defineProperty(me,v,{value:L,enumerable:!0,configurable:!0,writable:!0}):me[v]=L,me}class xt{constructor(){Et(this,"eol",c)}print(v,L){let W="";return L&&(this.eol=L),W+=this.printVersion(v.version),W+=this.printOrigin(v.origin),W+=this.printSessionName(v.sessionName),W+=this.printInformation(v.information),W+=this.printUri(v.uri),W+=this.printEmail(v.emails),W+=this.printPhone(v.phones),W+=this.printConnection(v.connection),W+=this.printBandwidth(v.bandwidths),W+=this.printTimeFields(v.timeFields),W+=this.printKey(v.key),W+=this.printSessionAttributes(v.attributes),W+=this.printMediaDescription(v.mediaDescriptions),W}printVersion(v){return"v=".concat(v).concat(this.eol)}printOrigin(v){return"o=".concat(v.username," ").concat(v.sessId," ").concat(v.sessVersion," ").concat(v.nettype," ").concat(v.addrtype," ").concat(v.unicastAddress).concat(this.eol)}printSessionName(v){return v?"s=".concat(v).concat(this.eol):""}printInformation(v){return v?"i=".concat(v).concat(this.eol):""}printUri(v){return v?"u=".concat(v).concat(this.eol):""}printEmail(v){let L="";for(const W of v)L+="e=".concat(W).concat(this.eol);return L}printPhone(v){let L="";for(const W of v)L+="e=".concat(W).concat(this.eol);return L}printConnection(v){return v?"c=".concat(v.nettype," ").concat(v.addrtype," ").concat(v.address).concat(this.eol):""}printBandwidth(v){let L="";for(const W of v)L+="b=".concat(W.bwtype,":").concat(W.bandwidth).concat(this.eol);return L}printTimeFields(v){let L="";for(const W of v){L+="t=".concat(W.time.startTime," ").concat(W.time.startTime).concat(this.eol);for(const Ee of W.repeats)L+="r=".concat(Ee.repeatInterval," ").concat(Ee.typedTimes.join(" ")).concat(this.eol);W.zoneAdjustments&&(L+="z=",L+="z=".concat(W.zoneAdjustments.map(Ee=>"".concat(Ee.time," ").concat(Ee.back?"-":""," ").concat(Ee.typedTime)).join(" ")).concat(this.eol),L+=this.eol)}return L}printKey(v){return v?"k=".concat(v).concat(this.eol):""}printAttributes(v){let L="";for(const W of v)L+="a=".concat(W.attField).concat(W.attValue?":".concat(W.attValue):"").concat(this.eol);return L}printMediaDescription(v){let L="";for(const W of v)L+=this.printMedia(W.media),L+=this.printInformation(W.information),L+=this.printConnections(W.connections),L+=this.printBandwidth(W.bandwidths),L+=this.printKey(W.key),L+=this.printMediaAttributes(W);return L}printConnections(v){let L="";for(const W of v)L+=this.printConnection(W);return L}printMedia(v){return"m=".concat(v.mediaType," ").concat(v.port," ").concat(v.protos.join("/")," ").concat(v.fmts.join(" ")).concat(this.eol)}printSessionAttributes(v){return new Rs(this.eol).print(v)}printMediaAttributes(v){return new de(this.eol).print(v)}}class Ht{constructor(v){Et(this,"eol",void 0),this.eol=v}printIceUfrag(v){return v===void 0?"":"a=ice-ufrag:".concat(v).concat(this.eol)}printIcePwd(v){return v===void 0?"":"a=ice-pwd:".concat(v).concat(this.eol)}printIceOptions(v){return v===void 0?"":"a=ice-options:".concat(v.join(l)).concat(this.eol)}printFingerprints(v){return v.length>0?v.map(L=>"a=fingerprint:".concat(L.hashFunction).concat(l).concat(L.fingerprint)).join(this.eol)+this.eol:""}printExtmap(v){return v.map(L=>"a=extmap:".concat(L.entry).concat(L.direction?"/".concat(L.direction):"").concat(l).concat(L.extensionName).concat(L.extensionAttributes?"".concat(l).concat(L.extensionAttributes):"").concat(this.eol)).join("")}printSetup(v){return v===void 0?"":"a=setup:".concat(v).concat(this.eol)}printUnrecognized(v){return v.map(L=>"a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol)).join("")}}class Rs extends Ht{print(v){let L="";return L+=this.printGroups(v.groups),L+=this.printMsidSemantic(v.msidSemantic),L+=this.printIceLite(v.iceLite),L+=this.printIceUfrag(v.iceUfrag),L+=this.printIcePwd(v.icePwd),L+=this.printIceOptions(v.iceOptions),L+=this.printFingerprints(v.fingerprints),L+=this.printSetup(v.setup),L+=this.printTlsId(v.tlsId),L+=this.printIdentity(v.identities),L+=this.printExtmap(v.extmaps),L+=this.printUnrecognized(v.unrecognized),L}printGroups(v){let L="";return v.length>0&&(L+=v.map(W=>"a=group:".concat(W.semantic).concat(W.identificationTag.map(Ee=>"".concat(l).concat(Ee)).join("")).concat(this.eol)).join("")),L}printIceLite(v){return v===void 0?"":"a=ice-lite"+this.eol}printTlsId(v){return v?"a=tls-id:".concat(v).concat(this.eol):""}printIdentity(v){return v.length===0?"":v.map(L=>"a=identity:".concat(L.assertionValue).concat(L.extensions.map(W=>"".concat(l).concat(W.name).concat(W.value?"=".concat(W.value):"")))).join(this.eol)+this.eol}printMsidSemantic(v){if(!v)return"";let L="a=msid-semantic:".concat(v.semantic);return v.applyForAll?L+="".concat(l,"*"):v.identifierList.length>0&&(L+=v.identifierList.map(W=>"".concat(l).concat(W))),L+this.eol}}class de extends Ht{print(v){const L=v.attributes;let W="";return W+=this.printRTCP(L.rtcp),W+=this.printIceUfrag(L.iceUfrag),W+=this.printIcePwd(L.icePwd),W+=this.printIceOptions(L.iceOptions),W+=this.printCandidates(L.candidates),W+=this.printRemoteCandidatesList(L.remoteCandidatesList),W+=this.printEndOfCandidates(L.endOfCandidates),W+=this.printFingerprints(L.fingerprints),W+=this.printSetup(L.setup),W+=this.printMid(L.mid),W+=this.printExtmap(L.extmaps),W+=this.printRTPRelated(L),W+=this.printPtime(L.ptime),W+=this.printMaxPtime(L.maxPtime),W+=this.printDirection(L.direction),W+=this.printSSRCGroups(L.ssrcGroups),W+=this.printSSRC(L.ssrcs),W+=this.printRTCPMux(L.rtcpMux),W+=this.printRTCPMuxOnly(L.rtcpMuxOnly),W+=this.printRTCPRsize(L.rtcpRsize),W+=this.printMSId(L.msids),W+=this.printImageattr(L.imageattr),W+=this.printRid(L.rids),W+=this.printSimulcast(L.simulcast),W+=this.printSCTPPort(L.sctpPort),W+=this.printMaxMessageSize(L.maxMessageSize),W+=this.printUnrecognized(L.unrecognized),W}printCandidates(v){return v.map(L=>"a=candidate:".concat(L.foundation).concat(l).concat(L.componentId).concat(l).concat(L.transport).concat(l).concat(L.priority).concat(l).concat(L.connectionAddress).concat(l).concat(L.port).concat(l,"typ").concat(l).concat(L.type).concat(L.relAddr?"".concat(l,"raddr").concat(l).concat(L.relAddr):"").concat(L.relPort?"".concat(l,"rport").concat(l).concat(L.relPort):"").concat(Object.keys(L.extension).map(W=>"".concat(l).concat(W).concat(l).concat(L.extension[W])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(v){return v.map(L=>"a=remote-candidates:".concat(L.join(l)).concat(this.eol)).join("")}printEndOfCandidates(v){return v===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(v){if(!v.payloads)return"";const L=v.payloads;let W="";W+=v.rtcpFeedbackWildcards.map(Ee=>this.printRTCPFeedback("*",Ee)).join("");for(const Ee of L)W+=this.printRtpMap(Ee.payloadType,Ee.rtpMap),W+=this.printFmtp(Ee.payloadType,Ee.fmtp),W+=Ee.rtcpFeedbacks.map(pt=>this.printRTCPFeedback(Ee.payloadType,pt)).join("");return W}printFmtp(v,L){if(!L)return"";const W=Object.keys(L.parameters);return W.length===1&&L.parameters[W[0]]===null?"a=fmtp:".concat(v).concat(l).concat(W[0]).concat(this.eol):"a=fmtp:".concat(v).concat(l).concat(Object.keys(L.parameters).map(Ee=>"".concat(Ee,"=").concat(L.parameters[Ee])).join(";")).concat(this.eol)}printRtpMap(v,L){return L?"a=rtpmap:".concat(v).concat(l).concat(L.encodingName,"/").concat(L.clockRate).concat(L.encodingParameters?"/".concat(L.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(v,L){let W="a=rtcp-fb:".concat(v).concat(l),Ee=L;return Ee.type==="trr-int"?W+="ttr-int".concat(l).concat(Ee.interval):(W+="".concat(Ee.type),Ee.parameter&&(W+="".concat(l).concat(Ee.parameter),Ee.additional&&(W+="".concat(l).concat(Ee.additional)))),W+this.eol}printPtime(v){return v===void 0?"":"a=ptime:".concat(v).concat(this.eol)}printMaxPtime(v){return v===void 0?"":"a=maxptime:".concat(v).concat(this.eol)}printDirection(v){return v===void 0?"":"a=".concat(v).concat(this.eol)}printSSRC(v){return v.map(L=>Object.keys(L.attributes).map(W=>"a=ssrc:".concat(L.ssrcId.toString(10)).concat(l).concat(W).concat(L.attributes[W]?":".concat(L.attributes[W]):"").concat(this.eol)).join("")).join("")}printRTCPMux(v){return v===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(v){return v===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(v){return v===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(v){if(v===void 0)return"";let L="a=rtcp:".concat(v.port);return v.netType&&(L+="".concat(l).concat(v.netType)),v.addressType&&(L+="".concat(l).concat(v.addressType)),v.address&&(L+="".concat(l).concat(v.address)),L+this.eol}printMSId(v){return v.map(L=>"a=msid:".concat(L.id).concat(L.appdata?"".concat(l).concat(L.appdata):"").concat(this.eol)).join("")}printImageattr(v){return v.map(L=>"a=imageattr:".concat(L).concat(this.eol)).join("")}printRid(v){return v.map(L=>{let W="a=rid:".concat(L.id).concat(l).concat(L.direction);return L.payloads&&(W+="".concat(l,"pt=").concat(L.payloads.join(","))),L.params.length>0&&(W+="".concat(l).concat(L.params.map(Ee=>Ee.type==="depend"?"depend=".concat(Ee.rids.join(",")):"".concat(Ee.type,"=").concat(Ee.val)).join(";"))),W+this.eol}).join("")}printSimulcast(v){return v===void 0?"":"a=simulcast:".concat(v).concat(this.eol)}printSCTPPort(v){return v===void 0?"":"a=sctp-port:".concat(v).concat(this.eol)}printMaxMessageSize(v){return v===void 0?"":"a=max-message-size:".concat(v).concat(this.eol)}printMid(v){return v===void 0?"":"a=mid:".concat(v).concat(this.eol)}printSSRCGroups(v){return v.map(L=>"a=ssrc-group:".concat(L.semantic).concat(L.ssrcIds.map(W=>"".concat(l).concat(W.toString(10))).join("")).concat(this.eol)).join("")}}function Se(me){return new xe().parse(me)}function Me(me,v){return new xt().print(me,v)}}},t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={exports:{}};return e[n](r,r.exports,s),r.exports}return s.d=(n,r)=>{for(var i in r)s.o(r,i)&&!s.o(n,i)&&Object.defineProperty(n,i,{enumerable:!0,get:r[i]})},s.o=(n,r)=>Object.prototype.hasOwnProperty.call(n,r),s.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},s(8)})();function ha(e){return LI.parse(e)}function ao(e,t){return LI.print(e,t)}var kz=ir("Array","keys"),jz=Io,Pz=Yn,Lz=X,Mz=kz,$b=Array.prototype,Uz={DOMTokenList:!0,NodeList:!0},Vz=function(e){var t=e.keys;return e===$b||Lz($b,e)&&t===$b.keys||Pz(Uz,jz(e))?Mz:t},Jn=E(Vz);function Ls(e,t,s){return(t=function(n){var r=function(i,o){if(typeof i!="object"||!i)return i;var c=i[Symbol.toPrimitive];if(c!==void 0){var l=c.call(i,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(i)}(n);return typeof r=="symbol"?r:r+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function MI(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function vt(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?MI(Object(s),!0).forEach(function(n){Ls(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):MI(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}function Tm(e,t){return Tm=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,n){return s.__proto__=n,s},Tm(e,t)}function Qb(){Qb=function(r,i){return new s(r,void 0,i)};var e=RegExp.prototype,t=new WeakMap;function s(r,i,o){var c=RegExp(r,i);return t.set(c,o||t.get(r)),Tm(c,s.prototype)}function n(r,i){var o,c=t.get(i);return or(o=Object.keys(c)).call(o,function(l,d){var h=c[d];if(typeof h=="number")l[d]=r[h];else{for(var p=0;r[h[p]]===void 0&&p+1<h.length;)p++;l[d]=r[h[p]]}return l},Object.create(null))}return function(r,i){if(typeof i!="function"&&i!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(i&&i.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),i&&Tm(r,i)}(s,RegExp),s.prototype.exec=function(r){var i=e.exec.call(this,r);if(i){i.groups=n(i,this);var o=i.indices;o&&(o.groups=n(o,this))}return i},s.prototype[Symbol.replace]=function(r,i){if(typeof i=="string"){var o=t.get(this);return e[Symbol.replace].call(this,r,i.replace(/\$<([^>]+)(>|$)/g,function(l,d,h){if(h==="")return l;var p=o[d];return Array.isArray(p)?"$"+p.join("$"):typeof p=="number"?"$"+p:""}))}if(typeof i=="function"){var c=this;return e[Symbol.replace].call(this,r,function(){var l=arguments;return typeof l[l.length-1]!="object"&&(l=[].slice.call(l)).push(n(l,c)),i.apply(this,l)})}return e[Symbol.replace].call(this,r,i)},Qb.apply(this,arguments)}const UI=new class extends Cs{constructor(){super(...arguments),Ls(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class Fz{constructor(t){Ls(this,"logger",void 0),Ls(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];this.logger.debug(...this.prefixLists,...s)}info(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];this.logger.info(...this.prefixLists,...s)}warning(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];this.logger.warning(...this.prefixLists,...s)}error(){for(var t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];this.logger.error(...this.prefixLists,...s)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function Zb(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function VI(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const dr={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Rm=Date.now(),Gu=e=>{for(const t in dr)if(Object.prototype.hasOwnProperty.call(dr,t)&&dr[t]===e)return t;return"DEFAULT"},b=new class{constructor(){Ls(this,"proxyServerURL",void 0),Ls(this,"logLevel",dr.DEBUG),Ls(this,"uploadState","collecting"),Ls(this,"uploadLogWaitingList",[]),Ls(this,"uploadLogUploadingList",[]),Ls(this,"uploadErrorCount",0),Ls(this,"currentLogID",0),Ls(this,"url",void 0),Ls(this,"extLog",(e,t)=>{this.appendLogToWaitingList(e,...t)})}debug(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=[dr.DEBUG].concat(t);this.log.apply(this,n)}info(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=[dr.INFO].concat(t);this.log.apply(this,n)}warning(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=[dr.WARNING].concat(t);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=[dr.ERROR].concat(t);this.log.apply(this,n)}upload(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];const n=[dr.DEBUG].concat(t);this.uploadLog.apply(this,n)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){ss("UPLOAD_LOG",!0)}disableLogUpload(){ss("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new Fz(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(Date.now()-Rm<100)return void setTimeout(()=>{this.log(...t)},Date.now()-Rm);const n=Math.max(0,Math.min(4,t[0]));if(t[0]=Zb()+" Agora-SDK [".concat(Gu(n),"]:"),this.appendLogToWaitingList(n,...t),n<this.logLevel)return;const r=Zb()+" %cAgora-SDK [".concat(Gu(n),"]:");let i=[];if(!C("USE_NEW_LOG"))switch(n){case dr.DEBUG:i=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,i);break;case dr.INFO:i=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,i);break;case dr.WARNING:i=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,i);break;case dr.ERROR:i=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,i)}}uploadLog(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(Date.now()-Rm<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-Rm);const n=Math.max(0,Math.min(4,t[0]));t[0]=Zb()+" Agora-SDK [".concat(Gu(n),"]:"),this.appendLogToWaitingList(n,...t)}appendLogToWaitingList(e){if(!C("UPLOAD_LOG"))return;for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];Array.isArray(s[0])?s[0][0]=VI()+" Agora-SDK [".concat(Gu(e),"]:"):s[0]=VI()+" Agora-SDK [".concat(Gu(e),"]:");let r="";s.forEach(i=>{typeof i=="object"&&(i=JSON.stringify(i)),r+="".concat(i," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:lr,process_id:C("PROCESS_ID"),payload:JSON.stringify(e)};return ni(async()=>{const s=await ba.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(C("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(C("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(s.data!=="OK"){const n=new Error("unexpected upload log response");throw n.response=s,n}},()=>(this.uploadLogUploadingList=[],!1),s=>{const n={status:-1,message:s.message,errorRange:e.map(r=>r.log_item_id)};return s.response?(n.status=s.response.status,n.data=s.response.data,n.headers=s.response.headers):s.request&&(n.status=s.request.status),UI.reportLogUploadError(n),!0},{timeout:C("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:C("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,C("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_INTERVAL"))}).catch(e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var FI;function Bz(e){return An(e.reportId,"params.reportId",0,100,!1),An(e.category,"params.category",0,100,!1),An(e.event,"params.event",0,100,!1),An(e.label,"params.label",0,100,!1),rs(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(FI={}).FREE="free",FI.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});const Gz={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let sn=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.RTE_DETAIL="rte_detail_stats",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e.AB_TEST="ab_test",e}({}),Ts=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e.AB_TEST="io.agora.pb.Wrtc.ABTest",e}({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let Wz=function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e}({});function tt(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,s,n){const r=n.value;if(typeof r=="function"){const i=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);n.value=function(){for(var o,c=arguments.length,l=new Array(c),d=0;d<c;d++)l[d]=arguments[d];let h=l;if(e.argsMap)try{h=e.argsMap(this,...l)}catch(m){b.warning(m),h=[]}try{JSON.stringify(h)}catch{b.warning("arguments for method ".concat(i,".").concat(String(s)," not serializable for apiInvoke.")),h=[]}const p=(e.report||Ue).reportApiInvoke(this._sessionId||null,{id:this._clientId||((o=this.store)===null||o===void 0?void 0:o.clientId)||this._ID,name:"".concat(i,".").concat(String(s)),options:h,tag:is.TRACER,reportResult:e.reportResult},e.throttleTime);try{const m=r.apply(this,l);return m instanceof Te?m.then(g=>(p.onSuccess(e.reportResult&&g),g)).catch(g=>{throw p.onError(g),g}):(p.onSuccess(e.reportResult&&m),m)}catch(m){throw p.onError(m),m}}}return n}}const Ue=new class{constructor(){Ls(this,"baseInfoMap",new Map),Ls(this,"proxyServer",void 0),Ls(this,"eventUploadTimer",void 0),Ls(this,"setSessionIdTimer",void 0),Ls(this,"url",void 0),Ls(this,"sids",new Set),Ls(this,"backupUrl",void 0),Ls(this,"_appId",void 0),Ls(this,"_aid",0),Ls(this,"keyEventUploadPendingItems",[]),Ls(this,"normalEventUploadPendingItems",[]),Ls(this,"apiInvokeUploadPendingItems",[]),Ls(this,"apiInvokeCount",0),Ls(this,"apiInvokeLoggedCount",0),Ls(this,"ltsList",[]),Ls(this,"lastSendNormalEventTime",Date.now()),Ls(this,"customReportCounterTimer",void 0),Ls(this,"customReportCount",0),Ls(this,"extApiInvoke",async e=>{for(const t of e){const s=vt(vt({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:is.TRACER});this.sendApiInvoke(s)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),C("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),C("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}setAppId(e){this._appId=e,this._aid=parseInt(e.replace(/[a-fA-F0-9]{8}/g,t=>{let[s,n]=t;return s+n}),16)||0}reportApiInvoke(e,t,s){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;const n=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,i=!!C("SHOW_REPORT_INVOKER_LOG"),o=!!C("SHOW_REPORT_USER_INVOKER_LOG"),c=i||o&&t.id;c&&(this.apiInvokeLoggedCount+=1);const l=this.apiInvokeLoggedCount;function d(g,T){if(c){let w="[apiInvoke-".concat(l,"]");if(t.id&&(w+="[".concat(t.id,"]")),t.name&&(w+="[".concat(t.name,"]"),t.name===Ns.JOIN))return b.info("".concat(w," ").concat(g));b.info("".concat(w," ").concat(g),g==="start"?t.options:T||"")}}const h=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:n,options:t.options,states:t.states||null});d("start");let p=!1;gn(t.timeout).then(()=>{p||(this.sendApiInvoke(vt(vt({},h()),{},{error:A.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});const m=new se(A.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:g=>{const T=()=>{if(p)throw m;return p=!0,this.sendApiInvoke(vt(vt({},h()),{},{success:!0},t.reportResult&&{result:g})),d("onSuccess"),g};return s?vI(T,t.name+"Success",s,()=>p=!0):T()},onError:g=>{const T=()=>{if(p)throw g;p=!0,this.sendApiInvoke(vt(vt({},h()),{},{success:!1,error:g})),d("onFailure",g.toString())};return s?vI(T,t.name+"Error",s,()=>p=!0):T()}}}_send(e,t,s){this.send({type:e,data:t},s)}_sendApiInvoke(e){return this.sendApiInvoke(e)}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const s=Date.now(),n=this.createBaseInfo(e,s);n.cname=t.cname,n.rteUrl=t.rteUrl;const r=Object.assign({},{willUploadConsoleLog:C("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Yb?"global":"oversea",areas:C("AREAS")&&C("AREAS").join(",")},t.extend),{stringUid:i,channelProfile:o,channelMode:c,isABTestSuccess:l,lsid:d,clientRole:h}=t,p=Date.now(),m=vt(vt({},n),{},{eventType:sn.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:Xb,lts:p,elapse:p-s,extend:JSON.stringify(r),mode:t.mode,process:C("PROCESS_ID"),appType:C("APP_TYPE"),success:!0,version:lr,stringUid:i,channelProfile:o,channelMode:c,isABTestSuccess:l,lsid:d,clientType:_e(g=window.navigator.userAgent).call(g,"AgoraWebView")?42:20,clientRole:h,serviceId:C("PROCESS_ID"),extensionID:C("PLUGIN_INFO").join(",")||"",rteUrl:t.rteUrl,rteSid:t.rteSid});var g;this.send({type:Ts.SESSION,data:m},!0)}reportRteDetail(e){const t=this.baseInfoMap.get(e);if(!t)return;const s=t.info,n=Date.now(),r=vt(vt({},s),{},{eventType:sn.RTE_DETAIL,lts:n,success:!0,elapse:n-t.startTime,vid:s.vid===void 0?0:Number(s.vid),ua:navigator.userAgent});this.send({type:Ts.RTE_DETAIL,data:r},!0)}joinChooseServer(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info;t.vid&&(n.vid=t.vid);const r=Date.now(),i=vt(vt({},n),{},{role:t.role,eventType:sn.JOIN_CHOOSE_SERVER,lts:r,eventElapse:t.elapse||r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-s.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3,corssRegionTagReq:t.corssRegionTagReq||void 0,corssRegionTagRes:t.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:t.resourceTimingInfo||void 0});this.send({type:Ts.JOIN_CHOOSE_SERVER,data:i},!0)}reqUserAccount(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{eventType:sn.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||r-s.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Ts.REQ_USER_ACCOUNT,data:i},!0)}joinGateway(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info;t.vid&&(n.vid=t.vid),n.uid=t.uid,n.cid=t.cid;const r=Date.now(),{firstSuccess:i,addr:o,isProxy:c}=t,l=r-s.startTime,d=vt(vt({},n),{},{eventType:sn.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,errorMsg:t.errorMsg||"",elapse:l,eventElapse:r-t.lts,firstSuccess:i,signalChannel:t.signalChannel,preload:t.preload?1:0,installId:Kb(),isABTestSuccess:t.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:c?1:0}),h=d.success?1:0;if(t.succ&&(s.lastJoinSuccessTime=r),o)if(d.signalChannel==="1"){const p=Qb(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),m=o.match(p);d.gatewayIp=m&&m.groups?m.groups.ip:"",d.gatewayPort=m&&m.groups?m.groups.port:""}else if(c){const p=o.match(/h=(\d{1,3}-){3}\d{1,3}/g),m=o.match(/p=[0-9]{1,6}/g);d.gatewayIp=p&&p.length?p[0].split("=")[1].replace(/-/g,"."):"",d.gatewayPort=m&&m.length?m[0].split("=")[1]:""}else{const p=o.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),m=o.match(/(:|p=)[0-9]{1,6}/g);d.gatewayIp=p&&p.length?p[0].split("//")[1].replace(/-/g,"."):"",d.gatewayPort=m&&m.length?m[0].split(/:|p=/g)[1]:""}if(i)this.send({type:Ts.JOIN_GATEWAY,data:d},!0);else{let p={isSuccess:h,port:d.gatewayPort};delete d.success,delete d.eventType,delete d.firstSuccess,delete d.gatewayPort,d.vid=Number(d.vid);const m=Object.assign({},d,p,{eventType:sn.REJOIN_GATEWAY});this.send({type:Ts.RE_JOIN_GATEWAY,data:m},!0)}}joinChannelTimeout(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=Date.now(),r=vt(vt({},s.info),{},{lts:n,timeout:t,elapse:n-s.startTime});this.send({type:Ts.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{eventType:sn.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-s.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Ts.PUBLISH,data:i},!0)}subscribe(e,t,s){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=vt(vt({},r),{},{eventType:sn.SUBSCRIBE,lts:i,eventElapse:t.eventElapse,elapse:i-n.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid,preSsrc:t.preSsrc?1:0},s&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?o.peerSuid=t.peerid:o.peer=t.peerid,this.send({type:Ts.SUBSCRIBE,data:o},!0)}wsCompressorInit(e){var t;const s=[...Jn(t=this.baseInfoMap).call(t)],n=s.length?s[0]:"UnableToGetSid",r=this.baseInfoMap.get(n);if(!r)return;const i=r.info,o=Date.now(),c=vt(vt({},i),{},{eventType:sn.WS_COMPRESSOR_INIT,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,status:e.status?1:2});this.send({type:Ts.WS_COMPRESSOR_INIT,data:c},!0)}firstXLAPeerFirstVideoFrame(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=t.peerPubStatusMs-(s.lastJoinSuccessTime||r),o=vt(vt({},n),{},{elapse:r-s.startTime,eventType:sn.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:t.peer,width:t.width,height:t.height,ssrc:t.ssrc,p2pid:t.p2pid,peerPublishDuration:t.peerPublishDuration,joinChannelSuccessElapse:i,peerPubStatusMs:t.peerPubStatusMs-t.joinChannelStart,availablePublish:t.peerPublishDuration>i?1:0,preloadStart:Math.max(t.preloadStart-t.joinChannelStart,0),preloadEnd:Math.max(t.preloadEnd-t.joinChannelStart,0),encrypt:Math.max(t.apStart-t.joinChannelStart,0),ap:Math.max(t.apEnd-t.joinChannelStart,0),sua:Math.max(t.suaEnd-t.joinChannelStart,0),beforeConnect:Math.max(t.beforeConnect-t.joinChannelStart,0),peerRecevier:Math.max(t.peerReceiver-t.joinChannelStart,0),ice:Math.max(t.ice-t.joinChannelStart,0),pc:Math.max(t.pc-t.joinChannelStart,0),signalConnected:Math.max(t.signalConnected-t.joinChannelStart,0),joinReq:Math.max(t.joinReq-t.joinChannelStart,0),joinRes:Math.max(t.joinRes-t.joinChannelStart,0),userJoinNotify:Math.max(t.userJoinNotify-t.joinChannelStart,0),videoSsrcNotify:Math.max(t.videoAddNotify-t.joinChannelStart,0),subscribeDelayMs:Math.max(t.subscribeStart-t.videoAddNotify,0),subscribeStart:Math.max(t.subscribeStart-t.joinChannelStart,0),subscribeEnd:Math.max(t.subscribeEnd-t.joinChannelStart,0),firstReceived:Math.max(t.firstReceived-t.joinChannelStart,0),firstDecoded:Math.max(t.firstDecoded-t.joinChannelStart,0),firstPreRender:Math.max(t.firstPreRender-t.joinChannelStart,0),firstRender:Math.max(t.firstRender-t.joinChannelStart,0),playDelayMs:Math.max(t.playStart-t.subscribeEnd,0),playStart:Math.max(t.playStart-t.joinChannelStart,0),playEnd:Math.max(t.playEnd-t.joinChannelStart,0),isPreSub:t.isPreSub?1:0,isPrePc:t.isPrePc?1:0,isPreInstantVideo:t.isPreInstantVideo?1:0,firstReceivedEncodedFrame:t.firstReceivedEncodedFrame?Math.max(t.firstReceivedEncodedFrame-t.joinChannelStart,0):void 0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""});this.send({type:Ts.XLA_PEER_FIRST_VIDEO_FRAME,data:o},!0)}firstRemoteVideoDecode(e,t,s,n){const r=this.baseInfoMap.get(e);if(!r)return;const i=r.info,o=Date.now(),c=vt(vt(vt({},i),n),{},{elapse:o-r.startTime,eventType:t,lts:o,firstDecodeFrame:Math.max((n.firstFrame||o)-r.startTime,0),apEnd:Math.max(n.apEnd-r.startTime,0),apStart:Math.max(n.apStart-r.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-r.startTime,0),joinGwStart:Math.max(n.joinGwStart-r.startTime,0),pcEnd:Math.max(n.pcEnd-r.startTime,0),pcStart:Math.max(n.pcStart-r.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-r.startTime,0),subscriberStart:Math.max(n.subscriberStart-r.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-r.startTime,0)});this.send({type:s,data:c},!0)}firstRemoteFrame(e,t,s,n){const r=this.baseInfoMap.get(e);if(!r)return;const i=r.info,o=Date.now(),c=vt(vt(vt({},i),n),{},{elapse:o-r.startTime,eventType:t,lts:o});this.send({type:s,data:c},!0)}abTest(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-s.startTime,eventType:sn.AB_TEST,lts:r});this.send({type:Ts.AB_TEST,data:i},!0)}pcStats(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-s.startTime,eventType:sn.PC_STATS,lts:r,preallocation:t.preallocation?1:0});this.send({type:Ts.PC_STATS,data:i},!0)}updateRemoteRTPCapabilities(e,t){if(e){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{vid:n.vid===void 0?0:Number(n.vid),eventType:sn.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Ts.UPDATE_REMOTE_RTPCAPABILITIES,data:i},!0)}}onGatewayStream(e,t,s,n){const r=this.baseInfoMap.get(e);if(!r)return;const i=r.info,o=Date.now(),c=vt(vt(vt({},i),n),{},{eventType:t,lts:o});this.send({type:s,data:c},!0)}streamSwitch(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{eventType:sn.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-s.startTime,success:t.succ});this.send({type:Ts.STREAM_SWITCH,data:i},!0)}requestProxyAppCenter(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{eventType:sn.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-s.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Ts.REQUEST_PROXY_APPCENTER,data:i},!0)}requestProxyWorkerManager(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{eventType:sn.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-s.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Ts.REQUEST_PROXY_WORKER_MANAGER,data:i},!0)}setProxyServer(e){this.proxyServer=e,e?b.debug("reportProxyServerurl: ".concat(e)):b.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt({},n),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-s.startTime,joinChannelSuccessElapse:r-(s.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Ts.PEER_PUBLISH_STATUS,data:i},!0)}workerEvent(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now();(function(i,o,c){const l=i[o];if(!l||typeof l!="string")return[i];i[o]="";const d=Ii(JSON.stringify(i));let h=0;const p=[];let m=0;for(let g=0;g<l.length;g++)m+=l.charCodeAt(g)<=127?1:3,m<=c-d||(p[p.length]=ye(ye({},i),{},{[o]:l.substring(h,g)}),h=g,m=l.charCodeAt(g)<=127?1:3);return h!==l.length-1&&(p[p.length]=ye(ye({},i),{},{[o]:l.substring(h)})),p})(vt(vt(vt({},n),t),{},{elapse:r-s.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(i=>this.send({type:Ts.WORKER_EVENT,data:i},!0))}apworkerEvent(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{elapse:r-s.startTime,lts:r});this.send({type:Ts.AP_WORKER_EVENT,data:i},!0)}joinWebProxyAP(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{elapse:r-s.startTime,lts:r,extend:t.extend||void 0});this.send({type:Ts.JOIN_WEB_PROXY_AP,data:i},!0)}WebSocketQuit(e,t){const s=this.baseInfoMap.get(e);if(!s)return;const n=s.info,r=Date.now(),i=vt(vt(vt({},n),t),{},{elapse:r-s.startTime,lts:r});this.send({type:Ts.WEBSOCKET_QUIT,data:i},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>C("CUSTOM_REPORT_LIMIT"))throw new se(A.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const s=Date.now(),n=t.map(r=>({type:Ts.USER_ANALYTICS,data:vt(vt({sid:e},r),{},{lts:s})}));try{C("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(r){throw b.error("send custom report message failed",r.toString()),new se(A.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(e){const t=C("NOT_REPORT_EVENT");if(e.tag&&_e(t)&&_e(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const s=this.baseInfoMap.get(e.sid);if(!s)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:n,uid:r,cid:i}=s.info;let o;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof se){const{code:l,message:d}=e.error;o=l||d||e.error.toString()}else o=e.error.toString();const c={invokeId:e.invokeId,sid:e.sid,cname:n,cid:i,uid:r,lts:e.lts,success:e.success,elapse:e.lts-s.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?o:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Ts.API_INVOKE,data:c},!1),!0}addSid(e){this.sids.add(e)}removeSid(e){this.sids.delete(e)}appendSessionId(){const e=this.apiInvokeUploadPendingItems;if(e.length===0)return;const t=Array.from(this.sids).find(s=>s!==null);t&&e.forEach(s=>{s&&(s.sid=t,this.sendApiInvoke(Object.assign({},s)))}),e.length=0}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const s=[],n=[];for(;e.length;){const i=e.shift();s.length<20?s.push(i):n.push(i)}e.push(...n);for(const i of[...s]){var r;this.ltsList.indexOf(i.data.lts)!==-1?(i.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(i.data.lts)):(this.ltsList.push(i.data.lts),bc(r=this.ltsList).call(r,(o,c)=>o-c))}return t||(this.lastSendNormalEventTime=Date.now()),C("ENABLE_EVENT_REPORT")&&s.length&&(C("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(s):this.postDataToStatsCollector(s)).catch((i=>o=>{C("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(i):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(i),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-C("NORMAL_EVENT_QUEUE_CAPACITY")),b.warning("report: drop normal events"))))})(s)),e}async postDataToStatsCollector2(e){Ps.networkState===ua.OFFLINE&&await Te.race([Ps.onlineWaiter,gn(2*Ys.maxRetryTimeout)]);const t=r=>{let i=new Uint8Array;return r.forEach(o=>{const c=Db(JSON.stringify(o.data)),l=new ArrayBuffer(5),d=(p=>{let m=0;return Object.entries(Ts).forEach(g=>{let[T,w]=g;w===p.type&&(m=Wz[T])}),m})(o),h=new DataView(l);h.setUint16(0,c.byteLength,!0),h.setUint8(2,255&d),h.setUint8(3,d>>>8&255),h.setUint8(4,d>>>16&255),i=dI(i,new Uint8Array(l)),i=dI(i,c)}),i},s="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(s):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(s);for(let r=0;r<2;r+=1){r===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(s):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(s));try{await Gb(n,{timeout:1e4,data:t(e),headers:vt(vt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(i){if(r===1)throw i;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const s=(c=>{const l=c&&c.data.sid&&this.baseInfoMap.get(c.data.sid);return l&&l.info.vid&&+l.info.vid||0})(e[0]),n=s?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(c=>JSON.stringify(c)),vid:s,aid:n};Ps.networkState===ua.OFFLINE&&await Te.race([Ps.onlineWaiter,gn(2*Ys.maxRetryTimeout)]);const i=t?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(C("EVENT_REPORT_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(i));for(let c=0;c<2;c+=1){c===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(C("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(i)));try{t?await Cz(o,{timeout:1e4,data:r}):await Gb(o,{timeout:1e4,data:r})}catch(l){if(c===1)throw l;continue}return}}createBaseInfo(e,t){const s=Object.assign({},Gz);return s.sid=e,this.baseInfoMap.set(e,{info:s,startTime:t}),s}reportResourceTiming(e,t){const s=performance.getEntriesByName(e),n=s[s.length-1];n&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:n,tag:is.TRACER}).onSuccess()}};UI.on("REPORT_LOG_UPLOAD",e=>{e.networkState=Ps.networkState,Ue.reportApiInvoke(null,{name:"logUploadError",options:e,tag:is.TRACER}).onSuccess("logUploadError")});let $=class extends se{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Ls(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,b)}throw(){super.throw(b)}};const xn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function At(){return xn}function BI(){return"setSinkId"in HTMLAudioElement.prototype&&(!C("RESTRICTION_SET_PLAYBACK_DEVICE")||(so()||XC())&&!aI())}function Cm(){return!xn.supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&Ci()}function Wu(e){return!(bs()||JC(87)||Cm()||!C("ENABLE_PRE_SUB")&&(e==null||!e.autoSubscribe||C("FORCE_DISABLE_AUTO_SUB")))}function GI(e){return C("ENABLE_INSTANT_VIDEO")?C("ENABLE_INSTANT_VIDEO"):!(e==null||!e.autoSubscribe||C("FORCE_DISABLE_AUTO_SUB"))}function WI(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function HI(){if(WI()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in e)||!e.suppressLocalAudioPlayback)}return si(141)||Uo(141)||Rc(141)}function zI(){if(WI()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in e)||!e.restrictOwnAudio)}return si(141)||Uo(141)||Rc(125)}let On=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function ad(e,t,s){return{sampleRate:e,stereo:t,bitrate:s}}function Bt(e,t,s,n,r){return{width:e,height:t,frameRate:s,bitrateMin:n,bitrateMax:r}}function jr(e,t,s,n,r){return{width:{max:e},height:{max:t},frameRate:s,bitrateMin:n,bitrateMax:r}}function e_(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const Hz={"90p":Bt(160,90),"90p_1":Bt(160,90),"120p":Bt(160,120,15,30,65),"120p_1":Bt(160,120,15,30,65),"120p_3":Bt(120,120,15,30,50),"120p_4":Bt(212,120),"180p":Bt(320,180,15,30,140),"180p_1":Bt(320,180,15,30,140),"180p_3":Bt(180,180,15,30,100),"180p_4":Bt(240,180,15,30,120),"240p":Bt(320,240,15,40,200),"240p_1":Bt(320,240,15,40,200),"240p_3":Bt(240,240,15,40,140),"240p_4":Bt(424,240,15,40,220),"360p":Bt(640,360,15,80,400),"360p_1":Bt(640,360,15,80,400),"360p_3":Bt(360,360,15,80,260),"360p_4":Bt(640,360,30,80,600),"360p_6":Bt(360,360,30,80,400),"360p_7":Bt(480,360,15,80,320),"360p_8":Bt(480,360,30,80,490),"360p_9":Bt(640,360,15,80,800),"360p_10":Bt(640,360,24,80,800),"360p_11":Bt(640,360,24,80,1e3),"480p":Bt(640,480,15,100,500),"480p_1":Bt(640,480,15,100,500),"480p_2":Bt(640,480,30,100,1e3),"480p_3":Bt(480,480,15,100,400),"480p_4":Bt(640,480,30,100,750),"480p_6":Bt(480,480,30,100,600),"480p_8":Bt(848,480,15,100,610),"480p_9":Bt(848,480,30,100,930),"480p_10":Bt(640,480,10,100,400),"720p":Bt(1280,720,15,120,1130),"720p_auto":Bt(1280,720,30,900,3e3),"720p_1":Bt(1280,720,15,120,1130),"720p_2":Bt(1280,720,30,120,2e3),"720p_3":Bt(1280,720,30,120,1710),"720p_5":Bt(960,720,15,120,910),"720p_6":Bt(960,720,30,120,1380),"1080p":Bt(1920,1080,15,120,2080),"1080p_1":Bt(1920,1080,15,120,2080),"1080p_2":Bt(1920,1080,30,120,3e3),"1080p_3":Bt(1920,1080,30,120,3150),"1080p_5":Bt(1920,1080,60,120,4780),"1440p":Bt(2560,1440,30,120,4850),"1440p_1":Bt(2560,1440,30,120,4850),"1440p_2":Bt(2560,1440,60,120,7350),"4k":Bt(3840,2160,30,120,8910),"4k_1":Bt(3840,2160,30,120,8910),"4k_3":Bt(3840,2160,60,120,13500)},zz={"480p":jr(640,480,5),"480p_1":jr(640,480,5),"480p_2":jr(640,480,30),"480p_3":jr(640,480,15),"720p":jr(1280,720,5),"720p_auto":Bt(1280,720,30,900,3e3),"720p_1":jr(1280,720,5),"720p_2":jr(1280,720,30),"720p_3":jr(1280,720,15),"1080p":jr(1920,1080,5),"1080p_1":jr(1920,1080,5),"1080p_2":jr(1920,1080,30),"1080p_3":jr(1920,1080,15)},Kz={"1SL1TL":e_(1,1),"3SL3TL":e_(3,3),"2SL3TL":e_(2,3)};function Pr(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},Hz[e]):e}function t_(e){return typeof e=="string"?Object.assign({},zz[e]):e}function Im(e){return typeof e=="string"?Object.assign({},Kz[e]):e}const Yz={speech_low_quality:ad(16e3,!1),speech_standard:ad(32e3,!1,18),music_standard:ad(48e3,!1),standard_stereo:ad(48e3,!0,56),high_quality:ad(48e3,!1,128),high_quality_stereo:ad(48e3,!0,192)};function Am(e){return typeof e=="string"?Object.assign({},Yz[e]):e}const Lc=[];function KI(e){return Ks(e,"mediaSource",["screen","window","application"]),!0}let Be=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),qt=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e.SCREEN_LOW_TRACK="screen_low_track",e}({}),rd=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),qz=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",e}({}),Xz=function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e[e.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",e}({}),Mc=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),id=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),ur=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e.PLAY_START="play-start",e.PLAY_END="play-end",e.FIRST_FRAME_RENDER="first-frame-render",e}({}),od=function(e){return e.AUDIO="audio",e.VIDEO="video",e.DATA="data",e}({}),Ya=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});const s_={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},n_={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},YI={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Jz={uplinkNetworkQuality:0,downlinkNetworkQuality:0},qI={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let pa=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),qa=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),Hu=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),Uc=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),Gn=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),Ai=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const a_={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Om=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function Lt(e,t,s,n,r){var i,o,c={};return Object.keys(n).forEach(function(l){c[l]=n[l]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=or(i=yy(o=s.slice()).call(o)).call(i,function(l,d){return d(e,t,l)||l},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(Object.defineProperty(e,t,c),null):c}function ee(e,t,s){return(t=function(n){var r=function(i,o){if(typeof i!="object"||!i)return i;var c=i[Symbol.toPrimitive];if(c!==void 0){var l=c.call(i,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(i)}(n);return typeof r=="symbol"?r:r+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function XI(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function ps(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?XI(Object(s),!0).forEach(function(n){ee(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):XI(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class JI extends Cs{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(Mc.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,s){super(),ee(this,"trackMediaType",void 0),ee(this,"_ID",void 0),ee(this,"_rtpTransceiver",void 0),ee(this,"_lowRtpTransceiver",void 0),ee(this,"_hints",[]),ee(this,"_isClosed",!1),ee(this,"_originMediaStreamTrack",void 0),ee(this,"mediaStreamTrack",void 0),ee(this,"_external",{}),this._ID=s||Jt(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,function(n){_e(Lc).call(Lc,n)||Lc.push(n)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||Vo(()=>{var s;Ue.reportApiInvoke(null,{name:Ns.GET_MEDIA_STREAM_TRACK,options:[],tag:is.TRACER}).onSuccess(((s=this._mediaStreamTrack)===null||s===void 0?void 0:s.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===rd.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const s=Lc.indexOf(t);s!==-1&&Lc.splice(s,1)}(this),this.emit(id.CLOSED),this.removeAllListeners(Mc.SEI_RECEIVED)}_updateRtpTransceiver(t,s){if(s===rd.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Mc.TRANSCEIVER_UPDATED,t,s)}}class cd extends JI{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,s){super(t,s),ee(this,"_enabled",!0),ee(this,"_muted",!1),ee(this,"_isExternalTrack",!1),ee(this,"_isClosed",!1),ee(this,"_enabledMutex",void 0),ee(this,"processor",void 0),ee(this,"_processorContext",void 0),ee(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new wn("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,s;return(t=(s=this._originMediaStreamTrack)===null||s===void 0?void 0:s.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,b.debug("[".concat(this.getTrackId(),"] close")),this.emit(Be.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,s){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=n,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),s&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await ls(this,Be.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(id.TRACK_ENDED)}stateCheck(t,s){if(b.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(s,"]")),Or(s,t),this._enabled&&this._muted&&t==="enabled"&&s===!1)throw new se(A.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",b);if(!this._enabled&&!this._muted&&t==="muted"&&s===!0)throw new se(A.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",b)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Te.resolve([])}}const $I=window.AudioContext||window.webkitAudioContext;let r_,Xa=null;const ns=new class extends Cs{constructor(){super(...arguments),ee(this,"prevState",void 0),ee(this,"curState",void 0),ee(this,"currentTime",void 0),ee(this,"currentTimeStuckAt",void 0),ee(this,"interruptDetectorTrack",void 0),ee(this,"onLocalAudioTrackMute",()=>{b.info("ios15-interruption-start"),this.emit(On.IOS_15_16_INTERRUPTION_START)}),ee(this,"onLocalAudioTrackUnmute",async()=>{b.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?b.info("ios15-interruption-end-canceled"):(Xa&&await Xa.suspend(),this.emit(On.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){b.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){b.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function ld(){if(!Xa){if(function(){if(!$I)return void b.error("your browser is not support web audio");b.info("create audio context");const e=ps({},C("WEBAUDIO_INIT_OPTIONS"));b.debug("audio context init option:",JSON.stringify(e)),Xa=new $I(e),ns.curState=Xa.state,Xa.onstatechange=()=>{ns.prevState=ns.curState,ns.curState=Xa?Xa.state:void 0;const{prevState:t,curState:s}=ns,n=s==="running",r=s==="interrupted",i=t==="running",o=t==="suspended",c=t==="interrupted",l=Ft().osVersion;(Xn()||Ar())&&i&&r&&(b.info("ios".concat(l,"-interruption-start")),ns.emit(On.IOS_INTERRUPTION_START)),(Xn()||Ar())&&(o||c)&&n&&(b.info("ios".concat(l,"-interruption-end")),ns.emit(On.IOS_INTERRUPTION_END)),t!==s&&ns.emit(On.STATE_CHANGE,s,t)},setInterval(()=>{var t;const s=(t=Xa)===null||t===void 0?void 0:t.currentTime;ns.currentTime!==s?(ns.currentTimeStuckAt&&(b.debug("AudioContext current time resume at ".concat(s)),ns.currentTimeStuckAt=void 0),ns.currentTime=s):(s!==ns.currentTimeStuckAt&&(Ue.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:s},tag:is.TRACER}).onSuccess(),b.warning("AudioContext current time stuck at ".concat(s))),ns.currentTimeStuckAt=s)},5e3),async function(t){const s=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,r,i=!1,o=!1,c=!1;function l(I){t.state==="running"?d(!1):Xn()||Ar()?t.state==="suspended"&&(d(!0),I&&t.resume().then(h,h)):t.state!=="closed"&&(d(!0),I&&t.resume().then(h,h))}function d(I){if(i!==I){i=I;for(let O=0,M=s;O<M.length;O+=1){const z=M[O];I?window.addEventListener(z,p,{capture:!0,passive:!0}):window.removeEventListener(z,p,{capture:!0,passive:!0})}}}function h(){l(!1)}function p(){l(!0)}function m(){let I;try{I=n.play(),I?I.then(w,w):(n.addEventListener("playing",w),n.addEventListener("abort",w),n.addEventListener("error",w))}catch{w()}}function g(I){c||(n.paused?I?(T(!1),c=!0,m()):T(!0):T(!1))}function T(I){if(o!==I){o=I;for(let O=0,M=s;O<M.length;O++){const z=M[O];I?window.addEventListener(z,S,{capture:!0,passive:!0}):window.removeEventListener(z,S,{capture:!0,passive:!0})}}}function w(){n.removeEventListener("playing",w),n.removeEventListener("abort",w),n.removeEventListener("error",w),c=!1,g(!1)}function S(){g(!0)}if(Xn()&&C("IOS_BG_TAG")){const I=t.createMediaStreamDestination(),O=document.createElement("div");O.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=O.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=I.stream,r=()=>{if(C("IOS_AUTO_RESTART_BG_TAG")&&n&&n.srcObject&&!c&&(!n.paused||o!==!0)){n.paused||n.pause();try{c=!0,m()}catch{c=!1}return!0}},g(!0)}return ns.on(On.STATE_CHANGE,function(){l(!0)}),l(!1),r}(Xa).then(t=>{r_=t})}(),!Xa)throw new se(A.NOT_SUPPORTED,"can not create audio context");return Xa}return Xa}function Vc(e){if(function(){if(i_!==null)return i_;const n=ld(),r=n.createBufferSource(),i=n.createGain(),o=n.createGain();r.connect(i),r.connect(o),r.disconnect(i);let c=!1;try{r.disconnect(i)}catch{c=!0}return r.disconnect(),i_=c,c}())return;const t=e.connect,s=e.disconnect;e.connect=(n,r,i)=>{var o;return e._inputNodes||(e._inputNodes=[]),_e(o=e._inputNodes).call(o,n)||(n instanceof AudioNode?(e._inputNodes.push(n),t.call(e,n,r,i)):t.call(e,n,r)),e},e.disconnect=(n,r,i)=>{s.call(e),n?bm(e._inputNodes,n):e._inputNodes=[];for(const o of e._inputNodes)t.call(e,o)}}let i_=null;function o_(e,t){let s=!1;const n=1/t;if(C("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{s?window.clearInterval(r):e(performance.now()/1e3)},1e3*n)}else{const r=ld();let i=r.createGain();i.gain.value=0,i.connect(r.destination);const o=()=>{if(s)return void(i=null);const c=r.createOscillator();c.onended=o,c.connect(i),c.start(0),c.stop(r.currentTime+n),e(r.currentTime)};o()}return()=>{s=!0}}class QI{constructor(){ee(this,"context",void 0),ee(this,"analyserNode",void 0),ee(this,"sourceNode",void 0),this.context=ld(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Xn()||Ar()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const n=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(n);for(let r=0;r<t.length;++r)t[r]=n[r]/128-1}const s=or(t).call(t,(n,r)=>n+r*r,0)/t.length;return Math.max(10*Math.log10(s)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,s;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(s=this.sourceNode)===null||s===void 0||s.connect(this.analyserNode)}catch{b.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class ZI extends Cs{get processSourceNode(){return this.sourceNode}set processedNode(t){var s;if(!this.isDestroyed&&this._processedNode!==t){try{var n;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.outputNode)}catch{}(s=this._processedNode)===null||s===void 0||s.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),ee(this,"outputNode",void 0),ee(this,"outputTrack",void 0),ee(this,"isPlayed",!1),ee(this,"sourceNode",void 0),ee(this,"context",void 0),ee(this,"audioBufferNode",void 0),ee(this,"destNode",void 0),ee(this,"audioOutputLevel",0),ee(this,"volumeLevelAnalyser",void 0),ee(this,"_processedNode",void 0),ee(this,"playNode",void 0),ee(this,"isDestroyed",!1),ee(this,"onNoAudioInput",void 0),ee(this,"isNoAudioInput",!1),ee(this,"_noAudioInputCount",0),this.context=ld(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Vc(this.outputNode),this.volumeLevelAnalyser=new QI}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=s=>{this.emit(Ya.ON_AUDIO_BUFFER,function(n){for(let r=0;r<n.outputBuffer.numberOfChannels;r+=1){const i=n.outputBuffer.getChannelData(r);for(let o=0;o<i.length;o+=1)i[o]=0}return n.inputBuffer}(s))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!At().webAudioMediaStreamDest)throw new se(A.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&_m(()=>{ns.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Xn()||Ar()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const s=this.volumeLevelAnalyser.getAnalyserNode();let n;s.getFloatTimeDomainData?(n=new Float32Array(s.fftSize),s.getFloatTimeDomainData(n)):(n=new Uint8Array(s.fftSize),s.getByteTimeDomainData(n));let r=!1;for(let i=0;i<n.length;i++)n[i]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await gn(200),await this.checkHasAudioInput(t?t+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,s;(t=this.processedNode)===null||t===void 0||t.disconnect(),(s=this.sourceNode)===null||s===void 0||s.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class c_ extends ZI{get isFreeze(){return!1}constructor(t,s,n){var r;if(super(),ee(this,"sourceNode",void 0),ee(this,"track",void 0),ee(this,"clonedTrack",void 0),ee(this,"audioElement",void 0),ee(this,"isCurrentTrackCloned",!1),ee(this,"isRemoteTrack",!1),ee(this,"originVolumeLevelAnalyser",void 0),ee(this,"rebuildWebAudio",async()=>{if(b.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void b.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>b.info("resume success")),b.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const c=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?c.stop():this.isCurrentTrackCloned=!0;const l=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(l),Vc(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Vc(this.outputNode),this.emit(Ya.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=l,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new se(A.UNEXPECTED_ERROR);this.track=t;const i=new MediaStream([this.track]);if(this.isRemoteTrack=!!s,this.sourceNode=this.context.createMediaStreamSource(i),Vc(this.sourceNode),n){const c=n.clone();c.enabled=!0,this.clonedTrack=c,b.debug("create an unmuted track ".concat(c.id," from the original track ").concat(n.id," to get the volume"));const l=this.context.createMediaStreamSource(new MediaStream([c]));Vc(l),this.originVolumeLevelAnalyser=new QI,this.originVolumeLevelAnalyser.updateSource(l)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=i;const o=Ft();s&&o.os===fn.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(ns.on(On.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(c=>{c||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const s=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(s),Vc(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Ya.UPDATE_SOURCE),this.audioElement.srcObject=s}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),ns.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const s=t.clone();s.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=s),b.debug("create an unmuted track ".concat(s.id," from the original track ").concat(t.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([s]));Vc(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function eA(e,t,s){const n=(i,o)=>i?typeof i!="number"?i.max||i.exact||i.ideal||i.min||o:i:o,r={audio:!!s&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:n(t.height,1080),maxWidth:n(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function $z(e,t){const s=await tA(e.mediaSource),{sourceId:n,audio:r}=await function(i){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Te((c,l)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const h=document.createElement("div");h.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const p=document.createElement("div");p.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",p.setAttribute("style","height: 12%;");const m=document.createElement("div");m.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const g=document.createElement("div");g.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const T=document.createElement("button");T.innerHTML="cancel",T.setAttribute("style","width: 85px;"),T.onclick=()=>{document.body.removeChild(I);const O=new Error("NotAllowedError");O.name="NotAllowedError",l(O)};let w=o;const S=document.createElement("div");if(o){const O=document.createElement("input");O.setAttribute("type","checkbox");const M=document.createElement("span");O.setAttribute("style","margin-right: 6px;"),M.innerText="Share audio",O.checked=w,O.onchange=()=>{w=O.checked},S.appendChild(O),S.appendChild(M)}g.appendChild(S),g.appendChild(T),h.appendChild(p),h.appendChild(m),h.appendChild(g);const I=document.createElement("div");I.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),I.appendChild(d),I.appendChild(h),document.body.appendChild(I),i.map(O=>{if(O.id){const M=document.createElement("div");M.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let z=O.thumbnail;try{const{width:K}=z.getSize();K>1920&&(z=z.resize({width:1920}))}catch(K){throw K&&K.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),K}M.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+z.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+O.name.replace(/[\u00A0-\u9999<>\&]/g,function(K){return"&#"+K.charCodeAt(0)+";"})+"</span>",M.onclick=()=>{document.body.removeChild(I),c({sourceId:O.id,audio:w})},m.appendChild(M)}})})}(s,t);return await eA(n,e,r)}async function tA(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const s=uI();if(!s)throw console.error("failed to fetch electron, please mount it to window"),new se(A.ELECTRON_IS_NULL);let n=null;try{var r;n=((r=s.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:t}))||s.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{n=null}n&&n.then||(n=new Te((i,o)=>{s.desktopCapturer.getSources({types:t},(c,l)=>{c?o(c):i(l)})}));try{return await n}catch(i){throw new se(A.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,i.toString())}}const l_=new wn("safari");let sA=!1,nA=!1;async function Ja(e,t){let s=0,n=null;for(;s<2;)try{n=await Qz(e,t,s>0);break}catch(r){if(r instanceof se)throw b.error("[".concat(t,"] ").concat(r.toString())),r;const i=Dm(r.name||r.code||r,r.message);if(i.code===A.MEDIA_OPTION_INVALID){b.debug("[".concat(t,"] detect media option invalid, retry")),s+=1,await gn(500);continue}throw b.error("[".concat(t,"] ").concat(i.toString())),i}if(!n)throw new se(A.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function Qz(e,t,s){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new se(A.NOT_SUPPORTED,"can not find getUserMedia");s&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const n=At(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return b.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(uI())e.screen.sourceId?dd(r,await eA(e.screen.sourceId,e.screen,!!e.screenAudio)):dd(r,await $z(e.screen,!!e.screenAudio));else if(so()&&e.screen.extensionId&&e.screen.mandatory){if(!n.getStreamFromExtension)throw new se(A.NOT_SUPPORTED,"This browser does not support screen sharing");b.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const m=await(o=e.screen.extensionId,c=t,new Te((g,T)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},w=>{if(!w||!w.streamId)return b.error("[".concat(c,"] No response from Chrome Plugin. Plugin not installed properly"),w),void T(new se(A.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));g(w.streamId)})}catch(w){b.error("[".concat(c,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),w.toString()),T(new se(A.CHROME_PLUGIN_NOT_INSTALL))}}));e.screen.mandatory.chromeMediaSourceId=m,dd(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(n.getDisplayMedia){var i;e.screen.mediaSource&&KI(e.screen.mediaSource);const m={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(i=e.screen.displaySurface)!==null&&i!==void 0?i:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:g,surfaceSwitching:T,systemAudio:w,preferCurrentTab:S,windowAudio:I,monitorTypeSurfaces:O}=e.screen,M={selfBrowserSurface:g,surfaceSwitching:T,systemAudio:w,preferCurrentTab:S,windowAudio:I,monitorTypeSurfaces:O};!g&&delete M.selfBrowserSurface,!T&&delete M.surfaceSwitching,!w&&delete M.systemAudio,!S&&delete M.preferCurrentTab,!I&&delete M.windowAudio,!O&&delete M.monitorTypeSurfaces,b.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:m,audio:e.screenAudio,controls:M})),dd(r,await navigator.mediaDevices.getDisplayMedia(ps({video:m,audio:e.screenAudio},M)))}else{if(!bs())throw b.error("[".concat(t,"] This browser does not support screenSharing")),new se(A.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&KI(e.screen.mediaSource);const m={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};b.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(m))),dd(r,await navigator.mediaDevices.getUserMedia(m))}}var o,c;if(!e.video&&!e.audio)return r;let l={video:e.video,audio:e.audio},d=C("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),l=Mb(l,d)}catch{}b.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(l)),Ft();let h,p=null;(yn()||Xn()||xm())&&(p=await l_.lock());try{h=await navigator.mediaDevices.getUserMedia(l)}catch(m){throw p&&p(),m}return l.audio&&(sA=!0),l.video&&(nA=!0),dd(r,h),p&&p(),r}function Dm(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new se(A.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new se(A.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new se(A.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new se(A.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new se(A.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new se(A.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return b.error("getUserMedia unexpected error",e),new se(A.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function dd(e,t){const s=e.getVideoTracks()[0],n=e.getAudioTracks()[0],r=t.getVideoTracks()[0],i=t.getAudioTracks()[0];i&&(n&&e.removeTrack(n),e.addTrack(i)),r&&(s&&e.removeTrack(s),e.addTrack(r))}const $a=new class extends Cs{get state(){return this._state}set state(e){e!==this._state&&(this.emit(Uc.STATE_CHANGE,e),this._state=e)}constructor(){super(),ee(this,"_state",Hu.IDLE),ee(this,"isAccessMicrophonePermission",!1),ee(this,"isAccessCameraPermission",!1),ee(this,"lastAccessMicrophonePermission",!1),ee(this,"lastAccessCameraPermission",!1),ee(this,"checkdeviceMatched",!1),ee(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(C("ENUMERATE_DEVICES_INTERVAL")||(Pu()||gm()===fn.HARMONY_OS)&&Ci())&&this.updateDevicesInfo()},C("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(e=>b.error(e.toString()))}async enumerateDevices(e,t){let s=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new se(A.NOT_SUPPORTED,"enumerateDevices() not supported.");const n=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(n);let i=!this.isAccessMicrophonePermission&&e,o=!this.isAccessCameraPermission&&t;r.audio&&(i=!1),r.video&&(o=!1);let c=null,l=null,d=null;if(!s&&(i||o)){if(l_.isLocked&&(b.debug("[device manager] wait GUM lock"),(await l_.lock())(),b.debug("[device manager] GUM unlock")),sA&&(i=!1,this.isAccessMicrophonePermission=!0),nA&&(o=!1,this.isAccessCameraPermission=!0),b.debug("[device manager] check media device permissions",e,t,i,o),i&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(h){const p=Dm(h.name||h.code||h,h.message);if(p.code===A.PERMISSION_DENIED)throw p;b.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(i){try{c=await navigator.mediaDevices.getUserMedia({audio:e})}catch(h){const p=Dm(h.name||h.code||h,h.message);if(p.code===A.PERMISSION_DENIED)throw p;b.warning("getUserMedia failed in getDevices",p)}this.isAccessMicrophonePermission=!0}else if(o){try{l=await navigator.mediaDevices.getUserMedia({video:t})}catch(h){const p=Dm(h.name||h.code||h,h.message);if(p.code===A.PERMISSION_DENIED)throw p;b.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0}b.debug("[device manager] mic permission",e,"cam permission",t)}try{const h=await navigator.mediaDevices.enumerateDevices();return c&&c.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),d&&d.getTracks().forEach(p=>p.stop()),c=null,l=null,d=null,h}catch(h){return c&&c.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),d&&d.getTracks().forEach(p=>p.stop()),c=null,l=null,d=null,new se(A.ENUMERATE_DEVICES_FAILED,h.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach(s=>{s.device.label===e&&(t=s.device.deviceId)}),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find(s=>s.deviceId===e);if(!t)throw new se(A.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=Hu.INITING;try{await this.updateDevicesInfo(),this.state=Hu.INITEND}catch(e){throw this.state=Hu.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(b.warning("Device Detection functionality cannot start properly.",e.toString()),e):new se(A.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),s=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=e.find(o=>o.kind==="audioinput"&&o.deviceId==="default"),i=e.find(o=>o.kind==="audiooutput"&&o.deviceId==="default");r&&i?i.groupId===r.groupId?b.debug("[device-check] default input ".concat(r.label," and output ").concat(i.label," is the same group")):b.debug("[device-check] default input ".concat(r.label," and output ").concat(i.label," is not the same group")):b.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(e);if(e.forEach(r=>{if(!r.deviceId)return;const i=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((i?i.state:"INACTIVE")!=="ACTIVE"){const o={initAt:t,updateAt:t,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),s.push(o)}i&&(i.updateAt=t)}),this.deviceInfoMap.forEach((r,i)=>{r.state==="ACTIVE"&&r.updateAt!==t&&(r.state="INACTIVE",s.push(r))}),this.state!==Hu.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));s.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Uc.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Uc.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Uc.PLAYOUT_DEVICE_CHANGED,r)}}),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter(r=>r.kind==="audioinput"),s=e.filter(r=>r.kind==="videoinput"),n={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){n.audio=!0;break}for(const r of s)if(r.label&&r.deviceId){n.video=!0;break}return n}};let d_=!1;const va=new class extends Cs{constructor(){super(...arguments),ee(this,"onAutoplayFailed",void 0),ee(this,"onAudioAutoplayFailed",void 0)}};function aA(){if(d_)return C("FLS_AUTOPLAY_EMITS")?(va.onAutoplayFailed&&va.onAutoplayFailed(),va.emit("autoplay-failed")):void 0;{const e=t=>{t.preventDefault(),d_=!1,Lu()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};d_=!0,Lu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),b.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),va.onAutoplayFailed?va.onAutoplayFailed():va.onAudioAutoplayFailed?b.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):b.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),va.emit("autoplay-failed")}}function rA(e,t,s,n){if(!e)return;const r=Ue.getBaseInfoBySessionId(e);if(!r)return;const i=r.info,o=Date.now(),c=ps(ps({},i),{},{vid:i.vid===void 0?0:Number(i.vid),lts:o,elapse:o-r.startTime,cbRegistered:va.onAutoplayFailed||va.onAudioAutoplayFailed?1:-1,errorMsg:s,mediaType:t,trackId:n,extend:void 0});Ue.send({type:Ts.AUTOPLAY_FAILED,data:c},!0)}const Zz=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ea=new class{constructor(){ee(this,"onAutoplayFailed",void 0),ee(this,"elementMap",new Map),ee(this,"elementStateMap",new Map),ee(this,"elementsNeedToResume",[]),ee(this,"sinkIdMap",new Map),ee(this,"autoResumeAfterInterruption",e=>Te.all(Array.from(this.elementMap.entries()).map(async t=>{let[s,n]=t;const r=this.elementStateMap.get(s),i=n.srcObject.getAudioTracks()[0],o=i&&i.readyState;if(b.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(e)),o==="live"){if(e)return n.pause(),n.play();if(ns.curState==="running")return Jl()?(n.pause(),n.play()):r&&r==="paused"?n.play():void 0}}))),ee(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(e=>{let[t,s]=e;const n=s.srcObject.getAudioTracks()[0];n&&n.readyState==="live"&&(b.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),s.pause(),s.play())})}),this.autoResumeAudioElement(),ns.on(On.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ns.on(On.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),ns.on(On.STATE_CHANGE,()=>{Xn()&&ns.prevState==="suspended"&&ns.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(e,t){const s=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),s)try{await s.setSinkId(t)}catch(n){throw new se(A.PERMISSION_DENIED,"can not set sink id: "+n.toString())}}play(e,t,s,n){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,Gn.INIT),this.setVolume(t,s);const i=this.sinkIdMap.get(t);if(i)try{r.setSinkId(i).catch(c=>{b.warning("[".concat(t,"] set sink id failed"),c.toString())})}catch(c){b.warning("[".concat(t,"] set sink id failed"),c.toString())}const o=r.play();o&&o.then&&o.catch(c=>{n&&rA(n,"audio",c.message,t),b.warning("audio element play warning",c.toString()),this.elementMap.has(t)&&c.name==="NotAllowedError"&&(b.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),_m(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),aA()}))})}updateTrack(e,t){const s=this.elementMap.get(e);s&&(s.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const s=this.elementMap.get(e);s&&(t=Math.max(0,Math.min(100,t)),s.volume=t/100)}getVolume(e){const t=this.elementMap.get(e);return t?t.volume:0}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const s=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(s,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){Zz.forEach(s=>{t.addEventListener(s,n=>{const r=this.elementStateMap.get(e),i=n.type==="pause"?"paused":n.type;if(b.debug("[".concat(e,"] audio-element-status change ").concat(r," => ").concat(i)),n.type==="error"){const o=t==null?void 0:t.error;o&&b.error("[".concat(e,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(e,i)})})}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(s=>{b.debug("Auto resume audio element success")}).catch(s=>{b.warning("Auto resume audio element failed!",s)})}),this.elementsNeedToResume=[]};new Te(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{Lu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function Ms(){return function(e,t,s){const n=s.value;return typeof n=="function"&&(s.value=function(){this._isClosed&&new se(A.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",b);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];const c=n.apply(this,i);return c instanceof Te?new Te((l,d)=>{c.then(l).catch(d)}):c}),s}}class iA extends Cs{constructor(t){super(),ee(this,"name","VideoProcessorDestination"),ee(this,"ID","0"),ee(this,"_source",void 0),ee(this,"videoContext",void 0),ee(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new se(A.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new se(A.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(pa.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(pa.ON_TRACK,void 0)}}class oA extends Cs{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,s){super(),ee(this,"constraintsMap",new Map),ee(this,"statsRegistry",[]),ee(this,"usageRegistry",[]),ee(this,"trackId",void 0),ee(this,"direction",void 0),ee(this,"_chained",!1),this.trackId=t,this.direction=s}async getConstraints(){return await Qs(this,qa.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,s){var n;return b.info("processor ".concat(s.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(s,t),ls(this,qa.REQUEST_UPDATE_CONSTRAINTS,Array.from(Pa(n=this.constraintsMap).call(n)))}async requestRevertConstraints(t){var s;if(this.constraintsMap.has(t))return b.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),ls(this,qa.REQUEST_UPDATE_CONSTRAINTS,Array.from(Pa(s=this.constraintsMap).call(s)))}registerStats(t,s,n){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===s)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:s,cb:n})}unregisterStats(t,s){const n=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===s);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const t=[];for(const{processorID:s,processorName:n,type:r,cb:i}of this.statsRegistry)try{const o=i();t.push({processorID:s,processorName:n,type:r,stats:o})}catch(o){b.error(new se(A.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,s){this.usageRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:s})}unregisterUsage(t){const s=this.usageRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name);s!==-1&&this.usageRegistry.splice(s,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:s}of this.usageRegistry)try{let n=s();n instanceof Te&&(n=await n),t.push(ps(ps({},n),{},{direction:this.direction}))}catch(n){b.error("gather extension usage error",n)}return t}getDirection(){return this.direction}}class cA extends Cs{constructor(t){super(),ee(this,"name","AudioProcessorDestination"),ee(this,"ID","0"),ee(this,"inputTrack",void 0),ee(this,"inputNode",void 0),ee(this,"audioProcessorContext",void 0),ee(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new se(A.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new se(A.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(pa.ON_TRACK,void 0),this.emit(pa.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(pa.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(pa.ON_NODE,this.inputNode))}}class lA extends Cs{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,s,n){super(),ee(this,"constraintsMap",new Map),ee(this,"statsRegistry",[]),ee(this,"audioContext",void 0),ee(this,"trackId",void 0),ee(this,"direction",void 0),ee(this,"usageRegistry",[]),ee(this,"_chained",!1),this.audioContext=t,this.trackId=s,this.direction=n}async getConstraints(){return Qs(this,qa.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,s){var n;return b.info("processor ".concat(s.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(s,t),ls(this,qa.REQUEST_UPDATE_CONSTRAINTS,Array.from(Pa(n=this.constraintsMap).call(n)))}async requestRevertConstraints(t){var s;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),ls(this,qa.REQUEST_UPDATE_CONSTRAINTS,Array.from(Pa(s=this.constraintsMap).call(s)))}registerStats(t,s,n){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===s)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:s,cb:n})}unregisterStats(t,s){const n=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===s);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const t=[];for(const{processorID:s,processorName:n,type:r,cb:i}of this.statsRegistry)try{const o=i();t.push({processorID:s,processorName:n,type:r,stats:o})}catch(o){b.error(new se(A.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,s){this.usageRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:s})}unregisterUsage(t){const s=this.usageRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name);s!==-1&&this.usageRegistry.splice(s,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:s}of this.usageRegistry)try{let n=s();n instanceof Te&&(n=await n),t.push(ps(ps({},n),{},{direction:this.direction}))}catch(n){b.error("gather extension usage error",n)}return t}getDirection(){return this.direction}}class u_ extends Cs{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),ee(this,"context",void 0),ee(this,"processSourceNode",void 0),ee(this,"outputTrack",void 0),ee(this,"processedNode",void 0),ee(this,"clonedTrack",void 0),ee(this,"outputNode",void 0),this.outputNode=new e7}setVolume(){}createOutputTrack(){throw new se(A.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class e7{disconnect(){}connect(){}}function dA(e){return new Te((t,s)=>{let n=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const i=Xn()?"canplay":"playing";r.addEventListener(i,()=>{const o=r.videoWidth,c=r.videoHeight;!o&&bs()||(n=!0,r.srcObject=null,r.remove(),t([o,c]))}),r.srcObject=new MediaStream([e]),r.play().catch(Vu),setTimeout(()=>{n||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))},4e3)})}function km(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const s=Pr(e.encoderConfig);return s.width!=null&&(t.width=s.width),s.height!=null&&(t.height=s.height),!nI()&&s.frameRate&&(t.frameRate=s.frameRate),XC()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),bs()&&(t.frameRate={ideal:30,max:30}),t}function uA(e){const t={};return nI()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,so()&&e.ANS&&(t.googHighpassFilter=e.ANS))),t}function hA(e){const t=uA(e);if(e.encoderConfig){const s=Am(e.encoderConfig);t.channelCount=s.stereo?2:1,t.sampleRate=s.sampleRate,t.sampleSize=s.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),Pu()&&(t.sampleRate=void 0),t}const pA=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:s,width:n,height:r}=e.getMediaStreamTrackSettings();let{frameRate:i=s,width:o=n,height:c=r}=t;if(!i||!o||!c)return;o=Zl(o),c=Zl(c),i=Zl(i);const{max:l,min:d}=function(g,T,w){const S=200*Math.pow(w/15,.6)*Math.pow(g*T/640/360,.75);return{min:Math.floor(S),max:Math.floor(4*S)}}(o,c,i),{bitrateMax:h,bitrateMin:p}=t||{};h||b.debug("calculate bitrate: [w: ".concat(o,", h: ").concat(c,", fps: ").concat(i,"] => [brMax: ").concat(h,", brMin: ").concat(p,"]"));const{maxFramerate:m}=C("ENCODER_CONFIG_LIMIT");return m&&typeof m=="number"&&(i=Math.min(i,m)),{frameRate:i,bitrateMax:h||l,bitrateMin:p||d,scaleResolutionDownBy:1,scale:0}},mA=async(e,t,s)=>await(async(n,r,i)=>{const o=function(d){const h=[];for(let p=0;p<d.length;p+=2)h.push(parseInt(d.slice(p,p+2),16));return Uint8Array.from(h)}(wI(""+r+i)).slice(0,16),c=o.slice(0,12),l=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},l,n))})(e.buffer,t,s),h_=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new Te((s,n)=>{t.toBlob(async r=>{if(t.remove(),r){const i=await fA(r);s({buffer:i,width:t.width,height:t.height})}else n(new se(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,1)})},fA=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var gA,xA,bA,_A,vA,EA,yA,wA,SA,NA,TA,RA,CA,IA,AA,OA,DA,kA,Ds,jA,PA,LA,MA,UA,VA,Oi,FA,BA,GA,WA,HA,zA,KA,YA,qA,XA,JA,$A,QA,Vn;let Us=(gA=tt({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),xA=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),bA=Ms(),_A=ed("LocalAudioTrack","_enabledMutex"),vA=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),EA=Ms(),yA=ed("LocalAudioTrack","_enabledMutex"),wA=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),SA=Ms(),NA=Ms(),TA=Ms(),RA=tt({argsMap:e=>[e.getTrackId()]}),CA=Ms(),IA=tt({argsMap:e=>[e.getTrackId()]}),AA=Ms(),OA=tt({argsMap:e=>[e.getTrackId()]}),DA=tt({argsMap:(e,t)=>[e.getTrackId(),t.name]}),kA=tt({argsMap:e=>[e.getTrackId()]}),Lt((Ds=class extends cd{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?ea.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,s,n){super(e,s),ee(this,"trackMediaType",od.AUDIO),ee(this,"_encoderConfig",void 0),ee(this,"_trackSource",void 0),ee(this,"metadata",[]),ee(this,"_enabled",!0),ee(this,"_volume",100),ee(this,"_useAudioElement",!0),ee(this,"_bypassWebAudio",!1),ee(this,"processor",void 0),ee(this,"_processorContext",void 0),ee(this,"_processorDestination",void 0),ee(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!n,this._trackSource=new u_,C("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),C("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),yn()&&!Xa?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){rs(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&ea.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void b.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,ls(this,Be.NEED_REPLACE_TRACK,this).then(()=>{b.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(s=>{b.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),s)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!BI())throw new se(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ea.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,s){return this._setEnabled(e,t,s)}async _setEnabled(e,t,s){if(!s){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(b.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{s||(this._enabled=!0),await ls(this,Be.NEED_ENABLE_TRACK,this),b.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(n){throw s||(this._enabled=!1),b.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}}else{this._originMediaStreamTrack.enabled=!1,s||(this._enabled=!1);try{await ls(this,Be.NEED_DISABLE_TRACK,this)}catch(n){throw s||(this._enabled=!0),b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,b.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await ls(this,Be.NEED_MUTE_TRACK,this):await ls(this,Be.NEED_UNMUTE_TRACK,this))}getStats(){return Vo(()=>{b.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Ua(this,Be.GET_STATS)||ps({},s_)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Ya.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Ya.ON_AUDIO_BUFFER),this._source.on(Ya.ON_AUDIO_BUFFER,s=>e(s))}play(){b.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(b.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ea.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){b.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ea.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];b.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ea.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await ls(this,Be.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Te.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new se(A.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new se(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(pa.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await ls(this,Be.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await ls(this,Be.NEED_REPLACE_TRACK,this))}),e.on(pa.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(e){e.removeAllListeners(pa.ON_TRACK),e.removeAllListeners(pa.ON_NODE)}bindProcessorContextEvents(e){e.on(qa.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(qa.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof u_&&(this._trackSource=new c_(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new lA(this._source.context,this.getTrackId(),"local"),t=new cA(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(Ya.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(ea.stop(this.getTrackId()),this._source.play()),ls(this,Be.NEED_REPLACE_MIXING_TRACK,this).then(()=>{b.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(s=>{b.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),s)})),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[gA],Object.getOwnPropertyDescriptor(Ds.prototype,"setVolume"),Ds.prototype),Lt(Ds.prototype,"setPlaybackDevice",[xA,bA],Object.getOwnPropertyDescriptor(Ds.prototype,"setPlaybackDevice"),Ds.prototype),Lt(Ds.prototype,"setEnabled",[_A,vA,EA],Object.getOwnPropertyDescriptor(Ds.prototype,"setEnabled"),Ds.prototype),Lt(Ds.prototype,"setMuted",[yA,wA,SA],Object.getOwnPropertyDescriptor(Ds.prototype,"setMuted"),Ds.prototype),Lt(Ds.prototype,"getStats",[NA],Object.getOwnPropertyDescriptor(Ds.prototype,"getStats"),Ds.prototype),Lt(Ds.prototype,"setAudioFrameCallback",[TA],Object.getOwnPropertyDescriptor(Ds.prototype,"setAudioFrameCallback"),Ds.prototype),Lt(Ds.prototype,"play",[RA,CA],Object.getOwnPropertyDescriptor(Ds.prototype,"play"),Ds.prototype),Lt(Ds.prototype,"stop",[IA,AA],Object.getOwnPropertyDescriptor(Ds.prototype,"stop"),Ds.prototype),Lt(Ds.prototype,"close",[OA],Object.getOwnPropertyDescriptor(Ds.prototype,"close"),Ds.prototype),Lt(Ds.prototype,"pipe",[DA],Object.getOwnPropertyDescriptor(Ds.prototype,"pipe"),Ds.prototype),Lt(Ds.prototype,"unpipe",[kA],Object.getOwnPropertyDescriptor(Ds.prototype,"unpipe"),Ds.prototype),Ds),zu=(jA=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),PA=Ms(),LA=ed("MicrophoneAudioTrack","_enabledMutex"),MA=tt({argsMap:(e,t,s)=>[e.getTrackId(),t,s]}),UA=Ms(),VA=tt({argsMap:e=>[e.getTrackId()]}),Lt((Oi=class extends Us{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,s,n){super(e,t.encoderConfig?Am(t.encoderConfig):{},n,C("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),ee(this,"_config",void 0),ee(this,"_deviceName","default"),ee(this,"_constraints",void 0),ee(this,"_originalConstraints",void 0),ee(this,"_enabled",!0),this._config=t,this._constraints=s,this._originalConstraints=s,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(Jl()||Ib())&&ns.bindInterruptDetectorTrack(this)}async setDevice(e){if(b.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await $a.getDeviceById(e),s={};s.audio=ps({},this._constraints),s.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let n=null;try{n=await Ja(s,this.getTrackId())}catch(r){throw b.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),n=await Ja({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await $a.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}b.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,s){if(t)return b.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!s){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(b.info("[".concat(this.getTrackId(),"] start setEnabled"),e),C("AUTO_RESET_AUDIO_ROUTE")&&(Xn()||Ar())){const o=navigator.audioSession;o&&(e||(o.type="playback"),o.type="auto")}if(!e){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(n=this._source.clonedTrack)===null||n===void 0||n.stop(),s||(this._enabled=!1);try{await ls(this,Be.NEED_DISABLE_TRACK,this)}catch(o){throw b.error("[".concat(this.getTrackId(),"] setEnabled false failed"),o.toString()),o}return}const r=ps({},this._constraints),i=$a.searchDeviceIdByName(this._deviceName);i&&!r.deviceId&&(r.deviceId=i);try{s||(this._enabled=!0);const o=await Ja({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getAudioTracks()[0],!1),await ls(this,Be.NEED_ENABLE_TRACK,this)}catch(o){throw s||(this._enabled=!1),b.error("[".concat(this.getTrackId(),"] setEnabled true failed"),o.toString()),o}b.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Jl()||Ib())&&ns.unbindInterruptDetectorTrack(this),Lc.some(e=>function(t){return"__className__"in t&&t.__className__==="MicrophoneAudioTrack"}(e))||r_&&r_()&&(Ue.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:is.TRACER}).onSuccess(),b.debug("restart background audio tag success"))}onTrackEnded(){if((Xn()||Ar())&&this._enabled&&!this._isClosed&&ns.duringInterruption){const e=async()=>{ns.off(On.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(b.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ns.on(On.IOS_INTERRUPTION_END,e)}else b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(id.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,s=$a.searchDeviceIdByName(this._deviceName);if(s&&!t.deviceId&&(t.deviceId=s),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const n=await Ja({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(qa.REQUEST_UPDATE_CONSTRAINTS,async(t,s,n)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),s()}catch(r){n(r)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(qa.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[jA,PA],Object.getOwnPropertyDescriptor(Oi.prototype,"setDevice"),Oi.prototype),Lt(Oi.prototype,"setEnabled",[LA,MA,UA],Object.getOwnPropertyDescriptor(Oi.prototype,"setEnabled"),Oi.prototype),Lt(Oi.prototype,"close",[VA],Object.getOwnPropertyDescriptor(Oi.prototype,"close"),Oi.prototype),Oi),t7=(FA=tt({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),BA=Ms(),GA=tt({argsMap:e=>[e.getTrackId()]}),WA=Ms(),HA=tt({argsMap:e=>[e.getTrackId()]}),zA=Ms(),KA=tt({argsMap:e=>[e.getTrackId()]}),YA=Ms(),qA=tt({argsMap:e=>[e.getTrackId()]}),XA=Ms(),JA=tt({argsMap:e=>[e.getTrackId()]}),$A=tt({argsMap:e=>[e.getTrackId()]}),QA=Ms(),Lt((Vn=class extends Us{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,s,n){super(t.createOutputTrack(),s,n),ee(this,"source",void 0),ee(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(Ya.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(id.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){rs(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[FA,BA],Object.getOwnPropertyDescriptor(Vn.prototype,"startProcessAudioBuffer"),Vn.prototype),Lt(Vn.prototype,"pauseProcessAudioBuffer",[GA,WA],Object.getOwnPropertyDescriptor(Vn.prototype,"pauseProcessAudioBuffer"),Vn.prototype),Lt(Vn.prototype,"seekAudioBuffer",[HA,zA],Object.getOwnPropertyDescriptor(Vn.prototype,"seekAudioBuffer"),Vn.prototype),Lt(Vn.prototype,"resumeProcessAudioBuffer",[KA,YA],Object.getOwnPropertyDescriptor(Vn.prototype,"resumeProcessAudioBuffer"),Vn.prototype),Lt(Vn.prototype,"stopProcessAudioBuffer",[qA,XA],Object.getOwnPropertyDescriptor(Vn.prototype,"stopProcessAudioBuffer"),Vn.prototype),Lt(Vn.prototype,"close",[JA],Object.getOwnPropertyDescriptor(Vn.prototype,"close"),Vn.prototype),Lt(Vn.prototype,"setAudioBufferPlaybackSpeed",[$A,QA],Object.getOwnPropertyDescriptor(Vn.prototype,"setAudioBufferPlaybackSpeed"),Vn.prototype),Vn);class nn extends Us{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=ld().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,Jt(8,"track-mix-")),ee(this,"trackList",void 0),ee(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(b.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):b.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){b.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}bm(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(s=>{s._encoderConfig&&((s._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=s._encoderConfig.bitrate),(s._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=s._encoderConfig.sampleRate),(s._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=s._encoderConfig.sampleSize),s._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(s=>{s instanceof nn?s.emit(Mc.TRANSCEIVER_UPDATED,t):s._updateRtpTransceiver(t)}))}}class s7 extends ZI{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Ya.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),ee(this,"audioBuffer",void 0),ee(this,"sourceNode",void 0),ee(this,"startPlayTime",0),ee(this,"startPlayOffset",0),ee(this,"pausePlayTime",0),ee(this,"options",void 0),ee(this,"currentLoopCount",0),ee(this,"currentPlaybackSpeed",100),ee(this,"_currentState","stopped"),this.audioBuffer=t,this.options=s,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):b.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const ZA=new Map;function eO(e,t){if(e.length===0||t.length===0)return 1/0;const s=Vb(e),n=Vb(t);return Math.floor(n/s)}class p_{get rendFrameRate(){const t=Math.max(1,eO(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/t)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:Gn.DESTROYED}set videoElementStatus(t){t!==this._videoElementStatus&&(b.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var s;t!==this._videoState&&(this._videoState=t,(s=this.onVideoStateChanged)===null||s===void 0||s.call(this,this.videoState))}constructor(t){ee(this,"trackId",void 0),ee(this,"config",void 0),ee(this,"onFirstVideoFrameDecoded",void 0),ee(this,"onFirstVideoFrameRender",void 0),ee(this,"onVideoBufferReady",void 0),ee(this,"onVideoStateChanged",void 0),ee(this,"freezeTimeCounterList",[]),ee(this,"renderFreezeAccTime",0),ee(this,"renderFreezeAccTime2",0),ee(this,"isKeepLastFrame",!1),ee(this,"isDestroyed",!1),ee(this,"timeUpdatedCount",0),ee(this,"freezeTime",0),ee(this,"playbackTime",0),ee(this,"lastTimeUpdatedTime",0),ee(this,"autoplayFailed",!1),ee(this,"videoTrack",void 0),ee(this,"videoElement",void 0),ee(this,"cacheVideoElement",void 0),ee(this,"cancelRVFId",void 0),ee(this,"internal",!1),ee(this,"_render_interframe_delays",[]),ee(this,"_render_interframe_delays_sizes",[]),ee(this,"_videoState",Ai.VideoStateStopped),ee(this,"videoElementCheckInterval",void 0),ee(this,"videoElementFreezeTimeout",void 0),ee(this,"_videoElementStatus",Gn.NONE),ee(this,"_isInPage",!0),ee(this,"isGettingVideoDimensions",!1),ee(this,"startGetVideoDimensions",()=>{const s=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return b.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(s,500)};!this.isGettingVideoDimensions&&s()}),ee(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&ns.curState==="running"&&(b.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(YC())),tI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),ee(this,"handleVideoEvents",s=>{switch(s.type){case"play":case"playing":s.type==="play"&&b.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=Gn.PLAYING;break;case"loadeddata":if(this.videoState=Ai.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Gn.CANPLAY;break;case"stalled":this.videoElementStatus=Gn.STALLED;break;case"suspend":this.videoElementStatus=Gn.SUSPEND;break;case"pause":this.videoElementStatus=Gn.PAUSED,Xn()||Ar()||yn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(b.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Gn.WAITING;break;case"abort":this.videoElementStatus=Gn.ABORT;break;case"ended":this.videoElementStatus=Gn.ENDED;break;case"emptied":this.videoElementStatus=Gn.EMPTIED;break;case"error":{const n=this.videoElement.error;n&&(this.videoElementStatus=Gn.ERROR,b.error("[".concat(this.trackId,"] media error: ").concat(n.message," (").concat(n.code,")")));break}case"timeupdate":{const n=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>C("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=n);const r=n-this.lastTimeUpdatedTime,i=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=n,Va.lastVisibleTime<Va.lastHiddenTime||i<Va.lastHiddenTime||i<Va.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>C("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),ee(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(b.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(YC())),tI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),ns.on(On.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ns.on(On.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const s=this.videoElement.play();s&&s.catch&&s.catch(r=>{t&&rA(t,"video",r.message,this.trackId),r.name==="NotAllowedError"?(b.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):b.warning("[".concat(this.trackId,"] play warning: "),r)});const n=Ft();if((n.name==="Safari"&&Number(n.version)===15||Jl())&&s&&s.then){const r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};s.then(r).catch(r)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const s=t.getContext("2d");if(!s)return b.error("create canvas context failed!"),new ImageData(2,2);s.drawImage(this.videoElement,0,0,t.width,t.height);const n=s.getImageData(0,0,t.width,t.height);return t.remove(),n}async getCurrentFrameToUint8Array(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const r=n.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,n.width,n.height),new Te((i,o)=>{n.toBlob(async c=>{if(n.remove(),c){const l=await fA(c);i({buffer:l,width:n.width,height:n.height})}else o(new se(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,s<0?.1:s>1?1:s)})):await h_(t)}destroy(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,ns.off(On.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ns.off(On.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),t?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Ai.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Gn.INIT,!this.videoElementCheckInterval&&(tO.forEach(i=>{this.videoElement.addEventListener(i,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{this._isInPage=function(i){return i!==document.body&&document.body.contains(i)}(this.videoElement)},1e3),C("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,s;let i;const o=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",o),this.videoElementFreezeTimeout=window.setTimeout(c,C("VIDEO_FREEZE_DURATION")))},c=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Ai.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Ai.VideoStateFrozen:document.addEventListener("visibilitychange",o))},l=(d,h)=>{if(this.videoElementStatus===Gn.PLAYING){if(i){const g=h.presentationTime-i.presentationTime,T=h.presentedFrames-i.presentedFrames;this._render_interframe_delays_sizes.push(T),this._render_interframe_delays.push(g);const w=Vb(this._render_interframe_delays_sizes),S=w-this._render_interframe_delays_sizes[0];if(w>30&&S>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Ai.VideoStateStarting&&(this.videoState=Ai.VideoStateDecoding),this.videoState===Ai.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(c,C("VIDEO_FREEZE_DURATION"))),g<C("VIDEO_FREEZE_DURATION")&&this.videoState===Ai.VideoStateFrozen&&(this.videoState=Ai.VideoStateDecoding),g>C("VIDEO_FREEZE_DURATION")&&Va.lastVisibleTime>=Va.lastHiddenTime&&i.timestamp>Va.lastVisibleTime&&i.timestamp>Va.lastHiddenTime){const I=Math.min(66,eO(this._render_interframe_delays_sizes,this._render_interframe_delays)),O=Math.max(0,g-(T-1)*I);this.renderFreezeAccTime2+=O>I?O:0,this.renderFreezeAccTime+=g}}i=ps(ps({},h),{},{timestamp:d})}else this.isSkipCalcRenderFreezeTime()&&(i=ps(ps({},h),{},{timestamp:d}));var p,m;C("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(p=(m=this.videoElement).requestVideoFrameCallback)===null||p===void 0?void 0:p.call(m,l))};this.cancelRVFId=(t=(s=this.videoElement).requestVideoFrameCallback)===null||t===void 0?void 0:t.call(s,l)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Pu()&&!C("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const n=Ft();this.config.noStyle||(n.name==="Safari"&&Number(n.version)===15||Jl()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,bs()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,bs()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(i=>{b.debug("[".concat(this.trackId,"] playback interrupted"),i.toString())})}resetVideoElement(){var t,s;tO.forEach(n=>{this.videoElement&&this.videoElement.removeEventListener(n,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((t=(s=this.videoElement).cancelVideoFrameCallback)===null||t===void 0||t.call(s,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=Gn.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===Gn.DESTROYED||this.internal}handleAutoPlayFailed(){const t=s=>{s.preventDefault(),this.videoElement.play().then(()=>{b.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(n=>{b.error(n)}),this.autoplayFailed=!1,Lu()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Lu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),aA()}}const tO=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class jm extends p_{constructor(t){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(t),ee(this,"container",void 0),ee(this,"slot",void 0),this.slot=t.element,this.internal=s,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const s=t.element;var n;!this.internal||this.slot?(s!==this.slot&&(this.destroy(),this.slot=s),this.createElements()):(this.slot=s,s&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(n=this.slot)===null||n===void 0||n.appendChild(this.container)):this.createElements())}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var s;(s=this.container)!==null&&s!==void 0&&s.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var s;let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(s=this.container)!==null&&s!==void 0&&s.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,n):await h_(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var t;this.container.remove(),(t=this.slot)===null||t===void 0||t.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var t;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",C("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(t=this.slot)===null||t===void 0||t.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var sO,nO,aO,rO,iO,oO,cO,lO,dO,uO,hO,pO,mO,fO,gO,xO,bO,_O,vO,EO,yO,wO,SO,NO,TO,RO,CO,IO,Ot,AO,OO,DO,kO,jO,PO,LO,MO,Qa;let os=(sO=tt({argsMap:(e,t,s)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",s]}),nO=Ms(),aO=tt({argsMap:e=>[e.getTrackId()]}),rO=ed("LocalVideoTrack","_enabledMutex"),iO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),oO=Ms(),cO=ed("LocalVideoTrack","_enabledMutex"),lO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),dO=Ms(),uO=tt({argsMap:(e,t)=>[e.getTrackId(),t,e._saveEncodeBitrateRatio]}),hO=Ms(),pO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),mO=Ms(),fO=Ms(),gO=tt({argsMap:(e,t,s)=>[e.getTrackId(),t,s]}),xO=Ms(),bO=Ms(),_O=Ms(),vO=tt({argsMap:e=>[e.getTrackId()]}),EO=Ms(),yO=Ms(),wO=Ms(),SO=Ms(),NO=Ms(),TO=tt({argsMap:(e,t)=>[e.getTrackId(),t.name]}),RO=tt({argsMap:e=>[e.getTrackId()]}),CO=tt({argsMap:e=>[e.getTrackId()]}),IO=tt({argsMap:(e,t,s)=>[e.getTrackId(),t.label,s]}),Ot=class kL extends cd{get videoHeight(){if(yn()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(yn()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Gn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,s,n,r,i,o){if(super(t,i),ee(this,"trackMediaType",od.VIDEO),ee(this,"_player",void 0),ee(this,"isUseScaleResolutionDownBy",!1),ee(this,"_videoVisibleTimer",null),ee(this,"_previousVideoVisibleStatus",void 0),ee(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),ee(this,"_encoderConfig",void 0),ee(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),ee(this,"_optimizationMode",void 0),ee(this,"_saveEncodeBitrateRatio",1),ee(this,"_videoHeight",void 0),ee(this,"_videoWidth",void 0),ee(this,"_forceBitrateLimit",void 0),ee(this,"_enabled",!0),ee(this,"_processorDestination",void 0),ee(this,"_processorContext",void 0),yn()){const{width:c,height:l}=t.getSettings();this._videoWidth=c,this._videoHeight=l}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=n,this._optimizationMode=r,this._hints=o||[],s&&this._hints.indexOf(qt.CUSTOM_TRACK)!==-1?this._encoderConfig=_s(s):this._encoderConfig=s,this._hints.indexOf(qt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(Tb(Wt.CHROME,115)&&gm().indexOf("Windows")!==-1){const c=function(l,d){if("VideoFrame"in window&&"TransformStream"in window&&At().supportWebRTCInsertableStream){const h=new MediaStreamTrackProcessor(l),p=new MediaStreamTrackGenerator({kind:"video"});let m,g,T=Date.now();const w=()=>{S&&(clearInterval(S),S=void 0),m&&(m.close(),m=void 0),l.stop(),g=void 0,p.removeEventListener("ended",w)};let S=window.setInterval(()=>{if(g&&m&&Date.now()-T>1e3)try{p.readyState==="live"?g.enqueue(m.clone()):w()}catch{w()}},1e3);const I=new TransformStream({transform:(O,M)=>{p.readyState==="live"?(g=M,T=Date.now(),m===void 0?(m=O,M.enqueue(O.clone())):(M.enqueue(m),m=O)):O.close()}});return p.addEventListener("ended",w),h.readable.pipeThrough(I).pipeTo(p.writable),p}}(t);c&&(b.info("local screen video track begin to inject frame"),this._mediaStreamTrack=c)}s&&this._hints.indexOf(qt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(s),this._processorContext=new oA(this.getTrackId(),"local"),this._processorDestination=new iA(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(b.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}b.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(s));const n=ps(ps(ps({},this._getDefaultPlayerConfig()),s),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new p_(n):this._player=new jm(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(id.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,b.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,s){if(!s){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await ls(this,Be.NEED_DISABLE_TRACK,this)}catch(n){throw b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}return s||(this._enabled=!1),void b.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await ls(this,Be.NEED_ENABLE_TRACK,this)}catch(n){throw b.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}b.info("[".concat(this.getTrackId(),"] setEnabled to true success")),s||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,b.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await ls(this,Be.NEED_MUTE_TRACK,this):await ls(this,Be.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*t),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*t),b.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(t)),this._saveEncodeBitrateRatio=1;try{await ls(this,Be.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(b)}}}async setEncoderConfiguration(t,s){if(!this._enabled)throw new se(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=Pr(t),C("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const n=km({encoderConfig:t});(yn()||Xn()||Ar())&&(n.deviceId=void 0),b.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(r){const i=new se(A.UNEXPECTED_ERROR,r.toString());throw b.error("[".concat(this.getTrackId(),"] applyConstraints error"),i.toString()),i}}this._encoderConfig=t,this._hints.indexOf(qt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await ls(this,Be.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(b)}}getStats(){return Vo(()=>{b.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Ua(this,Be.GET_STATS)||ps({},n_)}async setBeautyEffect(t){b.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,s):await h_(t)}async findClosestProfile(){const{width:t,height:s,frameRate:n}=this.getMediaStreamTrackSettings(),{width:r,height:i,frameRate:o}=this._encoderConfig||{},c=Zl(this._videoWidth||t||r||0),l=Zl(this._videoHeight||s||i||0),d=function(h,p,m){if(!Array.isArray(C("VIDEO_ENCODER_CONFIG_LIST"))||C("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const g=Math.min(h,p);return!(g>=480)&&ps(ps({},C("VIDEO_ENCODER_CONFIG_LIST").find(T=>T.height>g)),{},{frameRate:m})}(c,l,Zl(n||o||15));if(d)return b.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(c,"x").concat(l," => ").concat(JSON.stringify(d))),this.setEncoderConfiguration(d)}async setBitrateLimit(t){b.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t&&(this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate))}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void b.error(A.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const s=this._optimizationMode;try{this._optimizationMode=t,await ls(this,Be.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(n){throw this._optimizationMode=s,b.error("[".concat(this.getTrackId(),"] set optimization mode failed"),n.toString()),n}b.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return b.error(A.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,b.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){dA(this._originMediaStreamTrack).then(t=>{let[s,n]=t;this._videoHeight=n,this._videoWidth=s}).catch(Vu)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new se(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");b.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=Pr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(qt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await ls(this,Be.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(b)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:s,frameRate:n}=this.getMediaStreamTrackSettings();if(!t||!s||!n)return;const{bitrateMax:r,bitrateMin:i}=this._encoderConfig;if(i==null||r==null){const{max:o,min:c}=function(l,d,h,p,m){const g=C("BITRATE_ADAPTER_TYPE");if(g==="DEFAULT_BITRATE")return{min:p,max:m};if(m===void 0){const T=Math.floor(200*Math.pow(h/15,.6)*Math.pow(l*d/640/360,.75));m=g==="STANDARD_BITRATE"?4*T:2*T,p=p??T}else p=p??Math.floor(m/10);return{min:p,max:m}}(t,s,n,i,r);if(this._encoderConfig.bitrateMin=c,this._encoderConfig.bitrateMax=o,C("VIDEO_STANDARD_BITRATE_VERSION")&&i==null&&r==null){const[l,d]=function(h,p,m){const g=4*Math.floor(2e5*Math.pow(m/15,.6)*Math.pow(h*p/230400,.75)),T=h*p,w=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),S=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let I=Pa(w).call(w).next().value,O=1;if(w.has(T))I=w.get(T);else{var M;const ke=bc(M=Array.from(w.entries())).call(M,(at,Et)=>{let[xt]=at,[Ht]=Et;return xt-Ht}),lt=ke.find(at=>{let[Et]=at;return Et>T});if(lt){const at=ke.indexOf(lt);if(at>0){const Et=ke[at-1],xt=(T-Et[0])/(lt[0]-Et[0]);I=Et[1]+xt*(lt[1]-Et[1])}else I=lt[1]}else I=ke[ke.length-1][1]}if(S.has(T))O=S.get(T);else{var z;const ke=bc(z=Array.from(S.entries())).call(z,(at,Et)=>{let[xt]=at,[Ht]=Et;return xt-Ht}),lt=ke.find(at=>{let[Et]=at;return Et>T});if(lt){const at=ke.indexOf(lt);if(at>0){const Et=ke[at-1],xt=(T-Et[0])/(lt[0]-Et[0]);O=Et[1]+xt*(lt[1]-Et[1])}else O=lt[1]}else O=ke[ke.length-1][1]}const K=C("VIDEO_NEW_BITRATE_RATIO");K&&K>0&&(I=K/100);const V=Math.floor(g*I),Y=Math.floor(65e4*Math.pow(h*p/230400,.5)*Math.pow(m/15,.69));let ce=V;const xe=C("VIDEO_STANDARD_BITRATE_VERSION");return xe&&xe>0&&(xe===1?ce=g:xe===2?ce=V:xe===3&&(ce=Y)),[Math.floor(ce/1e3),O]}(t,s,n);this._encoderConfig.bitrateMax=l,this._encoderConfig.bitrateMin=c?Math.min(c,l):l,this._saveEncodeBitrateRatio=d,b.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(t,", h: ").concat(s,", fps: ").concat(n,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else b.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(s,", fps: ").concat(n,"] => [brMax: ").concat(o,", brMin: ").concat(c,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var t,s;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(s=this._player)===null||s===void 0?void 0:s.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:i,slot:o}=r;if(this.isPlaying&&i instanceof HTMLVideoElement&&o instanceof HTMLElement){const c=lI.checkOneElementVisible(i),l=Object.assign({},c);if(l.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=l.visible;const d=Ue.reportApiInvoke(null,{tag:is.TRACER,name:Ns.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});l.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(l.reason))}return l}return}catch(n){throw new se(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new se(A.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;t&&(n=ps(ps({},n),Pr(t))),n=Oc(n);const r=Jt(8,"track-video-cloned-"),i=new kL(s?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,Oc(this._scalabilityMode),this._optimizationMode,r,Oc(this._hints));return t&&n&&i.setEncoderConfiguration(n),b.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(s)),i}async replaceTrack(t,s){if(!(t instanceof MediaStreamTrack))throw new se(A.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new se(A.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,s,!0),this.updateMediaStreamTrackResolution()}sendSeiData(t){if(Vo(()=>{Ue.reportApiInvoke(null,{name:Ns.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:is.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!C("ENABLE_VIDEO_SEI")||!C("ENABLE_ENCODED_TRANSFORM"))return void b.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new se(A.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const s=this.getRTCRtpTransceiver();if(!s)return void b.warning("Video track is not published, SEI can not be send");const n=s.sender.getParameters();if(n.codecs.length===0)return;const r=n.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",t):b.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(pa.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await ls(this,Be.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await ls(this,Be.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(pa.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(qa.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(qa.REQUEST_CONSTRAINTS)}},Lt(Ot.prototype,"play",[sO,nO],Object.getOwnPropertyDescriptor(Ot.prototype,"play"),Ot.prototype),Lt(Ot.prototype,"stop",[aO],Object.getOwnPropertyDescriptor(Ot.prototype,"stop"),Ot.prototype),Lt(Ot.prototype,"setEnabled",[rO,iO,oO],Object.getOwnPropertyDescriptor(Ot.prototype,"setEnabled"),Ot.prototype),Lt(Ot.prototype,"setMuted",[cO,lO,dO],Object.getOwnPropertyDescriptor(Ot.prototype,"setMuted"),Ot.prototype),Lt(Ot.prototype,"setSaveEncodeBitrateRatio",[uO,hO],Object.getOwnPropertyDescriptor(Ot.prototype,"setSaveEncodeBitrateRatio"),Ot.prototype),Lt(Ot.prototype,"setEncoderConfiguration",[pO,mO],Object.getOwnPropertyDescriptor(Ot.prototype,"setEncoderConfiguration"),Ot.prototype),Lt(Ot.prototype,"getStats",[fO],Object.getOwnPropertyDescriptor(Ot.prototype,"getStats"),Ot.prototype),Lt(Ot.prototype,"setBeautyEffect",[gO,xO],Object.getOwnPropertyDescriptor(Ot.prototype,"setBeautyEffect"),Ot.prototype),Lt(Ot.prototype,"getCurrentFrameData",[bO],Object.getOwnPropertyDescriptor(Ot.prototype,"getCurrentFrameData"),Ot.prototype),Lt(Ot.prototype,"getCurrentFrameImage",[_O],Object.getOwnPropertyDescriptor(Ot.prototype,"getCurrentFrameImage"),Ot.prototype),Lt(Ot.prototype,"findClosestProfile",[vO,EO],Object.getOwnPropertyDescriptor(Ot.prototype,"findClosestProfile"),Ot.prototype),Lt(Ot.prototype,"setBitrateLimit",[yO],Object.getOwnPropertyDescriptor(Ot.prototype,"setBitrateLimit"),Ot.prototype),Lt(Ot.prototype,"setOptimizationMode",[wO],Object.getOwnPropertyDescriptor(Ot.prototype,"setOptimizationMode"),Ot.prototype),Lt(Ot.prototype,"setScalabiltyMode",[SO],Object.getOwnPropertyDescriptor(Ot.prototype,"setScalabiltyMode"),Ot.prototype),Lt(Ot.prototype,"updateMediaStreamTrackResolution",[NO],Object.getOwnPropertyDescriptor(Ot.prototype,"updateMediaStreamTrackResolution"),Ot.prototype),Lt(Ot.prototype,"pipe",[TO],Object.getOwnPropertyDescriptor(Ot.prototype,"pipe"),Ot.prototype),Lt(Ot.prototype,"unpipe",[RO],Object.getOwnPropertyDescriptor(Ot.prototype,"unpipe"),Ot.prototype),Lt(Ot.prototype,"close",[CO],Object.getOwnPropertyDescriptor(Ot.prototype,"close"),Ot.prototype),Lt(Ot.prototype,"replaceTrack",[IO],Object.getOwnPropertyDescriptor(Ot.prototype,"replaceTrack"),Ot.prototype),Ot),Pm=(AO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),OO=Ms(),DO=ed("CameraVideoTrack","_enabledMutex"),kO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),jO=Ms(),PO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),LO=Ms(),MO=tt({argsMap:e=>[e.getTrackId()]}),Qa=class jL extends os{get __className__(){return"CameraVideoTrack"}constructor(t,s,n,r,i,o){super(t,Pr(s.encoderConfig),r,i,o),ee(this,"_config",void 0),ee(this,"_originalConstraints",void 0),ee(this,"_constraints",void 0),ee(this,"_enabled",!0),ee(this,"_deviceName","default"),ee(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Jl()||Ib())&&!function(){const c=Ft();if(c.os!==fn.IOS||!c.osVersion)return!1;const l=c.osVersion.split(".");return Number(l[0])===15&&Number(l[1])>=2}()&&sI()&&this._enabled&&!this._isClosed&&(b.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=s,this._originalConstraints=n,this._constraints=n,this._deviceName=t.label,this._encoderConfig=Pr(this._config.encoderConfig),ns.on(On.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),ns.on(On.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(b.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const s=await $a.getDeviceById(t),n={};n.video=ps({},this._constraints),n.video.deviceId={exact:t},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await Ja(n,this.getTrackId())}catch(i){throw b.error("[".concat(this.getTrackId(),"] setDevice failed"),i.toString()),r=await Ja({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),i}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=s.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(s){throw b.error("[".concat(this.getTrackId(),"] setDevice error"),s.toString()),s}else try{const s=await $a.getDeviceById(t);this._deviceName=s.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(s){throw b.error("[".concat(this.getTrackId(),"] setDevice error"),s.toString()),s}b.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){b.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const s={video:ps(ps({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let n=null;try{n=await Ja(s,this.getTrackId())}catch(r){throw b.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),n=await Ja({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=ps({},s.video),b.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,s){if(!s){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const n=await Ja({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1)}await ls(this,Be.NEED_ENABLE_TRACK,this)}catch(n){throw b.error("[".concat(this.getTrackId(),"] setEnabled true error"),n.toString()),n}this.updateMediaStreamTrackResolution(),b.info("[".concat(this.getTrackId(),"] setEnabled to true success")),s||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),s||(this._enabled=!1);try{await ls(this,Be.NEED_DISABLE_TRACK,this)}catch(n){throw b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}b.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,s){if(!this._enabled)throw new se(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=Pr(t),C("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const n=_s(this._config);n.encoderConfig=t;const r=km(n);(yn()||Xn()||Ar())&&(r.deviceId=void 0),b.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(i){const o=new se(A.UNEXPECTED_ERROR,i.toString());throw b.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=n,this._constraints=r,this._originalConstraints=r,this._encoderConfig=t,this._hints.indexOf(qt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await ls(this,Be.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(b)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Xn()||Ar())&&this._enabled&&!this._isClosed&&ns.duringInterruption){const t=async()=>{ns.off(On.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(b.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ns.on(On.IOS_INTERRUPTION_END,t)}else b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(id.TRACK_ENDED)}async renewMediaStreamTrack(t){const s=t||this._constraints,n=$a.searchDeviceIdByName(this._deviceName);if(n&&!s.deviceId&&(s.deviceId={exact:n}),this._enabled){const r=await Ja({video:s},this.getTrackId());this._constraints=s,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),ns.off(On.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),ns.off(On.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;t&&(n=ps(ps({},n),Pr(t))),n=Oc(n);const r=Jt(8,"track-cam-cloned-"),i=new jL(s?this._mediaStreamTrack.clone():this._mediaStreamTrack,Oc(ps(ps({},this._config),{},{encoderConfig:n})),Oc(this._constraints),Oc(this._scalabilityMode),this._optimizationMode,r);return t&&n&&i.setEncoderConfiguration(n),b.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(s)),i}bindProcessorContextEvents(){this.processorContext.on(qa.REQUEST_UPDATE_CONSTRAINTS,async(t,s,n)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),s()}catch(r){n(r)}}),this.processorContext.on(qa.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}},Lt(Qa.prototype,"setDevice",[AO,OO],Object.getOwnPropertyDescriptor(Qa.prototype,"setDevice"),Qa.prototype),Lt(Qa.prototype,"setEnabled",[DO,kO,jO],Object.getOwnPropertyDescriptor(Qa.prototype,"setEnabled"),Qa.prototype),Lt(Qa.prototype,"setEncoderConfiguration",[PO,LO],Object.getOwnPropertyDescriptor(Qa.prototype,"setEncoderConfiguration"),Qa.prototype),Lt(Qa.prototype,"close",[MO],Object.getOwnPropertyDescriptor(Qa.prototype,"close"),Qa.prototype),Qa);function UO(e){const t=Jt(8,"track-cus-"),s=Ue.reportApiInvoke(null,{id:t,tag:is.TRACER,name:Ns.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),n=new Us(e.mediaStreamTrack,e.encoderConfig?Am(e.encoderConfig):{},t,!1);return b.info("create custom audio track success with config",e,"trackId",n.getTrackId()),s.onSuccess(n.getTrackId()),n}function m_(e,t,s,n){s.optimizationMode&&(n&&n.width&&n.height?(s.encoderConfig=ps(ps({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),s.optimizationMode!=="motion"&&s.optimizationMode!=="detail"||(t.contentHint=s.optimizationMode,t.contentHint===s.optimizationMode?b.debug("[".concat(e,"] set content hint to"),s.optimizationMode):b.debug("[".concat(e,"] set content hint failed")))):b.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var VO,FO,BO,GO,hr,WO,HO,zO,KO,YO,qO,XO,Fn;class JO extends JI{getUserId(){return this._userId}constructor(t,s,n,r){super(t,"track-".concat(t.kind,"-").concat(s,"-").concat(r.clientId,"_").concat(Jt(5,""))),ee(this,"_userId",void 0),ee(this,"_uintId",void 0),ee(this,"_isDestroyed",!1),ee(this,"store",void 0),ee(this,"processor",void 0),ee(this,"processorContext",void 0),this._userId=s,this._uintId=n,this.store=r}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,b.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let ud=(VO=tt({argsMap:(e,t,s)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",s]}),FO=tt({argsMap:e=>[e.getTrackId()]}),BO=tt({argsMap:(e,t)=>[e.getTrackId(),t.name]}),GO=tt({argsMap:e=>[e.getTrackId()]}),Lt((hr=class extends JO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Gn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,s,n,r){super(e,t,s,n),ee(this,"_videoVisibleTimer",null),ee(this,"_previousVideoVisibleStatus",void 0),ee(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),ee(this,"trackMediaType",od.VIDEO),ee(this,"_videoWidth",void 0),ee(this,"_videoHeight",void 0),ee(this,"_player",void 0),ee(this,"_prePlayer",void 0),ee(this,"processorDestination",void 0),ee(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new oA(this.getTrackId(),"remote"),this.processorDestination=new iA(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Vo(()=>{b.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Ua(this,Be.GET_STATS)||ps({},qI)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(ur.PLAY_START),typeof e=="string"){const n=document.getElementById(e);n?e=n:(b.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}b.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const s=ps(ps({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});if(this._player)this._player.updateConfig(s);else{let n=!1,r=!1;e instanceof HTMLVideoElement?(this._player=new p_(s),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,n=this._player.videoState>0,this._player.updateConfig(s)):this._player=new jm(s),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(ur.FIRST_FRAME_DECODED),r&&this.safeEmit(ur.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=i=>{this.safeEmit(ur.VIDEO_STATE_CHANGED,i)},n&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const n=this.getVideoElementVisibleStatus();this.safeEmit(ur.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(ur.PLAY_END)}stop(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(e),this._player=void 0,b.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){dA(this._originMediaStreamTrack).then(e=>{let[t,s]=e;this._videoHeight=s,this._videoWidth=t}).catch(Vu)}_updatePlayerSource(){b.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const s=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),n={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:s==null?void 0:s.parentElement},{element:r,slot:i}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&i instanceof HTMLElement){const o=lI.checkOneElementVisible(r),c=Object.assign({},o);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const l=Ue.reportApiInvoke(null,{tag:is.TRACER,name:Ns.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?l.onSuccess("Video is visible"):l.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(s){throw new se(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,s.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new se(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(pa.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(pa.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(Mc.SEI_RECEIVED,e)}}).prototype,"play",[VO],Object.getOwnPropertyDescriptor(hr.prototype,"play"),hr.prototype),Lt(hr.prototype,"stop",[FO],Object.getOwnPropertyDescriptor(hr.prototype,"stop"),hr.prototype),Lt(hr.prototype,"pipe",[BO],Object.getOwnPropertyDescriptor(hr.prototype,"pipe"),hr.prototype),Lt(hr.prototype,"unpipe",[GO],Object.getOwnPropertyDescriptor(hr.prototype,"unpipe"),hr.prototype),hr),hd=(WO=tt({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),HO=tt({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),zO=tt({argsMap:(e,t)=>[e.getTrackId(),t]}),KO=tt({argsMap:e=>[e.getTrackId()]}),YO=tt({argsMap:e=>[e.getTrackId()]}),qO=tt({argsMap:(e,t)=>[e.getTrackId(),t.name]}),XO=tt({argsMap:e=>[e.getTrackId()]}),Lt((Fn=class extends JO{get isPlaying(){return this._useAudioElement?ea.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,s,n){super(e,t,s,n),ee(this,"trackMediaType",od.AUDIO),ee(this,"_source",void 0),ee(this,"_useAudioElement",!0),ee(this,"_volume",100),ee(this,"processorContext",void 0),ee(this,"processorDestination",void 0),ee(this,"_played",!1),ee(this,"_bypassWebAudio",!1),C("DISABLE_WEBAUDIO")?(this._source=new u_,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new c_(e,!0),C("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Ya.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(ur.FIRST_FRAME_DECODED)}),this.processorContext=new lA(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new cA(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Ya.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Ya.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Ya.ON_AUDIO_BUFFER),this._source.on(Ya.ON_AUDIO_BUFFER,s=>e(s))}setVolume(e){this._volume=e,this._useAudioElement?ea.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}setAmplifiedVolume(e){this._useAudioElement&&this._played&&(ea.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,e=Math.min(e,C("MAX_WEBAUDIO_VOLUME")),this._volume=e,this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!BI())throw new se(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ea.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?ea.getVolume(this.getTrackId()):this._source instanceof c_?this._source.getAudioVolume():0}getStats(){return Vo(()=>{b.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Ua(this,Be.GET_STATS)||ps({},YI)}play(){b.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(b.debug("[".concat(this.getTrackId(),"] use audio element to play")),ea.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(b.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){b.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ea.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];b.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ea.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new se(A.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new se(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new se(A.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(pa.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(pa.ON_NODE,e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(pa.ON_TRACK),this.processorDestination.removeAllListeners(pa.ON_NODE)}}).prototype,"setVolume",[WO],Object.getOwnPropertyDescriptor(Fn.prototype,"setVolume"),Fn.prototype),Lt(Fn.prototype,"setAmplifiedVolume",[HO],Object.getOwnPropertyDescriptor(Fn.prototype,"setAmplifiedVolume"),Fn.prototype),Lt(Fn.prototype,"setPlaybackDevice",[zO],Object.getOwnPropertyDescriptor(Fn.prototype,"setPlaybackDevice"),Fn.prototype),Lt(Fn.prototype,"play",[KO],Object.getOwnPropertyDescriptor(Fn.prototype,"play"),Fn.prototype),Lt(Fn.prototype,"stop",[YO],Object.getOwnPropertyDescriptor(Fn.prototype,"stop"),Fn.prototype),Lt(Fn.prototype,"pipe",[qO],Object.getOwnPropertyDescriptor(Fn.prototype,"pipe"),Fn.prototype),Lt(Fn.prototype,"unpipe",[XO],Object.getOwnPropertyDescriptor(Fn.prototype,"unpipe"),Fn.prototype),Fn);const Va=new class extends Cs{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),ee(this,"_lastHiddenTime",0),ee(this,"_lastVisibleTime",0),ee(this,"needUploadStats",[]),ee(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),b.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class $O extends Cs{constructor(t,s){super(),ee(this,"trackMediaType",od.DATA),ee(this,"_version",1),ee(this,"_type",3),ee(this,"_config",void 0),ee(this,"_originDataChannel",void 0),ee(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),ee(this,"_dataStreamPacketHandler",{serialize:n=>n,deserialize:n=>n}),ee(this,"_datachannelEventMap",new Map),this._config=t,s&&(this._originDataChannel=s,this._bandDataChannelEvents(s)),this._initPacketHeader()}useDataStream(t){this._dataStreamPacketHandler=t}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return C("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,s;return(t=(s=this._originDataChannel)===null||s===void 0?void 0:s.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,s;return(t=(s=this._originDataChannel)===null||s===void 0?void 0:s.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Te((t,s)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const n=setTimeout(()=>{var r;s(new se(A.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new se(A.DATACHANNEL_CONNECTION_TIMEOUT)}}else s(new se(A.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Om.OPEN,Om.CLOSE,Om.ERROR].forEach(s=>{const n=()=>{this.emit(s)};this._datachannelEventMap.set(s,n),t.addEventListener(s,n)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(s=>{let[n,r]=s;t.removeEventListener(n,r)}),this._datachannelEventMap.clear()}}class n7 extends $O{constructor(t){super(t),ee(this,"_messageListener",void 0),this._messageListener=s=>{if(s.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const n=s.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(n).getUint8(3);if(r!==this.id)return void(C("SHOW_DATASTREAM2_LOG")&&b.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let i=s.data.slice(this._dataStreamPacketHeader.byteLength);i=this._dataStreamPacketHandler.deserialize(i),this.emit(Om.MESSAGE,i)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class a7 extends $O{send(t){if(this._originDataChannel){let s=t;s=this._dataStreamPacketHandler.serialize(t);const n=new Uint8Array(this._dataStreamPacketHeader.byteLength+s.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(s),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}function Lm(){const e=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>Pp.revokeObjectURL(e),0),new Worker(Pp.createObjectURL(e))}const QO=71,f_=1,g_=2,x_=1,ZO=2;var Bo=function(e){return e[e.AUDIO_LEVEL=1]="AUDIO_LEVEL",e[e.METADATA=2]="METADATA",e[e.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e}(Bo||{});function b_(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const s=e.getUint8(0);if(s!==QO)return;const n=e.getUint16(1),r=f_+g_+n,i=new Uint8Array(e.byteLength-r);i.set(new Uint8Array(e.buffer,r,e.byteLength-r));const o={m:s,tlvLen:n,tlv:[],frame:i};let c=f_+g_;for(;c<r;){const l=e.getUint8(c),d=e.getUint16(c+x_),h=x_+ZO;if(l===Bo.AUDIO_LEVEL){let p=e.getUint8(c+h);for(let m=1;m<d;m++)p=p<<8|e.getUint8(c+h+m);o.tlv.push({tag:l,length:d,value:t?127^p>>1:127&p})}else if(l===Bo.METADATA||l===Bo.AUDIO_64_BIT_PTS){const p=new Uint8Array(d);for(let m=0;m<d;m++)p[m]=e.getUint8(c+h+m);o.tlv.push({tag:l,length:d,value:p})}c+=h+d}return o}const Mm=new Map,Um=127,Fc=1e-10,__=139/13,Vm=new Map;function v_(e,t,s){const n="".concat(e,"-").concat(t,"-").concat(s);let r=0;return Vm.has(n)?r=Vm.get(n):(r=Math.log(function(o,c){const l=o-c;c<l&&(c=l);let d=1;for(let h=o,p=1;h>c;h--,p++)d=d*h/p;return d}(t,e))+e*Math.log(.5)+(t-e)*Math.log(1-.5)-Math.log(s)+s*e,Vm.set(n,r)),r<Fc&&(r=Fc),r}function eD(e,t,s){const n=t.length,r=e.length/n;let i=!1;for(let o=0,c=0;o<n;o++){let l=0;for(let d=c+r;c<d;c++)e[c]>s&&l++;t[o]!==l&&(t[o]=l,i=!0)}return i}window.cache=Vm;let r7=0;class tD{constructor(t){ee(this,"id",void 0),ee(this,"immediates",[]),ee(this,"lastNonSilence",-1),ee(this,"immediateSpeechActivityScore",Fc),ee(this,"lastLevelChangedTime",Date.now()),ee(this,"levels",[]),ee(this,"longs",[]),ee(this,"longSpeechActivityScore",Fc),ee(this,"mediums",[]),ee(this,"mediumSpeechActivityScore",Fc),ee(this,"minLevel",0),ee(this,"nextMinLevel",0),ee(this,"nextMinLevelWindowLength",0),ee(this,"energyScore",0),this.id=t||"".concat(r7++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const t=this.immediates,s=this.levels,n=this.minLevel+__;let r=!1;for(let i=0;i<t.length;++i){let o=s[i];o<n&&(o=0);const c=Math.floor(o/__);t[i]!==c&&(t[i]=c,r=!0)}return r}computeLongs(){return eD(this.mediums,this.longs,4)}computeMediums(){return eD(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=v_(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(t){this.longSpeechActivityScore=v_(this.longs[0],10,47),this.longSpeechActivityScore>Fc&&(this.lastNonSilence=t)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=v_(this.mediums[0],5,24)}evaluateSpeechActivityScores(t){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(t)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var t;return"[".concat(yy(t=[...this.levels]).call(t).join(),"]")}getSpeechActivityScore(t){switch(t){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+t)}}levelChanged(t,s){if(this.lastLevelChangedTime<=s){this.lastLevelChangedTime=s;let n=t;return t<0&&(n=0),t>Um&&(n=Um),this.levels.unshift(n),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(n),n>=this.minLevel+__?n:n/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(t){if(t!==0){if(this.minLevel===0||this.minLevel>t)return this.minLevel=t,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=t,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>t&&(this.nextMinLevel=t),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let s=Math.sqrt(this.minLevel*this.nextMinLevel);s<0?s=0:s>Um&&(s=Um),this.minLevel=s,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class i7{constructor(t){ee(this,"algorithm",void 0),this.algorithm=t}execute(){let t=!this.algorithm;if(!t)try{const s=this.algorithm.runInDecisionMaker(this);s<=0?t=!0:setTimeout(this.execute.bind(this),s)}catch{t=!0}t&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class E_{constructor(t,s,n){ee(this,"isDominant",void 0),ee(this,"energyRanking",void 0),ee(this,"energyScore",void 0),this.isDominant=t,this.energyRanking=s,this.energyScore=n}}class o7 extends Cs{constructor(t){super(),ee(this,"dominantId",null),ee(this,"lastDecisionTime",0),ee(this,"lastLevelChangedTime",0),ee(this,"lastLevelIdleTime",0),ee(this,"relativeSpeechActivities",[]),ee(this,"speakers",new Map),ee(this,"enableSilence",!1),ee(this,"timeoutToSilenceInterval",0),ee(this,"decisionMaker",null),ee(this,"loudest",[]),ee(this,"numLoudestToTrack",3),ee(this,"energyExpireTimeMs",250),ee(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=t,this.enableSilence=t>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,s=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=t,s!=null&&(this.energyExpireTimeMs=s),n!=null&&(this.energyAlphaPct=n),this.loudest.length>t&&this.loudest.splice(t)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(t){return this.loudest.some(s=>s.id===t)}levelChanged(t,s){const n=Date.now(),r=this.getOrCreateSpeaker(t);this.lastLevelChangedTime<n&&(this.lastLevelChangedTime=n,this.maybeStartDecisionMaker());const i=r.levelChanged(s,n);return this.updateLoudestList(r,i,n)}runInDecisionMaker(t){return this.decisionMaker!==t||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(t){this.decisionMaker===t&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(t){t.forEach(s=>{this.speakers.has(s.id)||this.speakers.set(s.id,s)})}removeSpeakers(t){t.forEach(s=>{this.speakers.delete(s.id)})}getOrCreateSpeaker(t){let s=this.speakers.get(t);return s||(s=new tD(t),this.speakers.set(t,s),this.maybeStartDecisionMaker()),s}updateLoudestList(t,s,n){const r=t.id===this.dominantId;if(s<0){let l=0;for(;l<this.loudest.length&&this.loudest[l]!==t;)++l;return new E_(r,l,t.energyScore)}if(t.energyScore=Math.floor((this.energyAlphaPct*s+(100-this.energyAlphaPct)*t.energyScore+50)/100),this.numLoudestToTrack===0)return new E_(r,0,t.energyScore);const i=n-this.energyExpireTimeMs;let o=0;for(;o<this.loudest.length;){const l=this.loudest[o];if(l.getLastLevelChangedTime()<i&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(o,1);else if(l.id!==t.id)++o;else if(this.loudest.splice(o,1),this.loudest.length<this.numLoudestToTrack)break}let c=0;for(;c<this.loudest.length&&!(this.loudest[c].energyScore<t.energyScore);)++c;return c<this.numLoudestToTrack&&(this.loudest.splice(c,0,t),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new E_(r,c,t.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new i7(this),this.decisionMaker.execute())}makeDecision(t){let s=null,n=null;const r=this.speakers.size;let i=null;if(r===0)i=null;else if(r===1){var o;const c=Pa(o=this.speakers).call(o).next().value;this.enableSilence&&c&&(i=c.id,c.evaluateSpeechActivityScores(t),t-c.lastNonSilence>this.timeoutToSilenceInterval&&(i=null))}else{let c=this.dominantId==null?null:this.speakers.get(this.dominantId);if(c==null){const h=this.speakers.entries().next();h.value&&(i=h.value[0],c=h.value[1])}else i=c.id;c!=null&&c.evaluateSpeechActivityScores(t);const l=this.relativeSpeechActivities;let d=2;for(const h of this.speakers.entries()){const[p,m]=h;if(m===c)continue;m.evaluateSpeechActivityScores(t);for(let S=0;S<l.length;++S){const I=c==null?Fc:c.getSpeechActivityScore(S);l[S]=Math.log(m.getSpeechActivityScore(S)/I)}const g=l[0],T=l[1],w=l[2];g>3&&T>2&&w>0&&T>d&&(d=T,i=p)}this.enableSilence&&c!=null&&i===c.id&&t-c.lastNonSilence>this.timeoutToSilenceInterval&&(i=null)}i==null&&!this.enableSilence||i===this.dominantId||(s=this.dominantId,this.dominantId=i,n=this.dominantId),n==null&&!this.enableSilence||n===s||this.emit("ActiveSpeakerChanged",n)}_runInDecisionMaker(){const t=Date.now(),s=300-(t-this.lastLevelIdleTime);let n=0;s<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(t),this.lastLevelIdleTime=t):n=s;let r=300-(t-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=t,this.makeDecision(t),r=300-(Date.now()-t)),r>0&&n>r&&(n=r),n}timeoutIdleLevels(t){const s=[];for(const r of Pa(n=this.speakers).call(n)){var n;const i=t-r.getLastLevelChangedTime();36e5<i&&(this.dominantId==null||r.id!==this.dominantId)?s.push(r.id):300<i&&r.levelTimedOut()}s.forEach(r=>this.speakers.delete(r))}}const pd=new Map;let ai=null,Fm=null;const sD=3;let Bc=[];const ri=new Map,Bm=new Map;class c7{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(t,s){ee(this,"id",void 0),ee(this,"track",void 0),ee(this,"score",0),ee(this,"active",!0),ee(this,"muted",!1),ee(this,"timer",0),ee(this,"actives",0),ee(this,"inactives",0),this.id=t,this.track=s,this.setActive(ri.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const t=this.active;this.active=this.activeRate>=.8;const{actives:s,inactives:n}=function(){const r=[],i=[];return Array.from(Pa(ri).call(ri)).forEach(o=>{o.active?r.push(o):i.push(o)}),{actives:r,inactives:i}}();if(s.length>3){let r;s.forEach(i=>{(!r||r.score>i.score)&&(r=i)}),r&&r.setActive(!1)}if(s.length<3&&n.length>0){let r;n.forEach(i=>{(!r||r.score<i.score)&&i.id!==this.id&&(r=i)}),r&&t&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(t){this.active=t,this.resetTimer(),this.setMuted(!t)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const t=function(s){let n;return Array.from(Pa(ri).call(ri)).forEach(r=>{!r.active||r.id===s||r.samples<40||(!n||r.score<n.score)&&(n=r)}),n}(this.id);t&&this.activeRate-t.activeRate>.4&&(t.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const t=function(s){let n;return Array.from(Pa(ri).call(ri)).forEach(r=>{r.active||r.id===s||r.samples<40||(!n||r.score>n.score)&&(n=r)}),n}(this.id);t&&t.activeRate-this.activeRate>.4&&(t.setActive(!0),this.setActive(!1))}addSample(t){t?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(t){this.track&&(this.track.enabled=!t,this.muted=t)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let Gm;function nD(e){const t=ri.get(e);t&&(ri.delete(e),t.clearTimer())}const Wm=new Map,l7=new Map,y_="video/h264",w_="video/h265";function aD(e,t,s){let n=new Uint8Array(e,t,s),r=[],i=0;for(;r.length<s;)i+3<s&&n[i]===0&&n[i+1]===0&&n[i+2]===3&&(n[i+3]===0||n[i+3]===1||n[i+3]===2||n[i+3]===3)?(r.push(n[i],n[i+1],n[i+3]),i+=4):(r.push(n[i]),i++);return new Uint8Array(r)}function rD(e){const t=e.length;let s=[],n=0;for(;n<t;)n+2<t&&e[n]===0&&e[n+1]===0&&(e[n+2]===0||e[n+2]===1||e[n+2]===2||e[n+2]===3)?(s.push(e[n],e[n+1],3,e[n+2]),n+=3):(s.push(e[n]),n++);return new Uint8Array(s)}function iD(e){if(e.length<5)return"";let t=-1;for(let r=0;r<e.length-3;r++){if(e[r]===0&&e[r+1]===0&&e[r+2]===1){t=r;break}if(r<e.length-4&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1){t=r;break}}if(t===-1)return"";const s=t+(e[t+2]===0?4:3);if(s>=e.length)return"";const n=e[s];return 128&n?"":(n>>1&63)>=32||s+1<e.length&&!(248&e[s+1])?w_:(31&n)<=31?y_:""}const Hm=new Map,Ku=new Map;(function(){const e=Ft();xn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),xn.getStreamFromExtension=e.name===Wt.CHROME&&Number(e.version)>34,xn.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let s=!1;try{t.addTransceiver("audio"),s=!0}catch{}return t.close(),s}(),xn.supportMinBitrate=e.name===Wt.CHROME||e.name===Wt.EDGE,xn.supportSetRtpSenderParameters=function(){const t=Ft();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Ci()||!(!yn()&&!xm())||t.name===Wt.FIREFOX&&Number(t.version)>=64)}(),e.name===Wt.SAFARI&&(Number(e.version)>=14?xn.supportDualStream=!0:xn.supportDualStream=!1),xn.webAudioMediaStreamDest=function(){const t=Ft();return!(t.name===Wt.SAFARI&&Number(t.version)<12)}(),xn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",xn.supportWebGL=typeof WebGLRenderingContext<"u",xn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ci()||(xn.webAudioWithAEC=!0),xn.supportShareAudio=function(){const t=Ft();return(t.os===fn.WIN_10||t.os===fn.WIN_81||t.os===fn.WIN_7||t.os===fn.LINUX||t.os===fn.MAC_OS||t.os===fn.CHROMIUM_OS)&&t.name===Wt.CHROME&&Number(t.version)>=74}(),xn.supportDataChannel=!!(si(76)||Rb(68)||$C(14)),xn.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!bs()&&!!t&&t.prototype.setConfiguration instanceof Function}(),xn.supportWebRTCEncodedTransform=si(87)||qC()||Rb(117),xn.supportWebRTCInsertableStream=function(){const t=Ft();return(t.name===Wt.CHROME||t.name===Wt.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),xn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,xn.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,xn.supportSuppressLocalAudioPlayback=HI(),xn.supportRestrictOwnAudio=zI(),_m(()=>{xn.supportDualStreamEncoding=function(){const t=Ft();return!!C("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&C("CHROME_DUAL_STREAM_USE_ENCODING"))}(),b.debug("browser ua: ",navigator.userAgent),b.info("browser info: ",e),b.info("browser compatibility: ",xn)})})();const d7=["CHINA","GLOBAL"],oD=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Gc=[],md=[];function Wc(e,t){return!!t&&Gc.some(s=>s.uid===e&&s.channelName===t)}function S_(){return md.length>0}var u7=mR.forEach,cD=Yh("forEach")?[].forEach:function(e){return u7(this,e,arguments.length>1?arguments[1]:void 0)};Xt({target:"Array",proto:!0,forced:[].forEach!==cD},{forEach:cD});var h7=ir("Array","forEach"),p7=Io,m7=Yn,f7=X,g7=h7,N_=Array.prototype,x7={DOMTokenList:!0,NodeList:!0},b7=function(e){var t=e.forEach;return e===N_||f7(N_,e)&&t===N_.forEach||m7(x7,p7(e))?g7:t},_7=E(b7),v7=yi,lD=Zh;Xt({target:"Object",stat:!0,forced:y(function(){lD(1)})},{keys:function(e){return lD(v7(e))}});var E7=E(rt.Object.keys),y7=E(_y),w7=E(Ey),S7=Xt,dD=au,N7=pp,T7=We,uD=Ug,R7=Co,C7=ts,I7=nx,A7=$s,O7=Oo,D7=aR("slice"),k7=A7("species"),T_=Array,j7=Math.max;S7({target:"Array",proto:!0,forced:!D7},{slice:function(e,t){var s,n,r,i=C7(this),o=R7(i),c=uD(e,o),l=uD(t===void 0?o:t,o);if(dD(i)&&(s=i.constructor,(N7(s)&&(s===T_||dD(s.prototype))||T7(s)&&(s=s[k7])===null)&&(s=void 0),s===T_||s===void 0))return O7(i,c,l);for(n=new(s===void 0?T_:s)(j7(l-c,0)),r=0;c<l;c++,r++)c in i&&I7(n,r,i[c]);return n.length=r,n}});var P7=ir("Array","slice"),L7=X,M7=P7,R_=Array.prototype,U7=function(e){var t=e.slice;return e===R_||L7(R_,e)&&t===R_.slice?M7:t},V7=E(U7);function Re(e,t,s,n,r){var i,o,c,l={};return _7(i=E7(n)).call(i,function(d){l[d]=n[d]}),l.enumerable=!!l.enumerable,l.configurable=!!l.configurable,("value"in l||l.initializer)&&(l.writable=!0),l=y7(o=w7(c=V7(s).call(s)).call(c)).call(o,function(d,h){return h(e,t,d)||d},l),r&&l.initializer!==void 0&&(l.value=l.initializer?l.initializer.call(r):void 0,l.initializer=void 0),l.initializer===void 0?(eR(e,t,l),null):l}let zm=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),C_=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),pr=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e}({}),ma=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),Qe=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),jt=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),Ge=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e}({}),qe=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e}({}),Hc=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),ut=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e}({}),fa=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),bt=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e.ON_FALLBACK="websocket:on_fallback",e}({});function Km(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw b.error("Invalid Channel Name ".concat(e)),new $(A.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Ym(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||iI(e,1,255)))throw new $(A.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&b.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let ro=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e}({});const F7={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},I_={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function A_(e,t){An(e.url,"".concat(t,".url"),1,1e3,!1),js(e.x)||rs(e.x,"".concat(t,".x"),0,1e4),js(e.y)||rs(e.y,"".concat(t,".y"),0,1e4),js(e.width)||rs(e.width,"".concat(t,".width"),0,1e4),js(e.height)||rs(e.height,"".concat(t,".height"),0,1e4),js(e.zOrder)||rs(e.zOrder,"".concat(t,".zOrder"),0,255),js(e.alpha)||rs(e.alpha,"".concat(t,".alpha"),0,1,!1)}const B7={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let Go=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),O_=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),an=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function hD(e){if(!e.channelName)throw new $(A.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new $(A.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&An(e.token,"info.token",1,2047),Ym(e.uid),Km(e.channelName),!0}let Ea=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),io=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),Ra=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),fd=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),Qt=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),Bs=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e.UPDATE_GATEWAY_CONFIG="update-gateway-config",e.VOS_FALLBACK="vos-fallback",e.VOS_FALLBACK_PROMISE="vos-fallback-promise",e.RESET_SIGNAL="reset-signal",e.DATACHANNEL_FAILBACK="datachannel-failback",e}({}),qm=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),bn=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),Kt=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const pD=[Kt.AFRICA,Kt.ASIA,Kt.CHINA,Kt.EUROPE,Kt.GLOBAL,Kt.INDIA,Kt.JAPAN,Kt.NORTH_AMERICA,Kt.OCEANIA,Kt.OVERSEA,Kt.SOUTH_AMERICA];let Wn=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const Xm={CHINA:{},ASIA:{CODE:Wn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Wn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Wn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Wn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Wn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Wn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Wn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Wn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Wn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Wn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Wn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Wn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Wn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Yb&&(Xm.CHINA={CODE:Wn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let ii=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",e.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",e.FALLBACK_TO_HLS="fallback_to_hls",e.UPDATE_VOS_CONFIGURE="update_vos_configure",e}({});function mD(e){return!!e&&!(!e.uplink||!e.id)&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0}class fD extends Cs{constructor(t,s){super(),N(this,"onICEConnectionStateChange",void 0),N(this,"onConnectionStateChange",void 0),N(this,"onDTLSTransportStateChange",void 0),N(this,"onDTLSTransportError",void 0),N(this,"onICETransportStateChange",void 0),N(this,"onFirstAudioReceived",void 0),N(this,"onFirstVideoReceived",void 0),N(this,"onFirstAudioDecoded",void 0),N(this,"onFirstVideoDecoded",void 0),N(this,"onFirstVideoRender",void 0),N(this,"onFirstVideoBufferReady",void 0),N(this,"onFirstVideoDecodedTimeout",void 0),N(this,"onSelectedLocalCandidateChanged",void 0),N(this,"onSelectedRemoteCandidateChanged",void 0),N(this,"onICECandidateError",void 0),N(this,"getLocalVideoStats",void 0)}}class Jm extends fD{constructor(t,s){super(t,s),N(this,"establishPromise",void 0)}}let Le=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),Sn=function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e}({}),oo=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.TCP_RESTART=3]="TCP_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({});const gD=["disconnected","failed"];let ve=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),Yt=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),Xe=function(e){return e.AudioMetadata="audioMetadata",e.AudioPts="audioPts",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e.FirstVideoPreRender="FirstVideoPreRender",e.FirstVideoBufferReady="FirstVideoBufferReady",e}({}),Lr=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Mr=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Nn=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Wo=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),rn=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),Di=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),mr=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),oi=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),gd=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Gs=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),xd=function(e){return e.ABORT="abort",e}({}),Ho=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),G7=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const W7={[zm.ACCESS_POINT]:{[ma.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[ma.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[ma.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[ma.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[ma.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[ma.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[ma.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[zm.UNILBS]:{[pr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[pr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[pr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[pr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[pr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[pr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[pr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[pr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[pr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[pr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[pr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[pr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[pr.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[zm.STRING_UID_ALLOCATOR]:{[C_.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[C_.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[C_.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function bd(e){const t=W7[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const s=t[e%1e4];if(!s){if(Math.floor(e/1e4)===zm.ACCESS_POINT){const n=e%1e4;if(n.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(n.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return s}const H7={[Qe.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Qe.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Qe.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Qe.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Qe.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Qe.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Qe.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Qe.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Qe.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Qe.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Qe.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Qe.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Qe.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Qe.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[Qe.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Qe.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Qe.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Qe.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Qe.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Qe.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Qe.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Qe.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Qe.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Qe.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Qe.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Qe.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Qe.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Qe.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Qe.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Qe.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Qe.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Qe.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Qe.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Qe.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Qe.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Qe.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Qe.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Qe.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Qe.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Qe.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Qe.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Qe.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Qe.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Qe.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Qe.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Qe.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Qe.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Qe.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Qe.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Qe.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Qe.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Qe.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Qe.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Qe.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Qe.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Qe.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Qe.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Qe.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Qe.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Qe.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Qe.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Qe.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function zc(e){return H7[e]||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function xD(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function D_(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?xD(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):xD(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}function k_(e,t){if(typeof e=="string")return e;const{proxy:s,host:n,port:r}=e;if(t){const i=C("JOIN_GATEWAY_FALLBACK_PORT")||443;return i===443?"wss://".concat(n,"/ws/?p=").concat(Number(r)+150):"wss://".concat(n,":").concat(i,"/ws/?p=").concat(Number(r)+150)}return s?"wss://".concat(s,"/ws/?h=").concat(n,"&p=").concat(r):"wss://".concat(n,":").concat(r)}const z7=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,K7=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Y7=/wss:\/\/(.+):([0-9]+)\/?/,q7=/wss:\/\/(.[^\/]+)\/?/;let X7=0;class J7{constructor(t,s){N(this,"id",0),N(this,"store",void 0),N(this,"recordIndex",void 0),N(this,"websockets",[]),N(this,"try443PortDuration",2e3),N(this,"forceCloseWSDuration",5e3),N(this,"try443PortTimeout",null),N(this,"forceCloseTimeout",null),N(this,"isTry443PortFailed",!1),N(this,"isNormalPortFailed",!1),N(this,"useDoubleDomain",!1),N(this,"useProxy",!1),N(this,"startTime",Date.now()),this.id=++X7,this.try443PortDuration=C("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=s}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var t;const s=Date.now()-this.startTime;for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];b.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(s,"ms:"),...r)}createWebSocket(t,s,n){this.logger("createWebSocket:",t,{isTry443Port:s,hasTimeoutDetection:n});const r=C("GATEWAY_DOMAINS"),i=Date.now(),o=[],c=r.find(m=>{var g;return _e(g=t.host).call(g,m)});c||(this.useDoubleDomain=!1);const l=[];if(this.useDoubleDomain)r.forEach(m=>{l.push(k_(D_(D_({},t),{},{host:t.host.replace(c,m)}),s))});else{const m=D_({},t);if(s&&c){const g=r.find(T=>T!==c);g&&(m.host=m.host.replace(c,g))}l.push(k_(m,s))}try{l.forEach(m=>{const g=new WebSocket(m);g.binaryType="arraybuffer",o.push(g),this.logger("ws is connecting:",g.url)})}catch(m){if(this.logger("ws create failed"),o.forEach(g=>g.close()),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,s,n);if(!s&&Number(t.port)!==443)return this.createWebSocket(t,!0,n);throw new $(A.WS_ERR,"init websocket failed! Error: ".concat(m.toString()))}const d=ju();this.store&&this.store.recordJoinChannelService({urls:o.map(m=>m.url),service:"gateway"},this.recordIndex),o.forEach(m=>{m.onopen=()=>{this.logger("onopen: ws ".concat(m.url," open cost ").concat(Date.now()-i,"ms")),this.websockets.forEach(g=>{g!==m&&(g.onopen=null,g.onclose=null,g.onmessage=null,g.close(),this.logger("close backup websocket: ".concat(g.url)))}),this.websockets.length=0,d.resolve(m)},m.onclose=g=>{this.logger("onclose: ws ".concat(m.url," closed cost ").concat(Date.now()-i,"ms state: ").concat(m.readyState));const T=o.every(w=>w.readyState===WebSocket.CLOSED||w.readyState===WebSocket.CLOSING);this.logger("".concat(s?"443":"47xx"," websocket closed, all failed: ").concat(T)),T&&(s||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(g.reason)),d.reject({code:g.code,reason:qm.A_ROUND_WS_FAILED})):!s&&T&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),p()),s?this.isTry443PortFailed=T:this.isNormalPortFailed=T},m.onmessage=g=>this.logger("".concat(m.url," onmessage: ").concat(g.data))}),this.websockets.push(...o);const h=()=>{this.websockets.forEach(m=>m.readyState!==WebSocket.OPEN&&m.close())},p=()=>{if(d.isResolved)return h();Ft().os===fn.MAC_OS&&bs()&&h(),this.createWebSocket(t,!0,!0).then(m=>{d.resolve(m)}).catch(m=>{this.isNormalPortFailed&&d.reject(m),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,h()},this.forceCloseWSDuration)};return n||(()=>{if(s||this.useProxy)return this.logger("add 5s timeout at ".concat(s?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,h()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,p()},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(t,s,n,r){return this.useDoubleDomain=!!s,typeof t=="string"&&(t=function(i){let o,c,l;return[,o,c,l]=i.match(z7)||[],o||([,c,l]=i.match(K7)||[]),c&&l||([,c,l]=i.match(Y7)||[]),c&&l||([,c]=i.match(q7)||[]),c||b.warning("un-destructible url: ",i),{proxy:o,host:c,port:l||"443"}}(t)),this.recordIndex=r,this.useProxy=!!t.proxy,n&&this.useProxy&&(b.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(t,!!n,!1).finally(()=>this.clearTimeout())}}function bD(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}class _D extends Cs{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var s;_e(s=["tryNext","recover"]).call(s,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(bt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(bt.CONNECTED):this._state==="closed"?this.emit(bt.CLOSED):this._state==="failed"&&this.emit(bt.FAILED))}resetReconnectCount(t){b.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,s){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],i=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),N(this,"_websocketUrl",null),N(this,"connectionID",0),N(this,"currentURLIndex",0),N(this,"urls",[]),N(this,"_reconnectMode","tryNext"),N(this,"reconnectReason",void 0),N(this,"_initMutex",void 0),N(this,"name",void 0),N(this,"_state","closed"),N(this,"reconnectInterrupter",void 0),N(this,"websocket",void 0),N(this,"retryConfig",void 0),N(this,"reconnectCount",0),N(this,"forceCloseTimeout",5e3),N(this,"onlineReconnectListener",void 0),N(this,"useCompress",void 0),N(this,"tryDoubleDomain",!1),N(this,"use443PortOnly",!1),N(this,"wsInflateLength",0),N(this,"wsDeflateLength",0),N(this,"closeEstablishingWs",()=>{}),N(this,"store",void 0),N(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=function(p){for(var m=1;m<arguments.length;m++){var g=arguments[m]!=null?arguments[m]:{};m%2?bD(Object(g),!0).forEach(function(T){N(p,T,g[T])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(g)):bD(Object(g)).forEach(function(T){Object.defineProperty(p,T,Object.getOwnPropertyDescriptor(g,T))})}return p}({},s),this.useCompress=n,this.tryDoubleDomain=r,this.use443PortOnly=i,this._initMutex=new wn("websocket",o?o.clientId:void 0);const{timeout:c,timeoutFactor:l}=s,d=Math.max(300,Math.floor(3*c/5)),h=Math.max(1.2,Math.floor(8*l)/10);ua.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=h),Ps.on(Ic.NETWORK_STATE_CHANGE,(p,m)=>{p!==m&&(this.resetReconnectCount("network state change: ".concat(m," -> ").concat(p)),p===ua.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=h):(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l))})}getConnection(){return this.websocket||void 0}async init(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=s,this.urls=t,this.state="connecting";try{var r;const i=ju(),o=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),function(c){return!(Cm()||C("USE_NEW_TOKEN")||!C("ENABLE_PREALLOC_PC")&&(c==null||!c.autoSubscribe||C("FORCE_DISABLE_AUTO_SUB")))}(this.store)&&this.emit(rn.PRE_CONNECT_PC),this.createWebSocketConnection(o).then(i.resolve).catch(i.reject),this.once(bt.CLOSED,()=>{i.reject(new se(A.WS_DISCONNECT))}),this.once(bt.CONNECTED,i.resolve),await i.promise}catch{}finally{n()}}close(t,s){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const n=this.websocket;s?setTimeout(()=>n.close(),500):n.close(),this.websocket=void 0,this._websocketUrl=null}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,s){if(!this.websocket)return void b.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),b.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(s)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:s})}sendMessage(t){let s=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new se(A.WS_ABORT,"websocket is not ready");try{s||(t=JSON.stringify(t)),this.websocket.send(t)}catch(n){throw new se(A.WS_ERR,"send websocket message error"+n.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,s=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:s}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var s;const n=ju();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=h=>{var p;(p=this.store)===null||p===void 0||p.signalChannelOpen(),b.debug("[".concat(this.name,"] websocket opened:"),h),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},i=async h=>{var p;if(b.debug("[".concat(this.name,"] websocket close ").concat((p=this.websocket)===null||p===void 0?void 0:p.url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new se(A.WS_DISCONNECT,"websocket close: ".concat(h.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const m=Ua(this,bt.WILL_RECONNECT,this.reconnectMode,h.reason)||this.reconnectMode,g=await this.reconnectWithAction(m);if(this.state==="closed")return void b.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!g)return n.reject(new se(A.WS_DISCONNECT,"websocket reconnect failed: ".concat(h.code))),this.close(!0);n.resolve()}},o=h=>{this.emit(bt.ON_MESSAGE,h)},c=h=>{b.warn("[".concat(this.connectionID,"] ws open error ").concat(h))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),C("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=C("GATEWAY_WSS_ADDRESS")),b.debug("[".concat(this.name,"] start connect, url:"),t);const l=(s=this.store)===null||s===void 0?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=k_(t);const h=await this.chooseBestWebsocketConnection(t);this.websocket=h,r&&r(this.websocket.url),this.websocket.onclose=i,this.websocket.onmessage=o,this.websocket.onerror=c,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},l),this.joinGatewayRecordIndex=l}catch(h){const p=this.state==="closed",m=h instanceof se,g=m&&h.code===A.WS_ABORT,T=m&&h.code===A.WS_ERR,w=m?h.message:h&&(h.reason||h.toString());b.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(w)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:g?"aborted":"error",errors:[h]},l),p||T?(n.reject(p?new se(A.WS_DISCONNECT,"websocket is closed: ".concat(w)):new se(A.WS_ERR,"init websocket failed: ".concat(w))),T&&b.error("[".concat(this.name,"] init websocket failed: ").concat(w))):i&&i(h)}return n.promise}async reconnectWithAction(t){let s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;b.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||Ps.isOnline||!Ps.onlineWaiter||(this.onlineReconnectListener=Ps.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let n=!0;if(this.reconnectInterrupter=()=>n=!1,s){const o=vm(this.reconnectCount,this.retryConfig);b.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(t)),await Te.race([gn(o),this.onlineReconnectListener||new Te(()=>{})])}if(this._state==="closed"||!n)return!1;this.reconnectCount+=1;const r=async(o,c)=>{this.emit(bt.RECONNECT_CREATE_CONNECTION,c),await this.createWebSocketConnection(o)};try{if(t==="retry")await r(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);b.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],t)}else t==="recover"&&(b.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await Qs(this,bt.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],t))}catch(o){var i;b.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const c=o==null||(i=o.data)===null||i===void 0?void 0:i.desc;if(Array.isArray(c)){if(_e(c).call(c,"dynamic key expired"))return this.emit(bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(_e(c).call(c,"request downgrade fallback"))return this.emit(bt.ON_FALLBACK),!1}return this.reconnectWithAction(t,s)}return!0}}class j_ extends _D{constructor(t,s){super(t,s,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,s){const n=ju(),r=function(o,c){return new J7(o,c)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{b.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),n.reject(new se(A.WS_ABORT,"choose best websocket aborted"))};const i=C("GATEWAY_DOMAINS");return b.debug("[choose-best-ws] currentDomain: ",t,", domains: ",i,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,s).then(n.resolve).catch(n.reject),n.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Yu extends _D{constructor(t,s){super(t,s,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,s){return new Te((n,r)=>{let i=!1;const o=[];this.closeEstablishingWs=()=>{b.debug("[choose-best-ws] close establishing websockets"),o.forEach(T=>{T.onclose=null,T.onopen=null,T.onmessage=null,T.close()}),r(new se(A.WS_ABORT,"choose best websocket aborted"))};const c=C("GATEWAY_DOMAINS");let l;const d=t.indexOf("?h="),h=c.find(T=>d!==-1?_e(t).call(t,T,d):_e(t).call(t,T));b.debug("[choose-best-ws] currentDomain: ",h,", domains: ",c);let p=!this.tryDoubleDomain||!h;if(!p&&h){var m;const T=Date.now();try{c.forEach(w=>{const S=d===-1?t.replace(h,w):t.substr(0,d)+t.substr(d).replace(h,w),I=new WebSocket(S);I.binaryType="arraybuffer",o.push(I),b.debug("[choose-best-ws] ws is connecting:",I.url)})}catch{for(b.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach(S=>S.close());o.length;)o.pop();p=!0}(m=this.store)===null||m===void 0||m.recordJoinChannelService({urls:o.map(w=>w.url),service:"gateway"},s),o.forEach(w=>{w.onopen=()=>{if(i)return;const S=Date.now()-T;b.debug("[choose-best-ws] ws open cost ".concat(S,"ms")),o.filter(I=>I!==w).forEach(I=>{b.debug("[choose-best-ws]close backup websocket: ".concat(I.url)),I.close()}),i=!0,n(w)},w.onclose=S=>{l=S,!i&&(o.find(I=>!(I.readyState===WebSocket.CLOSED||I.readyState===WebSocket.CLOSING))||(b.debug("[choose-best-ws] all websocket is closed"),i=!0,r(l)))},w.onmessage=S=>{b.debug("[choose-best-ws]".concat(w.url," onmessage: ").concat(S.data))}}),gn(this.forceCloseTimeout).then(()=>{o.forEach(w=>{w.readyState!==WebSocket.OPEN&&w.close()})})}if(p){var g;let T;b.debug("[choose-best-ws] use single url: ",t),(g=this.store)===null||g===void 0||g.recordJoinChannelService({urls:[t],service:"gateway"},s);try{T=new WebSocket(t),o.push(T),T.binaryType="arraybuffer"}catch(w){const S=new se(A.WS_ERR,"init websocket failed! Error: ".concat(w.toString()));return b.error("[".concat(this.name,"]").concat(S)),void r(S)}T.onopen=()=>{n(T)},T.onclose=w=>{r(w)},T.onmessage=w=>{b.debug("[choose-best-ws]".concat(T.url," onmessage: ").concat(w.data))},gn(this.forceCloseTimeout).then(()=>{T&&T.readyState!==WebSocket.OPEN&&T.close()})}}).then(n=>(this.closeEstablishingWs=void 0,n)).catch(n=>{throw this.closeEstablishingWs=void 0,n})}}class vD extends Cs{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===jt.CONNECTED?this.emit(Ge.WS_CONNECTED):t===jt.RECONNECTING?this.emit(Ge.WS_RECONNECTING,this._websocketReconnectReason):t===jt.CLOSED&&this.emit(Ge.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,s){super(),N(this,"__name__","AgoraRTCSignal"),N(this,"_disconnectedReason",void 0),N(this,"_websocketReconnectReason",void 0),N(this,"_connectionState",jt.CLOSED),N(this,"reconnectToken",void 0),N(this,"websocket",void 0),N(this,"openConnectionTime",void 0),N(this,"clientId",void 0),N(this,"lastMsgTime",Date.now()),N(this,"uploadCache",[]),N(this,"uploadCacheInterval",void 0),N(this,"rttRolling",new Fb(5)),N(this,"pingpongTimer",void 0),N(this,"wsInflateDataTimer",void 0),N(this,"pingpongTimeoutCount",0),N(this,"ortc",void 0),N(this,"joinResponse",void 0),N(this,"multiIpOption",void 0),N(this,"initError",void 0),N(this,"spec",void 0),N(this,"store",void 0),N(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(Ge.ON_BINARY_DATA,n.data);const r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const i="res-@".concat(r._id);this.emit(i,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(kt.UID_BANNED);break;case 15:this.close(kt.IP_BANNED);break;case 16:this.close(kt.CHANNEL_BANNED)}if(r._type===ut.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Qe.ERR_LICENSE_MISSING:this.close(kt.LICENSE_MISSING);break;case Qe.ERR_LICENSE_EXPIRED:this.close(kt.LICENSE_EXPIRED);break;case Qe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(kt.LICENSE_MINUTES_EXCEEDED);break;case Qe.ERR_LICENSE_PERIOD_INVALID:this.close(kt.LICENSE_PERIOD_INVALID);break;case Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(kt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Qe.ERR_LICENSE_ILLEGAL:this.close(kt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=s,this.websocket=new j_("gateway-".concat(this.clientId),this.spec.retryConfig,!0,C("JOIN_GATEWAY_USE_DUAL_DOMAIN"),C("JOIN_GATEWAY_USE_443PORT_ONLY"),s),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===jt.CONNECTED&&this.reconnect("retry",Mn.OFFLINE)})}async request(t,s,n,r){const i=Jt(6,""),o={_id:i,_type:t,_message:s},c=this.websocket.connectionID,l=()=>new Te((T,w)=>{if(this.connectionState===jt.CONNECTED)return T();const S=()=>{this.off(Ge.WS_CLOSED,I),T()},I=()=>{this.off(Ge.WS_CONNECTED,S),w(new $(A.WS_ABORT))};this.once(Ge.WS_CONNECTED,S),this.once(Ge.WS_CLOSED,I),t!==qe.PUBLISH&&t!==qe.PUBLISH_DATASTREAM&&t!==qe.SUBSCRIBE&&t!==qe.SUBSCRIBE_DATASTREAM&&t!==qe.UNSUBSCRIBE&&t!==qe.UNSUBSCRIBE_DATASTREAM&&t!==qe.UNPUBLISH&&t!==qe.UNPUBLISH_DATASTREAM&&t!==qe.CONTROL&&t!==qe.RESTART_ICE||this.once(Ge.DISCONNECT_P2P,()=>{w(new $(A.DISCONNECT_P2P))}),t!==qe.PUBLISH&&t!==qe.RESTART_ICE||this.once(Ge.ABORT_P2P_EXECUTION,()=>{w(new $(A.DISCONNECT_P2P))})});if(this.connectionState!==jt.CONNECTING&&this.connectionState!==jt.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await l(),this.websocket.sendMessage(o,!0),r)return;const d=new Te((T,w)=>{let S=!1;const I=(M,z)=>{S=!0,T({isSuccess:M==="success",message:z||{}}),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.emit(Ge.REQUEST_SUCCESS,t,s)};this.once("res-@".concat(i),I);const O=()=>{w(new $(A.WS_ABORT,"type: ".concat(t))),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.off("res-@".concat(i),I)};this.once(Ge.WS_CLOSED,O),this.once(Ge.WS_RECONNECTING,O),gn(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||S||(b.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Ge.REQUEST_TIMEOUT,t,s))})});let h=null;try{h=await d}catch(T){if(this.connectionState===jt.CLOSED||t===qe.LEAVE)throw new $(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():t===qe.JOIN||t===qe.REJOIN?null:(await l(),await this.request(t,s))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),m=zc(p),g=new $(A.UNEXPECTED_RESPONSE,"".concat(m.desc,": ").concat(h.message.error_str),{code:p,data:h.message,desc:m.desc});return m.action==="success"?h.message:(b.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(m.desc,", action: ").concat(m.action)),p===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=g,this.close()),g.throw()):m.action==="failed"?g.throw():m.action==="quit"?(this.initError=g,this.close(),g.throw()):(p===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Mn.MULTI_IP)):this.reconnect(m.action,Mn.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,s)))}waitMessage(t,s){return new Te(n=>{const r=i=>{(!s||s(i))&&(this.off(t,r),n(i))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void b.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const s={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,s)}upload(t,s){const n={_type:t,_message:s};try{this.websocket.sendMessage(n)}catch{const i=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>i&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==jt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,s){const n={_type:t,_message:s};this.websocket.sendMessage(n)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Te((s,n)=>{this.once(Ge.WS_CONNECTED,()=>s(this.joinResponse)),this.once(Ge.WS_CLOSED,r=>n(this.initError||new $(A.WS_ABORT,r))),this.connectionState=jt.CONNECTING,this.websocket.init(t).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||kt.LEAVE,this.connectionState=jt.CLOSED,b.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(Ge.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await Qs(this,Ge.REQUEST_JOIN_INFO);this.store.joinReq();const s=await this.request(qe.JOIN,t);if(this.ortc=t==null?void 0:t.ortc,this.store.joinRep(),!s)return this.emit(Ge.REPORT_JOIN_GATEWAY,qm.TIMEOUT,this.url||""),!1;this.joinResponse=s,this.emit(Ge.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new $(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Ac(this,Ge.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const s=await this.request(qe.REJOIN,t);return!!s&&(this.connectionState=jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),s.peers&&s.peers.forEach(n=>{this.emit(ut.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(ut.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(ut.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(ut.MUTE_AUDIO,{uid:n.uid}):this.emit(ut.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(ut.MUTE_VIDEO,{uid:n.uid}):this.emit(ut.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(ut.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(ut.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(ut.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(t,s){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,s)}async downgradeCodec(t){if(!this.ortc)return!1;const s={downgrade_codec:t,ortc:this.ortc};return!!await this.request(qe.DOWNGRADE_CODEC,s)}handleNotification(t){b.debug("[".concat(this.clientId,"] receive notification: "),t);const s=zc(t.code);if(t.code===28&&"detail"in t&&(b.info("[".concat(this.clientId,"] receive recover notification: "),t.detail),this.emit(Ge.RECOVER_NOTIFICATION,t.detail)),s.action!=="success"){if(s.action!=="failed")return s.action==="quit"?t.code===Qe.ERR_REPEAT_JOIN_CHANNEL&&C("IGNORE_UID_CHECK")?void this.close(kt.UID_CONFLICT):(s.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(kt.UID_BANNED),void this.close()):t.code===Qe.K_VOS_FALLBACK&&"detail"in t?(b.info("[".concat(this.clientId,"] receive vos fallback notification: "),t.detail),t.detail==="FALLBACKCN"&&C("ENABLE_QUALITY_FALLBACK")?void Qs(this,Ge.VOS_FALLBACK_PROMISE,t.detail).then(()=>{this.reconnect("recover",s.desc)}).catch(n=>{b.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),n)}):t.detail==="fallback_hls"&&C("ENABLE_FALLBACK_TO_HLS")?(this.emit(Ge.VOS_FALLBACK,t.detail),void this.close(kt.FALLBACK_TO_HLS)):this.reconnect(s.action,s.desc)):void this.reconnect(s.action,Mn.SERVER_ERROR);b.error("[".concat(this.clientId,"] ignore error: "),s.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=C("PING_PONG_TIME_OUT"),s=Date.now();this.pingpongTimeoutCount>=t&&(b.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(s-this.lastMsgTime,"ms")),s-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Mn.TIMEOUT):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-s;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:s}=this.websocket.getWsInflateData();t!==0&&s!==0&&this.upload(Hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:s,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(bt.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ge.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(bt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(bt.CLOSED,()=>{this.connectionState=jt.CLOSED}),this.websocket.on(bt.FAILED,()=>{this._disconnectedReason=kt.NETWORK_ERROR,this.connectionState=jt.CLOSED}),this.websocket.on(bt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===jt.CONNECTED?this.connectionState=jt.RECONNECTING:this.connectionState=jt.CONNECTING}),this.websocket.on(bt.WILL_RECONNECT,(t,s,n)=>{const r=Ac(this,Ge.IS_P2P_DISCONNECTED),i=r||t!=="retry";r&&t==="retry"&&(b.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",s=qm.P2P_DISCONNECTED),i&&(b.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(Ge.REPORT_JOIN_GATEWAY,s||qm.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Ge.DISCONNECT_P2P)),n(t)}),this.websocket.on(bt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{b.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Mn.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(Ge.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof $){if(t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return this.initError=new $(A.TOKEN_EXPIRE,"dynamic key expired"),void this.close(kt.TOKEN_EXPIRE);b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Mn.SERVER_ERROR):(this.initError=t,this.close())}})}),this.websocket.on(bt.REQUEST_NEW_URLS,(t,s)=>{Qs(this,Ge.REQUEST_RECOVER,this.multiIpOption).then(t).catch(s)}),this.websocket.on(bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(rn.PRE_CONNECT_PC,()=>{this.emit(Ge.PRE_CONNECT_PC)}),this.websocket.on(bt.ON_FALLBACK,()=>{C("ENABLE_FALLBACK_TO_HLS")&&this.emit(Ge.VOS_FALLBACK,"fallback_hls")})}}let $7=function(e){return e.NATIVE_RTC="native_rtc",e.NATIVE_RTM="native_rtm",e.WEB_RTC="web_rtc",e.WEB_RTM="web_rtm",e}({}),qs=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function ED(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function $m(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?ED(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ED(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let P_=0;function Ur(e){const t=C("TURN_DOMAINS");P_=(P_+1)%t.length;const s=t[P_]||"edge.agora.io";return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(s):(b.debug("Cannot recognized as ip address: ".concat(e,", use as host2")),e)}function Qm(e){try{const t=C("TURN_DOMAINS"),s=C("GATEWAY_DOMAINS").concat(t).find(n=>_e(e).call(e,n));return s?e.split(".".concat(s))[0].replace(/-/g,"."):e}catch{return b.debug("serverUrlToIp error, fallback to url",e),e}}function L_(e,t){e.addresses||(e.addresses=[]);const s=function(c,l){if(C("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return c.map(p=>{let{ip:m,port:g}=p;return{address:"".concat(m,":").concat(g)}});const d=C("GATEWAY_DOMAINS");let h=d[1]&&_e(l).call(l,d[1])?1:0;return c.map(p=>{let{domain_prefix:m,port:g,ip:T}=p;if(m)return{address:"".concat(m,".").concat(d[h++%d.length],":").concat(g)};const w=/^[\.\:\d]+$/.test(T),S=w?"".concat(T.replace(/[^\d]/g,"-"),".").concat(d[h++%d.length],":").concat(g):"".concat(T,":").concat(g);return w||b.debug("Cannot recognized as ip address: ".concat(T,", use as host3")),{ip:T,port:g,address:S}})}(e.addresses,t),n=Array.isArray(e.detail)&&e.detail[18];if(n&&typeof n=="string"){const c=n.split(";");for(let l=0;l<c.length;l++){var r;const d=la(r=c[l]).call(r);s[l]&&d&&(s[l].ip6=d)}}const i=e.detail&&e.detail.candidate;let o;if(i){const[c,l]=i.split(":");c&&l&&(o={port:Number(l),ip:c,address:"".concat(c,":").concat(l)})}return{gatewayAddrs:s,apGatewayAddress:o,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function ya(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function yD(e){const t=e._encoderConfig;if(!t)return{};const s={resolution:t.width&&t.height?"".concat(ya(t.width),"x").concat(ya(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(s.maxFrameRate=t.frameRate,s.minFrameRate=t.frameRate):t.frameRate&&(s.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,s.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),s}function Zm(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function qu(e,t){let s,n,r;switch(t){case qs.CHOOSE_SERVER:n=4096,r="choose server";break;case qs.CLOUD_PROXY:n=1048576,r="proxy";break;case qs.CLOUD_PROXY_5:n=4194304,r="proxy5";break;case qs.CLOUD_PROXY_FALLBACK:n=4194310,r="proxy fallback";break;default:throw new $(A.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach(i=>{i.buffer&&i.buffer.flag===n&&(s={code:i.buffer.code,addresses:(i.buffer.edges_services||[]).map(o=>$m($m({},o),{},{ticket:i.buffer.cert})),server_ts:e.enter_ts,uid:i.buffer.uid,cid:i.buffer.cid,cname:i.buffer.cname,detail:$m($m({},i.buffer.detail),e.detail),flag:i.buffer.flag,opid:e.opid,cert:i.buffer.cert})}),!s)throw new $(A.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return s}async function wD(e,t){return await Te.all(e.addresses.map(async s=>({address:Ur(s.ip),tcpport:s.port,udpport:s.port,username:t&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Un.username,password:t&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await kb(t.toString()):Un.password})))}function M_(e,t){const s=t.getMediaStreamTrack(!0).getSettings(),n=t.videoHeight||s.height,r=t.videoWidth||s.width;return n&&r?Math.max(Math.min(n,r)/Math.min(ya(e.height),ya(e.width)),1):(b.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function zo(e){let{candidateType:t,relayProtocol:s,type:n,address:r,port:i,protocol:o}=e;const c={candidateType:t,relayProtocol:s,protocol:o};if(n!=="local-candidate"){const l=r.split(".");l.length>=4&&(l[1]="*",l[2]="*"),c.address=l.join("."),c.port=i}return c}function ki(e){const t=e.split(":"),s=e.split(/[-.]/),n=_e(e).call(e,"-")?"-":".";let r=e;return t.length>1?s.length>1?(s[1]="**",r=s[0]+n+"**:"+t[t.length-1]):r=t.length>2?t[0]+n+"**:"+t[t.length-1]:"**:"+t[t.length-1]:s.length>1&&(r=s[0]+n+"**"),r}function SD(e,t){return e.getTransceivers().find(s=>s.sender.track===t||s.receiver.track===t)}function Xu(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:C("SVC_MODE");if(C("ENABLE_SVC"))return function(t){return t in wm}(e)?e:wm.L1T3}const ND={[Le.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[Le.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function TD(e){e.send&&(_d(Le.VIDEO,e.send.videoExtensions),_d(Le.AUDIO,e.send.audioExtensions)),e.recv&&(_d(Le.VIDEO,e.recv.videoExtensions),_d(Le.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(_d(Le.VIDEO,e.sendrecv.videoExtensions),_d(Le.AUDIO,e.sendrecv.audioExtensions))}function RD(e,t){e.send&&(ef(Le.VIDEO,e.send.videoExtensions,t.send.videoExtensions),ef(Le.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(ef(Le.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),ef(Le.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function ef(e,t,s){t.forEach(n=>{var r;const i=ND[e].find(c=>{var l;let{key:d}=c;return _e(l=n.extensionName).call(l,d)});if(!i)return;const o=s.find(c=>{let{extensionName:l}=c;return _e(l).call(l,i.key)});o&&_e(r=o.extensionName).call(r,"gdpr_forbidden")&&(n.extensionName=o.extensionName)})}function _d(e,t){t.forEach(s=>{var n;const r=ND[e].find(i=>{var o;let{key:c}=i;return _e(o=s.extensionName).call(o,c)});_e(n=s.extensionName).call(n,"gdpr_forbidden")&&r&&(s.extensionName=r.extensionName)})}function CD(e){return e==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||_e(e).call(e,"abs-send-time")}function tf(e){return e==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||_e(e).call(e,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function ID(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function AD(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?ID(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ID(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}function Ju(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:i,filterAudioFec:o,filterAudioCodec:c,filterVideoCodec:l,unsupportedVideoUplinkCodec:d,unsupportedVideoDownlinkCodec:h}=t,{useXR:p}=s;let m=[],g=[],T=[],w=[],S=!1,I=!1;if(ha(e).mediaDescriptions.forEach(M=>{n&&n!==M.attributes.direction||(M.media.mediaType!=="video"||S||(g=M.attributes.payloads,w=M.attributes.extmaps,S=!0),M.media.mediaType!=="audio"||I||(m=M.attributes.payloads,T=M.attributes.extmaps,I=!0))}),!w||g.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!T||m.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(g.forEach(M=>{var z;(z=M.rtpMap)!==null&&z!==void 0&&z.clockRate&&(M.rtpMap.clockRate=parseInt(M.rtpMap.clockRate)),p&&M.rtcpFeedbacks.push({type:"rrtr"})}),m.forEach(M=>{var z;(z=M.rtpMap)!==null&&z!==void 0&&z.clockRate&&(M.rtpMap.clockRate=parseInt(M.rtpMap.clockRate)),p&&M.rtcpFeedbacks.push({type:"rrtr"})}),r&&(m=m.filter(M=>{var z;return((z=M.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())!=="rtx"}),g=g.filter(M=>{var z;return((z=M.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())!=="rtx"})),i){const M=g.filter(V=>{var Y;return/(red)|(ulpfec)|(flexfec)/i.test(((Y=V.rtpMap)===null||Y===void 0?void 0:Y.encodingName)||"")}),z=Ko(M,g).map(V=>V.payloadType),K=[...M.map(V=>V.payloadType),...z];g=g.filter(V=>!_e(K).call(K,V.payloadType))}if(o&&(m=m.filter(M=>{var z;return!/(red)|(ulpfec)|(flexfec)/i.test(((z=M.rtpMap)===null||z===void 0?void 0:z.encodingName)||"")})),c&&(c==null?void 0:c.length)>0&&(m=m.filter(M=>{var z;return _e(c).call(c,((z=M.rtpMap)===null||z===void 0?void 0:z.encodingName.toLowerCase())||"")})),l&&(l==null?void 0:l.length)>0){const M=g.filter(z=>{var K;return _e(l).call(l,((K=z.rtpMap)===null||K===void 0?void 0:K.encodingName.toLowerCase())||"")});g=M.concat(r?[]:Ko(M,g))}const O=C("UNSUPPORTED_VIDEO_CODEC");if(O&&O.length>0){const M=g.filter(V=>V.rtpMap&&_e(O).call(O,V.rtpMap.encodingName.toLowerCase())),z=Ko(M,g),K=M.concat(z).map(V=>V.payloadType);g=g.filter(V=>!_e(K).call(K,V.payloadType)),b.debug("unsupportedVideoCodec: ".concat(O,", toBeRemoved: ").concat(K))}if(d&&d.length>0&&n==="sendonly"){const M=g.filter(V=>V.rtpMap&&_e(d).call(d,V.rtpMap.encodingName.toLowerCase())),z=Ko(M,g),K=M.concat(z).map(V=>V.payloadType);g=g.filter(V=>!_e(K).call(K,V.payloadType)),b.debug("unsupportedVideoUplinkCodec: ".concat(d,", toBeRemoved: ").concat(K))}if(h&&h.length>0&&n==="recvonly"){const M=g.filter(V=>V.rtpMap&&_e(h).call(h,V.rtpMap.encodingName.toLowerCase())),z=Ko(M,g),K=M.concat(z).map(V=>V.payloadType);g=g.filter(V=>!_e(K).call(K,V.payloadType)),b.debug("unsupportedVideoDownlinkCodec: ".concat(h,", toBeRemoved: ").concat(K))}return{audioCodecs:m,videoCodecs:g,audioExtensions:T,videoExtensions:w}}function ji(e){const t=ha(e);let s,n;for(const r of t.mediaDescriptions){if(!s){const i=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!i||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");s={iceUfrag:i,icePwd:o}}if(!n){const i=r.attributes.fingerprints;i.length>0&&(n={fingerprints:i})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!s)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:s,dtlsParameters:n}}function U_(e,t){const s=[],n=e.attributes.ssrcGroups.filter(o=>o.semantic==="FID"),r=e.attributes.ssrcGroups.find(o=>o.semantic==="SIM"),i=e.attributes.ssrcs;if(r)r.ssrcIds.forEach(o=>{var c;const l=(c=n.find(d=>d.ssrcIds[0]===o))===null||c===void 0?void 0:c.ssrcIds[1];s.push({ssrcId:o,rtx:t?l:void 0})});else if(n.length>0){const o=n[0].ssrcIds[0],c=n[0].ssrcIds[1];s.push({ssrcId:o,rtx:t?c:void 0})}else{if(i.length===0)throw new Error("No ssrcs found on local media description.");s.push({ssrcId:i[0].ssrcId})}return s}function OD(e,t,s){const{cname:n}=e;let r=[];t&&(r=DD(t)),r.length===0&&(r=e.iceParameters.candidates.map(h=>({foundation:h.foundation,componentId:"1",transport:h.protocol,priority:h.priority.toString(),connectionAddress:h.ip,port:h.port.toString(),type:h.type,extension:{}})),b.debug("Using candidates from gateway."));const i={fingerprints:e.dtlsParameters.fingerprints.map(h=>({hashFunction:h.algorithm,fingerprint:h.fingerprint}))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let c;switch(e.dtlsParameters.role){case"server":c="passive";break;case"client":c="active";break;case"auto":c="actpass"}const l=Qu(e.rtpCapabilities),d=[];return Array.isArray(s)&&s.length>0&&s.forEach(h=>{d.push({kind:Le.VIDEO,ssrcMsg:[{ssrcId:h.v,rtx:h.v_rtx}],mslabel:"".concat(h.v,"_").concat(h.a)},{kind:Le.AUDIO,ssrcMsg:[{ssrcId:h.a}],mslabel:"".concat(h.v,"_").concat(h.a)})}),{dtlsParameters:i,iceParameters:o,candidates:r,rtpCapabilities:l,setup:c,cname:n,preSSRCs:d}}function DD(e){let t=[];return e.ip&&typeof e.port=="number"&&(t=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],b.debug("Using remote candidate from AP ".concat(ki(e.ip),":").concat(e.port)),e.ip6&&(t.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),b.debug("Using IPV6 remote candidate from AP ".concat(ki(e.ip6),":").concat(e.port)))),t}function $u(e,t,s){const n=[],r=[];return e.forEach(i=>{let{ssrcId:o,rtx:c}=i;const l=Jt(8,"track-"),d={ssrcId:o,attributes:AD({label:l,mslabel:s=s||Jt(10,""),msid:"".concat(s," ").concat(l)},t&&{cname:t})};if(n.push(d),c!==void 0){const h={ssrcId:c,attributes:AD({label:l,mslabel:s,msid:"".concat(s," ").concat(l)},t&&{cname:t})};n.push(h),r.push({semantic:"FID",ssrcIds:[o,c]})}}),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map(i=>{let{ssrcId:o}=i;return o})}),{ssrcs:n,ssrcGroups:r}}function Kc(e,t){t instanceof Us&&e.attributes.payloads.forEach(s=>{var n;const r=(n=s.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;s.fmtp||(s.fmtp={parameters:{}}),r==="opus"&&typeof C("OPUS_PTIME")=="number"?s.fmtp.parameters.ptime=C("OPUS_PTIME"):s.fmtp.parameters.minptime="10",s.fmtp.parameters.useinbandfec="1";const i=t._encoderConfig;i&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(i.bitrate&&!bs()&&(s.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*i.bitrate))),i.sampleRate&&(s.fmtp.parameters.maxplaybackrate="".concat(i.sampleRate),s.fmtp.parameters["sprop-maxcapturerate"]="".concat(i.sampleRate)),i.stereo&&(s.fmtp.parameters.stereo="1",s.fmtp.parameters["sprop-stereo"]="1")),t instanceof zu&&r==="opus"&&t._config.DTX&&(s.fmtp.parameters.usedtx="1"))})}function V_(e){const t=e.attributes.unrecognized.findIndex(s=>s.attField==="x-google-flag"&&s.attValue==="conference");t!==-1&&e.attributes.unrecognized.splice(t,1)}function F_(e,t){var s;if(e.attributes.payloads.forEach(r=>{var i;((i=r.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&C("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),!(t instanceof os&&t._encoderConfig&&t._hints.indexOf(qt.SCREEN_TRACK)===-1))return;const n=t._encoderConfig;At().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach(r=>{var i,o;_e(i=["h264","h265","vp8","vp9","av1"]).call(i,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))}),At().supportMinBitrate&&!_e(s=t._hints).call(s,qt.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach(r=>{var i,o;_e(i=["h264","h265","vp8","vp9","av1"]).call(i,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(C("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))})}function kD(e){if(e.media.mediaType!=="video")return;const t=Ft();if(t.name!==Wt.SAFARI&&t.os!==fn.IOS)return;const s=e.attributes.extmaps.findIndex(n=>/video-orientation/g.test(n.extensionName));s!==-1&&e.attributes.extmaps.splice(s,1)}function sf(e,t,s){if(!t)return;let n,r;if(e.media.mediaType==="video"?(n=s.videoExtensions,r=s.videoCodecs):(n=s.audioExtensions,r=s.audioCodecs),t.twcc===!0){const i=n.find(o=>tf(o.extensionName));if(i){const o=i.extensionName;e.attributes.extmaps.find(l=>tf(l.extensionName))||e.attributes.extmaps.push({entry:i.entry,extensionName:o}),function(l,d){return d.filter(h=>!!l.find(p=>p.payloadType===h.payloadType&&!!p.rtcpFeedbacks.find(m=>m.type==="transport-cc")))}(r,e.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(d=>d.type==="transport-cc")||l.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(t.twcc===!1){const i=e.attributes.extmaps.findIndex(o=>tf(o.extensionName));i!==-1&&e.attributes.extmaps.splice(i,1),e.attributes.payloads.forEach(o=>{const c=o.rtcpFeedbacks.findIndex(l=>l.type==="transport-cc");c!==-1&&o.rtcpFeedbacks.splice(c,1)})}if(t.remb===!0){const i=n.find(o=>CD(o.extensionName));if(i){const o=i.extensionName;e.attributes.extmaps.find(l=>l.extensionName===o)||e.attributes.extmaps.push({entry:i.entry,extensionName:o}),function(l,d){return d.filter(h=>!!l.find(p=>p.payloadType===h.payloadType&&!!p.rtcpFeedbacks.find(m=>m.type==="goog-remb")))}(r,e.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(d=>d.type==="goog-remb")||l.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(t.remb===!1){const i=e.attributes.extmaps.findIndex(o=>CD(o.extensionName));i!==-1&&e.attributes.extmaps.splice(i,1),e.attributes.payloads.forEach(o=>{const c=o.rtcpFeedbacks.findIndex(l=>l.type==="goog-remb");c!==-1&&o.rtcpFeedbacks.splice(c,1)})}}function B_(e,t,s){if(bs()||e.media.mediaType!=="video"||!(t instanceof os)||s!=="vp9"&&s!=="vp8"||s==="vp8"&&!C("SIMULCAST")||s==="vp9"&&C("ENABLE_SVC")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const n=s==="vp8"?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],i=e.attributes.ssrcGroups.find(c=>c.semantic==="FID"&&c.ssrcIds[0]===r.ssrcId),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let c=1;c<n;c++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+c,attributes:_s(r.attributes)}),o.ssrcIds.push(r.ssrcId+c),i&&(e.attributes.ssrcs.push({ssrcId:i.ssrcIds[1]+c,attributes:_s(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+c,i.ssrcIds[1]+c]}));e.attributes.ssrcGroups.unshift(o)}async function jD(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:wm.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const s=ha(t.sdp).mediaDescriptions[0];if(!s)return;const n=s.attributes.extmaps.find(r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return e.close(),n}catch{return}}async function G_(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const s=new RTCPeerConnection;s.addTransceiver("video",{direction:"sendonly"}),s.addTransceiver("audio",{direction:"sendonly"}),s.addTransceiver("video",{direction:"recvonly"}),s.addTransceiver("audio",{direction:"recvonly"});const n=(await s.createOffer()).sdp,{send:r,recv:i,sendrecv:o}=function(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const h=Ju(d,c,l,"sendonly"),p=Ju(d,c,l,"recvonly"),m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vr(h,p,"videoExtensions",m,g,T),Vr(h,p,"videoCodecs",m,g,T),Vr(h,p,"audioExtensions",m,g,T),Vr(h,p,"audioCodecs",m,g,T),C("RAISE_H264_BASELINE_PRIORITY")){const w=[],S=[];if(T.videoCodecs.forEach((I,O)=>{var M;if(((M=I.rtpMap)===null||M===void 0?void 0:M.encodingName.toLocaleLowerCase())==="h264"){var z,K;const V=T.videoCodecs[O+1],Y=V&&UD(I,V),ce=(z=I.fmtp)===null||z===void 0?void 0:z.parameters["profile-level-id"],xe=(K=I.fmtp)===null||K===void 0?void 0:K.parameters["packetization-mode"];!ce||ce!==C("FIRST_H264_PROFILE_LEVEL_ID")||C("FIRST_PACKETIZATION_MODE")&&xe!==C("FIRST_PACKETIZATION_MODE")?Y?S.push([I,V]):S.push([I]):Y?w.push([I,V]):w.push([I])}}),w.length>0&&S.length>0){b.debug("raising H264 baseline profile priority"),T.videoCodecs.forEach((O,M)=>{var z;if(((z=O.rtpMap)===null||z===void 0?void 0:z.encodingName.toLocaleLowerCase())==="h264"){const K=UD(O,T.videoCodecs[M+1]),V=w.shift()||S.shift()||[];V.length>0&&(K?T.videoCodecs.splice(M,2,...V):T.videoCodecs.splice(M,1,...V))}});const I=g.videoCodecs.filter(O=>{var M,z;return((M=O.rtpMap)===null||M===void 0?void 0:M.encodingName.toLocaleLowerCase())==="h264"&&((z=O.fmtp)===null||z===void 0?void 0:z.parameters["profile-level-id"])!==C("FIRST_H264_PROFILE_LEVEL_ID")});if(I.length>0){const O=Ko(I,g.videoCodecs).map(z=>z.payloadType),M=[...I.map(z=>z.payloadType),...O];g.videoCodecs=g.videoCodecs.filter(z=>!_e(M).call(M,z.payloadType))}C("FILTER_SEND_H264_BASELINE")&&(m.videoCodecs=m.videoCodecs.filter(O=>{var M,z;return!(((M=O.rtpMap)===null||M===void 0?void 0:M.encodingName.toLocaleLowerCase())==="h264"&&((z=O.fmtp)===null||z===void 0?void 0:z.parameters["profile-level-id"])!==C("FIRST_H264_PROFILE_LEVEL_ID"))}))}return{send:m,recv:g,sendrecv:T}}return{send:m,recv:g,sendrecv:T}}(e,t,n);try{s.close()}catch{}return{send:r,recv:i,sendrecv:o}}function PD(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Ju(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vr(e,t,"videoExtensions",s,n,r),Vr(e,t,"videoCodecs",s,n,r),Vr(e,t,"audioExtensions",s,n,r),Vr(e,t,"audioCodecs",s,n,r),C("RAISE_H264_BASELINE_PRIORITY")){const i=r.videoCodecs.findIndex(o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f");if(i!==-1){const o=r.videoCodecs.findIndex(c=>c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(o<i){b.debug("raising H264 baseline profile priority");const c=r.videoCodecs[i];r.videoCodecs.splice(i,1),r.videoCodecs.splice(o,0,c)}o!==-1&&(n.videoCodecs=n.videoCodecs.filter(c=>!(c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&c.fmtp&&c.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:s,recv:n,sendrecv:r}}function Vr(e,t,s,n,r,i){if(s==="videoExtensions"||s==="audioExtensions"){const o=[];return e[s].forEach(c=>{t[s].some((l,d)=>{if(c.entry===l.entry&&c.extensionName===l.extensionName)return o.push(d),!0})?i[s].push(c):n[s].push(c)}),void t[s].forEach((c,l)=>{o.indexOf(l)===-1&&r[s].push(c)})}if(s==="videoCodecs"||s==="audioCodecs"){const o=[];return e[s].forEach(c=>{t[s].some((l,d)=>{if(c.payloadType===l.payloadType&&JSON.stringify(c)===JSON.stringify(l))return o.push(d),!0})?i[s].push(c):n[s].push(c)}),void t[s].forEach((c,l)=>{o.indexOf(l)===-1&&r[s].push(c)})}}function Qu(e){const{send:t,recv:s,sendrecv:n}=e;if(!n){if(!t||!s)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:s}}let r,i;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...n.audioCodecs],r.videoCodecs=[...t.videoCodecs,...n.videoCodecs],r.audioExtensions=[...t.audioExtensions,...n.audioExtensions],r.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):r=_s(n),s?(i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i.audioCodecs=[...s.audioCodecs,...n.audioCodecs],i.videoCodecs=[...s.videoCodecs,...n.videoCodecs],i.audioExtensions=[...s.audioExtensions,...n.audioExtensions],i.videoExtensions=[...s.videoExtensions,...n.videoExtensions]):i=_s(n),{send:r,recv:i}}function vd(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter(t=>{var s;return((s=t.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function Zu(e,t,s,n){let r=[];if(e===Le.VIDEO){if(C("H264_PROFILE_LEVEL_ID")&&n==="h264"&&(r=t.videoCodecs.filter(i=>{var o;return _e(o=i.rtpMap&&i.rtpMap.encodingName.toLowerCase()||"").call(o,n)&&i&&i.fmtp&&i.fmtp.parameters["profile-level-id"]===C("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let i=[];const o=[],c=[],l=[];if(s.videoCodecs.forEach(d=>{const h=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";_e(h).call(h,n)?i.push(d):_e(h).call(h,"vp9")?o.push(d):_e(h).call(h,"vp8")?c.push(d):_e(h).call(h,"h264")&&l.push(d)}),i.length===0){let d="";o.length!==0?(i=o,d="vp9"):c.length!==0?(i=c,d="vp8"):l.length!==0&&(i=l,d="h264"),b.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}i.length!==0&&(r=t.videoCodecs.filter(d=>i.some(h=>h.payloadType===d.payloadType)))}if(r.length===0&&(b.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs),C("USE_PUB_RTX")||C("USE_SUB_RTX")){const i=Ko(r,t.videoCodecs);r=[...r,...i]}}else{r=t.audioCodecs.filter(o=>{var c;return _e(c=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(c,n)});const i=t.audioCodecs.filter(o=>{var c;return _e(c=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(c,"red")});r.length===0&&(b.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter(o=>{var c;return _e(c=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(c,"opus")})),C("ENABLE_AUDIO_RED")&&i.length!==0&&(r=[...i,...r])}return r}function Ko(e,t){const s=e.map(n=>n.payloadType.toString());return t.filter(n=>n.rtpMap&&n.rtpMap.encodingName==="rtx"&&n.fmtp&&n.fmtp.parameters.apt&&_e(s).call(s,n.fmtp&&n.fmtp.parameters.apt))}async function Ca(e,t,s){const n=t.toString(),r=LD(n,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:n});const i=await e.createAnswer();if(!i.sdp)throw new Error("cannot get answer sdp");let o=i.sdp;o=W_(o,s||{}),r==null||r(o||""),await e.setLocalDescription({type:"answer",sdp:o})}function W_(e,t,s){if(C("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const n=ha(e),{useXR:r}=t;return n.mediaDescriptions.forEach(i=>{var o;i.attributes.mid&&(Array.isArray(s)&&!_e(s).call(s,i.attributes.mid)||(i.media.mediaType==="audio"&&vd(i),i.media.mediaType==="video"&&function(c){c.media.mediaType==="video"&&C("ENABLE_DOWN_SPS_PPS")&&c.attributes.payloads.filter(l=>{var d;return((d=l.rtpMap)===null||d===void 0?void 0:d.encodingName.toLowerCase())==="h264"}).forEach(l=>{l.fmtp||(l.fmtp={parameters:{}}),l.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"})}(i),r&&_e(o=["audio","video"]).call(o,i.media.mediaType)&&i.attributes.payloads.forEach(c=>{c.rtcpFeedbacks.findIndex(l=>l.type==="rrtr")===-1&&c.rtcpFeedbacks.push({type:"rrtr"})})))}),ao(n)}function LD(e,t,s,n){if(C("SDP_LOGGING"))return b.upload("exchanging ".concat(s," ").concat(t," SDP during P2PConnection.").concat(n,`
`),e),t==="offer"?r=>{LD(r,"answer",s==="local"?"remote":"local",n)}:void 0}async function MD(e,t,s){try{var n;if(!At().supportSetRtpSenderParameters||!function(l){return l==="vp9"||l==="av1"}(e)||!C("ENABLE_SVC"))return;const r={},i={},o=t.getParameters(),c=(n=o.encodings)===null||n===void 0?void 0:n[0];i.scalabilityMode=Xu(s),c&&Object.assign(c,i),Object.assign(o,r),await t.setParameters(o),b.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(o.encodings)))}catch(r){b.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function nf(e){const t=C("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some(s=>_e(e).call(e,s))}function UD(e,t){try{var s;return((s=e.fmtp)===null||s===void 0?void 0:s.parameters.apt)===t.payloadType.toString()}catch{return!1}}function VD(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Fa(e,t){return typeof C(e)===t?C(e):void 0}function Q7(){try{const e=C("EXPERIMENTS")||{};return typeof e=="string"||Array.isArray(e)?{}:function(t){for(var s=1;s<arguments.length;s++){var n=arguments[s]!=null?arguments[s]:{};s%2?VD(Object(n),!0).forEach(function(r){N(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):VD(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}({},e)}catch(e){return b.debug("handle gateway attributes failed: ",e),{}}}const FD={};function Pi(e){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&b.debug("install service ".concat(e.name)),FD[e.name]=e}function ci(e){const t=FD[e];if(!t)throw new se(A.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function BD(e,t){return ci("DataStream").create(e,t)}function af(){return ci("InterceptFrame").create()}function GD(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Tn(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?GD(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):GD(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const H_=new Map;class Z7 extends Cs{get state(){return this._state}set state(t){if(t===this._state)return;const s=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Bs.CONNECTION_STATE_CHANGE,t,s,this._disconnectedReason):this.emit(Bs.CONNECTION_STATE_CHANGE,t,s)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){b.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,s){var n,r,i;super(),N(this,"store",void 0),N(this,"joinInfo",void 0),N(this,"key",void 0),N(this,"ntpOffset",0),N(this,"usingProxy",!1),N(this,"signal",void 0),N(this,"role",void 0),N(this,"isPreallocation",void 0),N(this,"isPreSub",void 0),N(this,"inChannelInfo",{joinAt:null,duration:0}),N(this,"spec",void 0),N(this,"_state","DISCONNECTED"),N(this,"_statsCollector",void 0),N(this,"_disconnectedReason",void 0),N(this,"isSignalRecover",!1),N(this,"hasChangeBGPAddress",!1),N(this,"trafficStatsInterval",void 0),N(this,"networkQualityInterval",void 0),N(this,"_joinGatewayStartTime",0),N(this,"_signalTimeout",!1),N(this,"_clientRoleOptions",void 0),N(this,"_isProactiveJoin",!1),this.store=t,this.spec=s,this.signal=this.store.useP2P?(n={spec:Tn(Tn({},s),{},{retryConfig:s.websocketRetryConfig}),store:t},(r=(i=ci("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(i,n)):this.store.useDcSignal?function(o){return ci("DataChannelSignal").create(o)}({spec:Tn(Tn({},s),{},{retryConfig:s.websocketRetryConfig}),store:t}):new vD(Tn(Tn({},s),{},{retryConfig:s.websocketRetryConfig}),t),this._statsCollector=s.statsCollector,this.role=s.role||"audience",this._clientRoleOptions=s.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(t){this.usingProxy=t}async join(t,s,n){if(this.store.useDcSignal){let h=!1;t.cloudProxyServer!=="disabled"?(b.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),h=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(b.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),h=!0):t.apResponse.addresses.some(p=>p.fingerprint)||C("FINGERPRINT")||(b.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),h=!0),h&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let i=H_.get(t.cname);if(i||(i=new Map,H_.set(t.cname,i)),this._isProactiveJoin=!0,i.has(t.uid)){const h=new $(A.UID_CONFLICT);throw Ue.joinGateway(t.sid,{lts:r,succ:!1,ec:h.code,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!t.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:t.preload}),h}i.set(t.uid,!0),this.joinInfo=t,this.key=s;let o=0;this.joinGatewayStartTime=r;const c=t.proxyServer,l=this.store.useDcSignal?"datachannel":"websocket";try{b.debug("[".concat(this.store.clientId,"] use ").concat(l," join uid ").concat(o));const h=t.gatewayAddrs.map(m=>{let{address:g}=m;const[T,w]=g.split(":"),S={host:T,port:w};return t.proxyServer&&(S.proxy=t.proxyServer),S});let p;p=this.store.useDcSignal?await this.signal.init(t.apResponse.addresses):await this.signal.init(h),o=p.uid,b.debug("[".concat(this.store.clientId,"] ").concat(l," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(h){var d;throw h.code===A.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||Ue.joinGateway(t.sid,{lts:r,succ:!1,ec:((d=h.data)===null||d===void 0?void 0:d.desc)||h.code,errorMsg:h.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!c||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:t.preload}),h&&h.code===A.INIT_DATACHANNEL_TIMEOUT?(b.warning("[".concat(this.store.clientId,"] User join datachannel failed"),h.toString()),this.resetSignal(),h):(b.error("[".concat(this.store.clientId,"] User join failed"),h.toString()),i.delete(t.uid),this.signal.close(),h)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),b.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(h=>{b.warning("[".concat(this.store.clientId,"] get traffic stats error"),h.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Bs.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Bs.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Bs.NETWORK_QUALITY,{uplinkNetworkQuality:Zm(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Zm(this._statsCollector.trafficStats.B_dnq)}):this.emit(Bs.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],s=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){s!==kt.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==jt.CONNECTED||await function(n,r){return r===1/0?n:Te.race([n,Tz(r)])}(this.signal.request(qe.LEAVE,void 0,!0),3e3)}catch(n){b.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),n)}this.signal.close(s),s!==kt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,s,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:s,mode:this.spec.mode,extend:C("PUB_EXTEND"),twcc:!!C("PUBLISH_TWCC"),rtx:!!C("USE_PUB_RTX")};try{return(await this.signal.request(qe.PUBLISH,r,!0))._message}catch(i){if(n&&i.data&&i.data.code===Qe.ERR_PUBLISH_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),i.toString()),await this.tryUnpubBeforeRepub(t,s),this.publish(t,s,!1);throw i}}async publishDataChannel(t,s,n){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const i={stream_id:s.streamId,ordered:s.ordered?1:0,max_retrans_times:(r=s.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:s.channelId,metadata:s.metadata};try{await this.signal.request(qe.PUBLISH_DATASTREAM,i,!0)}catch(o){if(n&&o.data&&o.data.code===Qe.ERR_PUBLISH_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(t,s),this.publishDataChannel(t,s,!1);throw o}}async unpublish(t,s){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(qe.UNPUBLISH,{stream_id:s,ortc:t},!0)}catch(n){b.warning("[".concat(this.store.clientId,"] unpublish warning: "),n)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Te.all(t.map(s=>this.signal.request(qe.UNPUBLISH_DATASTREAM,{channel_id:s},!0)))}catch(s){b.warning("unpublish datachannels warning: ",s)}}async presubscribe(t,s,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:s,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!C("SUBSCRIBE_TWCC"),rtx:!!C("USE_SUB_RTX")||void 0,extend:C("SUB_EXTEND"),svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return await this.signal.request(qe.PRE_SUBSCRIBE,r,!0)}catch(i){if(n&&i.data&&i.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),i.toString()),this.presubscribe(t,s,!1);throw i}}async subscribe(t,s,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:s.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!C("SUBSCRIBE_TWCC"),rtx:!!C("USE_SUB_RTX"),extend:C("SUB_EXTEND"),ssrcId:s.ssrcId,svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return(await this.signal.request(qe.SUBSCRIBE,r,!0))._message}catch(i){if(n&&i.data&&i.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),i.toString()),await this.tryUnsubBeforeResub(t,s),await this.subscribe(t,s,!1);throw i}}async subscribeDataChannel(t,s,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:t,stream_id:s.id,channel_id:s.datachannelId};try{return void await this.signal.request(qe.SUBSCRIBE_DATASTREAM,r,!0)}catch(i){if(n&&i.data&&i.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),i.toString()),await this.tryUnsubDataChannelBeforeResub(t,s),await this.subscribeDataChannel(t,s,!1);throw i}}async subscribeAll(t,s){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!C("USE_SUB_RTX"),twcc:!!C("SUBSCRIBE_TWCC"),svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return await this.signal.request(qe.SUBSCRIBE_STREAMS,n,!0)}catch(r){if(s&&r.data&&r.data.code===Qe.ERR_SUBSCRIBE_REQUEST_INVALID)return b.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw r}}async setVideoProfile(t){const s=function(n){if(!(n.bitrateMax&&n.bitrateMin&&n.frameRate&&n.height&&n.width))return;let r=n.frameRate,i=n.width,o=n.height,c=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(c=!1)),typeof i!="number"&&(i=i.exact||i.ideal||i.max||i.min||0,i||(c=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(c=!1)),c?{stream_type:0,width:i,height:o,fps:r,start_bps:1e3*n.bitrateMax,min_bps:1e3*n.bitrateMin,target_bps:1e3*n.bitrateMax}:void 0}(t);if(s)return this.signal.request(qe.SET_VIDEO_PROFILE,s);b.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,s){try{await this.signal.request(qe.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:s},!0)}catch(n){b.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),n)}}async unsubscribeDataChannel(t,s){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Te.all(t.map(n=>this.signal.request(qe.UNSUBSCRIBE_DATASTREAM,{stream_id:n,uid:s},!0)))}catch(n){b.warning("unsubscribeDataChannel warning: ",n)}}async massUnsubscribe(t){try{await this.signal.request(qe.UNSUBSCRIBE_STREAMS,t,!0)}catch(s){b.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),s)}}async reconnectPC(t){const{iceParameters:s,dtlsParameters:n,rtpCapabilities:r}=t;return{gatewayEstablishParams:await this.signal.request(qe.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:s,dtlsParameters:n,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(qe.GATEWAY_INFO)}async renewToken(t){await this.signal.request(qe.RENEW_TOKEN,t),this.key=t.token}updateClientRole(t,s){s&&(this._clientRoleOptions=Object.assign({},s)),C("CLIENT_ROLE_OPTIONS")&&(b.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(C("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},C("CLIENT_ROLE_OPTIONS"))),this.role=t}async setClientRole(t,s){if(s&&(this._clientRoleOptions=Object.assign({},s)),C("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},C("CLIENT_ROLE_OPTIONS")),b.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(C("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=t);let n,r=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;const i=Object.assign({},s);delete i.delay,delete i.level,await this.signal.request(qe.SET_CLIENT_ROLE,Tn(Tn({role:t,level:r,delay:n},i),{},{client_ts:Date.now()})),this.role=t}async setDualStreamMode(t,s,n){await this.signal.request(qe.SET_DUAL_STREAM_MODE,{mode:t},n,s)}async setRemoteVideoStreamType(t,s){await this.signal.request(qe.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:s})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(qe.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,s){await this.signal.request(qe.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:s})}async pickSVCLayer(t,s){await this.signal.request(qe.PICK_SVC_LAYER,{stream_id:t,spatial_layer:s.spatialLayer,temporal_layer:s.temporalLayer})}async setRTM2Flag(t){await this.signal.request(qe.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,s,n){if(this.store.useP2P)return this.signal.sendExtensionMessage(t,s,n)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Tn({},this.inChannelInfo)}async setConfigure(t){if(t&&Array.isArray(t)&&t.length!==0)return this.signal.request(qe.CONFIGURE,t)}async getGatewayVersion(){return(await this.signal.request(qe.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=H_.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(s){let n;return n=s.startsWith("dc")?s.match(/(dc\:\/\/)?([^:]+):(\d+)/):s.match(/(wss\:\/\/)?([^:]+):(\d+)/),n?{username:Un.username,password:Un.password,turnServerURL:n[2],tcpport:parseInt(n[3])+30,udpport:parseInt(n[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Tn(Tn({},Un),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(qe.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(s=>{const n=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===s.peer_uid);n&&n.B_st!==s.B_st&&_m(()=>{this.emit(Bs.STREAM_TYPE_CHANGE,s.peer_uid,s.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){var s,n,r,i;if(!this.joinInfo||!this.key)throw new $(A.UNEXPECTED_ERROR,"can not generate join message, no join info");const o=Object.assign({},this.joinInfo.apResponse);let c=C("REPORT_APP_SCENARIO");if(typeof c!="string")try{c=JSON.stringify(c)}catch{c=void 0}var l;c&&c.length>128&&(c=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(Bs.UPDATE_GATEWAY_CONFIG),l=this.store.clientId,_e(md).call(md,l)||md.push(l);const d=Wu(this.store),h=!((s=this.isPreallocation)===null||s===void 0||!s.call(this)),p=GI(this.store),m=Q7(),g=si(87)||qC()||Rb(117),T=(function(){const O=Ft();if(O.name!==Wt.SAFARI||!O.browserVersion)return!1;const M=O.browserVersion.split(".");return Number(M[0])>18||Number(M[0])===18&&Number(M[1])>=4}()||QC(18,4,!1))&&Cb(18,6,!0)&&this.spec.codec==="h264"&&C("ENABLE_ABSSENDTIME_AS_SENTTS"),w=!(((n=o.detail)===null||n===void 0?void 0:n[3])!=="CN"||!C("ENABLE_QUALITY_FALLBACK"))&&C("ENABLE_QUALITY_FALLBACK"),S=!!C("ENABLE_AP_MULTI_IP")&&((r=o.detail)===null||r===void 0?void 0:r[5])==="multi-ip",I=Tn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:lr,browser:navigator.userAgent,process_id:C("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:S||this.hasChangeBGPAddress,ap_response:o,extend:C("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:c,attributes:{userAttributes:Tn(Tn({enableEncodedTransform:(!!C("ENABLE_AUDIO_METADATA")||!!C("ENABLE_AUDIO_PTS"))&&g||!!C("ENABLE_AUDIO_TOPN")&&Tb(Wt.CHROME,87,116)||void 0,enableAudioMetadata:!!C("ENABLE_AUDIO_METADATA")&&g,enableAudioPts:!!C("ENABLE_AUDIO_PTS")&&g,topnSmoothLevel:C("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:C("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:C("TOPN_SWITCH_HOLD_MS"),topnAudioGain:C("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:C("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:C("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Fa("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Fa("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Fa("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:C("USE_PUB_RTX")===!0||C("USE_SUB_RTX")===!0||void 0,disableFEC:C("DISABLE_FEC"),enableNTPReport:!!C("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:p,enableFulllinkAvSync:!!C("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Fa("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!C("FORCE_ENABLE_AUT_CC")||!Cm()&&(!!C("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!C("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Fa("USE_XR","boolean"),enableLossbasedBwe:Fa("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!C("FORCE_ENABLE_AUT_CC")||!Cm()&&(!!C("ENABLE_AUT_CC")||void 0),enableCCFallback:Fa("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:h,preSubNum:d?Fa("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Fa("PUBLISH_TWCC","boolean"),enableSubTWCC:Fa("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Fa("USE_PUB_RTX","boolean"),enableSubRTX:Fa("USE_SUB_RTX","boolean"),enableSubSVC:C("ENABLE_SVC")?C("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0,enableSvcExtended:C("ENABLE_SVC")&&Array.isArray(C("SVC_EXTENDED"))&&C("SVC_EXTENDED").length!==0?C("SVC_EXTENDED"):void 0,enableVosFallback:C("ENABLE_VOS_FALLBACK"),enableQualityFallback:w},m),{},{audioDuplicate:Fa("ENABLE_AUDIO_RED","boolean")?(i=Fa("AUDIO_DUPLICATE_NUM","number"))!==null&&i!==void 0?i:2:void 0,senttsUsesAbsSendTime:!!T||void 0,enableDualStreamFlag:Fa("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(I.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(I.aes_mode=this.joinInfo.aesmode,C("ENCRYPT_AES")?(I.aes_secret=this.joinInfo.aespassword,I.aes_encrypt=!0):I.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(I.aes_salt=this.joinInfo.aessalt)),o.addresses[this.signal.websocket.currentURLIndex]&&(I.ap_response.ticket=o.addresses[this.signal.websocket.currentURLIndex].ticket,delete o.addresses),this.joinInfo.defaultVideoStream!==void 0&&(I.default_video_stream=this.joinInfo.defaultVideoStream),I}getRejoinMessage(){if(!this.joinInfo)throw new $(A.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Ge.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(Ge.WS_RECONNECTING,t=>{this.joinInfo&&Ue.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||Mn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Ue.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(Ge.WS_CLOSED,t=>{let s;switch(t){case kt.LEAVE:s=Mn.LEAVE;break;case kt.UID_BANNED:case kt.IP_BANNED:case kt.CHANNEL_BANNED:case kt.SERVER_ERROR:s=Mn.SERVER_ERROR;break;case kt.FALLBACK:s=Mn.FALLBACK;break;case kt.LICENSE_MISSING:case kt.LICENSE_EXPIRED:case kt.LICENSE_MINUTES_EXCEEDED:case kt.LICENSE_PERIOD_INVALID:case kt.LICENSE_MULTIPLE_SDK_SERVICE:case kt.LICENSE_ILLEGAL:case kt.TOKEN_EXPIRE:s=t;break;default:s=Mn.NETWORK_ERROR}b.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(s||"undefined -> "+Mn.NETWORK_ERROR)),this.joinInfo&&Ue.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===kt.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:s}),this._disconnectedReason=t,t!==kt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(Ge.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const t=C("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;t&&(t.level||t.delay)&&(b.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(t.level,", delay: ").concat(t.delay)),this.setClientRole(this.role,t))}if(Ue.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void b.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));ss("EVENT_REPORT_DOMAIN",t[1]),ss("EVENT_REPORT_BACKUP_DOMAIN",t[1]),ss("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}}),this.signal.on(ut.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(Ge.REQUEST_RECOVER,(t,s,n)=>{if(!this.joinInfo)return n(new $(A.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Qs(this,Bs.REQUEST_NEW_GATEWAY_LIST).then(s).catch(n)}),this.signal.on(Ge.REQUEST_JOIN_INFO,async(t,s,n)=>{var r,i,o;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const c=_s((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(C("NEW_TURN_MODE")&&c&&((i=this.joinInfo)===null||i===void 0?void 0:i.cloudProxyServer)==="disabled"){var l;let m=c.servers.map(w=>"turnServerURL"in w&&C("USE_TURN_IP")?Tn(Tn({},w),{},{turnServerURL:Qm(w.turnServerURL)}):w),g=(l=c.serversFromGateway)===null||l===void 0?void 0:l.map(w=>C("USE_TURN_IP")?Tn(Tn({},w),{},{turnServerURL:Qm(w.turnServerURL)}):w);const T=this.signal.currentURLIndex;m.length>0&&(m=[m[T%m.length]],c.servers=m),Array.isArray(g)&&g.length>0&&(g=[g[0]],c.serversFromGateway=g),b.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(T))}const{iceParameters:d,dtlsParameters:h,rtpCapabilities:p}=await Qs(this,Bs.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:c,cloudProxyServer:(o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer});try{t(this.getJoinMessage({ortc:{iceParameters:d,dtlsParameters:h,rtpCapabilities:p,version:"2"}}))}catch(m){s(m)}}),this.signal.on(Ge.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(Ge.REPORT_JOIN_GATEWAY,(t,s)=>{if(!this.joinInfo)return;let n,r="";var i;t instanceof $?(n=((i=t.data)===null||i===void 0?void 0:i.desc)||t.code,r=t.message):n=t,Ue.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:n,errorMsg:r,addr:s,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})}),this.signal.on(Ge.IS_P2P_DISCONNECTED,t=>{t(Ac(this,Bs.IS_P2P_DISCONNECTED))}),this.signal.on(Ge.DISCONNECT_P2P,()=>{this.emit(Bs.DISCONNECT_P2P)}),this.signal.on(Ge.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(Ge.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(Ge.JOIN_RESPONSE,t=>{const s=this.getCurrentGatewayAddress();this.emit(Bs.JOIN_RESPONSE,t,s)}),this.signal.on(Ge.PRE_CONNECT_PC,async(t,s)=>{if(this.joinInfo){var n,r;this.updateTurnConfigFromSignal();const o=this.getCurrentGatewayAddress(),c=_s((n=this.joinInfo)===null||n===void 0?void 0:n.turnServer);if(C("NEW_TURN_MODE")&&c&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var i;let d=c.servers.map(m=>"turnServerURL"in m&&C("USE_TURN_IP")?Tn(Tn({},m),{},{turnServerURL:Qm(m.turnServerURL)}):m),h=(i=c.serversFromGateway)===null||i===void 0?void 0:i.map(m=>C("USE_TURN_IP")?Tn(Tn({},m),{},{turnServerURL:Qm(m.turnServerURL)}):m);const p=this.signal.currentURLIndex;d.length>0&&(d=[d[p%d.length]],c.servers=d),Array.isArray(h)&&h.length>0&&(h=[h[0]],c.serversFromGateway=h),b.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(p,",in pre pc"))}const l=C("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(o&&l){const d=DD(o);Qs(this,Bs.PRE_CONNECT_PC,{candidates:d,fingerprint:l,turnServer:c}).then(h=>{t==null||t(h)}).catch(s||(()=>{}))}}}),this.signal.on(Ge.RECOVER_NOTIFICATION,t=>{this.joinInfo&&typeof C("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(C("AP_REQUEST_DETAIL"),";").concat(t))}),this.signal.on(Ge.VOS_FALLBACK,t=>{this.emit(Bs.VOS_FALLBACK,t)}),this.signal.on(Ge.DATACHANNEL_FAILBACK,t=>{b.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Bs.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,s){try{await this.signal.request(qe.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[s]},!0)}catch(n){throw b.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),n),n}}async tryUnsubDataChannelBeforeResub(t,s){try{await this.signal.request(qe.UNSUBSCRIBE,{stream_id:s.id},!0)}catch(n){throw b.warning("unsubscribe datachannel warning",n),n}}async tryUnpubBeforeRepub(t,s){try{await this.signal.request(qe.UNPUBLISH,{stream_id:t,ortc:s},!0)}catch(n){throw b.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),n),n}}async tryUnpubDataChannelBeforeRepub(t,s){try{await this.signal.request(qe.UNPUBLISH_DATASTREAM,{channnel_id:s.channelId},!0)}catch(n){throw b.warning("unpublish datastream warning: ",n),n}}async tryMassUnsubBeforeResub(t){const s={users:t.map(n=>({stream_id:n.stream_id,stream_type:n.stream_type}))};try{await this.signal.request(qe.UNSUBSCRIBE_STREAMS,s,!0)}catch(n){throw b.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),n),n}}async muteLocal(t,s){const n={action:t.find(r=>r.stream_type===Qt.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:s};try{await this.signal.request(qe.CONTROL,n,!0,!0)}catch(r){throw b.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(t,s){const n={action:t.find(r=>r.stream_type===Qt.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:s};try{await this.signal.request(qe.CONTROL,n,!0,!0)}catch(r){throw b.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(t,s){const n={action:t===Le.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:s};try{await this.signal.request(qe.CONTROL,n,!0,!0)}catch(r){throw b.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(t,s){const n={action:t===Le.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:s};try{await this.signal.request(qe.CONTROL,n,!0,!0)}catch(r){throw b.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,s){this.signal.upload(t,s)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const s={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(qe.RESTART_ICE,s,!0)}catch(n){throw b.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),n),n}}reconnect(t,s){this.state==="CONNECTED"&&this.signal.reconnect(t||void 0,s||Mn.P2P_FAILED)}getCurrentGatewayAddress(){var t,s;if(!C("GATEWAY_WSS_ADDRESS"))return C("USE_CANDIDATE_FROM_AP_DETAIL")&&(t=this.joinInfo)!==null&&t!==void 0&&t.apGatewayAddress?(b.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(s=this.joinInfo)!==null&&s!==void 0&&s.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(qe.SET_PARAMETER,{enablePublishAudioFilter:t})}downgradeCodec(t){this.signal.downgradeCodec(t)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(kt.FALLBACK)),this.store.useDcSignal=!1,this.signal=new vD(Tn(Tn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Bs.RESET_SIGNAL)}}let rf=0,z_=0;function li(e,t,s,n){return new Te((r,i)=>{t.timeout=t.timeout||C("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!s?(t.data=JSON.stringify(t.data),rf+=Ii(t.data)):s&&(t.data.size?rf+=t.data.size:t.data instanceof FormData?rf+=bI(t.data):rf+=Ii(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ba.request(t).then(o=>{typeof o.data=="string"?z_+=Ii(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?z_+=o.data.byteLength:z_+=Ii(JSON.stringify(o.data)),n&&r({data:o.data,headers:o.headers}),r(o.data)}).catch(o=>{ba.isCancel(o)?i(new $(A.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?i(new $(A.NETWORK_TIMEOUT,o.message)):o.response?i(new $(A.NETWORK_RESPONSE_ERROR,o.response.status)):i(new $(A.NETWORK_ERROR,o.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var e;function t(de){var Se=0;return function(){return Se<de.length?{done:!1,value:de[Se++]}:{done:!0}}}var s=typeof Object.defineProperties=="function"?Object.defineProperty:function(de,Se,Me){return de==Array.prototype||de==Object.prototype||(de[Se]=Me.value),de},n,r=function(de){de=[typeof globalThis=="object"&&globalThis,de,typeof window=="object"&&window,typeof self=="object"&&self,typeof _=="object"&&_];for(var Se=0;Se<de.length;++Se){var Me=de[Se];if(Me&&Me.Math==Math)return Me}throw Error("Cannot find global object")}(this);function i(de,Se){if(Se)e:{var Me=r;de=de.split(".");for(var me=0;me<de.length-1;me++){var v=de[me];if(!(v in Me))break e;Me=Me[v]}(Se=Se(me=Me[de=de[de.length-1]]))!=me&&Se!=null&&s(Me,de,{configurable:!0,writable:!0,value:Se})}}function o(de){return(de={next:de})[Symbol.iterator]=function(){return this},de}function c(de){var Se=typeof Symbol<"u"&&Symbol.iterator&&de[Symbol.iterator];return Se?Se.call(de):{next:t(de)}}if(i("Symbol",function(de){function Se(v,L){this.A=v,s(this,"description",{configurable:!0,writable:!0,value:L})}if(de)return de;Se.prototype.toString=function(){return this.A};var Me="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",me=0;return function v(L){if(this instanceof v)throw new TypeError("Symbol is not a constructor");return new Se(Me+(L||"")+"_"+me++,L)}}),i("Symbol.iterator",function(de){if(de)return de;de=Symbol("Symbol.iterator");for(var Se="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),Me=0;Me<Se.length;Me++){var me=r[Se[Me]];typeof me=="function"&&typeof me.prototype[de]!="function"&&s(me.prototype,de,{configurable:!0,writable:!0,value:function(){return o(t(this))}})}return de}),typeof Object.setPrototypeOf=="function")n=Object.setPrototypeOf;else{var l;e:{var d={};try{d.__proto__={a:!0},l=d.a;break e}catch{}l=!1}n=l?function(de,Se){if(de.__proto__=Se,de.__proto__!==Se)throw new TypeError(de+" is not extensible");return de}:null}var h=n;function p(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function m(de){if(de.m)throw new TypeError("Generator is already running");de.m=!0}function g(de,Se){return de.h=3,{value:Se}}function T(de){this.g=new p,this.G=de}function w(de,Se,Me,me){try{var v=Se.call(de.g.j,Me);if(!(v instanceof Object))throw new TypeError("Iterator result "+v+" is not an object");if(!v.done)return de.g.m=!1,v;var L=v.value}catch(W){return de.g.j=null,de.g.s(W),S(de)}return de.g.j=null,me.call(de.g,L),S(de)}function S(de){for(;de.g.h;)try{var Se=de.G(de.g);if(Se)return de.g.m=!1,{value:Se.value,done:!1}}catch(Me){de.g.v=void 0,de.g.s(Me)}if(de.g.m=!1,de.g.l){if(Se=de.g.l,de.g.l=null,Se.F)throw Se.D;return{value:Se.return,done:!0}}return{value:void 0,done:!0}}function I(de){this.next=function(Se){return de.o(Se)},this.throw=function(Se){return de.s(Se)},this.return=function(Se){return function(Me,me){m(Me.g);var v=Me.g.j;return v?w(Me,"return"in v?v.return:function(L){return{value:L,done:!0}},me,Me.g.return):(Me.g.return(me),S(Me))}(de,Se)},this[Symbol.iterator]=function(){return this}}function O(de,Se){return Se=new I(new T(Se)),h&&de.prototype&&h(Se,de.prototype),Se}if(p.prototype.o=function(de){this.v=de},p.prototype.s=function(de){this.l={D:de,F:!0},this.h=this.C||this.u},p.prototype.return=function(de){this.l={return:de},this.h=this.u},T.prototype.o=function(de){return m(this.g),this.g.j?w(this,this.g.j.next,de,this.g.o):(this.g.o(de),S(this))},T.prototype.s=function(de){return m(this.g),this.g.j?w(this,this.g.j.throw,de,this.g.o):(this.g.s(de),S(this))},i("Array.prototype.entries",function(de){return de||function(){return function(Se,Me){Se instanceof String&&(Se+="");var me=0,v=!1,L={next:function(){if(!v&&me<Se.length){var W=me++;return{value:Me(W,Se[W]),done:!1}}return v=!0,{done:!0,value:void 0}}};return L[Symbol.iterator]=function(){return L},L}(this,function(Se,Me){return[Se,Me]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var M=function(de,Se){for(var Me=0;Me<de.length;Me++)Se(de[Me])},z=function(de){return de.replace(/\r?\n|\r/g,`\r
`)},K=function(de,Se,Me){return Se instanceof Blob?(Me=Me!==void 0?Me+"":typeof Se.name=="string"?Se.name:"blob",Se.name===Me&&Object.prototype.toString.call(Se)!=="[object Blob]"||(Se=new File([Se],Me)),[String(de),Se]):[String(de),String(Se)]},V=function(de,Se){if(de.length<Se)throw new TypeError(Se+" argument required, but only "+de.length+" present.")},Y=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,ce=Y.FormData,xe=Y.XMLHttpRequest&&Y.XMLHttpRequest.prototype.send,ke=Y.Request&&Y.fetch,lt=Y.navigator&&Y.navigator.sendBeacon,at=Y.Element&&Y.Element.prototype,Et=Y.Symbol&&Symbol.toStringTag;Et&&(Blob.prototype[Et]||(Blob.prototype[Et]="Blob"),"File"in Y&&!File.prototype[Et]&&(File.prototype[Et]="File"));try{new File([],"")}catch{Y.File=function(Se,Me,me){return Se=new Blob(Se,me||{}),Object.defineProperties(Se,{name:{value:Me},lastModified:{value:+(me&&me.lastModified!==void 0?new Date(me.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Et&&Object.defineProperty(Se,Et,{value:"File"}),Se}}var xt=function(de){return de.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Ht=function(de){this.i=[];var Se=this;de&&M(de.elements,function(Me){if(Me.name&&!Me.disabled&&Me.type!=="submit"&&Me.type!=="button"&&!Me.matches("form fieldset[disabled] *"))if(Me.type==="file"){var me=Me.files&&Me.files.length?Me.files:[new File([],"",{type:"application/octet-stream"})];M(me,function(v){Se.append(Me.name,v)})}else Me.type==="select-multiple"||Me.type==="select-one"?M(Me.options,function(v){!v.disabled&&v.selected&&Se.append(Me.name,v.value)}):Me.type==="checkbox"||Me.type==="radio"?Me.checked&&Se.append(Me.name,Me.value):(me=Me.type==="textarea"?z(Me.value):Me.value,Se.append(Me.name,me))})};if((e=Ht.prototype).append=function(de,Se,Me){V(arguments,2),this.i.push(K(de,Se,Me))},e.delete=function(de){V(arguments,1);var Se=[];de=String(de),M(this.i,function(Me){Me[0]!==de&&Se.push(Me)}),this.i=Se},e.entries=function de(){var Se,Me=this;return O(de,function(me){if(me.h==1&&(Se=0),me.h!=3)return Se<Me.i.length?me=g(me,Me.i[Se]):(me.h=0,me=void 0),me;Se++,me.h=2})},e.forEach=function(de,Se){V(arguments,1);for(var Me=c(this),me=Me.next();!me.done;me=Me.next()){var v=c(me.value);me=v.next().value,v=v.next().value,de.call(Se,v,me,this)}},e.get=function(de){V(arguments,1);var Se=this.i;de=String(de);for(var Me=0;Me<Se.length;Me++)if(Se[Me][0]===de)return Se[Me][1];return null},e.getAll=function(de){V(arguments,1);var Se=[];return de=String(de),M(this.i,function(Me){Me[0]===de&&Se.push(Me[1])}),Se},e.has=function(de){V(arguments,1),de=String(de);for(var Se=0;Se<this.i.length;Se++)if(this.i[Se][0]===de)return!0;return!1},e.keys=function de(){var Se,Me,me,v,L=this;return O(de,function(W){if(W.h==1&&(Se=c(L),Me=Se.next()),W.h!=3)return Me.done?void(W.h=0):(me=Me.value,v=c(me),g(W,v.next().value));Me=Se.next(),W.h=2})},e.set=function(de,Se,Me){V(arguments,2),de=String(de);var me=[],v=K(de,Se,Me),L=!0;M(this.i,function(W){W[0]===de?L&&(L=!me.push(v)):me.push(W)}),L&&me.push(v),this.i=me},e.values=function de(){var Se,Me,me,v,L=this;return O(de,function(W){if(W.h==1&&(Se=c(L),Me=Se.next()),W.h!=3)return Me.done?void(W.h=0):(me=Me.value,(v=c(me)).next(),g(W,v.next().value));Me=Se.next(),W.h=2})},Ht.prototype._asNative=function(){for(var de=new ce,Se=c(this),Me=Se.next();!Me.done;Me=Se.next()){var me=c(Me.value);Me=me.next().value,me=me.next().value,de.append(Me,me)}return de},Ht.prototype._blob=function(){var de="----formdata-polyfill-"+Math.random(),Se=[],Me="--"+de+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(me,v){return typeof me=="string"?Se.push(Me+xt(z(v))+`"\r
\r
`+z(me)+`\r
`):Se.push(Me+xt(z(v))+'"; filename="'+xt(me.name)+`"\r
Content-Type: `+(me.type||"application/octet-stream")+`\r
\r
`,me,`\r
`)}),Se.push("--"+de+"--"),new Blob(Se,{type:"multipart/form-data; boundary="+de})},Ht.prototype[Symbol.iterator]=function(){return this.entries()},Ht.prototype.toString=function(){return"[object FormData]"},at&&!at.matches&&(at.matches=at.matchesSelector||at.mozMatchesSelector||at.msMatchesSelector||at.oMatchesSelector||at.webkitMatchesSelector||function(de){for(var Se=(de=(this.document||this.ownerDocument).querySelectorAll(de)).length;0<=--Se&&de.item(Se)!==this;);return-1<Se}),Et&&(Ht.prototype[Et]="FormData"),xe){var Rs=Y.XMLHttpRequest.prototype.setRequestHeader;Y.XMLHttpRequest.prototype.setRequestHeader=function(de,Se){Rs.call(this,de,Se),de.toLowerCase()==="content-type"&&(this.B=!0)},Y.XMLHttpRequest.prototype.send=function(de){de instanceof Ht?(de=de._blob(),this.B||this.setRequestHeader("Content-Type",de.type),xe.call(this,de)):xe.call(this,de)}}ke&&(Y.fetch=function(de,Se){return Se&&Se.body&&Se.body instanceof Ht&&(Se.body=Se.body._blob()),ke.call(this,de,Se)}),lt&&(Y.navigator.sendBeacon=function(de,Se){return Se instanceof Ht&&(Se=Se._asNative()),lt.call(this,de,Se)}),Y.FormData=Ht}})();const eh=()=>{const e=C("AREAS");return e.length===0&&e.push(Kt.GLOBAL),or(e).call(e,(t,s,n)=>{const r=WD(s);return r?n===0?r:"".concat(t,",").concat(r):t},"")},WD=e=>e===Kt.OVERSEA?"".concat(Wn.ASIA,",").concat(Wn.EUROPE,",").concat(Wn.AFRICA,",").concat(Wn.NORTH_AMERICA,",").concat(Wn.SOUTH_AMERICA,",").concat(Wn.OCEANIA):Wn[e],eK=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map(s=>{const n=Xm[s],r=Object.keys(n);r&&r.map(i=>{i!=="CODE"&&(t[i]=t[i].concat(n[i]))})}),t},of={GLOBAL:{ASIA:[Kt.CHINA,Kt.JAPAN,Kt.INDIA,Kt.KOREA,Kt.HKMC],EUROPE:[],NORTH_AMERICA:[Kt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},cf=Object.keys(of[Kt.GLOBAL]),K_=[Kt.CHINA,Kt.NORTH_AMERICA,Kt.EUROPE,Kt.ASIA,Kt.JAPAN,Kt.INDIA,Kt.OCEANIA,Kt.SOUTH_AMERICA,Kt.AFRICA,Kt.KOREA,Kt.HKMC,Kt.US],tK=function(e,t){let s=[];if(_e(e).call(e,Kt.GLOBAL)){const i=[Kt.GLOBAL,Kt.OVERSEA],o=Object.keys(Xm);if(t===Kt.GLOBAL)throw new $(A.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Kt.CHINA)s=[Kt.OVERSEA];else if(r=t,_e(cf).call(cf,r)){const c=(n=t,of[Kt.GLOBAL][n]||[]),l=[...i,t,...c];s=o.filter(d=>!_e(l).call(l,d))}else if(function(c){let l=!1;return cf.forEach(d=>{var h;_e(h=of[Kt.GLOBAL][d]).call(h,c)&&(l=!0)}),l}(t)){const c=function(d){let h;return cf.forEach(p=>{var m;_e(m=of[Kt.GLOBAL][p]).call(m,d)&&(h=p)}),h}(t),l=[...i,c,t];s=o.filter(d=>!_e(l).call(l,d))}else s=e;s=function(c){const l=[];return K_.forEach(d=>{_e(c).call(c,d)&&l.push(d)}),l.concat(c.filter(d=>!_e(K_).call(K_,d)))}(s)}else s=e;var n,r;return s};function HD(e){var t,s;if(!e&&_e(t=C("AREAS")).call(t,Kt.EXTENSIONS))return b.debug("update area from ap : reset"),void Y_(d7,!0);if(!_e(s=C("AREAS")).call(s,Kt.GLOBAL)||!e)return;let n=Xm.EXTENSIONS;n&&(n={CODE:WD(Kt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},b.debug("update area from ap success: ".concat(e,",config is "),n),ss("AREAS",[Kt.EXTENSIONS],!0),Object.keys(n).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?ss(r,n[r][0]):ss(r,n[r])}))}function Y_(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const s=Ue.reportApiInvoke(null,{name:Ns.SET_AREA,options:e,tag:is.TRACER});try{let n=[];if(typeof e=="string"&&(n=[e]),Array.isArray(e)&&(e.forEach(i=>{if(!_e(pD).call(pD,i))throw new $(A.INVALID_PARAMS,"invalid area code")}),n=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:i,excludedArea:o}=e;if(!i)throw new $(A.INVALID_PARAMS,"area code is needed");let c=i;typeof i=="string"&&(c=[i]),n=o?tK(c,o):c}if(!t){if(Ka.AREAS){const i=new $(A.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return s.onError(i),void b.warning("setArea is prohibited because of config-distribute")}if(_e(n).call(n,Kt.GLOBAL)&&C("AREAS")===Kt.EXTENSIONS){const i=new $(A.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return s.onError(i),void b.warning("setArea is prohibited because of ap extensions")}}ss("AREAS",n,t);const r=eK(n);Object.keys(r).map(i=>{i==="LOG_UPLOAD_SERVER"||i==="EVENT_REPORT_DOMAIN"||i==="EVENT_REPORT_BACKUP_DOMAIN"||i==="PROXY_SERVER_TYPE3"?ss(i,r[i][0]):ss(i,r[i])}),b.debug("set area success:",n.join(","))}catch(n){throw s.onError(n),n}s.onSuccess()}function zD(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Li(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?zD(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):zD(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let q_=1;function sK(e,t,s,n,r){q_+=1;const i={sid:s.sid,command:"convergeAllocateEdge",uid:"666",appId:s.appId,ts:Math.floor(Date.now()/1e3),seq:q_,requestId:q_,version:lr,cname:s.cname},o={service_name:t,json_body:JSON.stringify(i)};let c,l,d=e[0];return ni(async()=>{c=Date.now();const h=await li(d,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-c,h.code!==0){const g=new $(A.UNEXPECTED_RESPONSE,"live streaming ap error, code"+h.code,{retry:!0,responseTime:l});throw b.error(g.toString()),g}const p=JSON.parse(h.json_body);if(p.code!==200){const g=new $(A.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(p.code,", reason: ").concat(p.reason),{code:p.code,responseTime:l});throw b.error(g.toString()),g}if(!p.servers||p.servers.length===0){const g=new $(A.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:p.code,responseTime:l});throw b.error(g.toString()),g}const m=function(g,T){return{addressList:g.servers.map(w=>"wss://".concat(w.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(w.wss,"?serviceName=").concat(encodeURIComponent(T))),workerToken:g.workerToken,vid:g.vid}}(p,t);return C("LIVE_STREAMING_ADDRESS")&&(m.addressList=C("LIVE_STREAMING_ADDRESS")instanceof Array?C("LIVE_STREAMING_ADDRESS"):[C("LIVE_STREAMING_ADDRESS")]),Li(Li({},m),{},{responseTime:l})},(h,p)=>(Ue.apworkerEvent(s.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(h.addressList),firstSuccess:p===0,responseTime:l,serverIp:e[p%e.length]}),!1),(h,p)=>(Ue.apworkerEvent(s.sid,{success:!1,sc:h.data&&h.data.code||200,serviceName:t,responseTime:l,serverIp:e[p%e.length]}),!!(h.code!==A.OPERATION_ABORTED&&h.code!==A.UNEXPECTED_RESPONSE||h.data&&h.data.retry)&&(d=e[(p+1)%e.length],!0)),r)}let X_=1;function KD(e,t,s,n){let{url:r,areaCode:i}=e;const{clientId:o,sid:c}=t,l=Date.now();let d;const h=t.role,[p,m]=$_(t,i,[qs.CHOOSE_SERVER]);let g=Ps.networkState;return ni(async()=>{g&&Ps.networkState===ua.OFFLINE&&Ps.onlineWaiter&&await Te.race([Ps.onlineWaiter,gn(n&&n.maxRetryTimeout||Ys.maxRetryTimeout)]),g=Ps.networkState;const{data:T,headers:w}=await li(r,{data:p,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=w.http3==="1"?1:-1,Ue.reportResourceTiming(r,c),qD(T,r,t,l,[qs.CHOOSE_SERVER],d);const S=qu(T,qs.CHOOSE_SERVER);return J_(S),L_(S,r)},T=>(T&&Ue.joinChooseServer(c,{role:h,lts:l,succ:!0,csAddr:r,opid:m,serverList:T.gatewayAddrs.map(w=>w.address),ec:null,cid:T.cid.toString(),uid:T.uid.toString(),csIp:T.csIp,unilbsServerIds:[qs.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:T.res.detail&&T.res.detail[38],vid:T.vid}),!1),T=>T.code!==A.OPERATION_ABORTED&&(T.code===A.CAN_NOT_GET_GATEWAY_SERVER?T.data.retry:(Ue.joinChooseServer(c,{role:h,lts:l,succ:!1,csAddr:r,serverList:null,opid:m,ec:T.code,csIp:T.data&&T.data.csIp,unilbsServerIds:[qs.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:g}),isHttp3:d,corssRegionTagReq:t.apRequestDetail}),b.warning("[".concat(o||"sid-".concat(c.slice(0,6)),"] Choose server network error, retry"),T),!0)),n)}function YD(e,t,s,n){let r,{url:i,areaCode:o,serviceIds:c}=e;const l=Date.now(),d=t.role,[h,p]=$_(t,o,c);let m;return ni(async()=>{m&&Ps.networkState===ua.OFFLINE&&Ps.onlineWaiter&&await Te.race([Ps.onlineWaiter,gn(n&&n.maxRetryTimeout||Ys.maxRetryTimeout)]),m=Ps.networkState;const{data:g,headers:T}=await li(i,{data:h,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=T.http3==="1"?1:-1,Ue.reportResourceTiming(i,t.sid),qD(g,i,t,l,c,r);const w=qu(g,qs.CHOOSE_SERVER),S=qu(g,t.cloudProxyServer==="proxy5"?qs.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?qs.CLOUD_PROXY:qs.CLOUD_PROXY_FALLBACK),I=performance.getEntriesByName(i),O=I[I.length-1];let M;return O&&(M={name:O.name,protocol:"nextHopProtocol"in O?O.nextHopProtocol:"",dnscost:"domainLookupEnd"in O&&"domainLookupStart"in O&&typeof O.domainLookupEnd=="number"&&typeof O.domainLookupStart=="number"?O.domainLookupEnd-O.domainLookupStart:-1,tcpTlsCost:"connectEnd"in O&&"connectStart"in O&&typeof O.connectEnd=="number"&&typeof O.connectStart=="number"?O.connectEnd-O.connectStart:-1,reqCost:"requestStart"in O&&typeof O.requestStart=="number"&&"responseEnd"in O&&typeof O.responseEnd=="number"?O.responseEnd-O.requestStart:-1,handleCost:"leave_ts"in g&&"enter_ts"in g&&typeof g.leave_ts=="number"&&typeof g.enter_ts=="number"?g.leave_ts-g.enter_ts:-1}),J_(w),{gatewayInfo:L_(w,i),proxyInfo:S,url:i,resourceTimingInfo:M}},g=>{var T;return g.gatewayInfo&&Ue.joinChooseServer(t.sid,{role:d,lts:l,succ:!0,csAddr:i,serverList:g.gatewayInfo.gatewayAddrs.map(w=>w.address),ec:null,opid:p,cid:g.gatewayInfo.cid.toString(),uid:g.gatewayInfo.uid.toString(),csIp:g.gatewayInfo.csIp,unilbsServerIds:c.toString(),isHttp3:r,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:g.gatewayInfo.res.detail&&g.gatewayInfo.res.detail[38],vid:(T=g.gatewayInfo)===null||T===void 0?void 0:T.vid,resourceTimingInfo:g.resourceTimingInfo?JSON.stringify(g.resourceTimingInfo):void 0}),g.proxyInfo&&Ue.joinWebProxyAP(t.sid,{lts:l,sucess:1,apServerAddr:i,turnServerAddrList:g.proxyInfo.addresses.map(w=>w.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:c.toString()}),!1},g=>g.code!==A.OPERATION_ABORTED&&(g.code===A.CAN_NOT_GET_GATEWAY_SERVER?g.data.retry:(Ue.joinWebProxyAP(t.sid,{lts:l,sucess:0,apServerAddr:i,turnServerAddrList:null,errorCode:g.code,eventType:t.cloudProxyServer,unilbsServerIds:c.toString(),extend:JSON.stringify({networkState:m})}),b.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),g),!0)),n)}const qD=(e,t,s,n,r,i)=>{const{sid:o,clientId:c,cloudProxyServer:l}=s,d=[],h=p=>{p.flag===4096?Ue.joinChooseServer(o,{role:s.role,lts:n,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:p.error.message,csIp:p.error.data&&p.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:i,corssRegionTagReq:s.apRequestDetail}):p.flag!==1048576&&p.flag!==4194304&&p.flag!==4194310||Ue.joinWebProxyAP(o,{lts:n,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:p.error.code,eventType:l,unilbsServerIds:r.toString()})};if(e.response_body.forEach(p=>{const m=p.buffer.code;if(p.uri===23&&m===0&&!p.buffer.edges_services)if(p.buffer.flag===4194310)b.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),p.buffer.edges_services=[];else{const g={error:new $(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:C("NO_EDGES_RETRY"),csIp:e.detail[502]}),flag:p.buffer.flag};d.push(g),h(g)}if(m!==0){const g=bd(m),T={error:new $(A.CAN_NOT_GET_GATEWAY_SERVER,g.desc,{desc:g.desc,retry:g.retry,csIp:e.detail[502]}),flag:p.buffer.flag};p.buffer.flag===4194310?b.warning(T.error.toString()):d.push(T),h(T)}}),d.length)throw b.warning("[".concat(c||"sid-".concat(o.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(d.map(p=>"flag: ".concat(p.flag,", message: ").concat(p.error.message,", retry: ").concat(p.error.data.retry)).join(" | "))),new $(A.CAN_NOT_GET_GATEWAY_SERVER,d.map(p=>"flag: ".concat(p.flag,", message: ").concat(p.error.message)).join(" | "),{retry:!!d.find(p=>p.error.data.retry),csIp:e.detail[502],desc:[...new Set(d.map(p=>{var m;return p==null||(m=p.error)===null||m===void 0||(m=m.data)===null||m===void 0?void 0:m.desc}).filter(p=>!!p))]})},J_=e=>{var t,s,n,r;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new $(A.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(C("AP_AREA")&&((n=e.detail)!==null&&n!==void 0&&n[23]&&typeof((r=e.detail)===null||r===void 0?void 0:r[23])=="string"?HD(e.detail[23].toLowerCase()):HD()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((s=e.detail)===null||s===void 0?void 0:s[19])=="string"){const o=e.detail[19],c=o==null?void 0:o.split(";");for(let l=0;l<c.length;l++){var i;const d=la(i=c[l]).call(i);e.addresses[l]&&c&&(e.addresses[l].fingerprint=d)}}if(C("GATEWAY_ADDRESS")&&C("GATEWAY_ADDRESS").length>0){b.debug("assign gateway address to",C("GATEWAY_ADDRESS"));const o=C("GATEWAY_ADDRESS").map(c=>{var l,d;const h=(l=(d=e.addresses.find(p=>p.ip===c.ip&&p.port===c.port))===null||d===void 0?void 0:d.fingerprint)!==null&&l!==void 0?l:"";return{ip:c.ip,port:c.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:c.fingerprint||h}});e.addresses=o}},nK=(e,t)=>{if(e.response_body&&e.response_body.length){const s=e.response_body[0];if(s.buffer.code!==0){const n=bd(s.buffer.code);throw new $(A.UPDATE_TICKET_FAILED,"[".concat(s.buffer.code,"]: ").concat(n.desc),{retry:n.retry})}return s.buffer.ticket}throw b.debug("update ticket request received ap response without response body:",t),new $(A.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},$_=(e,t,s)=>{const n=Math.floor(Math.random()*1e12),r=e.role==="host"?"1":e.role==="audience"?"2":void 0,i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:Li(Li(Li({6:e.stringUid,11:t,12:C("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:t},e.apRequestDetail?{33:e.apRequestDetail}:{}),e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:s,uid:e.uid||0}}]};i.request_bodies.forEach(c=>{e.multiIP&&e.multiIP.gateway_ip&&(c.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(i)),[o,n]},aK=(e,t)=>{const s=Math.floor(Math.random()*1e12),n={appid:e.appId,client_ts:Date.now(),opid:s,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map(i=>({ip:i.ip,port:i.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(n)),[r,s]};let Ed=0;function yd(e){return Te.all(e.map(t=>t.then(s=>{throw s},s=>s))).then(t=>{throw t},t=>t)}const th=async e=>{let{fragementLength:t,referenceList:s,asyncMapHandler:n,allFailedhandler:r,promisesCollector:i}=e,o=0;const c=t;let l,d=0;const h=async()=>{const p=(()=>{const m=o*c,g=m+c;return s.slice(m,g).map(n)})();i&&i.push(...p);try{l=await yd(p)}catch(m){if(d+=c,o++,!(d>=s.length))return void await h();r(m)}p.forEach(m=>m.cancel())};return await h(),l},XD=async e=>{let{referenceList:t,asyncMapHandler:s,closeFn:n}=e;const r=t.length;let i=0;const o=async()=>{const c=s(t.shift());try{return await c}catch(l){if(i++,i>=r||n!=null&&n(l))throw l;return o()}};return o()};async function rK(){if(typeof VideoDecoder>"u")return!0;let e;const t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],s=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],i=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],o=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new Te((l,d)=>{let h;(async function(){e&&e.state!=="closed"||await async function(){e=new VideoDecoder({output:m=>{m.close(),clearTimeout(h),l(!0)},error:m=>{clearTimeout(h),l(!1)}}),await e.configure({codec:"av01.0.05M.08",width:160,height:90})}();const p=[t,s,n,r,i,o];for(let m=0;m<p.length;m++){const g=new EncodedVideoChunk({type:m==0?"key":"delta",timestamp:33333*m,duration:33333,data:new Uint8Array(p[m])});try{await e.decode(g)}catch{return void l(!1)}}})(),h=setTimeout(()=>{l(!1)},5e3)})}async function lf(e,t,s,n){return{gatewayInfo:await async function(i,o,c,l){let d=null;const h=[],p=async()=>{const g=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(S=>({url:i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(S+"/api/v2/transpond/webrtc?v=2"):"https://".concat(S,"/api/v2/transpond/webrtc?v=2"),areaCode:eh()})),T=l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map(S=>S.url)}),w=await th({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:S=>(b.debug("[".concat(i.clientId,"] Connect to choose_server:"),S.url),KD(S,i,o,c)),allFailedhandler:S=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},T),S[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w},m=async()=>{if(await gn(1e3),d!==null)return d;const g=C("WEBCS_DOMAIN_BACKUP_LIST").map(S=>({url:i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(S+"/api/v2/transpond/webrtc?v=2"):"https://".concat(S,"/api/v2/transpond/webrtc?v=2"),areaCode:eh()})),T=l.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map(S=>S.url)}),w=await th({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:S=>(b.debug("[".concat(i.clientId,"] Connect to backup choose_server:"),S.url),KD(S,i,o,c)),allFailedhandler:S=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},T),S[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w};try{return d=await yd([p(),m()]),h.length&&h.forEach(g=>g.cancel&&typeof g.cancel=="function"&&g.cancel()),d}catch(g){throw g[0]}}(e,t,s,n)}}async function JD(e,t,s,n,r){const i=e.cloudProxyServer;if(i==="disabled"){if(e.useLocalAccessPoint)return await lf(e,t,s,r);if(C("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:m,proxyInfo:g}=await ZD(e,t,s,r);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:m};const T=g.map(w=>({turnServerURL:w.address,tcpport:w.tcpport||Un.tcpport,udpport:w.udpport||Un.udpport,username:w.username||Un.username,password:w.password||Un.password,forceturn:!1,security:!0}));if(r.useP2P){var o;const w=(o=e.uid)!==null&&o!==void 0?o:m.uid,S="glb:".concat(w.toString()),I=await kb(S),O=g.map(M=>({turnServerURL:M.address,tcpport:M.tcpport||Un.tcpport,udpport:M.udpport||Un.udpport,username:S,password:I,forceturn:!1,security:!0}));T.push(...O)}return e.turnServer={mode:"manual",servers:T},{gatewayInfo:m}}return await lf(e,t,s,r)}const{proxyInfo:c,gatewayInfo:l}=await ZD(e,t,s,r),d={gatewayInfo:l},h=c.map(m=>({turnServerURL:m.address,tcpport:i==="proxy3"?void 0:m.tcpport?m.tcpport:Un.tcpport,udpport:i==="proxy4"?void 0:m.udpport?m.udpport:Un.udpport,username:m.username||Un.username,password:m.password||Un.password,forceturn:i!=="proxy4",security:i==="proxy5"}));if(r.useP2P){var p;const m=(p=e.uid)!==null&&p!==void 0?p:l.uid,g="glb:".concat(m.toString()),T=await kb(g),w=c.map(S=>({turnServerURL:S.address,tcpport:i==="proxy3"?void 0:S.tcpport||Un.tcpport,udpport:i==="proxy4"?void 0:S.udpport||Un.udpport,username:g,password:T,forceturn:i!=="proxy4",security:i==="proxy5"}));h.push(...w)}return e.turnServer={mode:"manual",servers:h},b.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(i)),d}async function $D(e,t,s,n,r){const i=C("ACCOUNT_REGISTER").slice(0,C("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?i.map(l=>"https://".concat(t.proxyServer,"/ap/?url=").concat(l+"/api/v1")):i.map(l=>"https://".concat(l,"/api/v1"));const c=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const l=await async function(d,h,p,m,g){const T=Date.now(),w={sid:p.sid,opid:10,appid:p.appId,string_uid:h};let S=d[0];const I=await ni(()=>li(S+"".concat(S.indexOf("?")===-1?"?":"&","action=stringuid"),{data:w,cancelToken:m,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(O,M)=>{if(O.code===0){if(O.uid<=0||O.uid>=Math.pow(2,32))throw b.error("Invalid Uint Uid ".concat(h," => ").concat(O.uid),O),Ue.reqUserAccount(w.sid,{lts:T,success:!1,serverAddr:S,stringUid:w.string_uid,uid:O.uid,errorCode:A.INVALID_UINT_UID_FROM_STRING_UID,extend:w}),new $(A.INVALID_UINT_UID_FROM_STRING_UID);return Ue.reqUserAccount(w.sid,{lts:T,success:!0,serverAddr:S,stringUid:w.string_uid,uid:O.uid,errorCode:null,extend:w}),!1}const z=bd(O.code);return z.retry&&(S=d[(M+1)%d.length]),Ue.reqUserAccount(w.sid,{lts:T,success:!1,serverAddr:S,stringUid:w.string_uid,uid:O.uid,errorCode:z.desc,extend:w}),z.retry},(O,M)=>O.code!==A.OPERATION_ABORTED&&(Ue.reqUserAccount(w.sid,{lts:T,success:!1,serverAddr:S,stringUid:w.string_uid,uid:null,errorCode:O.code,extend:w}),S=d[(M+1)%d.length],!0),g);if(I.code!==0){const O=bd(I.code);throw new $(A.UNEXPECTED_RESPONSE,O.desc)}return I}(o,e,t,s,n);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},c),l.uid}catch(l){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[l]},c),l}}async function iK(e,t,s){const n=C("ACCOUNT_REGISTER");let r=[];r=t.proxyServer?n.map(i=>"https://".concat(t.proxyServer,"/ap/?url=").concat(i+"/api/v1")):n.map(i=>"https://".concat(i,"/api/v1"));try{return await XD({referenceList:r,asyncMapHandler:o=>async function(c,l,d,h){const p=Date.now(),m={sid:d.sid,opid:10,appid:d.appId,string_uid:l};try{const g=await li(c+"".concat(c.indexOf("?")===-1?"?":"&","action=stringuid"),{data:m,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(g.code!==0){const T=bd(g.code);throw new $(A.UNEXPECTED_RESPONSE,"preload sua error:".concat(T.desc),T)}if(g.uid<=0||g.uid>=Math.pow(2,32))throw new $(A.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:p,url:c,req:m,uid:g.uid,elapse:Date.now()-p}}catch(g){throw g}}(o,e,t,s),closeFn:o=>o.code===A.OPERATION_ABORTED||o.code===A.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(i){throw i}}async function oK(e,t,s){const n=C("CDS_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(l=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(l+"/api/v1"):"https://".concat(l,"/api/v1?action=config")),r=n.map(l=>function(d,h,p,m){const g=Ft(),T={flag:64,cipher_method:0,features:Li(Li(Li(Li(Li({install_id:Kb(),device:g.name,system:g.os,system_general:navigator.userAgent,vendor:h.appId,version:lr,cname:h.cname,session_id:h.sid,proxyServer:h.proxyServer,sdk_type:$7.WEB_RTC,browser_name:g.name,browser_version:g.version,user_agent:navigator.userAgent,channel_name:h.cname},h.stringUid&&{string_uid:h.stringUid}),h.uid&&{uid:h.uid+""}),g.os&&{os_name:g.os}),g.osVersion&&{os_version:g.osVersion}),{},{detail:""})};return ni(()=>li(d,{data:T,timeout:1e3,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,w=>w.code!==A.OPERATION_ABORTED,m)}(l,e,t,s));let i=null,o=null,c={};try{i=await yd(r)}catch(l){if(l.code===A.OPERATION_ABORTED)throw l;o=l}if(r.forEach(l=>l.cancel()),Ue.reportApiInvoke(e.sid,{name:Ns.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:i}}).onSuccess(),i&&i.test_tags)try{c=function(l){if(!l.test_tags)return{};const d=l.test_tags,h=Object.keys(d),p={};return h.forEach(m=>{var g;const T=la(g=m.slice(4)).call(g),w=JSON.parse(d[m]),S=w[1];p[T]={tag:w[0]||"",value:S}}),p}(i)}catch{}return c}async function QD(e,t){const s=C("WEBCS_DOMAIN").concat(C("WEBCS_DOMAIN_BACKUP_LIST")).map(n=>({url:"https://".concat(n,"/api/v2/transpond/webrtc?v=2"),areaCode:eh(),serviceIds:[qs.CHOOSE_SERVER,qs.CLOUD_PROXY_FALLBACK]}));try{return await XD({referenceList:s,asyncMapHandler:r=>async function(i,o,c){let l,{url:d,areaCode:h,serviceIds:p}=i;const m=Date.now(),[g,T]=$_(o,h,p);let w=Ps.networkState;try{w&&Ps.networkState===ua.OFFLINE&&Ps.onlineWaiter&&await Te.race([Ps.onlineWaiter,gn(Ys.maxRetryTimeout)]),w=Ps.networkState;const{data:S,headers:I}=await li(d,{data:g,cancelToken:c,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=I.http3==="1"?1:-1,(K=>{const V=[];if(K.response_body.forEach(Y=>{const ce=Y.buffer.code;if(Y.uri===23&&ce===0&&!Y.buffer.edges_services)if(Y.buffer.flag===4194310)Y.buffer.edges_services=[];else{const xe={error:new $(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:C("NO_EDGES_RETRY"),csIp:K.detail[502]}),flag:Y.buffer.flag};V.push(xe)}if(ce!==0){const xe=bd(ce),ke={error:new $(A.CAN_NOT_GET_GATEWAY_SERVER,xe.desc,{desc:xe.desc,retry:xe.retry,csIp:K.detail[502]}),flag:Y.buffer.flag};Y.buffer.flag===4194310?b.warning(ke.error.toString()):V.push(ke)}}),V.length)throw new $(A.CAN_NOT_GET_GATEWAY_SERVER,V.map(Y=>"flag: ".concat(Y.flag,", message: ").concat(Y.error.message)).join(" | "),{retry:!!V.find(Y=>Y.error.data.retry),csIp:K.detail[502],desc:[...new Set(V.map(Y=>{var ce;return Y==null||(ce=Y.error)===null||ce===void 0||(ce=ce.data)===null||ce===void 0?void 0:ce.desc}).filter(Y=>!!Y))]})})(S);const M=qu(S,qs.CHOOSE_SERVER),z=qu(S,qs.CLOUD_PROXY_FALLBACK);return J_(M),{gatewayInfo:L_(M,d),proxyInfo:z,opid:T,requestTime:m,url:d,isHttp3:l,elapse:Date.now()-m}}catch(S){throw S}}(r,e,t),closeFn:r=>r.code===A.OPERATION_ABORTED||r.code===A.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(n){throw n}}async function ZD(e,t,s,n){const r=C("PROXY_SERVER_TYPE3"),i=(g,T,w)=>{let S=w||r;return Array.isArray(S)&&(S=T%2==0&&r[1]||r[0]),"https://".concat(S,"/ap/?url=").concat(g)};let o=null;const c=[],l=async()=>{const g=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map((S,I)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?i("".concat(S,"/api/v2/transpond/webrtc?v=2"),I,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(S,"/api/v2/transpond/webrtc?v=2"):i("".concat(S,"/api/v2/transpond/webrtc?v=2"),I),{url:O,areaCode:eh(),serviceIds:[qs.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?qs.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?qs.CLOUD_PROXY:qs.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map(S=>S.url)}),w=await th({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:S=>(b.debug("[".concat(e.clientId,"] Connect to choose_server:"),S.url),YD(S,e,t,s)),allFailedhandler:S=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},T),S[0]},promisesCollector:c});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w},d=async()=>{if(await gn(1e3),o!==null)return o;const g=C("WEBCS_DOMAIN_BACKUP_LIST").map((S,I)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?i("".concat(S,"/api/v2/transpond/webrtc?v=2"),I,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(S,"/api/v2/transpond/webrtc?v=2"):i("".concat(S,"/api/v2/transpond/webrtc?v=2"),I),{url:O,areaCode:eh(),serviceIds:[qs.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?qs.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?qs.CLOUD_PROXY:qs.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map(S=>S.url)}),w=await th({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:S=>(b.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),S.url),YD(S,e,t,s)),allFailedhandler:S=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:S},T),S[0]},promisesCollector:c});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w};let h,p,m;try{({gatewayInfo:h,proxyInfo:p,url:m}=await yd([l(),d()]))}catch(g){throw g[0]}if(c.length&&c.forEach(g=>g.cancel&&typeof g.cancel=="function"&&g.cancel()),!h||!p)throw new $(A.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=m,e.cloudProxyServer!=="disabled"&&Array.isArray(r)&&m){const g=/^https?:\/\/(.+?)(\/.*)?$/.exec(m)[1];_e(r).call(r,g)&&(e.proxyServer=g,b.setProxyServer(g),Ue.setProxyServer(g))}return o={gatewayInfo:h,proxyInfo:await wD(p,h.uid)},o}async function cK(e,t,s){const n=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(i=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(i+"/api/v1?action=uap"):"https://".concat(i,"/api/v1?action=uap")),r=n.map(i=>function(o,c,l,d){const h={command:"convergeAllocateEdge",sid:c.sid,appId:c.appId,token:c.token,ts:Date.now(),version:lr,cname:c.cname,uid:c.uid.toString(),requestId:X_,seq:X_};X_+=1;const p={service_name:"tele_channel",json_body:JSON.stringify(h)};return ni(async()=>{const m=await li(o,{data:p,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(m.code!==0){const T=new $(A.UNEXPECTED_RESPONSE,"cross channel ap error, code"+m.code,{retry:!0});throw b.error(T.toString()),T}const g=JSON.parse(m.json_body);if(g.code!==200){const T=new $(A.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(g.code,", reason: ").concat(g.reason));throw b.error(T.toString()),T}if(!g.servers||g.servers.length===0){const T=new $(A.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw b.error(T.toString()),T}return{vid:g.vid,workerToken:g.workerToken,addressList:(C("CHANNEL_MEDIA_RELAY_SERVERS")||g.servers).map(T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(T.wss))}},void 0,m=>!!(m.code!==A.OPERATION_ABORTED&&m.code!==A.UNEXPECTED_RESPONSE||m.data&&m.data.retry),d)}(i,e,t,s));try{const i=await yd(r);return r.forEach(o=>o.cancel()),i}catch(i){throw i[0]}}async function lK(e,t,s){let n=null;const r=[],i=async o=>{const c=C(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(l=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(l+"/api/v2/transpond/webrtc?v=2"):"https://".concat(l,"/api/v2/transpond/webrtc?v=2"));return o&&(await gn(1e3),n!==null)?n:await th({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:c,asyncMapHandler:l=>(b.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),l),function(d,h,p,m){const[g]=aK(h,[qs.CHOOSE_SERVER]);let T=Ps.networkState;return ni(async()=>{T&&Ps.networkState===ua.OFFLINE&&Ps.onlineWaiter&&await Te.race([Ps.onlineWaiter,gn(m&&m.maxRetryTimeout||Ys.maxRetryTimeout)]),T=Ps.networkState;const w=await li(d,{data:g,cancelToken:p,headers:{"Content-Type":"multipart/form-data;"}},!0);return nK(w,d)},()=>!1,w=>w.code!==A.OPERATION_ABORTED&&(w.code===A.UPDATE_TICKET_FAILED?w.data.retry:(b.warning("[".concat(h.clientId,"] update ticket network error, retry"),w),!0)),m)}(l,e,t,s)),allFailedhandler:l=>{throw l[0]},promisesCollector:r})};try{return n=await yd([i(!1),i(!0)]),r.length&&r.forEach(o=>o.cancel&&typeof o.cancel=="function"&&o.cancel()),n}catch(o){throw o[0]}}function ek(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Q_(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?ek(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ek(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class dK extends Cs{get isSuccess(){return!!this.configs}constructor(t,s){super(),N(this,"configs",void 0),N(this,"store",void 0),N(this,"joinInfo",void 0),N(this,"cancelToken",void 0),N(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),N(this,"interval",void 0),N(this,"mutex",void 0),N(this,"mutableParamsRead",!1),N(this,"configCache",{}),N(this,"limit_bitrate",void 0),this.mutex=new wn("config-distribute",t),this.store=s}startGetConfigDistribute(t,s){this.joinInfo=t,this.cancelToken=s,this.interval&&this.stopGetConfigDistribute(),C("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},C("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Ue.reportApiInvoke(null,{options:void 0,name:Ns.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:is.TRACER}).onSuccess(JSON.stringify(Ka))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void b.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const s=await this.mutex.lock();try{t=await oK(this.joinInfo,this.cancelToken,this.retryConfig),b.debug("[config-distribute] get config distribute",JSON.stringify(t));const n=function(r){var i;const o=bc(i=Object.keys(r).filter(d=>/^webrtc_ng_global_parameter/.test(d))).call(i);for(let d=0;d<o.length;d++)for(let h=o.length-1;h>d;h--){const p=o[h],m=r[p].value;if(typeof m.__priority=="number"){const g=m.__priority,T=o[h-1],w=r[T].value;if(typeof w.__priority=="number"){if(!(g>w.__priority))continue;{const S=p;o[h]=o[h-1],o[h-1]=S}}else{const S=p;o[h]=o[h-1],o[h-1]=S}}}const c=Date.now(),l={};return o.forEach(d=>{const h=r[d].value.__expires;h&&h<=c||(l[d]=r[d])}),l}(t);this.cacheGlobalParameterConfig(n),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=n}catch(n){const r=new $(A.NETWORK_RESPONSE_ERROR,n);b.warning("[config-distribute] ".concat(r.toString()))}finally{s()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(t){mD(t)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==t.id&&this.emit(ii.UPDATE_BITRATE_LIMIT,t):this.emit(ii.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.limit_bitrate&&Q_({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(t){try{const s={},n=Object.keys(t),r=[];n.forEach(i=>{const o=t[i].value;s[i]=o;const c=o.__id;if(c&&this.configCache[i]&&this.configCache[i].__id===c)return;const l=o.__type,d=t[i].value,h=t[i].tag;let p=0;l?l===kI.REALTIME&&(p=1):Object.keys(d).some(m=>Object.prototype.hasOwnProperty.call(Jb,m)||!S_()&&Object.prototype.hasOwnProperty.call(Nm,m)?(p=1,!0):void 0),r.push({tag:h,isApplied:p,feature:i,params:JSON.stringify(o)})}),r.forEach(i=>{let{tag:o,feature:c,params:l,isApplied:d}=i;this.store.sessionId&&Ue.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:o,feature:c,params:l,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=s}catch(s){b.debug("handleABTestConfigDistribute error",s)}}cacheGlobalParameterConfig(t){const s=function(r){const i={};return Object.keys(r).forEach(o=>{const c=r[o].value,l=c.__expires,d=c.__type;Object.keys(c).forEach(h=>{h==="__id"||h==="__type"||h==="__priority"||h==="__expires"||Object.prototype.hasOwnProperty.call(i,h)||(i[h]=Q_(Q_({value:c[h]},l&&{expires:l}),d&&{type:d}))})}),i}(t);try{var n;const r=(n=s.LIMIT_BITRATE)===null||n===void 0?void 0:n.value;delete s.LIMIT_BITRATE,r&&mD(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(s),this.handleABTestConfigDistribute(t),function(c){try{const l=Date.now();Object.keys(c).forEach(d=>{const{value:h,type:p,expires:m}=c[d];m&&m<=l||((p===kI.REALTIME||Object.prototype.hasOwnProperty.call(Jb,d))&&(Ka[d]=h,$t[d]=h,b.debug("Update realtime parameters from config distribute",d,h)),p||S_()||!Object.prototype.hasOwnProperty.call(Nm,d)||(Ka[d]=h,$t[d]=h,b.debug("Update gateway parameters from config distribute",d,h)))})}catch(l){b.error("Error update config immediately: ".concat(c),l.message)}}(s);const i=JSON.stringify(s),o=window.btoa(i);window.localStorage.setItem("websdk_ng_global_parameter",o),b.debug("Caching global parameters ".concat(i))}catch(r){b.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(t){try{const s=Date.now();Object.keys(t).forEach(n=>{switch(n){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call($t,n)){const{value:i,expires:o}=t[n];if(o&&o<=s)return;Ub($t[n],i)||(Ka[n]=i,$t[n]=i,this.emit(ii.UPDATE_CLIENT_ROLE_OPTIONS,i),b.debug("Updating client role options: ".concat(JSON.stringify(i))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call($t,n)){var r;const{value:i,expires:o}=t[n];if(o&&o<=s)return;typeof i=="number"&&_e(r=[0,1,4,5,6,7,8,9]).call(r,i)&&(Ka[n]={value:i},$t[n]=i,this.emit(ii.UPDATE_REMOTE_VIDEO_STREAM_TYPE,i),b.debug("Updating client remote stream type: ".concat(JSON.stringify(i))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call($t,n)){const{value:i,expires:o}=t[n];if(o&&o<=s)return;Ub($t[n],i)||(Ka[n]=i,$t[n]=i,this.emit(ii.FALLBACK_TO_HLS,i),b.debug("Updating enable force hls: ".concat(JSON.stringify(i))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call($t,n)){const{value:i,expires:o}=t[n];if(o&&o<=s)return;Ub($t[n],i)||(Ka[n]=i,$t[n]=i,this.emit(ii.UPDATE_VOS_CONFIGURE,i),b.debug("Updating vos configure: ".concat(JSON.stringify(i))))}}})}catch(s){b.error("Error handling global parameter config:",s.message)}}}class uK extends Cs{constructor(){super(...arguments),N(this,"resultStorage",new Map)}setLocalAudioStats(t,s,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(n,s)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(n,s))}setLocalVideoStats(t,s,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(n,s)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(n,s)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(n)),!s.muted&&this.record("VIDEO_ENCODE_FAILED",t,this.checResolutionSent(n))}setRemoteAudioStats(t,s){const n=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(s))}setRemoteVideoStats(t,s){const n=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(s))}record(t,s,n){if(C("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(t);if(!r)return;r.result.push(n);const i=t==="VIDEO_ENCODE_FAILED"?C("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=i){var o;const c=_e(o=r.result).call(o,!0);r.isPrevNormal&&!c&&this.emit("exception",Z_[t],t,s),!r.isPrevNormal&&c&&this.emit("exception",Z_[t]+2e3,t+"_RECOVER",s),r.isPrevNormal=c,r.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,s){return s instanceof nn&&!s.isActive||!!s.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,s){let n=null;s._encoderConfig&&s._encoderConfig.frameRate&&(n=ya(s._encoderConfig.frameRate));const r=t.captureFrameRate;return!n||!r||!(n>10&&r<5||n<10&&n>=5&&r<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checResolutionSent(t){var s;return!(!t.codecType||_e(s=C("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(s,t.codecType.toLocaleLowerCase()))||!t.captureFrameRate||t.sendFrameRate!==0||t.sendResolutionWidth!==0||t.sendResolutionHeight!==0}checkSendVideoBitrate(t,s){return!!s.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,s){return s instanceof nn&&!s.isActive||!!s.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const Z_={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},Hn=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const s=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(s.length>0){const n=s[s.length-1];return Math.round(performance.now()-n.startTime)}return 0}measureFromPublishStart(e,t){const s=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(s.length>0){const n=s[s.length-1];return Math.round(performance.now()-n.startTime)}return 0}};function tk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Yc(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?tk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):tk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class sh{constructor(t){N(this,"store",void 0),N(this,"onStatsException",void 0),N(this,"onUploadPublishDuration",void 0),N(this,"onStatsChanged",void 0),N(this,"onVideoCodecChanged",void 0),N(this,"localStats",new Map),N(this,"remoteStats",new Map),N(this,"updateStatsInterval",void 0),N(this,"trafficStats",void 0),N(this,"trafficStatsPeerList",[]),N(this,"uplinkStats",void 0),N(this,"exceptionMonitor",void 0),N(this,"p2pChannel",void 0),N(this,"scalabilityMode",wm.L1T1),N(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.exceptionMonitor=new uK,this.exceptionMonitor.on("exception",(s,n,r)=>{this.onStatsException&&this.onStatsException(s,n,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(ve.LocalAudioTrack)||Yc({},s_)}getLocalVideoTrackStats(){return this.localStats.get(ve.LocalVideoTrack)||Yc({},n_)}getRemoteAudioTrackStats(t){const s=(i,o)=>{if(!this.trafficStats)return o;const c=this.trafficStats.peer_delay.find(l=>l.peer_uid===i);return c&&(o.publishDuration=c.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},n={};if(t){var r;const i=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.audioStats;i&&(n[t]=s(t,i))}else Array.from(this.remoteStats.entries()).forEach(i=>{let[o,{audioStats:c}]=i;c&&(n[o]=s(o,c))});return n}getRemoteNetworkQualityStats(t){const s={};if(t){var n;const r=(n=this.remoteStats.get(t))===null||n===void 0?void 0:n.networkStats;r&&(s[t]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[i,{networkStats:o}]=r;o&&(s[i]=o)});return s}getNetworkQuality(){let t=0,s=0;return this.trafficStats&&(t=Zm(this.trafficStats.B_unq),s=Zm(this.trafficStats.B_dnq)),{uplinkNetworkQuality:t,downlinkNetworkQuality:s}}getRemoteVideoTrackStats(t){const s=(i,o)=>{if(!this.trafficStats)return o;const c=this.trafficStats.peer_delay.find(l=>l.peer_uid===i);return c&&(o.publishDuration=c.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},n={};if(t){var r;const i=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.videoStats;i&&(n[t]=s(t,i))}else Array.from(this.remoteStats.entries()).forEach(i=>{let[o,{videoStats:c}]=i;c&&(n[o]=s(o,c))});return n}getRTCStats(){let t=0,s=0,n=0,r=0;const i=this.localStats.get(ve.LocalAudioTrack);i&&(t+=i.sendBytes,s+=i.sendBitrate);const o=this.localStats.get(ve.LocalVideoTrack);o&&(t+=o.sendBytes,s+=o.sendBitrate);const c=this.localStats.get(ve.LocalVideoLowTrack);c&&(t+=c.sendBytes,s+=c.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:h,videoStats:p}=d;h&&(n+=h.receiveBytes,r+=h.receiveBitrate),p&&(n+=p.receiveBytes,r+=p.receiveBitrate)});let l=1;return this.trafficStats&&(l+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:l,SendBitrate:s,SendBytes:t,RecvBytes:n,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(s=>s.B_ppad!==void 0||s.B_ppvd!==void 0),t.peer_delay.filter(s=>this.trafficStatsPeerList.indexOf(s.peer_uid)===-1).forEach(s=>{var n;const r=(n=this.p2pChannel)===null||n===void 0?void 0:n.getRemoteMedia(s.peer_uid),i=r!=null&&r.videoSSRC?Hn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?Hn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;s.B_ppad!==void 0&&s.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(s.peer_uid,s.B_ppad,s.B_ppvd,i>o?i:o),this.trafficStatsPeerList.push(s.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&b.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,s,n){if(!t)return!1;const r=!!n&&s.framesDecodeFreezeTime>n.framesDecodeFreezeTime,i=!n||s.framesDecodeCount>n.framesDecodeCount;return r||!i}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(s=>{let[n,r]=s;switch(n){case ve.LocalVideoTrack:case ve.LocalVideoLowTrack:{const c=r,l=Yc({},n_),d=t.getStats(),h=t.getLocalMedia(n);if(d){const p=d.videoSend.find(m=>m.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){const m=t.getLocalVideoSize(),g=t.getEncoderConfig(ve.LocalVideoTrack);var i;(p.codec==="H264"||p.codec==="H265"||p.codec==="VP8"||p.codec==="VP9"||p.codec==="AV1X"||p.codec==="AV1")&&(l.codecType=p.codec,(c==null?void 0:c.codecType)!==p.codec&&((i=this.onVideoCodecChanged)===null||i===void 0||i.call(this,p.codec.toLocaleLowerCase()))),l.sendBytes=p.bytes,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0,p.inputFrame?(l.captureFrameRate=p.inputFrame.frameRate,l.captureResolutionHeight=p.inputFrame.height,l.captureResolutionWidth=p.inputFrame.width):m&&(l.captureResolutionWidth=m.width,l.captureResolutionHeight=m.height),p.sentFrame?(l.sendFrameRate=p.sentFrame.frameRate,l.sendResolutionHeight=p.sentFrame.height,l.sendResolutionWidth=p.sentFrame.width):m&&(l.sendResolutionWidth=m.width,l.sendResolutionHeight=m.height),p.avgEncodeMs&&(l.encodeDelay=p.avgEncodeMs),g&&g.bitrateMax?l.targetSendBitrate=1e3*g.bitrateMax:p.targetBitrate&&(l.targetSendBitrate=p.targetBitrate),l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.totalDuration=c?c.totalDuration+1:1,l.totalFreezeTime=c?c.totalFreezeTime:0,this.isLocalVideoFreeze(p)&&(l.totalFreezeTime+=1),p.scalabilityMode&&this.scalabilityMode!==p.scalabilityMode&&(b.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(p.scalabilityMode)),this.scalabilityMode=p.scalabilityMode)}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(n,l),((c==null?void 0:c.sendResolutionWidth)!==l.sendResolutionWidth||(c==null?void 0:c.sendResolutionHeight)!==l.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:l.sendResolutionWidth,height:l.sendResolutionHeight})),l&&h&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,h.track,l);break}case ve.LocalAudioTrack:{const c=r,l=Yc({},s_),d=t.getStats(),h=t.getLocalMedia(n);if(d){const p=d.audioSend.find(m=>m.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){if(p.codec!=="opus"&&p.codec!=="aac"&&p.codec!=="PCMU"&&p.codec!=="PCMA"&&p.codec!=="G722"||(l.codecType=p.codec),p.inputLevel)l.sendVolumeLevel=Math.round(32767*p.inputLevel);else{const m=t.getLocalAudioVolume();m&&(l.sendVolumeLevel=Math.round(32767*m))}l.sendBytes=p.bytes,l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0}}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(ve.LocalAudioTrack,l),l&&h&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,h.track,l);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(s=>{var n,r;let[i,{videoStats:o,audioStats:c,videoPcStats:l}]=s;const d=c,h=o,p=l,m=Yc({},YI),g=Yc({},qI),T=Yc({},Jz),{audioTrack:w,videoTrack:S,audioSSRC:I,videoSSRC:O}=t.getRemoteMedia(i);let M;M=this.store.useP2P?t.getStats(!0):t.getStats();const z=(n=M)===null||n===void 0?void 0:n.audioRecv.find(ce=>ce.ssrc===I),K=(r=M)===null||r===void 0?void 0:r.videoRecv.find(ce=>ce.ssrc===O),V=this.trafficStats&&this.trafficStats.peer_delay.find(ce=>ce.peer_uid===i);if(z&&(z.codec!=="opus"&&z.codec!=="aac"&&z.codec!=="PCMU"&&z.codec!=="PCMA"&&z.codec!=="G722"||(m.codecType=z.codec),z.outputLevel?m.receiveLevel=Math.round(32767*z.outputLevel):w&&(m.receiveLevel=Math.round(32767*w.getVolumeLevel())),m.receiveBytes=z.bytes,m.receivePackets=z.packets,m.receivePacketsLost=z.packetsLost,m.receivePacketsDiscarded=z.packetsDiscarded,m.packetLossRate=m.receivePacketsLost/(m.receivePackets+m.receivePacketsLost),m.receiveBitrate=d?8*Math.max(0,m.receiveBytes-d.receiveBytes):0,m.totalDuration=d?d.totalDuration+1:1,m.totalFreezeTime=d?d.totalFreezeTime:0,m.freezeRate=m.totalFreezeTime/m.totalDuration,m.receiveDelay=z.jitterBufferMs,m.totalDuration>10&&sh.isRemoteAudioFreeze(w)&&(m.totalFreezeTime+=1)),K){var Y;K.codec!=="H264"&&K.codec!=="H265"&&K.codec!=="VP8"&&K.codec!=="VP9"&&K.codec!=="AV1X"&&K.codec!=="AV1"||(g.codecType=K.codec),g.receiveBytes=K.bytes,g.receiveBitrate=h?8*Math.max(0,g.receiveBytes-h.receiveBytes):0,g.decodeFrameRate=K.decodeFrameRate<0?0:K.decodeFrameRate,g.renderFrameRate=K.decodeFrameRate<0?0:K.decodeFrameRate,K.outputFrame&&(g.renderFrameRate=K.outputFrame.frameRate),K.receivedFrame?(g.receiveFrameRate=K.receivedFrame.frameRate,g.receiveResolutionHeight=K.receivedFrame.height,g.receiveResolutionWidth=K.receivedFrame.width):S&&(g.receiveResolutionHeight=S._videoHeight||0,g.receiveResolutionWidth=S._videoWidth||0),K.framesRateFirefox!==void 0&&(g.receiveFrameRate=Math.round(K.framesRateFirefox)),g.receivePackets=K.packets,g.receivePacketsLost=K.packetsLost,g.packetLossRate=g.receivePacketsLost/(g.receivePackets+g.receivePacketsLost);const ce=h?h.totalFreezeTime:0,xe=h?h.totalDuration:0;g.totalDuration=h?h.totalDuration+1:1,g.totalFreezeTime=(Y=K.totalFreezesDuration)!==null&&Y!==void 0?Y:ce||0,g.receiveDelay=K.jitterBufferMs||0;const ke=!!O&&t.getRemoteVideoIsReady(O);K.totalFreezesDuration===void 0&&S&&ke&&sh.isRemoteVideoFreeze(S,K,p)&&(g.totalFreezeTime+=1),g.freezeRate=Math.max(0,Math.min((g.totalFreezeTime-ce)/(g.totalDuration-xe),1))}V&&(m.end2EndDelay=V.B_ad,g.end2EndDelay=V.B_vd,m.transportDelay=V.B_ed,g.transportDelay=V.B_ed,m.currentPacketLossRate=V.B_ealr4/100,g.currentPacketLossRate=V.B_evlr4/100,T.uplinkNetworkQuality=V.B_punq?V.B_punq:0,T.downlinkNetworkQuality=V.B_pdnq?V.B_pdnq:0),this.remoteStats.set(i,{audioStats:m,videoStats:g,videoPcStats:K,networkStats:T}),w&&this.exceptionMonitor.setRemoteAudioStats(w,m),S&&this.exceptionMonitor.setRemoteVideoStats(S,g)})}}class sk{constructor(){N(this,"destChannelMediaInfos",new Map),N(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){hD(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){hD(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Km(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function nk(e){if(!(e instanceof sk))return new $(A.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),s=e.getDestChannelMediaInfo();if(!t)return new $(A.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(s.size===0)return new $(A.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Yo{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,s){N(this,"uid",void 0),N(this,"_uintid",void 0),N(this,"_trust_in_room_",!0),N(this,"_trust_audio_enabled_state_",!0),N(this,"_trust_video_enabled_state_",!0),N(this,"_trust_audio_mute_state_",!0),N(this,"_trust_video_mute_state_",!0),N(this,"_audio_muted_",!1),N(this,"_video_muted_",!1),N(this,"_audio_enabled_",!0),N(this,"_video_enabled_",!0),N(this,"_audio_added_",!1),N(this,"_video_added_",!1),N(this,"_is_pre_created",!1),N(this,"_video_pre_subscribed",!1),N(this,"_audio_pre_subscribed",!1),N(this,"_trust_video_stream_added_state_",!0),N(this,"_trust_audio_stream_added_state_",!0),N(this,"_audioTrack",void 0),N(this,"_videoTrack",void 0),N(this,"_dataChannels",[]),N(this,"_audioSSRC",void 0),N(this,"_videoSSRC",void 0),N(this,"_audioOrtc",void 0),N(this,"_videoOrtc",void 0),N(this,"_cname",void 0),N(this,"_rtxSsrcId",void 0),N(this,"_videoMid",void 0),N(this,"_audioMid",void 0),this.uid=t,this._uintid=s}}function ak(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function ev(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?ak(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ak(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const hK=e=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(e?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),df="9",tv=2e4,uf=4e4;let rk=class{get localCapabilities(){return _s(this._localCapabilities)}get rtpCapabilities(){return _s(this._rtpCapabilities)}get candidates(){return _s(this._candidates)}get iceParameters(){return _s(this._iceParameters)}get dtlsParameters(){return _s(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],s=arguments.length>2&&arguments[2]!==void 0&&arguments[2],n=arguments.length>3&&arguments[3]!==void 0&&arguments[3];N(this,"sessionDesc",void 0),N(this,"_localCapabilities",void 0),N(this,"_rtpCapabilities",void 0),N(this,"_candidates",void 0),N(this,"_originCandidates",void 0),N(this,"_iceParameters",void 0),N(this,"_isUseExtmapAllowMixed",void 0),N(this,"_isUseLocalCodecs",void 0),N(this,"_isUseDataChannel",void 0),N(this,"_dtlsParameters",void 0),N(this,"setup",void 0),N(this,"currentMidIndex",void 0),N(this,"cname",void 0),N(this,"useLocalCodecsMids",[]),N(this,"preloadSsrcs",[]),N(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=s,this._isUseDataChannel=n,e=_s(e);const{iceParameters:r,dtlsParameters:i,candidates:o,rtpCapabilities:c,setup:l,localCapabilities:d,cname:h}=e;this._rtpCapabilities=c,this._candidates=o,this._originCandidates=_s(o),this._iceParameters=r,this._dtlsParameters=i,this._localCapabilities=d,this.setup=l,this.cname=h,[this.sessionDesc]=this.updateRemoteRTPCapabilities(c),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every(t=>{var s;return _e(s=this.preloadSsrcs).call(s,t)})}preloadRemoteMedia(e){let t=0;const s=[],n=[];for(;e>0;){const r=[ev({ssrcId:uf+t},C("USE_SUB_RTX")?{rtx:uf+t+1}:{})],i="".concat(uf+t,"_").concat(tv+t),{ssrcs:o,ssrcGroups:c}=$u(r,this.cname,C("SYNC_GROUP")?i:void 0),l=this.preCreateOrRecycleSendMedia("video",o,c,void 0),d=[{ssrcId:tv+t}],h="".concat(uf+t,"_").concat(tv+t),{ssrcs:p,ssrcGroups:m}=$u(d,this.cname,C("SYNC_GROUP")?h:void 0),g=this.preCreateOrRecycleSendMedia("audio",p,m,void 0);e--,t+=2,s.push(l,g),n.push(o[0].ssrcId,p[0].ssrcId)}return this.useLocalCodecsMids.push(...s),this.preloadSsrcs=n,{mids:s,preSSRCs:n,isAvailable:!0}}preCreateOrRecycleSendMedia(e,t,s,n){const r=this.rtpCapabilities.send.videoCodecs,i=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;b.debug("create or recycle send media without remote rtp capabilities, ssrcs ",t[0].ssrcId);const o=e===Le.VIDEO?i.videoCodecs:i.audioCodecs,c=e===Le.VIDEO?i.videoExtensions:i.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:df,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:s,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};return d=this.mungSendMediaDesc(d,n),this.sessionDesc.mediaDescriptions.push(d),this.updateBundleMids(),l}toString(){return ao(this.sessionDesc)}send(e,t,s,n){const{ssrcs:r,ssrcGroups:i}=$u(t,this.cname,C("SYNC_GROUP")?s:void 0),o=this.findPreloadMediaDesc(r);if(o){if(bs()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,r);let l;return c===-1||c===1&&(yn()||function(){const d=Ft();return!(d.name!==Wt.CHROME||!d.osVersion)&&Number(d.version)<=90}()||si(143)||Uo(143)||C("RESERVE_MID_1_MLINE")||C("ENABLE_ENCODED_TRANSFORM")&&so())||c===0&&!function(d){const h=Ft();return!(h.name!==Wt.FIREFOX||!h.osVersion)&&Number(h.version)===d}(138)&&C("USE_SUB_RTX")||eI()?(l=this.createOrRecycleSendMedia(e,r,i,"sendonly",n),this.updateBundleMids()):(l=_s(this.sessionDesc.mediaDescriptions[c]),l.attributes.direction="sendonly",l.attributes.ssrcs=r,l.attributes.ssrcGroups=i,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(l,n)),bs()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,l.attributes.mid),{mid:l.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map(r=>{let{kind:i,ssrcMsg:o,mslabel:c}=r;return this.send(i,o,c)}),s=[];let n=!1;return t.forEach(r=>{let{mid:i,needExchangeSDP:o}=r;o&&(n=!0),s.push(i)}),{mids:s,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>s.attributes.mid&&e.indexOf(s.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(s=>{s.attributes.mid==="0"||bs()||eI()?s.attributes.ssrcs=[]:(s.attributes.ssrcs=[],s.attributes.direction="inactive",s.media.port="0")}),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find(s=>s.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find(s=>s.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>_e(e).call(e,s.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(s=>{s.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>_e(e).call(e,s.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(s=>{s.attributes.direction="recvonly"})}receive(e,t,s,n){e.forEach((r,i)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",t,s,n[i])}),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>e.indexOf(s.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(s=>{s.media.port="0",s.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||ha((s=this._isUseExtmapAllowMixed,this._isUseDataChannel?hK(s):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(s?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var s;this._rtpCapabilities=e;let n=!1;const r=this.rtpCapabilities.send,i=this.localCapabilities.send,o=this.localCapabilities.recv,c=o.videoCodecs,l=o.audioCodecs,d=o.videoExtensions,h=o.audioExtensions;for(const T of t.mediaDescriptions){var p;if(T.attributes.direction!=="sendonly"||typeof T.attributes.mid!="string"||!_e(p=this.useLocalCodecsMids).call(p,T.attributes.mid)){if(n=!0,T.attributes.iceUfrag=this._iceParameters.iceUfrag,T.attributes.icePwd=this._iceParameters.icePwd,T.attributes.fingerprints=this._dtlsParameters.fingerprints,T.attributes.candidates=this._candidates,T.attributes.setup=this.setup,T.media.mediaType==="application"&&(T.attributes.sctpPort="5000"),T.media.mediaType==="video")if(this._isUseLocalCodecs&&T.attributes.direction==="sendonly"){var m;T.media.fmts=c.map(S=>S.payloadType.toString(10)),T.attributes.payloads=c,T.attributes.extmaps=d;const w=T.attributes.mid;typeof w!="string"||_e(m=this.useLocalCodecsMids).call(m,w)||this.useLocalCodecsMids.push(w)}else if(r.videoCodecs.length===0){const w=i.videoCodecs.filter(S=>{var I,O;return(I=S.rtpMap)===null||I===void 0?void 0:_e(O=I.encodingName.toLowerCase()).call(O,"vp8")});w.length===0&&w.push(i.videoCodecs[0]),T.media.fmts=w.map(S=>S.payloadType.toString(10)),T.attributes.payloads=w,T.attributes.extmaps=[]}else T.media.fmts=r.videoCodecs.map(w=>w.payloadType.toString(10)),T.attributes.payloads=r.videoCodecs,T.attributes.extmaps=r.videoExtensions;if(T.media.mediaType==="audio")if(this._isUseLocalCodecs&&T.attributes.direction==="sendonly"){var g;T.media.fmts=l.map(S=>S.payloadType.toString(10)),T.attributes.payloads=l,T.attributes.extmaps=h;const w=T.attributes.mid;typeof w!="string"||_e(g=this.useLocalCodecsMids).call(g,w)||this.useLocalCodecsMids.push(w)}else if(r.audioCodecs.length===0){const w=i.audioCodecs.filter(S=>{var I,O;return(I=S.rtpMap)===null||I===void 0?void 0:_e(O=I.encodingName.toLowerCase()).call(O,"opus")})||[i.audioCodecs[0]];T.media.fmts=w.map(S=>S.payloadType.toString(10)),T.attributes.payloads=w,T.attributes.extmaps=[]}else T.media.fmts=r.audioCodecs.map(w=>w.payloadType.toString(10)),T.attributes.payloads=r.audioCodecs,T.attributes.extmaps=r.audioExtensions,vd(T)}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,n]}updateCandidates(e){const t=this._originCandidates.filter(n=>n.transport==="udp"),s=[];if(t.forEach(n=>{s.push(ev(ev({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}))}),t.length!==0){switch(e){case Sn.TCP_RELAY:this._candidates=s;break;case Sn.UDP_TCP_RELAY:case Sn.RELAY:this._candidates=[...t,...s];break;default:this._candidates=t}for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}}restartICE(e){e=_s(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const t=[];for(let s=0;s<e;s++)t.push((this.currentMidIndex+s+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex(s=>{const n=s.media.mediaType===e&&s.media.port!=="0"&&(s.attributes.direction==="sendonly"||s.attributes.direction==="sendrecv")&&s.attributes.ssrcs.length===0;if(bs()){if(n){const r=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(r||s.attributes.mid!=="0"&&s.attributes.mid!=="1")||!(!r||r!==s.attributes.mid)}return!1}return n})}createOrRecycleDataChannel(){for(const s of this.sessionDesc.mediaDescriptions)if(s.media.mediaType==="application")return{mediaDesc:s,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:df,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,s,n,r,i){const o=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,l=Zu(o,c,this.localCapabilities.send,o===Le.VIDEO?n:r),d=o===Le.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const h="".concat(this.currentMidIndex);let p={media:{mediaType:o,port:df,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(g=>g.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:s,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};p=this.mungRecvMediaDsec(p,e,i);const m=this.findFirstClosedMedia(o);if(m){const g=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[g]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map(r=>r.fingerprint)),s=new Set(e.map(r=>r.fingerprint));let n=!1;t.size!==s.size&&(n=!0);for(const r of t)s.has(r)||(n=!0);return n}updateRemoteCodec(e,t,s){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var m;return _e(m=Object.keys(Pc)).call(m,p)}))],r=new Set(t);if(n.every(p=>r.has(p)))return b.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const i=this._rtpCapabilities.recv.videoCodecs.filter(p=>t.some(m=>{var g;return _e(g=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(g,m)}));if(i.length===0)return b.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(t)),!1;const o=[...new Set(i.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(b.debug("updateRemoteCodec, from ".concat(n," to ").concat(o)),e.length===0)c=this.sessionDesc.mediaDescriptions.filter(p=>p.media.mediaType==="video"&&p.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&p.media.mediaType==="video"&&_e(e).call(e,p.attributes.mid)&&p.attributes.direction==="recvonly"),c.length!==e.length)return b.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(C("USE_PUB_RTX")||C("USE_SUB_RTX")){const p=Ko(i,this.rtpCapabilities.recv.videoCodecs);i.push(...p)}this._rtpCapabilities.recv.videoCodecs=i;const l=this.localCapabilities.send,d=this.rtpCapabilities.recv,h=Zu(Le.VIDEO,d,l,s);return c.forEach(p=>{const m=h.map(g=>g.payloadType.toString(10));b.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from"),p.attributes.payloads,"to",h),p.attributes.payloads=h,p.media.fmts=m}),b.debug("updateRemoteCodec success, mids: ".concat(e,", codecs: ").concat(t,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,s,n,r){const i=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||i.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,c=e===Le.VIDEO?o.videoCodecs:o.audioCodecs,l=e===Le.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let h={media:{mediaType:e,port:df,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:s,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};h=this.mungSendMediaDesc(h,r);const p=this.findFirstClosedMedia(e);if(p){const m=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[m]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,t,s){const n=_s(e);return V_(n),Kc(n,t),F_(n,t),kD(n),sf(n,s,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const s=_s(e);return s.attributes&&s.attributes.payloads&&Array.isArray(s.attributes.payloads)&&s.attributes.payloads.length>0&&s.attributes.payloads.forEach(n=>{n.rtpMap&&n.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&C("ENABLE_DOWN_SPS_PPS")&&(n.fmtp&&n.fmtp.parameters||(n.fmtp={parameters:{}}),n.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),sf(s,t,this.localCapabilities.recv),vd(s),s}updateRecvMedia(e,t){const s=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===e);if(s!==-1){const n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[s],t);this.sessionDesc.mediaDescriptions[s]=n}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>bs()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var s;return((s=t.attributes)===null||s===void 0||(s=s.ssrcs[0])===null||s===void 0?void 0:s.ssrcId)===e[0].ssrcId})}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find(s=>s.attributes.mid===e))===null||t===void 0?void 0:t.attributes.ssrcs}};function ik(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function co(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?ik(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ik(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}var wd=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(wd||{});const hf=new Map;function ok(e,t,s,n){let{scale:r}=e;if(r===0&&n===wd.UP||r>=t.length-1&&n===wd.DOWN)return e;let i=co(co({},e),{},{scale:n===wd.DOWN?++r:--r});switch(s){case"maintain-framerate":i=co(co({},i),t[r].motion);break;case"maintain-resolution":i=co(co({},i),t[r].detail);break;case"balanced":i=co(co({},i),t[r].balanced)}return i}function ck(e,t){if(t){const s={overUse:0,underUse:0,adaptationList:lk(t)};hf.set(e,s)}else hf.delete(e)}function lk(e){const t=co({},e),{bitrateMax:s,frameRate:n,scaleResolutionDownBy:r,bitrateMin:i}=t,{MIN_FRAME_RATE:o,MAX_THRESHOLD_FRAMERATE:c,MAX_SCALE:l,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:h,BWE_SCALE_UP_THRESHOLD:p,BWE_SCALE_DOWN_THRESHOLD:m,PERF_SCALE_DOWN_THRESHOLD:g,PERF_SCALE_UP_THRESHOLD:T,BALANCE_BITRATE_FACTOR:w,BALANCE_FRAMERATE_FACTOR:S,BALANCE_RESOLUTION_FACTOR:I,MOTION_RESOLUTION_FACTOR:O,MOTION_BITRATE_FACTOR:M,DETAIL_FRAMERATE_FACTOR:z,DETAIL_BITRATE_FACTOR:K}=qb,V=Math.min(t.frameRate,c),Y=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(m,1)*s),bwe_up:s,fps_down:Math.round(Math.pow(g,1)*V),fps_up:n},balanced:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:s,bitrateMin:i},motion:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:s,bitrateMin:i},detail:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:s,bitrateMin:i}}];for(let ce=1;ce<=l;ce++){const xe={bwe_up:Math.round(Math.pow(p,ce)*s),bwe_down:Math.round(Math.pow(m,ce+1)*s),fps_up:Math.round(Math.pow(T,ce)*V),fps_down:Math.round(Math.pow(g,ce+1)*V)},ke={scaleResolutionDownBy:r/Math.pow(I,ce),frameRate:Math.max(Math.round(Math.pow(S,ce)*n),o),bitrateMax:Math.max(Math.round(Math.pow(w,ce)*s),h),bitrateMin:Math.max(Math.round(Math.pow(w,ce)*i),d)},lt={scaleResolutionDownBy:r/Math.pow(O,ce),frameRate:n,bitrateMax:Math.max(Math.round(Math.pow(M,ce)*s),h),bitrateMin:Math.max(Math.round(Math.pow(M,ce)*i),d)},at={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(z,ce)*n),o),bitrateMax:Math.max(Math.round(Math.pow(K,ce)*s),h),bitrateMin:Math.max(Math.round(Math.pow(K,ce)*i),d)};Y.push({scale:ce,threshold:xe,balanced:ke,motion:lt,detail:at})}return Y}function pK(e,t,s,n,r,i){const o=hf.get(e)||{overUse:0,underUse:0,adaptationList:lk(r)},{adaptationList:c}=o;hf.set(e,o);const{OVERUSE_TIMES_THRESHOLD:l,UNDERUSE_TIMES_THRESHOLD:d}=qb,{scale:h}=n;let p,m;return typeof t=="number"&&t>0&&function(g,T,w,S){if(T>=w.length)return!1;let{threshold:{fps_down:I}}=w[T];return C("FORCE_AG_HIGH_FRAMERATE")&&S==="maintain-framerate"&&(I=w[0].threshold.fps_down),g<I}(t,h,c,i)&&(o.overUse++,m=td.CPU,o.overUse>l)||typeof s=="number"&&s>0&&function(g,T,w){if(T>=w.length)return!1;const{threshold:{bwe_down:S}}=w[T];return g<S}(s,h,c)&&(o.overUse++,m=td.BANDWIDTH,o.overUse>l)?(o.overUse=0,o.underUse=0,p=ok(n,c,i,wd.DOWN),[p,m]):(typeof t=="number"&&t>0&&typeof s=="number"&&s>0&&function(g,T,w,S){if(T===0)return;let{threshold:{fps_up:I}}=w[T];return C("FORCE_AG_HIGH_FRAMERATE")&&S==="maintain-framerate"&&(I=w[1].threshold.fps_up),g>I}(t,h,c,i)&&function(g,T,w){if(T===0)return;const{threshold:{bwe_up:S}}=w[T];return g>S}(s,h,c)&&(o.underUse++,o.underUse>d&&(o.overUse=0,o.underUse=0,p=ok(n,c,i,wd.UP),p.scale===0&&(m=td.NONE))),[p,m])}function dk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function sv(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?dk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):dk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}function uk(e){var t;return!!C("ENABLE_AG_ADAPTATION")&&!!(e instanceof Pm||_e(t=e._hints).call(t,qt.CUSTOM_TRACK))&&(!!C("FORCE_SUPPORT_AG_ADAPTATION")||!!(QC(14,0,!1)&&ZC(17,4,!0)||$C(14)&&Cb(17,4,!0)))}const pf=new Map;function hk(e,t,s,n,r,i){if(Sd(e,s),r(t),n!=="balanced"&&n!=="maintain-framerate"&&n!=="maintain-resolution")return;let o=-1;ck(e,t);const c=window.setInterval(()=>{const d=pf.get(e);if(!C("ENABLE_AG_ADAPTATION")||!d)return Sd(e,s),void r(t);const h=i();if(h.sendPackets>0&&h.OutgoingAvailableBandwidth>0){if(o===-1)return void(o=Date.now());if(Date.now()-o<1e3)return;const p=h.sendFrameRate,m=h.OutgoingAvailableBandwidth,[g,T]=pK(e,p,m,d.adaptationConfig,t,n);T&&(s.qualityLimitationReason=T),g&&d.adaptationConfig.scale!==g.scale&&(b.debug("[".concat(e,"] applyAdaptation: ").concat(s.qualityLimitationReason,`
           sendFps `).concat(p,", bwe ").concat(m,", switch from ").concat(d.adaptationConfig.scale," to ").concat(g.scale," ")),d.adaptationConfig=sv(sv({},d.adaptationConfig),g),r(g))}},C("CHECK_LOCAL_STATS_INTERVAL")),l=sv({},t);pf.set(e,{timer:c,adaptationConfig:l,originConfig:t,adaptationFunc:r}),b.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(n))}function Sd(e,t){const s=pf.get(e);if(s){const{timer:n}=s;window.clearTimeout(n),pf.delete(e)}t.qualityLimitationReason=td.NONE,ck(e)}function mK(e,t){var s;let n;switch(t){case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoTrack:n=_e(s=e._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:n=Qt.Low}return n}function nv(e){const t=At();if(e.some(s=>s._bypassWebAudio))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function av(e,t){nv(e);const s=new nn;return e.forEach(n=>s.addAudioTrack(n)),s}const fK=!At().supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&Ci();function nh(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(e.useDcSignal)return s={spec:t,store:e},ci("DataChannelConnection").create(s);var s;return fK?function(r){return ci("PlanBConnection").create(r)}({spec:t,store:e}):new Za(t,e)}function rv(e){return e&&(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")}function iv(e){try{if(e.iceServers)return!1;if(e.turnServer&&e.turnServer.mode!=="off"){if(Cc(e.turnServer.servers))return!1;if(C("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some(t=>t.forceturn))return!0}return!1}catch{return!1}}var Mt;function pk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function di(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?pk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):pk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let Za=(Mt=class ll extends Jm{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,s;return(t=(s=this.peerConnection.getReceivers()[0])===null||s===void 0||(s=s.transport)===null||s===void 0?void 0:s.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var s;return _e(s=Object.keys(Pc)).call(s,t)}))]}constructor(t,s){super(t,s),N(this,"id",Jt(5,"connection-")),N(this,"store",void 0),N(this,"peerConnection",void 0),N(this,"forceTurn",!1),N(this,"remoteSDP",void 0),N(this,"initialOffer",void 0),N(this,"transportEventReceiver",void 0),N(this,"statsFilter",void 0),N(this,"extension",{useXR:C("USE_XR")}),N(this,"localCapabilities",void 0),N(this,"remoteCodecs",void 0),N(this,"localCandidateCount",0),N(this,"allCandidatesReceived",!1),N(this,"isPreallocation",!1),N(this,"isPreRender",!1),N(this,"preMediaMap",new Map),N(this,"dataStreamChannelMap",new Map),N(this,"establishPromise",void 0),N(this,"recoveredDataChannelIds",[]),N(this,"currentDataChannelId",1),N(this,"supportAV1RtpSpec",!1),N(this,"mutex",void 0),N(this,"qualityLimitationReason",td.NONE),N(this,"isFirstConnected",!1),this.store=s,this.forceTurn=iv(t),this.mutex=new wn("P2PConnection-mutex",s.clientId),this.peerConnection=new RTCPeerConnection(ll.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=Sm(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,bs()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,s){if(this.remoteCodecs=s,!this.remoteSDP)return void b.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(s));if(this.remoteSDP.updateRemoteCodec(t,s,this.store.codec)){const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else b.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const s=await this.peerConnection.createOffer();if(!s.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=ji(s.sdp),r=await G_({filterRTX:!C("USE_PUB_RTX")&&!C("USE_SUB_RTX"),filterVideoFec:C("FILTER_VIDEO_FEC"),filterAudioFec:C("FILTER_AUDIO_FEC"),filterVideoCodec:C("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:C("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:C("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Qu(r),this.initialOffer=s,C("ENABLE_SVC")&&this.store.codec=="av1"){const o=await jD();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let i;return s.sdp&&nf(s.sdp)&&(i=_s(r),TD(i)),di(di({},n),{},{rtpCapabilities:i||r,offerSDP:s.sdp})}catch(s){throw new se(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,s.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&nf(this.initialOffer.sdp)&&RD(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new rk(di(di({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!C("ENABLE_PRE_SUB_WITH_PRE_PC")||!C("PRE_USE_LOCAL_CODECS"))&&Wu(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString(),n=W_(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(n||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s});const i=this.peerConnection.getTransceivers()[0];if(i!=null&&i.receiver&&this.tryBindTransportEvents(i.receiver),Wu(this.store))if(t.preallocation&&C("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=C("PRE_SUB_NUM"),{mids:c,preSSRCs:l}=this.remoteSDP.preloadRemoteMedia(o);await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(l)),this.presetMedia(c,l)}else{const{preSSRCs:o=[]}=t,c=o.map(d=>d.ssrcMsg[0].ssrcId);if(o.length===0)return;const{mids:l}=this.remoteSDP.batchSend(o.map(d=>Object.assign({},d)));await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(l,c)}}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(s.toString()))}}presetMedia(t,s){t.forEach((n,r)=>{this.peerConnection.getTransceivers().forEach(i=>{if(i.mid!=null&&n===i.mid&&i.receiver.track){const o=i.receiver.track;let c;o.kind==="video"&&C("ENABLE_PRE_RENDER")&&(c=new jm({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(Jt(5,""))},!0),c.updateVideoTrack(o),c.onFirstVideoFrameRender=()=>{var l;const d=this.preMediaMap.get(s[r]);d&&(d.firstVideoRender=Date.now()),(l=this.onFirstVideoRender)===null||l===void 0||l.call(this,s[r])},c.onVideoBufferReady=()=>{var l;(l=this.onFirstVideoBufferReady)===null||l===void 0||l.call(this,s[r])},c.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(s[r],{mid:n,track:o,player:c,transceiver:i})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let s=!1;const{rtpCapabilities:n}=t;if([,s]=this.remoteSDP.updateRemoteRTPCapabilities(n),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);s=s||o}const{preSSRCs:r=[]}=t,i=r.map(o=>o.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(i)){const o=[],c=[];if(Array.from(this.preMediaMap.entries()).every(l=>{let[d,{mid:h,player:p,track:m}]=l;return o.push(h),c.push(d),this.preMediaMap.delete(d),p&&p.destroy(),!0}),o.length>0&&(this.remoteSDP.stopSending(o),await Ca(this.peerConnection,this.remoteSDP,this.extension),b.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),Ue.reportApiInvoke(this.store.sessionId,{name:Ns.PRELOAD_MEDIA_FAILED,options:[r,c],tag:is.TRACER}).onSuccess()),r.length>0){const{mids:l}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(i)),this.presetMedia(l,i)}}s?(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):b.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(s.toString()))}}send(t,s,n){var r=this;return xa(function*(){const i=yield yt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],c=Xu();t.forEach(S=>{const I=r.peerConnection.addTransceiver(S._mediaStreamTrack,di({direction:"sendonly"},S.trackMediaType==="video"&&r.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));o.push(I),S._updateRtpTransceiver(I)}),bs()&&C("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(o,t)));const l=yield yt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(t.length),h=r.mungSendOfferSDP(l.sdp,t,d),p=ha(h),m=d.map(S=>{const I=p.mediaDescriptions.find(O=>O.attributes.mid===S);if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return U_(I,C("USE_PUB_RTX"))});let g;try{g=yield m}catch(S){g=[],r.remoteSDP.receive(t,s,n,g);const I=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield yt(r.stopSending(d,!0)),S}r.remoteSDP.receive(t,s,n,g);const T=r.remoteSDP.toString(),w=r.logSDPExchange(h,"offer","local","send");return yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(r.applySimulcastEncodings(o,t)),yield yt(r.applySendEncodings(o,t)),w==null||w(T),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),o.map((S,I)=>{const O=d[I];return{localSSRC:m[I],id:O,transceiver:S}})}catch(o){throw o instanceof se?o:new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{i()}})()}async createDataChannels(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);if(n&&n.readyState==="open")b.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const i=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof i!="number")throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:i,negotiated:!0,ordered:!1,maxRetransmits:C("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)}s.forEach(i=>{i._updateOriginDataChannel(n)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),b.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else b.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(n){throw n instanceof se?n:new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(n.toString()))}}async stopDataChannels(t){try{const s=this.dataStreamChannelMap.get(t);return s&&(s.id&&this.recoveredDataChannelIds.push(s.id),s.close()),void this.dataStreamChannelMap.delete(t)}catch(s){throw s instanceof se?s:new se(A.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(s.toString()))}}async stopSending(t,s){const n=s?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(l=>{var d;Sd(this.id+l.mid,this),l.direction="inactive",(d=l.stop)===null||d===void 0||d.call(l)});const i=await this.peerConnection.createOffer(),o=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();o==null||o(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(r){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(t,s,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:i,needExchangeSDP:o}=this.remoteSDP.send(t,s,n,r);o&&(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(l=>l.mid===i);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:i,transceiver:c}}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:s,needExchangeSDP:n}=this.remoteSDP.batchSend(t);return n&&(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),s.map(r=>{const i=this.peerConnection.getTransceivers().find(o=>o.mid===r);if(!i)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:i.receiver.track,id:r,transceiver:i}})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");t.forEach(i=>{Array.from(this.preMediaMap.entries()).some(o=>{let[c,{mid:l,player:d}]=o;if(l===i)return this.preMediaMap.delete(c),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(s.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(s.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(s.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(s.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(async(o,c)=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(s.toString()))}}restartICE(t){var s=this;return xa(function*(){const n=yield yt(s.mutex.lock("From P2PConnection.restartICE"));try{if(!s.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=At().supportPCSetConfiguration,i=C("FORCE_TURN_TCP")||s.forceTurn;if(t===Sn.RELAY&&!r)return;if(r&&!i){const p=t===Sn.RELAY?"relay":"all",m=s.peerConnection.getConfiguration();m.iceTransportPolicy!==p&&(b.debug("[".concat(s.store.clientId,"] restartICE change iceTransportPolicy from [").concat(m.iceTransportPolicy,"] to [").concat(p,"]")),m.iceTransportPolicy=p,s.peerConnection.setConfiguration(m))}s.remoteSDP.updateCandidates(t);const o=yield yt(s.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=ji(o.sdp),{remoteIceParameters:l}=yield c.iceParameters;s.remoteSDP.restartICE(l);const d=s.remoteSDP.toString(),h=s.logSDPExchange(o.sdp||"","offer","local","restartICE");s.store.descriptionStart(),yield yt(s.peerConnection.setLocalDescription(o)),h==null||h(d),yield yt(s.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){b.warning("[".concat(s.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(Sn.TCP_RELAY),await Ca(this.peerConnection,this.remoteSDP,this.extension)}catch(s){b.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),s)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(s=>{Sd(this.id+s.mid,this)}),this.preMediaMap.forEach(s=>{let{player:n}=s;n&&n.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return di(di({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[s],[t]);this.remoteSDP.updateRecvMedia(t,s);const i=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new se(A.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,s){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===t);n.length===1&&(this.isVP8Simulcast(s)?bs()||await this.applySimulcastEncodings(n,[s]):await this.applySendEncodings(n,[s]))}setStatsRemoteVideoIsReady(t,s){this.statsFilter.setVideoIsReady2(t,s)}async replaceTrack(t,s){const n=this.peerConnection.getTransceivers().find(r=>r.mid===s);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const s=t[0].transport.iceTransport,{local:n,remote:r}=s.getSelectedCandidatePair();return{local:di(di({},kr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:di(di({},kr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var s;const n="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",i=ki(t.url||"");b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(n,"), url: ").concat(i||"",", host_candidate:").concat(r)),(s=this.onICECandidateError)===null||s===void 0||s.call(this,n)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const s={iceServers:[]},n=t.cloudProxyServer||"disabled";return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&(Cc(t.turnServer.servers)?s.iceServers=t.turnServer.servers:C("NEW_TURN_MODE")&&s.iceServers&&n==="disabled"?(C("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&s.iceServers.push(...ll.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):s.iceServers.push(...ll.newTurnServerConfigToIceServers(t.turnServer.servers)),C("NEW_FORCE_TURN")&&(s.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(s.iceServers&&s.iceServers.push(...ll.turnServerConfigToIceServers(t.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...ll.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(s.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&At().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),s}static turnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{n.security?n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),s}static newTurnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{const r=C("NEW_TURN_MODE");r===1?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}):r===2?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}):r===3?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":443?transport=tcp")}):r===4&&(s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}),s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}),s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":443?transport=tcp")}))}),s}tryBindTransportEvents(t){const s=t.transport;if(s){this.transportEventReceiver=t,s.onstatechange=()=>{var r;s!=null&&s.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,s.state))},s.onerror=r=>{var i;(i=this.onDTLSTransportError)===null||i===void 0||i.call(this,"error"in r?r.error:r)};const n=s.iceTransport;n&&(n.onstatechange=()=>{const r=s==null?void 0:s.iceTransport.state;var i;r&&((i=this.onICETransportStateChange)===null||i===void 0||i.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:i}=n.getSelectedCandidatePair()||{};if(r&&i){const o=r.address+":"+r.port,c=i.address+":"+i.port;b.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ki(o)),", remote ").concat(JSON.stringify(ki(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,s){var n,r;if(s||(s=this.peerConnection.getSenders().find(S=>S.track===t._mediaStreamTrack)),!s)return b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return b.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!At().supportSetRtpSenderParameters)return b.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},o={};switch(t._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;case"balanced":i.degradationPreference="balanced"}const c=SD(this.peerConnection,t._mediaStreamTrack),l=pA(t);if(uk(t)&&c&&s&&l&&this.getLocalVideoStats&&_e(n=["vp8","vp9"]).call(n,this.store.codec)){var d;const w=i.degradationPreference||(_e(d=t._hints).call(d,qt.CUSTOM_TRACK)?C("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");hk(this.id+c.mid,l,this,w,S=>{s&&this.updateAdaptation(s,S)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:w,frameRate:S,scaleResolutionDownBy:I}=t._encoderConfig;w&&(o.maxBitrate=1e3*w),(_e(h=t._hints).call(h,qt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(S&&(o.maxFramerate=ya(S)),I&&I>=1&&(o.scaleResolutionDownBy=I))}const{maxFramerate:p}=C("ENCODER_CONFIG_LIMIT");if(p&&typeof p=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,p):p),C("DSCP_TYPE")&&Ci()){var m;const w=C("DSCP_TYPE");_e(m=["very-low","low","medium","high"]).call(m,w)&&(o.networkPriority=w)}const g=s.getParameters(),T=(r=g.encodings)===null||r===void 0?void 0:r[0];bs()&&!T&&(i.encodings=[o]),T&&Object.assign(T,o),Object.assign(g,i),b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(g.encodings))),await s.setParameters(g),await MD(this.store.codec,s,C("SVC_MODE"))}async updateAdaptation(t,s){var n,r;if(!t)return b.debug("[updateAdaptation] no rtpSender found");if(!At().supportSetRtpSenderParameters)return b.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const i={},{bitrateMax:o,frameRate:c,scaleResolutionDownBy:l}=s;o&&(i.maxBitrate=1e3*o),c&&(i.maxFramerate=ya(c)),l&&l>=1&&_e(n=["vp8","vp9"]).call(n,this.store.codec)&&(i.scaleResolutionDownBy=l);const d=t.getParameters(),h=(r=d.encodings)===null||r===void 0?void 0:r[0];h&&Object.assign(h,i),Object.assign(d,{});try{await t.setParameters(d),b.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(p){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?b.debug("[updateAdaptation] peerConnection not connected}"):b.debug("[updateAdaptation] updateRtpSenderEncodings failed",p):b.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,s){try{if(!At().supportSetRtpSenderParameters||t.length!==s.length)return;for(let n=0;n<t.length;n++){const r=t[n],i=s[n];i instanceof os&&!this.isVP8Simulcast(i)&&await this.updateRtpSenderEncodings(i,r.sender)}}catch{b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,s,n){if(C("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;const r=ha(t);return s.forEach((i,o)=>{const c=n[o],l=r.mediaDescriptions.find(d=>d.attributes.mid===c);l&&(Kc(l,i),B_(l,i,this.store.codec))}),ao(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var s;(s=this.onFirstAudioReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var s;(s=this.onFirstVideoReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var s;(s=this.onFirstAudioDecoded)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,s,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,s,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,s)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,s)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var s;(s=this.onFirstVideoDecodedTimeout)===null||s===void 0||s.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,s){if(t.length===s.length)for(let l=0;l<t.length;l++){var n,r,i,o,c;const d=t[l],h=s[l];if(h instanceof os&&!_e(n=h._hints).call(n,qt.LOW_STREAM)&&(r=h._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=h._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=h._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},m={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:m.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:m.high}];const g=d.sender.getParameters();await d.sender.setParameters(Object.assign(g,p))}}}async applySimulcastEncodings(t,s){if(!bs()&&t.length===s.length)for(let n=0;n<t.length;n++){const r=s[n];if(r instanceof os&&this.isVP8Simulcast(r)){const i=t[n],o={},c={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=i.sender.getParameters();await i.sender.setParameters(Object.assign(l,o))}}}isVP8Simulcast(t){var s,n,r,i,o;return!!(t instanceof os&&C("SIMULCAST")&&this.store.codec==="vp8"&&!_e(s=t._hints).call(s,qt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(i=t._scalabilityMode)!==null&&i!==void 0&&i.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,s,n,r){if(C("SDP_LOGGING"))return b.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(s," SDP during P2PConnection.").concat(r,`
`),t),s==="offer"?i=>{this.logSDPExchange(i,"answer",n==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const s=this.remoteSDP.getSSRC(t);return s&&s.length!==0?s[0].ssrcId:void 0}setConfiguration(t){if(At().supportPCSetConfiguration){const s=ll.resolvePCConfiguration(t);this.peerConnection.setConfiguration(s)}t.isPreallocation&&(this.isPreallocation=!0)}},Re(Mt.prototype,"updateRemoteRTPCapabilities",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"updateRemoteRTPCapabilities"),Mt.prototype),Re(Mt.prototype,"connect",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"connect"),Mt.prototype),Re(Mt.prototype,"updateRemoteConnect",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"updateRemoteConnect"),Mt.prototype),Re(Mt.prototype,"createDataChannels",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"createDataChannels"),Mt.prototype),Re(Mt.prototype,"receive",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"receive"),Mt.prototype),Re(Mt.prototype,"batchReceive",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"batchReceive"),Mt.prototype),Re(Mt.prototype,"stopReceiving",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"stopReceiving"),Mt.prototype),Re(Mt.prototype,"muteRemote",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"muteRemote"),Mt.prototype),Re(Mt.prototype,"unmuteRemote",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"unmuteRemote"),Mt.prototype),Re(Mt.prototype,"muteLocal",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"muteLocal"),Mt.prototype),Re(Mt.prototype,"unmuteLocal",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"unmuteLocal"),Mt.prototype),Re(Mt.prototype,"close",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"close"),Mt.prototype),Re(Mt.prototype,"updateEncoderConfig",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"updateEncoderConfig"),Mt.prototype),Re(Mt.prototype,"updateSendParameters",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"updateSendParameters"),Mt.prototype),Re(Mt.prototype,"replaceTrack",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"replaceTrack"),Mt.prototype),Re(Mt.prototype,"updateAdaptation",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"updateAdaptation"),Mt.prototype),Re(Mt.prototype,"getRemoteSSRC",[wa],Object.getOwnPropertyDescriptor(Mt.prototype,"getRemoteSSRC"),Mt.prototype),Mt);function wa(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}function ov(e,t){let s=document.createElement("video"),n=document.createElement("canvas");s.setAttribute("style","display:none"),n.setAttribute("style","display:none"),s.setAttribute("muted",""),s.muted=!0,s.setAttribute("autoplay",""),s.autoplay=!0,s.setAttribute("playsinline",""),n.width=ya(t.width),n.height=ya(t.height);const r=ya(t.framerate||15);document.body.append(s),document.body.append(n);let i=e._mediaStreamTrack;s.srcObject=new MediaStream([i]),s.play().catch(Vu);const o=n.getContext("2d");if(!o)throw new $(A.UNEXPECTED_ERROR,"can not get canvas context");const c=At(),l=n.captureStream(c.supportRequestFrame?0:r).getVideoTracks()[0];l.canvas||(l.canvas=n),n.startCapture=()=>{if(!s)return n.stopCapture&&n.stopCapture();if(s.paused&&s.play(),s.videoHeight>2&&s.videoWidth>2){const h=s.videoWidth,p=s.videoHeight/h,m=n.width*p;Math.abs(m-n.height)>=2&&(b.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(m)),n.height=m)}o.drawImage(s,0,0,n.width,n.height),l.requestFrame&&l.requestFrame(),i!==e._mediaStreamTrack&&(i=e._mediaStreamTrack,s.srcObject=new MediaStream([i]))},n.stopCapture=o_(()=>n.startCapture&&n.startCapture(),r);const d=l.stop;return l.stop=()=>{d.call(l),s&&(s.remove(),s.srcObject=null,s=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),b.debug("clean low stream renderer")},l}var mk=function(e){return e[e.Video_Send_Type=190]="Video_Send_Type",e}(mk||{}),ui=function(e){return e[e.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",e[e.Video_Send_Freeze=2082]="Video_Send_Freeze",e[e.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",e[e.Video_Recv_Freeze=2084]="Video_Recv_Freeze",e[e.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",e[e.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",e[e.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",e[e.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",e}(ui||{}),gt=function(e){return e[e.Video_Send_Retransmit=2062]="Video_Send_Retransmit",e[e.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",e[e.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",e[e.Video_Send_Transmit=2066]="Video_Send_Transmit",e[e.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",e[e.Video_Capture_Height=2033]="Video_Capture_Height",e[e.Video_Capture_Width=2035]="Video_Capture_Width",e[e.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",e[e.Video_Send_Low_Height=2073]="Video_Send_Low_Height",e[e.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",e[e.Video_Send_Low_Width=2077]="Video_Send_Low_Width",e[e.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",e[e.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",e[e.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",e[e.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",e[e.Video_Send_Width=2003]="Video_Send_Width",e[e.Video_Send_Height=2004]="Video_Send_Height",e[e.Video_Send_Disabled=2095]="Video_Send_Disabled",e[e.Video_Send_Adaptation=2032]="Video_Send_Adaptation",e[e.Video_Send_Player_Status=2128]="Video_Send_Player_Status",e[e.Video_Send_Nacks=2009]="Video_Send_Nacks",e[e.Video_Send_Plis=2010]="Video_Send_Plis",e[e.Video_Send_Firs=2011]="Video_Send_Firs",e[e.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",e[e.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",e[e.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",e[e.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",e[e.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",e[e.Video_Send_Bitrate=2012]="Video_Send_Bitrate",e[e.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",e[e.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",e[e.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",e[e.Audio_Send_Level=2038]="Audio_Send_Level",e[e.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",e[e.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",e[e.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",e[e.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",e[e.Audio_Send_Freeze=2081]="Audio_Send_Freeze",e[e.Audio_Send_Disabled=2096]="Audio_Send_Disabled",e[e.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",e[e.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",e[e.Video_Recv_Height=2019]="Video_Recv_Height",e[e.Video_Recv_Width=2018]="Video_Recv_Width",e[e.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",e[e.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",e[e.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",e[e.Video_Recv_Nacks=2026]="Video_Recv_Nacks",e[e.Video_Recv_Plis=2027]="Video_Recv_Plis",e[e.Video_Recv_Firs=2028]="Video_Recv_Firs",e[e.Video_Recv_Disabled=2101]="Video_Recv_Disabled",e[e.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",e[e.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",e[e.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",e[e.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",e[e.Audio_Render_Level=2043]="Audio_Render_Level",e[e.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",e[e.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",e[e.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",e[e.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",e[e.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",e[e.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",e[e.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",e[e.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",e[e.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",e[e.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",e[e.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",e[e.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",e}(gt||{}),_n=function(e){return e[e.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",e[e.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",e[e.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",e[e.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",e[e.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",e[e.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",e[e.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",e[e.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",e[e.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",e[e.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",e[e.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",e[e.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",e[e.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",e[e.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",e[e.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",e[e.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",e[e.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",e[e.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",e[e.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",e[e.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",e[e.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",e[e.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",e}(_n||{}),Dn=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e}(Dn||{}),Nd=function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e[e.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",e}(Nd||{}),cv=function(e){return e[e.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",e[e.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",e}(cv||{});const qc=1e3,mf=6,ah=3,gK=Math.max(mf,ah,60);function nt(e,t,s){s!=null&&Number.isFinite(s)&&(e[t]=Math.round(Math.max(0,s)))}function fk(e){const t={[Dn.CONN_TYPE]:0,[Dn.RTT]:e.rtt,[Dn.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const s=e.selectedCandidatePair.localCandidate.relayProtocol;s==="udp"&&(t[Dn.CONN_TYPE]=1),s==="tcp"&&(t[Dn.CONN_TYPE]=3),s==="tls"&&(t[Dn.CONN_TYPE]=4);break}case"srflx":t[Dn.CONN_TYPE]=2;break;case"unknown":t[Dn.CONN_TYPE]=5;break;default:t[Dn.CONN_TYPE]=0}return t}function gk(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class xk extends Cs{constructor(t){super(),N(this,"store",void 0),N(this,"uploadWRTCStatsTimer",void 0),N(this,"uploadOutboundDenoiserStatsTimer",void 0),N(this,"uploadExtStatsTimer",void 0),N(this,"uploadExtUsageStatsTimer",void 0),N(this,"uploadInboundExtStatsTimer",void 0),N(this,"requestStats",void 0),N(this,"requestTransportStats",void 0),N(this,"requestLocalMedia",void 0),N(this,"requestRemoteMedia",void 0),N(this,"requestAllTracks",void 0),N(this,"requestVideoIsReady",void 0),N(this,"requestUploadStats",void 0),N(this,"requestUpload",void 0),N(this,"uploadOutboundStarted",!1),N(this,"uploadInboundStarted",!1),N(this,"uploadTransportStarted",!1),N(this,"uploadBaseStatsStarted",!1),N(this,"uploadExtensionUsageStarted",!1),N(this,"lastRecvStats",void 0),N(this,"lastSendStats",void 0),N(this,"lastRefRecvStats",void 0),N(this,"lastRefSendStats",void 0),N(this,"lastNormalRecvStats",void 0),N(this,"lastNormalSendStats",void 0),N(this,"lastExtendStats",{}),N(this,"needUploadStats",{}),N(this,"needUploadRenderFreezeTime",!0),N(this,"lastUploadCompensateTime",-1),N(this,"uploadCompensateDeltaTime",0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;const s=t%ah==0,n=t%mf==0,r=t%60==0;let i,o;if(this.uploadTransportStarted&&(i=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!i&&this.uploadOutboundStarted&&(i=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),i||o){var c;const l={};if(this.uploadTransportStarted&&i){const h=this.getTransportStats(i,s?this.lastRefSendStats:void 0,o,s);h&&(l.misc=[h])}if(this.uploadOutboundStarted&&i){const h=this.getOutboundStats(i,n?this.lastNormalSendStats:void 0,s?this.lastRefSendStats:void 0,this.lastSendStats,r);h&&(l.outbound=[h])}if(this.uploadInboundStarted&&o){this.uploadCompensateStats(t);const h=this.getInboundStats(o,n?this.lastNormalRecvStats:void 0,s?this.lastRefRecvStats:void 0,this.lastRecvStats);h&&(l.inbound=h)}const d=(c=this.requestTransportStats)===null||c===void 0?void 0:c.call(this).connectState;if(d&&(Array.isArray(l.misc)?l.misc[0]&&l.misc[0].addition&&(l.misc[0].addition[Nd.RTC_PEER_CONNECTION_STATE]=zb[d]):l.misc=[{addition:{[Nd.RTC_PEER_CONNECTION_STATE]:zb[d]}}]),Va.needUploadStats.length>0||n){const h=Va.needUploadStats.shift()||(Va.visibility==="visible"?1:0);Array.isArray(l.misc)?l.misc[0]&&l.misc[0].addition&&(l.misc[0].addition[Nd.PAGE_VISIBILITY]=h):l.misc=[{addition:{[Nd.PAGE_VISIBILITY]:h}}]}this.needUploadStats.sendType&&(Array.isArray(l.outbound)&&l.outbound[0]&&l.outbound[0].high&&(l.outbound[0].high[mk.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(l)}this.lastRecvStats=o,this.lastSendStats=i,n&&(this.lastNormalRecvStats=o,this.lastNormalSendStats=i),s&&(this.lastRefRecvStats=o,this.lastRefSendStats=i)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,Va.startCollectStats();let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var s,n;const r=(s=this.requestTransportStats)===null||s===void 0?void 0:s.call(this);return void(r&&((n=this.requestUploadStats)===null||n===void 0||n.call(this,{misc:[{addition:{[Nd.RTC_PEER_CONNECTION_STATE]:zb[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(t),++t===gK+1&&(t=1)},qc)}uploadCompensateStats(t){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const s=t%ah==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!s)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const n=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=n,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;const i=this.requestStats(!0);new Array(r).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const o={};if(this.uploadInboundStarted&&i){const c=this.requestRemoteMedia()||[],l=[];c.forEach(d=>{let[h,p]=d;const m={peer:h.uid};if(h._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(h._videoSSRC)&&p.has(Le.VIDEO)&&h.videoTrack){const g=function(T,w,S){if(!w.videoRecv.find(O=>O.ssrc===T))return;const I={};if(S&&S._player){const O=S._player,{renderFreezeAccTime2:M,videoElementStatus:z}=O;if(Va.visibility==="visible"&&z===Gn.PLAYING&&At().supportRequestVideoFrameCallback){const K=Math.min(6e3,M);O.renderFreezeAccTime2=Math.max(0,M-K),nt(I,ui.Video_Render_Freeze_Time_Render2,K),C("USE_NEW_RENDER_FREEZE_TIME")&&nt(I,ui.Video_Render_Freeze_Time_Render,K)}}return I}(h._videoSSRC,i,h.videoTrack);g&&(m.video=g)}m.video&&l.push(m)}),l.length>0&&(o.inbound=l,this.requestUploadStats(o))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(t,s,n,r){if(!this.requestStats)return;if(!r)return t.rtt==null?void 0:{addition:{[Dn.RTT]:t.rtt,[Dn.CONN_TYPE]:void 0,[Dn.STATS_UPDATE_INTERVAL]:t.updateInterval||void 0}};const i=fk(t);if(this.store.useP2P){if(n){const o=fk(n);i[Dn.CONN_TYPE]&&o[Dn.CONN_TYPE]&&(i[Dn.CONN_TYPE]+=o[Dn.CONN_TYPE]<<3)}i[Dn.CONN_TYPE]?i[Dn.CONN_TYPE]+=110:i[Dn.CONN_TYPE]=110}else{i[Dn.CONN_TYPE]?i[Dn.CONN_TYPE]+=100:i[Dn.CONN_TYPE]=100;const o=function(c,l){return l?[Math.ceil(8*(c.transport.bytesSent-l.transport.bytesSent)/(c.timestamp-l.timestamp)),Math.ceil(8*(c.transport.bytesReceived-l.transport.bytesReceived)/(c.timestamp-l.timestamp))]:[0,0]}(t,s);i[cv.Transport_Send_Bitrate]=o[0],i[cv.Transport_Recv_Bitrate]=o[1]}return{addition:i}}getOutboundStats(t,s,n,r,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const o=this.requestLocalMedia();if(!o||o.length===0)return;let c,l,d;return o.forEach(h=>{let[p,{track:m,ssrcs:g}]=h;switch(p){case ve.LocalVideoLowTrack:case ve.LocalVideoTrack:if(p===ve.LocalVideoTrack){var T;const w=function(M,z,K,V,Y,ce){const xe=z.videoSend.find(Et=>Et.ssrc===M);if(!xe)return;const ke={},{sentFrame:lt,inputFrame:at}=xe;if(V&&(nt(ke,ui.Video_Send_Qp_Sum,xe.qpSumPerFrame),at&&lt)){const Et=at.frameRate,xt=lt.frameRate;ke[ui.Video_Send_Freeze]=function(Ht,Rs){let de=!0;return de=!(Ht<=5)&&(Ht<=10?Rs<3:Ht<=20?Rs<4:Rs<5),de}(Et,xt)?1:0}if(Y){switch(lt&&(nt(ke,gt.Video_Send_Height,lt.height),nt(ke,gt.Video_Send_Width,lt.width),nt(ke,gt.Video_Send_Frame_Rate,lt.frameRate)),ke[gt.Video_Send_Disabled]=K._originMediaStreamTrack&&!K._originMediaStreamTrack.enabled||K._mediaStreamTrack&&!K._mediaStreamTrack.enabled?1:0,xe.adaptionChangeReason){case"none":ke[gt.Video_Send_Adaptation]=0;break;case"cpu":ke[gt.Video_Send_Adaptation]=1;break;case"bandwidth":ke[gt.Video_Send_Adaptation]=2;break;case"other":ke[gt.Video_Send_Adaptation]=3}let Et=0;xe.adaptionChangeReason&&(Et+=gk(xe.adaptionChangeReason)),z.qualityLimitationReason&&(Et+=gk(z.qualityLimitationReason)<<3),ke[gt.Video_Send_Adaptation]=Et,ke[gt.Video_Send_Player_Status]=a_[K._player?K._player.videoElementStatus:"uninit"],nt(ke,gt.Video_Send_Nacks,xe.nacksCount),nt(ke,gt.Video_Send_Plis,xe.plisCount),nt(ke,gt.Video_Send_Firs,xe.firsCount),nt(ke,gt.Video_Send_Avg_Encode,xe.avgEncodeMs),nt(ke,gt.Video_Send_Huge_Frame_Sent,xe.hugeFramesSent),nt(ke,gt.Video_Send_Bytes_Retransmit,xe.retransmittedBytesSent),nt(ke,gt.Video_Send_Packages_Retransmit,xe.retransmittedPacketsSent),nt(ke,gt.Video_Send_Key_Frames_Encoded,xe.keyFramesEncoded);const xt=Y.videoSend.find(Ht=>Ht.ssrc===M);if(xt){let Ht=qc*ah;xt.timestamp&&xe.timestamp&&(Ht=xe.timestamp-xt.timestamp),xt.packets!=null&&xe.packets!=null&&nt(ke,gt.Video_Send_Package_Rate,1e3*(xe.packets-xt.packets)/Ht),xe.packetsLost!=null&&xt.packetsLost!=null&&nt(ke,gt.Video_Send_Package_Lost,xe.packetsLost-xt.packetsLost),xt.bytes!=null&&xe.bytes!=null&&nt(ke,gt.Video_Send_Bitrate,8*(xe.bytes-xt.bytes)/Ht)}}return ke}(g[0].ssrcId,t,m,s,n),S=m.__className__==="CameraVideoTrack"?3:_e(T=m._hints).call(T,qt.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==S||i)&&(this.needUploadStats={sendType:S},this.lastExtendStats.sendType=S);const I=m&&function(M,z,K,V){const Y=z.videoSend.find(xe=>xe.ssrc===M);if(!Y)return null;const ce={};if(V){const xe=Y.inputFrame,ke=xe&&xe.height||K.videoHeight||0,lt=xe&&xe.width||K.videoWidth||0,at=xe&&xe.frameRate||0;nt(ce,gt.Video_Capture_Height,ke),nt(ce,gt.Video_Capture_Width,lt),nt(ce,gt.Video_Capture_Frame_Rate,at)}return ce}(g[0].ssrcId,t,m,!!n),O=function(M,z){const K={};return z&&(nt(K,gt.Video_Send_Retransmit,M.bitrate.retransmit),nt(K,gt.Video_Send_Target_Encoded,M.bitrate.targetEncoded),nt(K,gt.Video_Send_Actual_Encoded,M.bitrate.actualEncoded),nt(K,gt.Video_Send_Transmit,M.bitrate.transmit),nt(K,gt.Video_Send_Bandwidth,M.sendBandwidth)),K}(t,!!n);l=Object.assign({},w,I,O)}else d=function(w,S,I,O,M){const z=S.videoSend.find(V=>V.ssrc===w);if(!z)return;const K={};if(O){const V=z.sentFrame;V&&(nt(K,gt.Video_Send_Low_Height,V.height),nt(K,gt.Video_Send_Low_Width,V.width),nt(K,gt.Video_Send_Low_Frame_Rate,V.frameRate));const Y=O.videoSend.find(ce=>ce.ssrc===w);if(Y){let ce=qc*mf;Y.timestamp&&z.timestamp&&(ce=z.timestamp-Y.timestamp),Y.packets!=null&&z.packets!=null&&nt(K,gt.Video_Send_Low_Package_Rate,1e3*(z.packets-Y.packets)/ce),z.packetsLost!=null&&Y.packetsLost!=null&&nt(K,gt.Video_Send_Low_Package_Lost,z.packetsLost-Y.packetsLost),Y.bytes!=null&&z.bytes!=null&&nt(K,gt.Video_Send_Low_Bitrate,8*(z.bytes-Y.bytes)/ce)}}return K}(g[0].ssrcId,t,0,n);break;case ve.LocalAudioTrack:c=m&&function(w,S,I,O,M,z){const K=S.audioSend.find(Y=>Y.ssrc===w);if(!K)return;const V={};if(M){V[gt.Audio_Send_Disabled]=I._originMediaStreamTrack&&!I._originMediaStreamTrack.enabled||I._mediaStreamTrack&&!I._mediaStreamTrack.enabled?1:0;const Y=100*I._source.getAccurateVolumeLevel(),ce=K.inputLevel;if(ce!=null){const ke=Math.ceil(50*Math.log10(100*ce+1));nt(V,gt.Audio_Send_Level,ke)}nt(V,gt.Audio_Capture_PCM_Level,Y),nt(V,gt.Audio_Send_AEC_Return_Loss,K.aecReturnLoss),nt(V,gt.Audio_Send_AEC_Return_Loss_Enhancement,K.aecReturnLossEnhancement),nt(V,gt.Audio_Send_Bytes_Retransmit,K.retransmittedBytesSent),nt(V,gt.Audio_Send_Packages_Retransmit,K.retransmittedPacketsSent),V[gt.Audio_Send_Freeze]=0;const xe=M.audioSend.find(ke=>ke.ssrc===w);if(xe){let ke=qc*mf;xe.timestamp&&K.timestamp&&(ke=K.timestamp-xe.timestamp),xe.bytes!=null&&K.bytes!=null&&nt(V,gt.Audio_Send_Bitrate,8*(K.bytes-xe.bytes)/ke),xe.packets!=null&&K.packets!=null&&nt(V,gt.Audio_Send_Package_Rate,1e3*(K.packets-xe.packets)/ke)}}return V}(g[0].ssrcId,t,m,0,n)}}),{high:l,low:d,audio:c}}getInboundStats(t,s,n,r){if(!this.requestRemoteMedia)return;const i=this.requestRemoteMedia()||[],o=[];return i.forEach(c=>{let[l,d]=c;const h={peer:l.uid};let p;if(d.has(Le.VIDEO)&&l.videoTrack){const m=l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)||!1,g=l.videoTrack?function(T,w,S,I,O,M,z,K){const V=w.videoRecv.find(xt=>xt.ssrc===T);if(!V)return;const Y={},{receivedFrame:ce,outputFrame:xe,decodeFrameRate:ke}=V;nt(Y,_n.Video_Render_Frame_Rate_Decode,ke),V.framesRateFirefox&&nt(Y,_n.Video_Recv_Frame_Rate,V.framesRateFirefox),ce&&nt(Y,_n.Video_Recv_Frame_Rate,ce.frameRate),nt(Y,_n.Video_Recv_Frame_Dropped,V.framesDroppedCount),nt(Y,_n.Video_Recv_Bytes_Retransmit,V.retransmittedBytesReceived),nt(Y,_n.Video_Recv_Packages_Retransmit,V.retransmittedPacketsReceived),nt(Y,_n.Video_Recv_Packages_Discarded,V.packetsDiscarded),nt(Y,_n.Video_Recv_Avg_Decode,V.avgDecodeMs),nt(Y,_n.Video_Recv_Avg_Processing_Delay,V.avgProcessingDelayMs),nt(Y,_n.Video_Recv_Avg_Assembly_Time,V.avgFramesAssembledFromMultiplePacketsMs),nt(Y,_n.Video_Recv_Avg_Inter_Frame_Delay,V.avgInterFrameDelayMs),nt(Y,_n.Video_Recv_Key_Frames_Decoded,V.keyFramesDecoded);const lt=K&&K.videoRecv.find(xt=>xt.ssrc===T);if(lt){const xt=w.timestamp-K.timestamp||qc;V.packetsLost!=null&&lt.packetsLost!=null&&nt(Y,_n.Video_Recv_Package_Lost,V.packetsLost-lt.packetsLost),lt.bytes!=null&&V.bytes!=null&&nt(Y,_n.Video_Recv_Bitrate,8*(V.bytes-lt.bytes)/xt),lt.packets!=null&&V.packets!=null&&nt(Y,_n.Video_Recv_Package_Rate,1e3*(V.packets-lt.packets)/xt)}const at=M&&M.videoRecv.find(xt=>xt.ssrc===T);if(at&&(nt(Y,ui.Video_Recv_Qp_Sum,V.qpSumPerFrame),Y[ui.Video_Recv_Freeze]=I&&sh.isRemoteVideoFreeze(S,V,at)?1:0),z){var Et;const xt=z.videoRecv.find(Rs=>Rs.ssrc===T);ce?(nt(Y,gt.Video_Recv_Height,ce.height),nt(Y,gt.Video_Recv_Width,ce.width)):S&&(nt(Y,gt.Video_Recv_Height,S._videoHeight||0),nt(Y,gt.Video_Recv_Width,S._videoWidth||0)),xe&&nt(Y,gt.Video_Recv_Frame_Rate_Output,xe.frameRate);const Ht=(Et=S._player)===null||Et===void 0?void 0:Et.rendFrameRate.toFixed(0);if(Ht&&nt(Y,gt.Video_Render_Frame_Rate_Render,+Ht),nt(Y,gt.Video_Recv_Jitter_Buffer,V.jitterBufferMs),nt(Y,gt.Video_Recv_Current_Delay,V.currentDelayMs),nt(Y,gt.Video_Recv_Firs,V.firsCount),nt(Y,gt.Video_Recv_Nacks,V.nacksCount),nt(Y,gt.Video_Recv_Plis,V.plisCount),S){Y[gt.Video_Recv_Disabled]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1;const Rs=S._player;if(Rs){const{freezeTimeCounterList:de,renderFreezeAccTime:Se,renderFreezeAccTime2:Me,videoElementStatus:me}=Rs;if(de&&de.length>0&&nt(Y,ui.Video_Render_Freeze_Time,de.splice(0,1)[0]),O&&Va.visibility==="visible"&&me===Gn.PLAYING&&At().supportRequestVideoFrameCallback){const v=Math.min(6e3,Me);Rs.renderFreezeAccTime2=Math.max(0,Me-v),nt(Y,ui.Video_Render_Freeze_Time_Render2,v);const L=Math.min(6e3,Se);Rs.renderFreezeAccTime=Math.max(0,Se-L),nt(Y,ui.Video_Render_Freeze_Time_Render,C("USE_NEW_RENDER_FREEZE_TIME")?v:L)}if(typeof V.totalFreezesDuration=="number"){const v=xt&&xt.totalFreezesDuration?V.totalFreezesDuration-xt.totalFreezesDuration:V.totalFreezesDuration;nt(Y,gt.Video_Render_Freeze_Duration,1e3*v)}}}if(Y[gt.Video_Recv_Player_Status]=a_[S._player?S._player.videoElementStatus:"uninit"],xt&&V.totalInterFrameDelay!==void 0&&V.totalSquaredInterFrameDelay!==void 0&&xt.totalInterFrameDelay!==void 0&&xt.totalSquaredInterFrameDelay!==void 0){const Rs=V.totalInterFrameDelay-xt.totalInterFrameDelay,de=V.totalSquaredInterFrameDelay-xt.totalSquaredInterFrameDelay,Se=V.framesDecodeCount-xt.framesDecodeCount,Me=Rs/Se*1e3,me=Math.round(1e3*Math.sqrt((de-Math.pow(Rs,2)/Se)/Se));!isNaN(me)&&Me+me>Math.max(3*Me,Me+150)&&(Y[gt.Video_Recv_I_Frame_Delay]=me)}}return Y}(l._videoSSRC,t,l.videoTrack,m===!0,this.needUploadRenderFreezeTime,s,n,r):void 0;if(g&&(h.video=g),l.videoTrack){const T=t.videoRecv.find(w=>w.ssrc===l._videoSSRC);T&&T.estimatedPlayoutTimestamp&&(p=T.estimatedPlayoutTimestamp)}}if(d.has(Le.AUDIO)&&l.audioTrack){const m=l.audioTrack?function(g,T,w,S,I,O){const M=T.audioRecv.find(Y=>Y.ssrc===g);if(!M)return;const z={};nt(z,_n.Audio_Recv_Jitter,M.jitterMs),nt(z,_n.Audio_Recv_Bytes_Retransmit,M.retransmittedBytesReceived),nt(z,_n.Audio_Recv_Packages_Retransmit,M.retransmittedPacketsReceived),nt(z,_n.Audio_Recv_Packages_Discarded,M.packetsDiscarded),nt(z,_n.Audio_Recv_Avg_Processing_Delay,M.avgProcessingDelayMs);const K=O&&O.audioRecv.find(Y=>Y.ssrc===g);if(K){const Y=qc;M.packets!=null&&K.packets!=null&&nt(z,_n.Audio_Recv_Package_Rate,1e3*(M.packets-K.packets)/Y),M.packetsLost!=null&&K.packetsLost!=null&&nt(z,_n.Audio_Recv_Package_Lost,M.packetsLost-K.packetsLost)}if(S){const{receivedFrames:Y,droppedFrames:ce}=M;Y!=null&&ce!=null&&(z[ui.Audio_Recv_Freeze]=(V=Y)===0||100*ce/V>20?1:0)}var V;if(I){const Y=100*w._source.getAccurateVolumeLevel(),ce=M.outputLevel;if(ce!=null){const ke=Math.ceil(50*Math.log10(100*ce+1));nt(z,gt.Audio_Render_Level,ke)}nt(z,gt.Audio_Recv_PCM_Level,Y),w&&(z[gt.Audio_Recv_Disabled]=w._originMediaStreamTrack.enabled&&w._mediaStreamTrack.enabled?0:1),nt(z,gt.Audio_Recv_Jitter_Buffer,M.jitterBufferMs),nt(z,gt.Audio_Recv_Current_Delay,M.jitterBufferMs),z[gt.Audio_Recv_Player_Status]=a_[ea.getPlayerState(w.getTrackId())];const xe=I.audioRecv.find(ke=>ke.ssrc===g);if(xe){xe.bytes!=null&&M.bytes!=null&&nt(z,gt.Audio_Recv_Bitrate,8*(M.bytes-xe.bytes)/(qc*ah));const ke=M.concealedSamples-xe.concealedSamples;ke>0&&nt(z,gt.Audio_Recv_Concealed_Samples,ke);const lt=M.totalSamplesReceived-xe.totalSamplesReceived;lt>0&&nt(z,gt.Audio_Recv_Total_Samples_Received,lt);const at=M.freezeSamples80-xe.freezeSamples80;at>0&&nt(z,gt.Audio_Render_Freeze_Samples_80ms,at);const Et=M.freezeSamples200-xe.freezeSamples200;Et>0&&nt(z,gt.Audio_Render_Freeze_Samples_200ms,Et);const xt=M.freezeMs80-xe.freezeMs80;nt(z,gt.Audio_Render_Freeze_Time_80ms,xt<0?0:xt);const Ht=M.freezeMs200-xe.freezeMs200;nt(z,gt.Audio_Render_Freeze_Time_200ms,Ht<0?0:Ht)}}return z}(l._audioSSRC,t,l.audioTrack,s,n,r):void 0;if(m&&(h.audio=m),l.audioTrack&&p){const g=t.audioRecv.find(T=>T.ssrc===l._audioSSRC);if(g&&g.estimatedPlayoutTimestamp){const T=g.estimatedPlayoutTimestamp-p;h.audio?h.audio[_n.Audio_Recv_AV_Sync_TIME]=T:h.audio={[_n.Audio_Recv_AV_Sync_TIME]:T}}}}(h.video||h.audio)&&o.push(h)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(s=>s instanceof zu);if(t&&t._external.getDenoiserStats){const s=t._external.getDenoiserStats();s&&this.requestUpload(Hc.DENOISER_STATS,s)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(s=>{this.requestUpload&&this.requestUpload(s.type,s.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[s,n]=t;n.has(Le.VIDEO)&&s.videoTrack&&s.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),n.has(Le.AUDIO)&&s.audioTrack&&s.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const s=Date.now(),n={connectionInterval:C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:s};let r=[];const i=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of i)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,h]of o)h.has(Le.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),h.has(Le.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;n.details=function(d,h){const p={};for(const{id:w,value:S,level:I,direction:O}of d){var m;const M=(m=h.get(w))!==null&&m!==void 0?m:0,z=S===2?M+C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:M;var g,T;h.set(w,z),p[w]?(S===2&&(p[w].value=S),I>p[w].level&&(p[w].level=I),O==="remote"&&(p[w].remoteUidCount+=1),p[w].totalTs=(g=h.get(w))!==null&&g!==void 0?g:0):p[w]={value:S,level:I,remoteUidCount:O==="local"?0:1,totalTs:(T=h.get(w))!==null&&T!==void 0?T:0}}return Object.keys(p).map(w=>{const{level:S,value:I,totalTs:O}=p[w];return{id:w,level:S,value:I,totalTs:O}})}(r,t);const c=Date.now(),l=c>s?c:s+1;this.requestUpload&&this.requestUpload(Hc.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:l})},C("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,Va.stopCollectStats()}}const xK=C("ICE_RESTART_INTERVAL");let ff=new Map,Td=new Map,qo=[Sn.UDP_TCP_RELAY,Sn.TCP_RELAY,Sn.RELAY],lv=C("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&At().supportPCSetConfiguration;function bk(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const s=ff.get(e.id);s&&(window.clearTimeout(s),ff.delete(e.id));const n=Td.get(e.id);t&&n&&n.index===qo.length-1&&(b.debug("[".concat(e.id,"] reset ICE restart policy")),Td.delete(e.id))}function _k(e,t,s){if(ff.size===0&&Td.size===0&&(Array.isArray(C("RESTART_SEQUENCE"))&&C("RESTART_SEQUENCE").length>0&&!function(c,l){if(c.length!==l.length)return!1;for(let d=0;d<c.length;d+=1){const h=c[d];if(c.filter(p=>p===h).length!==l.filter(p=>p===h).length)return!1}return!0}(qo,C("RESTART_SEQUENCE"))&&(qo=C("RESTART_SEQUENCE").filter(c=>{var l;if(_e(l=Object.values(Sn)).call(l,c))return!0}),b.debug("use reconnection policy from config distribution, queues: ".concat(qo.join(" => ")))),lv=C("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&At().supportPCSetConfiguration),qo.length===0)return void s();let n,{index:r=0,type:i}=Td.get(e.id)||{};if(lv&&i===Sn.RELAY)return void s();let o=i&&r>=qo.length-1;if(lv)i=Sn.RELAY;else{if(o)return void s();i?(r++,i=qo[r]):(i=qo[0],r=0)}b.debug("[".concat(e.id,"] choose ICE restart policy: ").concat(i,", index: ").concat(r)),t(i),Td.set(e.id,{index:r,type:i}),n=window.setTimeout(()=>_k(e,t,s),xK),ff.set(e.id,n)}var Dt;function vk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Mi(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?vk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):vk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}function Ek(e){var t,s,n,r=2;for(typeof Symbol<"u"&&(s=om,n=Symbol.iterator);r--;){if(s&&(t=e[s])!=null)return t.call(e);if(n&&(t=e[n])!=null)return new gf(t.call(e));s="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function gf(e){function t(s){if(Object(s)!==s)return Te.reject(new TypeError(s+" is not an object."));var n=s.done;return Te.resolve(s.value).then(function(r){return{value:r,done:n}})}return gf=function(s){this.s=s,this.n=s.next},gf.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(s){var n=this.s.return;return n===void 0?Te.resolve({value:s,done:!0}):t(n.apply(this.s,arguments))},throw:function(s){var n=this.s.return;return n===void 0?Te.reject(s):t(n.apply(this.s,arguments))}},new gf(e)}let Xc=(Dt=class extends Cs{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Xe.StateChange,t,this._state)}constructor(e,t){super(),N(this,"isPlanB",void 0),N(this,"store",void 0),N(this,"statsUploader",void 0),N(this,"connection",void 0),N(this,"localTrackMap",new Map),N(this,"remoteUserMap",new Map),N(this,"localDataChannels",[]),N(this,"remoteDataChannelMap",new Map),N(this,"pendingLocalTracks",[]),N(this,"pendingRemoteTracks",[]),N(this,"pendingLocalDataChannels",[]),N(this,"pendingRemoteDataChannels",[]),N(this,"statsCollector",void 0),N(this,"shouldForwardP2PCreation",void 0),N(this,"iceFailedCount",0),N(this,"dtlsFailedCount",0),N(this,"mutex",void 0),N(this,"_state",Yt.Disconnected),N(this,"_pcStatsUploadType",C("NEW_ICE_RESTART")?oo.FIRST_CONNECTION:oo.OLD_FIRST_CONNECTION),N(this,"_isStartRestartIce",!1),N(this,"_restartTimer",void 0),N(this,"_isTryConnecting",!1),N(this,"_iceError",null),N(this,"_forceTurn",!1),N(this,"_isWaitPcToRePub",!1),N(this,"handleMuteLocalTrack",async(s,n,r)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Yt.Connected)return void r(new se(A.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const o=this.filterTobeMutedTracks(s);if(o.length===0)return void n();const c=o.find(d=>d[0]==="videoLowTrack");if(c){const d=c[1];this.store.enableInstantMuteRestore?(d.track._originMediaStreamTrack.enabled=!1,b.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):d.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?b.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(o.map(d=>{let[,{id:h}]=d;return h}));const l=this.createMuteMessage(o);await ls(this,Xe.RequestMuteLocal,l),n()}catch(o){r(o)}finally{i()}}),N(this,"handleUnmuteLocalTrack",async(s,n,r)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Yt.Connected)return void r(new se(A.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const o=this.filterTobeUnmutedTracks(s);if(o.length===0)return void n();const c=o.find(d=>d[0]==="videoLowTrack");if(c){const d=c[1];if(this.store.enableInstantMuteRestore)d.track._originMediaStreamTrack.enabled=!0,b.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(d.track._originMediaStreamTrack.stop(),!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding){const h=s._mediaStreamTrack.clone();d.track._mediaStreamTrack=h,d.track._originMediaStreamTrack=h}else{const h=ov(s,Ac(this,Xe.RequestLowStreamParameter));d.track._mediaStreamTrack=h,d.track._originMediaStreamTrack=h}await new Te((h,p)=>{this.handleReplaceTrack(d.track,h,p,!0)})}}this.store.enableInstantMuteRestore?b.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(o.map(d=>{let[,{id:h}]=d;return h}));const l=this.createUnmuteMessage(o);await ls(this,Xe.RequestUnmuteLocal,l),n()}catch(o){r(o)}finally{i()}}),N(this,"handleUpdateVideoEncoder",async(s,n,r,i)=>{let o;i||(o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get(ve.LocalVideoTrack);if(!this.connection||!l||l.track!==s||this.state!==Yt.Connected)return void n();const{id:d,track:h}=l;await this.connection.updateSendParameters(d,h),await this.connection.updateEncoderConfig(d,h),this.emit(Xe.UpdateVideoEncoder,h),n()}catch(l){r(l)}finally{var c;(c=o)===null||c===void 0||c()}}),N(this,"handleUpdateVideoSendParameters",async(s,n,r)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(ve.LocalVideoTrack);if(!this.connection||!o||o.track!==s||this.state!==Yt.Connected)return void n();const{id:c,track:l}=o;await this.connection.updateSendParameters(c,l),n()}catch(o){r(o)}finally{i()}}),N(this,"handleReplaceMixingTrack",async(s,n,r,i)=>{if(!this.connection||this.state!==Yt.Connected)return void n();const o=av([s]);let c;b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),typeof i=="boolean"&&i||(c=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(s,o),n()}catch(d){r(d)}finally{var l;(l=c)===null||l===void 0||l()}}),N(this,"handleReplaceTrack",async(s,n,r,i)=>{let o;b.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(s.getTrackId(),"]")),typeof i=="boolean"&&i||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var c;const d=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:p}]=h;return s===p});if(!this.connection||!d||this.state!==Yt.Connected)return void n();if(await((c=this.connection)===null||c===void 0?void 0:c.replaceTrack(s,d[1].id)),this.isPlanB){const h=d[1];h.id=s._mediaStreamTrack.id,this.localTrackMap.set(d[0],h)}if(d[0]===ve.LocalVideoTrack&&!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding){const h=this.localTrackMap.get(ve.LocalVideoLowTrack);if(h){const p=s._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=p,h.track._originMediaStreamTrack=p,await new Te((m,g)=>{this.handleReplaceTrack(h.track,m,g,!0)})}}n()}catch(d){r(d)}finally{var l;(l=o)===null||l===void 0||l()}}),N(this,"handleGetRTCStats",s=>{s(this.statsCollector.getRTCStats())}),N(this,"handleGetLocalVideoStats",s=>{s(this.statsCollector.getLocalVideoTrackStats())}),N(this,"handleGetLocalAudioStats",s=>{s(this.statsCollector.getLocalAudioTrackStats())}),N(this,"handleGetRemoteVideoStats",s=>this.statsCollector.getRemoteVideoTrackStats(s.uid)[s.uid]),N(this,"handleGetRemoteAudioStats",s=>this.statsCollector.getRemoteAudioTrackStats(s.uid)[s.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new xk(this.store),this.bindStatsUploaderEvents(),this.mutex=new wn("P2PChannel-mutex",this.store.clientId),this.isPlanB=!At().supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&Ci(),this.shouldForwardP2PCreation=C("FORWARD_P2P_CREATION")&&At().supportPCSetConfiguration&&aI(),this.shouldForwardP2PCreation&&(this.connection=nh(this.store),this.emit(Xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var s;this.state=Yt.New,this._forceTurn=iv(e),b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const n=this.shouldForwardP2PCreation&&((s=this.connection)===null||s===void 0?void 0:s.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||n||t)&&((n||t)&&this.connection&&(b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=nh(this.store,e),this.emit(Xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new se(A.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=C("NEW_ICE_RESTART")?oo.FIRST_CONNECTION:oo.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new se(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==Yt.Connected){this.store.peerConnectionStart();const t=await this.connection.connect(e);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Yt.Connected,t}if(this.connection instanceof Za&&this.connection.checkDtlsParameters(e.dtlsParameters.fingerprints))return b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),Ue.reportApiInvoke(this.store.sessionId,{name:Ns.MISMATCH_DTLS_PARAMETERS,options:[e.dtlsParameters.fingerprints],tag:is.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(Xe.RequestReconnect)});await this.connection.updateRemoteConnect(e)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter(r=>{var i;let[o]=r;return _e(i=[ve.LocalVideoLowTrack,ve.LocalVideoTrack]).call(i,o)}),s=t.map(r=>{let[,{id:i}]=r;return i}),n=t.map(r=>{let[i]=r;return i});if(this.connection instanceof Za||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(Ue.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(n),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!_e(e).call(e,this.store.codec)){const r=["vp9","vp8","h264"].find(i=>_e(e).call(e,i));r&&(this.store.codec=r,b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(s,e)}}async getEstablishParams(){var e;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Za&&this.connection.peerConnectionState!=="closed"&&_e(e=[Yt.New,Yt.Connected]).call(e,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(e){if(!this.connection||this.state!==Yt.Connected){if(this.state===Yt.Disconnected)throw new se(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach(s=>{var n;_e(n=this.pendingLocalDataChannels).call(n,s)||this.pendingLocalDataChannels.push(s)}),[]}const t=this.filterTobePublishedDataChannels(e);return t.length===0?[]:(t.forEach(s=>{const n=Date.now();this.store.publish(s.id.toString(),"datachannel",n)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(s=>{this.localDataChannels.push(s);const n=Date.now();this.store.publish(s.id+"","datachannel",void 0,n)}),e.map(s=>({streamId:s.id,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:s.metadata,channelId:s._originDataChannelId})))}publish(e,t,s){var n=this;return xa(function*(){const r=yield yt(n.mutex.lock("From P2PChannel.publish"));try{var i;const o=n.connection&&_e(i=["disconnected","failed"]).call(i,n.connection.peerConnectionState);if(!n.connection||n.state!==Yt.Connected||o){if(n.state===Yt.Disconnected)throw new se(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const l=e.filter(d=>n.pendingLocalTracks.indexOf(d)===-1);return n.pendingLocalTracks=n.pendingLocalTracks.concat(l),void(o&&(n._isWaitPcToRePub=!0))}n.store.pubId=n.store.pubId+1,Hn.markPublishStart(n.store.clientId,n.store.pubId);const c=n.filterTobePublishedTracks(e,t,s);if(c.length===0)return void(yield yt(n.tryToUnmuteAudio(e)));yield*Xl(Ek(n.doPublish(n.connection,c)))}finally{r()}})()}doPublish(e,t){var s=this;return xa(function*(){t.forEach(m=>{let{track:g,type:T}=m;const w=Date.now();s.store.publish(g.getTrackId(),T===ve.LocalAudioTrack?"audio":"video",w)}),s.bindLocalTrackEvents(t);const n=t.map(m=>{let{track:g}=m;return g}),r=yield yt(e.send(n,s.store.codec,s.store.audioCodec)),i=(yield yt(r.next())).value,o=s.createGatewayPublishMessage(t,i);let c;try{c=yield o}catch(m){throw r.throw(m),(m==null?void 0:m.code)===A.WS_ABORT&&t.forEach(g=>{let{track:T}=g;s.pendingLocalTracks.indexOf(T)===-1&&s.pendingLocalTracks.push(T)}),s.unbindLocalTrackEvents(t),m}const l=s.mapPubResToRemoteConfig(o,c,n),d=(yield yt(r.next(l))).value;if(s.state===Yt.Disconnected)throw new se(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");C("ENABLE_VIDEO_SEI");const h=C("ENABLE_ENCODED_TRANSFORM"),p=C("ENABLE_AUDIO_METADATA");n.forEach(async m=>{const g=m.getRTCRtpTransceiver();if(!g||!h)return;const{interceptLocalVideoFrame:T,interceptLocalAudioFrame:w}=af();m.trackMediaType===Le.VIDEO?await T(g.sender,m):m.trackMediaType===Le.AUDIO&&await w(g.sender,{metadata:p?()=>{const S=m.metadata.shift();return S&&S.value}:void 0})}),t.forEach(m=>{let{type:g}=m;s.statsCollector.addLocalStats(g)}),s.assignLocalTracks(t,d),s.statsUploader.startUploadOutboundStats(),t.forEach(m=>{let{track:g,type:T}=m;const w=Date.now();s.store.publish(g.getTrackId(),T===ve.LocalAudioTrack?"audio":"video",void 0,w)})})()}async updateVideoStreamParameter(e,t){const s=this.localTrackMap.get(t);if(!s||!this.connection)return;if(!(s.track instanceof os))return b.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:n}=s,r=function(i,o){const c={};return i.height&&i.width&&(c.scaleResolutionDownBy=M_(i,o)),c.maxFramerate=i.framerate?ya(i.framerate):void 0,c.maxBitrate=i.bitrate?1e3*i.bitrate:void 0,c}(e,n);if(n._encoderConfig||(n._encoderConfig={}),t!==ve.LocalVideoLowTrack||!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(n._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const i=n._originMediaStreamTrack;if(!i.canvas)return b.warn("[".concat(n.getTrackId(),"] no canvas on track"));(function(o,c){const l=o.canvas;c.width&&(l.width=ya(c.width)),c.height&&(l.height=ya(c.height)),c.framerate&&(l.stopCapture&&l.stopCapture(),l.stopCapture=o_(()=>{!l.startCapture&&l.stopCapture&&l.stopCapture(),l.startCapture&&l.startCapture()},ya(c.framerate)))})(i,e)}r.maxBitrate!=null&&(n._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(n._encoderConfig.frameRate&&typeof n._encoderConfig.frameRate=="object"?n._encoderConfig.frameRate.max=r.maxFramerate:n._encoderConfig.frameRate={max:r.maxFramerate}),b.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),await this.connection.updateRtpSenderEncodings(n)}publishLowStream(e){var t=this;return xa(function*(){if(!t.connection||t.state!==Yt.Connected)return;const s=yield yt(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=t.localTrackMap.get(ve.LocalVideoTrack);if(!r)throw new se(A.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(ve.LocalVideoLowTrack))throw new se(A.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const i=[{track:t.getLowVideoTrack(r.track,e),type:ve.LocalVideoLowTrack}];if(yield*Xl(Ek(t.doPublish(t.connection,i))),r.track.muted||!r.track.enabled){var n;const o=(n=t.localTrackMap.get(ve.LocalVideoLowTrack))===null||n===void 0?void 0:n.id;o!==void 0&&(yield yt(t.connection.muteLocal([o])))}}finally{s()}})()}async republish(){this.pendingLocalTracks.length>0&&(b.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Qs(this,Xe.RequestRePublish,this.pendingLocalTracks),this.emit(Xe.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(b.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Qs(this,Xe.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:s,kind:n}=this.pendingRemoteTracks[t];(n!==Le.AUDIO||s._audio_added_&&s._audioSSRC)&&(n!==Le.VIDEO||s._video_added_&&s._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await Qs(this,Xe.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:s}of this.pendingRemoteTracks)await this.subscribe(t,s,s===Le.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:s}=t;this.emit(Xe.MediaReconnectEnd,s.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Yt.Connected)return void e.forEach(n=>{const r=this.pendingLocalTracks.indexOf(n);r!==-1&&this.pendingLocalTracks.splice(r,1)});const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const s=t.find(n=>n[0]==="videoLowTrack");return s&&s[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==Yt.Connected)return void e.forEach(s=>{const n=this.pendingLocalDataChannels.indexOf(s);n!==-1&&this.pendingLocalDataChannels.splice(n,1)});const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(s=>{const n=this.localDataChannels.indexOf(s);n!==-1&&this.localDataChannels.splice(n,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(s=>s.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Yt.Connected)return;const e=this.localTrackMap.get(ve.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[ve.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const s=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(n=>{let[,{id:r}]=n;return r})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(n=>{let[r,{track:i}]=n;return{type:r,track:i}})),t.forEach(n=>{let[r]=n;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),s}async subscribeDataChannel(e,t){if(!this.connection||this.state!==Yt.Connected)throw new se(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const s=t.filter(n=>{var r;return!((r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.get(n.id))});if(s.length!==0)return await this.connection.createDataChannels(e.uid,s),s.forEach(n=>{var r;this.remoteDataChannelMap.has(e)?(r=this.remoteDataChannelMap.get(e))===null||r===void 0||r.set(n.id,n):this.remoteDataChannelMap.set(e,new Map([[n.id,n]]));const i=this.pendingRemoteDataChannels.findIndex(o=>{let{user:c,id:l}=o;return c.uid===e.uid&&l===n.id});i!==-1&&this.pendingRemoteDataChannels.splice(i,1)}),s.map(n=>n.id)}async subscribe(e,t,s,n,r){var i;if(!this.connection||this.state!==Yt.Connected)throw new se(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((i=this.remoteUserMap.get(e))!==null&&i!==void 0&&i.has(t))return;let o,c,l,d;const h=this.connection.getPreMedia(s);if(h)b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(s,", no need to send sub to gateway.")),l=h.transceiver,o=h.track,c=h.mid,d=h.player,h.firstVideoRender&&this.store.firstVideoFrameDecoded(e.uid,{firstPreRender:h.firstVideoRender});else if(r){const g=r.find(w=>{let{stream_type:S}=w;return S===t});if(!g)throw new se(A.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const T=await this.connection.receive(t,g.ssrcs,String(e._uintid),g.attributes);(this.connection instanceof Za||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(l=T.transceiver),o=T.track,c=T.id}else{const g=await this.connection.receive(t,[{ssrcId:s,rtx:n}],String(e._uintid),void 0);(this.connection instanceof Za||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(l=g.transceiver),o=g.track,c=g.id}if(t===Le.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new hd(o,e.uid,e._uintid,this.store),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),l&&e._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new ud(o,e.uid,e._uintid,this.store,d),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId())),e._videoTrack.once(ur.PLAY_START,()=>{this.store.firstVideoFrameDecoded(e.uid,{playStart:Date.now()})}),e._videoTrack.once(ur.PLAY_END,()=>{this.store.firstVideoFrameDecoded(e.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(e)}),d?e._videoTrack.once(ur.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)}):e._videoTrack.once(ur.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)})),l&&e._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._videoTrack)),l&&C("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:g,interceptRemoteAudioFrame:T}=af();t==Le.VIDEO?await g(l.receiver,{onSei:C("ENABLE_VIDEO_SEI")&&(w=>{var S;return(S=e._videoTrack)===null||S===void 0?void 0:S._onSei(w)}),onFirstFrame:w=>{var S;const I=Array.from(Jn(S=this.remoteUserMap).call(S)).find(O=>O._videoSSRC===w.ssrc);I&&this.store.firstVideoFrameDecoded(I.uid,{firstReceivedEncodedFrame:Date.now(),frameType:w.type,rtpTimestamp:w.rtpTimestamp,framePayloadType:w.payloadType,frameDataLength:w.length,mimeType:w.mimeType})}}):t==Le.AUDIO&&await T(l.receiver,{enableTopn:!!C("ENABLE_AUDIO_TOPN"),enableMetadata:!!C("ENABLE_AUDIO_METADATA"),enablePts:!!C("ENABLE_AUDIO_PTS"),onMetadata:w=>{this.safeEmit(Xe.AudioMetadata,w)},onPts:w=>{this.safeEmit(Xe.AudioPts,w)}})}const p=this.remoteUserMap.get(e);p?p.set(t,c):this.remoteUserMap.set(e,new Map([[t,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const m=this.pendingRemoteTracks.findIndex(g=>{let{user:T,kind:w}=g;return T.uid===e.uid&&t===w});m!==-1&&(this.pendingRemoteTracks.splice(m,1),this.emit(Xe.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Yt.Connected)throw new se(A.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(r=>{var i;let{user:o,mediaType:c}=r;return!((i=this.remoteUserMap.get(o))!==null&&i!==void 0&&i.has(c))});const t=[],s=new Map;e.forEach(r=>{if(!this.connection)return;const i=this.connection.getPreMedia(r.ssrcId);if(i){const{track:o,mid:c,transceiver:l,player:d}=i;s.set(r.ssrcId,{track:o,id:c,transceiver:l,player:d})}else t.push(r)});const n=await this.connection.batchReceive(t.map(r=>{let{user:i,mediaType:o,ssrcId:c,rtxSsrcId:l}=r;return{kind:o,ssrcMsg:[{ssrcId:c,rtx:l}],mslabel:String(i._uintid)}}));t.forEach((r,i)=>{s.set(r.ssrcId,n[i])});for(const{user:r,mediaType:i,ssrcId:o}of e){const c=s.get(o);if(!c)return void b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(i,", ").concat(o));const{track:l,id:d,transceiver:h,player:p}=c;if(h&&C("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:T,interceptRemoteAudioFrame:w}=af();i==Le.VIDEO?await T(h.receiver,{onSei:C("ENABLE_VIDEO_SEI")&&(S=>{var I;return(I=r._videoTrack)===null||I===void 0?void 0:I._onSei(S)}),onFirstFrame:S=>{var I;const O=Array.from(Jn(I=this.remoteUserMap).call(I)).find(M=>M._videoSSRC===S.ssrc);O&&this.store.firstVideoFrameDecoded(O.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):i==Le.AUDIO&&await w(h.receiver,{enableTopn:!!C("ENABLE_AUDIO_TOPN"),enableMetadata:!!C("ENABLE_AUDIO_METADATA"),enablePts:!!C("ENABLE_AUDIO_PTS"),onMetadata:S=>{this.safeEmit(Xe.AudioMetadata,S)},onPts:S=>{this.safeEmit(Xe.AudioPts,S)}})}if(i===Le.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(l):(r._audioTrack=new hd(l,r.uid,r._uintid,this.store),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),h&&r._audioTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(l):(r._videoTrack=new ud(l,r.uid,r._uintid,this.store,p),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),h&&r._videoTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(r,r._videoTrack)),C("ENABLE_VIDEO_SEI")&&h){const{interceptRemoteVideoFrame:T,interceptRemoteAudioFrame:w}=af();i==Le.VIDEO?await T(h.receiver,{onSei:S=>{var I;(I=r._videoTrack)===null||I===void 0||I._onSei(S)},onFirstFrame:S=>{var I;const O=Array.from(Jn(I=this.remoteUserMap).call(I)).find(M=>M._videoSSRC===S.ssrc);O&&this.store.firstVideoFrameDecoded(O.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):i==Le.AUDIO&&await w(h.receiver)}const m=this.remoteUserMap.get(r);m?m.set(i,d):this.remoteUserMap.set(r,new Map([[i,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const g=this.pendingRemoteTracks.findIndex(T=>{let{user:w,kind:S}=T;return w.uid===r.uid&&i===S});g!==-1&&(this.pendingRemoteTracks.splice(g,1),this.emit(Xe.MediaReconnectEnd,r.uid))}}async unsubscribe(e,t,s){const n=this.pendingRemoteTracks.filter(o=>{let{user:c,kind:l}=o;return t!==void 0?c.uid===e.uid&&t===l:c.uid===e.uid});if(n.forEach(o=>{const c=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(c,1)}),this.connection&&this.state===Yt.Connected||s||n.forEach(o=>{let{kind:c}=o;var l;if(c===Le.AUDIO)(l=e._audioTrack)===null||l===void 0||l._destroy(),e._audioTrack=void 0;else if(c===Le.VIDEO){var d;(d=e._videoTrack)===null||d===void 0||d._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==Yt.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(r.length===0)return;await this.connection.stopReceiving(r.map(o=>{let[,{id:c}]=o;return c}));const i=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(o=>{let[c,{kind:l}]=o;var d,h;if(l===Le.VIDEO&&c._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),l===Le.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),s||((h=c._videoTrack)===null||h===void 0||h._destroy(),c._videoTrack=void 0);else if(l===Le.AUDIO){var p;this.unbindRemoteTrackEvents(c._audioTrack),!s&&((p=c._audioTrack)===null||p===void 0||p._destroy(),c._audioTrack=void 0)}}),i}async unsubscribeDataChannel(e,t){if(t.forEach(r=>{const i=this.pendingRemoteDataChannels.findIndex(o=>o.id===r.id);i!==-1&&this.pendingRemoteDataChannels.splice(i,1)}),!this.connection)return;const s=this.filterTobeUnSubscribedDataChannels(e,t);if(s.length===0)return;t.forEach(r=>{r._close()});const n=this.remoteDataChannelMap.get(e);return s.forEach(r=>{n&&n.delete(r.id)}),n&&n.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),s.map(r=>r.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:i}of e){const o=this.pendingRemoteTracks.filter(c=>{let{user:l,kind:d}=c;return i!==void 0?l.uid===r.uid&&i===d:l.uid===r.uid});o.forEach(c=>{const l=this.pendingRemoteTracks.indexOf(c);this.pendingRemoteTracks.splice(l,1)}),t=t.concat(o)}if(!this.connection||this.state!==Yt.Connected)return void t.forEach(r=>{let{user:i,kind:o}=r;var c;if(o===Le.AUDIO)(c=i._audioTrack)===null||c===void 0||c._destroy(),i._audioTrack=void 0;else if(o===Le.VIDEO){var l;(l=i._videoTrack)===null||l===void 0||l._destroy(),i._videoTrack=void 0}});const s=or(e).call(e,(r,i)=>{let{user:o,mediaType:c}=i;const l=this.filterTobeUnSubscribedTracks(o,c);return r.concat(l)},[]);if(s.length===0)return;await this.connection.stopReceiving(s.map(r=>{let[,{id:i}]=r;return i}));const n=this.createUnsubscribeAllMessage(s);return this.withdrawRemoteTracks(s),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),s.forEach(r=>{let[i,{kind:o}]=r;var c,l;if(o===Le.VIDEO&&i._videoSSRC&&((c=this.connection)===null||c===void 0||c.setStatsRemoteVideoIsReady(i._videoSSRC,!1)),o===Le.VIDEO)this.unbindRemoteTrackEvents(i._videoTrack),(l=i._videoTrack)===null||l===void 0||l._destroy(),i._videoTrack=void 0;else if(o===Le.AUDIO){var d;this.unbindRemoteTrackEvents(i._audioTrack),(d=i._audioTrack)===null||d===void 0||d._destroy(),i._audioTrack=void 0}}),n}isPreSubScribe(e){return!this.connection||this.state!==Yt.Connected?!1:!!this.connection.getPreMedia(e)}async muteRemote(e,t){if(!this.connection)return;const s=this.remoteUserMap.get(e);if(!s)return void b.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!s.get(t))return void b.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const n=t===Le.VIDEO?e._videoSSRC:e._audioSSRC;n!==void 0&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const s=this.remoteUserMap.get(e);if(!s)return void b.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));s.get(t)||b.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}addAudioMetadata(e){const t=this.localTrackMap.get(ve.LocalAudioTrack),s=t&&t.track;s&&s.metadata.push(e)}getAllTracks(e){const t=this.localTrackMap.get(ve.LocalAudioTrack);if((t==null?void 0:t.track)instanceof nn){const s=t.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==ve.LocalAudioTrack}).filter(n=>{let[r]=n;return!(e&&r===ve.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(s.trackList)}return Array.from(this.localTrackMap.entries()).filter(s=>{let[n]=s;return!(e&&n===ve.LocalVideoLowTrack)}).map(s=>{let[,{track:n}]=s;return n})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,s,n,r){if(e){const o=this.localTrackMap.get(ve.LocalAudioTrack),c=n?this.localTrackMap.get(ve.LocalVideoLowTrack):this.localTrackMap.get(ve.LocalVideoTrack);Ue.publish(this.store.sessionId,{eventElapse:Hn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o==null?void 0:o.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(qt.SCREEN_TRACK))!==-1,audio:!!o,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var i;s||(s=[]);const o=s.find(l=>l instanceof Us),c=n?(i=this.localTrackMap.get(ve.LocalVideoTrack))===null||i===void 0?void 0:i.track:s.find(l=>l instanceof os);Ue.publish(this.store.sessionId,{eventElapse:Hn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o==null?void 0:o.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(qt.SCREEN_TRACK))!==-1,audio:!!o,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,s,n){const r=n===Le.VIDEO?s._videoSSRC:s._audioSSRC;r&&Ue.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===Le.VIDEO,audio:n===Le.AUDIO,peerid:s.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:Hn.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){b.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new wn("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=nh(this.store),this.emit(Xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(ve.LocalAudioTrack);if((e==null?void 0:e.track)instanceof nn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(s=>{t.removeAudioTrack(s)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Yt.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(ve.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(ve.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof os||t&&t.track instanceof Us?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const s=this.remoteUserMap.get(e);return!!s&&(!t||s.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const s=this.remoteUserMap.get(e);return!!s&&(!t||s.has(t))}getRemoteMedia(e){var t;const s=Array.from(Jn(t=this.remoteUserMap).call(t)).find(n=>n.uid===e);return s?{audioTrack:s.audioTrack,audioSSRC:s._audioSSRC,videoTrack:s.videoTrack,videoSSRC:s._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(s=>{let[n]=s;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(ve.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=bc(e).call(e,(s,n)=>s.level-n.level),e}async disconnectForReconnect(){this.connection&&(b.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Yt.Reconnecting,C("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var s;t._videoTrack&&t._videoTrack._player&&((s=t._videoTrack._player.getVideoElement())===null||s===void 0||s.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=nh(this.store),this.emit(Xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[s,{track:n}]=e;switch(s){case ve.LocalVideoTrack:_e(t=n._hints).call(t,qt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case ve.LocalAudioTrack:n instanceof nn?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case ve.LocalVideoLowTrack:}}),this.emit(Xe.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,s]=e;Array.from(Jn(s).call(s)).forEach(n=>{this.setPendingRemoteMedia(t,n)}),this.emit(Xe.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,s]=e;Array.from(Jn(s).call(s)).forEach(n=>{this.setPendingRemoteDataChannel(t,n)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),b.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const s of this.pendingRemoteDataChannels){const{user:n,id:r}=s;if((e instanceof Yo?e.uid:e)===n.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const s of this.pendingRemoteTracks){const{user:n,kind:r}=s;if((e instanceof Yo?e.uid:e)===n.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return xa(function*(){if(!t.connection||t.state!==Yt.Connected)return;const s=yield yt(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield yt(t.connection.restartICE(e));const i=yield yt(n.next());if(i.done)return;const o=i.value,c=yield o;switch(rv(t.connection)&&t.reportPCStats(Date.now(),!1,t._pcStatsUploadType),e){case Sn.UDP_TCP_RELAY:t._pcStatsUploadType=oo.UDP_TCP_RESTART;break;case Sn.TCP_RELAY:t._pcStatsUploadType=oo.TCP_RESTART;break;case Sn.RELAY:t._pcStatsUploadType=oo.RELAY_RESTART;break;default:t._pcStatsUploadType=oo.OLD_RESTART}t._isTryConnecting=!0,n.next(c)}catch(i){var r;(r=n)===null||r===void 0||r.throw(i)}finally{s()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(ve.LocalVideoTrack),s=this.localTrackMap.get(ve.LocalAudioTrack),n=e.videoSend.find(g=>g.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),r=e.audioSend.find(g=>g.ssrc===(s==null?void 0:s.ssrcs[0].ssrcId));if(!n||!r)return 1;const i=Ua(this,Xe.NeedSignalRTT),o=n?n.rttMs:void 0,c=r?r.rttMs:void 0,l=o&&c?(o+c)/2:o||c,d=(l&&i?(l+i)/2:l||i)||0,h=100*e.sendPacketLossRate*.7/50+.3*d/1500,p=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,m=t==null?void 0:t.track;if(m&&m._encoderConfig&&m._hints.indexOf(qt.SCREEN_TRACK)===-1){const g=m._encoderConfig.bitrateMax,T=e.bitrate.actualEncoded;if(g&&T){const w=(1e3*g-T)/(1e3*g);return oD[w<.15?0:w<.3?1:w<.45?2:w<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(s=>{let[n]=s;const r=n._audioSSRC,i=n._videoSSRC,o=e.audioRecv.find(T=>T.ssrc===r),c=e.videoRecv.find(T=>T.ssrc===i);if(!o&&!c)return void(t+=1);const l=Ua(this,Xe.NeedSignalRTT),d=e.rtt,h=(d&&l?(d+l)/2:d||l)||0,p=o?o.jitterMs:void 0,m=e.recvPacketLossRate;let g=.7*m*100/50+.3*h/1500;p&&(g=.6*m*100/50+.2*h/1500+.2*p/400),t+=g<.1?1:g<.17?2:g<.36?3:g<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Te((t,s)=>{this.handleMuteLocalTrack(e,t,s)})}async replaceTrack(e,t){var s;if(b.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==Yt.Connected)return;const n=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return e===o});if(!n)return;const r=n[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:r}]),this.bindLocalTrackEvents([{track:t,type:r}]),n[1].track=t),await((s=this.connection)===null||s===void 0?void 0:s.replaceTrack(t,n[1].id)),this.isPlanB){const i=n[1];i.id=t._mediaStreamTrack.id,this.localTrackMap.set(r,i)}if(r===ve.LocalVideoTrack&&!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding){const i=this.localTrackMap.get(ve.LocalVideoLowTrack);if(i){const o=e._mediaStreamTrack.clone();i.track._originMediaStreamTrack.stop(),i.track._mediaStreamTrack=o,i.track._originMediaStreamTrack=o,await new Te((c,l)=>{this.handleReplaceTrack(i.track,c,l,!0)})}}}filterTobePublishedTracks(e,t,s){const n=[],r=this.getAllTracks();e=Ql(e=e.filter(l=>r.indexOf(l)===-1));let i,o=!1;const c=this.localTrackMap.get(ve.LocalAudioTrack);for(const l of e){if(l instanceof os&&(this.localTrackMap.has(ve.LocalVideoTrack)||o?new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:l,type:ve.LocalVideoTrack}),o=!0),t)){const d=this.getLowVideoTrack(l,s);n.push({track:d,type:ve.LocalVideoLowTrack})}if(l instanceof Us)if(c){const d=c.track;if(d instanceof nn)nv([l]),d.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0);else{const h=av([d,l]);b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(h.getTrackId(),"]")),this.replaceTrack(d,h)}}else i instanceof nn?(nv([l]),i.addAudioTrack(l)):i||!l._useAudioElement&&At().webAudioMediaStreamDest&&!l._bypassWebAudio?i=av(i?[l,i]:[l]):i=l}return i&&(b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(i.getTrackId(),"]")),n.push({track:i,type:ve.LocalAudioTrack})),n}filterTobeUnpublishedTracks(e){const t=[],s=this.getAllTracks();e=Ql(e=e.filter(n=>s.indexOf(n)!==-1));for(const n of e){if(n instanceof Us){const r=this.localTrackMap.get(ve.LocalAudioTrack);if(!r)continue;r.track instanceof nn?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(t.push([ve.LocalAudioTrack,r]),r.track.close())):t.push([ve.LocalAudioTrack,r])}if(n instanceof os){const r=this.localTrackMap.get(ve.LocalVideoTrack);if(!r)continue;t.push([ve.LocalVideoTrack,r]);const i=this.localTrackMap.get(ve.LocalVideoLowTrack);i&&t.push([ve.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=Ql(e)).filter(t=>this.localDataChannels.findIndex(s=>s.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=Ql(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:s,type:n}=t;switch(n){case ve.LocalVideoTrack:s.addListener(Be.GET_STATS,this.handleGetLocalVideoStats),s.addListener(Be.GET_RTC_STATS,this.handleGetRTCStats),s.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.addListener(Be.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),s.addListener(Be.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),s.addListener(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),s.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ve.LocalAudioTrack:this.bindLocalAudioTrackEvents(s);case ve.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof nn?e.trackList.forEach(s=>{s.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.addListener(Be.GET_STATS,this.handleGetLocalAudioStats),s.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Be.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(Be.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[s,{track:n}]=t;return{track:n,type:s}})),e.forEach(t=>{let{track:s,type:n}=t;switch(n){case ve.LocalVideoTrack:s.off(Be.GET_STATS,this.handleGetLocalVideoStats),s.off(Be.GET_RTC_STATS,this.handleGetRTCStats),s.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.off(Be.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),s.off(Be.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),s.off(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),s.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ve.LocalAudioTrack:this.unbindLocalAudioTrackEvents(s);case ve.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof nn?e.trackList.forEach(t=>{t.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Be.GET_STATS,this.handleGetLocalAudioStats),t.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Be.GET_STATS,this.handleGetLocalAudioStats),e.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Be.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof ud&&t.addListener(Be.GET_STATS,s=>{s(this.handleGetRemoteVideoStats(e))}),t instanceof hd&&t.addListener(Be.GET_STATS,s=>{s(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Be.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,s]=e;s.has(Le.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),s.has(Le.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((s,n)=>{var r;let i,o,{track:c,type:l}=s;switch(l){case ve.LocalAudioTrack:i=Qt.Audio,o={dtx:c instanceof zu&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case ve.LocalVideoTrack:i=_e(r=c._hints).call(r,qt.SCREEN_TRACK)?Qt.Screen:Qt.High,o=Mi(Mi({},yD(c)),{},{codec:this.store.codec,svc_mode:Xu()});break;case ve.LocalVideoLowTrack:i=Qt.Low,o=Mi(Mi({},yD(c)),{},{codec:this.store.codec,svc_mode:Xu()})}return{stream_type:i,attributes:o,ssrcs:t[n]}})}createGatewayUnpublishMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}assignLocalTracks(e,t){e.forEach((s,n)=>{let{track:r,type:i}=s;this.localTrackMap.set(i,{track:r,id:t[n].id,ssrcs:t[n].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[s]=t;this.localTrackMap.delete(s)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(Xe.PeerConnectionStateChange,t),t==="connecting"&&e instanceof Za&&!bs()&&C("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{t==="connecting"&&e.extendCandidate()},C("FIRST_TCP_CANDIDATE_INTERVAL")),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),e instanceof Za&&bk(e,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=oo.DISCONNECTED_OR_FAILED,Ua(this,Xe.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const s=this.pendingLocalTracks.map(r=>r.getTrackId()),n=this.pendingLocalDataChannels.map(r=>"dc_".concat(r.id));Ue.reportApiInvoke(this.store.sessionId,{name:Ns.REPUB_AFTER_PC_CONNECTED,options:s.concat(n),tag:is.TRACER}).onSuccess(),this.republish()}if(C("NEW_ICE_RESTART")&&e instanceof Za&&!bs()&&!this._forceTurn&&!this.store.useDcSignal){if(_e(gD).call(gD,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const s=r=>{rv(e)&&(b.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),Ua(this,Xe.QueryClientConnectionState)==="CONNECTED"&&this.emit(Xe.RequestRestartICE,r))},n=()=>{rv(e)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),b.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(Xe.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{_k(e,s,n)},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&C("ICE_RESTART")&&Ua(this,Xe.QueryClientConnectionState)==="CONNECTED"&&this.emit(Xe.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(Xe.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(Xe.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Ue.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:is.TRACER}).onSuccess(),this.emit(Xe.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(i=>i._audioSSRC===t);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(ur.FIRST_FRAME_DECODED),Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_AUDIO_DECODE,Ts.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._audioSSRC===t);n&&Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_AUDIO_RECEIVED,Ts.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,s,n)=>{var r;const i=Array.from(Jn(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===t);i&&this.store.firstVideoFrameDecoded(i.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(t,s,n)},e.onFirstVideoRender=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._videoSSRC===t);n&&(this.store.firstVideoFrameDecoded(n.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(n),this.emit(Xe.FirstVideoPreRender,n.uid,t))},e.onFirstVideoReceived=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._videoSSRC===t);n&&(this.store.firstVideoFrameDecoded(n.uid,{firstReceived:Date.now()}),Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_VIDEO_RECEIVED,Ts.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstVideoBufferReady=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._videoSSRC===t);n&&this.emit(Xe.FirstVideoBufferReady,n.uid,t)},e.onSelectedLocalCandidateChanged=(t,s)=>{const n=t.candidateType==="relay",r=s.candidateType==="relay";s.candidateType!=="unknown"&&n===r||this.emit(Xe.ConnectionTypeChange,n),b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(zo(s))," -> ").concat(JSON.stringify(zo(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,s)=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(zo(s))," -> ").concat(JSON.stringify(zo(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),s=this.statsCollector.getRTCStats();return Mi(Mi({},t),s)},e.onICECandidateError=t=>{this._iceError=t}}fallbackConnection(){b.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===Yt.Connected?(b.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=nh(this.store),this.emit(Xe.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(e){e instanceof Za&&function(t){Td.delete(t.id),bk(t)}(e),e.close(),this.emit(Xe.PeerConnectionStateChange,"closed"),function(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}(e),this._isWaitPcToRePub=!1}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const s=this.localTrackMap.get(ve.LocalAudioTrack);if(e instanceof Us&&(s==null?void 0:s.track)instanceof nn)return s.track.isActive||t.push([ve.LocalAudioTrack,s]),t;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:i}]=r;return e===i});if(n&&(t.push(n),n[0]===ve.LocalVideoTrack)){const r=this.localTrackMap.get(ve.LocalVideoLowTrack);r&&t.push([ve.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],s=this.localTrackMap.get(ve.LocalAudioTrack);if(e instanceof Us&&(s==null?void 0:s.track)instanceof nn)return s.track.isActive&&t.push([ve.LocalAudioTrack,s]),t;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:i}]=r;return e===i});if(n)if(n[0]===ve.LocalVideoTrack){t.push(n);const r=this.localTrackMap.get(ve.LocalVideoLowTrack);r&&t.push([ve.LocalVideoLowTrack,r])}else t.push(n);return t}createMuteMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}filterTobeUnSubscribedTracks(e,t){const s=[],n=this.remoteUserMap.get(e);if(!n)return s;if(t){const r=n.get(t);if(!r)return s;s.push([e,{kind:t,id:r}])}else Array.from(n.entries()).forEach(r=>{let[i,o]=r;s.push([e,{kind:i,id:o}])});return s}filterTobeUnSubscribedDataChannels(e,t){const s=[];return t.forEach(n=>{var r;(r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.has(n.id)&&s.push(n)}),s}createUnsubscribeMessage(e){const t=[];return e.forEach(s=>{let[n,{kind:r,id:i}]=s;switch(r){case Le.VIDEO:return void(n._videoSSRC&&t.push({stream_type:Le.VIDEO,ssrcId:n._videoSSRC}));case Le.AUDIO:return void(n._audioSSRC&&t.push({stream_type:Le.AUDIO,ssrcId:n._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach(s=>{let[n,{kind:r}]=s;if(t.has(n)){let i=t.get(n);r===Le.VIDEO?i|=bn.Video:i|=bn.Audio,t.set(n,i)}else r===Le.VIDEO?t.set(n,bn.Video):t.set(n,bn.Audio)}),{users:Array.from(t.entries()).map(s=>{let[n,r]=s;return{stream_id:n.uid,stream_type:r}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[s,{kind:n}]=t;const r=this.remoteUserMap.get(s);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(s))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(ve.LocalVideoTrack),s=this.localTrackMap.get(ve.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new Te((n,r)=>{this.handleUpdateVideoEncoder(t.track,n,r,!0)})),s&&e.low_stream_uplink&&(await s.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new Te((n,r)=>{this.handleUpdateVideoEncoder(s.track,n,r,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof Za&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Za)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof Za&&this.connection.isPreRender}mapPubResToRemoteConfig(e,t,s){return e.map((n,r)=>{var i;let{stream_type:o}=n;const c=(i=t.find(l=>{let{stream_type:d}=l;return o===d}))===null||i===void 0?void 0:i.attributes;if(c&&C("DISABLE_SCREEN_SHARE_REMB")){const l=s[r]._hints;(_e(l).call(l,qt.SCREEN_TRACK)||_e(l).call(l,qt.SCREEN_LOW_TRACK))&&(c.remb=!1,b.debug("disable remb for screen share, hints:",l))}return c})}async tryToUnmuteAudio(e){for(let s=0;s<e.length;s++)if(e[s]instanceof Us){var t;const n=this.filterTobeUnmutedTracks(e[s]);if(n.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(n.map(i=>{let[,{id:o}]=i;return o})));const r=this.createUnmuteMessage(n);return void await ls(this,Xe.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Xe.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Xe.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var e;return{connectState:((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await gn(vm(this.dtlsFailedCount,Ys)),this.emit(Xe.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await Qs(this,Xe.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Xe.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(ve.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof os)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof os).length>1)throw new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Us).length>1&&(e.some(t=>t instanceof Us&&t._bypassWebAudio)||!At().webAudioMediaStreamDest))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof os&&this.pendingLocalTracks.some(s=>s instanceof os))throw new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Us&&this.pendingLocalTracks.some(s=>s instanceof Us)&&(!At().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(s=>s instanceof Us&&s._bypassWebAudio)))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){var s;const n=!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding,r=Mi(Mi({},{width:160,height:120,framerate:15,bitrate:50}),t);let i;i=n?e._mediaStreamTrack.clone():ov(e,r);const o=Jt(8,"track-low-"),c=new os(i,Mi(Mi({},n&&{scaleResolutionDownBy:M_(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return c.on(Mc.TRANSCEIVER_UPDATED,l=>{e._updateRtpTransceiver(l,rd.LOW_STREAM)}),c._hints.push(qt.LOW_STREAM),_e(s=e._hints).call(s,qt.SCREEN_TRACK)&&c._hints.push(qt.SCREEN_LOW_TRACK),e.on("sei-to-send",l=>{c.emit("sei-to-send",l)}),e.addListener(Be.NEED_CLOSE,()=>{c.close()}),c}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,s){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Za){var r,i,o,c;const l=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:h,peerConnectionState:p}=this.connection,{local:m,remote:g}=await this.connection.getSelectedCandidatePair();Ue.pcStats(this.store.sessionId,{startTime:l,eventElapse:e-l||0,iceconnectionsate:d,dtlsstate:h,connectionstate:p,intSucc:t?1:2,error:this._iceError||n||"",selectedLocalCandidateProtocol:(r=m==null?void 0:m.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(i=m.candidateType)!==null&&i!==void 0?i:"",selectedLocalCandidateAddress:"".concat(m.address,":").concat(m.port),selectedRemoteCandidateProtocol:(o=g.protocol)!==null&&o!==void 0?o:"",selectedRemoteCandidateType:(c=g.candidateType)!==null&&c!==void 0?c:"",selectedRemoteCandidateAddress:"".concat(g.address,":").concat(g.port),restartCnt:s,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(e){const t=this.store.keyMetrics,s=t.firstVideoFrameDecoded.find(h=>h.userId===e.uid);if(!s)return;const{isInternalUpload:n,isExternalUpload:r}=s;if(n&&r)return;const{subscribeEnd:i,firstPreRender:o,peerPublishDuration:c,peerPubStatusMs:l}=s;let{firstRender:d=0}=s;if(i&&(d||o)&&c&&l){s.isInternalUpload=!0;const{playEnd:h}=s;h&&(s.isExternalUpload=!0);const{firstPreRender:p=0}=s;d=p||d;const m=e.videoTrack,g={peer:e._uintid,width:(m==null?void 0:m._videoWidth)||0,height:(m==null?void 0:m._videoHeight)||0,ssrc:e._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:c,peerPubStatusMs:l,joinChannelStart:t.joinStart||0,preloadStart:t.preloadStart||0,preloadEnd:t.preloadEnd||0,apStart:t.requestAPStart||0,apEnd:t.requestAPEnd||0,suaEnd:t.requestSUAEnd||0,beforeConnect:t.beforeConnect||0,peerReceiver:t.peerReceiver||0,ice:t.iceConnectionEnd||0,pc:t.peerConnectionEnd||0,signalConnected:t.signalConnected||0,joinReq:t.joinReq||0,joinRes:t.joinRep||0,userJoinNotify:s.userJoinNotify||0,videoAddNotify:s.videoAddNotify||0,subscribeStart:s.subscribeStart||0,subscribeEnd:s.subscribeEnd||0,firstReceived:s.firstReceived||0,firstDecoded:s.firstDecoded||0,firstPreRender:p||0,firstRender:h?Math.max(d,h):Math.max(d,i),playStart:s.playStart||0,playEnd:s.playEnd||0,isPreSub:!(!e._videoSSRC||!this.isPreSubScribe(e._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:GI(this.store),firstReceivedEncodedFrame:s.firstReceivedEncodedFrame||0,frameType:s.frameType||"",rtpTimestamp:s.rtpTimestamp||0,framePayloadType:s.framePayloadType||0,frameDataLength:s.frameDataLength||0,mimeType:s.mimeType||""};Ue.firstXLAPeerFirstVideoFrame(this.store.sessionId,g)}}reportVideoFirstFrameDecoded(e,t,s,n){var r;const i=Array.from(Jn(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===e);if(i){n||this.store.subscribe(i.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,c=o.subscribe.find(l=>l.userId===i.uid&&l.type==="video");Ue.firstRemoteVideoDecode(this.store.sessionId,sn.FIRST_VIDEO_DECODE,Ts.FIRST_VIDEO_DECODE,{peer:i._uintid,videowidth:t,videoheight:s,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:n?1:0,firstFrame:(c==null?void 0:c.firstFrame)||0})}}async remoteMediaSsrcChanged(e,t,s){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const r=n.get(t);if(!r)return!1;const i=await this.connection.getRemoteSSRC(r);return i!==void 0&&i!==s}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:s}]=e;t===ve.LocalVideoLowTrack?s._updateRtpTransceiver(void 0,rd.LOW_STREAM):s._updateRtpTransceiver(void 0)})}},Re(Dt.prototype,"startP2PConnection",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"startP2PConnection"),Dt.prototype),Re(Dt.prototype,"connect",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"connect"),Dt.prototype),Re(Dt.prototype,"updateRemoteRTPCapabilities",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"updateRemoteRTPCapabilities"),Dt.prototype),Re(Dt.prototype,"publishDataChannel",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"publishDataChannel"),Dt.prototype),Re(Dt.prototype,"unpublish",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unpublish"),Dt.prototype),Re(Dt.prototype,"unpublishDataChannel",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unpublishDataChannel"),Dt.prototype),Re(Dt.prototype,"unpublishLowStream",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unpublishLowStream"),Dt.prototype),Re(Dt.prototype,"subscribeDataChannel",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"subscribeDataChannel"),Dt.prototype),Re(Dt.prototype,"subscribe",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"subscribe"),Dt.prototype),Re(Dt.prototype,"massSubscribe",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"massSubscribe"),Dt.prototype),Re(Dt.prototype,"unsubscribe",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unsubscribe"),Dt.prototype),Re(Dt.prototype,"unsubscribeDataChannel",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unsubscribeDataChannel"),Dt.prototype),Re(Dt.prototype,"massUnsubscribe",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"massUnsubscribe"),Dt.prototype),Re(Dt.prototype,"muteRemote",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"muteRemote"),Dt.prototype),Re(Dt.prototype,"unmuteRemote",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"unmuteRemote"),Dt.prototype),Re(Dt.prototype,"hasRemoteMediaWithLock",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"hasRemoteMediaWithLock"),Dt.prototype),Re(Dt.prototype,"disconnectForReconnect",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"disconnectForReconnect"),Dt.prototype),Re(Dt.prototype,"updateBitrateLimit",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"updateBitrateLimit"),Dt.prototype),Re(Dt.prototype,"remoteMediaSsrcChanged",[ta],Object.getOwnPropertyDescriptor(Dt.prototype,"remoteMediaSsrcChanged"),Dt.prototype),Dt);function ta(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("From P2PChannel.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}function yk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function wk(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?yk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):yk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const bK=Date.now(),_K=20,dv=new Map,xf=new Map;async function Sk(e){const t=dv.get(e),s=Array.isArray(t)&&t[t.length-1],n=xf.get(e);if(!s)return void(n.isSyncing=!1);const r={uid:s.uid,payload:s.payload};n.firstRecvTs===0&&(n.firstRecvTs=s.recvTs,n.firstSendTs=s.sendTs);const i=s.sendTs-n.firstSendTs,o=i-(Date.now()-n.firstRecvTs);o>0&&(n.firstRecvTs=Date.now()-i);let c=s.mediaDelay+o;c<=0?(t.pop(),Nk(s.context,r),c=0):c=Math.min(c,_K),setTimeout(()=>t.length&&Sk(e),c)}function Nk(e,t){e.safeEmit(St.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function vK(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return Nk(s,{uid:e.uid,payload:e.payload});const n="".concat(s.id,"-").concat(e.uid),r=dv.get(n)||[],i=r.findIndex(d=>e.sendTs>=d.sendTs),o=wk(wk({},e),{},{context:s,mediaDelay:t,recvTs:Date.now()});i===-1?r.push(o):r.splice(i,0,o),dv.set(n,r);let c=!1;var l;xf.has(n)?c=!((l=xf.get(n))===null||l===void 0||!l.isSyncing):xf.set(n,{isSyncing:c,firstRecvTs:0,firstSendTs:0}),c||Sk(n)}const EK=Ft().name;function Tk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Rk(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?Tk(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Tk(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const Rd="websdk_ng_cache_parameter",yK=C("MAX_PRELOAD_ASYNC_LENGTH"),wK=1e4,Jc=new Map,$c=[];let uv=null,hv=0,pv=0;const bf=new Map,Ck=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),SK=function(e,t){const s=[];let n=0;const r=async()=>{const i=s.shift();i&&await i(),s.length>0&&n<t?r():n--};return async function(){for(var i=arguments.length,o=new Array(i),c=0;c<i;c++)o[c]=arguments[c];return new Te(async(l,d)=>{s.push(async()=>{try{const h=await e(...o);l(h)}catch(h){d(h)}}),n<t&&(n++,r())})}}(fv,yK),mv=ba.CancelToken.source();class NK{constructor(){N(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const t=this._audioContext.sampleRate,s=10*t,n=this._audioContext.createBuffer(2,s,t),r=this._audioContext.createBufferSource();r.buffer=n;const i=this._audioContext.createMediaStreamDestination();return r.connect(i),r.start(),i.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function fv(e,t,s,n,r,i,o){try{if(!C("ENABLE_PRELOAD"))return;if(!At().supportWebCrypto)return void Vo(()=>{b.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!s&&s!==null)throw new se(A.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&An(s,"token",1,2047),An(e,"appid",1,2047),Km(t),n&&Ym(n);const c=kc();b.debug("preload channel ".concat(t,", uid is ").concat(n));const l={appId:e,cname:t,token:s||e,uid:typeof n!="string"?n:null,sid:c,proxyServer:r,role:o};let d,h;typeof n=="string"?(l.stringUid=n,[h,d]=await Te.all([iK(n,{sid:c,appId:e},mv.token),QD(Rk(Rk({},l),{},{token:s||e,uid:0}),mv.token)]),l.uid=h.uid,d.gatewayInfo.uid=l.uid,d.gatewayInfo.res.uid=l.uid):(i&&(l.stringUid=i),d=await QD(l,mv.token));const p={sid:c,appId:e,cname:t,token:s||e,uid:l.stringUid||n,intUid:l.uid||d.gatewayInfo.uid,stringUid:l.stringUid,ts:Date.now(),sua:h,ap:d};await xv(p),hv++}catch(c){throw pv++,function(l){uv||(uv=window.setTimeout(()=>{let h="";bf.forEach((p,m)=>{h+="".concat(m,": ").concat(p," ;")}),Ue.reportApiInvoke(null,{name:Ns.PRELOAD,options:{success:hv,failed:pv,err:h}}).onError(l),hv=0,pv=0,bf.clear(),uv=null},wK));const d=bf.get(l.code)||0;bf.set(l.code,d+1)}(c),c}}async function gv(e){try{if(C("AP_REQUEST_DETAIL")||C("ENABLE_ROLE_SELECT_EDGE"))return;const t=Ik(e);if(!t||e.cloudProxyServer!=="disabled")return;const s=await async function(n,r){try{const i=await window.crypto.subtle.importKey("raw",gI(r),"AES-GCM",!1,["decrypt"]),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:Ck},i,Dc(n));return JSON.parse(window.atob(Fo(new Uint8Array(o))))}catch{return}}(t,e.token||e.appId);if(!s||!function(n,r){return n.cname===r.cname&&n.appId===r.appId&&n.token===r.token?r.stringUid?n.stringUid===r.stringUid:typeof r.uid=="number"?n.uid===r.uid:n.uid==r.uid:!1}(s,e))return;if(s&&Date.now()-s.ts<C("AP_CACHE_LIFETIME"))return s}catch(t){b.warn("Error get preloadInfo",t.message)}}function Ik(e){let t;try{if(t=Dk(Rd),!t)return;const s=JSON.parse(t),n=kk(e),r=function(o,c){for(let l=o.length-1;l>=0;l--)if(c(o[l]))return l;return-1}(s,o=>n in o);if(r===-1)return;const i=s.splice(r,1)[0];return _f(Rd,JSON.stringify(s)),i[n]}catch(s){b.warn("Error delete preload info: ".concat(t),s.message),_f(Rd,"")}}async function xv(e){let t;try{e.uid&&Ik({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const s=kk(e),n=await async function(i,o){try{const c=await window.crypto.subtle.importKey("raw",gI(o),"AES-GCM",!1,["encrypt"]),l=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:Ck},c,Dc(window.btoa(JSON.stringify(i))));return Fo(new Uint8Array(l))}catch{return}}(e,e.token||e.appId);if(!n)return;t=Dk(Rd);const r=t?JSON.parse(t):[];r.push({[s]:n}),r.length>C("AP_CACHE_NUM")&&r.shift(),_f(Rd,JSON.stringify(r))}catch(s){b.warn("Error caching server parameters:",s.message),_f(Rd,"")}}function bv(e){if(e){let t=Jc.get(e);t&&(window.clearTimeout(t),t=null,Jc.delete(e)),_e($c).call($c,e)||e.cloudProxyServer!=="disabled"||$c.push(e)}if(Jc.size<C("AP_CACHE_NUM")&&$c.length>0){const t=$c.shift();Jc.set(t,window.setTimeout(async()=>{const{appId:s,cname:n,token:r,stringUid:i,uid:o,proxyServer:c,role:l}=t;try{await SK(s,n,r,o,c,i,l),Jc.has(t)&&bv(t)}catch(d){b.warn("update preload failed",d.message),Ak(t)}},C("AP_UPDATE_INTERVAL")))}}function Ak(e){const t=$c.indexOf(e);t!==-1&&$c.splice(t,1);let s=Jc.get(e);s&&(window.clearTimeout(s),s=null,Jc.delete(e),bv())}function Ok(e,t){const s=e.sua,n=e.ap;t&&s&&Ue.reqUserAccount(e.sid,{lts:s.requestTime,elapse:s.elapse,success:!0,serverAddr:s.url,stringUid:t,uid:e.intUid,errorCode:null,extend:s.req}),Ue.reportResourceTiming(e.ap.url,e.sid),Ue.joinWebProxyAP(e.sid,{lts:n.requestTime,elapse:n.elapse,sucess:1,apServerAddr:n.url,turnServerAddrList:n.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[qs.CHOOSE_SERVER,qs.CLOUD_PROXY_FALLBACK].toString()}),Ue.joinChooseServer(e.sid,{lts:n.requestTime,elapse:n.elapse,succ:!0,csAddr:n.url,opid:n.opid,serverList:n.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:n.gatewayInfo.cid.toString(),uid:n.gatewayInfo.uid.toString(),csIp:n.gatewayInfo.csIp,unilbsServerIds:[qs.CHOOSE_SERVER].toString(),isHttp3:n.isHttp3})}function Dk(e){return window.atob(window.localStorage.getItem(e)||"")}function _f(e,t){window.localStorage.setItem(e,window.btoa(t))}function kk(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),wI(t)}function TK(e){let t=function(){const s=IK.pop();return s?(s.offset=s.limit=0,s):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(s,n){let r=s.appId;r!==void 0&&(Xs(n,10),Xo(n,r));let i=s.cid;i!==void 0&&(Xs(n,16),Xs(n,i));let o=s.cname;o!==void 0&&(Xs(n,26),Xo(n,o));let c=s.deviceId;c!==void 0&&(Xs(n,34),Xo(n,c));let l=s.elapse;l!==void 0&&(Xs(n,40),Jo(n,l));let d=s.fileSize;d!==void 0&&(Xs(n,48),Jo(n,Cd(d)));let h=s.height;h!==void 0&&(Xs(n,56),Jo(n,Cd(h)));let p=s.jpg;p!==void 0&&(Xs(n,66),Xs(n,p.length),Pk(n,p));let m=s.networkType;m!==void 0&&(Xs(n,72),Jo(n,Cd(m)));let g=s.osType;g!==void 0&&(Xs(n,80),Jo(n,Cd(g)));let T=s.requestId;T!==void 0&&(Xs(n,90),Xo(n,T));let w=s.sdkVersion;w!==void 0&&(Xs(n,98),Xo(n,w));let S=s.sequence;S!==void 0&&(Xs(n,104),Jo(n,Cd(S)));let I=s.sid;I!==void 0&&(Xs(n,114),Xo(n,I));let O=s.timestamp;O!==void 0&&(Xs(n,120),Jo(n,O));let M=s.uid;M!==void 0&&(Xs(n,128),Xs(n,M));let z=s.vid;z!==void 0&&(Xs(n,136),Xs(n,z));let K=s.width;K!==void 0&&(Xs(n,144),Jo(n,Cd(K)));let V=s.service;V!==void 0&&(Xs(n,152),Xs(n,V));let Y=s.callbackData;Y!==void 0&&(Xs(n,162),Xs(n,Y.length),Pk(n,Y));let ce=s.ticket;ce!==void 0&&(Xs(n,170),Xo(n,ce));let xe=s.vendorConfigs;xe!==void 0&&(Xs(n,178),Xo(n,xe))}(e,t),function(s){let n=s.bytes,r=s.limit;return n.length===r?n:n.subarray(0,r)}(t)}function RK(e){return function(s){let n={};e:for(;!AK(s);){let r=rh(s);switch(r>>>3){case 0:break e;case 1:n.code=rh(s);break;case 2:n.msg=Lk(s,rh(s));break;case 3:n.requestId=Lk(s,rh(s));break;case 4:n.timestamp=OK(s,!1);break;default:CK(s,7&r)}}return n}({bytes:t=e,offset:0,limit:t.length});var t}function CK(e,t){switch(t){case 0:for(;128&Fr(e););break;case 2:_v(e,rh(e));break;case 5:_v(e,4);break;case 1:_v(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Cd(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let IK=[];function _v(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function AK(e){return e.offset>=e.limit}function vf(e,t){let s=e.bytes,n=e.offset,r=e.limit,i=n+t;if(i>s.length){let o=new Uint8Array(2*i);o.set(s),e.bytes=o}return e.offset=i,i>r&&(e.limit=i),n}function jk(e,t){let s=e.offset;if(s+t>e.limit)throw new Error("Read past limit");return e.offset+=t,s}function Pk(e,t){let s=vf(e,t.length);e.bytes.set(t,s)}function Lk(e,t){let s=jk(e,t),n=String.fromCharCode,r=e.bytes,i="",o="";for(let c=0;c<t;c++){let l,d,h,p,m=r[c+s];128&m?(224&m)==192?c+1>=t?o+=i:(l=r[c+s+1],(192&l)!=128?o+=i:(p=(31&m)<<6|63&l,p<128?o+=i:(o+=n(p),c++))):(240&m)==224?c+2>=t?o+=i:(l=r[c+s+1],d=r[c+s+2],(49344&(l|d<<8))!=32896?o+=i:(p=(15&m)<<12|(63&l)<<6|63&d,p<2048||p>=55296&&p<=57343?o+=i:(o+=n(p),c+=2))):(248&m)==240?c+3>=t?o+=i:(l=r[c+s+1],d=r[c+s+2],h=r[c+s+3],(12632256&(l|d<<8|h<<16))!=8421504?o+=i:(p=(7&m)<<18|(63&l)<<12|(63&d)<<6|63&h,p<65536||p>1114111?o+=i:(p-=65536,o+=n(55296+(p>>10),56320+(1023&p)),c+=3))):o+=i:o+=n(m)}return o}function Xo(e,t){let s=t.length,n=0;for(let o=0;o<s;o++){let c=t.charCodeAt(o);c>=55296&&c<=56319&&o+1<s&&(c=(c<<10)+t.charCodeAt(++o)-56613888),n+=c<128?1:c<2048?2:c<65536?3:4}Xs(e,n);let r=vf(e,n),i=e.bytes;for(let o=0;o<s;o++){let c=t.charCodeAt(o);c>=55296&&c<=56319&&o+1<s&&(c=(c<<10)+t.charCodeAt(++o)-56613888),c<128?i[r++]=c:(c<2048?i[r++]=c>>6&31|192:(c<65536?i[r++]=c>>12&15|224:(i[r++]=c>>18&7|240,i[r++]=c>>12&63|128),i[r++]=c>>6&63|128),i[r++]=63&c|128)}}function Fr(e){return e.bytes[jk(e,1)]}function Mk(e,t){let s=vf(e,1);e.bytes[s]=t}function rh(e){let t,s=0,n=0;do t=Fr(e),s<32&&(n|=(127&t)<<s),s+=7;while(128&t);return n}function Xs(e,t){for(t>>>=0;t>=128;)Mk(e,127&t|128),t>>>=7;Mk(e,t)}function OK(e,t){let s,n=0,r=0,i=0;return s=Fr(e),n=127&s,128&s&&(s=Fr(e),n|=(127&s)<<7,128&s&&(s=Fr(e),n|=(127&s)<<14,128&s&&(s=Fr(e),n|=(127&s)<<21,128&s&&(s=Fr(e),r=127&s,128&s&&(s=Fr(e),r|=(127&s)<<7,128&s&&(s=Fr(e),r|=(127&s)<<14,128&s&&(s=Fr(e),r|=(127&s)<<21,128&s&&(s=Fr(e),i=127&s,128&s&&(s=Fr(e),i|=(127&s)<<7))))))))),{low:n|r<<28,high:r>>>4|i<<24,unsigned:t}}function Jo(e,t){let s=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,i=r===0?n===0?s<16384?s<128?1:2:s<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,o=vf(e,i),c=e.bytes;switch(i){case 10:c[o+9]=r>>>7&1;case 9:c[o+8]=i!==9?128|r:127&r;case 8:c[o+7]=i!==8?n>>>21|128:n>>>21&127;case 7:c[o+6]=i!==7?n>>>14|128:n>>>14&127;case 6:c[o+5]=i!==6?n>>>7|128:n>>>7&127;case 5:c[o+4]=i!==5?128|n:127&n;case 4:c[o+3]=i!==4?s>>>21|128:s>>>21&127;case 3:c[o+2]=i!==3?s>>>14|128:s>>>14&127;case 2:c[o+1]=i!==2?s>>>7|128:s>>>7&127;case 1:c[o]=i!==1?128|s:127&s}}const Uk={},Vk={},Ef=4294967296,DK=Ef*Ef,Fk=DK/2;Gk(0,!0);const Bk=Gk(0),kK=ih(0,-2147483648,!1),jK=ih(-1,2147483647,!1);function Gk(e,t){let s,n,r;return t?(r=0<=(e>>>=0)&&e<256)&&(n=Vk[e],n)?n:(s=ih(e,0,!0),r&&(Vk[e]=s),s):(r=-128<=(e|=0)&&e<128)&&(n=Uk[e],n)?n:(s=ih(e,e<0?-1:0,!1),r&&(Uk[e]=s),s)}function ih(e,t,s){return{low:0|e,high:0|t,unsigned:!!s}}function Wk(e,t){if(isNaN(e))return Bk;{if(e<=-Fk)return kK;if(e+1>=Fk)return jK}return e<0?Bk:ih(e%Ef|0,e/Ef|0,t)}function Hk(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}class vv extends Cs{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const s=this._connectionState;this._connectionState=t,this.emit(oi.CONNECTION_STATE_CHANGE,t,s)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var s;super(),N(this,"name","AgoraRTCImageModeration"),N(this,"_connectionState",mr.CONNECTING),N(this,"_sequence",0),N(this,"_moderationStartTime",void 0),N(this,"_workerConnection",void 0),N(this,"_workerMessageLengthLimit",void 0),N(this,"_qualityRatio",void 0),N(this,"_connectInfo",void 0),N(this,"_cancelTokenSource",ba.CancelToken.source()),N(this,"_retryConfig",void 0),N(this,"_moderationInterval",void 0),N(this,"_moderationTimer",null),N(this,"_moderationMode",1),N(this,"_quality",1),N(this,"_qualityTimer",null),N(this,"_ticket",void 0),N(this,"_moderationIntervalMinimum",void 0),N(this,"_uploadFailedNum",0),N(this,"_uploadNum",0),N(this,"_uploadTimer",null),N(this,"_extraInfo",void 0),N(this,"_vendor",""),N(this,"_encoder",new TextEncoder),N(this,"_moderationId",void 0),N(this,"inspectImage",()=>{if(this.connectionState!==mr.CONNECTED)throw new $(A.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===mr.CONNECTED?this.requestToInspectImage():b.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Jt(5,"image-moderation-"),this._workerMessageLengthLimit=C("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=C("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(s=t.interval)!==null&&s!==void 0?s:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=C("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Yu("worker-"+this._moderationId,Ys),this.on(oi.STATE_CHANGE,(n,r)=>{b.debug("[".concat(this._moderationId,"] Moderation operation :").concat(gd[n]," ").concat(r||""))}),this.handleWorkerEvents()}async init(t,s){this.emit(oi.STATE_CHANGE,gd.CONNECT_AP),this._connectInfo=t;const n=this._cancelTokenSource.token;return this._retryConfig=s,new Te((r,i)=>{this.on(oi.CONNECTION_STATE_CHANGE,(o,c)=>{o===mr.CONNECTED&&r()}),this.requestAP(t,n,s).then(o=>{this.connectWorker(o)}).catch(o=>{i(o)})})}updateConfig(t){var s;this._moderationInterval=(s=t.interval)!==null&&s!==void 0?s:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),b.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===mr.CONNECTED&&this.inspectImage()}async requestAP(t,s,n){const r=C("WEBCS_DOMAIN").map(l=>"https://".concat(l,"/api/v1")),i=await function(l,d,h,p){let{appId:m,areaCode:g,cname:T,sid:w,token:S,uid:I}=d;Ed++;const O="moderation_plugin",M={service_name:O,json_body:JSON.stringify({appId:m,areaCode:g,cname:T,command:"allocateEdge",requestId:Ed,seq:Ed,sid:w,appToken:S,ts:Date.now(),uid:I+""})};let z,K,V=l[0];return ni(async()=>{z=Date.now();const Y=await li(V,{data:M,cancelToken:h,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(K=Date.now()-z,Y.code!==0){const at=new $(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+Y.code,{retry:!0,responseTime:K});throw b.error(at.toString()),at}const ce=JSON.parse(Y.json_body);if(ce.code!==200){const at=new $(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(ce.code,", reason: ").concat(ce.reason),{code:ce.code,responseTime:K});throw b.error(at.toString()),at}if(!ce.servers||!Array.isArray(ce.servers)||ce.servers.length===0){const at=new $(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:ce.code,responseTime:K});throw b.error(at.toString()),at}if(!ce.servers.some(at=>!!at.wss)){const at=new $(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:ce.code,responseTime:K});throw b.error(at.toString()),at}const xe=C("IMAGE_MODERATION_WORKER_WSS");if(xe)return{addressList:[xe],workerToken:ce.workerToken,vid:ce.vid,responseTime:K};const ke=C("IMAGE_MODERATION_WORKER_HOST");return{addressList:ce.servers.map(at=>{let{address:Et,wss:xt}=at;if(Et&&xt)return"wss://".concat(Et.replace(/\./g,"-"),".").concat(ke,":").concat(xt,"/moderation")}).filter(at=>!!at),workerToken:ce.workerToken,vid:ce.vid,ticket:ce.appTicket,responseTime:K}},(Y,ce)=>(Ue.apworkerEvent(w,{success:!0,sc:200,serviceName:O,responseDetail:JSON.stringify(Y.addressList),firstSuccess:ce===0,responseTime:K,serverIp:l[ce%l.length]}),!1),(Y,ce)=>(Ue.apworkerEvent(w,{success:!1,sc:Y.data&&Y.data.code||200,serviceName:O,responseTime:K,serverIp:l[ce%l.length]}),!!(Y.code!==A.OPERATION_ABORTED&&Y.code!==A.UNEXPECTED_RESPONSE||Y.data&&Y.data.retry)&&(V=l[(ce+1)%l.length],!0)),p)}(r,t,s,n);this.emit(oi.STATE_CHANGE,gd.AP_CONNECTED);const{addressList:o,ticket:c}=i;return this._ticket=c,o}async connectWorker(t){this.emit(oi.STATE_CHANGE,gd.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(bt.CONNECTED,async()=>{this.emit(oi.STATE_CHANGE,gd.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=mr.CONNECTED}),this._workerConnection.on(bt.CLOSED,()=>{this.connectionState=mr.CLOSED}),this._workerConnection.on(bt.FAILED,()=>{this.connectionState=mr.CLOSED}),this._workerConnection.on(bt.RECONNECTING,()=>{this.connectionState=this.connectionState===mr.CONNECTED?mr.RECONNECTING:mr.CONNECTING}),this._workerConnection.on(bt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const s=RK(new Uint8Array(t.data));C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&b.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(s)),this._uploadNum++,s.code===void 0||s.code===0||(this._uploadFailedNum++,b.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(s.code,", msg is ").concat(s.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{Ue.reportApiInvoke(this._connectInfo.sid||null,{name:Ns.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,s.code],tag:is.TRACER}).onError(new $(A.IMAGE_MODERATION_UPLOAD_FAILED,s.msg)),this._uploadTimer=null},C("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else b.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(bt.WILL_RECONNECT,(t,s,n)=>{t==="recover"&&n(t),n("tryNext")}),this._workerConnection.on(bt.REQUEST_NEW_URLS,(t,s)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(s)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=Ua(this,oi.CLIENT_LOCAL_VIDEO_TRACK),s={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&b.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(t,s);this._workerConnection.sendMessage(n,!0,!0)}else C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&b.debug("Only the track being published can be inspected")}async generateRequestData(t,s){let{appId:n,cname:r,cid:i,vid:o,sid:c,uid:l}=s;const d=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),p=await mA(h,n,r),m=this._sequence+"-"+i+"-"+l+"-"+d+"-"+Jt(12,""),g={appId:n,cid:i,cname:r,deviceId:"",elapse:vv.intToLong(Number(d-this._moderationStartTime)),fileSize:h.buffer.byteLength,height:h.height,width:h.width,jpg:p,networkType:6,osType:7,requestId:m,sdkVersion:"4.24.2",sequence:this._sequence,sid:c,timestamp:Wk(d),uid:l,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete g.callbackData;const T=TK(g);if(T.byteLength<this._workerMessageLengthLimit){if(C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const w=function(S){for(var I=1;I<arguments.length;I++){var O=arguments[I]!=null?arguments[I]:{};I%2?Hk(Object(O),!0).forEach(function(M){N(S,M,O[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(S,Object.getOwnPropertyDescriptors(O)):Hk(Object(O)).forEach(function(M){Object.defineProperty(S,M,Object.getOwnPropertyDescriptor(O,M))})}return S}({},g);delete w.jpg,b.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(w))}return T}{const w=this.quality*this._qualityRatio;return this.quality=w,await this.generateRequestData(t,{appId:n,cname:r,cid:i,vid:o,sid:c,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ba.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=mr.CLOSED,this.emit(oi.STATE_CHANGE,gd.CLOSED)}}function zk(e){if(rs(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new $(A.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new $(A.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const PK={name:"ImageModeration",create:function(e){let{config:t}=e;return zk(t),new vv(t)}};var Kk,Yk,qk,Xk,Jk,$k,Qk,Zk,ej,tj,sj,nj,aj,rj,ij,oj,cj,lj,dj,uj,hj,pj,mj,fj,gj,xj,bj,_j,vj,Ej,yj,wj,Sj,Nj,Tj,Rj,Cj,Ij,Aj,Oj,Dj,kj,Pe;function jj(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Br(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?jj(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):jj(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}wn.setLogger(b);let LK=(Kk=tt(),Yk=tt({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof cd))return[t];t=[t]}return t.map(s=>s?Object(s).toString():"null")}}),qk=tt({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==od.DATA?(Array.isArray(t)||(t=[t]),t.map(s=>s.getTrackId())):[t.getChannelId()])}),Xk=tt({argsMap:(e,t,s,n)=>[typeof t=="object"?t.uid:t,s,n]}),Jk=tt({argsMap:(e,t,s)=>[t,s]}),$k=tt({argsMap:(e,t)=>t.map(s=>{let{user:n,mediaType:r}=s;return[n==null?void 0:n.uid,r]})}),Qk=tt({argsMap:(e,t,s,n)=>[typeof t=="object"?t.uid:t,s,n]}),Zk=tt({argsMap:(e,t)=>t.map(s=>{let{user:n,mediaType:r}=s;return{uid:n==null?void 0:n.uid,mediaType:r}})}),ej=tt(),tj=tt(),sj=tt(),nj=tt(),aj=tt(),rj=tt(),ij=tt(),oj=tt(),cj=tt(),lj=tt(),dj=tt(),uj=tt(),hj=tt(),pj=tt(),mj=tt(),fj=tt(),gj=tt({argsMap:(e,t)=>[t]}),xj=tt(),bj=tt(),_j=tt(),vj=tt(),Ej=tt(),yj=tt(),wj=tt(),Sj=tt(),Nj=tt({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),Tj=tt(),Rj=tt(),Cj=tt(),Ij=tt(),Aj=tt(),Oj=tt(),Dj=tt({reportResult:!0}),kj=tt(),Pe=class extends Cs{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e,t){let s;if(super(),N(this,"store",void 0),N(this,"_uid",void 0),N(this,"_channelName",void 0),N(this,"_uintUid",void 0),N(this,"_users",[]),N(this,"_config",void 0),N(this,"_clientId",void 0),N(this,"_appId",void 0),N(this,"_sessionId",null),N(this,"_key",void 0),N(this,"_rtmConfig",{}),N(this,"_joinInfo",void 0),N(this,"_gateway",void 0),N(this,"_statsCollector",void 0),N(this,"_configDistribute",void 0),N(this,"_leaveMutex",void 0),N(this,"_publishMutex",void 0),N(this,"_renewTokenMutex",void 0),N(this,"_subscribeMutex",void 0),N(this,"_encryptionMode","none"),N(this,"_encryptionSecret",null),N(this,"_encryptionSalt",null),N(this,"_encryptDataStream",!1),N(this,"_encryptDataStreamKey",null),N(this,"_encryptDataStreamIv",null),N(this,"_proxyServer",void 0),N(this,"_turnServer",{servers:[],mode:"auto"}),N(this,"_cloudProxyServerMode","disabled"),N(this,"_isDualStreamEnabled",!1),N(this,"_defaultStreamFallbackType",void 0),N(this,"_lowStreamParameter",void 0),N(this,"_streamFallbackTypeCacheMap",new Map),N(this,"_remoteStreamTypeCacheMap",new Map),N(this,"_axiosCancelSource",ba.CancelToken.source()),N(this,"_audioVolumeIndicationInterval",void 0),N(this,"_networkQualityInterval",void 0),N(this,"_userOfflineTimeout",void 0),N(this,"_streamRemovedTimeout",void 0),N(this,"_rteDetailInterval",void 0),N(this,"_liveTranscodeStreamingClient",void 0),N(this,"_liveRawStreamingClient",void 0),N(this,"_channelMediaRelayClient",void 0),N(this,"_networkQualitySensitivity","normal"),N(this,"_p2pChannel",void 0),N(this,"_useLocalAccessPoint",!1),N(this,"_setLocalAPVersion",void 0),N(this,"_joinAndNotLeaveYet",!1),N(this,"_numberOfJoinCount",0),N(this,"_joinResponse",null),N(this,"_remoteDefaultVideoStreamType",void 0),N(this,"_inspect",void 0),N(this,"_moderation",void 0),N(this,"_license",void 0),N(this,"_pendingPublishedUsers",[]),N(this,"ntpAlignErrorCount",0),N(this,"remoteInboundOffset",0),N(this,"_peerConnectionState",void 0),N(this,"_pendingRtpCapabilityChange",void 0),N(this,"_fallbackServerInfo",void 0),N(this,"_dualStreamMode",void 0),N(this,"_handleLocalTrackEnable",(r,i,o)=>{this.publish(r,!1).then(i).catch(o)}),N(this,"_handleLocalTrackDisable",(r,i,o)=>{this.unpublish(r).then(i).catch(o)}),N(this,"_handleUserOnline",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(r.uid,this.channelName))return void b.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&b.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find(o=>o.uid===r.uid);if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(St.USER_JOINED,i));else{const o=new Yo(r.uid,r.uint_id||r.uid);this._users.push(o),b.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(o.uid,{userJoinNotify:Date.now()}),this.safeEmit(St.USER_JOINED,o)}}),N(this,"_handleUserOffline",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(r.uid,this.channelName))return;const i=this._users.find(o=>o.uid===r.uid);i&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:bm(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),b.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(St.USER_LEAVED,i,r.reason))}),N(this,"_handleAddAudioOrVideoStream",(r,i,o,c,l,d,h,p)=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(i,this.channelName))return;const m=this._users.find(w=>w.uid===i);if(!m)return void b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));b.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(r)),this.store.subscribe(m.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(m.uid,{videoAddNotify:Date.now()});const g=r==="audio"?m.hasAudio:m.hasVideo;m._uintid||(m._uintid=d||i),r==="audio"?m._trust_audio_stream_added_state_=!0:m._trust_video_stream_added_state_=!0,r==="audio"?(m._audio_added_=!0,o!==void 0&&(m._audioSSRC=o),c!==void 0&&(m._cname=c),h&&(m._audioOrtc=h)):(m._video_added_=!0,o!==void 0&&(m._videoSSRC=o),c!==void 0&&(m._cname=c),p!==void 0&&(m._rtxSsrcId=p),h&&(m._videoOrtc=h)),(r==="audio"?m.hasAudio:m.hasVideo)&&!g&&(b.info("[".concat(this._clientId,"] remote user ").concat(m.uid," published ").concat(r)),this.safeEmit(St.USER_PUBLISHED,m,r)),r==="video"?Ue.onGatewayStream(this._sessionId,sn.ON_ADD_VIDEO_STREAM,Ts.ON_ADD_VIDEO_STREAM,{peer:d||i,ssrc:m._videoSSRC}):Ue.onGatewayStream(this._sessionId,sn.ON_ADD_AUDIO_STREAM,Ts.ON_ADD_AUDIO_STREAM,{peer:d||i,ssrc:m._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(m,r,o).then(w=>{if(w&&(b.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(m.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Xc))return this._p2pChannel.unsubscribe(m,r,!0).then(()=>this._subscribe(m,r,!0).catch(S=>{b.error("[".concat(this._clientId,"] resubscribe error"),S.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(m,r)&&(b.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(m.uid," after reconnect.")),this._subscribe(m,r,!0).catch(w=>{b.error("[".concat(this._clientId,"] resubscribe error"),w.toString())}));const T=this._getEncodingName(l);r==="video"&&(T==="unknown"?this.safeEmit(St.AV1_DECODABLE_RESULT,!1):yn()||Xn()||(T==null?void 0:T.toLocaleLowerCase())!==Pc.av1||rK().then(w=>{C("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(St.AV1_DECODABLE_RESULT,w),w||this._gateway.downgradeCodec(T)}))}),N(this,"_handleRemoveStream",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(r.uid,this.channelName))return;const i=this._users.find(c=>c.uid===r.uid);if(!i)return void b.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));b.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let o=()=>{};i.hasAudio&&i.hasVideo?o=()=>{b.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(St.USER_UNPUBLISHED,i,"audio"),b.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(St.USER_UNPUBLISHED,i,"video")}:i.hasVideo?o=()=>{b.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(St.USER_UNPUBLISHED,i,"video")}:i.hasAudio&&(o=()=>{b.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(St.USER_UNPUBLISHED,i,"audio")}),i._video_pre_subscribed||i._audio_pre_subscribed||(i._trust_audio_stream_added_state_=!0,i._trust_video_stream_added_state_=!0,i._audio_added_=!1,i._video_added_=!1,this._p2pChannel instanceof Xc&&this._p2pChannel.unsubscribe(i).then(c=>{if(c)return this._gateway.unsubscribe(c,i.uid)}),i._audioSSRC=void 0,i._videoSSRC=void 0,i._audioOrtc=void 0,i._videoOrtc=void 0,i._rtxSsrcId=void 0),Ue.onGatewayStream(this._sessionId,sn.ON_REMOVE_STREAM,Ts.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),o()}),N(this,"_handleSetStreamLocalEnable",(r,i,o)=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(i,this.channelName))return;const c=this._users.find(h=>h.uid===i);if(!c)return void b.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));b.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(o?"enabled":"disabled"," with uid ").concat(i));const l=r==="audio"?c.hasAudio:c.hasVideo;if(r==="audio"){c._trust_audio_enabled_state_=!0;const h=c._audio_enabled_;if(c._audio_enabled_=o,c._audio_enabled_===h)return;{const p=c._audio_enabled_?"enable-local-audio":"disable-local-audio";b.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(p)),this.safeEmit(St.USER_INFO_UPDATED,i,p)}}else{c._trust_video_enabled_state_=!0;const h=c._video_enabled_;if(c._video_enabled_=o,c._video_enabled_===h)return;{const p=c._video_enabled_?"enable-local-video":"disable-local-video";b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(p)),this.safeEmit(St.USER_INFO_UPDATED,i,p)}}const d=r==="audio"?c.hasAudio:c.hasVideo;return l!==d?!l&&d?(b.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(r)),void this.safeEmit(St.USER_PUBLISHED,c,r)):(r==="video"&&c._videoTrack&&c._videoTrack._destroy(),r==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,r),b.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(r)),void this.safeEmit(St.USER_UNPUBLISHED,c,r)):void 0}),N(this,"_handleMuteStream",(r,i,o)=>{if(C("BLOCK_LOCAL_CLIENT")&&Wc(r,this.channelName))return;b.debug("[".concat(this._clientId,"] receive mute message"),r,i,o);const c=this._users.find(h=>h.uid===r);if(!c)return void b.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));const l=i==="audio"?c.hasAudio:c.hasVideo;if(i==="audio"){c._trust_audio_mute_state_=!0;const h=c._audio_muted_;if(c._audio_muted_=o,c._audio_muted_===h)return;{const p=c._audio_muted_?"mute-audio":"unmute-audio";b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(p)),this.safeEmit(St.USER_INFO_UPDATED,r,p)}}else{c._trust_video_mute_state_=!0;const h=c._video_muted_;if(c._video_muted_=o,c._video_muted_===h)return;{const p=c._video_muted_?"mute-video":"unmute-video";b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(p)),this.safeEmit(St.USER_INFO_UPDATED,r,p)}}const d=i==="audio"?c.hasAudio:c.hasVideo;if(l!==d){if(!l&&d)return(i==="audio"?c._audioSSRC:c._videoSSRC)?(b.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(i)),void this.safeEmit(St.USER_PUBLISHED,c,i)):void b.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."));i==="video"&&c._videoTrack&&!c._video_pre_subscribed&&c._videoTrack._destroy(),i==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,i),b.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(i)),this.safeEmit(St.USER_UNPUBLISHED,c,i)}}),N(this,"_handleP2PLost",async r=>{b.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():b.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)}),N(this,"_handleTokenWillExpire",()=>{b.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(St.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),N(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),b.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),N(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(St.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(St.NETWORK_QUALITY,r)}),N(this,"_handleP2PAddAudioOrVideoStream",(r,i,o,c)=>{const l=this._users.find(h=>h.uid===i);if(!l)return void b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));b.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(r)),this.store.subscribe(l.uid,r,void 0,void 0,void 0,Date.now());const d=r==="audio"?l.hasAudio:l.hasVideo;r==="audio"?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,r==="audio"?(l._audio_added_=!0,o!==void 0&&(l._audioSSRC=o),c!==void 0&&(l._audioMid=c)):(l._video_added_=!0,o!==void 0&&(l._videoSSRC=o),c!==void 0&&(l._videoMid=c)),(r==="audio"?l.hasAudio:l.hasVideo)&&!d&&(b.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(r)),this.safeEmit(St.USER_PUBLISHED,l,r)),this._p2pChannel.hasPendingRemoteMedia(l,r)&&(b.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,r,!0).catch(h=>{b.error("[".concat(this._clientId,"] resubscribe error"),h.toString())}))}),this._config=e,this._clientId=t||Jt(5,"client-"),this.store=new class{constructor(r,i,o,c,l){mt(this,"state",void 0),this.state={codec:r,audioCodec:i,mode:o,clientId:c,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:jc.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!l}}dispatch(r){this.state=function(i,o){switch(o.type){case dt.SET_SESSION_ID:return ye(ye({},i),{},{sessionId:o.sessionId});case dt.SET_P2P_ID:return ye(ye({},i),{},{p2pId:o.p2pId});case dt.SET_UID:return ye(ye({},i),{},{uid:o.uid});case dt.SET_INT_UID:return ye(ye({},i),{},{intUid:o.intUid});case dt.SET_PUB_ID:return ye(ye({},i),{},{pubId:o.pubId});case dt.KEY_METRIC_CLIENT_CREATED:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{clientCreated:o.metric})});case dt.KEY_METRIC_JOIN_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinStart:o.metric})});case dt.KEY_METRIC_PRELOAD_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{preloadStart:o.metric})});case dt.KEY_METRIC_PRELOAD_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{preloadEnd:o.metric})});case dt.KEY_METRIC_JOIN_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinEnd:o.metric})});case dt.KEY_METRIC_REQUEST_AP_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{requestAPStart:o.metric})});case dt.KEY_METRIC_REQUEST_AP_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{requestAPEnd:o.metric})});case dt.KEY_METRIC_REQUEST_SUA_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{requestSUAEnd:o.metric})});case dt.KEY_METRIC_BEFORE_CONNECT:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{beforeConnect:o.metric})});case dt.KEY_METRIC_PEER_RECEIVER:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{peerReceiver:o.metric})});case dt.KEY_METRIC_SIGNAL_CONNECTED:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{signalConnected:o.metric})});case dt.KEY_METRIC_JOIN_REQ:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinReq:o.metric})});case dt.KEY_METRIC_JOIN_REP:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinRep:o.metric})});case dt.KEY_METRIC_JOIN_GATEWAY_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinGatewayStart:o.metric})});case dt.KEY_METRIC_JOIN_GATEWAY_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{joinGatewayEnd:o.metric})});case dt.KEY_METRIC_PEER_CONNECTION_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{peerConnectionStart:o.metric})});case dt.KEY_METRIC_PEER_CONNECTION_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{peerConnectionEnd:o.metric})});case dt.KEY_METRIC_DESCRIPTION_START:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{descriptionStart:o.metric})});case dt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{signalChannelOpen:o.metric})});case dt.KEY_METRIC_ICE_CONNECTION_END:return ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{iceConnectionEnd:o.metric})});case dt.KEY_METRIC_PUBLISH:{const c=i.keyMetrics.publish,l=c.findIndex(d=>d.trackId===o.metric.trackId);return l!==-1?(c[l]=ye(ye({},c[l]),o.metric),ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{publish:[...c]})})):ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{publish:[...i.keyMetrics.publish,o.metric]})})}case dt.KEY_METRIC_SUBSCRIBE:{const c=i.keyMetrics.subscribe,l=c.findIndex(d=>d.userId===o.metric.userId&&d.type===o.metric.type);return l!==-1?(c[l]=ye(ye({},c[l]),o.metric),ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{subscribe:[...c]})})):ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{subscribe:[...i.keyMetrics.subscribe,o.metric]})})}case dt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const c=i.keyMetrics.firstVideoFrameDecoded,l=c.findIndex(d=>d.userId===o.metric.userId);return l!==-1?(c[l]=ye(ye({},c[l]),o.metric),ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{firstVideoFrameDecoded:[...c]})})):ye(ye({},i),{},{keyMetrics:ye(ye({},i.keyMetrics),{},{firstVideoFrameDecoded:[...i.keyMetrics.firstVideoFrameDecoded,o.metric]})})}case dt.RESET_FIRST_VIDEO_FRAME_DECODED:return i.keyMetrics.firstVideoFrameDecoded=[],i;case dt.SET_CLOUD_PROXY_SERVER_MODE:return i.cloudProxyServerMode=o.mode,i;case dt.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?i.joinChannelServiceRecords=[...i.joinChannelServiceRecords,o.record]:(i.joinChannelServiceRecords[o.index]=ye(ye({},i.joinChannelServiceRecords[o.index]),o.record),i.joinChannelServiceRecords=[...i.joinChannelServiceRecords]),i;case dt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return i.joinChannelServiceRecords=[],i;case dt.RESET_KEY_METRICS:return i.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},i;case dt.SET_USE_P2P:return ye(ye({},i),{},{useP2P:o.val});case dt.SET_TRANSPORT_TYPE:return ye(ye({},i),{},{p2pTransport:o.val});case dt.SET_RTE_URL:return ye(ye({},i),{},{rteUrl:o.rteUrl});case dt.SET_RTE_SID:return ye(ye({},i),{},{rteSid:o.rteSid});default:return i}}(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:dt.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:dt.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:dt.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:dt.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:dt.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:dt.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:dt.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:dt.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:dt.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:dt.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:dt.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:dt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:dt.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:dt.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:dt.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:dt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:dt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:dt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:dt.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:dt.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:dt.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:dt.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:dt.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:dt.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:dt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:dt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:dt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:dt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,i){this.dispatch({type:dt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:ye({userId:r},i)})}descriptionStart(){this.dispatch({type:dt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:dt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:dt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,i,o,c){this.dispatch({type:dt.KEY_METRIC_PUBLISH,metric:ye(ye({trackId:r,type:i},o&&{publishStart:o}),c&&{publishEnd:c})})}subscribe(r,i,o,c,l,d,h){this.dispatch({type:dt.KEY_METRIC_SUBSCRIBE,metric:ye(ye(ye(ye(ye({userId:r,type:i},o&&{subscribeStart:o}),c&&{subscribeEnd:c}),l&&{firstFrame:l}),d&&{streamAdded:d}),h&&{firstDecoded:h})})}massSubscribe(r,i,o,c){r.forEach(l=>{this.dispatch({type:dt.KEY_METRIC_SUBSCRIBE,metric:ye(ye(ye({userId:l.userId,type:l.type},i&&{subscribeStart:i}),o&&{subscribeEnd:o}),c&&{firstFrame:c})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,i){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map(o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof i!="number"?(this.dispatch({type:dt.RECORD_JOIN_CHANNEL_SERVICE,record:ye(ye({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(i<0||i>=this.state.joinChannelServiceRecords.length||this.dispatch({type:dt.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:i}),i)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:dt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:dt.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:dt.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(e.codec,e.audioCodec,e.mode,this._clientId,C("SIGNAL_CHANNEL")===1),this._leaveMutex=new wn("client-leave",this._clientId),this._publishMutex=new wn("client-publish",this._clientId),this._renewTokenMutex=new wn("client-renewtoken",this._clientId),this._subscribeMutex=new wn("client-subscribe",this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),b.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(lr," build: ").concat(Xb,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{jb(e.clientRoleOptions),s=Object.assign({},e.clientRoleOptions)}catch(r){b.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var n;this._statsCollector=new sh(this.store),this._statsCollector.onStatsException=(r,i,o)=>{b.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(i,", uid: ").concat(o)),r===Z_.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(c=>{c instanceof Pm&&C("ENABLE_ENCODE_EXCEPTION")&&c.findClosestProfile()}),this.safeEmit(St.EXCEPTION,{code:r,msg:i,uid:o})},this._statsCollector.onUploadPublishDuration=(r,i,o,c)=>{const l=this._users.find(d=>d.uid===r);l&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(l.uid,{peerPublishDuration:o,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(l)),Ue.peerPublishStatus(this._sessionId,{subscribeElapse:c,audioPublishDuration:i,videoPublishDuration:o,peer:l._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(C("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){const i=this.localTracks.find(o=>o instanceof os);i&&i._saveEncodeBitrateRatio!==1&&i.setSaveEncodeBitrateRatio(r==="h264"?C("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=e.mode==="p2p",this._gateway=new Z7(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Ys,httpRetryConfig:e.httpRetryConfig||Ys,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:s}),this._configDistribute=new dK(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(n={store:this.store,statsCollector:this._statsCollector},ci("P2PChannel").create(n)),this._handleP2PEvents()):this._p2pChannel=new Xc(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,s,n,r){let i=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],o=arguments.length>6&&arguments[6]!==void 0&&arguments[6];ss("JOIN_GATEWAY_USE_443PORT_ONLY",i),ss("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const c=this._gateway.signal.websocket;return c instanceof j_&&(c.use443PortOnly=i,c.tryDoubleDomain=o),async function(l,d,h){mm.get(l)||mm.set(l,[]),fm.get(l)||fm.set(l,d),Ri.get(l)||Ri.set(l,0);const p=mm.get(l),m=fm.get(l);if(!p||!m)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Ri.get(l)===m){const I=ju();p.push(I),await I.promise}Ri.set(l,Ri.get(l)+1);for(var g=arguments.length,T=new Array(g>3?g-3:0),w=3;w<g;w++)T[w-3]=arguments[w];const S=await h(...T);return Ri.set(l,Ri.get(l)-1),Ri.get(l)===m-1&&p.length>0&&(p[0].resolve(),p.shift()),Ri.get(l)===0&&(mm.set(l,[]),fm.set(l,0),Ri.set(l,0)),S}("client.join",C("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,s,n,r)}async join(e,t,s,n,r){const i=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const o=(Em||Em||(Em=(window.location.protocol.split(":")[0]||"").toUpperCase(),Em))==="HTTPS",c=NI()?window.isSecureContext:"Browser Not Support";(!NI()&&!o||!window.isSecureContext)&&b.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let l;Ue.setAppId(e);try{if(!s&&s!==null)throw new $(A.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));if(s&&An(s,"token",1,2047),An(e,"appid",1,2047),Km(t),n&&Ym(n),r)if(typeof r=="string")An(r,"optionalInfo",1,256),l=r;else{if(typeof r!="object")throw new $(A.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:S,enableInstantMuteRestore:I,networkQualityProbe:O}=r;S&&(Or(S,"autoSubscribe"),b.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(S)),this.store.autoSubscribe=S),I&&(Or(I,"enableInstantMuteRestore"),b.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(I)),this.store.enableInstantMuteRestore=I),O&&(Or(O,"networkQualityProbe"),b.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(O)),this.store.networkQualityProbe=O)}}}catch(S){throw Ue.reportApiInvoke(kc(),{name:Ns.JOIN,options:[e,t,s,n],states:{isHttps:o,isSecureContext:c},tag:is.TRACER}).onError(S),S}if(this._leaveMutex.isLocked&&(b.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),b.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const S=new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw Ue.reportApiInvoke(kc(),{name:Ns.JOIN,options:[e,t,s,n],states:{isHttps:o,isSecureContext:c},tag:is.TRACER}).onError(S),S}this._gateway.state="CONNECTING",this.store.preloadStart();const d=await gv({appId:e,cname:t,uid:n,stringUid:typeof n=="string"?n:void 0,token:s||e,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const h=(d==null?void 0:d.sid)||kc();b.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(i)),this._sessionId||(this._sessionId=h,this.store.sessionId=this._sessionId);const p=Ue.reportApiInvoke(this._sessionId,{id:this._clientId,name:Ns.JOIN,options:[e,t,s,n],states:{isHttps:o,isSecureContext:c},tag:is.TRACER}),m=Br(Br(Br({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof n!="string"?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:s||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:l,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:C("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(m.setLocalAPVersion=this._setLocalAPVersion),typeof n=="string"&&(m.stringUid=n,this._uintUid?(m.uid=this._uintUid,this._uintUid=void 0):m.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(m.aesmode=this._encryptionMode,m.aespassword=await(async S=>{const I=function(K){const V=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),Y=new Uint8Array(new ArrayBuffer(V.length));for(let ce=0;ce<V.length;ce+=1)Y[ce]=V.charCodeAt(ce);return Y}(),O=await window.crypto.subtle.importKey("spki",I,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),M=Db(S),z=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},O,M);return function(K){let V="";for(let Y=0;Y<K.length;Y+=1)V+=String.fromCharCode(K[Y]);return window.btoa(V)}(new Uint8Array(z))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(m.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const S=new TextEncoder,I=C("USE_PURE_ENCRYPTION_MASTER_KEY")?S.encode(m.appId+this._encryptionSecret+this._encryptionSecret):S.encode(m.appId+m.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(O,M,z){const K=await window.crypto.subtle.importKey("raw",M,"PBKDF2",!1,["deriveBits","deriveKey"]),V=O==="aes-128-gcm2"?128:256,Y=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:PI,hash:"SHA-256",salt:z},K,V+Oz);return new Uint8Array(Y).subarray(V/8)}(this._encryptionMode,I,Dc(this._encryptionSalt)),this._encryptDataStreamKey=await async function(O,M,z){const K=await window.crypto.subtle.importKey("raw",M,"PBKDF2",!1,["deriveBits","deriveKey"]),V=O==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:PI,hash:"SHA-256",salt:z},K,{name:"AES-GCM",length:V},!0,["encrypt","decrypt"])}(this._encryptionMode,I,Dc(this._encryptionSalt))}else c?b.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):b.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,b.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:m.stringUid});const g=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&g===this._sessionId&&Ue.joinChannelTimeout(this._sessionId,5)},5e3);try{var T;let S;const I=m.cloudProxyServer;if(_e(T=["proxy3","proxy4","proxy5"]).call(T,I)){const V=C("PROXY_SERVER_TYPE3");Array.isArray(V)?m.proxyServer=V[0]:m.proxyServer=V}if(Ue.setProxyServer(m.proxyServer),b.setProxyServer(m.proxyServer),this.store.requestAPStart(),d){if(b.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(m.stringUid?", ".concat(m.stringUid," => ").concat(d.intUid):""," ")),m.stringUid&&!m.uid&&(m.uid=d.intUid),S={gatewayInfo:d.ap.gatewayInfo},C("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&m.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)b.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const V=(await wD(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map(Y=>({turnServerURL:Y.address,tcpport:Y.tcpport||Un.tcpport,udpport:Y.udpport||Un.udpport,username:Y.username||Un.username,password:Y.password||Un.password,forceturn:!1,security:!0}));m.turnServer={mode:"manual",servers:V}}Ok(d,m.stringUid)}else{if(m.stringUid&&!m.uid){let V;[V,S]=await Te.all([$D(m.stringUid,m,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys,this.store).finally(()=>{this.store.requestSUAEnd()}),JD(m,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),b.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(m.stringUid," => ").concat(V)),m.uid=V,S.gatewayInfo.uid=V,S.gatewayInfo.res.uid=V}else S=await JD(m,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys,!0,this.store);if(!this._joinAndNotLeaveYet)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(m,this._axiosCancelSource.token),this._configDistribute.on(ii.UPDATE_BITRATE_LIMIT,V=>{this._p2pChannel.updateBitrateLimit(V)}),this._configDistribute.on(ii.UPDATE_CLIENT_ROLE_OPTIONS,V=>{this._setClientRoleOptions(V)}),this._configDistribute.on(ii.UPDATE_REMOTE_VIDEO_STREAM_TYPE,V=>{var Y;_e(Y=[0,1,4,5,6,7,8,9]).call(Y,V)&&(this.remoteUsers.forEach(ce=>{this._remoteStreamTypeCacheMap.get(ce.uid)!==V&&this.setRemoteVideoStreamType(ce.uid,V)}),this.setRemoteDefaultVideoStreamType(V))}),this._configDistribute.on(ii.FALLBACK_TO_HLS,V=>{V&&this.safeEmit(St.FALLBACK_TO_HLS,Pb.CONFIG)}),this._configDistribute.on(ii.UPDATE_VOS_CONFIGURE,V=>{this._gateway.setConfigure(V).catch(Y=>{b.debug("[".concat(this._clientId,"] auto set vos config failed"),Y)})})},0),this._key=s||e;const O=S.gatewayInfo,M=m.uid?m.uid:O.uid;this._joinInfo=Br(Br({},m),{},{cid:O.cid,uid:M,vid:O.vid,apResponse:O.res,apGatewayAddress:O.apGatewayAddress,uni_lbs_ip:O.uni_lbs_ip,gatewayAddrs:O.gatewayAddrs}),this.store.intUid=M,this.store.cid=O.cid;const z=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));p.onSuccess(z),this._appId=e,this._channelName=m.cname,this._uid=z,this.store.uid=z,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!yn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(yn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const K=m.stringUid?"string uid: ".concat(m.stringUid,",uid: ").concat(m.uid):"uid: ".concat(this._uid);return b.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(K)),setTimeout(()=>{b.startUpload()},5e3),this.store.joinEnd(),w=this,_e(Gc).call(Gc,w)||Gc.push(w),this._cloudProxyServerMode==="disabled"&&At().supportWebCrypto&&C("ENABLE_PRELOAD")&&bv(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&Ue.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval(()=>{this._sessionId&&Ue.reportRteDetail(this._sessionId)},C("RTE_DETAIL_REPORT_INTERVAL")||6e4),z}catch(S){const I=Array.isArray(S)?S[0]:S;throw I&&I.code===A.OPERATION_ABORTED?b.warning("[".concat(this._clientId,"] join number: ").concat(i,", Joining channel failed, rollback"),I):b.error("[".concat(this._clientId,"] join number: ").concat(i,", Joining channel failed, rollback"),I),I.code!==A.OPERATION_ABORTED&&this._numberOfJoinCount===i&&(this._gateway.state="DISCONNECTED",this._reset()),p.onError(I),I}var w}async _joinGateway(){if(!this._joinInfo||!this._key)throw new $(A.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!C("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(e){if(e.code===A.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,kt.FALLBACK),b.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new $(A.INVALID_OPERATION);return Ue.reportApiInvoke(this._sessionId,{name:Ns.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:is.TRACER}).onSuccess(),await this._joinGateway()}throw e}}async leave(){b.info("[".concat(this._clientId,"] Leaving channel"));const e=()=>{!yn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(yn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(s){const n=Gc.indexOf(s);n!==-1&&Gc.splice(n,1)}(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||e();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return b.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",kt.LEAVE),b.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t(),this.store.useDcSignal&&e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof cd))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new $(A.INVALID_PARAMS,"param list is empty");const s=e;if(this._gateway.role==="audience")throw new $(A.INVALID_OPERATION,"audience can not publish stream");for(const r of s){if(!(r instanceof cd))throw new $(A.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new $(A.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}b.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(s.map(r=>"".concat(r.getTrackId()," "))));const n=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&s.forEach(r=>{const i=this._configDistribute.getBitrateLimit();r instanceof os&&i&&r.setBitrateLimit(i.uplink)});try{await this._publishHighStream(s),b.info("[".concat(this._clientId,"] Publish success, id ").concat(s.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw b.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{n()}}async _publishDataChannel(e){if(e==null)throw new $(A.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(e)));rs(e.id,"id",0,65535,!0),Or(e.ordered,"ordered"),An(e.metadata,"metadata",0,512),b.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===e.id)!==-1)throw new $(A.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new $(A.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&C("FORCE_TURN")&&!C("TURN_ENABLE_TCP")&&!C("TURN_ENABLE_UDP"))throw new $(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const s=function(r){return BD(r,!1)}(e),n=await this._p2pChannel.publishDataChannel([s]);if(n.length>0){if(typeof s._originDataChannelId!="number")throw b.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new $(A.CREATE_DATACHANNEL_ERROR);try{await Te.all(n.map(r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0))),await s._waitTillOpen()}catch(r){if(r.code!==A.DISCONNECT_P2P)throw r}}return b.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(s.id)),s}catch(s){throw b.error("[".concat(this._clientId,"] publish datachannels error"),s.toString()),s}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new $(A.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof cd))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);b.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(n=>"".concat(n.getTrackId()," "))," "));const s=await this._publishMutex.lock();try{if(this.store.useP2P){const n=await this._p2pChannel.unpublish(t);n&&await this._gateway.sendExtensionMessage(Gs.UNPUBLISH,{unpubMsg:n},!0)}else{const n=await this._p2pChannel.unpublish(t);n&&await this._gateway.unpublish(n,this._uid),b.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(r=>"".concat(r.getTrackId()))))}}catch(n){throw b.error("[".concat(this._clientId,"] unpublish error"),n.toString()),n}finally{s&&s()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),b.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(s=>"".concat(s.id," "))," "));const t=await this._publishMutex.lock();try{const s=await this._p2pChannel.unpublishDataChannel(e);s&&await this._gateway.unpublishDataChannel(s),b.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(n=>"".concat(n.id))))}catch(s){throw b.error("[".concat(this._clientId,"] unpublish dataChannel error"),s.toString()),s}finally{t&&t()}}async subscribe(e,t,s){if(!(e instanceof Yo)){const n=this.remoteUsers.find(r=>r.uid===e);if(!n)throw new $(A.INVALID_REMOTE_USER,"user is not in the channel");e=n}return t==="datachannel"?this._subscribeDataChannel(e,s):this._subscribe(e,t)}async presubscribe(e,t){if(Ks(t,"mediaType",["audio","video"]),this.store.useP2P)throw new $(A.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new $(A.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const s=t===Le.AUDIO,n=t===Le.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:i,ortc:o,rtxSsrcId:c,cname:l,uint_id:d}=await this._gateway.presubscribe(e,t,!0);if(i==null)throw new $(A.UNEXPECTED_RESPONSE,"no ssrc id");let h=this._users.find(m=>m.uid===e);h||(h=new Yo(e,d||e),h._is_pre_created=!0,this._users.push(h)),l&&(h._cname=l),h._uintid||(h._uintid=d||e),s&&(h._audioSSRC=i,h._audio_pre_subscribed=!0,o&&(h._audioOrtc=o)),n&&(h._videoSSRC=i,h._video_pre_subscribed=!0,o&&(h._videoOrtc=o),c!=null&&(h._rtxSsrcId=c)),b.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(i)),await this._p2pChannel.subscribe(h,t,i,c,o);const p=s?h._audioTrack:h._videoTrack;if(!p)throw new $(A.UNEXPECTED_ERROR,"can not find remote track in user");return s&&(h._trust_audio_stream_added_state_=!0,h._audio_added_=!0),n&&(h._trust_video_stream_added_state_=!0,h._video_added_=!0),p}catch(i){throw b.error("[".concat(this._clientId,"] presub user ").concat(e," error"),i),i}finally{r()}}async _subscribeDataChannel(e,t){var s;if(rs(t,"channelId",0,65535,!0),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===e))throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new $(A.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new $(A.INVALID_REMOTE_USER,"user is not published");const r=(s=e._dataChannels)===null||s===void 0?void 0:s.find(c=>c.id===t);if(!r)throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new $(A.REMOTE_USER_IS_NOT_PUBLISHED);const i=await this._subscribeMutex.lock();b.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const c=await this._p2pChannel.subscribeDataChannel(e,[r]);if(c&&_e(c).call(c,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new $(A.CREATE_DATACHANNEL_ERROR);const l={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(e.uid,l,!0),await r._waitTillOpen()}catch(l){if((l==null?void 0:l.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[r]),l;await this._p2pChannel.unsubscribeDataChannel(e,[r]),this._p2pChannel.setPendingRemoteDataChannel(e,r.id)}return b.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),r}finally{i()}}async _p2pSubscribe(e,t,s){if(Ks(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(i=>i===e)){const i=new $(A.INVALID_REMOTE_USER,"user is not in the channel");throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new $(A.INVALID_REMOTE_USER,"user is not published");throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!s&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const i=new $(A.REMOTE_USER_IS_NOT_PUBLISHED);throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),i}const r=await this._subscribeMutex.lock();b.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const o=t==="audio"?e._audioSSRC:e._videoSSRC,c=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(e,t,o,c)}catch(o){throw o}b.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(o=>{b.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});const i=t==="audio"?e._audioTrack:e._videoTrack;if(!i)throw new $(A.UNEXPECTED_ERROR,"can not find remote track in user object");return i}catch(i){throw b.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{r()}}async _subscribe(e,t,s){if(this.store.useP2P)return this._p2pSubscribe(e,t);if(Ks(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===e)){const d=new $(A.INVALID_REMOTE_USER,"user is not in the channel");throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),d}if(!e.hasAudio&&!e.hasVideo){const d=new $(A.INVALID_REMOTE_USER,"user is not published");throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),d}if(!(s||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const d=new $(A.REMOTE_USER_IS_NOT_PUBLISHED);throw b.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),d}let r=t==="audio"?e._audioSSRC:e._videoSSRC,i=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?Le.AUDIO:Le.VIDEO,ssrcId:r};t==="video"&&this.store.firstVideoFrameDecoded(e.uid,{subscribeStart:Date.now()});const l=await this._subscribeMutex.lock();b.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const h=t==="audio"?e._audioSSRC:e._videoSSRC;h!==void 0&&h!==r&&(r=h,i=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?Le.AUDIO:Le.VIDEO,ssrcId:r}),Hn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,r,o,i);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(e.uid,c,!0)}catch(p){if((p==null?void 0:p.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),p;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(h){throw this._p2pChannel.reportSubscribeEvent(!1,h==null?void 0:h.code,e,t),h}b.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(h=>{b.warning("[".concat(this._clientId,"] auto set fallback failed"),h)});const d=t==="audio"?e._audioTrack:e._videoTrack;if(!d)throw new $(A.UNEXPECTED_ERROR,"can not find remote track in user object");return t==="video"&&(this.store.firstVideoFrameDecoded(e.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(e)),d}catch(d){throw b.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),d),d}finally{l()}}async massSubscribe(e){if(no(e,"subscribeList"),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),s=new Map,n=await this._subscribeMutex.lock();b.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(c=>{let{user:l,mediaType:d}=c;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(d)}).join("; ")));const r=(e=[...e]).map(c=>{let{user:l,mediaType:d}=c;return{user:l,mediaType:d}}),i=await this._p2pChannel.globalLock();try{var o;for(let l=e.length-1;l>=0;l--){const d=e[l],{user:h,mediaType:p}=d;if(Ks(p,"mediaType",["audio","video"]),!h){const w=new $(A.INVALID_PARAMS,"user property does not exist in subscribeList item");throw b.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),w}if(!this._users.find(w=>w===h)){const w=new $(A.INVALID_REMOTE_USER,"user is not in the channel");b.error("[".concat(this._clientId,"] can not massSubscribe ").concat(h.uid,", this user is not in the channel")),r[l].error=w,e.splice(l,1);continue}if(p==="audio"&&(!h.hasAudio||h._audioSSRC===void 0)||p==="video"&&(!h.hasVideo||h._videoSSRC===void 0)){const w=new $(A.REMOTE_USER_IS_NOT_PUBLISHED);b.error("[".concat(this._clientId,"] can not subscribe ").concat(h.uid," with mediaType ").concat(p,", remote user is not published")),r[l].error=w,e.splice(l,1);continue}const g=bn.Video|bn.LwoVideo,T=s.get(h);if(T){if(p==="video"?T&g:T&bn.Audio){e.splice(l,1),b.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(h.uid,", mediaType:").concat(p," twice"));continue}s.set(h,T|(p==="video"?g:bn.Audio))}else s.set(h,p==="video"?g:bn.Audio)}for(let l=e.length-1;l>=0;l--){const d=e[l],{user:h,mediaType:p}=d,m=bn.Video|bn.LwoVideo;if(this._p2pChannel.hasRemoteMedia(h,p)){await this._p2pChannel.unmuteRemoteNoLock(h,p);const g=s.get(h);s.set(h,p==="video"?g^m:g^bn.Audio),e.splice(l,1)}}this.store.massSubscribe(e.map(l=>({userId:l.user.uid,type:l.mediaType})),t);let c=or(o=Array.from(s.entries())).call(o,(l,d)=>{let[h,p]=d;if(p===0)return l;const m={stream_id:h.uid,stream_type:p};return p&bn.Audio&&(m.audio_ssrc=h._audioSSRC),p&bn.Video&&(m.video_ssrc=h._videoSSRC),l.push(m),l},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(d=>{let{user:h,mediaType:p}=d;return{user:h,mediaType:p,ssrcId:p===Le.VIDEO?h._videoSSRC:h._audioSSRC,rtxSsrcId:p===Le.VIDEO?h._rtxSsrcId:void 0}}));const l=new Map;if(c=c.filter(d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc),c.length>0){const d=await this._gateway.subscribeAll(c,!0);((d==null?void 0:d.users)||[]).forEach(h=>{let{stream_id:p,video_error_code:m,audio_error_code:g,error_code:T}=h;(m||g||T)&&l.set(p,{video_error_code:m,audio_error_code:g,error_code:T})})}if(Array.from(l.entries()).length>0){const d=[];Array.from(l.entries()).forEach(h=>{let[p,m]=h;const g=this.remoteUsers.find(T=>T.uid===p);if(g){let T;m.error_code||m.video_error_code&&m.audio_error_code?T=void 0:m.video_error_code?T=Le.VIDEO:m.audio_error_code&&(T=Le.AUDIO),d.push({user:g,mediaType:T})}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const h=l.get(d.user.uid);if(h){const p=h.error_code||d.mediaType==="audio"&&h.audio_error_code||d.mediaType==="video"&&h.video_error_code;if(p){const m=zc(p);b.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(m.desc)),d.error=new $(A.SUBSCRIBE_FAILED,"code ".concat(p,": ").concat(m.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var h;Ue.subscribe(this.store.sessionId,{succ:!!d.error,ec:((h=d.error)===null||h===void 0?void 0:h.code)||null,video:d.mediaType===Le.VIDEO,audio:d.mediaType===Le.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===Le.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)}),b.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(d=>{let{user:h,mediaType:p}=d;return"user: ".concat(h==null?void 0:h.uid,", mediaType: ").concat(p)}).join("; "))),r}catch(l){throw await this._p2pChannel.massUnsubscribeNoLock(e),l}}finally{i(),n()}}async unsubscribe(e,t,s){if(!(e instanceof Yo)){const i=this.remoteUsers.find(o=>o.uid===e);if(!i)throw new $(A.INVALID_REMOTE_USER,"user is not in the channel");e=i}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,s)}else await this._unsubscribeDataChannel(e,s);if(t&&Ks(t,"mediaType",["audio","video"]),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(i=>i===e)){const i=new $(A.INVALID_REMOTE_USER,"user is not in the channel");throw b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}b.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(e,t);else{const i=await this._p2pChannel.unsubscribe(e,t);i&&await this._gateway.unsubscribe(i,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&bm(this._users,e),b.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(i){if(i.code===A.DISCONNECT_P2P)return void b.warning("disconnecting p2p, abort unsubscribe request.");throw b.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}finally{r()}}async _unsubscribeDataChannel(e,t){if(t&&rs(t,"id",0,65535,!0),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===e)){const r=new $(A.INVALID_REMOTE_USER,"user is not in the channel");throw b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),r}let n;if(typeof t=="number"){const r=e._dataChannels.find(i=>i.id===t);r&&(n=[r])}else n=e._dataChannels;if(n===void 0){const r=new $(A.REMOTE_USER_IS_NOT_PUBLISHED);throw b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),r}b.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map(r=>r.id)));try{const r=await this._p2pChannel.unsubscribeDataChannel(e,n);r&&await this._gateway.unsubscribeDataChannel(r,e.uid),b.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===A.DISCONNECT_P2P)return void b.warning("disconnecting p2p, abort unsubscribe request.");throw b.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),r.toString()),r}}async massUnsubscribe(e){if(no(e,"unsubscribeList"),!this._joinInfo)throw new $(A.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");b.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(s=>{let{user:n,mediaType:r}=s;return"user: ".concat(n==null?void 0:n.uid,", mediaType: ").concat(r,";")}).join())),e=[...e];const t=new Map;for(let s=e.length-1;s>=0;s--){const{user:n,mediaType:r}=e[s];if(!n){const c=new $(A.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw b.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),c}if(Ks(r,"mediaType",["video","audio",void 0]),!this._users.find(c=>c===n)){b.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),e.splice(s,1);continue}const o=bn.Video|bn.LwoVideo;if(t.has(n)){const c=t.get(n);let l;switch(r){case"video":l=c&o;break;case"audio":l=c&bn.Audio;break;default:l=c&(bn.Audio|o)}if(l){b.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(r," twice.")),e.splice(s,1);continue}r?r==="audio"?t.set(n,c|bn.Audio):r==="video"&&t.set(n,c|o):t.set(n,c|bn.Audio|o)}else r?r==="audio"?t.set(n,bn.Audio):r==="video"&&t.set(n,o):t.set(n,bn.Audio|o)}try{const s=await this._p2pChannel.massUnsubscribe(e);s&&await this._gateway.massUnsubscribe(s),b.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(n=>{let{user:r,mediaType:i}=n;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(i,";")}).join()))}catch(s){if(s.code===A.DISCONNECT_P2P)return void b.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw b.error("[".concat(this._clientId,"] massUnsubscribe error"),s.toString()),s}}async setLowStreamParameter(e){(function(s){if(!s)throw new se(A.INVALID_PARAMS);js(s.width)||Ab(s.width,"streamParameter.width"),js(s.height)||Ab(s.height,"streamParameter.height"),js(s.framerate)||Ab(s.framerate,"streamParameter.framerate"),js(s.bitrate)||rs(s.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&b.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),b.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,ve.LocalVideoLowTrack)}async setDualStreamMode(e,t){Ks(e,"mode",[0,1,-1]);try{switch(t&&await this.setLowStreamParameter(t),this._dualStreamMode=e,this._joinInfo?this._gateway.setDualStreamMode(e).catch(s=>{b.warning("[".concat(this._clientId,"] set dual stream mode failed"),s.toString())}):b.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(e)),e){case $l.AUTO_SIMULCAST_STREAM:b.info("[".concat(this._clientId,"] set dual stream mode to ").concat(e));break;case $l.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case $l.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(s){throw b.error("[".concat(this._clientId,"] set dual stream mode error"),s.toString()),s}}async enableDualStream(){if(!At().supportDualStream)throw Ue.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new $(A.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new $(A.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw Ue.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,this._dualStreamMode=$l.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{b.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),Ue.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),b.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void b.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(ve.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw Ue.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,this._dualStreamMode=$l.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{b.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),Ue.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),b.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(n){Ks(n,"role",["audience","host"])}(e),t&&jb(t),this.mode==="rtc"||this.mode==="p2p")throw b.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new $(A.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new $(A.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new $(A.INVALID_OPERATION,"can not set client role to audience when publishing stream");const s=this._config.role;if(this._joinInfo&&(this._joinInfo.role=e),e!==s&&C("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(e,t),this._config.role=e,this._gateway.reconnect("recover",Mn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(e,t),this._config.role=e),b.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level)),s==="audience"&&e!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Xc){const{video_codec:n}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(n.map(r=>r.toLowerCase()).filter(r=>{var i;return _e(i=Object.keys(Pc)).call(i,r)}))}}async _setClientRoleOptions(e){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let t=!1;try{e&&jb(e),await this._gateway.setClientRole(this._config.role,e),t=!0}catch{}finally{b.info("[".concat(this._clientId,"] set client role options ").concat(t?"succeed":"failed",", options is ").concat(e))}}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const s=t.timestamp-Date.now();return Math.abs(s)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?s:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(An(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new $(A.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new $(A.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,Ue.setProxyServer(this._proxyServer),b.setProxyServer(this._proxyServer),b.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new $(A.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new $(A.INVALID_OPERATION,"You have already set the proxy")}if(Cc(e))return this._turnServer={servers:e,mode:"original-manual"},void b.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(s=>s.urls).join(","),"."));e.forEach(s=>pI(s)),this._turnServer={servers:e,mode:"manual"},b.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new $(A.INVALID_OPERATION,"you should set license before join channel");if(An(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new $(A.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,b.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new $(A.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new $(A.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let s;switch(e===void 0&&(e=3),e){case 1:case 2:throw new $(A.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:s="proxy3";break;case 4:s="proxy4";break;case 5:s="proxy5";break;default:throw new $(A.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=s,this.store.cloudProxyServerMode=s,b.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new $(A.INVALID_OPERATION,"Stop proxy server after leave channel");Ue.setProxyServer(),b.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",b.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new $(A.INVALID_PARAMS,"accessPoints is required.");no(e.accessPoints.serverList,"accessPoints.serverList"),An(e.accessPoints.domain,"accessPoints.domain");const t=(m,g)=>{rs(m,g,0,65535,!0)};let s=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),s=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new $(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");C("CLOSE_AFB_FOR_LOCAL_AP")&&(ss("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),ss("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,i=e.accessPoints.serverList.map(m=>n.test(m)?"".concat(m.replace(/\./g,"-"),".").concat(r):m),o=i.map(m=>"".concat(m,":").concat(s));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,ss("WEBCS_DOMAIN",o),ss("WEBCS_DOMAIN_BACKUP_LIST",o),ss("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(no(e.report.hostname,"report.hostname"),ss("EVENT_REPORT_DOMAIN",e.report.hostname[0]),ss("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(ss("EVENT_REPORT_DOMAIN",i[0]),ss("EVENT_REPORT_BACKUP_DOMAIN",i[1]||i[0]));let c=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),c=e.report.port),ss("STATS_COLLECTOR_PORT",c),e.report?ss("ENABLE_EVENT_REPORT",!0):ss("ENABLE_EVENT_REPORT",!1);let l="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(no(e.log.hostname,"log.hostname"),l=e.log.hostname[0]):l=i[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),ss("LOG_UPLOAD_SERVER","".concat(l,":").concat(d));let h=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(no(e.cds.hostname,"cds.hostname"),h=e.cds.hostname):h=i;let p=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),p=e.cds.port),ss("CDS_AP",h.map(m=>"".concat(m,":").concat(p))),e.cds?ss("ENABLE_CONFIG_DISTRIBUTE",!0):ss("ENABLE_CONFIG_DISTRIBUTE",!1),b.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(no(e,"serverList"),An(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new $(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const s=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(n=>s.test(n)?"".concat(n.replace(/\./g,"-"),".").concat(t):n),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,ss("WEBCS_DOMAIN",e),ss("WEBCS_DOMAIN_BACKUP_LIST",e),ss("GATEWAY_DOMAINS",[t]),ss("EVENT_REPORT_DOMAIN",e[0]),ss("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),ss("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),b.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Ks(e,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw b.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else b.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){Ks(t,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{const s=this._users.find(n=>n.uid===e);s&&s.videoTrack&&s.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(s){throw b.error("[".concat(this._clientId,"] set remote video stream type error"),s.toString()),s}b.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Ks(t,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(s){throw b.error("[".concat(this._clientId,"] set stream fallback option"),s.toString()),s}b.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,s,n){(function(i){Ks(i,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),An(t,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(_e(r).call(r,e)){if(!s||!(s instanceof Uint8Array&&s.length===32))throw new $(A.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(s)throw new $(A.INVALID_PARAMS,"current encrypt mode does not need salt");if(n){if(Or(n,"encryptDataStream"),!_e(r).call(r,e))throw new $(A.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||b.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,s&&(this._encryptionSalt=Fo(s))}async renewToken(e){if(An(e,"token",1,2047),!this._key||!this._joinInfo)throw new $(A.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const s=await this._renewTokenMutex.lock();try{if(C("USE_NEW_TOKEN")){b.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const n=await lK(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys);b.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:n})}else b.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});b.debug("[".concat(this._clientId,"] renewToken success"))}catch(n){throw this._key=t,this._joinInfo.token=t,b.error("[".concat(this._clientId,"] renewToken failed"),n.toString()),n}finally{s()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?b.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(St.VOLUME_INDICATOR,e)},C("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new $(A.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new $(A.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new $(A.LIVE_STREAMING_TASK_CONFLICT);const s=t?ro.TRANSCODE:ro.RAW;return this._createLiveStreamingClient(s).startLiveStreamingTask(e,s)}setLiveTranscoding(e){return this._createLiveStreamingClient(ro.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(s=>s&&s.hasUrl(e));if(!t.length)throw new $(A.INVALID_PARAMS,"can not find live streaming url to stop");await Te.all(t.map(s=>s&&s.stopLiveStreamingTask(e)))}async startChannelMediaRelay(e){nk(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){nk(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(e){this._p2pChannel instanceof Xc&&this._p2pChannel.addAudioMetadata(e)}async sendStreamMessage(e){var t;let s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new $(A.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const r=new TextEncoder;e.payload=r.encode(e.payload)}let n=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&_e(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(n=!0,e.payload=await async function(r,i,o){var c;const l=or(c=Array.from(o)).call(c,(w,S)=>w+S,0),d={serverTs:0,seq:Dz++,length:o.length,checkSum:l},h=new Uint8Array(yI(l,2)),p=new ArrayBuffer(nd),m=new DataView(p);m.setUint32(0,d.serverTs),m.setUint16(4,d.seq),m.setUint16(6,d.length),m.setUint16(8,d.checkSum);const g=16-o.length%16;o=xI(o,new Uint8Array(g));const T=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:jI,additionalData:h},i,o);return xI(new Uint8Array(p),new Uint8Array(T))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new $(A.INVALID_PARAMS,n?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(qe.DATA_STREAM,{payload:Fo(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-bK},!s)}sendMetadata(e){if(!this._joinInfo)throw new $(A.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new $(A.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(qe.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Fo(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(Bz),!this._joinInfo)throw new $(A.INVALID_OPERATION,"can not send custom report, not joined");await Ue.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const e=this._statsCollector.getRemoteNetworkQualityStats();if(C("DELETE_NEQ_AFTER_USER_LEAVE")){const t=this._users.map(s=>s.uid+"");Object.keys(e).forEach(s=>{_e(t).call(t,s)||delete e[s]})}return e}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(e,t){Ks(t.spatialLayer,"spatialLayer",[0,1,2,3]),Ks(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(s){throw b.error("[".concat(this._clientId,"] pick SVC layer failed"),s.toString()),s}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:s}=e;if(Or(t,"apRTM"),rs(s,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=s,b.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=s,this._gateway.setRTM2Flag(s)}_reset(){if(b.debug("[".concat(this._clientId,"] reset client")),function(e){const t=md.indexOf(e);t!==-1&&md.splice(t,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=ba.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&Ak(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&Ue.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&Ue.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new wn("client-publish",this._clientId),this._subscribeMutex=new wn("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var s;const n=e||kc();e?b.debug("[".concat(this._clientId,"] new Session ").concat(n)):b.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(n));const r=e?"":this._sessionId||"";this._sessionId=n,this.store.sessionId=n,Ue.addSid(n);const i={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(t==null?void 0:t.stringUid)||((s=this._joinInfo)===null||s===void 0?void 0:s.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};Ue.sessionInit(this._sessionId,Br({cname:t.channel,appid:t.appId},i)),this._joinInfo&&(this._joinInfo.sid=n),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=n)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new $(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&C("FORCE_TURN")&&!C("TURN_ENABLE_TCP")&&!C("TURN_ENABLE_UDP"))throw new $(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");b.debug("[".concat(this._clientId,"] publish high stream"));try{const s=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const n=(await s.next()).value;if(n){try{await this._gateway.sendExtensionMessage(Gs.PUBLISH,n,!0)}catch(r){throw s.throw(r),r}await s.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await s.next()).value;if(n){var t;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(i){if(i.code!==A.DISCONNECT_P2P)throw s.throw(i),i}await s.next(((t=r)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of e)r instanceof os&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch(i=>{b.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(s){if(this._p2pChannel.reportPublishEvent(!1,s==null?void 0:s.code,e),(s==null?void 0:s.code)===A.WS_ABORT)return;throw s}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new $(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new $(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));b.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const s=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await s.next()).value;if(n){var t;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(i){if(i.code!==A.DISCONNECT_P2P)throw s.throw(i),i}s.next(((t=r)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(s){if(this._p2pChannel.reportPublishEvent(!1,s==null?void 0:s.code,void 0,!0),(s==null?void 0:s.code)===A.WS_ABORT)return;throw s}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId)return new $(A.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const s=(n={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},ci("LiveStreaming").create(n));var n;return s.onLiveStreamError=(r,i)=>{Ue.reportApiInvoke(this._sessionId,{name:Ns.ON_LIVE_STREAM_ERROR,options:[r,i],tag:is.TRACER}).onSuccess(),this.safeEmit(St.LIVE_STREAMING_ERROR,r,i)},s.onLiveStreamWarning=(r,i)=>{Ue.reportApiInvoke(this._sessionId,{name:Ns.ON_LIVE_STREAM_WARNING,options:[r,i],tag:is.TRACER}).onSuccess(),this.safeEmit(St.LIVE_STREAMING_WARNING,r,i)},s.on(O_.REQUEST_WORKER_MANAGER_LIST,(r,i,o)=>{if(!this._joinInfo)return o(new $(A.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(c,l,d,h){const p=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(m=>l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(m+"/api/v1?action=uap"):"https://".concat(m,"/api/v1?action=uap"));return await sK(p,c,l,d,h)})(r,this._joinInfo,this._axiosCancelSource.token,Ys).then(i).catch(o)}),s};return e===ro.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new $(A.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:s}=this.getLocalVideoStats(),n=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:s}},ci("ChannelMediaRelay").create(e));n.on("state",r=>{r===Ra.RELAY_STATE_FAILURE&&n&&n.dispose(),this.safeEmit(St.CHANNEL_MEDIA_RELAY_STATE,r)}),n.on("event",r=>{this.safeEmit(St.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._channelMediaRelayClient=n,this._statsCollector.onStatsChanged=(r,i)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(i))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:s,deleted:n}=e,r=[];if(t){const i=[];this._users.forEach(o=>{o._dataChannels.forEach(c=>{s.every(l=>l.uid!==o._uintid||l.stream_id!==c.id)&&i.push({uid:o._uintid,stream_id:c.id,ordered:c.ordered,max_retrans_times:c.maxRetransmits,metadata:c.metadata})})}),i.length>0&&this._handleUpdateDataChannel({added:[],deleted:i})}Array.isArray(s)&&s.length>0&&s.forEach(i=>{const{uid:o,stream_id:c,ordered:l,max_retrans_times:d,metadata:h}=i,p=this._users.find(m=>m._uintid===o);if(!p)return void b.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(b.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),_e(r).call(r,p)||r.push(p),p._uintid||(p._uintid=o),p._dataChannels.findIndex(m=>m.id===i.stream_id)===-1){const m={id:c,ordered:!!l,maxRetransmits:d,metadata:h},g=function(T){return BD(T,!0)}(m);p._dataChannels.push(g),b.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published datachannel")),t||this.safeEmit(St.USER_PUBLISHED,p,"datachannel",m)}this._p2pChannel.hasPendingRemoteDataChannel(p,i.stream_id)&&(b.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(p.uid," after reconnect.")),this._subscribeDataChannel(p,i.stream_id).catch(m=>{b.error("[".concat(this._clientId,"] resubscribe datachannel error"),m.toString())}))}),t&&(this.safeEmit(St.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach(i=>{const{uid:o,stream_id:c}=i,l=this._users.find(h=>h._uintid===o);if(!l)return void b.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=l._dataChannels.find(h=>h.id===i.stream_id);d&&(b.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(l,[d]).then(h=>{if(l._dataChannels=l._dataChannels.filter(p=>p!==d),h)return this._gateway.unsubscribeDataChannel(h,l.uid)}),b.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(St.USER_UNPUBLISHED,l,"datachannel",d._config))})}_getEncodingName(e){var t,s;if(!this._joinResponse)return;const n=(t=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||t===void 0?void 0:t.videoCodecs;if(!n)return;for(const c of n){var r;if(c.payloadType===e)return c==null||(r=c.rtpMap)===null||r===void 0?void 0:r.encodingName}const i=(s=this._joinResponse.ortc.rtpCapabilities.recv)===null||s===void 0?void 0:s.videoCodecs;if(i)for(const c of i){var o;if(c.payloadType===e)return c==null||(o=c.rtpMap)===null||o===void 0?void 0:o.encodingName}return e===0?"unknown":void 0}_handleRemoveDataChannels(e){const t=this._users.find(s=>s.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){b.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const s=()=>{b.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(n=>{this.safeEmit(St.USER_UNPUBLISHED,t,"datachannel",n._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(n=>{if(n)return this._gateway.unsubscribeDataChannel(n,t.uid)}),s()}}else b.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Bs.UPDATE_GATEWAY_CONFIG,()=>{(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void b.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),s=Date.now();Object.keys(t).forEach(n=>{const{value:r,type:i,expires:o}=t[n];o&&o<=s||i||S_()||!Object.prototype.hasOwnProperty.call(Nm,n)||(Ka[n]=r,$t[n]=r,b.debug("Update gateway parameters from config distribute",n,r))})}catch(t){b.error("Error update config from local cache",t.message)}})()}),this._gateway.on(Bs.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Bs.CONNECTION_STATE_CHANGE,(e,t,s)=>{var n;if(s===kt.FALLBACK)return;const r=()=>{this.safeEmit(St.CONNECTION_STATE_CHANGE,e,t,s)};if(Ue.reportApiInvoke(this._sessionId||((n=this._gateway.joinInfo)===null||n===void 0?void 0:n.sid)||null,{name:Ns.CONNECTION_STATE_CHANGE,options:[e,t,s],tag:is.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:s})),b.info("[".concat(this._clientId,"] signal connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void r();if(e==="RECONNECTING")this._users.forEach(o=>{o._trust_in_room_=!1,o._trust_audio_enabled_state_=!1,o._trust_video_enabled_state_=!1,o._trust_audio_mute_state_=!1,o._trust_video_mute_state_=!1,o._trust_audio_stream_added_state_=!1,o._trust_video_stream_added_state_=!1,o._is_pre_created||(o._audio_pre_subscribed||(o._audioSSRC=void 0,o._audioOrtc=void 0),o._video_pre_subscribed||(o._videoSSRC=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),o._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var i;this._streamFallbackTypeCacheMap.forEach((o,c)=>{this._gateway.setStreamFallbackOption(c,o).catch(l=>{b.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),l)})}),this._remoteStreamTypeCacheMap.forEach((o,c)=>{this._gateway.setRemoteVideoStreamType(c,o).catch(l=>{b.warning("[".concat(this._clientId,"] auto set remote stream type failed"),l)})}),C("VOS_CONFIGURE")&&Array.isArray(C("VOS_CONFIGURE"))&&C("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(C("VOS_CONFIGURE")).catch(o=>{b.debug("[".concat(this._clientId,"] auto set vos config failed"),o)}),b.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((i=this._joinInfo)===null||i===void 0?void 0:i.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{b.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(o=>{b.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(o))}),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch(o=>{b.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),o)}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(o=>!o._trust_in_room_).forEach(o=>{b.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(o.uid)),this._handleUserOffline({uid:o.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(o=>{o._trust_audio_mute_state_||(b.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,Le.AUDIO,!1)),o._trust_video_mute_state_||(b.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,Le.VIDEO,!1)),o._trust_audio_enabled_state_||(b.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(o.uid)),this._handleSetStreamLocalEnable("audio",o.uid,!0)),o._trust_video_enabled_state_||(b.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(o.uid)),this._handleSetStreamLocalEnable("video",o.uid,!0)),o._trust_video_stream_added_state_||(b.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(o.uid)),this._handleResetAddStream(o,"video")),o._trust_audio_stream_added_state_||(b.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(o.uid)),this._handleResetAddStream(o,"audio")),o._video_added_||o._audio_added_||(b.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(o.uid)),this._handleRemoveStream({uid:o.uid,uint_id:o._uintid}))}))},1e3))}r()}),this._gateway.on(Bs.REQUEST_NEW_GATEWAY_LIST,async(e,t)=>{if(!this._joinInfo)return t(new $(A.UNEXPECTED_ERROR,"can not recover, no join info"));try{let s;if(this._fallbackServerInfo)s=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,Ue.reportApiInvoke(this._sessionId,{name:Ns.VOS_FALLBACK_CN,options:{cur:s.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:is.TRACER}).onSuccess(),b.info("[".concat(this._clientId,"] use fallback cn server info"));else{const r=await gv(Br(Br({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(s=r.ap,Ok(r),this._joinInfo.preload=!0):(s=await lf(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=s.gatewayInfo.res,this._joinInfo.gatewayAddrs=s.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=s.gatewayInfo.uni_lbs_ip);const n=[];s.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:i}=r;const[o,c]=i.split(":");this._joinInfo&&this._joinInfo.proxyServer?n.push({proxy:this._joinInfo.proxyServer,host:o,port:c}):n.push({host:o,port:c})}),e(n)}catch(s){t(s)}}),this._gateway.on(Bs.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(St.NETWORK_QUALITY,e)}),this._gateway.on(Bs.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(St.STREAM_TYPE_CHANGED,e,t),Ue.reportApiInvoke(this._sessionId,{name:Ns.STREAM_TYPE_CHANGE,options:[e,t],tag:is.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(Bs.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Bs.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,s)=>{try{let n=await this._p2pChannel.getEstablishParams();n&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(n=await this._p2pChannel.startP2PConnection(e)),t(n)}catch(n){s(n)}}),this._gateway.on(Bs.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;let s;this._joinResponse=e,e.attributes?s=e.attributes.userAttributes.preSubSsrcs:b.debug("no attributes in joinResponse");const n=OD(e.ortc,t,s);this._p2pChannel.connect(n)}),this._gateway.on(Bs.PRE_CONNECT_PC,async(e,t,s)=>{const{candidates:n,fingerprint:r,turnServer:i}=e;if(this._joinInfo&&n.length>0&&!this._p2pChannel.isPlanB){const{cert:c,cid:l}=this._joinInfo.apResponse,d="".concat(l,"_").concat(c);if(d.length<4||d.length>256)return void b.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(d.length));await this._p2pChannel.startP2PConnection({turnServer:i,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var o;t(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(l,"_").concat(c),icePwd:"".concat(l,"_").concat(c)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(o=C("FINGERPRINT"))!==null&&o!==void 0?o:r}]},candidates:n,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(h){h.code&&h.code===A.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:i,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),s(h)}}}),this._gateway.on(Bs.VOS_FALLBACK,e=>{e==="fallback_hls"&&this.safeEmit(St.FALLBACK_TO_HLS,Pb.VOSERROR)}),this._gateway.on(Bs.RESET_SIGNAL,()=>{this._p2pChannel instanceof Xc&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()}),this._gateway.on(Bs.DATACHANNEL_FAILBACK,()=>{Ue.reportApiInvoke(this._sessionId,{name:Ns.DATACHANNEL_FAILBACK,options:{},tag:is.TRACER}).onSuccess(),this._joinGateway()})}_handleGatewaySignalEvents(){this._gateway.signal.on(ut.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(ut.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(ut.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc)),this._gateway.signal.on(ut.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(ut.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(ut.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(ut.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(ut.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(ut.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,Le.AUDIO,!0)),this._gateway.signal.on(ut.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,Le.AUDIO,!1)),this._gateway.signal.on(ut.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,Le.VIDEO,!0)),this._gateway.signal.on(ut.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,Le.VIDEO,!1)),this._gateway.signal.on(ut.RECEIVE_METADATA,e=>{const t=Dc(e.metadata);this.safeEmit(St.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(ut.ON_DATA_STREAM,async e=>{var t;if(!e)return;let s=Dc(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&_e(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<nd)throw new $(A.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(nd));s=await async function(i,o,c){const l=c.subarray(0,nd),d=l.slice(8,nd),h=(d[0]<<8)+d[1],p=(l[6]<<8)+l[7],m=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:i,tagLength:jI,additionalData:new Uint8Array(yI(h,2))},o,c.subarray(nd));return new Uint8Array(m).subarray(0,p)}(this._encryptDataStreamIv,this._encryptDataStreamKey,s)}let n=0;if(e.ordered||e.syncWithAudio){const r=this._p2pChannel.getStats(),i=this.remoteUsers.find(c=>c.uid===e.uid),o=r==null?void 0:r.audioRecv.find(c=>c.ssrc===(i==null?void 0:i._audioSSRC));n=o==null?void 0:o.jitterBufferMs}(n==null||Number.isNaN(n))&&(n=0),vK(Br(Br({},e),{},{payload:s}),n,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(ut.ON_CRYPT_ERROR,()=>{Vo(()=>{b.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(St.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(ut.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{b.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,kt.TOKEN_EXPIRE),this.safeEmit(St.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(ut.ON_STREAM_FALLBACK_UPDATE,e=>{b.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(St.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(ut.ENABLE_MULTI_STREAM,e=>{this._dualStreamMode===$l.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch(t=>{b.debug("[".concat(this._clientId,"] set dual stream mode error"),t.toString())})}),this._gateway.signal.on(ut.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),b.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(ut.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(ut.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(Ge.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case qe.PUBLISH:{if(!t)return;const r=t.ortc;if(r){var s,n;const i=r.some(l=>{let{stream_type:d}=l;return d===Qt.Audio}),o=r.some(l=>{let{stream_type:d}=l;return d!==Qt.Audio}),c=r.some(l=>{let{stream_type:d}=l;return d===Qt.Screen||d===Qt.ScreenLow});t.state==="offer"&&Ue.publish(this._joinInfo.sid,{eventElapse:Hn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:A.TIMEOUT,audio:i,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:i?(s=r.find(l=>{let{stream_type:d}=l;return d===Qt.Audio}))===null||s===void 0||(s=s.ssrcs[0])===null||s===void 0?void 0:s.ssrcId.toString():void 0,videoName:o?(n=r.find(l=>{let{stream_type:d}=l;return d!==Qt.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0})}break}case qe.SUBSCRIBE:t&&Ue.subscribe(this._joinInfo.sid,{succ:!1,ec:A.TIMEOUT,audio:t.stream_type===Le.AUDIO,video:t.stream_type===Le.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Hn.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}}),this._gateway.signal.on(ut.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(ut.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;C("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(n=>!Wc(n.string_id||n.stream_id,this.channelName)));const t=[],s=[];for(const n of e.users){let r=this._users.find(h=>h._uintid===n.stream_id);r?r._trust_in_room_=!0:(r=new Yo(n.string_id||n.stream_id,n.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(St.PUBLISHED_USER_LIST).length===0&&(b.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(St.USER_JOINED,r)));const i=bn.Audio&n.stream_type,o=(bn.Video|bn.LwoVideo)&n.stream_type,c=(65280&n.stream_type)!=0,l=i&&r.hasAudio,d=o&&r.hasVideo;o&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=n.video_ssrc,r._rtxSsrcId=n.video_rtx),i&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=n.audio_ssrc),i&&!l&&this.getListeners(St.PUBLISHED_USER_LIST).length===0&&(b.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(St.USER_PUBLISHED,r,"audio")),o&&!d&&this.getListeners(St.PUBLISHED_USER_LIST).length===0&&(b.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(St.USER_PUBLISHED,r,"video")),(i&&!l||o&&!d||c)&&t.push(r),o&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&s.push({user:r,mediaType:"video"}),i&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&s.push({user:r,mediaType:"audio"})}s.length>0&&(b.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(s.map(n=>"user: ".concat(n.user.uid,", mediaType: ").concat(n.mediaType)).join("; ")," ")),this.massSubscribe(s).catch(n=>{b.error("[".concat(this._clientId,"] mass resubscribe error"),n.toString())})),this.getListeners(St.PUBLISHED_USER_LIST).length>0?C("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(b.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(n=>n.uid).join(", "))),this.safeEmit(St.PUBLISHED_USER_LIST,t)):b.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(n=>n.uid).join(", ")))}),this._gateway.signal.on(ut.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:t}=e;if(this._p2pChannel instanceof Xc){if(this.role==="audience"&&C("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=e,void b.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(e)));this._p2pChannel.updateRemoteRTPCapabilities(t.map(s=>s.toLowerCase()).filter(s=>{var n;return _e(n=Object.keys(Pc)).call(n,s)}))}}),this._gateway.signal.on(Ge.VOS_FALLBACK_PROMISE,async(e,t,s)=>{if(e==="FALLBACKCN"&&C("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return s(new $(A.UNEXPECTED_ERROR,"can not recover, no join info"));b.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=e;const i=await lf(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ys,this.store);if(C("QUALITY_FALLBACK_REHEARSAL"))return Ue.reportApiInvoke(this._sessionId,{name:Ns.VOS_FALLBACK_CN,options:{cur:i.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:is.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void s();this._fallbackServerInfo=i,t()}catch(i){var n;const o=i==null||(n=i.data)===null||n===void 0?void 0:n.desc;C("QUALITY_FALLBACK_REHEARSAL")?(Ue.reportApiInvoke(this._sessionId,{name:Ns.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+o||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:is.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(o)&&_e(o).call(o,"request downgrade fallback")&&this.safeEmit(St.FALLBACK_TO_HLS,Pb.AP_ERROR),s(i)}}else s()})}_handleP2PEvents(){this._gateway.signal.on(ut.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Gs.PUBLISH,(e,t,s)=>{const{uid:n}=e;e.forEach(r=>{const{kind:i,ssrcs:o,mid:c,isMuted:l}=r;this._handleP2PAddAudioOrVideoStream(i,n,o[0].ssrcId,c);const d=this._users.find(h=>h.uid===n);return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,i,o[0].ssrcId,c).then(()=>{t()}).catch(s):t(),this._handleMuteStream(n,i,!!l)})}),this._gateway.signal.on(Gs.CALL,async(e,t,s)=>{if(this.store.useP2P)try{var n;t(await this._p2pChannel.startP2P({turnServer:(n=this._joinInfo)===null||n===void 0?void 0:n.turnServer},e))}catch(r){s(r)}}),this._gateway.signal.on(Ge.P2P_CONNECTION,async e=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(e)}),this._gateway.signal.on(Gs.UNPUBLISH,async(e,t,s)=>{if(this.store.useP2P){const{unpubMsg:n,uid:r}=e,i=this._users.find(o=>o.uid===r);if(!i)return b.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{n.forEach(async o=>{let{stream_type:c}=o;const l=c===Qt.Audio?Le.AUDIO:Le.VIDEO;await this._p2pChannel.unsubscribe(i,l),this._handleMuteStream(r,l,!0)}),t()}catch(o){s(o)}}}),this._gateway.signal.on(Gs.CONTROL,async(e,t)=>{const{action:s}=e;switch(s){case Ho.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,Le.VIDEO,!0);break;case Ho.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,Le.AUDIO,!0);break;case Ho.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,Le.VIDEO,!1);break;case Ho.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,Le.AUDIO,!1)}}),this._gateway.signal.on(Gs.RESTART_ICE,async(e,t,s)=>{if(this.store.useP2P)try{const{direction:n,iceParameter:r}=e;n!==fa.SEND_ONLY||r?t(await this._p2pChannel.restartICE(n,r)):(this._p2pChannel.handleDisconnect(n),t())}catch(n){s(n)}}),this._gateway.signal.on(Gs.CANDIDATE,e=>{if(this.store.useP2P){const{candidate:t,direction:s}=e;this._p2pChannel.addRemoteCandidate(t,s)}}),this._p2pChannel.on(Xe.RequestP2PRestartICE,async(e,t,s)=>{try{const{direction:n}=e;t(await this._gateway.sendExtensionMessage(Gs.RESTART_ICE,e,n===fa.SEND_ONLY))}catch(n){s(n)}}),this._p2pChannel.on(Xe.LocalCandidate,e=>{this._gateway.sendExtensionMessage(Gs.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(Xe.RequestP2PMuteLocal,async(e,t,s)=>{try{await this._gateway.sendExtensionMessage(Gs.CONTROL,e,!0),t()}catch(n){s(n)}}),this._p2pChannel.on(Xe.RequestP2PUnmuteRemote,async(e,t,s)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():s(n)}else t()}),this._p2pChannel.on(Xe.RequestP2PMuteRemote,async(e,t,s)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():s(n)}else t()}),this._p2pChannel.on(Xe.StateChange,(e,t)=>{t===Yt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(Xe.PeerConnectionStateChange,e=>{const t=this._peerConnectionState;e!==t&&(this.safeEmit(St.PEERCONNECTION_STATE_CHANGE,e,t),this._peerConnectionState=e)}),this._p2pChannel.on(Xe.RequestMuteLocal,async(e,t,s)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():s(n)}else t()}),this._p2pChannel.on(Xe.RequestUnmuteLocal,async(e,t,s)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():s(n)}else t()}),this._p2pChannel.on(Xe.RequestRePublish,(e,t,s)=>{this.publish(e,!1).then(t).catch(s)}),this._p2pChannel.on(Xe.RequestRePublishDataChannel,(e,t,s)=>{Te.all(e.map(async n=>{const r=await this._p2pChannel.publishDataChannel([n]);try{r.forEach(i=>{this._uid&&this._gateway.publishDataChannel(this._uid,i,!0)})}catch(i){if(i.code!==A.DISCONNECT_P2P)throw i}})).then(t).catch(s)}),this._p2pChannel.on(Xe.RequestReSubscribe,async(e,t,s)=>{try{for(const{user:n,kind:r}of e)r===Le.VIDEO?await this.subscribe(n,"video"):await this.subscribe(n,"audio");t()}catch(n){s(n)}}),this._p2pChannel.on(Xe.RequestUpload,(e,t)=>{this._gateway.upload(e,t)}),this._p2pChannel.on(Xe.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(Xe.MediaReconnectStart,e=>{this.safeEmit(St.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(Xe.MediaReconnectEnd,e=>{this.safeEmit(St.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(Xe.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(Xe.RequestRestartICE,async e=>{if(this.store.useP2P)return;const t=await this._p2pChannel.restartICE(e),s=await t.next();if(s.done)return;const n=s.value;let r;try{r=await this._gateway.restartICE({iceParameters:n})}catch(o){return void t.throw(o)}const{iceParameters:i}=function(o){const c=o.iceParameters;return{iceParameters:{iceUfrag:c.iceUfrag,icePwd:c.icePwd}}}(r);await t.next({remoteIceParameters:i})}),this._p2pChannel.on(Xe.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(Xe.RequestReconnectPC,async()=>{var e;const{iceParameters:t,dtlsParameters:s,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:i}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:s,rtpCapabilities:n}),o=OD(r,i);await this._p2pChannel.connect(o),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(Xe.RequestUnpublishForReconnectPC,async(e,t,s)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):s()}),this._p2pChannel.on(Xe.P2PLost,()=>{this.safeEmit(St.P2P_LOST,this.store.uid)}),this._p2pChannel.on(Xe.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(Xe.ConnectionTypeChange,e=>{this.safeEmit(St.IS_USING_CLOUD_PROXY,e),this._gateway.setUsingProxy(e)}),this._p2pChannel.on(Xe.FirstVideoBufferReady,(e,t)=>{this.safeEmit(St.FIRST_VIDEO_BUFFER_READY,e,t)}),this._p2pChannel.on(Xe.FirstVideoPreRender,(e,t)=>{this.safeEmit(St.FIRST_VIDEO_PRE_RENDER,e,t)}),this._p2pChannel.on(Xe.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(Xe.QueryClientConnectionState,e=>{e(this.connectionState)}),this._p2pChannel.on(Xe.AudioMetadata,e=>{this.safeEmit(St.AUDIO_METADATA,e)}),this._p2pChannel.on(Xe.AudioPts,e=>{this.safeEmit(St.AUDIO_PTS,Number(e))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const s=(t={config:e},ci("ContentInspect").create(t));this._inspect=s,this.handleVideoInspectEvents(s);const{appId:n,cname:r,sid:i,token:o,uid:c,cid:l,vid:d}=this._joinInfo;await s.init({appId:n,areaCode:"",cname:r,sid:i,token:o,uid:c,cid:l,vid:d?Number(d):0},Ys)}catch(s){throw Array.isArray(s)?s[0]:s}var t}handleVideoInspectEvents(e){e.on(Nn.CONNECTION_STATE_CHANGE,(t,s)=>{if(this.safeEmit(St.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,s),s===Lr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(St.CONTENT_INSPECT_ERROR,new $(A.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Nn.INSPECT_RESULT,(t,s)=>{var n;if((s==null?void 0:s.code)===A.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return b.debug("Stop inspect content because that has left channel"),this==null||(n=this._inspect)===null||n===void 0||n.close(),void(this._inspect=void 0);this.safeEmit(St.CONTENT_INSPECT_RESULT,t,s)}),e.on(Nn.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(s=>s.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(Or(e,"enabled"),e){if(!t)throw new $(A.INVALID_PARAMS,"config is required");if(zk(t),!this._joinInfo)throw new $(A.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const n=(s={config:t},ci("ImageModeration").create(s));this._moderation=n,this.handleImageModerationEvents(n);const{appId:r,cname:i,sid:o,token:c,uid:l,cid:d,vid:h}=this._joinInfo;await n.init({appId:r,areaCode:"",cname:i,sid:o,token:c,uid:l,cid:d,vid:h?Number(h):0},Ys)}}catch(n){throw Array.isArray(n)?n[0]:n}}else{var s;if(!this._moderation)throw new $(A.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}}handleImageModerationEvents(e){e.on(oi.CONNECTION_STATE_CHANGE,(t,s)=>{if(this.safeEmit(St.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,s),t===mr.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new $(A.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(oi.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(s=>s.trackMediaType==="video")[0])})}setP2PTransport(e){if(function(t){Ks(t,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new $(A.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,b.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return b.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){Or(e,"enabled"),ss("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_setRteInfo(e,t){this.store.rteUrl=e,this.store.rteSid=t}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},Re(Pe.prototype,"leave",[Kk],Object.getOwnPropertyDescriptor(Pe.prototype,"leave"),Pe.prototype),Re(Pe.prototype,"publish",[Yk],Object.getOwnPropertyDescriptor(Pe.prototype,"publish"),Pe.prototype),Re(Pe.prototype,"unpublish",[qk],Object.getOwnPropertyDescriptor(Pe.prototype,"unpublish"),Pe.prototype),Re(Pe.prototype,"subscribe",[Xk],Object.getOwnPropertyDescriptor(Pe.prototype,"subscribe"),Pe.prototype),Re(Pe.prototype,"presubscribe",[Jk],Object.getOwnPropertyDescriptor(Pe.prototype,"presubscribe"),Pe.prototype),Re(Pe.prototype,"massSubscribe",[$k],Object.getOwnPropertyDescriptor(Pe.prototype,"massSubscribe"),Pe.prototype),Re(Pe.prototype,"unsubscribe",[Qk],Object.getOwnPropertyDescriptor(Pe.prototype,"unsubscribe"),Pe.prototype),Re(Pe.prototype,"massUnsubscribe",[Zk],Object.getOwnPropertyDescriptor(Pe.prototype,"massUnsubscribe"),Pe.prototype),Re(Pe.prototype,"setLowStreamParameter",[ej],Object.getOwnPropertyDescriptor(Pe.prototype,"setLowStreamParameter"),Pe.prototype),Re(Pe.prototype,"setDualStreamMode",[tj],Object.getOwnPropertyDescriptor(Pe.prototype,"setDualStreamMode"),Pe.prototype),Re(Pe.prototype,"enableDualStream",[sj],Object.getOwnPropertyDescriptor(Pe.prototype,"enableDualStream"),Pe.prototype),Re(Pe.prototype,"disableDualStream",[nj],Object.getOwnPropertyDescriptor(Pe.prototype,"disableDualStream"),Pe.prototype),Re(Pe.prototype,"setClientRole",[aj],Object.getOwnPropertyDescriptor(Pe.prototype,"setClientRole"),Pe.prototype),Re(Pe.prototype,"_setClientRoleOptions",[rj],Object.getOwnPropertyDescriptor(Pe.prototype,"_setClientRoleOptions"),Pe.prototype),Re(Pe.prototype,"setProxyServer",[ij],Object.getOwnPropertyDescriptor(Pe.prototype,"setProxyServer"),Pe.prototype),Re(Pe.prototype,"setTurnServer",[oj],Object.getOwnPropertyDescriptor(Pe.prototype,"setTurnServer"),Pe.prototype),Re(Pe.prototype,"setLicense",[cj],Object.getOwnPropertyDescriptor(Pe.prototype,"setLicense"),Pe.prototype),Re(Pe.prototype,"startProxyServer",[lj],Object.getOwnPropertyDescriptor(Pe.prototype,"startProxyServer"),Pe.prototype),Re(Pe.prototype,"stopProxyServer",[dj],Object.getOwnPropertyDescriptor(Pe.prototype,"stopProxyServer"),Pe.prototype),Re(Pe.prototype,"setLocalAccessPointsV2",[uj],Object.getOwnPropertyDescriptor(Pe.prototype,"setLocalAccessPointsV2"),Pe.prototype),Re(Pe.prototype,"setLocalAccessPoints",[hj],Object.getOwnPropertyDescriptor(Pe.prototype,"setLocalAccessPoints"),Pe.prototype),Re(Pe.prototype,"setRemoteDefaultVideoStreamType",[pj],Object.getOwnPropertyDescriptor(Pe.prototype,"setRemoteDefaultVideoStreamType"),Pe.prototype),Re(Pe.prototype,"setRemoteVideoStreamType",[mj],Object.getOwnPropertyDescriptor(Pe.prototype,"setRemoteVideoStreamType"),Pe.prototype),Re(Pe.prototype,"setStreamFallbackOption",[fj],Object.getOwnPropertyDescriptor(Pe.prototype,"setStreamFallbackOption"),Pe.prototype),Re(Pe.prototype,"setEncryptionConfig",[gj],Object.getOwnPropertyDescriptor(Pe.prototype,"setEncryptionConfig"),Pe.prototype),Re(Pe.prototype,"renewToken",[xj],Object.getOwnPropertyDescriptor(Pe.prototype,"renewToken"),Pe.prototype),Re(Pe.prototype,"enableAudioVolumeIndicator",[bj],Object.getOwnPropertyDescriptor(Pe.prototype,"enableAudioVolumeIndicator"),Pe.prototype),Re(Pe.prototype,"startLiveStreaming",[_j],Object.getOwnPropertyDescriptor(Pe.prototype,"startLiveStreaming"),Pe.prototype),Re(Pe.prototype,"setLiveTranscoding",[vj],Object.getOwnPropertyDescriptor(Pe.prototype,"setLiveTranscoding"),Pe.prototype),Re(Pe.prototype,"stopLiveStreaming",[Ej],Object.getOwnPropertyDescriptor(Pe.prototype,"stopLiveStreaming"),Pe.prototype),Re(Pe.prototype,"startChannelMediaRelay",[yj],Object.getOwnPropertyDescriptor(Pe.prototype,"startChannelMediaRelay"),Pe.prototype),Re(Pe.prototype,"updateChannelMediaRelay",[wj],Object.getOwnPropertyDescriptor(Pe.prototype,"updateChannelMediaRelay"),Pe.prototype),Re(Pe.prototype,"stopChannelMediaRelay",[Sj],Object.getOwnPropertyDescriptor(Pe.prototype,"stopChannelMediaRelay"),Pe.prototype),Re(Pe.prototype,"sendCustomReportMessage",[Nj],Object.getOwnPropertyDescriptor(Pe.prototype,"sendCustomReportMessage"),Pe.prototype),Re(Pe.prototype,"pickSVCLayer",[Tj],Object.getOwnPropertyDescriptor(Pe.prototype,"pickSVCLayer"),Pe.prototype),Re(Pe.prototype,"setRTMConfig",[Rj],Object.getOwnPropertyDescriptor(Pe.prototype,"setRTMConfig"),Pe.prototype),Re(Pe.prototype,"enableContentInspect",[Cj],Object.getOwnPropertyDescriptor(Pe.prototype,"enableContentInspect"),Pe.prototype),Re(Pe.prototype,"disableContentInspect",[Ij],Object.getOwnPropertyDescriptor(Pe.prototype,"disableContentInspect"),Pe.prototype),Re(Pe.prototype,"setImageModeration",[Aj],Object.getOwnPropertyDescriptor(Pe.prototype,"setImageModeration"),Pe.prototype),Re(Pe.prototype,"setP2PTransport",[Oj],Object.getOwnPropertyDescriptor(Pe.prototype,"setP2PTransport"),Pe.prototype),Re(Pe.prototype,"getJoinChannelServiceRecords",[Dj],Object.getOwnPropertyDescriptor(Pe.prototype,"getJoinChannelServiceRecords"),Pe.prototype),Re(Pe.prototype,"setPublishAudioFilterEnabled",[kj],Object.getOwnPropertyDescriptor(Pe.prototype,"setPublishAudioFilterEnabled"),Pe.prototype),Pe);function Pj(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const s=Jt(5,"client-"),n=Ue.reportApiInvoke(null,{id:s,name:Ns.CREATE_CLIENT,options:[t],tag:is.TRACER});try{(function(r){Ks(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Ks(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&Ks(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&An(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&pI(r.turnServer),r.httpRetryConfig!==void 0&&hI(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&hI(r.websocketRetryConfig)})(t)}catch(r){throw n.onError(r),r}return(ZC(16,0,!0)||Cb(16,0,!0))&&(t.codec==="vp9"&&(t.codec="vp8",b.debug("browser not support vp9, force use vp8")),ss("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),n.onSuccess(),new LK(Br(Br({forceWaitGatewayResponse:!0},t),{},{role:_e(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}),s)}function MK(){let e=!1;const t=Ft();return(t.name===Wt.CHROME&&Number(t.version)>=58&&(ti.engine.name!=="WebKit"||function(){const s=Ft();if(xm()){if(s.os===fn.MAC_OS)return!0;if(s.os===fn.IOS){const n=ti.os.version&&ti.os.version.split(".");if(n&&Number(n[0])===14&&n[1]&&Number(n[1])>=3||n&&Number(n[0])>14)return!0}}return!1}())||t.name===Wt.FIREFOX&&Number(t.version)>=56||t.name===Wt.OPERA&&Number(t.version)>=45||t.name===Wt.SAFARI&&Number(t.version)>=11||t.name==="WebKit"&&(Xn()||Ar())&&t.osVersion&&Number(t.osVersion.split(".")[0])>=11||sI()||Ft().name===Wt.QQ)&&(e=!0),e}class oh{constructor(t,s){N(this,"id",0),N(this,"element",void 0),N(this,"peerPair",void 0),N(this,"context",void 0),N(this,"audioPlayerElement",void 0),N(this,"audioTrack",void 0),oh.count+=1,this.id=oh.count,this.element=t,this.context=s}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const s=document.createElement("audio");s.srcObject=new MediaStream([t.track]),s.play(),this.audioPlayerElement=s}}async switchSdp(){if(!this.peerPair)return;const t=async(n,r)=>{const i=r==="offer"?await n.createOffer():await n.createAnswer();return await n.setLocalDescription(i),n.iceGatheringState==="complete"?n.localDescription:new Te(o=>{n.onicegatheringstatechange=()=>{n.iceGatheringState==="complete"&&o(n.localDescription)}})},s=async(n,r)=>await n.setRemoteDescription(r);try{const n=await t(this.peerPair[0],"offer");await s(this.peerPair[1],n);const r=await t(this.peerPair[1],"answer");await s(this.peerPair[0],r)}catch(n){throw new $(A.LOCAL_AEC_ERROR,n.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let s;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),s=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(s)}catch(r){throw new $(A.LOCAL_AEC_ERROR,r.toString()).print()}if(!s)throw new $(A.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=s.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,s=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(s),await this.switchSdp()}close(){b.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var Lj,yf;N(oh,"count",0);const UK=window.AudioContext||window.webkitAudioContext,VK=new(Lj=tt({report:Ue}),Re((yf=class{constructor(){N(this,"units",[]),N(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return b.debug("the system does not need to process local aec"),-1;this.context||(this.context=new UK);let t=this.units.find(s=>s&&s.getElement()===e);return t||(t=new oh(e,this.context),this.units.push(t)),t.startEchoCancellation(),b.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return Ft().name!==Wt.SAFARI}}).prototype,"processExternalMediaAEC",[Lj],Object.getOwnPropertyDescriptor(yf.prototype,"processExternalMediaAEC"),yf.prototype),yf);function Mj(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Uj(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?Mj(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Mj(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}const Ev=window||document;function Vj(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Ev)return;const s=Zs._cspEventHandlerPointer;if(s&&t)return void console.error(s,t);const n=r=>{if(!(r&&r.blockedURI&&(Zs.onSecurityPolicyViolation||Zs.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0)))return;const i=r.blockedURI;C("CSP_DETECTED_HOSTNAME_LIST").some(o=>_e(i).call(i,o))&&(Zs.onSecurityPolicyViolation&&typeof Zs.onSecurityPolicyViolation=="function"&&Zs.onSecurityPolicyViolation(r),Zs.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0&&Zs.safeEmit(Di.SECURITY_POLICY_VIOLATION,r))};s&&Ev.removeEventListener("securitypolicyviolation",s),(t||e&&typeof e=="function"||Zs.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0)&&Ev.addEventListener("securitypolicyviolation",n),Zs._cspEventHandlerPointer=n}var FK=X,BK=jx,Fj=RegExp.prototype,GK=function(e){return e===Fj||FK(Fj,e)?BK(e):e.flags},sa=E(GK);function Id(e){let t=e.length;for(;--t>=0;)e[t]=0}const yv=256,Bj=286,ch=30,lh=15,wv=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),wf=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),WK=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Gj=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),lo=new Array(576);Id(lo);const dh=new Array(60);Id(dh);const uh=new Array(512);Id(uh);const hh=new Array(256);Id(hh);const Sv=new Array(29);Id(Sv);const Sf=new Array(ch);function Nv(e,t,s,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=s,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}let Wj,Hj,zj;function Tv(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}Id(Sf);const Kj=e=>e<256?uh[e]:uh[256+(e>>>7)],ph=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},er=(e,t,s)=>{e.bi_valid>16-s?(e.bi_buf|=t<<e.bi_valid&65535,ph(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=s-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=s)},Ui=(e,t,s)=>{er(e,s[2*t],s[2*t+1])},Yj=(e,t)=>{let s=0;do s|=1&e,e>>>=1,s<<=1;while(--t>0);return s>>>1},qj=(e,t,s)=>{const n=new Array(16);let r,i,o=0;for(r=1;r<=lh;r++)o=o+s[r-1]<<1,n[r]=o;for(i=0;i<=t;i++){let c=e[2*i+1];c!==0&&(e[2*i]=Yj(n[c]++,c))}},Xj=e=>{let t;for(t=0;t<Bj;t++)e.dyn_ltree[2*t]=0;for(t=0;t<ch;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Jj=e=>{e.bi_valid>8?ph(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},$j=(e,t,s,n)=>{const r=2*t,i=2*s;return e[r]<e[i]||e[r]===e[i]&&n[t]<=n[s]},Rv=(e,t,s)=>{const n=e.heap[s];let r=s<<1;for(;r<=e.heap_len&&(r<e.heap_len&&$j(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!$j(t,n,e.heap[r],e.depth));)e.heap[s]=e.heap[r],s=r,r<<=1;e.heap[s]=n},Qj=(e,t,s)=>{let n,r,i,o,c=0;if(e.sym_next!==0)do n=255&e.pending_buf[e.sym_buf+c++],n+=(255&e.pending_buf[e.sym_buf+c++])<<8,r=e.pending_buf[e.sym_buf+c++],n===0?Ui(e,r,t):(i=hh[r],Ui(e,i+yv+1,t),o=wv[i],o!==0&&(r-=Sv[i],er(e,r,o)),n--,i=Kj(n),Ui(e,i,s),o=wf[i],o!==0&&(n-=Sf[i],er(e,n,o)));while(c<e.sym_next);Ui(e,256,t)},Cv=(e,t)=>{const s=t.dyn_tree,n=t.stat_desc.static_tree,r=t.stat_desc.has_stree,i=t.stat_desc.elems;let o,c,l,d=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<i;o++)s[2*o]!==0?(e.heap[++e.heap_len]=d=o,e.depth[o]=0):s[2*o+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=d<2?++d:0,s[2*l]=1,e.depth[l]=0,e.opt_len--,r&&(e.static_len-=n[2*l+1]);for(t.max_code=d,o=e.heap_len>>1;o>=1;o--)Rv(e,s,o);l=i;do o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Rv(e,s,1),c=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=c,s[2*l]=s[2*o]+s[2*c],e.depth[l]=(e.depth[o]>=e.depth[c]?e.depth[o]:e.depth[c])+1,s[2*o+1]=s[2*c+1]=l,e.heap[1]=l++,Rv(e,s,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((h,p)=>{const m=p.dyn_tree,g=p.max_code,T=p.stat_desc.static_tree,w=p.stat_desc.has_stree,S=p.stat_desc.extra_bits,I=p.stat_desc.extra_base,O=p.stat_desc.max_length;let M,z,K,V,Y,ce,xe=0;for(V=0;V<=lh;V++)h.bl_count[V]=0;for(m[2*h.heap[h.heap_max]+1]=0,M=h.heap_max+1;M<573;M++)z=h.heap[M],V=m[2*m[2*z+1]+1]+1,V>O&&(V=O,xe++),m[2*z+1]=V,z>g||(h.bl_count[V]++,Y=0,z>=I&&(Y=S[z-I]),ce=m[2*z],h.opt_len+=ce*(V+Y),w&&(h.static_len+=ce*(T[2*z+1]+Y)));if(xe!==0){do{for(V=O-1;h.bl_count[V]===0;)V--;h.bl_count[V]--,h.bl_count[V+1]+=2,h.bl_count[O]--,xe-=2}while(xe>0);for(V=O;V!==0;V--)for(z=h.bl_count[V];z!==0;)K=h.heap[--M],K>g||(m[2*K+1]!==V&&(h.opt_len+=(V-m[2*K+1])*m[2*K],m[2*K+1]=V),z--)}})(e,t),qj(s,d,e.bl_count)},Zj=(e,t,s)=>{let n,r,i=-1,o=t[1],c=0,l=7,d=4;for(o===0&&(l=138,d=3),t[2*(s+1)+1]=65535,n=0;n<=s;n++)r=o,o=t[2*(n+1)+1],++c<l&&r===o||(c<d?e.bl_tree[2*r]+=c:r!==0?(r!==i&&e.bl_tree[2*r]++,e.bl_tree[32]++):c<=10?e.bl_tree[34]++:e.bl_tree[36]++,c=0,i=r,o===0?(l=138,d=3):r===o?(l=6,d=3):(l=7,d=4))},e1=(e,t,s)=>{let n,r,i=-1,o=t[1],c=0,l=7,d=4;for(o===0&&(l=138,d=3),n=0;n<=s;n++)if(r=o,o=t[2*(n+1)+1],!(++c<l&&r===o)){if(c<d)do Ui(e,r,e.bl_tree);while(--c!=0);else r!==0?(r!==i&&(Ui(e,r,e.bl_tree),c--),Ui(e,16,e.bl_tree),er(e,c-3,2)):c<=10?(Ui(e,17,e.bl_tree),er(e,c-3,3)):(Ui(e,18,e.bl_tree),er(e,c-11,7));c=0,i=r,o===0?(l=138,d=3):r===o?(l=6,d=3):(l=7,d=4)}};let t1=!1;const s1=(e,t,s,n)=>{er(e,0+(n?1:0),3),Jj(e),ph(e,s),ph(e,~s),s&&e.pending_buf.set(e.window.subarray(t,t+s),e.pending),e.pending+=s};var HK=e=>{t1||((()=>{let t,s,n,r,i;const o=new Array(16);for(n=0,r=0;r<28;r++)for(Sv[r]=n,t=0;t<1<<wv[r];t++)hh[n++]=r;for(hh[n-1]=r,i=0,r=0;r<16;r++)for(Sf[r]=i,t=0;t<1<<wf[r];t++)uh[i++]=r;for(i>>=7;r<ch;r++)for(Sf[r]=i<<7,t=0;t<1<<wf[r]-7;t++)uh[256+i++]=r;for(s=0;s<=lh;s++)o[s]=0;for(t=0;t<=143;)lo[2*t+1]=8,t++,o[8]++;for(;t<=255;)lo[2*t+1]=9,t++,o[9]++;for(;t<=279;)lo[2*t+1]=7,t++,o[7]++;for(;t<=287;)lo[2*t+1]=8,t++,o[8]++;for(qj(lo,287,o),t=0;t<ch;t++)dh[2*t+1]=5,dh[2*t]=Yj(t,5);Wj=new Nv(lo,wv,257,Bj,lh),Hj=new Nv(dh,wf,0,ch,lh),zj=new Nv(new Array(0),WK,0,19,7)})(),t1=!0),e.l_desc=new Tv(e.dyn_ltree,Wj),e.d_desc=new Tv(e.dyn_dtree,Hj),e.bl_desc=new Tv(e.bl_tree,zj),e.bi_buf=0,e.bi_valid=0,Xj(e)},zK=(e,t,s,n)=>{let r,i,o=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(c=>{let l,d=4093624447;for(l=0;l<=31;l++,d>>>=1)if(1&d&&c.dyn_ltree[2*l]!==0)return 0;if(c.dyn_ltree[18]!==0||c.dyn_ltree[20]!==0||c.dyn_ltree[26]!==0)return 1;for(l=32;l<yv;l++)if(c.dyn_ltree[2*l]!==0)return 1;return 0})(e)),Cv(e,e.l_desc),Cv(e,e.d_desc),o=(c=>{let l;for(Zj(c,c.dyn_ltree,c.l_desc.max_code),Zj(c,c.dyn_dtree,c.d_desc.max_code),Cv(c,c.bl_desc),l=18;l>=3&&c.bl_tree[2*Gj[l]+1]===0;l--);return c.opt_len+=3*(l+1)+5+5+4,l})(e),r=e.opt_len+3+7>>>3,i=e.static_len+3+7>>>3,i<=r&&(r=i)):r=i=s+5,s+4<=r&&t!==-1?s1(e,t,s,n):e.strategy===4||i===r?(er(e,2+(n?1:0),3),Qj(e,lo,dh)):(er(e,4+(n?1:0),3),((c,l,d,h)=>{let p;for(er(c,l-257,5),er(c,d-1,5),er(c,h-4,4),p=0;p<h;p++)er(c,c.bl_tree[2*Gj[p]+1],3);e1(c,c.dyn_ltree,l-1),e1(c,c.dyn_dtree,d-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),Qj(e,e.dyn_ltree,e.dyn_dtree)),Xj(e),n&&Jj(e)},KK=(e,t,s)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=s,t===0?e.dyn_ltree[2*s]++:(e.matches++,t--,e.dyn_ltree[2*(hh[s]+yv+1)]++,e.dyn_dtree[2*Kj(t)]++),e.sym_next===e.sym_end),YK=e=>{er(e,2,3),Ui(e,256,lo),(t=>{t.bi_valid===16?(ph(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},qK={_tr_init:HK,_tr_stored_block:s1,_tr_flush_block:zK,_tr_tally:KK,_tr_align:YK},mh=(e,t,s,n)=>{let r=65535&e|0,i=e>>>16&65535|0,o=0;for(;s!==0;){o=s>2e3?2e3:s,s-=o;do r=r+t[n++]|0,i=i+r|0;while(--o);r%=65521,i%=65521}return r|i<<16|0};const XK=new Uint32Array((()=>{let e,t=[];for(var s=0;s<256;s++){e=s;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[s]=e}return t})());var ga=(e,t,s,n)=>{const r=XK,i=n+s;e^=-1;for(let o=n;o<i;o++)e=e>>>8^r[255&(e^t[o])];return-1^e},Qc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Nf={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:JK,_tr_stored_block:Iv,_tr_flush_block:$K,_tr_tally:$o,_tr_align:QK}=qK,{Z_NO_FLUSH:Qo,Z_PARTIAL_FLUSH:ZK,Z_FULL_FLUSH:e9,Z_FINISH:Gr,Z_BLOCK:n1,Z_OK:Sa,Z_STREAM_END:a1,Z_STREAM_ERROR:Vi,Z_DATA_ERROR:t9,Z_BUF_ERROR:Av,Z_DEFAULT_COMPRESSION:s9,Z_FILTERED:n9,Z_HUFFMAN_ONLY:Tf,Z_RLE:a9,Z_FIXED:r9,Z_DEFAULT_STRATEGY:i9,Z_UNKNOWN:o9,Z_DEFLATED:Rf}=Nf,Ov=286,c9=30,l9=19,d9=2*Ov+1,u9=15,Zc=258,Fi=262,Ad=42,el=113,fh=666,tl=(e,t)=>(e.msg=Qc[t],t),r1=e=>2*e-(e>4?9:0),Zo=e=>{let t=e.length;for(;--t>=0;)e[t]=0},h9=e=>{let t,s,n,r=e.w_size;t=e.hash_size,n=t;do s=e.head[--n],e.head[n]=s>=r?s-r:0;while(--t);t=r,n=t;do s=e.prev[--n],e.prev[n]=s>=r?s-r:0;while(--t)};let ec=(e,t,s)=>(t<<e.hash_shift^s)&e.hash_mask;const fr=e=>{const t=e.state;let s=t.pending;s>e.avail_out&&(s=e.avail_out),s!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+s),e.next_out),e.next_out+=s,t.pending_out+=s,e.total_out+=s,e.avail_out-=s,t.pending-=s,t.pending===0&&(t.pending_out=0))},gr=(e,t)=>{$K(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,fr(e.strm)},Vs=(e,t)=>{e.pending_buf[e.pending++]=t},gh=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Dv=(e,t,s,n)=>{let r=e.avail_in;return r>n&&(r=n),r===0?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),s),e.state.wrap===1?e.adler=mh(e.adler,t,r,s):e.state.wrap===2&&(e.adler=ga(e.adler,t,r,s)),e.next_in+=r,e.total_in+=r,r)},i1=(e,t)=>{let s,n,r=e.max_chain_length,i=e.strstart,o=e.prev_length,c=e.nice_match;const l=e.strstart>e.w_size-Fi?e.strstart-(e.w_size-Fi):0,d=e.window,h=e.w_mask,p=e.prev,m=e.strstart+Zc;let g=d[i+o-1],T=d[i+o];e.prev_length>=e.good_match&&(r>>=2),c>e.lookahead&&(c=e.lookahead);do if(s=t,d[s+o]===T&&d[s+o-1]===g&&d[s]===d[i]&&d[++s]===d[i+1]){i+=2,s++;do;while(d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&d[++i]===d[++s]&&i<m);if(n=Zc-(m-i),i=m-Zc,n>o){if(e.match_start=t,o=n,n>=c)break;g=d[i+o-1],T=d[i+o]}}while((t=p[t&h])>l&&--r!=0);return o<=e.lookahead?o:e.lookahead},Od=e=>{const t=e.w_size;let s,n,r;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Fi)&&(e.window.set(e.window.subarray(t,t+t-n),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),h9(e),n+=t),e.strm.avail_in===0)break;if(s=Dv(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=s,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=ec(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=ec(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Fi&&e.strm.avail_in!==0)},o1=(e,t)=>{let s,n,r,i=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,c=e.strm.avail_in;do{if(s=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r||(r=e.strm.avail_out-r,n=e.strstart-e.block_start,s>n+e.strm.avail_in&&(s=n+e.strm.avail_in),s>r&&(s=r),s<i&&(s===0&&t!==Gr||t===Qo||s!==n+e.strm.avail_in)))break;o=t===Gr&&s===n+e.strm.avail_in?1:0,Iv(e,0,0,o),e.pending_buf[e.pending-4]=s,e.pending_buf[e.pending-3]=s>>8,e.pending_buf[e.pending-2]=~s,e.pending_buf[e.pending-1]=~s>>8,fr(e.strm),n&&(n>s&&(n=s),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+n),e.strm.next_out),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n,e.block_start+=n,s-=n),s&&(Dv(e.strm,e.strm.output,e.strm.next_out,s),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s)}while(o===0);return c-=e.strm.avail_in,c&&(c>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=c&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-c,e.strm.next_in),e.strstart),e.strstart+=c,e.insert+=c>e.w_size-e.insert?e.w_size-e.insert:c),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==Qo&&t!==Gr&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(Dv(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,i=r>e.w_size?e.w_size:r,n=e.strstart-e.block_start,(n>=i||(n||t===Gr)&&t!==Qo&&e.strm.avail_in===0&&n<=r)&&(s=n>r?r:n,o=t===Gr&&e.strm.avail_in===0&&s===n?1:0,Iv(e,e.block_start,s,o),e.block_start+=s,fr(e.strm)),o?3:1)},kv=(e,t)=>{let s,n;for(;;){if(e.lookahead<Fi){if(Od(e),e.lookahead<Fi&&t===Qo)return 1;if(e.lookahead===0)break}if(s=0,e.lookahead>=3&&(e.ins_h=ec(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),s!==0&&e.strstart-s<=e.w_size-Fi&&(e.match_length=i1(e,s)),e.match_length>=3)if(n=$o(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=ec(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=ec(e,e.ins_h,e.window[e.strstart+1]);else n=$o(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(gr(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Gr?(gr(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(gr(e,!1),e.strm.avail_out===0)?1:2},Dd=(e,t)=>{let s,n,r;for(;;){if(e.lookahead<Fi){if(Od(e),e.lookahead<Fi&&t===Qo)return 1;if(e.lookahead===0)break}if(s=0,e.lookahead>=3&&(e.ins_h=ec(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,s!==0&&e.prev_length<e.max_lazy_match&&e.strstart-s<=e.w_size-Fi&&(e.match_length=i1(e,s),e.match_length<=5&&(e.strategy===n9||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,n=$o(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=r&&(e.ins_h=ec(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(gr(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(n=$o(e,0,e.window[e.strstart-1]),n&&gr(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=$o(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Gr?(gr(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(gr(e,!1),e.strm.avail_out===0)?1:2};function Bi(e,t,s,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=s,this.max_chain=n,this.func=r}const xh=[new Bi(0,0,0,0,o1),new Bi(4,4,8,4,kv),new Bi(4,5,16,8,kv),new Bi(4,6,32,32,kv),new Bi(4,4,16,16,Dd),new Bi(8,16,32,32,Dd),new Bi(8,16,128,128,Dd),new Bi(8,32,128,256,Dd),new Bi(32,128,258,1024,Dd),new Bi(32,258,258,4096,Dd)];function p9(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Rf,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*d9),this.dyn_dtree=new Uint16Array(2*(2*c9+1)),this.bl_tree=new Uint16Array(2*(2*l9+1)),Zo(this.dyn_ltree),Zo(this.dyn_dtree),Zo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(u9+1),this.heap=new Uint16Array(2*Ov+1),Zo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Ov+1),Zo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const bh=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Ad&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==el&&t.status!==fh?1:0},c1=e=>{if(bh(e))return tl(e,Vi);e.total_in=e.total_out=0,e.data_type=o9;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Ad:el,e.adler=t.wrap===2?0:1,t.last_flush=-2,JK(t),Sa},l1=e=>{const t=c1(e);return t===Sa&&(s=>{s.window_size=2*s.w_size,Zo(s.head),s.max_lazy_match=xh[s.level].max_lazy,s.good_match=xh[s.level].good_length,s.nice_match=xh[s.level].nice_length,s.max_chain_length=xh[s.level].max_chain,s.strstart=0,s.block_start=0,s.lookahead=0,s.insert=0,s.match_length=s.prev_length=2,s.match_available=0,s.ins_h=0})(e.state),t},d1=(e,t,s,n,r,i)=>{if(!e)return Vi;let o=1;if(t===s9&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),r<1||r>9||s!==Rf||n<8||n>15||t<0||t>9||i<0||i>r9||n===8&&o!==1)return tl(e,Vi);n===8&&(n=9);const c=new p9;return e.state=c,c.strm=e,c.status=Ad,c.wrap=o,c.gzhead=null,c.w_bits=n,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=r+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new Uint8Array(2*c.w_size),c.head=new Uint16Array(c.hash_size),c.prev=new Uint16Array(c.w_size),c.lit_bufsize=1<<r+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new Uint8Array(c.pending_buf_size),c.sym_buf=c.lit_bufsize,c.sym_end=3*(c.lit_bufsize-1),c.level=t,c.strategy=i,c.method=s,l1(e)};var m9=(e,t)=>{if(bh(e)||t>n1||t<0)return e?tl(e,Vi):Vi;const s=e.state;if(!e.output||e.avail_in!==0&&!e.input||s.status===fh&&t!==Gr)return tl(e,e.avail_out===0?Av:Vi);const n=s.last_flush;if(s.last_flush=t,s.pending!==0){if(fr(e),e.avail_out===0)return s.last_flush=-1,Sa}else if(e.avail_in===0&&r1(t)<=r1(n)&&t!==Gr)return tl(e,Av);if(s.status===fh&&e.avail_in!==0)return tl(e,Av);if(s.status===Ad&&s.wrap===0&&(s.status=el),s.status===Ad){let r=Rf+(s.w_bits-8<<4)<<8,i=-1;if(i=s.strategy>=Tf||s.level<2?0:s.level<6?1:s.level===6?2:3,r|=i<<6,s.strstart!==0&&(r|=32),r+=31-r%31,gh(s,r),s.strstart!==0&&(gh(s,e.adler>>>16),gh(s,65535&e.adler)),e.adler=1,s.status=el,fr(e),s.pending!==0)return s.last_flush=-1,Sa}if(s.status===57){if(e.adler=0,Vs(s,31),Vs(s,139),Vs(s,8),s.gzhead)Vs(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),Vs(s,255&s.gzhead.time),Vs(s,s.gzhead.time>>8&255),Vs(s,s.gzhead.time>>16&255),Vs(s,s.gzhead.time>>24&255),Vs(s,s.level===9?2:s.strategy>=Tf||s.level<2?4:0),Vs(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(Vs(s,255&s.gzhead.extra.length),Vs(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(e.adler=ga(e.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69;else if(Vs(s,0),Vs(s,0),Vs(s,0),Vs(s,0),Vs(s,0),Vs(s,s.level===9?2:s.strategy>=Tf||s.level<2?4:0),Vs(s,3),s.status=el,fr(e),s.pending!==0)return s.last_flush=-1,Sa}if(s.status===69){if(s.gzhead.extra){let r=s.pending,i=(65535&s.gzhead.extra.length)-s.gzindex;for(;s.pending+i>s.pending_buf_size;){let c=s.pending_buf_size-s.pending;if(s.pending_buf.set(s.gzhead.extra.subarray(s.gzindex,s.gzindex+c),s.pending),s.pending=s.pending_buf_size,s.gzhead.hcrc&&s.pending>r&&(e.adler=ga(e.adler,s.pending_buf,s.pending-r,r)),s.gzindex+=c,fr(e),s.pending!==0)return s.last_flush=-1,Sa;r=0,i-=c}let o=new Uint8Array(s.gzhead.extra);s.pending_buf.set(o.subarray(s.gzindex,s.gzindex+i),s.pending),s.pending+=i,s.gzhead.hcrc&&s.pending>r&&(e.adler=ga(e.adler,s.pending_buf,s.pending-r,r)),s.gzindex=0}s.status=73}if(s.status===73){if(s.gzhead.name){let r,i=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>i&&(e.adler=ga(e.adler,s.pending_buf,s.pending-i,i)),fr(e),s.pending!==0)return s.last_flush=-1,Sa;i=0}r=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,Vs(s,r)}while(r!==0);s.gzhead.hcrc&&s.pending>i&&(e.adler=ga(e.adler,s.pending_buf,s.pending-i,i)),s.gzindex=0}s.status=91}if(s.status===91){if(s.gzhead.comment){let r,i=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>i&&(e.adler=ga(e.adler,s.pending_buf,s.pending-i,i)),fr(e),s.pending!==0)return s.last_flush=-1,Sa;i=0}r=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,Vs(s,r)}while(r!==0);s.gzhead.hcrc&&s.pending>i&&(e.adler=ga(e.adler,s.pending_buf,s.pending-i,i))}s.status=103}if(s.status===103){if(s.gzhead.hcrc){if(s.pending+2>s.pending_buf_size&&(fr(e),s.pending!==0))return s.last_flush=-1,Sa;Vs(s,255&e.adler),Vs(s,e.adler>>8&255),e.adler=0}if(s.status=el,fr(e),s.pending!==0)return s.last_flush=-1,Sa}if(e.avail_in!==0||s.lookahead!==0||t!==Qo&&s.status!==fh){let r=s.level===0?o1(s,t):s.strategy===Tf?((i,o)=>{let c;for(;;){if(i.lookahead===0&&(Od(i),i.lookahead===0)){if(o===Qo)return 1;break}if(i.match_length=0,c=$o(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++,c&&(gr(i,!1),i.strm.avail_out===0))return 1}return i.insert=0,o===Gr?(gr(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&(gr(i,!1),i.strm.avail_out===0)?1:2})(s,t):s.strategy===a9?((i,o)=>{let c,l,d,h;const p=i.window;for(;;){if(i.lookahead<=Zc){if(Od(i),i.lookahead<=Zc&&o===Qo)return 1;if(i.lookahead===0)break}if(i.match_length=0,i.lookahead>=3&&i.strstart>0&&(d=i.strstart-1,l=p[d],l===p[++d]&&l===p[++d]&&l===p[++d])){h=i.strstart+Zc;do;while(l===p[++d]&&l===p[++d]&&l===p[++d]&&l===p[++d]&&l===p[++d]&&l===p[++d]&&l===p[++d]&&l===p[++d]&&d<h);i.match_length=Zc-(h-d),i.match_length>i.lookahead&&(i.match_length=i.lookahead)}if(i.match_length>=3?(c=$o(i,1,i.match_length-3),i.lookahead-=i.match_length,i.strstart+=i.match_length,i.match_length=0):(c=$o(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++),c&&(gr(i,!1),i.strm.avail_out===0))return 1}return i.insert=0,o===Gr?(gr(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&(gr(i,!1),i.strm.avail_out===0)?1:2})(s,t):xh[s.level].func(s,t);if(r!==3&&r!==4||(s.status=fh),r===1||r===3)return e.avail_out===0&&(s.last_flush=-1),Sa;if(r===2&&(t===ZK?QK(s):t!==n1&&(Iv(s,0,0,!1),t===e9&&(Zo(s.head),s.lookahead===0&&(s.strstart=0,s.block_start=0,s.insert=0))),fr(e),e.avail_out===0))return s.last_flush=-1,Sa}return t!==Gr?Sa:s.wrap<=0?a1:(s.wrap===2?(Vs(s,255&e.adler),Vs(s,e.adler>>8&255),Vs(s,e.adler>>16&255),Vs(s,e.adler>>24&255),Vs(s,255&e.total_in),Vs(s,e.total_in>>8&255),Vs(s,e.total_in>>16&255),Vs(s,e.total_in>>24&255)):(gh(s,e.adler>>>16),gh(s,65535&e.adler)),fr(e),s.wrap>0&&(s.wrap=-s.wrap),s.pending!==0?Sa:a1)},f9=(e,t)=>{let s=t.length;if(bh(e))return Vi;const n=e.state,r=n.wrap;if(r===2||r===1&&n.status!==Ad||n.lookahead)return Vi;if(r===1&&(e.adler=mh(e.adler,t,s,0)),n.wrap=0,s>=n.w_size){r===0&&(Zo(n.head),n.strstart=0,n.block_start=0,n.insert=0);let l=new Uint8Array(n.w_size);l.set(t.subarray(s-n.w_size,s),0),t=l,s=n.w_size}const i=e.avail_in,o=e.next_in,c=e.input;for(e.avail_in=s,e.next_in=0,e.input=t,Od(n);n.lookahead>=3;){let l=n.strstart,d=n.lookahead-2;do n.ins_h=ec(n,n.ins_h,n.window[l+3-1]),n.prev[l&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=l,l++;while(--d);n.strstart=l,n.lookahead=2,Od(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=o,e.input=c,e.avail_in=i,n.wrap=r,Sa},_h={deflateInit:(e,t)=>d1(e,t,Rf,15,8,i9),deflateInit2:d1,deflateReset:l1,deflateResetKeep:c1,deflateSetHeader:(e,t)=>bh(e)||e.state.wrap!==2?Vi:(e.state.gzhead=t,Sa),deflate:m9,deflateEnd:e=>{if(bh(e))return Vi;const t=e.state.status;return e.state=null,t===el?tl(e,t9):Sa},deflateSetDictionary:f9,deflateInfo:"pako deflate (from Nodeca project)"};const g9=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Cf={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const s=t.shift();if(s){if(typeof s!="object")throw new TypeError(s+"must be non-object");for(const n in s)g9(s,n)&&(e[n]=s[n])}}return e},flattenChunks:e=>{let t=0;for(let n=0,r=e.length;n<r;n++)t+=e[n].length;const s=new Uint8Array(t);for(let n=0,r=0,i=e.length;n<i;n++){let o=e[n];s.set(o,r),r+=o.length}return s}};let u1=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{u1=!1}const vh=new Uint8Array(256);for(let e=0;e<256;e++)vh[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;vh[254]=vh[254]=1;var Eh={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,s,n,r,i,o=e.length,c=0;for(r=0;r<o;r++)s=e.charCodeAt(r),(64512&s)==55296&&r+1<o&&(n=e.charCodeAt(r+1),(64512&n)==56320&&(s=65536+(s-55296<<10)+(n-56320),r++)),c+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Uint8Array(c),i=0,r=0;i<c;r++)s=e.charCodeAt(r),(64512&s)==55296&&r+1<o&&(n=e.charCodeAt(r+1),(64512&n)==56320&&(s=65536+(s-55296<<10)+(n-56320),r++)),s<128?t[i++]=s:s<2048?(t[i++]=192|s>>>6,t[i++]=128|63&s):s<65536?(t[i++]=224|s>>>12,t[i++]=128|s>>>6&63,t[i++]=128|63&s):(t[i++]=240|s>>>18,t[i++]=128|s>>>12&63,t[i++]=128|s>>>6&63,t[i++]=128|63&s);return t},buf2string:(e,t)=>{const s=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let n,r;const i=new Array(2*s);for(r=0,n=0;n<s;){let o=e[n++];if(o<128){i[r++]=o;continue}let c=vh[o];if(c>4)i[r++]=65533,n+=c-1;else{for(o&=c===2?31:c===3?15:7;c>1&&n<s;)o=o<<6|63&e[n++],c--;c>1?i[r++]=65533:o<65536?i[r++]=o:(o-=65536,i[r++]=55296|o>>10&1023,i[r++]=56320|1023&o)}}return((o,c)=>{if(c<65534&&o.subarray&&u1)return String.fromCharCode.apply(null,o.length===c?o:o.subarray(0,c));let l="";for(let d=0;d<c;d++)l+=String.fromCharCode(o[d]);return l})(i,r)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let s=t-1;for(;s>=0&&(192&e[s])==128;)s--;return s<0||s===0?t:s+vh[e[s]]>t?s:t}},h1=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const p1=Object.prototype.toString,{Z_NO_FLUSH:x9,Z_SYNC_FLUSH:b9,Z_FULL_FLUSH:_9,Z_FINISH:v9,Z_OK:If,Z_STREAM_END:E9,Z_DEFAULT_COMPRESSION:y9,Z_DEFAULT_STRATEGY:w9,Z_DEFLATED:S9}=Nf;function Af(e){this.options=Cf.assign({level:y9,method:S9,chunkSize:16384,windowBits:15,memLevel:8,strategy:w9},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h1,this.strm.avail_out=0;let s=_h.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(s!==If)throw new Error(Qc[s]);if(t.header&&_h.deflateSetHeader(this.strm,t.header),t.dictionary){let n;if(n=typeof t.dictionary=="string"?Eh.string2buf(t.dictionary):p1.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,s=_h.deflateSetDictionary(this.strm,n),s!==If)throw new Error(Qc[s]);this._dict_set=!0}}function m1(e,t){const s=new Af(t);if(s.push(e,!0),s.err)throw s.msg||Qc[s.err];return s.result}Af.prototype.push=function(e,t){const s=this.strm,n=this.options.chunkSize;let r,i;if(this.ended)return!1;for(i=t===~~t?t:t===!0?v9:x9,typeof e=="string"?s.input=Eh.string2buf(e):p1.call(e)==="[object ArrayBuffer]"?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;)if(s.avail_out===0&&(s.output=new Uint8Array(n),s.next_out=0,s.avail_out=n),(i===b9||i===_9)&&s.avail_out<=6)this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;else{if(r=_h.deflate(s,i),r===E9)return s.next_out>0&&this.onData(s.output.subarray(0,s.next_out)),r=_h.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===If;if(s.avail_out!==0){if(i>0&&s.next_out>0)this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;else if(s.avail_in===0)break}else this.onData(s.output)}return!0},Af.prototype.onData=function(e){this.chunks.push(e)},Af.prototype.onEnd=function(e){e===If&&(this.result=Cf.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var N9={deflate:m1,deflateRaw:function(e,t){return(t=t||{}).raw=!0,m1(e,t)}};const Of=16209;var T9=function(e,t){let s,n,r,i,o,c,l,d,h,p,m,g,T,w,S,I,O,M,z,K,V,Y,ce,xe;const ke=e.state;s=e.next_in,ce=e.input,n=s+(e.avail_in-5),r=e.next_out,xe=e.output,i=r-(t-e.avail_out),o=r+(e.avail_out-257),c=ke.dmax,l=ke.wsize,d=ke.whave,h=ke.wnext,p=ke.window,m=ke.hold,g=ke.bits,T=ke.lencode,w=ke.distcode,S=(1<<ke.lenbits)-1,I=(1<<ke.distbits)-1;e:do{g<15&&(m+=ce[s++]<<g,g+=8,m+=ce[s++]<<g,g+=8),O=T[m&S];t:for(;;){if(M=O>>>24,m>>>=M,g-=M,M=O>>>16&255,M===0)xe[r++]=65535&O;else{if(!(16&M)){if(!(64&M)){O=T[(65535&O)+(m&(1<<M)-1)];continue t}if(32&M){ke.mode=16191;break e}e.msg="invalid literal/length code",ke.mode=Of;break e}z=65535&O,M&=15,M&&(g<M&&(m+=ce[s++]<<g,g+=8),z+=m&(1<<M)-1,m>>>=M,g-=M),g<15&&(m+=ce[s++]<<g,g+=8,m+=ce[s++]<<g,g+=8),O=w[m&I];s:for(;;){if(M=O>>>24,m>>>=M,g-=M,M=O>>>16&255,!(16&M)){if(!(64&M)){O=w[(65535&O)+(m&(1<<M)-1)];continue s}e.msg="invalid distance code",ke.mode=Of;break e}if(K=65535&O,M&=15,g<M&&(m+=ce[s++]<<g,g+=8,g<M&&(m+=ce[s++]<<g,g+=8)),K+=m&(1<<M)-1,K>c){e.msg="invalid distance too far back",ke.mode=Of;break e}if(m>>>=M,g-=M,M=r-i,K>M){if(M=K-M,M>d&&ke.sane){e.msg="invalid distance too far back",ke.mode=Of;break e}if(V=0,Y=p,h===0){if(V+=l-M,M<z){z-=M;do xe[r++]=p[V++];while(--M);V=r-K,Y=xe}}else if(h<M){if(V+=l+h-M,M-=h,M<z){z-=M;do xe[r++]=p[V++];while(--M);if(V=0,h<z){M=h,z-=M;do xe[r++]=p[V++];while(--M);V=r-K,Y=xe}}}else if(V+=h-M,M<z){z-=M;do xe[r++]=p[V++];while(--M);V=r-K,Y=xe}for(;z>2;)xe[r++]=Y[V++],xe[r++]=Y[V++],xe[r++]=Y[V++],z-=3;z&&(xe[r++]=Y[V++],z>1&&(xe[r++]=Y[V++]))}else{V=r-K;do xe[r++]=xe[V++],xe[r++]=xe[V++],xe[r++]=xe[V++],z-=3;while(z>2);z&&(xe[r++]=xe[V++],z>1&&(xe[r++]=xe[V++]))}break}}break}}while(s<n&&r<o);z=g>>3,s-=z,g-=z<<3,m&=(1<<g)-1,e.next_in=s,e.next_out=r,e.avail_in=s<n?n-s+5:5-(s-n),e.avail_out=r<o?o-r+257:257-(r-o),ke.hold=m,ke.bits=g};const Df=15,R9=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),C9=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),I9=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),A9=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var yh=(e,t,s,n,r,i,o,c)=>{const l=c.bits;let d,h,p,m,g,T,w=0,S=0,I=0,O=0,M=0,z=0,K=0,V=0,Y=0,ce=0,xe=null;const ke=new Uint16Array(16),lt=new Uint16Array(16);let at,Et,xt,Ht=null;for(w=0;w<=Df;w++)ke[w]=0;for(S=0;S<n;S++)ke[t[s+S]]++;for(M=l,O=Df;O>=1&&ke[O]===0;O--);if(M>O&&(M=O),O===0)return r[i++]=20971520,r[i++]=20971520,c.bits=1,0;for(I=1;I<O&&ke[I]===0;I++);for(M<I&&(M=I),V=1,w=1;w<=Df;w++)if(V<<=1,V-=ke[w],V<0)return-1;if(V>0&&(e===0||O!==1))return-1;for(lt[1]=0,w=1;w<Df;w++)lt[w+1]=lt[w]+ke[w];for(S=0;S<n;S++)t[s+S]!==0&&(o[lt[t[s+S]]++]=S);if(e===0?(xe=Ht=o,T=20):e===1?(xe=R9,Ht=C9,T=257):(xe=I9,Ht=A9,T=0),ce=0,S=0,w=I,g=i,z=M,K=0,p=-1,Y=1<<M,m=Y-1,e===1&&Y>852||e===2&&Y>592)return 1;for(;;){at=w-K,o[S]+1<T?(Et=0,xt=o[S]):o[S]>=T?(Et=Ht[o[S]-T],xt=xe[o[S]-T]):(Et=96,xt=0),d=1<<w-K,h=1<<z,I=h;do h-=d,r[g+(ce>>K)+h]=at<<24|Et<<16|xt|0;while(h!==0);for(d=1<<w-1;ce&d;)d>>=1;if(d!==0?(ce&=d-1,ce+=d):ce=0,S++,--ke[w]==0){if(w===O)break;w=t[s+o[S]]}if(w>M&&(ce&m)!==p){for(K===0&&(K=M),g+=I,z=w-K,V=1<<z;z+K<O&&(V-=ke[z+K],!(V<=0));)z++,V<<=1;if(Y+=1<<z,e===1&&Y>852||e===2&&Y>592)return 1;p=ce&m,r[p]=M<<24|z<<16|g-i|0}}return ce!==0&&(r[g+ce]=w-K<<24|64<<16|0),c.bits=M,0};const{Z_FINISH:f1,Z_BLOCK:O9,Z_TREES:kf,Z_OK:sl,Z_STREAM_END:D9,Z_NEED_DICT:k9,Z_STREAM_ERROR:Wr,Z_DATA_ERROR:g1,Z_MEM_ERROR:x1,Z_BUF_ERROR:j9,Z_DEFLATED:b1}=Nf,jf=16180,Pf=16190,uo=16191,jv=16192,Pv=16194,Lf=16199,Mf=16200,Lv=16206,Rn=16209,_1=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function P9(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const nl=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<jf||t.mode>16211?1:0},v1=e=>{if(nl(e))return Wr;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=jf,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,sl},E1=e=>{if(nl(e))return Wr;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,v1(e)},y1=(e,t)=>{let s;if(nl(e))return Wr;const n=e.state;return t<0?(s=0,t=-t):(s=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Wr:(n.window!==null&&n.wbits!==t&&(n.window=null),n.wrap=s,n.wbits=t,E1(e))},w1=(e,t)=>{if(!e)return Wr;const s=new P9;e.state=s,s.strm=e,s.window=null,s.mode=jf;const n=y1(e,t);return n!==sl&&(e.state=null),n};let Mv,Uv,S1=!0;const L9=e=>{if(S1){Mv=new Int32Array(512),Uv=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(yh(1,e.lens,0,288,Mv,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;yh(2,e.lens,0,32,Uv,0,e.work,{bits:5}),S1=!1}e.lencode=Mv,e.lenbits=9,e.distcode=Uv,e.distbits=5},N1=(e,t,s,n)=>{let r;const i=e.state;return i.window===null&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),n>=i.wsize?(i.window.set(t.subarray(s-i.wsize,s),0),i.wnext=0,i.whave=i.wsize):(r=i.wsize-i.wnext,r>n&&(r=n),i.window.set(t.subarray(s-n,s-n+r),i.wnext),(n-=r)?(i.window.set(t.subarray(s-n,s),0),i.wnext=n,i.whave=i.wsize):(i.wnext+=r,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=r))),0};var M9=(e,t)=>{let s,n,r,i,o,c,l,d,h,p,m,g,T,w,S,I,O,M,z,K,V,Y,ce=0;const xe=new Uint8Array(4);let ke,lt;const at=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(nl(e)||!e.output||!e.input&&e.avail_in!==0)return Wr;s=e.state,s.mode===uo&&(s.mode=jv),o=e.next_out,r=e.output,l=e.avail_out,i=e.next_in,n=e.input,c=e.avail_in,d=s.hold,h=s.bits,p=c,m=l,Y=sl;e:for(;;)switch(s.mode){case jf:if(s.wrap===0){s.mode=jv;break}for(;h<16;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(2&s.wrap&&d===35615){s.wbits===0&&(s.wbits=15),s.check=0,xe[0]=255&d,xe[1]=d>>>8&255,s.check=ga(s.check,xe,2,0),d=0,h=0,s.mode=16181;break}if(s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",s.mode=Rn;break}if((15&d)!==b1){e.msg="unknown compression method",s.mode=Rn;break}if(d>>>=4,h-=4,V=8+(15&d),s.wbits===0&&(s.wbits=V),V>15||V>s.wbits){e.msg="invalid window size",s.mode=Rn;break}s.dmax=1<<s.wbits,s.flags=0,e.adler=s.check=1,s.mode=512&d?16189:uo,d=0,h=0;break;case 16181:for(;h<16;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(s.flags=d,(255&sa(s))!==b1){e.msg="unknown compression method",s.mode=Rn;break}if(57344&sa(s)){e.msg="unknown header flags set",s.mode=Rn;break}s.head&&(s.head.text=d>>8&1),512&sa(s)&&4&s.wrap&&(xe[0]=255&d,xe[1]=d>>>8&255,s.check=ga(s.check,xe,2,0)),d=0,h=0,s.mode=16182;case 16182:for(;h<32;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.head&&(s.head.time=d),512&sa(s)&&4&s.wrap&&(xe[0]=255&d,xe[1]=d>>>8&255,xe[2]=d>>>16&255,xe[3]=d>>>24&255,s.check=ga(s.check,xe,4,0)),d=0,h=0,s.mode=16183;case 16183:for(;h<16;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.head&&(s.head.xflags=255&d,s.head.os=d>>8),512&sa(s)&&4&s.wrap&&(xe[0]=255&d,xe[1]=d>>>8&255,s.check=ga(s.check,xe,2,0)),d=0,h=0,s.mode=16184;case 16184:if(1024&sa(s)){for(;h<16;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.length=d,s.head&&(s.head.extra_len=d),512&sa(s)&&4&s.wrap&&(xe[0]=255&d,xe[1]=d>>>8&255,s.check=ga(s.check,xe,2,0)),d=0,h=0}else s.head&&(s.head.extra=null);s.mode=16185;case 16185:if(1024&sa(s)&&(g=s.length,g>c&&(g=c),g&&(s.head&&(V=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Uint8Array(s.head.extra_len)),s.head.extra.set(n.subarray(i,i+g),V)),512&sa(s)&&4&s.wrap&&(s.check=ga(s.check,n,g,i)),c-=g,i+=g,s.length-=g),s.length))break e;s.length=0,s.mode=16186;case 16186:if(2048&sa(s)){if(c===0)break e;g=0;do V=n[i+g++],s.head&&V&&s.length<65536&&(s.head.name+=String.fromCharCode(V));while(V&&g<c);if(512&sa(s)&&4&s.wrap&&(s.check=ga(s.check,n,g,i)),c-=g,i+=g,V)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=16187;case 16187:if(4096&sa(s)){if(c===0)break e;g=0;do V=n[i+g++],s.head&&V&&s.length<65536&&(s.head.comment+=String.fromCharCode(V));while(V&&g<c);if(512&sa(s)&&4&s.wrap&&(s.check=ga(s.check,n,g,i)),c-=g,i+=g,V)break e}else s.head&&(s.head.comment=null);s.mode=16188;case 16188:if(512&sa(s)){for(;h<16;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(4&s.wrap&&d!==(65535&s.check)){e.msg="header crc mismatch",s.mode=Rn;break}d=0,h=0}s.head&&(s.head.hcrc=sa(s)>>9&1,s.head.done=!0),e.adler=s.check=0,s.mode=uo;break;case 16189:for(;h<32;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}e.adler=s.check=_1(d),d=0,h=0,s.mode=Pf;case Pf:if(s.havedict===0)return e.next_out=o,e.avail_out=l,e.next_in=i,e.avail_in=c,s.hold=d,s.bits=h,k9;e.adler=s.check=1,s.mode=uo;case uo:if(t===O9||t===kf)break e;case jv:if(s.last){d>>>=7&h,h-=7&h,s.mode=Lv;break}for(;h<3;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}switch(s.last=1&d,d>>>=1,h-=1,3&d){case 0:s.mode=16193;break;case 1:if(L9(s),s.mode=Lf,t===kf){d>>>=2,h-=2;break e}break;case 2:s.mode=16196;break;case 3:e.msg="invalid block type",s.mode=Rn}d>>>=2,h-=2;break;case 16193:for(d>>>=7&h,h-=7&h;h<32;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",s.mode=Rn;break}if(s.length=65535&d,d=0,h=0,s.mode=Pv,t===kf)break e;case Pv:s.mode=16195;case 16195:if(g=s.length,g){if(g>c&&(g=c),g>l&&(g=l),g===0)break e;r.set(n.subarray(i,i+g),o),c-=g,i+=g,l-=g,o+=g,s.length-=g;break}s.mode=uo;break;case 16196:for(;h<14;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(s.nlen=257+(31&d),d>>>=5,h-=5,s.ndist=1+(31&d),d>>>=5,h-=5,s.ncode=4+(15&d),d>>>=4,h-=4,s.nlen>286||s.ndist>30){e.msg="too many length or distance symbols",s.mode=Rn;break}s.have=0,s.mode=16197;case 16197:for(;s.have<s.ncode;){for(;h<3;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.lens[at[s.have++]]=7&d,d>>>=3,h-=3}for(;s.have<19;)s.lens[at[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,ke={bits:s.lenbits},Y=yh(0,s.lens,0,19,s.lencode,0,s.work,ke),s.lenbits=ke.bits,Y){e.msg="invalid code lengths set",s.mode=Rn;break}s.have=0,s.mode=16198;case 16198:for(;s.have<s.nlen+s.ndist;){for(;ce=s.lencode[d&(1<<s.lenbits)-1],S=ce>>>24,I=ce>>>16&255,O=65535&ce,!(S<=h);){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(O<16)d>>>=S,h-=S,s.lens[s.have++]=O;else{if(O===16){for(lt=S+2;h<lt;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(d>>>=S,h-=S,s.have===0){e.msg="invalid bit length repeat",s.mode=Rn;break}V=s.lens[s.have-1],g=3+(3&d),d>>>=2,h-=2}else if(O===17){for(lt=S+3;h<lt;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}d>>>=S,h-=S,V=0,g=3+(7&d),d>>>=3,h-=3}else{for(lt=S+7;h<lt;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}d>>>=S,h-=S,V=0,g=11+(127&d),d>>>=7,h-=7}if(s.have+g>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=Rn;break}for(;g--;)s.lens[s.have++]=V}}if(s.mode===Rn)break;if(s.lens[256]===0){e.msg="invalid code -- missing end-of-block",s.mode=Rn;break}if(s.lenbits=9,ke={bits:s.lenbits},Y=yh(1,s.lens,0,s.nlen,s.lencode,0,s.work,ke),s.lenbits=ke.bits,Y){e.msg="invalid literal/lengths set",s.mode=Rn;break}if(s.distbits=6,s.distcode=s.distdyn,ke={bits:s.distbits},Y=yh(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,ke),s.distbits=ke.bits,Y){e.msg="invalid distances set",s.mode=Rn;break}if(s.mode=Lf,t===kf)break e;case Lf:s.mode=Mf;case Mf:if(c>=6&&l>=258){e.next_out=o,e.avail_out=l,e.next_in=i,e.avail_in=c,s.hold=d,s.bits=h,T9(e,m),o=e.next_out,r=e.output,l=e.avail_out,i=e.next_in,n=e.input,c=e.avail_in,d=s.hold,h=s.bits,s.mode===uo&&(s.back=-1);break}for(s.back=0;ce=s.lencode[d&(1<<s.lenbits)-1],S=ce>>>24,I=ce>>>16&255,O=65535&ce,!(S<=h);){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(I&&!(240&I)){for(M=S,z=I,K=O;ce=s.lencode[K+((d&(1<<M+z)-1)>>M)],S=ce>>>24,I=ce>>>16&255,O=65535&ce,!(M+S<=h);){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}d>>>=M,h-=M,s.back+=M}if(d>>>=S,h-=S,s.back+=S,s.length=O,I===0){s.mode=16205;break}if(32&I){s.back=-1,s.mode=uo;break}if(64&I){e.msg="invalid literal/length code",s.mode=Rn;break}s.extra=15&I,s.mode=16201;case 16201:if(s.extra){for(lt=s.extra;h<lt;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.length+=d&(1<<s.extra)-1,d>>>=s.extra,h-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=16202;case 16202:for(;ce=s.distcode[d&(1<<s.distbits)-1],S=ce>>>24,I=ce>>>16&255,O=65535&ce,!(S<=h);){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(!(240&I)){for(M=S,z=I,K=O;ce=s.distcode[K+((d&(1<<M+z)-1)>>M)],S=ce>>>24,I=ce>>>16&255,O=65535&ce,!(M+S<=h);){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}d>>>=M,h-=M,s.back+=M}if(d>>>=S,h-=S,s.back+=S,64&I){e.msg="invalid distance code",s.mode=Rn;break}s.offset=O,s.extra=15&I,s.mode=16203;case 16203:if(s.extra){for(lt=s.extra;h<lt;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}s.offset+=d&(1<<s.extra)-1,d>>>=s.extra,h-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=Rn;break}s.mode=16204;case 16204:if(l===0)break e;if(g=m-l,s.offset>g){if(g=s.offset-g,g>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=Rn;break}g>s.wnext?(g-=s.wnext,T=s.wsize-g):T=s.wnext-g,g>s.length&&(g=s.length),w=s.window}else w=r,T=o-s.offset,g=s.length;g>l&&(g=l),l-=g,s.length-=g;do r[o++]=w[T++];while(--g);s.length===0&&(s.mode=Mf);break;case 16205:if(l===0)break e;r[o++]=s.length,l--,s.mode=Mf;break;case Lv:if(s.wrap){for(;h<32;){if(c===0)break e;c--,d|=n[i++]<<h,h+=8}if(m-=l,e.total_out+=m,s.total+=m,4&s.wrap&&m&&(e.adler=s.check=sa(s)?ga(s.check,r,m,o-m):mh(s.check,r,m,o-m)),m=l,4&s.wrap&&(sa(s)?d:_1(d))!==s.check){e.msg="incorrect data check",s.mode=Rn;break}d=0,h=0}s.mode=16207;case 16207:if(s.wrap&&sa(s)){for(;h<32;){if(c===0)break e;c--,d+=n[i++]<<h,h+=8}if(4&s.wrap&&d!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=Rn;break}d=0,h=0}s.mode=16208;case 16208:Y=D9;break e;case Rn:Y=g1;break e;case 16210:return x1;default:return Wr}return e.next_out=o,e.avail_out=l,e.next_in=i,e.avail_in=c,s.hold=d,s.bits=h,(s.wsize||m!==e.avail_out&&s.mode<Rn&&(s.mode<Lv||t!==f1))&&N1(e,e.output,e.next_out,m-e.avail_out),p-=e.avail_in,m-=e.avail_out,e.total_in+=p,e.total_out+=m,s.total+=m,4&s.wrap&&m&&(e.adler=s.check=sa(s)?ga(s.check,r,m,e.next_out-m):mh(s.check,r,m,e.next_out-m)),e.data_type=s.bits+(s.last?64:0)+(s.mode===uo?128:0)+(s.mode===Lf||s.mode===Pv?256:0),(p===0&&m===0||t===f1)&&Y===sl&&(Y=j9),Y},ho={inflateReset:E1,inflateReset2:y1,inflateResetKeep:v1,inflateInit:e=>w1(e,15),inflateInit2:w1,inflate:M9,inflateEnd:e=>{if(nl(e))return Wr;let t=e.state;return t.window&&(t.window=null),e.state=null,sl},inflateGetHeader:(e,t)=>{if(nl(e))return Wr;const s=e.state;return 2&s.wrap?(s.head=t,t.done=!1,sl):Wr},inflateSetDictionary:(e,t)=>{const s=t.length;let n,r,i;return nl(e)?Wr:(n=e.state,n.wrap!==0&&n.mode!==Pf?Wr:n.mode===Pf&&(r=1,r=mh(r,t,s,0),r!==n.check)?g1:(i=N1(e,t,s,s),i?(n.mode=16210,x1):(n.havedict=1,sl)))},inflateInfo:"pako inflate (from Nodeca project)"},U9=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const T1=Object.prototype.toString,{Z_NO_FLUSH:V9,Z_FINISH:F9,Z_OK:wh,Z_STREAM_END:Vv,Z_NEED_DICT:Fv,Z_STREAM_ERROR:B9,Z_DATA_ERROR:R1,Z_MEM_ERROR:G9}=Nf;function Uf(e){this.options=Cf.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h1,this.strm.avail_out=0;let s=ho.inflateInit2(this.strm,t.windowBits);if(s!==wh)throw new Error(Qc[s]);if(this.header=new U9,ho.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Eh.string2buf(t.dictionary):T1.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(s=ho.inflateSetDictionary(this.strm,t.dictionary),s!==wh)))throw new Error(Qc[s])}function C1(e,t){const s=new Uf(t);if(s.push(e),s.err)throw s.msg||Qc[s.err];return s.result}Uf.prototype.push=function(e,t){const s=this.strm,n=this.options.chunkSize,r=this.options.dictionary;let i,o,c;if(this.ended)return!1;for(o=t===~~t?t:t===!0?F9:V9,T1.call(e)==="[object ArrayBuffer]"?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;){for(s.avail_out===0&&(s.output=new Uint8Array(n),s.next_out=0,s.avail_out=n),i=ho.inflate(s,o),i===Fv&&r&&(i=ho.inflateSetDictionary(s,r),i===wh?i=ho.inflate(s,o):i===R1&&(i=Fv));s.avail_in>0&&i===Vv&&s.state.wrap>0&&e[s.next_in]!==0;)ho.inflateReset(s),i=ho.inflate(s,o);switch(i){case B9:case R1:case Fv:case G9:return this.onEnd(i),this.ended=!0,!1}if(c=s.avail_out,s.next_out&&(s.avail_out===0||i===Vv))if(this.options.to==="string"){let l=Eh.utf8border(s.output,s.next_out),d=s.next_out-l,h=Eh.buf2string(s.output,l);s.next_out=d,s.avail_out=n-d,d&&s.output.set(s.output.subarray(l,l+d),0),this.onData(h)}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(i!==wh||c!==0){if(i===Vv)return i=ho.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,!0;if(s.avail_in===0)break}}return!0},Uf.prototype.onData=function(e){this.chunks.push(e)},Uf.prototype.onEnd=function(e){e===wh&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Cf.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var W9={inflate:C1,inflateRaw:function(e,t){return(t=t||{}).raw=!0,C1(e,t)}};const{deflate:H9,deflateRaw:z9}=N9,{inflate:K9,inflateRaw:Y9}=W9;var q9=H9,X9=z9,J9=K9,$9=Y9,I1=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(I1||{});class Q9{constructor(){N(this,"_sequence",0),N(this,"_startTime",Date.now()),N(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const s={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const c=new Uint8Array(4);c.set([1,0,0,0]);const l={id:0,length:4,data:c.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[l]};s.commonPacketHeader.extension=1,s.extension=d,s.payload=this.compress(t),s.commonPacketHeader.length=8+(s.extension.length+2)+s.payload.byteLength}else s.commonPacketHeader.length=8+s.payload.byteLength;C("SHOW_DATASTREAM2_LOG")&&b.debug("send data header: ".concat(JSON.stringify(s.commonPacketHeader)));const n=new ArrayBuffer(s.commonPacketHeader.length),r=new Uint8Array(n),i=new DataView(n);let o=0;if(i.setUint16(o,s.commonPacketHeader.extension<<15|s.commonPacketHeader.reserved<<14|s.commonPacketHeader.length,!0),o+=2,i.setUint32(o,s.commonPacketHeader.sequence,!0),o+=4,i.setUint16(o,s.commonStreamHeader,!0),o+=2,s.extension){const c=this.serializeExtension(s.extension);r.set(new Uint8Array(c),o),o+=c.byteLength}if(r.set(new Uint8Array(s.payload),o),o+=s.payload.byteLength,o!==s.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const s=new DataView(t);let n=0;const r=s.getUint16(n,!0);n+=2;const i={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:s.getUint16(n+2,!0)<<16|s.getUint16(n,!0)};let o,c;if(n+=4,C("SHOW_DATASTREAM2_LOG")&&b.debug("receive data header: ".concat(JSON.stringify(i))),s.getUint16(n,!0),n+=2,i.extension){c=this.deserializeExtension(t.slice(n)),n+=2+c.length,o=t.slice(n);let l=!1;if(c.datas.length>0){const d=c.datas.find(h=>h.id===0);d&&(l=(1&new DataView(d.data).getUint32(0,!0))==1)}o=l?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:s,length:n,datas:r}=t,i=new ArrayBuffer(n+2),o=new Uint8Array(i),c=new DataView(i);let l=0;if(c.setUint8(l++,s),c.setUint8(l++,n),r.forEach(d=>{s?(c.setUint8(l++,d.id),c.setUint8(l++,d.length),o.set(new Uint8Array(d.data),l),l+=d.data.byteLength):(c.setUint8(l++,d.id|d.length<<4),o.set(new Uint8Array(d.data),l),l+=d.data.byteLength)}),l!==n+2)throw Error("serialize extension error, is ".concat(l,"!==").concat(n+2));return i}deserializeExtension(t){const s=new DataView(t);let n=0;const r=s.getUint8(n);n++;const i=s.getUint8(n);n++;const o=r===I1.TWO_BYTE,c=[],l=new DataView(t,2);let d=0;for(;d<i;){let h=0,p=0,m=new ArrayBuffer(0);o?(h=l.getUint8(d),d++,p=l.getUint8(d),d++):(h=15&l.getUint8(d),p=l.getUint8(d)>>4,d++),p>0&&(m=l.buffer.slice(d+2,d+2+p),d+=m.byteLength),c.push({id:h,length:p,data:m})}if(d!==i)throw Error("parse error");return{profile:r,length:i,datas:c}}decompress(t){return J9(new Uint8Array(t))}compress(t){return q9(new Uint8Array(t))}}const Z9={name:"DataStream",create:(e,t)=>{const s=t?new n7(e):new a7(e);return s.useDataStream(new Q9),s}};class eY extends Cs{constructor(t,s,n){super(),N(this,"ws",void 0),N(this,"requestId",1),N(this,"heartBeatTimer",void 0),N(this,"joinInfo",void 0),N(this,"clientId",void 0),N(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),N(this,"onClose",r=>{this.emit("close"),this.dispose()}),N(this,"onMessage",r=>{const i=JSON.parse(r.data);if(!i||i.command!=="serverResponse"||!i.requestId)return i&&i.command==="serverStatus"&&i.serverStatus&&i.serverStatus.command?(this.emit("status",i.serverStatus),void this.emit(i.serverStatus.command,i.serverStatus)):void 0;this.emit("req_".concat(i.requestId),i)}),this.joinInfo=t,this.clientId=s,this.ws=new Yu("cross-channel-".concat(this.clientId),n),this.ws.on(bt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(bt.CONNECTED,this.onOpen),this.ws.on(bt.ON_MESSAGE,this.onMessage),this.ws.on(bt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const s=this.requestId++;return t.requestId=s,t.seq=s,this.ws.sendMessage(t),s}waitStatus(t){return new Te((s,n)=>{const r=window.setTimeout(()=>{n(new $(A.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,i=>{window.clearTimeout(r),i.state&&i.state!==0?n(new $(A.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):s(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),n(new $(A.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new $(A.WS_DISCONNECT);const s=()=>new Te((o,c)=>{this.ws.once(bt.CLOSED,()=>c(new $(A.WS_ABORT))),this.ws.once(bt.CONNECTED,o)});this.ws.state!=="connected"&&await s();const n=this.sendMessage(t),r=new Te((o,c)=>{const l=()=>{c(new $(A.WS_ABORT))};this.ws.once(bt.RECONNECTING,l),this.ws.once(bt.CLOSED,l),this.once("req_".concat(n),o),gn(3e3).then(()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(bt.RECONNECTING,l),this.ws.off(bt.CLOSED,l),c(new $(A.TIMEOUT,"cross channel ws request timeout"))})}),i=await r;if(!i||i.code!==200)throw new $(A.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(i)));return i}async connect(t){this.ws.removeAllListeners(bt.REQUEST_NEW_URLS),this.ws.on(bt.REQUEST_NEW_URLS,s=>{s(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const s=this.requestId++;return t.requestId=s,this.ws.sendMessage(t),s}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class tY extends Cs{set state(t){t!==this._state&&(t!==Ra.RELAY_STATE_FAILURE&&(this.errorCode=fd.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,s,n,r,i){super(),N(this,"joinInfo",void 0),N(this,"sid",void 0),N(this,"clientId",void 0),N(this,"cancelToken",ba.CancelToken.source()),N(this,"workerToken",void 0),N(this,"requestId",0),N(this,"signal",void 0),N(this,"prevChannelMediaConfig",void 0),N(this,"httpRetryConfig",void 0),N(this,"_resolution",void 0),N(this,"_state",Ra.RELAY_STATE_IDLE),N(this,"errorCode",fd.RELAY_OK),N(this,"onStatus",o=>{b.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",io.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",io.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=fd.SRC_TOKEN_EXPIRED,this.state=Ra.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=fd.DEST_TOKEN_EXPIRED,this.state=Ra.RELAY_STATE_FAILURE))}),N(this,"onReconnect",async()=>{b.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",io.NETWORK_DISCONNECTED),this.state=Ra.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(o=>{this.state!==Ra.RELAY_STATE_IDLE&&(b.error("auto restart channel media relay failed",o.toString()),this.errorCode=fd.SERVER_CONNECTION_LOST,this.state=Ra.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=s,this.sid=kc(),this.signal=new eY(this.joinInfo,this.clientId,n),this.httpRetryConfig=r,this._resolution=i}async startChannelMediaRelay(t){if(this.state!==Ra.RELAY_STATE_IDLE)throw new $(A.INVALID_OPERATION);this.state=Ra.RELAY_STATE_CONNECTING,await this.connect(),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(s){throw s.data&&s.data.serverResponse&&s.data.serverResponse.command==="SetSourceChannel"?new $(A.CROSS_CHANNEL_FAILED_JOIN_SRC):s.data&&s.data.serverResponse&&s.serverResponse.command==="SetDestChannelStatus"?new $(A.CROSS_CHANNEL_FAILED_JOIN_DEST):s.data&&s.data.serverResponse&&s.serverResponse.command==="StartPacketTransfer"?new $(A.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):s}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==Ra.RELAY_STATE_RUNNING)throw new $(A.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==Ra.RELAY_STATE_RUNNING)throw new $(A.INVALID_OPERATION);const s=this.genMessage(Ea.SetVideoProfile);await this.signal.request(s),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),b.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Ra.RELAY_STATE_IDLE,this.dispose()}dispose(){b.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ba.CancelToken.source(),this.state=Ra.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await cK(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",io.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const s=this.genMessage(Ea.SetSdkProfile,t);await this.signal.request(s),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const n=this.genMessage(Ea.SetSourceChannel,t);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",io.PACKET_JOINED_SRC_CHANNEL),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(Ea.SetSourceUserId,t);await this.signal.request(r),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const i=this.genMessage(Ea.SetDestChannel,t);await this.signal.request(i),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",io.PACKET_JOINED_DEST_CHANNEL),b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(Ea.StartPacketTransfer,t);await this.signal.request(o),this.emit("event",io.PACKET_SENT_TO_DEST_CHANNEL),this.state=Ra.RELAY_STATE_RUNNING,b.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const s=this.genMessage(Ea.UpdateDestChannel,t);await this.signal.request(s),this.emit("event",io.PACKET_UPDATE_DEST_CHANNEL),b.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(Ea.StopPacketTransfer);await this.signal.request(t),b.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,s){const n=[],r=[],i=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:lr,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.24.2"&&(o.sdkVersion="0.0.1");let c=null,l=null;switch(t){case Ea.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Ea.SetSourceChannel:if(l=s&&s.getSrcChannelMediaInfo(),!l)throw new $(A.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:l.channelName,token:l.token||this.joinInfo.appId},o;case Ea.SetSourceUserId:if(l=s&&s.getSrcChannelMediaInfo(),!l)throw new $(A.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:l.uid+""},o;case Ea.SetDestChannel:if(c=s&&s.getDestChannelMediaInfo(),!c)throw new $(A.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),i.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"SetDestChannel",channelName:n,uid:r,token:i},o;case Ea.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Ea.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Ea.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Ea.UpdateDestChannel:if(c=s&&s.getDestChannelMediaInfo(),!c)throw new $(A.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),i.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"UpdateDestChannel",channelName:n,uid:r,token:i},o;case Ea.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const sY={name:"ChannelMediaRelay",create:function(e){return new tY(e.joinInfo,e.clientId,e.websocketRetryConfig||Ys,e.httpRetryConfig||Ys,e.resolution)}};function A1(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Sh(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?A1(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):A1(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class nY extends Cs{constructor(t,s,n,r){super(),N(this,"spec",void 0),N(this,"token",void 0),N(this,"websocket",void 0),N(this,"pingpongTimer",void 0),N(this,"reconnectMode","retry"),N(this,"serviceMode",void 0),N(this,"reqId",0),N(this,"commandReqId",0),N(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),N(this,"handleWebSocketMessage",i=>{if(!i.data)return;const o=JSON.parse(i.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):(Ue.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===ro.TRANSCODE?1:2}),this.emit(Go.PUBLISH_STREAM_STATUS,o))}),this.spec=s,this.token=t,this.serviceMode=r,this.websocket=new Yu("live-streaming",n),this.websocket.on(bt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(bt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(bt.REQUEST_NEW_URLS,(i,o)=>{Qs(this,Go.REQUEST_NEW_ADDRESS).then(i).catch(o)}),this.websocket.on(bt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,s,n,r){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const i=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new $(A.UNEXPECTED_ERROR);const c=Sh({command:t,sdkVersion:lr==="4.24.2"?"0.0.1":lr,seq:o,requestId:o,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},s);if(this.websocket.state==="closed")throw new $(A.WS_DISCONNECT);const l=()=>new Te((m,g)=>{this.websocket.once(bt.CLOSED,()=>g(new $(A.WS_ABORT))),this.websocket.once(bt.CONNECTED,m)});this.websocket.state!=="connected"&&await l(),c.clientRequest&&(c.clientRequest.workerToken=this.token);const d=new Te((m,g)=>{const T=()=>{g(new $(A.WS_ABORT))};this.websocket.once(bt.RECONNECTING,T),this.websocket.once(bt.CLOSED,T),this.once("@".concat(o,"-").concat(this.spec.sid),w=>{m(w)})});r&&Ue.workerEvent(this.spec.sid,Sh(Sh({},r),{},{requestId:i,actionType:"request",payload:JSON.stringify(s.clientRequest),serverCode:0,code:0}));const h=Date.now();this.websocket.sendMessage(c);let p=null;try{p=await d}catch(m){if(this.websocket.state==="closed")throw m;return await l(),await this.request(t,s,n)}return r&&Ue.workerEvent(this.spec.sid,Sh(Sh({},r),{},{requestId:i,actionType:"response",payload:JSON.stringify(p.serverResponse),serverCode:p.code,success:p.code===200,responseTime:Date.now()-h})),p.code!==200&&this.handleResponseError(p),p}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=lr==="4.24.2"?"0.0.1":lr;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case an.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void b.warning("live stream response already exists stream");case an.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case an.LIVE_STREAM_RESPONSE_BAD_STREAM:case an.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new $(A.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case an.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream")return;throw new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case an.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new $(A.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case an.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const s=new $(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Go.WARNING,s,t.serverResponse.url)}case an.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const s=new $(A.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Go.WARNING,s,t.serverResponse.url)}case an.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case an.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new $(A.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case an.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const s=new $(A.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Go.WARNING,s,t.serverResponse.url)}case an.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case an.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case an.LIVE_STREAM_RESPONSE_WORKER_LOST:case an.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream")return;throw new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case an.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case an.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new $(A.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Vu)},6e3)}}function O1(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Ia(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?O1(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):O1(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class aY extends Cs{constructor(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ys,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ys;super(),N(this,"onLiveStreamWarning",void 0),N(this,"onLiveStreamError",void 0),N(this,"spec",void 0),N(this,"retryTimeout",1e4),N(this,"connection",void 0),N(this,"httpRetryConfig",void 0),N(this,"wsRetryConfig",void 0),N(this,"streamingTasks",new Map),N(this,"isStartingStreamingTask",!1),N(this,"taskMutex",new wn("live-streaming")),N(this,"cancelToken",ba.CancelToken.source()),N(this,"transcodingConfig",void 0),N(this,"uapResponse",void 0),N(this,"lastTaskId",1),N(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=n,this.wsRetryConfig=s}async setTranscodingConfig(t){const s=Ia(Ia({},B7),t);s.videoCodecProfile!==66&&s.videoCodecProfile!==77&&s.videoCodecProfile!==100&&(b.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(s.videoCodecProfile," -> 100")),s.videoCodecProfile=100),s.transcodingUsers||(s.transcodingUsers=s.userConfigs),s.transcodingUsers&&(s.transcodingUsers=s.transcodingUsers.map(o=>Ia(Ia(Ia({},F7),o),{},{zOrder:o.zOrder?o.zOrder+1:1}))),function(o){js(o.width)||rs(o.width,"config.width",0,1e4),js(o.height)||rs(o.height,"config.height",0,1e4),js(o.videoBitrate)||rs(o.videoBitrate,"config.videoBitrate",1,1e6),js(o.videoFrameRate)||rs(o.videoFrameRate,"config.videoFrameRate"),js(o.lowLatency)||Or(o.lowLatency,"config.lowLatency"),js(o.audioSampleRate)||Ks(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),js(o.audioBitrate)||rs(o.audioBitrate,"config.audioBitrate",1,128),js(o.audioChannels)||Ks(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),js(o.videoGop)||rs(o.videoGop,"config.videoGop"),js(o.videoCodecProfile)||Ks(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),js(o.userCount)||rs(o.userCount,"config.userCount",0,17),js(o.backgroundColor)||rs(o.backgroundColor,"config.backgroundColor",0,16777215),js(o.userConfigExtraInfo)||An(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!js(o.transcodingUsers)&&(no(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach((c,l)=>{Ym(c.uid),js(c.x)||rs(c.x,"transcodingUser[".concat(l,"].x"),0,1e4),js(c.y)||rs(c.y,"transcodingUser[".concat(l,"].y"),0,1e4),js(c.width)||rs(c.width,"transcodingUser[".concat(l,"].width"),0,1e4),js(c.height)||rs(c.height,"transcodingUser[".concat(l,"].height"),0,1e4),js(c.zOrder)||rs(c.zOrder-1,"transcodingUser[".concat(l,"].zOrder"),0,100),js(c.alpha)||rs(c.alpha,"transcodingUser[".concat(l,"].alpha"),0,1,!1)})),js(o.watermark)||A_(o.watermark,"watermark"),js(o.backgroundImage)||A_(o.backgroundImage,"backgroundImage"),o.images&&!js(o.images)&&(no(o.images,"config.images"),o.images.forEach((c,l)=>{A_(c,"images[".concat(l,"]"))}))}(s);const n=[];s.images&&n.push(...s.images.map(o=>Ia(Ia(Ia({},I_),o),{},{zOrder:255}))),s.backgroundImage&&(n.push(Ia(Ia(Ia({},I_),s.backgroundImage),{},{zOrder:0})),delete s.backgroundImage),s.watermark&&(n.push(Ia(Ia(Ia({},I_),s.watermark),{},{zOrder:255})),delete s.watermark),s.images=n,s.transcodingUsers&&(s.userConfigs=s.transcodingUsers.map(o=>Ia({},o)),s.userCount=s.transcodingUsers.length,delete s.transcodingUsers);const r=(s.userConfigs||[]).map(o=>typeof o.uid=="number"?Te.resolve(o.uid):$D(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Te.all(r)).forEach((o,c)=>{s.userConfigs&&s.userConfigs[c]&&(s.userConfigs[c].uid=o)}),this.transcodingConfig=s,this.connection)try{var i;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Pa(i=this.streamingTasks).call(i)).map(c=>c.taskId).join("#")});b.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(c=>{b.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,o).then(()=>{b.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(c.url," success"))}).catch(l=>{b.error("[".concat(this.spec.clientId,"] live streaming republish failed"),c.url,l.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,l)})})}}async startLiveStreamingTask(t,s,n){if(!this.transcodingConfig&&s===ro.TRANSCODE)throw new $(A.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const r={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};b.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(s));const i=await this.taskMutex.lock();if(!this.connection&&n)return void i();if(this.streamingTasks.get(t)&&!n)return i(),new $(A.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(s))}catch(c){throw i(),c}switch(s){case ro.TRANSCODE:r.transcodingConfig=Ia({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const c=new Te((d,h)=>{gn(this.retryTimeout).then(()=>{if(n)return h(n);const p=this.statusError.get(t);return p?(this.statusError.delete(t),h(p)):void 0})}),l=await Te.race([this.connection.request("request",{clientRequest:r},!0,{url:t,command:"PublishStream",workerType:s===ro.TRANSCODE?1:2,requestByUser:!n,tid:o.toString()}),c]);this.isStartingStreamingTask=!1,b.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(l.code)),this.streamingTasks.set(t,{clientRequest:r,mode:s,url:t,taskId:o}),i()}catch(c){if(i(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||n)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,s,c)):await this.startLiveStreamingTask(t,s,c)}}stopLiveStreamingTask(t){return new Te((s,n)=>{const r=this.streamingTasks.get(t);if(!r||!this.connection)return new $(A.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const i=r.mode;r.abortTask=()=>{b.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),s()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:t,command:"UnPublishStream",workerType:i===ro.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(o=>{b.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),s()}).catch(n)})}resetAllTask(){var t;const s=Array.from(Pa(t=this.streamingTasks).call(t));this.terminate();for(const n of s)this.startLiveStreamingTask(n.url,n.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ba.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new $(A.UNEXPECTED_ERROR,"live streaming connection has already connected");const s=await Qs(this,O_.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=s,this.connection=new nY(s.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Go.WARNING,(n,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,n)),this.connection.on(Go.PUBLISH_STREAM_STATUS,n=>this.handlePublishStreamServer(n)),this.connection.on(Go.REQUEST_NEW_ADDRESS,(n,r)=>{if(!this.connection)return r(new $(A.UNEXPECTED_ERROR,"can not get new live streaming address list"));Qs(this,O_.REQUEST_WORKER_MANAGER_LIST,t).then(i=>{this.uapResponse=i,n(i.addressList)}).catch(r)}),await this.connection.init(s.addressList),this.connection}handlePublishStreamServer(t){const s=t.serverStatus&&t.serverStatus.url||"empty_url",n=this.streamingTasks.get(s),r=t.reason;switch(t.code){case an.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case an.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new $(A.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(n)return b.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(s,o);if(!this.isStartingStreamingTask)return;this.statusError.set(s,o)}case an.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new $(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(s,o)}case an.LIVE_STREAM_RESPONSE_WORKER_LOST:case an.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var i;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(Pa(i=this.streamingTasks).call(i));for(const c of o)c.abortTask?c.abortTask():(b.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,new $(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{b.debug("[".concat(this.spec.clientId,"] republish live stream success"),c.url)}).catch(l=>{b.error(l.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,l)}));return}}}hasUrl(t){return this.streamingTasks.has(t)}}const rY={name:"LiveStreaming",create:function(e){return new aY(e.joinInfo,e.websocketRetryConfig||Ys,e.httpRetryConfig||Ys)}};function iY(e){let t=j1();return function(s,n){let r=s.appId;r!==void 0&&(Zt(n,10),Gi(n,r));let i=s.cid;i!==void 0&&(Zt(n,16),Zt(n,i));let o=s.cname;o!==void 0&&(Zt(n,26),Gi(n,o));let c=s.deviceId;c!==void 0&&(Zt(n,34),Gi(n,c));let l=s.elapse;l!==void 0&&(Zt(n,40),tc(n,l));let d=s.fileSize;d!==void 0&&(Zt(n,48),tc(n,kd(d)));let h=s.height;h!==void 0&&(Zt(n,56),tc(n,kd(h)));let p=s.jpg;p!==void 0&&(Zt(n,66),Zt(n,p.length),function(Rs,de){let Se=jd(Rs,de.length);Rs.bytes.set(de,Se)}(n,p));let m=s.networkType;m!==void 0&&(Zt(n,72),tc(n,kd(m)));let g=s.osType;g!==void 0&&(Zt(n,80),tc(n,kd(g)));let T=s.requestId;T!==void 0&&(Zt(n,90),Gi(n,T));let w=s.sdkVersion;w!==void 0&&(Zt(n,98),Gi(n,w));let S=s.sequence;S!==void 0&&(Zt(n,104),tc(n,kd(S)));let I=s.sid;I!==void 0&&(Zt(n,114),Gi(n,I));let O=s.timestamp;O!==void 0&&(Zt(n,120),tc(n,O));let M=s.uid;M!==void 0&&(Zt(n,128),Zt(n,M));let z=s.vid;z!==void 0&&(Zt(n,136),Zt(n,z));let K=s.width;K!==void 0&&(Zt(n,144),tc(n,kd(K)));let V=s.service;V!==void 0&&(Zt(n,152),Zt(n,V));let Y=s.callbackData;Y!==void 0&&(Zt(n,162),Gi(n,Y));let ce=s.jpgEncryption;ce!==void 0&&(Zt(n,168),Zt(n,ce));let xe=s.requestType;xe!==void 0&&(Zt(n,176),Zt(n,xe));let ke=s.scorePorn;ke!==void 0&&(Zt(n,185),zv(n,ke));let lt=s.scoreSexy;lt!==void 0&&(Zt(n,193),zv(n,lt));let at=s.scoreNeutral;at!==void 0&&(Zt(n,201),zv(n,at));let Et=s.scene;Et!==void 0&&(Zt(n,208),Zt(n,Et));let xt=s.ossFilePrefix;xt!==void 0&&(Zt(n,218),Gi(n,xt));let Ht=s.serviceVendor;if(Ht!==void 0)for(let Rs of Ht){Zt(n,226);let de=j1();lY(Rs,de),Zt(n,de.limit),pY(n,de),hY(de)}}(e,t),function(s){let n=s.bytes,r=s.limit;return n.length===r?n:n.subarray(0,r)}(t)}function oY(e){return function(s){let n={};e:for(;!P1(s);){let r=Wi(s);switch(r>>>3){case 0:break e;case 1:n.code=Wi(s);break;case 2:n.msg=L1(s,Wi(s));break;case 3:{let i=dY(s);n.data=cY(s),s.limit=i;break}default:D1(s,7&r)}}return n}({bytes:t=e,offset:0,limit:t.length});var t}function cY(e){let t={};e:for(;!P1(e);){let s=Wi(e);switch(s>>>3){case 0:break e;case 1:t.requestId=L1(e,Wi(e));break;case 2:t.requestType=Wi(e)>>>0;break;case 3:t.scorePorn=Hv(e);break;case 4:t.scoreSexy=Hv(e);break;case 5:t.scoreNeutral=Hv(e);break;case 6:t.requestScene=Wi(e)>>>0;break;case 7:t.scene=Wi(e)>>>0;break;default:D1(e,7&s)}}return t}function lY(e,t){let s=e.service;s!==void 0&&(Zt(t,8),Zt(t,s));let n=e.vendor;n!==void 0&&(Zt(t,16),Zt(t,n));let r=e.token;r!==void 0&&(Zt(t,26),Gi(t,r));let i=e.callbackUrl;i!==void 0&&(Zt(t,34),Gi(t,i))}function dY(e){let t=Wi(e),s=e.limit;return e.limit=e.offset+t,s}function D1(e,t){switch(t){case 0:for(;128&M1(e););break;case 2:Gv(e,Wi(e));break;case 5:Gv(e,4);break;case 1:Gv(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let uY=new Float32Array(1);new Uint8Array(uY.buffer);let Bv=new Float64Array(1),Aa=new Uint8Array(Bv.buffer);function kd(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let k1=[];function j1(){const e=k1.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function hY(e){k1.push(e)}function Gv(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function P1(e){return e.offset>=e.limit}function jd(e,t){let s=e.bytes,n=e.offset,r=e.limit,i=n+t;if(i>s.length){let o=new Uint8Array(2*i);o.set(s),e.bytes=o}return e.offset=i,i>r&&(e.limit=i),n}function Wv(e,t){let s=e.offset;if(s+t>e.limit)throw new Error("Read past limit");return e.offset+=t,s}function L1(e,t){let s=Wv(e,t),n=String.fromCharCode,r=e.bytes,i="",o="";for(let c=0;c<t;c++){let l,d,h,p,m=r[c+s];128&m?(224&m)==192?c+1>=t?o+=i:(l=r[c+s+1],(192&l)!=128?o+=i:(p=(31&m)<<6|63&l,p<128?o+=i:(o+=n(p),c++))):(240&m)==224?c+2>=t?o+=i:(l=r[c+s+1],d=r[c+s+2],(49344&(l|d<<8))!=32896?o+=i:(p=(15&m)<<12|(63&l)<<6|63&d,p<2048||p>=55296&&p<=57343?o+=i:(o+=n(p),c+=2))):(248&m)==240?c+3>=t?o+=i:(l=r[c+s+1],d=r[c+s+2],h=r[c+s+3],(12632256&(l|d<<8|h<<16))!=8421504?o+=i:(p=(7&m)<<18|(63&l)<<12|(63&d)<<6|63&h,p<65536||p>1114111?o+=i:(p-=65536,o+=n(55296+(p>>10),56320+(1023&p)),c+=3))):o+=i:o+=n(m)}return o}function Gi(e,t){let s=t.length,n=0;for(let o=0;o<s;o++){let c=t.charCodeAt(o);c>=55296&&c<=56319&&o+1<s&&(c=(c<<10)+t.charCodeAt(++o)-56613888),n+=c<128?1:c<2048?2:c<65536?3:4}Zt(e,n);let r=jd(e,n),i=e.bytes;for(let o=0;o<s;o++){let c=t.charCodeAt(o);c>=55296&&c<=56319&&o+1<s&&(c=(c<<10)+t.charCodeAt(++o)-56613888),c<128?i[r++]=c:(c<2048?i[r++]=c>>6&31|192:(c<65536?i[r++]=c>>12&15|224:(i[r++]=c>>18&7|240,i[r++]=c>>12&63|128),i[r++]=c>>6&63|128),i[r++]=63&c|128)}}function pY(e,t){let s=jd(e,t.limit),n=e.bytes,r=t.bytes;for(let i=0,o=t.limit;i<o;i++)n[i+s]=r[i]}function M1(e){return e.bytes[Wv(e,1)]}function U1(e,t){let s=jd(e,1);e.bytes[s]=t}function Hv(e){let t=Wv(e,8),s=e.bytes;return Aa[0]=s[t++],Aa[1]=s[t++],Aa[2]=s[t++],Aa[3]=s[t++],Aa[4]=s[t++],Aa[5]=s[t++],Aa[6]=s[t++],Aa[7]=s[t++],Bv[0]}function zv(e,t){let s=jd(e,8),n=e.bytes;Bv[0]=t,n[s++]=Aa[0],n[s++]=Aa[1],n[s++]=Aa[2],n[s++]=Aa[3],n[s++]=Aa[4],n[s++]=Aa[5],n[s++]=Aa[6],n[s++]=Aa[7]}function Wi(e){let t,s=0,n=0;do t=M1(e),s<32&&(n|=(127&t)<<s),s+=7;while(128&t);return n}function Zt(e,t){for(t>>>=0;t>=128;)U1(e,127&t|128),t>>>=7;U1(e,t)}function tc(e,t){let s=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,i=r===0?n===0?s<16384?s<128?1:2:s<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,o=jd(e,i),c=e.bytes;switch(i){case 10:c[o+9]=r>>>7&1;case 9:c[o+8]=i!==9?128|r:127&r;case 8:c[o+7]=i!==8?n>>>21|128:n>>>21&127;case 7:c[o+6]=i!==7?n>>>14|128:n>>>14&127;case 6:c[o+5]=i!==6?n>>>7|128:n>>>7&127;case 5:c[o+4]=i!==5?128|n:127&n;case 4:c[o+3]=i!==4?s>>>21|128:s>>>21&127;case 3:c[o+2]=i!==3?s>>>14|128:s>>>14&127;case 2:c[o+1]=i!==2?s>>>7|128:s>>>7&127;case 1:c[o]=i!==1?128|s:127&s}}function V1(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}const mY=new Map([["moderation",1],["supervise",2]]);class fY extends Cs{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const s=this._connectionState;this._connectionState=t,this.emit(Nn.CONNECTION_STATE_CHANGE,s,t)}get inspectType(){return this._inspectType}set inspectType(t){var s;this._inspectMode=or(s=t.map(n=>mY.get(n)||0)).call(s,(n,r)=>n+r),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),N(this,"name","AgoraRTCVideoContentInspect"),N(this,"_connectionState",Lr.CONNECTING),N(this,"_innerConnectionState",void 0),N(this,"sequence",0),N(this,"inspectStartTime",void 0),N(this,"workerManagerConnection",void 0),N(this,"workerConnection",void 0),N(this,"workerMessageLengthLimit",void 0),N(this,"inspectIntervalMinimum",void 0),N(this,"qualityRatio",void 0),N(this,"_connectInfo",void 0),N(this,"_cancelTokenSource",ba.CancelToken.source()),N(this,"_retryConfig",void 0),N(this,"wmSequence",0),N(this,"inspectInterval",void 0),N(this,"inspectTimer",null),N(this,"ossFilePrefix",void 0),N(this,"extraInfo",void 0),N(this,"_inspectType",void 0),N(this,"_inspectMode",void 0),N(this,"_quality",1),N(this,"qualityTimer",null),N(this,"_inspectId",void 0),N(this,"_needWorkUrlOnly",!1),N(this,"inspectImage",()=>{if(this.connectionState!==Lr.CONNECTED)throw new $(A.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Lr.CONNECTED?this.requestToInspectImage():b.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Jt(5,"inspect-"),this.workerMessageLengthLimit=C("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=C("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=C("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Yu("worker-manager-"+this._inspectId,Ys),this.on(Nn.STATE_CHANGE,(s,n)=>{this._innerConnectionState=s,b.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Mr[s]," ").concat(n||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Yu("worker-"+this._inspectId,Ys),this.handleWorkerEvents()}async init(t,s){this.emit(Nn.STATE_CHANGE,Mr.CONNECT_AP),this._connectInfo=t;const n=this._cancelTokenSource.token;return this._retryConfig=s,new Te((r,i)=>{this.on(Nn.CONNECTION_STATE_CHANGE,(o,c)=>{c===Lr.CONNECTED&&r()}),this.requestAP(t,n,s).then(o=>{this.connectWorkerManager(o)}).catch(o=>{i(o)})})}async requestAP(t,s,n){const r=C("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),i=await function(c,l,d,h){let{appId:p,areaCode:m,cname:g,sid:T,token:w,uid:S}=l;Ed++;const I="image_moderation_api",O={service_name:I,json_body:JSON.stringify({appId:p,areaCode:m,cname:g,command:"allocateEdge",requestId:Ed,seq:Ed,sid:T,token:w,ts:Date.now(),uid:S+""})};let M,z,K=c[0];return ni(async()=>{M=Date.now();const V=await li(K,{data:O,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(z=Date.now()-M,V.code!==0){const at=new $(A.UNEXPECTED_RESPONSE,"image inspect ap error, code"+V.code,{retry:!0,responseTime:z});throw b.error(at.toString()),at}const Y=JSON.parse(V.json_body);if(Y.code!==200){const at=new $(A.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(Y.code,", reason: ").concat(Y.reason),{code:Y.code,responseTime:z});throw b.error(at.toString()),at}if(!Y.servers||!Array.isArray(Y.servers)||Y.servers.length===0){const at=new $(A.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:Y.code,responseTime:z});throw b.error(at.toString()),at}const ce=C("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(ce)return{addressList:[ce],workerToken:Y.workerToken,vid:Y.vid,responseTime:z};const xe=C("VIDEO_INSPECT_WORKER_MANAGER_HOST"),ke=C("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:Y.servers.map(at=>{let{address:Et,wss:xt}=at;if(Et&&xt)return"wss://".concat(Et.replace(/\./g,"-"),".").concat(xe,":").concat(ke||xt)}).filter(at=>!!at),workerToken:Y.workerToken,vid:Y.vid,responseTime:z}},(V,Y)=>(Ue.apworkerEvent(T,{success:!0,sc:200,serviceName:I,responseDetail:JSON.stringify(V.addressList),firstSuccess:Y===0,responseTime:z,serverIp:c[Y%c.length]}),!1),(V,Y)=>(Ue.apworkerEvent(T,{success:!1,sc:V.data&&V.data.code||200,serviceName:I,responseTime:z,serverIp:c[Y%c.length]}),!!(V.code!==A.OPERATION_ABORTED&&V.code!==A.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(K=c[(Y+1)%c.length],!0)),h)}(r,t,s,n);this.emit(Nn.STATE_CHANGE,Mr.AP_CONNECTED);const{addressList:o}=i;return this.wmSequence++,o}async connectWorkerManager(t){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=s,this.emit(Nn.STATE_CHANGE,Mr.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(bt.CONNECTED,async()=>{this.emit(Nn.STATE_CHANGE,Mr.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(bt.CLOSED,()=>{this._innerConnectionState<Mr.GET_WORKER_MANAGER_RESPONSE&&b.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(bt.FAILED,()=>{this._innerConnectionState<Mr.GET_WORKER_MANAGER_RESPONSE&&b.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(bt.RECONNECTING,()=>{this._innerConnectionState<Mr.GET_WORKER_MANAGER_RESPONSE&&b.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(bt.ON_MESSAGE,async t=>{this.emit(Nn.STATE_CHANGE,Mr.GET_WORKER_MANAGER_RESPONSE);const s=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(t.data);if(n.code!==200)throw b.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new $(A.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&s))throw b.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new $(A.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const r=C("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,i=s.replace(/:\d+\/?$/,":".concat(r));this.emit(Nn.STATE_CHANGE,Mr.CONNECT_WORKER,i),this._needWorkUrlOnly?this.emit(Nn.REQUEST_NEW_WORKER_URL,i):await this.connectWorker(i)}}),this.workerManagerConnection.on(bt.WILL_RECONNECT,(t,s,n)=>{n(t)}),this.workerManagerConnection.on(bt.REQUEST_NEW_URLS,(t,s)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(s)})}handleWorkerEvents(){this.workerConnection.on(bt.CONNECTED,async()=>{this.emit(Nn.STATE_CHANGE,Mr.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Lr.CONNECTED}),this.workerConnection.on(bt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const n=oY(new Uint8Array(t.data));if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&b.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Nn.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var s;const r={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},i=or(s=Object.keys(r)).call(s,(c,l)=>r[c]>r[l]?c:l,"porn"),o=Object.keys(r).find(c=>c===i);this.emit(Nn.INSPECT_RESULT,o)}else this.emit(Nn.INSPECT_RESULT,void 0,new $(A.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Nn.INSPECT_RESULT,void 0,new $(A.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else b.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Nn.INSPECT_RESULT,void 0,new $(A.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(bt.CLOSED,()=>{this.connectionState=Lr.CLOSED}),this.workerConnection.on(bt.FAILED,()=>{this.connectionState=Lr.CLOSED}),this.workerConnection.on(bt.RECONNECTING,()=>{this.connectionState=this.connectionState===Lr.CONNECTED?Lr.RECONNECTING:Lr.CONNECTING}),this.workerConnection.on(bt.WILL_RECONNECT,(t,s,n)=>{t==="recover"&&n(t),n("tryNext")}),this.workerConnection.on(bt.REQUEST_NEW_URLS,(t,s)=>{this.workerManagerConnection.close(),this.once(Nn.REQUEST_NEW_WORKER_URL,n=>{t([n])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n=>{this.connectWorkerManager(n,!0)}).catch(n=>{s(n)})})}async requestToInspectImage(){this.sequence++;const t=Ua(this,Nn.CLIENT_LOCAL_VIDEO_TRACK),s={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(Nn.INSPECT_RESULT,void 0,new $(A.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(t,s);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(Nn.INSPECT_RESULT,void 0,new $(A.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,s){let{appId:n,cname:r,cid:i,vid:o,sid:c,uid:l}=s;const d=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),p=await mA(h,n,r),m=this.sequence+"-"+i+"-"+l+"-"+d+"-"+Jt(12,""),g={appId:n,cid:i,cname:r,deviceId:"",elapse:(T=Number(d-this.inspectStartTime),{low:T|=0,high:T>>31,unsigned:T>=0}),fileSize:p.byteLength,jpgEncryption:2,height:h.height,width:h.width,jpg:p,networkType:6,osType:7,requestId:m,sdkVersion:"4.24.2",sequence:this.sequence,sid:c,timestamp:Wk(d),uid:l,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var T;this.extraInfo===void 0&&delete g.callbackData,this.ossFilePrefix===void 0&&delete g.ossFilePrefix;const w=iY(g);if(w.byteLength<this.workerMessageLengthLimit){if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const S=function(I){for(var O=1;O<arguments.length;O++){var M=arguments[O]!=null?arguments[O]:{};O%2?V1(Object(M),!0).forEach(function(z){N(I,z,M[z])}):Object.getOwnPropertyDescriptors?Object.defineProperties(I,Object.getOwnPropertyDescriptors(M)):V1(Object(M)).forEach(function(z){Object.defineProperty(I,z,Object.getOwnPropertyDescriptor(M,z))})}return I}({},g);delete S.jpg,b.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(S))}return w}{const S=this.quality*this.qualityRatio;return this.quality=S,await this.generateRequestData(t,{appId:n,cname:r,cid:i,vid:o,sid:c,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ba.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Lr.CLOSED,this.emit(Nn.STATE_CHANGE,Mr.CLOSED)}}const gY={name:"ContentInspect",create:function(e){let{config:t}=e;return function(s){if(!s)throw new $(A.INVALID_PARAMS,"inspectConfig is necessary.");if(!s.inspectType||!Array.isArray(s.inspectType))throw new $(A.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const n=[...new Set(s.inspectType)];n.forEach(r=>{var i;if(!_e(i=["supervise","moderation"]).call(i,r))throw new $(A.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))}),s.inspectType=n}if(s&&s.extraInfo&&s.extraInfo.length>1024)throw new $(A.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(t),new fY(t)}};var F1=E(rt.Object.getOwnPropertySymbols),xY=Xt,bY=Vg.indexOf,_Y=Yh,Kv=pe([].indexOf),B1=!!Kv&&1/Kv([1],1,-0)<0;xY({target:"Array",proto:!0,forced:B1||!_Y("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return B1?Kv(this,e,t)||0:bY(this,e,t)}});var vY=ir("Array","indexOf"),EY=X,yY=vY,Yv=Array.prototype,wY=function(e){var t=e.indexOf;return e===Yv||EY(Yv,e)&&t===Yv.indexOf?yY:t},G1=E(wY);function SY(e,t){if(e==null)return{};var s,n,r=function(o,c){if(o==null)return{};var l={};for(var d in o)if({}.hasOwnProperty.call(o,d)){if(G1(c).call(c,d)!==-1)continue;l[d]=o[d]}return l}(e,t);if(F1){var i=F1(e);for(n=0;n<i.length;n++)s=i[n],G1(t).call(t,s)===-1&&{}.propertyIsEnumerable.call(e,s)&&(r[s]=e[s])}return r}let W1=class{get localCapabilities(){return _s(this._localCapabilities)}get rtpCapabilities(){return _s(this._rtpCapabilities)}get candidates(){return _s(this._candidates)}get iceParameters(){return _s(this._iceParameters)}get dtlsParameters(){return _s(this._dtlsParameters)}constructor(e){N(this,"sessionDesc",void 0),N(this,"_localCapabilities",void 0),N(this,"_rtpCapabilities",void 0),N(this,"_candidates",void 0),N(this,"_iceParameters",void 0),N(this,"_dtlsParameters",void 0),N(this,"setup",void 0),N(this,"currentMidIndex",void 0),N(this,"cname","o/i14u9pJrxRKAsu"),N(this,"firefoxSsrcMidMap",new Map),e=_s(e);const{remoteIceParameters:t,remoteDtlsParameters:s,candidates:n,remoteRTPCapabilities:r,localCapabilities:i,direction:o,setup:c,videoCodec:l,audioCodec:d}=e;let h;this.setup=c,h=o===fa.RECEIVE_ONLY?ha(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):ha(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=n,this._iceParameters=t,this._dtlsParameters=s,this._localCapabilities=i;const p=o===fa.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,m=o===fa.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,g=o===fa.RECEIVE_ONLY?r.send.videoCodecs:Zu(Le.VIDEO,p,m,l),T=o===fa.RECEIVE_ONLY?r.send.audioCodecs:Zu(Le.AUDIO,p,m,d);for(const w of h.mediaDescriptions)w.attributes.iceUfrag=t.iceUfrag,w.attributes.icePwd=t.icePwd,w.attributes.fingerprints=s.fingerprints,w.attributes.candidates=n,w.attributes.setup=this.setup,w.media.mediaType==="application"&&(w.attributes.sctpPort="5000"),w.media.mediaType==="video"&&(w.media.fmts=g.map(S=>S.payloadType.toString(10)),w.attributes.payloads=g,w.attributes.extmaps=p.videoExtensions),w.media.mediaType==="audio"&&(w.media.fmts=T.map(S=>S.payloadType.toString(10)),w.attributes.payloads=T,w.attributes.extmaps=p.audioExtensions,vd(w));this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return ao(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===e)}send(e,t,s,n,r){s=s.replace(/ /g,"-");const{ssrcs:i,ssrcGroups:o}=$u(t,this.cname,C("SYNC_GROUP")?s:void 0),c=this.findPreloadMediaDesc(i);if(c){if(bs()&&this.firefoxSsrcMidMap.set(i[0].ssrcId,c.attributes.mid),r&&(r.twcc||r.remb)){const l=this.sessionDesc.mediaDescriptions.indexOf(c);return this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(c,r),{mid:c.attributes.mid,needExchangeSDP:!0}}return{mid:c.attributes.mid,needExchangeSDP:!1}}{const l=this.findAvailableMediaIndex(e,i,n);let d;return l===-1?(d=this.createOrRecycleSendMedia(e,i,o,"sendonly",n,r),this.updateBundleMids()):(d=_s(this.sessionDesc.mediaDescriptions[l]),d.attributes.direction="sendonly",d.attributes.ssrcs=i,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(d,r)),bs()&&this.firefoxSsrcMidMap.set(i[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>s.attributes.mid&&e.indexOf(s.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(s=>{s.attributes.ssrcs=[]}),this.updateBundleMids()}receive(e,t,s){const n=[];return e.forEach(r=>{const i=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(i);let c,l=!1;o===-1?(l=!0,c=this.createOrRecycleRecvMedia(r,[],"recvonly",t,s),this.updateBundleMids()):(c=_s(this.sessionDesc.mediaDescriptions[o]),c.attributes.direction="recvonly"),n.push({mid:c.attributes.mid,needCreateTransceiver:l})}),n}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>e.indexOf(s.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(s=>{s.media.port="0",s.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:s,address:n,port:r,type:i,relatedAddress:o,relatedPort:c,priority:l}=new RTCIceCandidate(e),d={foundation:t??"",componentId:"1",transport:s??"",priority:l?l+"":"",connectionAddress:n??"",port:r?r+"":"",type:i?i+"":"",relAddr:o??"",relPort:c?c+"":"",extension:{}};this.candidates.some(h=>h.priority===d.priority&&h.connectionAddress===d.connectionAddress&&h.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(h=>{h.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,s,n,r){const i=e._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,c=Zu(i,o,this.localCapabilities.send,i===Le.AUDIO?r:n),l=i===Le.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let h={media:{mediaType:i,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:s,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};h=this.mungRecvMediaDsec(h,e);const p=this.findFirstClosedMedia(i);if(p){const m=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[m]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>_e(e).call(e,s.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(s=>{s.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(s=>_e(e).call(e,s.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(s=>{s.attributes.direction="recvonly"})}findAvailableMediaIndex(e,t,s){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(bs()){if(r){const i=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(i||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!i||i!==n.attributes.mid)}return!1}return r&&n.attributes.mid===s})}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const s=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&s})}predictReceivingMids(e){const t=[];for(let s=0;s<e;s++)t.push((this.currentMidIndex+s+1).toString(10));return t}restartICE(e){e=_s(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}createOrRecycleSendMedia(e,t,s,n,r,i){const o=this.rtpCapabilities.send,c=e===Le.VIDEO?o.videoCodecs:o.audioCodecs,l=e===Le.VIDEO?o.videoExtensions:o.audioExtensions;bs()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:s,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,i);const h=this.findFirstClosedMedia(e);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,s){const n=_s(e);return V_(n),Kc(n,t),F_(n,t),kD(n),sf(n,s,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const s=_s(e);return sf(s,t,this.localCapabilities.recv),vd(s),s}updateRecvMedia(e,t){const s=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===e);if(s!==-1){const n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[s],t);this.sessionDesc.mediaDescriptions[s]=n}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var s;return((s=t.attributes)===null||s===void 0||(s=s.ssrcs[0])===null||s===void 0?void 0:s.ssrcId)===e[0].ssrcId})}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>bs()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}};const NY=["sdp"];var vs;function H1(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function sc(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?H1(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):H1(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let z1=(vs=class Vd extends fD{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,s;return(t=(s=this.peerConnection.getReceivers()[0])===null||s===void 0||(s=s.transport)===null||s===void 0?void 0:s.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,s,n){super(t,s),N(this,"direction",void 0),N(this,"name",void 0),N(this,"store",void 0),N(this,"spec",void 0),N(this,"peerConnection",void 0),N(this,"initialOffer",void 0),N(this,"transport",void 0),N(this,"statsFilter",void 0),N(this,"localCandidateCount",0),N(this,"_isInRestartIce",!1),N(this,"mutex",void 0),N(this,"onLocalCandidate",void 0),N(this,"remoteSDP",void 0),N(this,"pendingCandidates",[]),N(this,"localCapabilities",void 0),N(this,"isReady",!1),N(this,"restartCnt",0),N(this,"curTurnServerIndex",0),this.store=s,this.spec=t,this.mutex=new wn("P2PConnection-mutex",s.clientId),this.peerConnection=new RTCPeerConnection(Vd.resolvePCConfiguration(t,s.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=n??fa.SEND_ONLY,this.name=this.direction===fa.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Sm(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,bs()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const s=await G_();if(this.localCapabilities=Qu(s),t){const{sdp:n}=t,r=SY(t,NY),i=function(){const h={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},p=Ju(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vr(p,h,"videoExtensions",m,g,T),Vr(p,h,"videoCodecs",m,g,T),Vr(p,h,"audioExtensions",m,g,T),Vr(p,h,"audioCodecs",m,g,T),C("RAISE_H264_BASELINE_PRIORITY")){const w=T.videoCodecs.findIndex(S=>S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&S.fmtp&&S.fmtp.parameters["profile-level-id"]==="42001f");if(w!==-1){const S=T.videoCodecs.findIndex(I=>I.rtpMap&&I.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(S<w){b.debug("raising H264 baseline profile priority");const I=T.videoCodecs[w];T.videoCodecs.splice(w,1),T.videoCodecs.splice(S,0,I)}S!==-1&&C("FILTER_SEND_H264_BASELINE")&&(m.videoCodecs=m.videoCodecs.filter(I=>!(I.rtpMap&&I.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&I.fmtp&&I.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:m,recv:g,sendrecv:T}}({},{},n);this.remoteSDP=new W1({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:i,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const c=ji(o.sdp);await this.peerConnection.setLocalDescription(o);const l=await PD({},{},o.sdp);this.localCapabilities=Qu(l);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),sc(sc({},c),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=ji(n.sdp);return this.initialOffer=n,sc(sc({},r),{},{sdp:n.sdp})}}catch(s){throw new se(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,s.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:s,iceParameters:n,dtlsParameters:r}=t,i=await PD({},{},s);this.remoteSDP=new W1({remoteIceParameters:n,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:i,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(s.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(s=>{this.peerConnection.addIceCandidate(s)}),this.pendingCandidates=[])}catch(s){throw new se(A.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(s.toString()))}}send(t,s,n){var r=this;return xa(function*(){const i=yield yt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],c=r.remoteSDP.receive(t,s,n);t.forEach((S,I)=>{if(c[I].needCreateTransceiver){const O=r.peerConnection.addTransceiver(S._mediaStreamTrack,{direction:"sendonly"});o.push(O),S._updateRtpTransceiver(O)}else{const O=r.peerConnection.getTransceivers().find(M=>M.mid===c[I].mid);if(!O)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(c[I].mid));o.push(O),S._updateRtpTransceiver(O)}}),bs()&&C("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(o,t)));const l=c.map(S=>S.mid),d=yield yt(r.peerConnection.createOffer()),h=r.mungSendOfferSDP(d.sdp,t,l),p=ha(h),m=l.map(S=>{const I=p.mediaDescriptions.find(O=>O.attributes.mid===S);if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return U_(I,C("USE_PUB_RTX"))}),g=o.map((S,I)=>{const O=l[I];return{localSSRC:m[I],id:O}});yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h}));try{yield g}catch(S){const I=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield yt(r.stopSending(l,!0)),S}yield yt(r.applySimulcastEncodings(o,t)),yield yt(r.applySendEncodings(o,t));const T=r.remoteSDP.toString(),w=r.logSDPExchange(h,"offer","local","send");return w==null||w(T),yield yt(r.setRemoteDescription({type:"answer",sdp:T})),o.map((S,I)=>{const O=l[I];return{localSSRC:m[I],id:O}})}catch(o){throw o instanceof se?o:new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{i()}})()}async stopSending(t,s){const n=s?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));r.map(l=>{var d;l.direction="inactive",(d=l.stop)===null||d===void 0||d.call(l)});const i=await this.peerConnection.createOffer(),o=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();o==null||o(c),await this.setRemoteDescription({type:"answer",sdp:c})}catch(r){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(t,s,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:i,needExchangeSDP:o}=this.remoteSDP.send(t,s,n,r);if(o){const l=this.remoteSDP.toString(),d=this.logSDPExchange(l,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:l});const h=await this.peerConnection.createAnswer(),p=this.mungReceiveAnswerSDP(h.sdp,i,t);d==null||d(p||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:p}),b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const c=this.peerConnection.getTransceivers().find(l=>l.mid===i);if(!c||c.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,mid:c.mid,transceiver:c}}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async mockReceive(t,s,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:i,needExchangeSDP:o}=this.remoteSDP.send(t,s,n,r);if(o){const c=this.remoteSDP.toString(),l=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer(),h=this.mungReceiveAnswerSDP(d.sdp,i,t);l==null||l(h||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:h}),b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(s.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===jc.Auto&&(this.store.p2pTransport=jc.SdRtn,At().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Vd.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,At().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Vd.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const s=await this.peerConnection.createOffer({iceRestart:!0});if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:n}=ji(s.sdp);return this.store.descriptionStart(),this.direction===fa.SEND_ONLY&&await this.peerConnection.setLocalDescription(s),n}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===fa.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:n}=ji(s.sdp);return await this.peerConnection.setLocalDescription(s),n}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(s.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[s],[t]);this.remoteSDP.updateRecvMedia(t,s);const i=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new se(A.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,s){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===t);n.length===1&&(this.isVP8Simulcast(s)?bs()||await this.applySimulcastEncodings(n,[s]):await this.applySendEncodings(n,[s]))}setStatsRemoteVideoIsReady(t,s){this.statsFilter.setVideoIsReady2(t,s)}async replaceTrack(t,s){const n=this.peerConnection.getTransceivers().find(r=>r.mid===s);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const s=t[0].transport.iceTransport,{local:n,remote:r}=s.getSelectedCandidatePair();return{local:sc(sc({},kr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:sc(sc({},kr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,s;_e(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(s=this.onICEConnectionStateChange)===null||s===void 0||s.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var s;t.candidate.candidate&&((s=this.onLocalCandidate)===null||s===void 0||s.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,s){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var i;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Cc(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...Vd.turnServerConfigToIceServers(t.turnServer.servers,s,n)),C("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...Vd.turnServerConfigToIceServers(t.turnServer.serversFromGateway,s,n)),_e(i=[jc.Relay,jc.SdRtn]).call(i,s)&&(r.iceTransportPolicy="relay"),C("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(r.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&At().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),b.debug("P2PConnection p2pTransport is ".concat(s)),r}static turnServerConfigToIceServers(t,s){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],i=t.filter(c=>c.tcpport);b.debug("P2PConnection turnServers is ".concat(i,", current index is ").concat(n));const o=i.length>n?i[n]:i[0];switch(s){case jc.SdRtn:const c=t.filter(d=>{var h;return _e(h=d.username).call(h,"glb:")&&d.turnServerURL==d.turnServerURL}),l=c.length>n?c[n]:c[0];l&&(r.push({username:l.username,credential:l.password,credentialType:"password",urls:"turn:".concat(Ur(l.turnServerURL),":").concat(l.tcpport,"?transport=udp")}),r.push({username:l.username,credential:l.password,credentialType:"password",urls:"turns:".concat(Ur(l.turnServerURL),":").concat(l.tcpport,"?transport=tcp")}));break;case jc.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Ur(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Ur(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var n;t!=null&&t.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,t.state))},t.onerror=n=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in n?n.error:n)};const s=t.iceTransport;s&&(s.onstatechange=()=>{const n=t==null?void 0:t.iceTransport.state;var r;n&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,n))},s.getSelectedCandidatePair&&(s.onselectedcandidatepairchange=()=>{if(s.getSelectedCandidatePair()){const{local:n,remote:r}=s.getSelectedCandidatePair()||{};if(n&&r){const i=n.address+":"+n.port,o=r.address+":"+r.port;b.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ki(i)),", remote ").concat(JSON.stringify(ki(o))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,s){var n;if(s||(s=this.peerConnection.getSenders().find(h=>h.track===t._mediaStreamTrack)),!s)return b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return b.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!At().supportSetRtpSenderParameters)return b.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},i={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:h,frameRate:p,scaleResolutionDownBy:m}=t._encoderConfig;h&&(i.maxBitrate=1e3*h),_e(o=t._hints).call(o,qt.LOW_STREAM)&&(p&&(i.maxFramerate=ya(p)),m&&m>=1&&(i.scaleResolutionDownBy=m))}if(C("DSCP_TYPE")&&Ci()){var c;const h=C("DSCP_TYPE");_e(c=["very-low","low","medium","high"]).call(c,h)&&(i.networkPriority=h)}const l=s.getParameters(),d=(n=l.encodings)===null||n===void 0?void 0:n[0];bs()&&!d&&(r.encodings=[i]),d&&Object.assign(d,i),Object.assign(l,r),b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await s.setParameters(l)}async applySendEncodings(t,s){try{if(!At().supportSetRtpSenderParameters||t.length!==s.length)return;for(let n=0;n<t.length;n++){const r=t[n],i=s[n];i instanceof os&&!this.isVP8Simulcast(i)&&await this.updateRtpSenderEncodings(i,r.sender)}}catch{b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,s,n){const r=ha(t);return s.forEach((i,o)=>{const c=n[o],l=r.mediaDescriptions.find(d=>d.attributes.mid===c);l&&(Kc(l,i),B_(l,i,this.store.codec))}),ao(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var s;(s=this.onFirstAudioReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var s;(s=this.onFirstVideoReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var s;(s=this.onFirstAudioDecoded)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,s,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,s,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,s)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,s)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var s;(s=this.onFirstVideoDecodedTimeout)===null||s===void 0||s.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,s){if(t.length===s.length)for(let l=0;l<t.length;l++){var n,r,i,o,c;const d=t[l],h=s[l];if(h instanceof os&&!_e(n=h._hints).call(n,qt.LOW_STREAM)&&(r=h._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=h._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=h._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},m={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:m.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:m.high}];const g=d.sender.getParameters();await d.sender.setParameters(Object.assign(g,p))}}}async applySimulcastEncodings(t,s){if(!bs()&&t.length===s.length)for(let n=0;n<t.length;n++){const r=s[n];if(r instanceof os&&this.isVP8Simulcast(r)){const i=t[n],o={},c={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=i.sender.getParameters();await i.sender.setParameters(Object.assign(l,o))}}}isVP8Simulcast(t){var s,n,r,i,o;return!!(t instanceof os&&C("SIMULCAST")&&this.store.codec==="vp8"&&!_e(s=t._hints).call(s,qt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(i=t._scalabilityMode)!==null&&i!==void 0&&i.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,s,n,r){if(C("SDP_LOGGING"))return b.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(s," SDP during P2PConnection.").concat(r,`
`),t),s==="offer"?i=>{this.logSDPExchange(i,"answer",n==="local"?"remote":"local",r)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const i=this.remoteSDP.toString();r==null||r(i),await this.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(s.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(async o=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t);const i=this.remoteSDP.toString();r==null||r(i),await this.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(s.toString()))}}async getRemoteSSRC(t,s){var n;if(s=s??((n=this.currentRemoteDescription)===null||n===void 0?void 0:n.sdp)){var r;const i=(r=ha(s).mediaDescriptions.find(o=>o.attributes.mid===t))===null||r===void 0?void 0:r.attributes.ssrcs;return i==null?void 0:i[0].ssrcId}}async setRemoteDescription(t){var s;await this.peerConnection.setRemoteDescription(t),_e(s=["connected","completed"]).call(s,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,s,n){const r=ha(t),i=r.mediaDescriptions.find(o=>o.attributes.mid===s);return i&&n===Le.AUDIO&&i.media.mediaType==="audio"&&vd(i),ao(r)}},Re(vs.prototype,"establish",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"establish"),vs.prototype),Re(vs.prototype,"connect",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"connect"),vs.prototype),Re(vs.prototype,"receive",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"receive"),vs.prototype),Re(vs.prototype,"mockReceive",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"mockReceive"),vs.prototype),Re(vs.prototype,"stopReceiving",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"stopReceiving"),vs.prototype),Re(vs.prototype,"restartICE",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"restartICE"),vs.prototype),Re(vs.prototype,"close",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"close"),vs.prototype),Re(vs.prototype,"updateEncoderConfig",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"updateEncoderConfig"),vs.prototype),Re(vs.prototype,"updateSendParameters",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"updateSendParameters"),vs.prototype),Re(vs.prototype,"replaceTrack",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"replaceTrack"),vs.prototype),Re(vs.prototype,"muteLocal",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"muteLocal"),vs.prototype),Re(vs.prototype,"unmuteLocal",[Hr],Object.getOwnPropertyDescriptor(vs.prototype,"unmuteLocal"),vs.prototype),vs);function Hr(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}let hi=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});var K1,Y1,q1,X1,J1,$1,Q1,Z1,eP,tP,sP,Is;function nP(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Vf(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?nP(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):nP(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let TY=(K1=pi(hi.SEND_ONLY),Y1=pi(hi.SEND_ONLY),q1=pi(),X1=pi(hi.RECEIVE_ONLY),J1=pi(hi.RECEIVE_ONLY),$1=pi(hi.RECEIVE_ONLY),Q1=pi(hi.RECEIVE_ONLY),Z1=pi(hi.RECEIVE_ONLY),eP=pi(hi.RECEIVE_ONLY),tP=pi(),sP=pi(hi.RECEIVE_ONLY),Is=class extends Cs{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Xe.StateChange,t,this._state)}constructor(e,t){super(),N(this,"isPlanB",!1),N(this,"store",void 0),N(this,"statsUploader",void 0),N(this,"sendConnection",void 0),N(this,"recvConnection",void 0),N(this,"localTrackMap",new Map),N(this,"remoteUserMap",new Map),N(this,"localDataChannels",[]),N(this,"pendingLocalTracks",[]),N(this,"pendingRemoteTracks",[]),N(this,"statsCollector",void 0),N(this,"dtlsFailedCount",0),N(this,"sendMutex",void 0),N(this,"recvMutex",void 0),N(this,"_state",Yt.Disconnected),N(this,"_restartStates",["disconnected","failed"]),N(this,"reconnectInterval",void 0),N(this,"uploadUnplinkStarted",!1),N(this,"uploadDownlinkStarted",!1),N(this,"uplinkStateUploadInterval",void 0),N(this,"downlinkStatsUploadInterval",void 0),N(this,"handleMuteLocalTrack",async(s,n,r)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Yt.Connected)return void r(new se(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const l=this.filterTobeMutedTracks(s);if(l.length===0)return void n();const d=l.find(g=>g[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(l.map(g=>{let[,{id:T}]=g;return T}));let h=!1;var o,c;s.trackMediaType==="video"?h=!((o=this.localTrackMap.get(ve.LocalAudioTrack))===null||o===void 0||!o.track._muted):h=((c=this.localTrackMap.get(ve.LocalVideoTrack))===null||c===void 0?void 0:c.id)===void 0;const p=this.createMuteMessage(l);await ls(this,Xe.RequestMuteLocal,p);const m=s.trackMediaType==="video"?Ho.MUTE_LOCAL_VIDEO:Ho.MUTE_LOCAL_AUDIO;await ls(this,Xe.RequestP2PMuteLocal,{action:m,message:p,isMuteAll:h}),n()}catch(l){r(l)}finally{i()}}),N(this,"handleUnmuteLocalTrack",async(s,n,r)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Yt.Connected)return void r(new se(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const o=this.filterTobeUnmutedTracks(s);if(o.length===0)return void n();await this.sendConnection.unmuteLocal(o.map(d=>{let[,{id:h}]=d;return h}));const c=this.createUnmuteMessage(o),l=s.trackMediaType==="video"?Ho.UNMUTE_LOCAL_VIDEO:Ho.UNMUTE_LOCAL_AUDIO;await ls(this,Xe.RequestP2PMuteLocal,{action:l,message:c}),n()}catch(o){r(o)}finally{i()}}),N(this,"handleUpdateVideoEncoder",async(s,n,r,i)=>{let o;typeof i=="boolean"&&i||(o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get(ve.LocalVideoTrack);if(!this.sendConnection||!l||l.track!==s||this.state!==Yt.Connected)return void n();const{id:d,track:h}=l;d&&(await this.sendConnection.updateSendParameters(d,h),await this.sendConnection.updateEncoderConfig(d,h),this.emit(Xe.UpdateVideoEncoder,h)),n()}catch(l){r(l)}finally{var c;(c=o)===null||c===void 0||c()}}),N(this,"handleUpdateVideoSendParameters",async(s,n,r)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(ve.LocalVideoTrack);if(!this.sendConnection||!o||o.track!==s||this.state!==Yt.Connected)return void n();const{id:c,track:l}=o;c&&await this.sendConnection.updateSendParameters(c,l),n()}catch(o){r(o)}finally{i()}}),N(this,"handleReplaceTrack",async(s,n,r,i)=>{let o;b.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(s.getTrackId(),"]")),typeof i=="boolean"&&i||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var c;const d=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:p}]=h;return s===p});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==Yt.Connected)return void n();if(await((c=this.sendConnection)===null||c===void 0?void 0:c.replaceTrack(s,d[1].id)),d[0]===ve.LocalVideoTrack&&At().supportDualStreamEncoding){const h=this.localTrackMap.get(ve.LocalVideoLowTrack);if(h){const p=s._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=p,h.track._originMediaStreamTrack=p,await new Te((m,g)=>{this.handleReplaceTrack(h.track,m,g,!0)})}}n()}catch(d){r(d)}finally{var l;(l=o)===null||l===void 0||l()}}),N(this,"handleGetLocalVideoStats",s=>{s(this.statsCollector.getLocalVideoTrackStats())}),N(this,"handleGetLocalAudioStats",s=>{s(this.statsCollector.getLocalAudioTrackStats())}),N(this,"handleGetRemoteVideoStats",s=>this.statsCollector.getRemoteVideoTrackStats(s.uid)[s.uid]),N(this,"handleGetRemoteAudioStats",s=>this.statsCollector.getRemoteAudioTrackStats(s.uid)[s.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new xk(e),this.bindStatsUploaderEvents(),this.sendMutex=new wn("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new wn("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(s=>{s&&(s.iceConnectionState!=="disconnected"&&s.iceConnectionState!=="failed"||this.handleDisconnect(s.direction))})},C("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new se(A.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new se(A.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let s;try{if(t){this.recvConnection&&(b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),s=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new z1(e,this.store,fa.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const n=await this.recvConnection.establish(t);return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}{this.state=Yt.New,this.sendConnection&&(b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),s=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new z1(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const n=await this.sendConnection.establish();return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}}finally{s&&s()}}async p2pConnect(e){if(!this.sendConnection)throw new se(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Yt.Connected}async addRemoteCandidate(e,t){if(t===fa.RECEIVE_ONLY){if(!this.sendConnection)throw new se(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new se(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,s){var n=this;return xa(function*(){const r=yield yt(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==Yt.Connected){n.throwIfTrackTypeNotMatch(e);const d=e.filter(h=>n.pendingLocalTracks.indexOf(h)===-1);return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(d))}n.store.pubId=n.store.pubId+1,Hn.markPublishStart(n.store.clientId,n.store.pubId);const i=n.filterTobePublishedTracks(e,t,s);if(i.length===0)return void(yield yt(n.tryToUnmuteAudio(e)));i.forEach(d=>{let{track:h,type:p}=d;const m=Date.now();n.store.publish(h.getTrackId(),p===ve.LocalAudioTrack?"audio":"video",m)}),n.bindLocalTrackEvents(i);const o=yield yt(n.sendConnection.send(i.map(d=>{let{track:h}=d;return h}),n.store.codec,n.store.audioCodec)),c=(yield yt(o.next())).value,l=n.createGatewayPublishMessage(i,c);try{yield l}catch(d){throw o.throw(d),(d==null?void 0:d.code)===A.WS_ABORT&&i.forEach(h=>{let{track:p}=h;n.pendingLocalTracks.indexOf(p)===-1&&n.pendingLocalTracks.push(p)}),n.unbindLocalTrackEvents(i),d}yield yt(o.next()),i.forEach(d=>{let{type:h}=d;n.statsCollector.addLocalStats(h)}),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(i,c),i.forEach(d=>{let{track:h,type:p}=d;const m=Date.now();n.store.publish(h.getTrackId(),p===ve.LocalAudioTrack?"audio":"video",void 0,m)}),n.startUploadUplinkState()}finally{r()}})()}async unpublish(e){if(!this.sendConnection||this.state!==Yt.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!_e(e).call(e,r)));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const s=t.find(r=>r[0]==="videoLowTrack");s&&s[1].track.close();const n=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map(r=>{let[,{id:i}]=r;return i})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(r=>{let[i,{track:o}]=r;return{type:i,track:o}})),t.forEach(r=>{let[i]=r;this.statsCollector.removeLocalStats(i)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Yt.Connected)return s&&s[1].track.close(),n;e.forEach(r=>{const i=this.pendingLocalTracks.indexOf(r);i!==-1&&this.pendingLocalTracks.splice(i,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],s=[];Array.from(this.localTrackMap.entries()).forEach(n=>{let[r,{track:i,ssrcs:o}]=n;const c={stream_type:mK(i,r),ssrcs:o};i._muted||!i._enabled?t.push(c):s.push(c)}),t.length>0&&t.forEach(n=>{ls(this,Xe.RequestMuteLocal,[n])}),s.length>0&&s.forEach(n=>{ls(this,Xe.RequestUnmuteLocal,[n])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return xa(function*(){throw new se(A.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(b.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Qs(this,Xe.RequestRePublish,this.pendingLocalTracks),this.emit(Xe.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new se(A.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,s,n){var r;if(!this.recvConnection)throw new se(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(e))!==null&&r!==void 0&&r.has(t))return;const{track:i,mid:o,transceiver:c}=await this.recvConnection.receive(t,[{ssrcId:s}],String(e.uid),n);t===Le.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(i):(e._audioTrack=new hd(i,e.uid,e._uintid,this.store),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=s,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(i):(e._videoTrack=new ud(i,e.uid,e._uintid,this.store),b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const l=this.remoteUserMap.get(e);l?l.set(t,o):this.remoteUserMap.set(e,new Map([[t,o]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex(h=>{let{user:p,kind:m}=h;return p.uid===e.uid&&t===m});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(Xe.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,s,n){if(!this.recvConnection)throw new se(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:s}],String(e.uid),n)}async unsubscribe(e,t,s){const n=this.pendingRemoteTracks.filter(i=>{let{user:o,kind:c}=i;return t!==void 0?o.uid===e.uid&&t===c:o.uid===e.uid});if(n.forEach(i=>{const o=this.pendingRemoteTracks.indexOf(i);this.pendingRemoteTracks.splice(o,1)}),this.recvConnection||s||n.forEach(i=>{let{kind:o}=i;var c;if(o===Le.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(o===Le.VIDEO){var l;(l=e._videoTrack)===null||l===void 0||l._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(i=>{let[,{id:o}]=i;return o})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(i=>{let[o,{kind:c}]=i;var l,d;if(c===Le.VIDEO&&o._videoSSRC&&((l=this.recvConnection)===null||l===void 0||l.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),c===Le.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),s||((d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0);else if(c===Le.AUDIO){var h;this.unbindRemoteTrackEvents(o._audioTrack),!s&&((h=o._audioTrack)===null||h===void 0||h._destroy(),o._audioTrack=void 0)}}),r.forEach(i=>{let[,{kind:o}]=i;ls(this,Xe.RequestP2PMuteRemote,o)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(t=>{let[,s]=t;[Le.VIDEO,Le.AUDIO].forEach(n=>{s.has(n)?ls(this,Xe.RequestP2PUnmuteRemote,n):ls(this,Xe.RequestP2PMuteRemote,n)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new se(A.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new se(A.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new se(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new se(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const s=this.remoteUserMap.get(e);if(!s)return void b.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!s.get(t))return void b.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const n=t===Le.VIDEO?e._videoSSRC:e._audioSSRC;n!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const s=this.remoteUserMap.get(e);if(!s)return void b.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));s.get(t)||b.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(ve.LocalAudioTrack);if((t==null?void 0:t.track)instanceof nn){const s=t.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==ve.LocalAudioTrack}).filter(n=>{let[r]=n;return!(e&&r===ve.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(s.trackList)}return Array.from(this.localTrackMap.entries()).filter(s=>{let[n]=s;return!(e&&n===ve.LocalVideoLowTrack)}).map(s=>{let[,{track:n}]=s;return n})}reportPublishEvent(e,t,s,n,r){if(e){const o=this.localTrackMap.get(ve.LocalAudioTrack),c=n?this.localTrackMap.get(ve.LocalVideoLowTrack):this.localTrackMap.get(ve.LocalVideoTrack);Ue.publish(this.store.sessionId,{eventElapse:Hn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o==null?void 0:o.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(qt.SCREEN_TRACK))!==-1,audio:!!o,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var i;s||(s=[]);const o=s.find(l=>l instanceof Us),c=n?(i=this.localTrackMap.get(ve.LocalVideoTrack))===null||i===void 0?void 0:i.track:s.find(l=>l instanceof os);Ue.publish(this.store.sessionId,{eventElapse:Hn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o==null?void 0:o.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(qt.SCREEN_TRACK))!==-1,audio:!!o,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,s,n){const r=n===Le.VIDEO?s._videoSSRC:s._audioSSRC;r&&Ue.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===Le.VIDEO,audio:n===Le.AUDIO,peerid:s.uid,subscribeRequestid:n===Le.VIDEO?s._videoSSRC:s._audioSSRC,p2pid:this.store.p2pId,eventElapse:Hn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){b.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new wn("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new wn("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(ve.LocalAudioTrack);if((e==null?void 0:e.track)instanceof nn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(s=>{t.removeAudioTrack(s)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Yt.Disconnected}getStats(e){var t,s;return e?(s=this.recvConnection)===null||s===void 0?void 0:s.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(ve.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(ve.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof os||t&&t.track instanceof Us?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const s=this.remoteUserMap.get(e);return!!s&&(!t||s.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const s=this.remoteUserMap.get(e);return!!s&&(!t||s.has(t))}getRemoteMedia(e){var t;const s=Array.from(Jn(t=this.remoteUserMap).call(t)).find(n=>n.uid===e);return s?{audioTrack:s.audioTrack,audioSSRC:s._audioSSRC,videoTrack:s.videoTrack,videoSSRC:s._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(s=>{let[n]=s;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(ve.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=bc(e).call(e,(s,n)=>s.level-n.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(b.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Yt.Reconnecting,C("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var s;t._videoTrack&&t._videoTrack._player&&((s=t._videoTrack._player.getVideoElement())===null||s===void 0||s.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[s,{track:n}]=e;switch(s){case ve.LocalVideoTrack:_e(t=n._hints).call(t,qt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case ve.LocalAudioTrack:n instanceof nn?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case ve.LocalVideoLowTrack:}}),this.emit(Xe.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,s]=e;Array.from(Jn(s).call(s)).forEach(n=>{this.setPendingRemoteMedia(t,n)}),this.emit(Xe.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),b.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const s of this.pendingRemoteTracks){const{user:n,kind:r}=s;if((e instanceof Yo?e.uid:e)===n.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let s,n;if(e===fa.SEND_ONLY){if(!this.sendConnection)throw new se(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");s=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new se(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");s=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(t){const r=await n.restartICE(t);return n.isInRestartIce=!1,r}{const r=await n.restartICE();if(r){const i=await Qs(this,Xe.RequestP2PRestartICE,{direction:fa.RECEIVE_ONLY,iceParameter:r});await n.restartICE(i),n.isInRestartIce=!1}}}finally{s()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(ve.LocalVideoTrack),s=this.localTrackMap.get(ve.LocalAudioTrack),n=e.videoSend.find(g=>{var T;return g.ssrc===(t==null||(T=t.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)}),r=e.audioSend.find(g=>{var T;return g.ssrc===(s==null||(T=s.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)});if(!n||!r)return 1;const i=Ua(this,Xe.NeedSignalRTT),o=n?n.rttMs:void 0,c=r?r.rttMs:void 0,l=o&&c?(o+c)/2:o||c,d=(l&&i?(l+i)/2:l||i)||0,h=100*e.sendPacketLossRate*.7/50+.3*d/1500,p=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,m=t==null?void 0:t.track;if(m&&m._encoderConfig&&m._hints.indexOf(qt.SCREEN_TRACK)===-1){const g=m._encoderConfig.bitrateMax,T=e.bitrate.actualEncoded;if(g&&T){const w=(1e3*g-T)/(1e3*g);return oD[w<.15?0:w<.3?1:w<.45?2:w<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(s=>{let[n]=s;const r=n._audioSSRC,i=n._videoSSRC,o=e.audioRecv.find(T=>T.ssrc===r),c=e.videoRecv.find(T=>T.ssrc===i);if(!o&&!c)return void(t+=1);const l=Ua(this,Xe.NeedSignalRTT),d=e.rtt,h=(d&&l?(d+l)/2:d||l)||0,p=o?o.jitterMs:void 0,m=e.recvPacketLossRate;let g=.7*m*100/50+.3*h/1500;p&&(g=.6*m*100/50+.2*h/1500+.2*p/400),t+=g<.1?1:g<.17?2:g<.36?3:g<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Te((t,s)=>{this.handleMuteLocalTrack(e,t,s)})}filterTobePublishedTracks(e,t,s){const n=[],r=At(),i=this.getAllTracks();e=Ql(e=e.filter(l=>i.indexOf(l)===-1));let o=!1,c=!1;for(const l of e){if(l instanceof os&&(this.localTrackMap.has(ve.LocalVideoTrack)||o?new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:l,type:ve.LocalVideoTrack}),o=!0),t)){const d=this.getLowVideoTrack(l,s);n.push({track:d,type:ve.LocalVideoLowTrack})}if(l instanceof Us){const d=this.localTrackMap.get(ve.LocalAudioTrack);if(d){if(!(d.track instanceof nn))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0)}else if(c){const h=n.find(p=>{let{type:m}=p;return m===ve.LocalAudioTrack});if(!(h.track instanceof nn))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");h.track.addAudioTrack(l)}else{if(!r.webAudioMediaStreamDest||l instanceof nn||l._bypassWebAudio)n.push({track:l,type:ve.LocalAudioTrack});else{const h=new nn;h.addAudioTrack(l),n.push({track:h,type:ve.LocalAudioTrack})}c=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],s=this.getAllTracks();e=Ql(e=e.filter(n=>s.indexOf(n)!==-1));for(const n of e){if(n instanceof Us){const r=this.localTrackMap.get(ve.LocalAudioTrack);if(!r)continue;r.track instanceof nn?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(t.push([ve.LocalAudioTrack,r]),r.track.close())):t.push([ve.LocalAudioTrack,r])}if(n instanceof os){const r=this.localTrackMap.get(ve.LocalVideoTrack);if(!r)continue;t.push([ve.LocalVideoTrack,r]);const i=this.localTrackMap.get(ve.LocalVideoLowTrack);i&&t.push([ve.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:s,type:n}=t;switch(n){case ve.LocalVideoTrack:s.addListener(Be.GET_STATS,this.handleGetLocalVideoStats),s.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.addListener(Be.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),s.addListener(Be.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),s.addListener(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),s.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ve.LocalAudioTrack:this.bindLocalAudioTrackEvents(s);case ve.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof nn?e.trackList.forEach(s=>{s.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.addListener(Be.GET_STATS,this.handleGetLocalAudioStats),s.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(Be.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[s,{track:n}]=t;return{track:n,type:s}})),e.forEach(t=>{let{track:s,type:n}=t;switch(n){case ve.LocalVideoTrack:s.off(Be.GET_STATS,this.handleGetLocalVideoStats),s.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),s.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),s.off(Be.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),s.off(Be.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),s.off(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),s.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),s.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case ve.LocalAudioTrack:this.unbindLocalAudioTrackEvents(s);case ve.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof nn?e.trackList.forEach(t=>{t.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Be.GET_STATS,this.handleGetLocalAudioStats),t.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(Be.GET_STATS,this.handleGetLocalAudioStats),e.off(Be.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Be.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Be.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Be.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Be.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof ud&&t.addListener(Be.GET_STATS,s=>{s(this.handleGetRemoteVideoStats(e))}),t instanceof hd&&t.addListener(Be.GET_STATS,s=>{s(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Be.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,s]=e;s.has(Le.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),s.has(Le.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((s,n)=>{var r;let i,{track:o,type:c}=s;switch(c){case ve.LocalAudioTrack:i=Qt.Audio;break;case ve.LocalVideoTrack:i=_e(r=o._hints).call(r,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:i=Qt.Low}return{kind:c===ve.LocalAudioTrack?Le.AUDIO:Le.VIDEO,stream_type:i,mid:t[n].id,ssrcs:t[n].localSSRC,isMuted:o.muted||!o.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}assignLocalTracks(e,t){e.forEach((s,n)=>{let{track:r,type:i}=s;this.localTrackMap.set(i,{track:r,id:t[n].id,ssrcs:t[n].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[s]=t;this.localTrackMap.delete(s)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var s;b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(Xe.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),_e(s=this._restartStates).call(s,t)&&!e.isInRestartIce&&(t==="disconnected"&&await gn(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Ue.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:is.TRACER}).onSuccess(),this.emit(Xe.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(i=>i._audioSSRC===t);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(ur.FIRST_FRAME_DECODED),Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_AUDIO_DECODE,Ts.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._audioSSRC===t);n&&Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_AUDIO_RECEIVED,Ts.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,s,n)=>{this.reportVideoFirstFrameDecoded(t,s,n)},e.onFirstVideoReceived=t=>{var s;const n=Array.from(Jn(s=this.remoteUserMap).call(s)).find(r=>r._videoSSRC===t);n&&Ue.firstRemoteFrame(this.store.sessionId,sn.FIRST_VIDEO_RECEIVED,Ts.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,s)=>{const n=t.candidateType==="relay",r=s.candidateType==="relay";s.candidateType!=="unknown"&&n===r||this.emit(Xe.ConnectionTypeChange,n),b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(zo(s))," -> ").concat(JSON.stringify(zo(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,s)=>{b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(zo(s))," -> ").concat(JSON.stringify(zo(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(Xe.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===fa.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,b.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===fa.SEND_ONLY?this.restartICE(e):Qs(this,Xe.RequestP2PRestartICE,{direction:fa.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const s=this.localTrackMap.get(ve.LocalAudioTrack);if(e instanceof Us&&(s==null?void 0:s.track)instanceof nn)return s.track.isActive||t.push([ve.LocalAudioTrack,s]),t;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:i}]=r;return e===i});if(n&&(t.push(n),n[0]===ve.LocalVideoTrack)){const r=this.localTrackMap.get(ve.LocalVideoLowTrack);r&&t.push([ve.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],s=this.localTrackMap.get(ve.LocalAudioTrack);if(e instanceof Us&&(s==null?void 0:s.track)instanceof nn)return s.track.isActive&&t.push([ve.LocalAudioTrack,s]),t;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:i}]=r;return e===i});if(n)if(n[0]===ve.LocalVideoTrack){t.push(n);const r=this.localTrackMap.get(ve.LocalVideoLowTrack);r&&t.push([ve.LocalVideoLowTrack,r])}else t.push(n);return t}createMuteMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var s;let n,[r,{track:i,ssrcs:o,id:c}]=t;switch(r){case ve.LocalAudioTrack:n=Qt.Audio;break;case ve.LocalVideoTrack:n=_e(s=i._hints).call(s,qt.SCREEN_TRACK)?Qt.Screen:Qt.High;break;case ve.LocalVideoLowTrack:n=Qt.Low}return{stream_type:n,ssrcs:o,mid:c}})}filterTobeUnSubscribedTracks(e,t){const s=[],n=this.remoteUserMap.get(e);if(!n)return s;if(t){const r=n.get(t);if(!r)return s;s.push([e,{kind:t,id:r}])}else Array.from(n.entries()).forEach(r=>{let[i,o]=r;s.push([e,{kind:i,id:o}])});return s}createUnsubscribeMessage(e){const t=[];return e.forEach(s=>{let[n,{kind:r,id:i}]=s;switch(r){case Le.VIDEO:return void(n._videoSSRC&&t.push({stream_type:Le.VIDEO,ssrcId:n._videoSSRC}));case Le.AUDIO:return void(n._audioSSRC&&t.push({stream_type:Le.AUDIO,ssrcId:n._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[s,{kind:n}]=t;const r=this.remoteUserMap.get(s);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(s))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(ve.LocalVideoTrack),s=this.localTrackMap.get(ve.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new Te((n,r)=>{this.handleUpdateVideoEncoder(t.track,n,r,!0)})),s&&e.low_stream_uplink&&(await s.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new Te((n,r)=>{this.handleUpdateVideoEncoder(s.track,n,r,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Us){const s=this.filterTobeUnmutedTracks(e[t]);if(s.length===0)continue;const n=this.createUnmuteMessage(s);return void await ls(this,Xe.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Xe.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Xe.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await gn(vm(this.dtlsFailedCount,Ys)),this.emit(Xe.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(ve.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof os)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof os).length>1)throw new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Us).length>1&&(e.some(t=>t instanceof Us&&t._bypassWebAudio)||!At().webAudioMediaStreamDest))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof os&&this.pendingLocalTracks.some(s=>s instanceof os))throw new se(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Us&&this.pendingLocalTracks.some(s=>s instanceof Us)&&(!At().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(s=>s instanceof Us&&s._bypassWebAudio)))throw new se(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const s=!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&At().supportDualStreamEncoding,n=Vf(Vf({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=s?e._mediaStreamTrack.clone():ov(e,n);const i=Jt(8,"track-low-"),o=new os(r,Vf(Vf({},s&&{scaleResolutionDownBy:M_(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,i);return o.on(Mc.TRANSCEIVER_UPDATED,c=>{e._updateRtpTransceiver(c,rd.LOW_STREAM)}),o._hints.push(qt.LOW_STREAM),e.addListener(Be.NEED_CLOSE,()=>{o.close()}),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,s,n){var r;const i=Array.from(Jn(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===e);if(i){n||this.store.subscribe(i.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,c=o.subscribe.find(l=>l.userId===i.uid&&l.type==="video");Ue.firstRemoteVideoDecode(this.store.sessionId,sn.FIRST_VIDEO_DECODE,Ts.FIRST_VIDEO_DECODE,{peer:i._uintid,videowidth:t,videoheight:s,subscribeElapse:Hn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,s){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const r=n.get(t);if(!r)return!1;const i=await this.recvConnection.getRemoteSSRC(r);return i!==void 0&&i!==s}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new se(A.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new se(A.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new se(A.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new se(A.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new se(A.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new se(A.NOT_SUPPORTED)}async preConnect(e){throw new se(A.NOT_SUPPORTED)}getEstablishParams(){throw new se(A.NOT_SUPPORTED)}async reSubscribe(e){throw new se(A.NOT_SUPPORTED)}reportVideoFirstFrameRender(e){}async updateVideoStreamParameter(e,t){throw new se(A.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:s}]=e;t===ve.LocalVideoLowTrack?s._updateRtpTransceiver(void 0,rd.LOW_STREAM):s._updateRtpTransceiver(void 0)})}},Re(Is.prototype,"p2pConnect",[K1],Object.getOwnPropertyDescriptor(Is.prototype,"p2pConnect"),Is.prototype),Re(Is.prototype,"unpublish",[Y1],Object.getOwnPropertyDescriptor(Is.prototype,"unpublish"),Is.prototype),Re(Is.prototype,"unpublishLowStream",[q1],Object.getOwnPropertyDescriptor(Is.prototype,"unpublishLowStream"),Is.prototype),Re(Is.prototype,"subscribe",[X1],Object.getOwnPropertyDescriptor(Is.prototype,"subscribe"),Is.prototype),Re(Is.prototype,"mockSubscribe",[J1],Object.getOwnPropertyDescriptor(Is.prototype,"mockSubscribe"),Is.prototype),Re(Is.prototype,"unsubscribe",[$1],Object.getOwnPropertyDescriptor(Is.prototype,"unsubscribe"),Is.prototype),Re(Is.prototype,"muteRemote",[Q1],Object.getOwnPropertyDescriptor(Is.prototype,"muteRemote"),Is.prototype),Re(Is.prototype,"unmuteRemote",[Z1],Object.getOwnPropertyDescriptor(Is.prototype,"unmuteRemote"),Is.prototype),Re(Is.prototype,"hasRemoteMediaWithLock",[eP],Object.getOwnPropertyDescriptor(Is.prototype,"hasRemoteMediaWithLock"),Is.prototype),Re(Is.prototype,"disconnectForReconnect",[tP],Object.getOwnPropertyDescriptor(Is.prototype,"disconnectForReconnect"),Is.prototype),Re(Is.prototype,"remoteMediaSsrcChanged",[sP],Object.getOwnPropertyDescriptor(Is.prototype,"remoteMediaSsrcChanged"),Is.prototype),Is);function pi(e){return function(t,s,n){const r=t[s];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var i=arguments.length,o=new Array(i),c=0;c<i;c++)o[c]=arguments[c];switch(e){case hi.SEND_ONLY:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(s));try{return await r.apply(this,o)}finally{l()}}case hi.RECEIVE_ONLY:{const l=await this.recvMutex.lock("From P2PChannel2.".concat(s));try{return await r.apply(this,o)}finally{l()}}default:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(s)),d=await this.recvMutex.lock("From P2PChannel2.".concat(s));try{return await r.apply(this,o)}finally{l(),d()}}}},n}}class al extends Cs{constructor(t,s){super(),N(this,"signal",void 0),N(this,"token",void 0),N(this,"tokenTimeout",void 0),N(this,"tokenInterval",void 0),N(this,"_sequence",0),N(this,"userMap",new Map),N(this,"encoder",new TextEncoder),this.signal=t,this.token=s;const n=()=>{this.signal.connectionState===jt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*C("P2P_TOKEN_INTERVAL"))};n()}async send(t,s,n,r,i){var o;if(this.userMap.size===0)return;const c=Array.from(Pa(o=this.userMap).call(o))[0].token;typeof s!="string"&&(s=JSON.stringify(s)),r=r??Jt(6,""),i=i??this._sequence++;const l={_id:r,_type:t,_seq:i,_message:s,token:"".concat(this.token,"_").concat(c)};C("SHOW_P2P_LOG")&&b.debug("send message",l,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(l)).forEach(h=>{this.signal.request(qe.DATA_STREAM,{payload:Fo(this.encoder.encode(h))})});const d=new Te((h,p)=>{const m=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),g),this.off("res-@".concat(r),w),this.off(xd.ABORT,T),b.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(r)),this.userMap.size===0?p(new se(A.INVALID_REMOTE_USER)):p(new se(A.TIMEOUT))},C("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),g=()=>{m&&window.clearTimeout(m),this.off(xd.ABORT,T),n&&h()},T=()=>{m&&window.clearTimeout(m),this.off("res-@".concat(r,"_ack"),g),this.off("res-@".concat(r),w),p(new se(A.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(r)))};this.once(xd.ABORT,T),this.once("res-@".concat(r,"_ack"),g);const w=(I,O)=>{S=!0,m&&window.clearTimeout(m),this.off("res-@".concat(r,"_ack"),g),this.off(xd.ABORT,T),I==="success"?h(O):p(new se(A.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(r)))};let S=!1;n||(this.once("res-@".concat(r),w),gn(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{S||b.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(r,", ").concat(l))}))});try{return await d}catch(h){if(h.code===A.TIMEOUT)return await this.send(t,s,n,r,i);throw h}}onMessage(t){var s;const{_uid:n}=t;let r,i=this.userMap.get(n);if(i)r=i.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Gs.CHECK)return;const{token:d}=t;r=new Map,i={uid:n,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,i),this.signal.emit(ut.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:d,total:h}=t,p=(o=r.get(d))!==null&&o!==void 0?o:[];if(p.push(t),r.has(d)||r.set(d,p),p.length!==h)return;{const m=bc(p).call(p,(g,T)=>g.index-T.index).map(g=>g.payload).join("");r.delete(d),(t=JSON.parse(m))._uid=n}}const{_type:c,token:l}=t;if(_e(s=[Gs.ACK,Gs.CHECK]).call(s,c))return c===Gs.CHECK&&this.handleCheckToken(i,l),void this.receiveMessage(t);l==="".concat(i.token,"_").concat(this.token)?this.handleReceivedMessage(t):b.debug('Receive unexpected message", '.concat(l,", cur_token: ").concat(i.token,"_").concat(this.token),t)}check(){const t={_id:Jt(6,""),token:this.token,_type:Gs.CHECK};C("SHOW_P2P_LOG")&&b.debug("send message",t),this.signal.request(qe.DATA_STREAM,{payload:Fo(this.encoder.encode(JSON.stringify(t)))})}ack(t){const s={_id:t,_type:Gs.ACK,token:this.token};C("SHOW_P2P_LOG")&&b.debug("send message",s),this.signal.request(qe.DATA_STREAM,{payload:Fo(this.encoder.encode(JSON.stringify(s)))})}response(t,s,n){this.send(Gs.RESPONSE,JSON.stringify({success:!n,message:s}),!0,t)}handleReceivedMessage(t){const s=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:h,nextExpectedSequenceNumber:p}=d;for(;h.has(p);){const m=h.get(p);h.delete(p),this.receiveMessage(m),d.nextExpectedSequenceNumber++}})};if(!t)return void s();const{_uid:n,_seq:r}=t,i=this.userMap.get(n),{receivedMessagesMap:o,isStart:c,nextExpectedSequenceNumber:l}=i;if(r<l)return this.ack(t._id),void b.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(t._message));o.set(r,t),c&&r===l&&(this.receiveMessage(t),o.delete(l),i.nextExpectedSequenceNumber++,s())}receiveMessage(t){const{_id:s,_type:n,_message:r,_uid:i}=t;if(C("SHOW_P2P_LOG")&&b.debug("receive message",t),s){let o;switch(t._type!==Gs.ACK&&(r&&(o=JSON.parse(r)),this.ack(t._id)),t._type){case Gs.CANDIDATE:case Gs.CONTROL:this.signal.emit(n,o,i);break;case Gs.PUBLISH:case Gs.UNPUBLISH:case Gs.RESTART_ICE:case Gs.CALL:o.uid=i,Qs(this.signal,n,o).then(c=>{this.response(t._id,c)}).catch(()=>{this.response(t._id,void 0,!0)});break;case Gs.ACK:this.getListeners("res-@".concat(s,"_ack")).length>0&&this.emit("res-@".concat(s,"_ack"));break;case Gs.RESPONSE:{const{success:c,message:l}=o;this.emit("res-@".concat(s),c?"success":"failed",l);break}}}}splitMessage(t){if(t.length<al.MAX_MESSAGE_SIZE)return[t];const s=[],{remoteToken:n}=JSON.parse(t),r=Jt(6,"");let i=0,o=800;const c=Math.ceil(t.length/o);for(;t.length>0;){i++;const l={id:r,index:i,total:c,payload:t.slice(0,o),token:"".concat(this.token,"_").concat(n)};JSON.stringify(l).length>al.MAX_MESSAGE_SIZE?o-=50:(s.push(l),t=t.slice(o))}return s.map(l=>JSON.stringify(l))}handleCheckToken(t,s){return t.token!==s?(b.debug("token changed, from ".concat(t.token," to ").concat(s)),this.reset(t.uid,s),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{b.debug("token timeout, ".concat(s)),this.reset(t.uid)},C("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await Qs(this.signal,Gs.CALL,void 0),s=await this.send(Gs.CALL,t);this.signal.emit(Ge.P2P_CONNECTION,s,!0)}async reset(t,s){const n=this.userMap.get(t);n&&(this.emit(xd.ABORT),this.signal.emit(ut.ON_USER_OFFLINE,{uid:n.uid,reason:G7.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),s||(b.debug("change local token from ".concat(s," to ").concat(s)),this.token=Jt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(xd.ABORT)}}N(al,"MAX_SIZE",1),N(al,"MAX_MESSAGE_SIZE",1024);class RY extends Cs{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===jt.CONNECTED?this.emit(Ge.WS_CONNECTED):t===jt.RECONNECTING?this.emit(Ge.WS_RECONNECTING,this._websocketReconnectReason):t===jt.CLOSED&&this.emit(Ge.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,s){super(),N(this,"__name__","P2PSignal"),N(this,"_disconnectedReason",void 0),N(this,"_websocketReconnectReason",void 0),N(this,"_connectionState",jt.CLOSED),N(this,"reconnectToken",void 0),N(this,"p2pToken",void 0),N(this,"websocket",void 0),N(this,"openConnectionTime",void 0),N(this,"clientId",void 0),N(this,"lastMsgTime",Date.now()),N(this,"uploadCache",[]),N(this,"uploadCacheInterval",void 0),N(this,"rttRolling",new Fb(5)),N(this,"pingpongTimer",void 0),N(this,"pingpongTimeoutCount",0),N(this,"joinResponse",void 0),N(this,"multiIpOption",void 0),N(this,"initError",void 0),N(this,"spec",void 0),N(this,"store",void 0),N(this,"_external_signal",void 0),N(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(Ge.ON_BINARY_DATA,n.data);const r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const i="res-@".concat(r._id);this.emit(i,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case ut.ON_DATA_STREAM:return void this.handleDataStream(r._message);case ut.MUTE_AUDIO:case ut.MUTE_VIDEO:case ut.ON_P2P_LOST:case ut.ON_USER_ONLINE:return;case ut.ON_USER_OFFLINE:const{uid:i}=r._message;return b.debug("[".concat(this.clientId,"] user-offline uid: ").concat(i)),void this._external_signal.reset(i)}if(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(kt.UID_BANNED);break;case 15:this.close(kt.IP_BANNED);break;case 16:this.close(kt.CHANNEL_BANNED)}if(r._type===ut.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Qe.ERR_LICENSE_MISSING:this.close(kt.LICENSE_MISSING);break;case Qe.ERR_LICENSE_EXPIRED:this.close(kt.LICENSE_EXPIRED);break;case Qe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(kt.LICENSE_MINUTES_EXCEEDED);break;case Qe.ERR_LICENSE_PERIOD_INVALID:this.close(kt.LICENSE_PERIOD_INVALID);break;case Qe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(kt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Qe.ERR_LICENSE_ILLEGAL:this.close(kt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=s,this.websocket=new j_("gateway-".concat(this.clientId),this.spec.retryConfig,!0,C("JOIN_GATEWAY_USE_DUAL_DOMAIN"),C("JOIN_GATEWAY_USE_443PORT_ONLY"),s),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===jt.CONNECTED&&this.reconnect("retry",Mn.OFFLINE)}),this.p2pToken=Jt(6,""),this._external_signal=new al(this,this.p2pToken)}async request(t,s,n,r){const i=Jt(6,""),o={_id:i,_type:t,_message:s},c=this.websocket.connectionID,l=()=>new Te((T,w)=>{if(this.connectionState===jt.CONNECTED)return T();const S=()=>{this.off(Ge.WS_CLOSED,I),T()},I=()=>{this.off(Ge.WS_CONNECTED,S),w(new se(A.WS_ABORT))};this.once(Ge.WS_CONNECTED,S),this.once(Ge.WS_CLOSED,I)});if(this.connectionState!==jt.CONNECTING&&this.connectionState!==jt.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await l(),this.websocket.sendMessage(o,!0),r)return;const d=new Te((T,w)=>{let S=!1;const I=(M,z)=>{S=!0,T({isSuccess:M==="success",message:z||{}}),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.emit(Ge.REQUEST_SUCCESS,t,s)};this.once("res-@".concat(i),I);const O=()=>{w(new se(A.WS_ABORT,"type: ".concat(t))),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.off("res-@".concat(i),I)};this.once(Ge.WS_CLOSED,O),this.once(Ge.WS_RECONNECTING,O),gn(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||S||(b.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Ge.REQUEST_TIMEOUT,t,s))})});let h=null;try{h=await d}catch(T){if(this.connectionState===jt.CLOSED||t===qe.LEAVE)throw new se(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():t===qe.JOIN||t===qe.REJOIN?null:(await l(),await this.request(t,s))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),m=zc(p),g=new se(A.UNEXPECTED_RESPONSE,"".concat(m.desc,": ").concat(h.message.error_str),{code:p,data:h.message,desc:m.desc});return m.action==="success"?h.message:(b.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(m.desc,", action: ").concat(m.action)),p===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=g,this.close()),g.throw()):m.action==="failed"?g.throw():m.action==="quit"?(this.initError=g,this.close(),g.throw()):(p===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Mn.MULTI_IP)):this.reconnect(m.action,Mn.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,s)))}waitMessage(t,s){return new Te(n=>{const r=i=>{(!s||s(i))&&(this.off(t,r),n(i))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void b.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const s={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,s)}upload(t,s){const n={_type:t,_message:s};try{this.websocket.sendMessage(n)}catch{const i=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>i&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==jt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,s){const n={_type:t,_message:s};this.websocket.sendMessage(n)}async sendExtensionMessage(t,s,n){return await this._external_signal.send(t,s,n)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Te((s,n)=>{this.once(Ge.WS_CONNECTED,()=>s(this.joinResponse)),this.once(Ge.WS_CLOSED,()=>n(this.initError||new se(A.WS_ABORT))),this.connectionState=jt.CONNECTING,this.websocket.init(t).catch(n)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||kt.LEAVE,this.connectionState=jt.CLOSED,b.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=Jt(6,""),this._external_signal.clear(),this._external_signal=new al(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Ge.ABORT_P2P_EXECUTION);const t=await Qs(this,Ge.REQUEST_JOIN_INFO),s=await this.request(qe.JOIN,t);if(!s)return this.emit(Ge.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=s,this.emit(Ge.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,s){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,s)}async downgradeCodec(t){return!1}handleDataStream(t){try{var s;const n=Dc(t.payload),r=new TextDecoder().decode(n),i=JSON.parse(r);"total"in i&&"id"in i||_e(s=Object.values(Gs)).call(s,i._type)?(i._uid=t.uid,this._external_signal.onMessage(i)):this.emit(ut.ON_DATA_STREAM,t)}catch{this.emit(ut.ON_DATA_STREAM,t)}}handleNotification(t){b.debug("[".concat(this.clientId,"] receive notification: "),t);const s=zc(t.code);if(s.action!=="success"){if(s.action!=="failed")return s.action==="quit"?t.code===Qe.ERR_REPEAT_JOIN_CHANNEL&&C("IGNORE_UID_CHECK")?void this.close(kt.UID_CONFLICT):(s.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(kt.UID_BANNED),void this.close()):void this.reconnect(s.action,Mn.SERVER_ERROR);b.error("[".concat(this.clientId,"] ignore error: "),s.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=C("PING_PONG_TIME_OUT"),s=Date.now();this.pingpongTimeoutCount>=t&&(b.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(s-this.lastMsgTime,"ms")),s-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Mn.TIMEOUT):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-s;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWebsocketEvents(){this.websocket.on(bt.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ge.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(bt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(bt.CLOSED,()=>{this.connectionState=jt.CLOSED}),this.websocket.on(bt.FAILED,()=>{this._disconnectedReason=kt.NETWORK_ERROR,this.connectionState=jt.CLOSED}),this.websocket.on(bt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===jt.CONNECTED?this.connectionState=jt.RECONNECTING:this.connectionState=jt.CONNECTING}),this.websocket.on(bt.WILL_RECONNECT,(t,s,n)=>{t!=="retry"?(b.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0):b.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(t)}),this.websocket.on(bt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(Ge.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof se&&t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return b.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Mn.SERVER_ERROR);b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Mn.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(bt.REQUEST_NEW_URLS,(t,s)=>{Qs(this,Ge.REQUEST_RECOVER,this.multiIpOption).then(t).catch(s)}),this.websocket.on(bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const CY={name:"P2PChannel",create:function(e){let{store:t,statsCollector:s}=e;return new TY(t,s)},createSubmodule:function(e){let{store:t,spec:s}=e;return new RY(s,t)}};function aP(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function rP(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?aP(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):aP(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}class IY{constructor(t){N(this,"sessionDesc",void 0),N(this,"localCapabilities",void 0),N(this,"rtpCapabilities",void 0),N(this,"candidates",void 0),N(this,"_originCandidates",void 0),N(this,"iceParameters",void 0),N(this,"dtlsParameters",void 0),N(this,"setup",void 0),N(this,"currentMidIndex",void 0),N(this,"cname",void 0),t=_s(t);const{iceParameters:s,dtlsParameters:n,candidates:r,rtpCapabilities:i,setup:o,localCapabilities:c,sdkCodec:l,cname:d}=t,h=ha(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=i,this.candidates=r,this._originCandidates=_s(r),this.iceParameters=s,this.dtlsParameters=n,this.setup=o,this.localCapabilities=c,this.cname=d;for(let p=0;p<h.mediaDescriptions.length;p++){const m=h.mediaDescriptions[p];if(m.attributes.iceUfrag=s.iceUfrag,m.attributes.icePwd=s.icePwd,m.attributes.fingerprints=n.fingerprints,m.attributes.candidates=r,m.attributes.setup=o,m.media.mediaType==="video"){m.media.fmts=i.videoCodecs.map(w=>w.payloadType.toString(10));const g=i.videoCodecs.filter(w=>{var S,I;return(S=w.rtpMap)===null||S===void 0?void 0:_e(I=S.encodingName.toLowerCase()).call(I,l)}),T=i.videoCodecs.filter(w=>!_e(g).call(g,w));m.attributes.payloads=[...g,...T],m.attributes.extmaps=i.videoExtensions}m.media.mediaType==="audio"&&(m.media.fmts=i.audioCodecs.map(g=>g.payloadType.toString(10)),m.attributes.payloads=i.audioCodecs,m.attributes.extmaps=i.audioExtensions),h.mediaDescriptions[p]=this.mungMediaDesc(m)}this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return ao(this.sessionDesc)}send(t,s,n){const{ssrcs:r,ssrcGroups:i}=$u(s,this.cname),o=this.sessionDesc.mediaDescriptions.find(d=>t===Le.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),c=r[0].attributes.label,l=r[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(r),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(i),{id:c,mslabel:l}}batchSend(t){return t.map(s=>{let{kind:n,ssrcMsg:r}=s;return this.send(n,r,void 0)})}stopSending(t){this.sessionDesc.mediaDescriptions.forEach(s=>{const n=[],r=[],i=[];s.attributes.ssrcs.forEach(o=>{_e(t).call(t,o.attributes.label||"")?i.push(o):n.push(o)}),s.attributes.ssrcGroups.forEach(o=>{var c;_e(c=i.map(l=>l.ssrcId)).call(c,o.ssrcIds[0])||r.push(o)}),s.attributes.ssrcs=n,s.attributes.ssrcGroups=r})}mute(t){const s=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!s)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));s.attributes.direction="inactive"}unmute(t){const s=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!s)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));s.attributes.direction="sendonly"}receive(t,s,n){t.forEach((r,i)=>{const o=r._mediaStreamTrack,c=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===o.kind),l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[c],r);this.sessionDesc.mediaDescriptions[c]=l})}stopReceiving(t){}updateCandidates(t){const s=this._originCandidates.filter(r=>r.transport==="udp"),n=[];if(s.forEach(r=>{n.push(rP(rP({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),s.length!==0){switch(t){case Sn.TCP_RELAY:this.candidates=n;break;case Sn.UDP_TCP_RELAY:case Sn.RELAY:this.candidates=[...s,...n];break;default:this.candidates=s}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(t){t=_s(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(s=>{s.attributes.iceUfrag=t.iceUfrag,s.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const s=[];for(let n=0;n<t;n++)s.push((this.currentMidIndex+n+1).toString(10));return s}mungRecvMediaDsec(t,s){const n=_s(t);return Kc(n,s),F_(n,s),n}updateRecvMedia(t,s){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===t);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],s);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,s,n){const r=this.sessionDesc.mediaDescriptions.find(o=>t===Le.VIDEO?o.attributes.mid==="video":o.attributes.mid==="audio");if(r){const o=r.attributes.ssrcs.find(c=>c.attributes.label===s);var i;o&&(o.attributes.label=n,(i=o.attributes.msid)===null||i===void 0||i.replace(s,n))}}mungMediaDesc(t){const s=_s(t);return V_(s),function(n){const r=n.attributes.extmaps.find(i=>tf(i.extensionName));r&&n.attributes.extmaps.splice(n.attributes.extmaps.indexOf(r),1),n.attributes.payloads.forEach(i=>{const o=i.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");o!==-1&&i.rtcpFeedbacks.splice(o,1)})}(s),s}getSSRC(t){for(const s of this.sessionDesc.mediaDescriptions)for(const n of s.attributes.ssrcs)if(n.attributes.label===t)return[n]}}var ds;function iP(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function Ff(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?iP(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):iP(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let AY=(ds=class Oh extends Jm{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var s;return _e(s=Object.keys(Pc)).call(s,t)}))]}constructor(t,s){super(t,s),N(this,"store",void 0),N(this,"peerConnection",void 0),N(this,"remoteSDP",void 0),N(this,"initialOffer",void 0),N(this,"statsFilter",void 0),N(this,"useRTX",!1),N(this,"localCapabilities",void 0),N(this,"localCandidateCount",0),N(this,"allCandidatesReceived",!1),N(this,"establishPromise",void 0),N(this,"mutex",void 0),this.store=s,this.mutex=new wn("P2PConnection-mutex",s.clientId),this.peerConnection=new RTCPeerConnection(Oh.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Sm(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,bs()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const s=ji(t.sdp),n=Ju(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:C("FILTER_VIDEO_FEC"),filterAudioFec:C("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=t,Ff(Ff({},s),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:t.sdp})}catch(t){throw new se(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async updateRemoteConnect(){}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new IY(Ff(Ff({},t),{},{rtpCapabilities:t.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(s.toString()))}}async updateRemoteRTPCapabilities(t,s){throw new se(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(t){}send(t,s){var n=this;return xa(function*(){const r=yield yt(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const i=t.map(m=>n.peerConnection.addTrack(m._mediaStreamTrack)),o=yield yt(n.peerConnection.createOffer()),c=ha(o.sdp),l=t.map(m=>{const g=m._mediaStreamTrack,T=c.mediaDescriptions.find(w=>w.attributes.mid===g.kind);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return function(w,S,I){const O=w.attributes.ssrcs.filter(z=>z.attributes.label===S),M=w.attributes.ssrcGroups;if(O.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(M&&O.length>1){const z=M.find(K=>K.ssrcIds.indexOf(O[0].ssrcId)!==-1);return z?[{ssrcId:z.ssrcIds[0],rtx:I?z.ssrcIds[1]:void 0}]:[{ssrcId:O[0].ssrcId}]}return[{ssrcId:O[0].ssrcId}]}(T,g.id,n.useRTX)});let d;try{d=yield l}catch(m){throw i.forEach(g=>{yn()&&g.replaceTrack(null),n.peerConnection.removeTrack(g)}),m}const h=n.mungSendOfferSDP(o.sdp,t);n.remoteSDP.receive(t,s,d);const p=n.remoteSDP.toString();return yield yt(n.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(n.applySendEncodings(i,t)),yield yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:p})),t.map((m,g)=>{const T=m._mediaStreamTrack.id;return{localSSRC:l[g],id:T}})}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(i.toString()))}finally{r()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const s=this.peerConnection.getSenders().filter(i=>{var o;return t.indexOf(((o=i.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");s.map(i=>{yn()&&i.replaceTrack(null),this.peerConnection.removeTrack(i)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(s.toString()))}}async receive(t,s,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:i,mslabel:o}=this.remoteSDP.send(t,s,r),c=new Te((h,p)=>{const m=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(i)))},1e4),g=T=>{const w=Ft();if((w.name==="Safari"&&Number(w.version)===11||Xn())&&T.track.id!==i&&T.streams[0].id===o){var S;const I=T.streams[0].getTracks()[0];return(S=this.remoteSDP)===null||S===void 0||S.updateTrackLabel(t,i,T.track.id),this.peerConnection.removeEventListener("track",g),clearTimeout(m),void h(I)}if(T.track.id===i)return this.peerConnection.removeEventListener("track",g),clearTimeout(m),void h(T.track)};this.peerConnection.addEventListener("track",g)}),l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await c,id:i}}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(s.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const s=this.peerConnection.getSenders().filter(n=>{var r;return t.indexOf(((r=n.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(s.length!==t.length)throw new Error("sender' length doesn't match mids' length.");s.map(n=>{if(yn()&&n.track)n.track.enabled=!1;else{const r=n.getParameters();r.encodings.forEach(i=>i.active=!1),n.setParameters(r)}})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(s.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const s=this.peerConnection.getSenders().filter(i=>{var o;return t.indexOf(((o=i.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(s.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");s.map(async i=>{if(yn()&&i.track)i.track.enabled=!0;else{const o=i.getParameters();o.encodings.forEach(c=>c.active=!0),await i.setParameters(o)}});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(s.toString()))}}restartICE(t){var s=this;return xa(function*(){const n=yield yt(s.mutex.lock("From P2PConnection.restartICE"));try{if(!s.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=At().supportPCSetConfiguration;if(t===Sn.RELAY&&!r)return;if(r){const d=s.peerConnection.getConfiguration(),h=t===Sn.RELAY?"relay":"all";d.iceTransportPolicy!==h&&(b.debug("[".concat(s.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(h,"]")),d.iceTransportPolicy=h,s.peerConnection.setConfiguration(d))}t!==Sn.RELAY&&s.remoteSDP.updateCandidates(t);const i=yield yt(s.peerConnection.createOffer({iceRestart:!0}));if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=ji(i.sdp),{remoteIceParameters:c}=yield o.iceParameters;s.remoteSDP.restartICE(c);const l=s.remoteSDP.toString();yield yt(s.peerConnection.setLocalDescription(i)),yield yt(s.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(r){b.warning("[".concat(s.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[s]);this.remoteSDP.updateRecvMedia(s._mediaStreamTrack.kind,s);const i=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new se(A.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,s){const n=this.peerConnection.getSenders().filter(r=>{var i;return((i=r.track)===null||i===void 0?void 0:i.id)===t});n.length===1&&await this.applySendEncodings(n,[s])}setStatsRemoteVideoIsReady(t,s){this.statsFilter.setVideoIsReady2(t,s)}async replaceTrack(t,s){const n=this.peerConnection.getSenders().find(r=>{var i;return((i=r.track)===null||i===void 0?void 0:i.id)===s});n&&await n.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,s){throw new se(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new se(A.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const s={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Cc(t.turnServer.servers)?s.iceServers=t.turnServer.servers:(s.iceServers&&s.iceServers.push(...Oh.turnServerConfigToIceServers(t.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...Oh.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(s.iceTransportPolicy="relay")}))),s}static turnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{n.security?n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),s}async updateRtpSenderEncodings(t,s){var n;if(s||(s=this.peerConnection.getSenders().find(d=>{var h;return((h=d.track)===null||h===void 0?void 0:h.id)===t._mediaStreamTrack.id})),!s)return b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!At().supportSetRtpSenderParameters)return b.warn("Browser not support set rtp-sender parameters");const r={},i={};if(t instanceof os)switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(C("DSCP_TYPE")&&Ci()){var o;const d=C("DSCP_TYPE");_e(o=["very-low","low","medium","high"]).call(o,d)&&(i.networkPriority=d)}const c=s.getParameters(),l=(n=c.encodings)===null||n===void 0?void 0:n[0];l&&Object.assign(l,i),Object.assign(c,r),b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await s.setParameters(c)}async applySendEncodings(t,s){try{if(!At().supportSetRtpSenderParameters||t.length!==s.length)return;for(let n=0;n<t.length;n++){const r=t[n],i=s[n];r&&i&&await this.updateRtpSenderEncodings(i,r)}}catch{b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,s){const n=ha(t);return s.forEach((r,i)=>{const o=r._mediaStreamTrack,c=n.mediaDescriptions.find(l=>l.attributes.mid===o.kind);c&&Kc(c,r)}),ao(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var s;(s=this.onFirstAudioReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var s;(s=this.onFirstVideoReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var s;(s=this.onFirstAudioDecoded)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,s,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,s,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,s)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,s)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,s)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const s=this.remoteSDP.batchSend(t).map((i,o)=>{let{id:c,mslabel:l}=i;const{kind:d}=t[o];return new Te((h,p)=>{const m=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(c)))},1e4),g=T=>{const w=Ft();if(w.name==="Safari"&&Number(w.version)===11&&T.track.id!==c&&T.streams[0].id===l){var S;const I=T.streams[0].getTracks()[0];return(S=this.remoteSDP)===null||S===void 0||S.updateTrackLabel(d,c,T.track.id),this.peerConnection.removeEventListener("track",g),clearTimeout(m),void h({track:I,id:c})}if(T.track.id===c)return this.peerConnection.removeEventListener("track",g),clearTimeout(m),void h({track:T.track,id:c})};this.peerConnection.addEventListener("track",g)})}),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await Te.all(s)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const s=this.remoteSDP.getSSRC(t);return s==null?void 0:s[0].ssrcId}setConfiguration(t){if(At().supportPCSetConfiguration){const s=Oh.resolvePCConfiguration(t);this.peerConnection.setConfiguration(s)}}},Re(ds.prototype,"connect",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"connect"),ds.prototype),Re(ds.prototype,"stopSending",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"stopSending"),ds.prototype),Re(ds.prototype,"receive",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"receive"),ds.prototype),Re(ds.prototype,"stopReceiving",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"stopReceiving"),ds.prototype),Re(ds.prototype,"muteRemote",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"muteRemote"),ds.prototype),Re(ds.prototype,"unmuteRemote",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"unmuteRemote"),ds.prototype),Re(ds.prototype,"muteLocal",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"muteLocal"),ds.prototype),Re(ds.prototype,"unmuteLocal",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"unmuteLocal"),ds.prototype),Re(ds.prototype,"close",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"close"),ds.prototype),Re(ds.prototype,"updateEncoderConfig",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"updateEncoderConfig"),ds.prototype),Re(ds.prototype,"updateSendParameters",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"updateSendParameters"),ds.prototype),Re(ds.prototype,"replaceTrack",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"replaceTrack"),ds.prototype),Re(ds.prototype,"getRemoteSSRC",[xr],Object.getOwnPropertyDescriptor(ds.prototype,"getRemoteSSRC"),ds.prototype),ds);function xr(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("Locking from P2PConnection.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}const OY={name:"PlanBConnection",create:function(e){let{store:t,spec:s}=e;return new AY(s,t)}},DY={interceptLocalAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!At().supportWebRTCEncodedTransform)return void b.warning("browser not support audio encoded transform");if(Mm.has(e)||!e.track)return;const s={track:e.track};if(so()){if(!e.createEncodedStreams)return void b.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void b.error("create audio-encoded-streams error",o&&o.message)}const i=new TransformStream({transform(o,c){s.controller||(s.controller=c),e.track&&e.track.id!==s.track.id&&(b.debug("audio track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n));const l=t.metadata&&t.metadata();l?function(d,h){const{chunk:p,controller:m}=h,g=Bo.METADATA;p.data=function(T,w,S){const I=S.byteLength,O=I+x_+ZO,M=f_+g_+O,z=new ArrayBuffer(T.byteLength+M),K=new DataView(z);K.setUint8(0,QO),K.setUint16(1,O),K.setUint8(3,w),K.setUint16(4,I);for(let Y=0;Y<I;Y++)K.setUint8(6+Y,S[Y]);const V=new Uint8Array(K.buffer);return V.set(new Uint8Array(T),M),V.buffer}(p.data,g,d),m.enqueue(p)}(l,{chunk:o,controller:c}):c.enqueue(o)}});r.readable.pipeThrough(i).pipeTo(r.writable)}else if(yn()){if(typeof RTCRtpScriptTransform>"u")return void b.warning("browser not support RTCRtpScriptTransform");const r=Lm(),i=new MessageChannel;await new Te(c=>r.onmessage=l=>{l.data==="registered"&&c(void 0)});const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:i.port2},[i.port2]);e.transform=o,await new Te(c=>r.onmessage=l=>{l.data==="started"&&c(void 0)}),i.port1.onmessage=c=>{var l;if(c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==s.track.id)b.debug("audio track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n);else if(c.data.getMetadata){const d=t.metadata&&t.metadata();d&&i.port1.postMessage({metadata:d})}},s.worker=r}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}const r=Mm.get(e);if(r){Mm.delete(e);try{var i,o;(i=r.controller)===null||i===void 0||i.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(c){b.warning(c&&c.message)}}}Mm.set(e,s),e.track.addEventListener("ended",n)},interceptRemoteAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!At().supportWebRTCEncodedTransform)return void b.warning("browser not support audio encoded transform");if(Wm.has(e))return;const s={track:e.track,onMetadata:t.onMetadata,onPts:t.onPts};if(so()&&!Xn()){if(!e.createEncodedStreams)return void b.warning("browser not support createEncodedStreams() API");Tb(Wt.CHROME,87,116)||(t.enableTopn=!1);let r=null;try{r=e.createEncodedStreams()}catch(o){return void b.error("create audio-encoded-streams error",o&&o.message)}const i=new TransformStream({transform(o,c){s.controller||(s.controller=c),e.track&&e.track.id!==s.track.id&&(b.debug("audio track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n)),t.enableTopn?function(l,d,h){var p;const m=b_(new DataView(d.data));if(!m)return h.enqueue(d);const g=l.track.id;l7.set(g,l.track);const T=(p=m.tlv.find(z=>z.tag===Bo.AUDIO_LEVEL))===null||p===void 0?void 0:p.value;let w=0;typeof T=="number"&&(w=127-T);const S=Math.round(Math.pow(10,w/60)-1),{selected:I,speaker:O}=function(z,K){let V=pd.get(z);if(V||(V=function(Y){const ce=new tD;return pd.set(Y,ce),ai||(ai=new o7(C("TOPN_SILENCE_THRESHOLD")||500),ai.on("ActiveSpeakerChanged",xe=>{xe!=null&&(Fm=xe)})),ai.addSpeakers([ce]),ce}(z)),pd.size<=sD)return{selected:!0,speaker:V};if(!ai)throw new Error("no active speaker detector");return ai.levelChanged(V.id,K),Bc=ai.loudest.map(Y=>Y.id),Fm&&!_e(Bc).call(Bc,Fm)&&Bc.length>=sD&&Bc.pop(),{selected:_e(Bc).call(Bc,V.id)||V.id===Fm,speaker:V}}(l,S),M=function(z,K,V){const Y=ri.get(z)||new c7(z,K);return Y.score=V,ri.set(z,Y),function(ce){if(Bm.set(ce,!0),!Gm)return void(Gm=Date.now());const xe=Date.now();xe-Gm>1e3&&(Bm.get(ce)?Bm.set(ce,!1):(nD(ce),Bm.delete(ce)),Gm=xe)}(z),Y}(g,l.track,O.energyScore);M.addSample(I),M.active&&(d.data=m.frame.buffer,h.enqueue(d))}(e,o,c):t.enableMetadata||t.enablePts?function(l,d,h,p){const m=new DataView(l.data),g=m.getUint8(0);let T;if(128&g&&g!==71){const I=function(O){if(O.byteLength<=0)return[];const M=[];let z=0;for(;z<O.byteLength;){const V=(128&O.getUint8(z))>>7,Y=127&O.getUint8(z);if(!(V&&z+4<=O.byteLength)){z++;break}{const ce=O.getUint32(z,!1),xe=(16776192&ce)>>10,ke=1023&ce;M.push({pt:Y,ts_offset:xe,length:ke,data:new Uint8Array}),z+=4}}let K=O.byteLength-z;for(const V of M){if(V.length>K)return console.warn("Broken red payload"),[];V.length>0&&(V.data=new Uint8Array(O.buffer,O.byteOffset+z,V.length),z+=V.length,K-=V.length)}if(K>0){const V={pt:M.length>0?M[M.length-1].pt:0,ts_offset:0,length:K,data:new Uint8Array(O.buffer,O.byteOffset+z,K)};M.push(V)}return M}(m);if(I.length>0){const O=function(M){let z=0;for(let Y=0;Y<M.length;Y++)z+=Y<M.length-1?4:1,z+=M[Y].length;const K=new Uint8Array(z);let V=0;for(let Y=0;Y<M.length;Y++)if(Y<M.length-1){const ce=(2147483648|(127&M[Y].pt)<<24|(262143&M[Y].ts_offset)<<10|1023&M[Y].length)>>>0;K[V++]=ce>>24&255,K[V++]=ce>>16&255,K[V++]=ce>>8&255,K[V++]=255&ce}else K[V++]=127&M[Y].pt;for(const Y of M)K.set(Y.data,V),V+=Y.length;return K}(I.map(M=>{const z=new Uint8Array(M.length);z.set(M.data);const K=b_(new DataView(z.buffer));return K!=null&&K.frame&&(M.data=K==null?void 0:K.frame),T=K,M}));l.data=O.buffer}}else T=b_(m),T&&(l.data=T.frame.buffer);if(d.enqueue(l),!T)return;const w=T.tlv.find(I=>I.tag===Bo.METADATA);w&&h&&w.value instanceof Uint8Array&&h(w.value);const S=T.tlv.find(I=>I.tag===Bo.AUDIO_64_BIT_PTS);S&&p&&S.value instanceof Uint8Array&&S.value.length==8&&p(new DataView(S.value.buffer).getBigUint64(0,!0))}(o,c,t.onMetadata,t.onPts):c.enqueue(o)}});r.readable.pipeThrough(i).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void b.warning("browser not support RTCRtpScriptTransform");const r=Lm(),i=new MessageChannel;await new Te(c=>r.onmessage=l=>{l.data==="registered"&&c(void 0)});const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:i.port2},[i.port2]);e.transform=o,await new Te(c=>r.onmessage=l=>{l.data==="started"&&c(void 0)}),i.port1.onmessage=c=>{var l;c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==s.track.id?(b.debug("audio track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n)):c.data.metadata&&s.onMetadata?s.onMetadata(c.data.metadata):c.data.pts&&s.onPts&&s.onPts(c.data.pts)},s.worker=r}function n(){e.track.removeEventListener("ended",n),function(r){const i=Wm.get(r);if(i){(function(l){const d=pd.get(l);d&&(pd.delete(l),ai&&(ai.removeSpeakers([d]),pd.size===0&&(ai.destroy(),ai=null)))})(r),nD(r.track.id),Wm.delete(r);try{var o,c;(o=i.controller)===null||o===void 0||o.terminate(),(c=i.worker)===null||c===void 0||c.terminate()}catch(l){b.warning(l&&l.message)}}}(e)}Wm.set(e,s),e.track.addEventListener("ended",n)},interceptLocalVideoFrame:async function(e,t){if(!At().supportWebRTCEncodedTransform)return void b.warning("browser not support video encoded transform");if(Hm.has(e)||!e.track)return;const s={track:e.track};if(so()){if(!e.createEncodedStreams)return void b.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(c){return void b.error("create video-encoded-streams error",c&&c.message)}const i=[];t.on("sei-to-send",c=>{i.push(c)});const o=new TransformStream({transform(c,l){s.controller||(s.controller=l),e.track&&e.track.id!==s.track.id&&(b.debug("video track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n));const d=iD(new Uint8Array(c.data)),h=i.shift();if(h){const p=function(m,g,T){switch(T){case y_:return function(w,S){const I=rD(S),O=I.length,M=Math.floor(O/255),z=O%255,K=new Uint8Array(6+M+1+O+w.byteLength);K[0]=0,K[1]=0,K[2]=0,K[3]=1,K[4]=6,K[5]=101;let V=0;for(;V<M;)K[6+V]=255,V++;return K[6+V]=z,V++,K.set(I,6+V),K.set(new Uint8Array(w),6+V+O),K.buffer}(m,g);case w_:return function(w,S){const I=rD(S),O=I.length,M=Math.floor(O/255),z=O%255,K=new Uint8Array(7+M+1+O+1+w.byteLength);K[0]=0,K[1]=0,K[2]=0,K[3]=1,K[4]=78,K[5]=1,K[6]=101;let V=0;for(;V<M;)K[7+V]=255,V++;return K[7+V]=z,V++,K.set(I,7+V),V+=O,K[7+V]=128,V++,K.set(new Uint8Array(w),7+V),K.buffer}(m,g);default:return null}}(c.data,h,d);p&&(c.data=p)}l.enqueue(c)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(!yn())return;{if(typeof RTCRtpScriptTransform>"u")return void b.warning("browser not support RTCRtpScriptTransform");const r=Lm(),i=new MessageChannel;await new Te(c=>r.onmessage=l=>{l.data==="registered"&&c(void 0)});const o=new RTCRtpScriptTransform(r,{name:"sei-tx",port:i.port2},[i.port2]);e.transform=o,await new Te(c=>r.onmessage=l=>{l.data==="started"&&c(void 0)}),t.on("sei-to-send",c=>{i.port1.postMessage({sei:c})}),i.port1.onmessage=c=>{var l;c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==s.track.id&&(b.debug("video track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n))},s.worker=r}}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}const r=Hm.get(e);if(r){Hm.delete(e);try{var i,o;(i=r.controller)===null||i===void 0||i.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(c){b.warning(c&&c.message)}}}Hm.set(e,s),e.track.addEventListener("ended",n)},interceptRemoteVideoFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!At().supportWebRTCEncodedTransform)return void b.warning("browser not support video encoded transform");if(!e.track)return;if(Ku.has(e)){const r=Ku.get(e);return void(r&&(r.onSei=t.onSei))}const s={track:e.track,onSei:t.onSei};if(so()){if(!e.createEncodedStreams)return void b.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void b.error("create video-encoded-streams error",o&&o.message)}const i=new TransformStream({transform(o,c){if(s.controller||(s.controller=c),!s.firstFrameInfo){var l;const h=o.getMetadata()||{};s.firstFrameInfo=ps({type:o.type,rtpTimestamp:o.timestamp,payloadType:h.payloadType||0,ssrc:h.synchronizationSource||0,length:o.data.byteLength},"mimeType"in h?{mimeType:h.mimeType}:{}),(l=t.onFirstFrame)===null||l===void 0||l.call(t,s.firstFrameInfo)}e.track&&e.track.id!==s.track.id&&(b.debug("video track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n));const d=function(h,p){switch(p){case y_:return function(m){const g=new DataView(m.data);let T=0;for(;T+4<m.data.byteLength;){if(g.getUint8(T+0)===0&&g.getUint8(T+1)===0&&g.getUint8(T+2)===0&&g.getUint8(T+3)===1&&g.getUint8(T+4)===6){let w=T+6,S=0,I=0;for(;(I=g.getUint8(w++))===255;)S+=255;S+=I;const O=aD(m.data,w,S);return new Uint8Array(O)}T++}return null}(h);case w_:return function(m){const g=new DataView(m.data);let T=0;for(;T+5<m.data.byteLength;){if(g.getUint8(T+0)===0&&g.getUint8(T+1)===0&&g.getUint8(T+2)===0&&g.getUint8(T+3)===1&&g.getUint8(T+4)===78&&g.getUint8(T+5)===1&&g.getUint8(T+6)===101){let w=T+7,S=0,I=0;for(;(I=g.getUint8(w++))===255;)S+=255;S+=I;const O=aD(m.data,w,S);return new Uint8Array(O)}T++}return null}(h);default:return null}}(o,iD(new Uint8Array(o.data)));d&&s.onSei&&s.onSei(d),c.enqueue(o)}});r.readable.pipeThrough(i).pipeTo(r.writable)}else if(yn()){if(typeof RTCRtpScriptTransform>"u")return void b.warning("browser not support RTCRtpScriptTransform");const r=Lm(),i=new MessageChannel;await new Te(c=>r.onmessage=l=>{l.data==="registered"&&c(void 0)});const o=new RTCRtpScriptTransform(r,{name:"sei-rx",port:i.port2},[i.port2]);e.transform=o,await new Te(c=>r.onmessage=l=>{l.data==="started"&&c(void 0)}),i.port1.onmessage=c=>{var l;if(c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==s.track.id)b.debug("video track changed: ".concat(s.track.id," => ").concat(e.track.id)),s.track.removeEventListener("ended",n),s.track=e.track,s.track.addEventListener("ended",n);else if(c.data.sei&&s.onSei)s.onSei(c.data.sei);else if(c.data.firstFrameInfo&&t.onFirstFrame){var d;(d=t.onFirstFrame)===null||d===void 0||d.call(t,c.data.firstFrameInfo)}},s.worker=r}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}(function(r){const i=Ku.get(r);if(i){Ku.delete(r);try{var o,c;(o=i.controller)===null||o===void 0||o.terminate(),(c=i.worker)===null||c===void 0||c.terminate()}catch(l){b.warning(l&&l.message)}}})(e)}Ku.set(e,s),e.track.addEventListener("ended",n)}},kY={name:"InterceptFrame",create:()=>DY};var Ut;function oP(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}function mi(e){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?arguments[t]:{};t%2?oP(Object(s),!0).forEach(function(n){N(e,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):oP(Object(s)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))})}return e}let jY=(Ut=class Fd extends Jm{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,s;return(t=(s=this.peerConnection.getReceivers()[0])===null||s===void 0||(s=s.transport)===null||s===void 0?void 0:s.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var s;return _e(s=Object.keys(Pc)).call(s,t)}))]}constructor(t,s,n){super(t,s),N(this,"id",Jt(5,"connection-")),N(this,"store",void 0),N(this,"peerConnection",void 0),N(this,"forceTurn",!1),N(this,"remoteSDP",void 0),N(this,"initialOffer",void 0),N(this,"transportEventReceiver",void 0),N(this,"statsFilter",void 0),N(this,"extension",{useXR:C("USE_XR")}),N(this,"localCapabilities",void 0),N(this,"remoteCodecs",void 0),N(this,"localCandidateCount",0),N(this,"allCandidatesReceived",!1),N(this,"isPreallocation",!1),N(this,"preMediaMap",new Map),N(this,"dataStreamChannelMap",new Map),N(this,"establishPromise",void 0),N(this,"recoveredDataChannelIds",[]),N(this,"currentDataChannelId",1),N(this,"supportAV1RtpSpec",!1),N(this,"mutex",void 0),N(this,"qualityLimitationReason",td.NONE),N(this,"isFirstConnected",!1),this.store=s,this.forceTurn=iv(t),this.mutex=new wn("NVConnectionExtension-mutex",s.clientId),this.peerConnection=n,this.isFirstConnected=!1,this.statsFilter=Sm(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,bs()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,s){if(this.remoteCodecs=s,!this.remoteSDP)return void b.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(s));if(this.remoteSDP.updateRemoteCodec(t,s,this.store.codec)){const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else b.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const s=await this.peerConnection.createOffer();if(!s.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=ji(s.sdp),r=await G_({filterRTX:!C("USE_PUB_RTX")&&!C("USE_SUB_RTX"),filterVideoFec:C("FILTER_VIDEO_FEC"),filterAudioFec:C("FILTER_AUDIO_FEC"),filterVideoCodec:C("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:C("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:C("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Qu(r),this.initialOffer=s,C("ENABLE_SVC")&&this.store.codec=="av1"){const o=await jD();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let i;return s.sdp&&nf(s.sdp)&&(i=_s(r),TD(i)),mi(mi({},n),{},{rtpCapabilities:i||r,offerSDP:s.sdp})}catch(s){throw new se(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,s.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&nf(this.initialOffer.sdp)&&RD(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new rk(mi(mi({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!C("ENABLE_PRE_SUB_WITH_PRE_PC")||!C("PRE_USE_LOCAL_CODECS"))&&Wu(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString(),n=W_(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(n||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s});const i=this.peerConnection.getTransceivers()[0];if(i!=null&&i.receiver&&this.tryBindTransportEvents(i.receiver),Wu(this.store))if(t.preallocation&&C("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=C("PRE_SUB_NUM"),{mids:c,preSSRCs:l}=this.remoteSDP.preloadRemoteMedia(o);await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(l)),this.presetMedia(c,l)}else{const{preSSRCs:o=[]}=t,c=o.map(d=>d.ssrcMsg[0].ssrcId);if(o.length===0)return;const{mids:l}=this.remoteSDP.batchSend(o.map(d=>Object.assign({},d)));await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(l,c)}}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(s.toString()))}}presetMedia(t,s){t.forEach((n,r)=>{this.peerConnection.getTransceivers().forEach(i=>{if(i.mid!=null&&n===i.mid&&i.receiver.track){const o=i.receiver.track;let c;o.kind==="video"&&C("ENABLE_PRE_RENDER")&&(c=new jm({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(Jt(5,""))},!0),c.updateVideoTrack(o),c.onFirstVideoFrameRender=()=>{var l;const d=this.preMediaMap.get(s[r]);d&&(d.firstVideoRender=Date.now()),(l=this.onFirstVideoRender)===null||l===void 0||l.call(this,s[r])},c.onVideoBufferReady=()=>{var l;(l=this.onFirstVideoBufferReady)===null||l===void 0||l.call(this,s[r])},c.play(this.store.sessionId||void 0)),this.preMediaMap.set(s[r],{mid:n,track:o,player:c,transceiver:i})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let s=!1;const{rtpCapabilities:n}=t;if([,s]=this.remoteSDP.updateRemoteRTPCapabilities(n),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);s=s||o}const{preSSRCs:r=[]}=t,i=r.map(o=>o.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(i)){const o=[],c=[];if(Array.from(this.preMediaMap.entries()).every(l=>{let[d,{mid:h,player:p,track:m}]=l;return o.push(h),c.push(d),this.preMediaMap.delete(d),p&&p.destroy(),!0}),o.length>0&&(this.remoteSDP.stopSending(o),await Ca(this.peerConnection,this.remoteSDP,this.extension),b.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),Ue.reportApiInvoke(this.store.sessionId,{name:Ns.PRELOAD_MEDIA_FAILED,options:[r,c],tag:is.TRACER}).onSuccess()),r.length>0){const{mids:l}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(i)),this.presetMedia(l,i)}}s?(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):b.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(s.toString()))}}send(t,s,n){var r=this;return xa(function*(){const i=yield yt(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const o=[],c=Xu();t.forEach(S=>{const I=r.peerConnection.addTransceiver(S._mediaStreamTrack,mi({direction:"sendonly"},S.trackMediaType==="video"&&r.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));o.push(I),S._updateRtpTransceiver(I)}),bs()&&C("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(o,t)));const l=yield yt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(t.length),h=r.mungSendOfferSDP(l.sdp,t,d),p=ha(h),m=d.map(S=>{const I=p.mediaDescriptions.find(O=>O.attributes.mid===S);if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return U_(I,C("USE_PUB_RTX"))});let g;try{g=yield m}catch(S){g=[],r.remoteSDP.receive(t,s,n,g);const I=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield yt(r.stopSending(d,!0)),S}r.remoteSDP.receive(t,s,n,g);const T=r.remoteSDP.toString(),w=r.logSDPExchange(h,"offer","local","send");return yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield yt(r.applySimulcastEncodings(o,t)),yield yt(r.applySendEncodings(o,t)),w==null||w(T),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),o.map((S,I)=>{const O=d[I];return{localSSRC:m[I],id:O,transceiver:S}})}catch(o){throw o instanceof se?o:new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(o.toString()))}finally{i()}})()}async createDataChannels(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);if(n&&n.readyState==="open")b.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const i=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof i!="number")throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:i,negotiated:!0,ordered:!1,maxRetransmits:C("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)}s.forEach(i=>{i._updateOriginDataChannel(n)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),b.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else b.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(n){throw n instanceof se?n:new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(n.toString()))}}async stopDataChannels(t){try{const s=this.dataStreamChannelMap.get(t);return s&&(s.id&&this.recoveredDataChannelIds.push(s.id),s.close()),void this.dataStreamChannelMap.delete(t)}catch(s){throw s instanceof se?s:new se(A.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(s.toString()))}}async stopSending(t,s){const n=s?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map(l=>{var d;Sd(this.id+l.mid,this),l.direction="inactive",(d=l.stop)===null||d===void 0||d.call(l)});const i=await this.peerConnection.createOffer(),o=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();o==null||o(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(r){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(t,s,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:i,needExchangeSDP:o}=this.remoteSDP.send(t,s,n,r);o&&(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(l=>l.mid===i);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:i,transceiver:c}}catch(i){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(i.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:s,needExchangeSDP:n}=this.remoteSDP.batchSend(t);return n&&(await Ca(this.peerConnection,this.remoteSDP,this.extension),b.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),s.map(r=>{const i=this.peerConnection.getTransceivers().find(o=>o.mid===r);if(!i)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:i.receiver.track,id:r,transceiver:i}})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");t.forEach(i=>{Array.from(this.preMediaMap.entries()).some(o=>{let[c,{mid:l,player:d}]=o;if(l===i)return this.preMediaMap.delete(c),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(s.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(s.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const s=this.remoteSDP.toString(),n=this.logSDPExchange(s,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(s.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(s.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const s=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");s.map(async(o,c)=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString();r==null||r(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(s){throw new se(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(s.toString()))}}restartICE(t){var s=this;return xa(function*(){const n=yield yt(s.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!s.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=At().supportPCSetConfiguration,i=C("FORCE_TURN_TCP")||s.forceTurn;if(t===Sn.RELAY&&!r)return;if(r&&!i){const p=t===Sn.RELAY?"relay":"all",m=s.peerConnection.getConfiguration();m.iceTransportPolicy!==p&&(b.debug("[".concat(s.store.clientId,"] restartICE change iceTransportPolicy from [").concat(m.iceTransportPolicy,"] to [").concat(p,"]")),m.iceTransportPolicy=p,s.peerConnection.setConfiguration(m))}s.remoteSDP.updateCandidates(t);const o=yield yt(s.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=ji(o.sdp),{remoteIceParameters:l}=yield c.iceParameters;s.remoteSDP.restartICE(l);const d=s.remoteSDP.toString(),h=s.logSDPExchange(o.sdp||"","offer","local","restartICE");s.store.descriptionStart(),yield yt(s.peerConnection.setLocalDescription(o)),h==null||h(d),yield yt(s.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){b.warning("[".concat(s.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(Sn.TCP_RELAY),await Ca(this.peerConnection,this.remoteSDP,this.extension)}catch(s){b.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),s)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(s=>{Sd(this.id+s.mid,this)}),this.preMediaMap.forEach(s=>{let{player:n}=s;n&&n.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return mi(mi({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[s],[t]);this.remoteSDP.updateRecvMedia(t,s);const i=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new se(A.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,s){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===t);n.length===1&&(this.isVP8Simulcast(s)?bs()||await this.applySimulcastEncodings(n,[s]):await this.applySendEncodings(n,[s]))}setStatsRemoteVideoIsReady(t,s){this.statsFilter.setVideoIsReady2(t,s)}async replaceTrack(t,s){const n=this.peerConnection.getTransceivers().find(r=>r.mid===s);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const s=t[0].transport.iceTransport,{local:n,remote:r}=s.getSelectedCandidatePair();return{local:mi(mi({},kr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:mi(mi({},kr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var s;const n="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",i=ki(t.url||"");b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(n,"), url: ").concat(i||"",", host_candidate:").concat(r)),(s=this.onICECandidateError)===null||s===void 0||s.call(this,n)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const s={iceServers:[]},n=t.cloudProxyServer||"disabled";return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&(Cc(t.turnServer.servers)?s.iceServers=t.turnServer.servers:C("NEW_TURN_MODE")&&s.iceServers&&n==="disabled"?(C("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&s.iceServers.push(...Fd.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):s.iceServers.push(...Fd.newTurnServerConfigToIceServers(t.turnServer.servers)),C("NEW_FORCE_TURN")&&(s.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(s.iceServers&&s.iceServers.push(...Fd.turnServerConfigToIceServers(t.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...Fd.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(s.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&At().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),s}static turnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{n.security?n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),s}static newTurnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{const r=C("NEW_TURN_MODE");r===1?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}):r===2?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}):r===3?s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":443?transport=tcp")}):r===4&&(s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}),s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}),s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":443?transport=tcp")}))}),s}tryBindTransportEvents(t){const s=t.transport;if(s){this.transportEventReceiver=t,s.onstatechange=()=>{var r;s!=null&&s.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,s.state))},s.onerror=r=>{var i;(i=this.onDTLSTransportError)===null||i===void 0||i.call(this,"error"in r?r.error:r)};const n=s.iceTransport;n&&(n.onstatechange=()=>{const r=s==null?void 0:s.iceTransport.state;var i;r&&((i=this.onICETransportStateChange)===null||i===void 0||i.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:i}=n.getSelectedCandidatePair()||{};if(r&&i){const o=r.address+":"+r.port,c=i.address+":"+i.port;b.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ki(o)),", remote ").concat(JSON.stringify(ki(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,s){var n,r;if(s||(s=this.peerConnection.getSenders().find(S=>S.track===t._mediaStreamTrack)),!s)return b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return b.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!At().supportSetRtpSenderParameters)return b.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},o={};switch(t._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;case"balanced":i.degradationPreference="balanced"}const c=SD(this.peerConnection,t._mediaStreamTrack),l=pA(t);if(uk(t)&&c&&s&&l&&this.getLocalVideoStats&&_e(n=["vp8","vp9"]).call(n,this.store.codec)){var d;const w=i.degradationPreference||(_e(d=t._hints).call(d,qt.CUSTOM_TRACK)?C("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");hk(this.id+c.mid,l,this,w,S=>{s&&this.updateAdaptation(s,S)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:w,frameRate:S,scaleResolutionDownBy:I}=t._encoderConfig;w&&(o.maxBitrate=1e3*w),(_e(h=t._hints).call(h,qt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(S&&(o.maxFramerate=ya(S)),I&&I>=1&&(o.scaleResolutionDownBy=I))}const{maxFramerate:p}=C("ENCODER_CONFIG_LIMIT");if(p&&typeof p=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,p):p),C("DSCP_TYPE")&&Ci()){var m;const w=C("DSCP_TYPE");_e(m=["very-low","low","medium","high"]).call(m,w)&&(o.networkPriority=w)}const g=s.getParameters(),T=(r=g.encodings)===null||r===void 0?void 0:r[0];bs()&&!T&&(i.encodings=[o]),T&&Object.assign(T,o),Object.assign(g,i),b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(g.encodings))),await s.setParameters(g),await MD(this.store.codec,s,C("SVC_MODE"))}async updateAdaptation(t,s){var n,r;if(!t)return b.debug("[updateAdaptation] no rtpSender found");if(!At().supportSetRtpSenderParameters)return b.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const i={},{bitrateMax:o,frameRate:c,scaleResolutionDownBy:l}=s;o&&(i.maxBitrate=1e3*o),c&&(i.maxFramerate=ya(c)),l&&l>=1&&_e(n=["vp8","vp9"]).call(n,this.store.codec)&&(i.scaleResolutionDownBy=l);const d=t.getParameters(),h=(r=d.encodings)===null||r===void 0?void 0:r[0];h&&Object.assign(h,i),Object.assign(d,{});try{await t.setParameters(d),b.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(p){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?b.debug("[updateAdaptation] peerConnection not connected}"):b.debug("[updateAdaptation] updateRtpSenderEncodings failed",p):b.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,s){try{if(!At().supportSetRtpSenderParameters||t.length!==s.length)return;for(let n=0;n<t.length;n++){const r=t[n],i=s[n];i instanceof os&&!this.isVP8Simulcast(i)&&await this.updateRtpSenderEncodings(i,r.sender)}}catch{b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,s,n){const r=ha(t);return s.forEach((i,o)=>{const c=n[o],l=r.mediaDescriptions.find(d=>d.attributes.mid===c);l&&(Kc(l,i),B_(l,i,this.store.codec))}),ao(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var s;(s=this.onFirstAudioReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var s;(s=this.onFirstVideoReceived)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var s;(s=this.onFirstAudioDecoded)===null||s===void 0||s.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,s,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,s,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,s)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,s)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,s)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var s;(s=this.onFirstVideoDecodedTimeout)===null||s===void 0||s.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,s){if(t.length===s.length)for(let l=0;l<t.length;l++){var n,r,i,o,c;const d=t[l],h=s[l];if(h instanceof os&&!_e(n=h._hints).call(n,qt.LOW_STREAM)&&(r=h._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=h._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=h._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const p={},m={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:m.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:m.high}];const g=d.sender.getParameters();await d.sender.setParameters(Object.assign(g,p))}}}async applySimulcastEncodings(t,s){if(!bs()&&t.length===s.length)for(let n=0;n<t.length;n++){const r=s[n];if(r instanceof os&&this.isVP8Simulcast(r)){const i=t[n],o={},c={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=i.sender.getParameters();await i.sender.setParameters(Object.assign(l,o))}}}isVP8Simulcast(t){var s,n,r,i,o;return!!(t instanceof os&&C("SIMULCAST")&&this.store.codec==="vp8"&&!_e(s=t._hints).call(s,qt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(i=t._scalabilityMode)!==null&&i!==void 0&&i.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,s,n,r){if(C("SDP_LOGGING"))return b.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(s," SDP during NVConnectionExtension.").concat(r,`
`),t),s==="offer"?i=>{this.logSDPExchange(i,"answer",n==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const s=this.remoteSDP.getSSRC(t);return s&&s.length!==0?s[0].ssrcId:void 0}setConfiguration(t){if(At().supportPCSetConfiguration){const s=Fd.resolvePCConfiguration(t);this.peerConnection.setConfiguration(s)}t.isPreallocation&&(this.isPreallocation=!0)}},Re(Ut.prototype,"updateRemoteRTPCapabilities",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"updateRemoteRTPCapabilities"),Ut.prototype),Re(Ut.prototype,"connect",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"connect"),Ut.prototype),Re(Ut.prototype,"updateRemoteConnect",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"updateRemoteConnect"),Ut.prototype),Re(Ut.prototype,"createDataChannels",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"createDataChannels"),Ut.prototype),Re(Ut.prototype,"receive",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"receive"),Ut.prototype),Re(Ut.prototype,"batchReceive",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"batchReceive"),Ut.prototype),Re(Ut.prototype,"stopReceiving",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"stopReceiving"),Ut.prototype),Re(Ut.prototype,"muteRemote",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"muteRemote"),Ut.prototype),Re(Ut.prototype,"unmuteRemote",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"unmuteRemote"),Ut.prototype),Re(Ut.prototype,"muteLocal",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"muteLocal"),Ut.prototype),Re(Ut.prototype,"unmuteLocal",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"unmuteLocal"),Ut.prototype),Re(Ut.prototype,"close",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"close"),Ut.prototype),Re(Ut.prototype,"updateEncoderConfig",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"updateEncoderConfig"),Ut.prototype),Re(Ut.prototype,"updateSendParameters",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"updateSendParameters"),Ut.prototype),Re(Ut.prototype,"replaceTrack",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"replaceTrack"),Ut.prototype),Re(Ut.prototype,"updateAdaptation",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"updateAdaptation"),Ut.prototype),Re(Ut.prototype,"getRemoteSSRC",[Na],Object.getOwnPropertyDescriptor(Ut.prototype,"getRemoteSSRC"),Ut.prototype),Ut);function Na(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("From NVConnectionExtension.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}var es;function cP(e){var t,s,n,r=2;for(typeof Symbol<"u"&&(s=om,n=Symbol.iterator);r--;){if(s&&(t=e[s])!=null)return t.call(e);if(n&&(t=e[n])!=null)return new Bf(t.call(e));s="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Bf(e){function t(s){if(Object(s)!==s)return Te.reject(new TypeError(s+" is not an object."));var n=s.done;return Te.resolve(s.value).then(function(r){return{value:r,done:n}})}return Bf=function(s){this.s=s,this.n=s.next},Bf.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(s){var n=this.s.return;return n===void 0?Te.resolve({value:s,done:!0}):t(n.apply(this.s,arguments))},throw:function(s){var n=this.s.return;return n===void 0?Te.reject(s):t(n.apply(this.s,arguments))}},new Bf(e)}let PY=(es=class sg extends Jm{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,s){super(t,s),N(this,"name","DataChannelConnection"),N(this,"store",void 0),N(this,"peerConnection",void 0),N(this,"cname",void 0),N(this,"mutex",new wn("DataChannelConnection-mutex")),N(this,"dataChannel",void 0),N(this,"_p2pConnection",void 0),N(this,"establishPromise",void 0),N(this,"_nvMedia",void 0),this.store=s,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(sg.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new jY(t,s,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(t){var s;return(s=this._p2pConnection)===null||s===void 0?void 0:s.getPreMedia(t)}isPreSub(){var t,s;return(t=(s=this._p2pConnection)===null||s===void 0?void 0:s.isPreSub())!==null&&t!==void 0&&t}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(t){return this._p2pConnection.updateRtpSenderEncodings(t)}async connect(t){return this.cname=t.cname,await this._p2pConnection.connect(t),await new Te((s,n)=>{const r=setTimeout(()=>{this.closeSignal(),n(new $(A.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(t.candidates))))},C("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void s()},this.dataChannel.onerror=i=>{this.closeSignal(),n(i)},this.dataChannel.addEventListener("close",()=>{n(new $(A.DATACHANNEL_CONNECTION_TIMEOUT))})}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,s){return this._p2pConnection.updateRemoteRTPCapabilities(t,s)}send(t,s,n){var r=this;return xa(function*(){const i=yield yt(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Xl(cP(r._p2pConnection.send(t,s,n)))}finally{i()}})()}async stopSending(t,s){return this._p2pConnection.stopSending(t,s)}async createDataChannels(t,s){return this._p2pConnection.createDataChannels(t,s)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,s,n,r){return this._nvMedia?(b.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,s,this.cname)):(b.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,s,n,r))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var s=this;return xa(function*(){return yield*Xl(cP(s._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var s;return(s=this._nvMedia)===null||s===void 0||s.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,s){return await this._p2pConnection.updateEncoderConfig(t,s)}async updateSendParameters(t,s){return await this._p2pConnection.updateSendParameters(t,s)}setStatsRemoteVideoIsReady(t,s){this._p2pConnection.setStatsRemoteVideoIsReady(t,s)}async replaceTrack(t,s){return await this._p2pConnection.replaceTrack(t,s)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,s,n,r){if(C("SDP_LOGGING"))return b.upload("exchanging ".concat(n," ").concat(s," SDP during DataChannelConnection.").concat(r,`
`),t),s==="offer"?i=>{this.logSDPExchange(i,"answer",n==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(t){const s={iceServers:[]};return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Cc(t.turnServer.servers)?s.iceServers=t.turnServer.servers:(s.iceServers&&s.iceServers.push(...sg.turnServerConfigToIceServers(t.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...sg.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(s.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&At().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),s}static turnServerConfigToIceServers(t){const s=[];return t.forEach(n=>{n.security?n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Ur(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),s}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var s;return(s=this.onICEConnectionStateChange)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var s;return(s=this.onConnectionStateChange)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var s;return(s=this.onDTLSTransportStateChange)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var s;return(s=this.onDTLSTransportError)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var s;return(s=this.onICETransportStateChange)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var s;return(s=this.onFirstAudioReceived)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var s;return(s=this.onFirstVideoReceived)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var s;return(s=this.onFirstAudioDecoded)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstVideoRender=t=>{var s;return(s=this.onFirstVideoRender)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstVideoBufferReady=t=>{var s;return(s=this.onFirstVideoBufferReady)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,s,n)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,t,s,n)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var s;return(s=this.onFirstVideoDecodedTimeout)===null||s===void 0?void 0:s.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,s)=>{var n;return(n=this.onSelectedLocalCandidateChanged)===null||n===void 0?void 0:n.call(this,t,s)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,s)=>{var n;return(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0?void 0:n.call(this,t,s)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},Re(es.prototype,"connect",[tr],Object.getOwnPropertyDescriptor(es.prototype,"connect"),es.prototype),Re(es.prototype,"updateRemoteRTPCapabilities",[tr],Object.getOwnPropertyDescriptor(es.prototype,"updateRemoteRTPCapabilities"),es.prototype),Re(es.prototype,"createDataChannels",[tr],Object.getOwnPropertyDescriptor(es.prototype,"createDataChannels"),es.prototype),Re(es.prototype,"receive",[tr],Object.getOwnPropertyDescriptor(es.prototype,"receive"),es.prototype),Re(es.prototype,"stopReceiving",[tr],Object.getOwnPropertyDescriptor(es.prototype,"stopReceiving"),es.prototype),Re(es.prototype,"muteRemote",[tr],Object.getOwnPropertyDescriptor(es.prototype,"muteRemote"),es.prototype),Re(es.prototype,"unmuteRemote",[tr],Object.getOwnPropertyDescriptor(es.prototype,"unmuteRemote"),es.prototype),Re(es.prototype,"muteLocal",[tr],Object.getOwnPropertyDescriptor(es.prototype,"muteLocal"),es.prototype),Re(es.prototype,"unmuteLocal",[tr],Object.getOwnPropertyDescriptor(es.prototype,"unmuteLocal"),es.prototype),Re(es.prototype,"close",[tr],Object.getOwnPropertyDescriptor(es.prototype,"close"),es.prototype),Re(es.prototype,"updateEncoderConfig",[tr],Object.getOwnPropertyDescriptor(es.prototype,"updateEncoderConfig"),es.prototype),Re(es.prototype,"updateSendParameters",[tr],Object.getOwnPropertyDescriptor(es.prototype,"updateSendParameters"),es.prototype),Re(es.prototype,"replaceTrack",[tr],Object.getOwnPropertyDescriptor(es.prototype,"replaceTrack"),es.prototype),Re(es.prototype,"getRemoteSSRC",[tr],Object.getOwnPropertyDescriptor(es.prototype,"getRemoteSSRC"),es.prototype),es);function tr(e,t,s){const n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const r=this.mutex,i=await r.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return await n.apply(this,c)}finally{i()}},s}function lP(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,n)}return s}class LY extends Cs{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var s;_e(s=["tryNext","recover"]).call(s,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(rn.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(rn.CONNECTED):this._state==="closed"?this.emit(rn.CLOSED):this._state==="failed"&&this.emit(rn.FAILED))}constructor(t,s,n,r){super(),N(this,"connectionID",0),N(this,"currentURLIndex",0),N(this,"reconnectReason",void 0),N(this,"_reconnectMode","tryNext"),N(this,"_initMutex",void 0),N(this,"_name",void 0),N(this,"_state","closed"),N(this,"_reconnectInterrupter",void 0),N(this,"_url",void 0),N(this,"_retryConfig",void 0),N(this,"_reconnectCount",0),N(this,"_forceCloseTimeout",5e3),N(this,"_onlineReconnectListener",void 0),N(this,"_closeEstablishingTransmitter",()=>{}),N(this,"_store",void 0),N(this,"_joinChannelServiceRecordIndex",void 0),N(this,"_transmitter",void 0),N(this,"_useCompress",void 0),N(this,"_inflateLength",0),N(this,"_deflateLength",0),this._store=r,this._name=t,this._retryConfig=function(i){for(var o=1;o<arguments.length;o++){var c=arguments[o]!=null?arguments[o]:{};o%2?lP(Object(c),!0).forEach(function(l){N(i,l,c[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(c)):lP(Object(c)).forEach(function(l){Object.defineProperty(i,l,Object.getOwnPropertyDescriptor(c,l))})}return i}({},s),this._useCompress=n}resetReconnectCount(t){b.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,s){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const n=this._transmitter;s?setTimeout(()=>n.close(),500):n.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,s){if(!this._transmitter)return void b.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;t!==void 0&&(this.reconnectMode=t),b.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((n=this._store)===null||n===void 0||n.recordJoinChannelService({status:"error",errors:[new Error(s)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:s})}getInflateData(){const t=this._inflateLength,s=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:s}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let fi=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class MY{constructor(t,s,n){N(this,"version",1),N(this,"initialRTO",void 0),N(this,"maxBatchAckCount",void 0),N(this,"maxRTO",void 0),N(this,"initialRTT",void 0),N(this,"ID",void 0),N(this,"rtt",void 0),N(this,"packetNumber",1),N(this,"rtoRatioMap",new Map),N(this,"timeoutMap",new Map),N(this,"unorderedPacketQueue",[]),N(this,"batchAckPacketQueue",[]),N(this,"lastOrderedPacketNumber",0),N(this,"batchAckTimer",void 0),N(this,"sendImpl",void 0),N(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=s,this.ID=Jt(7,"transmitter-"),this.initialRTO=(n==null?void 0:n.initialRTO)!==void 0?n.initialRTO:C("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:C("TRANSMITTER_INITIAL_RTT"),this.rtt=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:C("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(n==null?void 0:n.maxBatchAckCount)!==void 0?n.maxBatchAckCount:C("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(n==null?void 0:n.maxRTO)!==void 0?n.maxRTO:C("TRANSMITTER_MAX_RTO")}packetize(t,s){return{type:fi.Default,version:this.version,packetNumber:s,payload:t}}serialize(t){switch(t.type){case fi.Default:{let s;typeof t.payload=="string"?s=new TextEncoder().encode(t.payload):s=t.payload;const n=new ArrayBuffer(s.length+15),r=new DataView(n);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.packetNumber),cI(r,7,BigInt(t.sendTs)),new Uint8Array(r.buffer).set(s,15),n}case fi.Ack:{const s=new ArrayBuffer(16),n=new DataView(s);return n.setUint16(0,t.version),n.setUint8(2,t.type),n.setUint32(3,t.maxAckPacketNumber),n.setUint8(7,t.shift),cI(n,8,BigInt(t.ackSendTs)),s}}}deserialize(t){const s=new DataView(t),n=s.getUint16(0),r=s.getUint8(2);switch(r){case fi.Default:{const i=s.getUint32(3),o=oI(s,7),c=t.slice(15),l=new Uint8Array(c);return{version:n,type:r,packetNumber:i,sendTs:Number(o),payload:l}}case fi.Ack:{const i=s.getUint32(3),o=s.getUint8(7),c=oI(s,8);return{version:n,type:r,maxAckPacketNumber:i,shift:o,ackSendTs:Number(c)}}default:throw b.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(t){C("DC_DEBUG_LOG")&&typeof t=="string"&&b.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const s=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const n=this.calculateRTO(s),r=window.setTimeout(()=>{this.resendMessage(s)},n);this.timeoutMap.set(s.packetNumber,r),this.sendPacket(s)}onData(t){const s=this.deserialize(t);s.type===fi.Default?this.ack(s):s.type===fi.Ack&&(this.updateRTT(s,Math.round(performance.now())),this.clearRTO(s))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[s,n]=t;window.clearTimeout(n)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const s=this.calculateRTO(t),n=window.setTimeout(()=>{C("DC_DEBUG_LOG")&&typeof t.payload=="string"&&b.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(s)),this.resendMessage(t)},s);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}calculateRTO(t){const s=this.rtoRatioMap.get(t.packetNumber);if(s===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*s;return this.rtoRatioMap.set(t.packetNumber,s+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(t,s){const n=t.ackSendTs;this.rtt=this.rtt*(7/8)+(s-n-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const s=this.unorderedPacketQueue[0];if(!s){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(s.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const s={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:fi.Ack,version:this.version};C("DC_DEBUG_LOG")&&b.debug("[".concat(this.ID,"] sending ack packet"),s,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(s)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const s={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:fi.Ack,version:this.version};C("DC_DEBUG_LOG")&&b.debug("[".concat(this.ID,"] sending ack packet"),s,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(s)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:fi.Ack,version:this.version};C("DC_DEBUG_LOG")&&b.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===fi.Default&&(t.sendTs=Math.round(performance.now()));const s=this.serialize(t);this.sendImpl(s)}clearRTO(t){for(let s=t.maxAckPacketNumber-t.shift;s<=t.maxAckPacketNumber;s++){const n=this.timeoutMap.get(s);n!==void 0&&window.clearTimeout(n),this.timeoutMap.delete(s),this.rtoRatioMap.delete(s)}}}class dP extends LY{constructor(t,s){super(t,s,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),N(this,"_initMutex",void 0),N(this,"_reconnectInterrupter",void 0),N(this,"_url",void 0),N(this,"_transmitter",void 0),N(this,"_addresses",void 0),N(this,"_reliableTransmission",void 0),N(this,"_textEncoder",void 0),N(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new wn("datachannel");const{timeout:n,timeoutFactor:r}=s,i=Math.max(300,Math.floor(3*n/5)),o=Math.max(1.2,Math.floor(8*r)/10);ua.ONLINE&&(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=o),Ps.on(Ic.NETWORK_STATE_CHANGE,(c,l)=>{c!==l&&(this.resetReconnectCount("network state change: ".concat(l," -> ").concat(c)),c===ua.ONLINE?(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=s;const n=(r,i)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(c=>c.fingerprint||C("FINGERPRINT"));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(r).catch(i),this.once(rn.CLOSED,()=>i(new $(A.WS_DISCONNECT))),this.once(rn.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new Te((i,o)=>{n(i,o)}).then(()=>{r()}).catch(()=>{r()}))}async sendMessage(t){let s=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new $(A.WS_ABORT,"datachannel is not ready");try{s||(t=JSON.stringify(t));const n=this._textEncoder.encode(t),r=X9(n,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(n){throw new $(A.WS_ERR,"send datachannel signal message error"+n.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const s=JSON.stringify(t);return{compressed:s,compressedLength:s.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new Te((s,n)=>{var r;const i=()=>{b.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),s()},o=async h=>{var p;if((p=this._closeEstablishingTransmitter)===null||p===void 0||p.call(this),b.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const m=Ua(this,rn.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,g=await this.reconnectWithAction(m);if(this.state==="closed")return void b.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!g)return n(new $(A.WS_DISCONNECT,"datachannel reconnect failed: ".concat(h.code))),void this.close(!0);s()}else n(new $(A.WS_DISCONNECT,"datachannel close: ".concat(h.code))),this.close()},c=async h=>{try{var p;(p=this._reliableTransmission)===null||p===void 0||p.onData(h.data)}catch(m){console.log(m)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),b.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const l=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Qs(this,rn.TO_CONNECT_DATACHANNEL).then(h=>{var p,m;if(!h)throw new Error("transmissonInfo not exist yet");const{transmitter:g,close:T}=h;this._transmitter=g,(p=this._store)===null||p===void 0||p.signalChannelOpen();const w=Date.now()-d;b.debug("[choose dc] dc open cost ".concat(w,"ms")),this._reliableTransmission=new MY(S=>{var I;this._transmitter&&this._transmitter.readyState==="open"&&((I=this._transmitter)===null||I===void 0||I.send(S))},S=>{if(typeof S=="string")this.emit(rn.ON_MESSAGE,S);else{const I=$9(S,{raw:!0}).buffer,O=this._textDecoder.decode(I);this.emit(rn.ON_MESSAGE,O)}}),this._closeEstablishingTransmitter=()=>{var S;(S=this._reliableTransmission)===null||S===void 0||S.close(),this._reliableTransmission=void 0,T()},i&&i(),g.onclose=o,g.onmessage=c,(m=this._store)===null||m===void 0||m.recordJoinChannelService({endTs:Date.now(),status:"success"},l),this._joinChannelServiceRecordIndex=l}).catch(h=>{var p;if((p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:h instanceof $&&h.code===A.WS_ABORT?"aborted":"error",errors:[h]},l),this.state!=="closed"){if(h instanceof $&&h.code===A.WS_ERR){const m=new $(A.WS_ERR,"init datachannel failed! Error: ".concat(h.toString()));return b.error("[".concat(this._name,"]").concat(m)),void n(m)}o&&o(h)}else n(new $(A.WS_DISCONNECT,"datachannel is closed: ".concat(h.toString())))})})}async reconnectWithAction(t){let s=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Ps.networkState!==ua.OFFLINE||(this._onlineReconnectListener=Ps.onlineWaiter&&Ps.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},s){const c=vm(this._reconnectCount,this._retryConfig);b.debug("[".concat(this._name,"] wait ").concat(c,"ms to reconnect datachannel, mode: ").concat(t)),await Te.race([gn(c),this._onlineReconnectListener||new Te(()=>{})])}if(this.state==="closed"||!n)return!1;this._reconnectCount+=1;const r=async(c,l)=>{this.emit(rn.RECONNECT_CREATE_CONNECTION,l),await this.createTransmitterConnection(c)};try{if(t==="retry"){const c=this._addresses[this.currentURLIndex];await r(c,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let l=this.currentURLIndex;l<this._addresses.length;l++){if(this._addresses[l].fingerprint||C("FINGERPRINT")){this.currentURLIndex=l;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return b.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);b.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const c=this._addresses[this.currentURLIndex];await r(c,t)}else t==="recover"&&(b.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(rn.FAILBACK));return!0}catch(c){var i,o;return b.error("[".concat(this._name,"] reconnect failed"),c.toString()),c!=null&&(i=c.data)!==null&&i!==void 0&&i.desc&&Array.isArray(c.data.desc)&&c.data.desc.length&&_e(o=c.data.desc).call(o,"dynamic key expired")?(this.emit(rn.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,s)}}}class UY extends Cs{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===jt.CONNECTED?this.emit(Ge.WS_CONNECTED):t===jt.RECONNECTING?this.emit(Ge.WS_RECONNECTING,this._websocketReconnectReason):t===jt.CLOSED&&this.emit(Ge.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(b.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach(t=>{let{type:s,message:n}=t;this.emit(s,n),s===ut.ON_NOTIFICATION&&this.handleNotification(n),s===ut.ON_USER_BANNED&&this.handleUserBanned(n)}),this.pendingNotifications=[])}handleUserBanned(t){switch(t.error_code){case 14:this.close(kt.UID_BANNED);break;case 15:this.close(kt.IP_BANNED);break;case 16:this.close(kt.CHANNEL_BANNED)}}constructor(t,s){super(),N(this,"__name__","DataChannelSignal"),N(this,"_disconnectedReason",void 0),N(this,"_websocketReconnectReason",void 0),N(this,"_connectionState",jt.CLOSED),N(this,"reconnectToken",void 0),N(this,"websocket",void 0),N(this,"openConnectionTime",void 0),N(this,"clientId",void 0),N(this,"lastMsgTime",Date.now()),N(this,"uploadCache",[]),N(this,"uploadCacheInterval",void 0),N(this,"rttRolling",new Fb(5)),N(this,"pingpongTimer",void 0),N(this,"inflateDataTimer",void 0),N(this,"pingpongTimeoutCount",0),N(this,"ortc",void 0),N(this,"joinResponse",void 0),N(this,"multiIpOption",void 0),N(this,"initError",void 0),N(this,"spec",void 0),N(this,"store",void 0),N(this,"isJoining",!1),N(this,"pendingNotifications",[]),N(this,"onWebsocketMessage",n=>{if(n instanceof ArrayBuffer)return void this.emit(Ge.ON_BINARY_DATA,n);const r=JSON.parse(n);if(C("DC_DEBUG_LOG")&&b.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const i="res-@".concat(r._id);this.emit(i,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===ut.ON_NOTIFICATION||r._type===ut.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),b.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED&&this.handleUserBanned(r._message)))}),this.clientId=t.clientId,this.spec=t,this.store=s,this.websocket=new dP("gateway-".concat(this.clientId),this.spec.retryConfig,!0,s),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===jt.CONNECTED&&this.reconnect("retry",Wo.OFFLINE)})}async request(t,s,n,r){const i=Jt(6,""),o={_id:i,_type:t,_message:s},c=this.websocket.connectionID,l=()=>new Te((T,w)=>{if(this.connectionState===jt.CONNECTED)return T();const S=()=>{this.off(Ge.WS_CLOSED,I),T()},I=()=>{this.off(Ge.WS_CONNECTED,S),w(new $(A.WS_ABORT))};this.once(Ge.WS_CONNECTED,S),this.once(Ge.WS_CLOSED,I),t!==qe.PUBLISH&&t!==qe.SUBSCRIBE&&t!==qe.UNSUBSCRIBE&&t!==qe.UNPUBLISH&&t!==qe.CONTROL&&t!==qe.RESTART_ICE||this.once(Ge.DISCONNECT_P2P,()=>{w(new $(A.DISCONNECT_P2P))}),t!==qe.PUBLISH&&t!==qe.RESTART_ICE||this.once(Ge.ABORT_P2P_EXECUTION,()=>{w(new $(A.DISCONNECT_P2P))})});if(this.connectionState!==jt.CONNECTING&&this.connectionState!==jt.RECONNECTING||t===qe.JOIN||t===qe.REJOIN||await l(),t===qe.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),C("DC_DEBUG_LOG")&&b.debug("[datachannel-signal] sendMessage",o),await this.websocket.sendMessage(o,!0,!1),r)return;const d=new Te((T,w)=>{let S=!1;const I=(M,z)=>{S=!0,T({isSuccess:M==="success",message:z||{}}),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.emit(Ge.REQUEST_SUCCESS,t,s)};this.once("res-@".concat(i),I);const O=()=>{w(new $(A.WS_ABORT,"type: ".concat(t))),this.off(Ge.WS_CLOSED,O),this.off(Ge.WS_RECONNECTING,O),this.off("res-@".concat(i),I)};this.once(Ge.WS_CLOSED,O),this.once(Ge.WS_RECONNECTING,O),gn(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||S||(b.warning("dc request timeout, type: ".concat(t)),this.emit(Ge.REQUEST_TIMEOUT,t,s))})});let h=null;try{h=await d}catch(T){if(this.connectionState===jt.CLOSED||t===qe.LEAVE)throw new $(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():t===qe.JOIN||t===qe.REJOIN?null:(await l(),await this.request(t,s))}if(h.isSuccess)return h.message;const p=Number(h.message.error_code||h.message.code),m=zc(p),g=new $(A.UNEXPECTED_RESPONSE,"".concat(m.desc,": ").concat(h.message.error_str),{code:p,data:h.message});return m.action==="success"?h.message:(b.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(p,", message: ").concat(m.desc,", action: ").concat(m.action)),p===Qe.ERR_TOO_MANY_BROADCASTERS?((t===qe.JOIN||t===qe.REJOIN)&&(this.initError=g,this.close()),g.throw()):m.action==="failed"?g.throw():m.action==="quit"?(this.initError=g,this.close(),g.throw()):(p===Qe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Wo.MULTI_IP)):this.reconnect(m.action,Wo.SERVER_ERROR),t===qe.JOIN||t===qe.REJOIN?null:await this.request(t,s)))}waitMessage(t,s){return new Te(n=>{const r=i=>{(!s||s(i))&&(this.off(t,r),n(i))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void b.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const s={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,s)}upload(t,s){const n={_type:t,_message:s};try{this.websocket.sendMessage(n)}catch{const i=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>i&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==jt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(t,s){const n={_type:t,_message:s};await this.websocket.sendMessage(n)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Te((s,n)=>{this.once(Ge.WS_CONNECTED,()=>s(this.joinResponse)),this.once(Ge.WS_CLOSED,()=>n(this.initError||new $(A.WS_ABORT))),this.connectionState=jt.CONNECTING,this.websocket.init(t).catch(n),this.websocket.once(rn.FAILBACK,()=>{n(new $(A.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{this.openConnectionTime===void 0&&(b.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new $(A.INIT_DATACHANNEL_TIMEOUT)))},C("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||kt.LEAVE,this.connectionState=jt.CLOSED,b.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===kt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new dP("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),C("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(Ge.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await Qs(this,Ge.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const s=await this.request(qe.JOIN,t);if(this.store.joinRep(),this.ortc=t==null?void 0:t.ortc,!s)return this.emit(Ge.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=s,this.emit(Ge.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=jt.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new $(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Ac(this,Ge.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const s=await this.request(qe.REJOIN,t);return!!s&&(this.connectionState=jt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),C("DC_PINGPONG_INTERVAL")),s.peers&&s.peers.forEach(n=>{this.emit(ut.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(ut.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(ut.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(ut.MUTE_AUDIO,{uid:n.uid}):this.emit(ut.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(ut.MUTE_VIDEO,{uid:n.uid}):this.emit(ut.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(ut.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(ut.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(ut.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(t,s){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,s)}async downgradeCodec(t){if(!this.ortc)return!1;const s={downgrade_codec:t,ortc:this.ortc};return!!await this.request(qe.DOWNGRADE_CODEC,s)}handleNotification(t){b.debug("[".concat(this.clientId,"] receive notification: "),t);const s=zc(t.code);if(s.action!=="success"){if(s.action!=="failed")return s.action==="quit"?(s.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(kt.UID_BANNED),void this.close()):void this.reconnect(s.action,Wo.SERVER_ERROR);b.error("[".concat(this.clientId,"] ignore error: "),s.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,C("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=C("PING_PONG_TIME_OUT"),s=Date.now();this.pingpongTimeoutCount>=t&&(b.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(s-this.lastMsgTime,"ms")),s-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",Wo.FALLBACK):this.request(qe.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-s;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(qe.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleInflateData(){const{inflateLength:t,deflateLength:s}=this.websocket.getInflateData();t!==0&&s!==0&&this.upload(Hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:s,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(rn.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ge.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(rn.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(rn.CLOSED,()=>{this.connectionState=jt.CLOSED}),this.websocket.on(rn.FAILED,()=>{this._disconnectedReason=kt.NETWORK_ERROR,this.connectionState=jt.CLOSED}),this.websocket.on(rn.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===jt.CONNECTED?this.connectionState=jt.RECONNECTING:this.connectionState=jt.CONNECTING}),this.websocket.on(rn.WILL_RECONNECT,(t,s)=>{if(Ac(this,Ge.IS_P2P_DISCONNECTED)&&t==="retry")return b.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Ge.NEED_RENEW_SESSION),this.emit(Ge.DISCONNECT_P2P),s("tryNext");t!=="retry"&&(b.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Ge.NEED_RENEW_SESSION),this.emit(Ge.DISCONNECT_P2P)),s(t)}),this.websocket.on(rn.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{b.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Wo.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(Ge.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof $&&t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Qe.ERR_NO_AUTHORIZED)return b.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Wo.SERVER_ERROR);b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Wo.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(rn.REQUEST_NEW_URLS,(t,s)=>{Qs(this,Ge.REQUEST_RECOVER,this.multiIpOption).then(t).catch(s)}),this.websocket.on(rn.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(rn.TO_CONNECT_DATACHANNEL,(t,s)=>{Qs(this,Ge.PRE_CONNECT_PC).then(t).catch(s)}),this.websocket.on(rn.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(Ge.DATACHANNEL_FAILBACK)})}}const VY={name:"DataChannelConnection",create:function(e){let{store:t,spec:s}=e;return new PY(s,t)}},FY={name:"DataChannelSignal",create:function(e){let{store:t,spec:s}=e;return new UY(s,t)}};Kb(),ss("PROCESS_ID","process-".concat(Jt(8,""),"-").concat(Jt(4,""),"-").concat(Jt(4,""),"-").concat(Jt(4,""),"-").concat(Jt(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void b.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),s=Date.now();b.debug("Loading global parameters from cache",t),Object.keys(t).forEach(n=>{if(Object.prototype.hasOwnProperty.call($t,n)){const{value:r,expires:i}=t[n];if(i&&i<=s)return;Ka[n]=r,$t[n]=r}})}catch(t){b.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(Ka.AREAS)&&Ka.AREAS.length>0&&Y_(Ka.AREAS,!0);const uP=(e,t,s)=>{b.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),ss(e,t,s)};Pi(sY,!1),Pi(rY,!1),Pi(PK,!1),Pi(gY,!1),Pi(Z9,!1),Pi(CY,!1),Pi(OY,!1),Pi(kY,!1),Pi(VY,!1),Pi(FY,!1);const Zs=function(e){const t=new Cs,s=e,n={getListeners:t.getListeners.bind(t),on:(r,i)=>(function(o,c){o===Di.SECURITY_POLICY_VIOLATION&&Vj(c,!0)}(r,i),t.on.bind(t)(r,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Uj(Uj({},s),n)}({__TRACK_LIST__:Lc,VERSION:lr,BUILD:Xb,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:uP,getParameter:C,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const s=await async function(n){let r;return At().supportUnifiedPlan?(n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}),r=(await n.createOffer()).sdp):r=(await n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(t);if(!s)return e;t.close(),t=null,e=function(n){const r={video:[],audio:[]};return n.match(/ VP8/i)&&r.video.push("VP8"),n.match(/ VP9/i)&&r.video.push("VP9"),n.match(/ AV1/i)&&r.video.push("AV1"),n.match(/ H264/i)&&r.video.push("H264"),n.match(/ H265/i)&&r.video.push("H265"),n.match(/ opus/i)&&r.audio.push("OPUS"),n.match(/ PCMU/i)&&r.audio.push("PCMU"),n.match(/ PCMA/i)&&r.audio.push("PCMA"),n.match(/ G722/i)&&r.audio.push("G722"),r}(s)}catch(t){throw new $(A.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const t=Ue.reportApiInvoke(null,{name:Ns.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:is.TRACER}),s=function(){let i=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],o=!1;try{const c=window.RTCPeerConnection,l=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;o=!(!c||!d),i&&!l&&(o=!1),o&&Pu()&&JC(75)&&new c().close()}catch(c){b.error("check system requirement failed: ",c),o=!1}return o}(e),n=MK();b.debug("checkSystemRequirements, api:",s,"browser",n);const r=s&&n;return t.onSuccess(r),C("IGNORE_RTC_DEVICE_CHECK")?s:r},getDevices:function(e){return $a.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return $a.getRecordingDevices(e)},getCameras:function(e){return $a.getCamerasDevices(e)},getElectronScreenSources:tA,getPlaybackDevices:function(e){return $a.getSpeakers(e)},createClient:Pj,createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=C("CAMERA_CAPTURE_CONFIG"),s=Jt(8,"track-cam-"),n=Ue.reportApiInvoke(null,{id:s,tag:is.TRACER,name:Ns.CREATE_CAM_VIDEO_TRACK,options:[ps({},e),t]});t&&(e.encoderConfig=t);const r=km(e);let i=null;b.info("start create camera video track with config",JSON.stringify(e),"trackId",s);try{i=(await Ja({video:r},s)).getVideoTracks()[0]||null}catch(c){throw n.onError(c),c}if(!i){const c=new se(A.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(c),c.throw(b)}if(e.optimizationMode&&m_(s,i,e,Pr(e.encoderConfig)),C("USE_STANDARD_BITRATE_DEFAULT")){const c=Pr(e.encoderConfig);e.encoderConfig=c,delete c.bitrateMax,delete c.bitrateMin}const o=new Pm(i,e,r,e.scalabiltyMode?Im(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,s);return n.onSuccess(o.getTrackId()),b.info("create camera video success, trackId:",s),o},createCustomVideoTrack:function(e){const t=Jt(8,"track-cus-"),s=Ue.reportApiInvoke(null,{id:t,tag:is.TRACER,name:Ns.CREATE_CUSTOM_VIDEO_TRACK,options:[e]});C("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin);const n=new os(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Im(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,t,[qt.CUSTOM_TRACK]);return s.onSuccess(n.getTrackId()),b.info("create custom video track success with config",e,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const s=typeof t=="object"?function(m){const g=uA(m);return HI()&&m.suppressLocalAudioPlayback&&(g.suppressLocalAudioPlayback=m.suppressLocalAudioPlayback),zI()&&m.restrictOwnAudio&&(g.restrictOwnAudio=!0),g}(t):void 0;s&&(t="auto");const n=Jt(8,"track-scr-v-"),r=Ue.reportApiInvoke(null,{id:n,tag:is.TRACER,name:Ns.CREATE_SCREEN_VIDEO_TRACK,options:[ps({},e),t]});e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const i=function(m){const g={};m.screenSourceType&&(g.mediaSource=m.screenSourceType),m.extensionId&&so()&&(g.extensionId=m.extensionId);const{displaySurface:T,selfBrowserSurface:w,surfaceSwitching:S,systemAudio:I,preferCurrentTab:O,windowAudio:M,monitorTypeSurfaces:z}=m;(si(107)||Uo(107)||Rc(93))&&(T&&(Ks(T,"displaySurface",["browser","window","monitor"]),g.displaySurface=T),w?(Ks(w,"selfBrowserSurface",["exclude","include"]),g.selfBrowserSurface=w):g.selfBrowserSurface="include",S&&(Ks(S,"surfaceSwitching",["exclude","include"]),g.surfaceSwitching=S)),(si(105)||Uo(105)||Rc(91))&&I&&(Ks(I,"systemAudio",["exclude","include"]),g.systemAudio=I),(si(94)||Uo(94)||Rc(80))&&O&&(g.preferCurrentTab=!0),(si(141)||Uo(141)||Rc(125))&&M&&(Ks(M,"windowAudio",["exclude","system"]),g.windowAudio=M),(si(119)||Uo(119)||Rc(105))&&z&&(Ks(z,"monitorTypeSurfaces",["exclude","include"]),g.monitorTypeSurfaces=z),m.electronScreenSourceId&&(g.sourceId=m.electronScreenSourceId);const K=m.encoderConfig?t_(m.encoderConfig):null;return g.mandatory={chromeMediaSource:"desktop",maxWidth:K?K.width:void 0,maxHeight:K?K.height:void 0},K&&(K.frameRate&&(typeof K.frameRate=="number"?(g.mandatory.maxFrameRate=K.frameRate,g.mandatory.minFrameRate=K.frameRate):(g.mandatory.maxFrameRate=K.frameRate.max||K.frameRate.ideal||K.frameRate.exact||void 0,g.mandatory.minFrameRate=K.frameRate.min||K.frameRate.ideal||K.frameRate.exact||void 0),g.frameRate=K.frameRate),K.width&&(g.width=K.width),K.height&&(g.height=K.height)),g}(e);let o=null,c=null;const l=At();if(!l.supportShareAudio&&t==="enable"){const m=new se(A.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(m),m.throw(b)}b.info("start create screen video track with config",e,"withAudio",t,"trackId",n);const d=l.supportShareAudio&&t!=="disable";try{const m=await Ja({screen:i,screenAudio:d?s||!0:void 0},n);o=m.getVideoTracks()[0]||null,c=m.getAudioTracks()[0]||null}catch(m){throw r.onError(m),m}if(!o){const m=new se(A.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(m),m.throw(b)}if(!c&&t==="enable"){o&&o.stop();const m=new se(A.SHARE_AUDIO_NOT_ALLOWED);return r.onError(m),m.throw(b)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(m_(n,o,e,e.encoderConfig&&t_(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const h=new os(o,e.encoderConfig?t_(e.encoderConfig):{},e.scalabiltyMode?Im(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n,[qt.SCREEN_TRACK]);if(!c)return r.onSuccess(h.getTrackId()),b.info("create screen video track success","video:",h.getTrackId()),h;const p=new Us(c,void 0,Jt(8,"track-scr-a-"),!1);return r.onSuccess([h.getTrackId(),p.getTrackId()]),b.info("create screen video track success","video:",h.getTrackId(),"audio:",p.getTrackId()),[h,p]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const s=C("CAMERA_CAPTURE_CONFIG"),n=Jt(8,"track-mic-"),r=Jt(8,"track-cam-"),i=Ue.reportApiInvoke(null,{id:"".concat(n,"-").concat(r),tag:is.TRACER,name:Ns.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,s]});s&&(t.encoderConfig=s);const o=km(t),c=hA(e);let l=null,d=null;b.info("start create camera video track(".concat(r,") and microphone audio track(").concat(n,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const m=await Ja({audio:c,video:o},"".concat(n,"-").concat(r));l=m.getAudioTracks()[0],d=m.getVideoTracks()[0]}catch(m){throw i.onError(m),m}if(!l||!d){const m=new se(A.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(m),m.throw(b)}if(t.optimizationMode&&m_(r,d,t,Pr(t.encoderConfig)),C("USE_STANDARD_BITRATE_DEFAULT")){const m=Pr(t.encoderConfig);t.encoderConfig=m,delete m.bitrateMax,delete m.bitrateMin}const h=new zu(l,e,c,n),p=new Pm(d,t,o,t.scalabiltyMode?Im(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return i.onSuccess([h.getTrackId(),p.getTrackId()]),b.info("create camera video track(".concat(r,") and microphone audio track(").concat(n,") success")),[h,p]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=Jt(8,"track-mic-"),s=Ue.reportApiInvoke(null,{id:t,tag:is.TRACER,name:Ns.CREATE_MIC_AUDIO_TRACK,options:[e]}),n=hA(e);let r=null;b.info("start create microphone audio track with config",JSON.stringify(e),"trackId",t);try{r=(await Ja({audio:n},t)).getAudioTracks()[0]||null}catch(o){throw s.onError(o),o}if(!r){const o=new se(A.UNEXPECTED_ERROR,"can not find track in media stream");return s.onError(o),o.throw(b)}const i=new zu(r,e,n,t);return s.onSuccess(i.getTrackId()),b.info("create microphone audio track success, trackId:",t),i},createCustomAudioTrack:UO,createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:s,encoderConfig:n}=e;let{source:r}=e;const i={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":r,cacheOnlineFile:s,encoderConfig:n},o=Jt(8,"track-buf-"),c=Ue.reportApiInvoke(null,{id:o,tag:is.TRACER,name:Ns.CREATE_BUFFER_AUDIO_TRACK,options:[i]});if(C("DISABLE_WEBAUDIO"))throw new se(A.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");b.info("start create buffer source audio track with config",JSON.stringify(i),"trackId",o);const l=r;if(!(r instanceof AudioBuffer))try{r=await async function(p,m){let g=null;if(typeof p=="string"){const w=ZA.get(p);if(w)return b.debug("use cached audio resource: ",p),w;try{g=(await ni(()=>ba.get(p,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(S){throw new se(A.FETCH_AUDIO_FILE_FAILED,S.toString())}}else g=await new Te((S,I)=>{const O=new FileReader;O.onload=M=>{M.target?S(M.target.result):I(new se(A.READ_LOCAL_AUDIO_FILE_ERROR))},O.onerror=()=>{I(new se(A.READ_LOCAL_AUDIO_FILE_ERROR))},O.readAsArrayBuffer(p)});const T=await function(w){const S=ld();return new Te((I,O)=>{S.decodeAudioData(w,M=>{I(M)},M=>{O(new se(A.DECODE_AUDIO_FILE_FAILED,M.toString()))})})}(g);return typeof p=="string"&&m&&ZA.set(p,T),T}(r,s)}catch(p){return c.onError(p),p.throw(b)}const d=new s7(r),h=new t7(l,d,n?Am(n):{},o);return b.info("create buffer source audio track success, trackId:",o),c.onSuccess(h.getTrackId()),h},setAppType:function(e){if(b.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw b.debug("Invalid appType"),new $(A.INVALID_PARAMS,"invalid app type",e);ss("APP_TYPE",Math.floor(e))},setLogLevel:function(e){b.setLogLevel(e)},enableLogUpload:function(){C("USE_NEW_LOG")?ss("UPLOAD_LOG",!0):b.enableLogUpload()},disableLogUpload:function(){C("USE_NEW_LOG")?ss("UPLOAD_LOG",!1):b.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new sk},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const s=Ue.reportApiInvoke(null,{tag:is.TRACER,name:Ns.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Us||e instanceof hd)){const l=new $(A.INVALID_TRACK,"the parameter is not a audio track");return s.onError(l),l.throw()}t&&t<1e3&&(t=1e3);const n=e instanceof Us?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let i=r,o=r;const c=Date.now();return new Te(l=>{const d=setInterval(()=>{const h=e.getVolumeLevel();i=h>i?h:i,o=h<o?h:o;const p=i-o>1e-4,m=Date.now()-c;if(p||m>t){clearInterval(d);const g=p,T={duration:m,deviceLabel:n,maxVolumeLevel:i,result:g};b.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(T))),s.onSuccess(T),l(g)}},200)})},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const s=Ue.reportApiInvoke(null,{tag:is.TRACER,name:Ns.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof os||e instanceof ud)){const p=new $(A.INVALID_TRACK,"the parameter is not a video track");return s.onError(p),p.throw()}t&&t<1e3&&(t=1e3);const n=e instanceof os?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),i=document.createElement("video");i.style.width="1px",i.style.height="1px",i.setAttribute("muted",""),i.muted=!0,i.setAttribute("playsinline",""),i.controls=!1,(yn()||xm())&&(i.style.opacity="0.01",i.style.position="fixed",i.style.left="0",i.style.top="0",document.body.appendChild(i)),i.srcObject=new MediaStream([r]),i.play();const o=document.createElement("canvas");o.width=160,o.height=120;let c=0,l=0;try{const p=Date.now();c=await function(m,g,T,w){let S,I=0,O=null;return new Te((M,z)=>{function K(){I>w&&S&&(S(),M(I));const V=T.getContext("2d");if(!V){const xe=new $(A.UNEXPECTED_ERROR,"can not get canvas 2d context.");return b.error(xe.toString()),void z(xe)}V.drawImage(m,0,0,160,120);const Y=V.getImageData(0,0,T.width,T.height),ce=Math.floor(Y.data.length/3);if(O){for(let xe=0;xe<ce;xe+=3)if(Y.data[xe]!==O[xe])return I+=1,void(O=Y.data);O=Y.data}else O=Y.data}setTimeout(()=>{S&&(S(),M(I))},g),S=o_(()=>{K()},30)})}(i,t,o,4),l=Date.now()-p}catch(p){throw s.onError(p),p}EK===Wt.SAFARI&&(i.pause(),i.remove()),i.srcObject=null;const d=c>4,h={duration:l,changedPicNum:c,deviceLabel:n,result:d};return b.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(h))),s.onSuccess(h),d},setArea:Y_,audioElementPlayCenter:ea,resumeAudioContext:function(){return ea.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){VK.processExternalMediaAEC(e)},registerExtensions:function(e){const t=C("PLUGIN_INFO")||[];e.forEach(s=>{"name"in s&&!_e(t).call(t,s.name)&&t.push(s.name);const n=s;n.__registered__=!0,n.logger.hookLog=b.extLog,n.reporter.hookApiInvoke=Ue.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach(r=>{n.parameters[r]=C(r)})}),uP("PLUGIN_INFO",t)},ChannelMediaRelayError:fd,ChannelMediaRelayEvent:io,ChannelMediaRelayState:Ra,RemoteStreamFallbackType:Xz,RemoteStreamType:qz,ConnectionDisconnectedReason:kt,AudienceLatencyLevelType:wz,AREAS:Kt,preload:async function(e,t,s,n){return fv(e,t,s,n)},startLastmileProbeTest:async function(e,t,s,n){let r={state:"unavailable"};await fv(e,t,s,n);const i=await gv({appId:e,cname:t,token:s||e,uid:n,cloudProxyServer:"disabled"});if(!i)return r;await xv(i);let o,c=Pj({mode:"rtc",codec:"vp8"});try{o=await c.join(e,t,s,n,{networkQualityProbe:!0})}catch{return r}const l=new NK,d=l.createMuteAudioTrack();let h=await UO({mediaStreamTrack:d});await c.publish([h]);let[p,m,g]=await new Te((M,z)=>{const K=setTimeout(()=>{clearTimeout(K),M([!0,null,"audio"])},5e3);c.on("user-published",async(V,Y)=>{V.uid===o&&(clearTimeout(K),M([!1,V,Y]))})});if(p||!m)return await c.unpublish([h]),await c.leave(),h.close(),l.close(),r;await c.subscribe(m,g),await new Te((M,z)=>{const K=setTimeout(()=>{clearTimeout(K),M(null)},5e3)});let T=c.getRTCStats(),w=c.getLocalAudioStats();const S=T.RTT,I=w.sendJitterMs,O=w.currentPacketLossRate;return r={state:"complete",rtt:S,packetLossRate:O,jitter:I,networkQuality:((M,z,K)=>{let V=1;if(K>0){let lt=Math.log(100*K)/Math.log(2)+1;lt=Math.min(5,Math.max(0,lt)),V=1-lt/5}let Y=1;if(M>0){let lt=Math.log(M/40)/Math.log(2)+1;lt=Math.min(5,Math.max(0,lt)),Y=1-lt/5}let ce=1;if(z>0){let lt=Math.log(z/10)/Math.log(2.5)+1;lt=Math.min(5,Math.max(0,lt)),ce=1-lt/5}const xe=.5*V+.3*Y+.2*ce;let ke=0;return ke=xe>=.8?1:xe>=.6?2:xe>=.4?3:xe>=.2?4:5,ke})(S,I,O)},await c.unsubscribe(m),await c.unpublish([h]),await c.leave(),h.close(),l.close(),await xv(i),r}});return Object.defineProperties(Zs,{onAudioAutoplayFailed:{get:()=>va.onAudioAutoplayFailed,set:e=>{va.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>va.onAutoplayFailed,set:e=>{va.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Zs._onSecurityPolicyViolation,set(e){Zs._onSecurityPolicyViolation=e,Vj(e)}},__CLIENT_LIST__:{get:()=>C("SHOW_GLOBAL_CLIENT_LIST")?Gc:[]}}),$a.on(Uc.CAMERA_DEVICE_CHANGED,e=>{b.info("camera device changed",JSON.stringify(e)),Zs.onCameraChanged&&Zs.onCameraChanged(e),Zs.safeEmit(Di.CAMERA_CHANGED,e)}),$a.on(Uc.RECORDING_DEVICE_CHANGED,e=>{b.info("microphone device changed",JSON.stringify(e)),Zs.onMicrophoneChanged&&Zs.onMicrophoneChanged(e),Zs.safeEmit(Di.MICROPHONE_CHANGED,e)}),$a.on(Uc.PLAYOUT_DEVICE_CHANGED,e=>{b.debug("playout device changed",JSON.stringify(e)),Zs.onPlaybackDeviceChanged&&Zs.onPlaybackDeviceChanged(e),Zs.safeEmit(Di.PLAYBACK_DEVICE_CHANGED,e)}),ea.onAutoplayFailed=()=>{b.info("detect audio element autoplay failed"),va.onAudioAutoplayFailed&&va.onAudioAutoplayFailed()},ns.on("autoplay-failed",()=>{b.info("detect webaudio autoplay failed"),va.onAudioAutoplayFailed&&va.onAudioAutoplayFailed(),Zs.safeEmit(Di.AUTOPLAY_FAILED)}),ns.on(On.STATE_CHANGE,(e,t)=>{b.info("audio context state changed: ".concat(t," => ").concat(e)),Zs.onAudioContextStateChanged&&Zs.onAudioContextStateChanged(e,t),Zs.safeEmit(Di.AUDIO_CONTEXT_STATE_CHANGED,e,t)}),Ps.on(Ic.NETWORK_STATE_CHANGE,(e,t)=>{b.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))}),window&&(window.__ARTC__=Zs),Zs})})(DL);var VZ=DL.exports;const Gd=WY(VZ);function FZ(){var He,ot,_t,Ke,ht,st,ct,fs,ys,As,zs;const{appointmentId:u}=Lh(),f=Ga(),[x,_]=j.useState(null),[E,y]=j.useState(!0),[R,P]=j.useState(!1),[U,G]=j.useState("video"),[F,k]=j.useState([]),[X,q]=j.useState(""),[D,H]=j.useState({video:!0,audio:!0,speaker:!0}),[B,ne]=j.useState(null),[ae,Z]=j.useState(null),[te,ie]=j.useState(null),[ue,Ne]=j.useState([]),[be,Q]=j.useState(!1),pe=j.useRef(null),he=j.useRef(null);j.useEffect(()=>(le(),Ae(),()=>{fe()}),[u]);const Ae=()=>{const je=Gd.createClient({mode:"rtc",codec:"vp8"});je.on("user-published",async(Ze,Ct)=>{await je.subscribe(Ze,Ct),Ct==="video"&&(Ne(zt=>[...zt.filter(ts=>ts.uid!==Ze.uid),Ze]),he.current&&Ze.videoTrack.play(he.current)),Ct==="audio"&&Ze.audioTrack.play()}),je.on("user-unpublished",Ze=>{Ne(Ct=>Ct.filter(zt=>zt.uid!==Ze.uid))}),je.on("user-left",Ze=>{Ne(Ct=>Ct.filter(zt=>zt.uid!==Ze.uid))}),ne(je)},fe=async()=>{ae&&(ae.stop(),ae.close()),te&&(te.stop(),te.close()),B&&be&&await B.leave()},le=async()=>{try{const{data:je}=await sr.getAppointmentDetails(u);_(je)}catch{Ve.error("Failed to load appointment details"),f("/doctors")}finally{y(!1)}},we=async()=>{if(!B||!(x!=null&&x.videoRoom)){Ve.error("Video call not available");return}try{const{config:je}=x.videoRoom;if(je.type==="agora"&&je.appId&&je.token){await B.join(je.appId,je.channelName,je.token,je.uid);const Ze=await Gd.createCameraVideoTrack(),Ct=await Gd.createMicrophoneAudioTrack();Z(Ze),ie(Ct),pe.current&&Ze.play(pe.current),await B.publish([Ze,Ct]),Q(!0),Ve.success("Joined video call successfully")}else Ve.error("Video call configuration not available")}catch(je){console.error("Error joining video call:",je),Ve.error("Failed to join video call")}},re=async()=>{try{await fe(),Q(!1),Ne([]),Ve.success("Left video call")}catch(je){console.error("Error leaving video call:",je)}},oe=async()=>{try{await sr.startConsultation(u),P(!0),(x==null?void 0:x.type)==="video"&&await we(),Ve.success("Consultation started")}catch{Ve.error("Failed to start consultation")}},J=async()=>{try{be&&await re(),await sr.endConsultation(u),P(!1),Ve.success("Consultation ended"),f("/consultation-summary/"+u)}catch{Ve.error("Failed to end consultation")}},Oe=()=>{if(!X.trim())return;const je={id:Date.now(),text:X,sender:"patient",timestamp:new Date};k([...F,je]),q("")},$e=async je=>{if(je==="video"&&ae){const Ze=!D.video;await ae.setEnabled(Ze),H(Ct=>({...Ct,video:Ze}))}else if(je==="audio"&&te){const Ze=!D.audio;await te.setEnabled(Ze),H(Ct=>({...Ct,audio:Ze}))}else je==="speaker"&&H(Ze=>({...Ze,speaker:!Ze.speaker}))};return E?a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"})}):x?a.jsxs("div",{className:"min-h-screen bg-[#0a0f1a]",children:[a.jsx("div",{className:"bg-[#111827] border-b border-slate-700 px-4 py-4",children:a.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("button",{onClick:()=>f("/doctors"),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-400"})}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-lg font-bold text-white",children:((_t=(ot=(He=x.doctor)==null?void 0:He.name)==null?void 0:ot[0])==null?void 0:_t.toUpperCase())||"D"}),a.jsxs("div",{children:[a.jsxs("h1",{className:"text-lg font-bold text-white",children:["Dr. ",(Ke=x.doctor)==null?void 0:Ke.name]}),a.jsx("p",{className:"text-sm text-slate-400",children:(ht=x.doctor)==null?void 0:ht.specialization})]})]})]}),a.jsx("div",{className:"flex items-center gap-2",children:a.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${x.status==="confirmed"?"bg-green-500/20 text-green-400":x.status==="pending"?"bg-yellow-500/20 text-yellow-400":"bg-slate-500/20 text-slate-400"}`,children:x.status})})]})}),R?a.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[a.jsxs("div",{className:"flex-1 bg-slate-900 relative",children:[U==="video"&&a.jsxs("div",{className:"h-full relative",children:[a.jsx("div",{className:"w-full h-full bg-slate-800 flex items-center justify-center",children:ue.length>0?a.jsx("div",{ref:he,className:"w-full h-full",style:{background:"#1e293b"}}):a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-32 h-32 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-4xl font-bold text-white mx-auto mb-4",children:((As=(ys=(fs=x.doctor)==null?void 0:fs.name)==null?void 0:ys[0])==null?void 0:As.toUpperCase())||"D"}),a.jsxs("p",{className:"text-white text-lg",children:["Dr. ",(zs=x.doctor)==null?void 0:zs.name]}),a.jsx("p",{className:"text-slate-400",children:be?"Waiting for doctor to join...":"Video consultation ready"})]})}),be&&a.jsxs("div",{className:"absolute top-4 right-4 w-48 h-36 bg-slate-800 rounded-lg overflow-hidden border-2 border-slate-600",children:[a.jsx("div",{ref:pe,className:"w-full h-full",style:{background:"#1e293b"}}),a.jsx("div",{className:"absolute bottom-2 left-2 text-white text-xs bg-black/50 px-2 py-1 rounded",children:"You"})]}),a.jsx("div",{className:"absolute top-4 left-4",children:a.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${be?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:[a.jsx("div",{className:`w-2 h-2 rounded-full ${be?"bg-green-400":"bg-yellow-400"} animate-pulse`}),be?"Connected":"Connecting..."]})}),be&&a.jsx("div",{className:"absolute top-4 left-1/2 transform -translate-x-1/2",children:a.jsxs("div",{className:"flex items-center gap-2 bg-slate-800/90 backdrop-blur-sm rounded-full px-3 py-1 text-white text-sm",children:[a.jsx(Wd,{className:"w-4 h-4"}),ue.length+1," participants"]})})]}),a.jsx("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2",children:a.jsxs("div",{className:"flex items-center gap-4 bg-slate-800/90 backdrop-blur-sm rounded-full px-6 py-3",children:[a.jsx("button",{onClick:()=>$e("audio"),className:`p-3 rounded-full transition-colors ${D.audio?"bg-slate-700 text-white hover:bg-slate-600":"bg-red-500 text-white hover:bg-red-600"}`,title:D.audio?"Mute microphone":"Unmute microphone",children:D.audio?a.jsx(w2,{className:"w-5 h-5"}):a.jsx(S2,{className:"w-5 h-5"})}),a.jsx("button",{onClick:()=>$e("video"),className:`p-3 rounded-full transition-colors ${D.video?"bg-slate-700 text-white hover:bg-slate-600":"bg-red-500 text-white hover:bg-red-600"}`,title:D.video?"Turn off camera":"Turn on camera",children:D.video?a.jsx(FE,{className:"w-5 h-5"}):a.jsx(hE,{className:"w-5 h-5"})}),a.jsx("button",{onClick:()=>$e("speaker"),className:`p-3 rounded-full transition-colors ${D.speaker?"bg-slate-700 text-white hover:bg-slate-600":"bg-red-500 text-white hover:bg-red-600"}`,title:D.speaker?"Mute speaker":"Unmute speaker",children:D.speaker?a.jsx(oq,{className:"w-5 h-5"}):a.jsx(cq,{className:"w-5 h-5"})}),a.jsx("button",{className:"p-3 rounded-full bg-slate-700 text-white hover:bg-slate-600 transition-colors",title:"Share screen",children:a.jsx(lq,{className:"w-5 h-5"})}),a.jsx("button",{onClick:J,className:"p-3 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors",title:"End consultation",children:a.jsx(ra,{className:"w-5 h-5"})})]})})]}),a.jsxs("div",{className:"w-80 bg-[#111827] border-l border-slate-700 flex flex-col",children:[a.jsx("div",{className:"p-4 border-b border-slate-700",children:a.jsx("h3",{className:"text-white font-medium",children:"Chat"})}),a.jsx("div",{className:"flex-1 p-4 overflow-y-auto space-y-3",children:F.map(je=>a.jsx("div",{className:`flex ${je.sender==="patient"?"justify-end":"justify-start"}`,children:a.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg text-sm ${je.sender==="patient"?"bg-cyan-500 text-white":"bg-slate-700 text-white"}`,children:je.text})},je.id))}),a.jsx("div",{className:"p-4 border-t border-slate-700",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{type:"text",value:X,onChange:je=>q(je.target.value),onKeyPress:je=>je.key==="Enter"&&Oe(),placeholder:"Type a message...",className:"flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500"}),a.jsx("button",{onClick:Oe,className:"bg-cyan-500 hover:bg-cyan-600 text-white p-2 rounded-lg transition-colors",children:a.jsx(Uh,{className:"w-4 h-4"})})]})})]})]}):a.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h2",{className:"text-lg font-bold text-white mb-6",children:"Appointment Details"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(Pn,{className:"w-5 h-5 text-cyan-400"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Date & Time"}),a.jsxs("p",{className:"text-slate-400 text-sm",children:[new Date(x.date).toLocaleDateString()," at ",x.timeSlot]})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(dc,{className:"w-5 h-5 text-cyan-400"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Consultation Type"}),a.jsx("p",{className:"text-slate-400 text-sm capitalize",children:x.type})]})]}),x.symptoms&&a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(un,{className:"w-5 h-5 text-cyan-400 mt-0.5"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Symptoms"}),a.jsx("p",{className:"text-slate-400 text-sm",children:x.symptoms})]})]})]})]}),a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h2",{className:"text-lg font-bold text-white mb-6",children:"Doctor Information"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(UE,{className:"w-5 h-5 text-cyan-400"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Experience"}),a.jsxs("p",{className:"text-slate-400 text-sm",children:[((st=x.doctor)==null?void 0:st.experience)||"5+"," years"]})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(dE,{className:"w-5 h-5 text-cyan-400"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Location"}),a.jsx("p",{className:"text-slate-400 text-sm",children:((ct=x.doctor)==null?void 0:ct.location)||"Online"})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(wo,{className:"w-5 h-5 text-cyan-400"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-white font-medium",children:"Rating"}),a.jsxs("div",{className:"flex items-center gap-1",children:[[1,2,3,4,5].map(je=>a.jsx(wo,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"},je)),a.jsx("span",{className:"text-slate-400 text-sm ml-1",children:"(4.8)"})]})]})]})]})]})]}),a.jsx("div",{className:"mt-8 text-center",children:a.jsxs("button",{onClick:oe,className:"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white px-8 py-4 rounded-xl font-medium transition-all inline-flex items-center gap-2",children:[a.jsx(dc,{className:"w-5 h-5"}),"Start Consultation"]})})]})]}):a.jsxs("div",{className:"text-center py-12",children:[a.jsx(hn,{className:"w-16 h-16 text-red-400 mx-auto mb-4"}),a.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"Appointment Not Found"}),a.jsx("p",{className:"text-slate-400",children:"The appointment you're looking for doesn't exist."})]})}function BZ(){const{appointmentId:u}=Lh(),f=Ga(),[x,_]=j.useState(null),[E,y]=j.useState(!0),[R,P]=j.useState(0),[U,G]=j.useState(""),[F,k]=j.useState(!1),[X,q]=j.useState("summary");j.useEffect(()=>{D()},[u]);const D=async()=>{try{const{data:Z}=await sr.getConsultationSummary(u);_(Z)}catch{Ve.error("Failed to load consultation summary"),f("/doctors")}finally{y(!1)}},H=async()=>{if(R===0){Ve.error("Please provide a rating");return}k(!0);try{await sr.submitReview(u,{rating:R,review:U}),Ve.success("Review submitted successfully"),_(Z=>({...Z,reviewSubmitted:!0}))}catch{Ve.error("Failed to submit review")}finally{k(!1)}},B=async()=>{try{const Z=await sr.downloadPrescription(u),te=new Blob([Z.data],{type:"application/pdf"}),ie=window.URL.createObjectURL(te),ue=document.createElement("a");ue.href=ie,ue.download=`prescription-${u}.pdf`,ue.click(),window.URL.revokeObjectURL(ie)}catch{Ve.error("Failed to download prescription")}};if(E)return a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"})});const ne={doctor:{name:"Dr. Sarah Johnson",specialization:"General Physician"},date:new Date().toISOString(),duration:"30 minutes",diagnosis:"Vitamin D deficiency with mild fatigue symptoms",prescription:[{medication:"Vitamin D3 Supplement",dosage:"1000 IU daily",duration:"3 months",instructions:"Take with food, preferably in the morning"},{medication:"Multivitamin",dosage:"1 tablet daily",duration:"1 month",instructions:"Take after breakfast"}],recommendations:["Get 15-20 minutes of sunlight exposure daily","Include vitamin D rich foods like fatty fish, eggs, and fortified milk","Regular exercise to improve energy levels","Follow-up blood test in 3 months"],followUp:{date:new Date(Date.now()+90*24*60*60*1e3).toISOString(),type:"Blood test review"},notes:"Patient reported fatigue and low energy levels. Blood work shows vitamin D deficiency at 18 ng/mL (normal: 30-100). Recommended supplementation and lifestyle changes.",reviewSubmitted:!1},ae=x||ne;return a.jsxs("div",{className:"min-h-screen bg-[#0a0f1a] pb-8",children:[a.jsx("div",{className:"bg-[#111827] border-b border-slate-700 px-4 py-4",children:a.jsxs("div",{className:"max-w-4xl mx-auto flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("button",{onClick:()=>f("/doctors"),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-400"})}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-lg font-bold text-white",children:"Consultation Summary"}),a.jsxs("p",{className:"text-sm text-slate-400",children:[new Date(ae.date).toLocaleDateString(),"  ",ae.duration]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("button",{onClick:B,className:"flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors",children:[a.jsx(jE,{className:"w-4 h-4"}),"Download"]}),a.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-colors",children:[a.jsx(x2,{className:"w-4 h-4"}),"Share"]})]})]})}),a.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[a.jsx("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6 mb-6",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-16 h-16 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-xl font-bold text-white",children:ae.doctor.name[0]}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h2",{className:"text-xl font-bold text-white",children:ae.doctor.name}),a.jsx("p",{className:"text-slate-400",children:ae.doctor.specialization})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("div",{className:"flex items-center gap-1 mb-1",children:[1,2,3,4,5].map(Z=>a.jsx(wo,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"},Z))}),a.jsx("p",{className:"text-sm text-slate-400",children:"4.8 rating"})]})]})}),a.jsxs("div",{className:"flex gap-2 p-1 bg-slate-800 rounded-xl w-fit mb-6",children:[a.jsx("button",{onClick:()=>q("summary"),className:`px-4 py-2 rounded-lg font-medium transition-all ${X==="summary"?"bg-slate-700 text-white":"text-slate-400 hover:text-white"}`,children:"Summary"}),a.jsx("button",{onClick:()=>q("prescription"),className:`px-4 py-2 rounded-lg font-medium transition-all ${X==="prescription"?"bg-slate-700 text-white":"text-slate-400 hover:text-white"}`,children:"Prescription"}),a.jsx("button",{onClick:()=>q("followup"),className:`px-4 py-2 rounded-lg font-medium transition-all ${X==="followup"?"bg-slate-700 text-white":"text-slate-400 hover:text-white"}`,children:"Follow-up"})]}),a.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[a.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[X==="summary"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center",children:a.jsx(ms,{className:"w-5 h-5 text-blue-400"})}),a.jsx("h3",{className:"text-lg font-bold text-white",children:"Diagnosis"})]}),a.jsx("p",{className:"text-slate-300 leading-relaxed",children:ae.diagnosis})]}),a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center",children:a.jsx(un,{className:"w-5 h-5 text-green-400"})}),a.jsx("h3",{className:"text-lg font-bold text-white",children:"Doctor's Notes"})]}),a.jsx("p",{className:"text-slate-300 leading-relaxed",children:ae.notes})]}),a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center",children:a.jsx(Hs,{className:"w-5 h-5 text-cyan-400"})}),a.jsx("h3",{className:"text-lg font-bold text-white",children:"Recommendations"})]}),a.jsx("ul",{className:"space-y-3",children:ae.recommendations.map((Z,te)=>a.jsxs("li",{className:"flex items-start gap-3",children:[a.jsx(Hs,{className:"w-5 h-5 text-green-400 mt-0.5 shrink-0"}),a.jsx("span",{className:"text-slate-300",children:Z})]},te))})]})]}),X==="prescription"&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center",children:a.jsx(oc,{className:"w-5 h-5 text-purple-400"})}),a.jsx("h3",{className:"text-lg font-bold text-white",children:"Prescription"})]}),a.jsx("div",{className:"space-y-4",children:ae.prescription.map((Z,te)=>a.jsxs("div",{className:"p-4 bg-slate-800 rounded-xl",children:[a.jsxs("div",{className:"flex items-start justify-between mb-2",children:[a.jsx("h4",{className:"font-bold text-white",children:Z.medication}),a.jsx("span",{className:"text-sm text-slate-400",children:Z.duration})]}),a.jsx("p",{className:"text-cyan-400 font-medium mb-2",children:Z.dosage}),a.jsx("p",{className:"text-slate-300 text-sm",children:Z.instructions})]},te))}),a.jsx("div",{className:"mt-6 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl",children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(lc,{className:"w-5 h-5 text-yellow-400 mt-0.5"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-yellow-400 font-medium mb-1",children:"Important"}),a.jsx("p",{className:"text-slate-300 text-sm",children:"Take medications as prescribed. Do not stop or change dosage without consulting your doctor."})]})]})})]}),X==="followup"&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center",children:a.jsx(Pn,{className:"w-5 h-5 text-orange-400"})}),a.jsx("h3",{className:"text-lg font-bold text-white",children:"Follow-up Care"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"p-4 bg-slate-800 rounded-xl",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[a.jsx(Yr,{className:"w-5 h-5 text-cyan-400"}),a.jsx("h4",{className:"font-bold text-white",children:"Next Appointment"})]}),a.jsxs("p",{className:"text-slate-300",children:[new Date(ae.followUp.date).toLocaleDateString()," - ",ae.followUp.type]})]}),a.jsxs("div",{className:"p-4 bg-slate-800 rounded-xl",children:[a.jsx("h4",{className:"font-bold text-white mb-2",children:"Health Tracking"}),a.jsx("p",{className:"text-slate-300 text-sm mb-3",children:"Monitor your progress and upload follow-up reports to track improvements."}),a.jsx("button",{className:"bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm transition-colors",children:"Upload Report"})]})]})]})]}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Quick Actions"}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("button",{className:"w-full flex items-center gap-3 p-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors",children:[a.jsx(Pn,{className:"w-5 h-5 text-cyan-400"}),a.jsx("span",{className:"text-white",children:"Book Follow-up"})]}),a.jsxs("button",{className:"w-full flex items-center gap-3 p-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors",children:[a.jsx(Mh,{className:"w-5 h-5 text-cyan-400"}),a.jsx("span",{className:"text-white",children:"Message Doctor"})]}),a.jsxs("button",{className:"w-full flex items-center gap-3 p-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors",children:[a.jsx(dq,{className:"w-5 h-5 text-cyan-400"}),a.jsx("span",{className:"text-white",children:"Save to Health Records"})]})]})]}),!ae.reviewSubmitted&&a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Rate this Consultation"}),a.jsxs("div",{className:"mb-4",children:[a.jsx("p",{className:"text-slate-400 text-sm mb-2",children:"How was your experience?"}),a.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(Z=>a.jsx("button",{onClick:()=>P(Z),className:`p-1 transition-colors ${Z<=R?"text-yellow-400":"text-slate-600 hover:text-slate-400"}`,children:a.jsx(wo,{className:"w-6 h-6 fill-current"})},Z))})]}),a.jsx("textarea",{value:U,onChange:Z=>G(Z.target.value),placeholder:"Share your feedback (optional)",className:"w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-400 resize-none h-20 focus:outline-none focus:border-cyan-500"}),a.jsx("button",{onClick:H,disabled:F||R===0,className:"w-full mt-4 bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-600 text-white py-2 rounded-lg transition-colors flex items-center justify-center gap-2",children:F?a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):a.jsxs(a.Fragment,{children:[a.jsx(Uh,{className:"w-4 h-4"}),"Submit Review"]})})]}),a.jsxs("div",{className:"bg-[#111827] rounded-2xl border border-slate-700 p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Health Tracking"}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-slate-300",children:"Vitamin D Level"}),a.jsx("span",{className:"text-yellow-400",children:"Improving"})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-slate-300",children:"Energy Level"}),a.jsx("span",{className:"text-green-400",children:"Stable"})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-slate-300",children:"Sleep Quality"}),a.jsx("span",{className:"text-cyan-400",children:"Good"})]})]})]})]})]})]})]})}function GZ(){const[u,f]=j.useState(null),[x,_]=j.useState(null),[E,y]=j.useState(null),[R,P]=j.useState([]),[U,G]=j.useState(!1),[F,k]=j.useState(!0),[X,q]=j.useState(!0),D=j.useRef(null),H=j.useRef(null),B="e788e8f838484d4dafe4705d682df57c",ne="healthai-test";j.useEffect(()=>(ae(),()=>{ie()}),[]);const ae=()=>{const be=Gd.createClient({mode:"rtc",codec:"vp8"});be.on("user-published",async(Q,pe)=>{await be.subscribe(Q,pe),pe==="video"&&(P(he=>[...he.filter(Ae=>Ae.uid!==Q.uid),Q]),H.current&&Q.videoTrack.play(H.current)),pe==="audio"&&Q.audioTrack.play()}),be.on("user-unpublished",Q=>{P(pe=>pe.filter(he=>he.uid!==Q.uid))}),be.on("user-left",Q=>{P(pe=>pe.filter(he=>he.uid!==Q.uid))}),f(be)},Z=async()=>{if(u)try{const be=Math.floor(Math.random()*1e4);let Q=null;try{const fe=await(await fetch("/api/doctors/generate-video-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelName:ne,uid:be})})).json();fe.success&&(Q=fe.token,console.log("Generated token:",Q?"Token received":"No token (testing mode)"))}catch(Ae){console.log("Failed to get token from server, using null token:",Ae)}await u.join(B,ne,Q,be);const pe=await Gd.createCameraVideoTrack(),he=await Gd.createMicrophoneAudioTrack();_(pe),y(he),D.current&&pe.play(D.current),await u.publish([pe,he]),G(!0),Ve.success("Joined video call successfully!")}catch(be){console.error("Error joining channel:",be),Ve.error("Failed to join video call: "+be.message)}},te=async()=>{if(u)try{await ie(),G(!1),P([]),Ve.success("Left video call")}catch(be){console.error("Error leaving channel:",be),Ve.error("Failed to leave video call")}},ie=async()=>{x&&(x.stop(),x.close(),_(null)),E&&(E.stop(),E.close(),y(null)),u&&U&&await u.leave()},ue=async()=>{if(x){const be=!F;await x.setEnabled(be),k(be)}},Ne=async()=>{if(E){const be=!X;await E.setEnabled(be),q(be)}};return a.jsx("div",{className:"min-h-screen bg-[#0a0f1a] p-6",children:a.jsxs("div",{className:"max-w-6xl mx-auto",children:[a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Video Call Test"}),a.jsx("p",{className:"text-slate-400",children:"Test your Agora.io video calling setup"}),a.jsx("div",{className:"mt-4 p-4 bg-slate-800 rounded-lg",children:a.jsxs("p",{className:"text-sm text-slate-300",children:[a.jsx("strong",{children:"Channel:"})," ",ne," | ",a.jsx("strong",{children:"App ID:"})," ",B.substring(0,8),"..."]})})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:[a.jsxs("div",{className:"bg-slate-900 rounded-2xl overflow-hidden aspect-video relative",children:[a.jsx("div",{ref:D,className:"w-full h-full bg-slate-800"}),a.jsxs("div",{className:"absolute bottom-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm",children:["You ",U?"(Live)":"(Preview)"]}),!F&&a.jsx("div",{className:"absolute inset-0 bg-slate-800 flex items-center justify-center",children:a.jsx(hE,{className:"w-16 h-16 text-slate-400"})})]}),a.jsxs("div",{className:"bg-slate-900 rounded-2xl overflow-hidden aspect-video relative",children:[R.length>0?a.jsx("div",{ref:H,className:"w-full h-full bg-slate-800"}):a.jsx("div",{className:"w-full h-full bg-slate-800 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(dc,{className:"w-16 h-16 text-slate-400 mx-auto mb-4"}),a.jsx("p",{className:"text-slate-400",children:U?"Waiting for others to join...":"Remote participant will appear here"})]})}),R.length>0&&a.jsx("div",{className:"absolute bottom-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm",children:"Remote User"})]})]}),a.jsxs("div",{className:"flex items-center justify-center gap-4 mb-8",children:[a.jsx("button",{onClick:Ne,className:`p-4 rounded-full transition-colors ${X?"bg-slate-700 text-white hover:bg-slate-600":"bg-red-500 text-white hover:bg-red-600"}`,disabled:!U,children:X?a.jsx(w2,{className:"w-6 h-6"}):a.jsx(S2,{className:"w-6 h-6"})}),a.jsx("button",{onClick:ue,className:`p-4 rounded-full transition-colors ${F?"bg-slate-700 text-white hover:bg-slate-600":"bg-red-500 text-white hover:bg-red-600"}`,disabled:!U,children:F?a.jsx(dc,{className:"w-6 h-6"}):a.jsx(hE,{className:"w-6 h-6"})}),U?a.jsxs("button",{onClick:te,className:"bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full font-medium transition-colors flex items-center gap-2",children:[a.jsx(uq,{className:"w-5 h-5"}),"Leave Call"]}):a.jsxs("button",{onClick:Z,className:"bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full font-medium transition-colors flex items-center gap-2",children:[a.jsx(BE,{className:"w-5 h-5"}),"Join Call"]})]}),a.jsx("div",{className:"text-center",children:a.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium ${U?"bg-green-500/20 text-green-400":"bg-slate-500/20 text-slate-400"}`,children:[a.jsx("div",{className:`w-2 h-2 rounded-full ${U?"bg-green-400 animate-pulse":"bg-slate-400"}`}),U?`Connected (${R.length+1} participants)`:"Not connected"]})}),a.jsxs("div",{className:"mt-8 bg-slate-800 rounded-2xl p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Testing Instructions:"}),a.jsxs("ol",{className:"text-slate-300 space-y-2 list-decimal list-inside",children:[a.jsx("li",{children:'Click "Join Call" to start the video call'}),a.jsx("li",{children:"Allow camera and microphone permissions when prompted"}),a.jsx("li",{children:"Open this page in another browser tab/window to test with multiple participants"}),a.jsx("li",{children:"Test the mute/unmute and video on/off controls"}),a.jsx("li",{children:"Check that you can see and hear other participants"})]}),a.jsx("div",{className:"mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg",children:a.jsxs("p",{className:"text-blue-400 text-sm",children:[a.jsx("strong",{children:"Note:"})," This is using your Agora.io free tier (10,000 minutes/month). Perfect for testing and development!"]})}),a.jsxs("div",{className:"mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg",children:[a.jsx("h4",{className:"text-yellow-400 font-medium mb-2",children:" Troubleshooting"}),a.jsxs("div",{className:"text-yellow-300 text-sm space-y-1",children:[a.jsx("p",{children:a.jsx("strong",{children:"If video call fails:"})}),a.jsx("p",{children:" Check browser console for error messages"}),a.jsx("p",{children:" Ensure camera/microphone permissions are granted"}),a.jsx("p",{children:" Try disabling token authentication in Agora Console"}),a.jsx("p",{children:" Check server logs for token generation issues"})]})]}),a.jsxs("div",{className:"mt-4 p-4 bg-green-500/10 border border-green-500/20 rounded-lg",children:[a.jsx("h4",{className:"text-green-400 font-medium mb-2",children:" Quick Fix"}),a.jsx("div",{className:"text-green-300 text-sm",children:a.jsxs("p",{children:[a.jsx("strong",{children:"Easiest solution:"}),' Go to Agora Console  Project Settings  Change Authentication from "App ID + Token" to "App ID only"']})})]})]})]})})}function WZ(){const[u,f]=j.useState(""),[x,_]=j.useState(!1),[E,y]=j.useState(null),R=async P=>{if(P.preventDefault(),!u){Ve.error("Please enter an email address");return}_(!0),y(null);try{const G=await(await fetch("/api/doctors/test-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:u})})).json();G.success?(y({success:!0,message:G.message}),Ve.success("Test email sent successfully!")):(y({success:!1,message:G.message}),Ve.error("Failed to send email"))}catch(U){console.error("Email test error:",U),y({success:!1,message:U.message}),Ve.error("Failed to send email")}finally{_(!1)}};return a.jsx("div",{className:"min-h-screen bg-[#0a0f1a] p-6",children:a.jsxs("div",{className:"max-w-2xl mx-auto",children:[a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Email Test"}),a.jsx("p",{className:"text-slate-400",children:"Test your SMTP email configuration"})]}),a.jsxs("div",{className:"bg-slate-800 rounded-2xl p-6 mb-8",children:[a.jsxs("h3",{className:"text-lg font-bold text-white mb-4 flex items-center gap-2",children:[a.jsx(qd,{className:"w-5 h-5 text-cyan-400"}),"Current SMTP Configuration"]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-slate-400",children:"Host:"}),a.jsx("span",{className:"text-white ml-2",children:"smtp.gmail.com"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-slate-400",children:"Port:"}),a.jsx("span",{className:"text-white ml-2",children:"587"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-slate-400",children:"User:"}),a.jsx("span",{className:"text-white ml-2",children:"tech@colabplatforms.com"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-slate-400",children:"From:"}),a.jsx("span",{className:"text-white ml-2",children:"HealthAI <tech@colabplatforms.com>"})]})]})]}),a.jsxs("div",{className:"bg-slate-800 rounded-2xl p-6 mb-8",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Send Test Email"}),a.jsxs("form",{onSubmit:R,className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Test Email Address"}),a.jsx("input",{type:"email",value:u,onChange:P=>f(P.target.value),placeholder:"Enter email to receive test appointment confirmation",className:"w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500",required:!0})]}),a.jsx("button",{type:"submit",disabled:x,className:"w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 disabled:from-slate-600 disabled:to-slate-600 text-white py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2",children:x?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Sending..."]}):a.jsxs(a.Fragment,{children:[a.jsx(Uh,{className:"w-5 h-5"}),"Send Test Email"]})})]})]}),E&&a.jsxs("div",{className:`rounded-2xl p-6 ${E.success?"bg-green-500/10 border border-green-500/20":"bg-red-500/10 border border-red-500/20"}`,children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[E.success?a.jsx(Hs,{className:"w-6 h-6 text-green-400"}):a.jsx(hn,{className:"w-6 h-6 text-red-400"}),a.jsx("h3",{className:`text-lg font-bold ${E.success?"text-green-400":"text-red-400"}`,children:E.success?"Email Sent Successfully!":"Email Failed"})]}),a.jsx("p",{className:`${E.success?"text-green-300":"text-red-300"}`,children:E.message}),E.success&&a.jsxs("div",{className:"mt-4 p-4 bg-slate-800 rounded-lg",children:[a.jsx("h4",{className:"text-white font-medium mb-2",children:"What to expect:"}),a.jsxs("ul",{className:"text-slate-300 text-sm space-y-1",children:[a.jsx("li",{children:' Check your inbox for "Appointment Confirmation - HealthAI"'}),a.jsx("li",{children:" The email will contain appointment details and a join link"}),a.jsx("li",{children:" It may take a few minutes to arrive"}),a.jsx("li",{children:" Check spam folder if not received"})]})]})]}),a.jsxs("div",{className:"mt-8 bg-slate-800 rounded-2xl p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Email Features"}),a.jsxs("div",{className:"space-y-4 text-slate-300",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"text-white font-medium mb-2",children:" Appointment Confirmation"}),a.jsx("p",{className:"text-sm",children:"Professional HTML email with appointment details, doctor info, and video call join link."})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-white font-medium mb-2",children:" Automated Reminders"}),a.jsx("p",{className:"text-sm",children:"System sends reminders 24 hours before and 30 minutes before appointments."})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-white font-medium mb-2",children:" Mobile Responsive"}),a.jsx("p",{className:"text-sm",children:"Emails look great on all devices with touch-friendly buttons and responsive design."})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-white font-medium mb-2",children:" Professional Design"}),a.jsx("p",{className:"text-sm",children:"Branded emails with HealthAI colors, gradients, and professional layout."})]})]})]}),a.jsxs("div",{className:"mt-8 bg-yellow-500/10 border border-yellow-500/20 rounded-2xl p-6",children:[a.jsx("h3",{className:"text-lg font-bold text-yellow-400 mb-4",children:"Troubleshooting"}),a.jsxs("div",{className:"space-y-2 text-yellow-300 text-sm",children:[a.jsxs("p",{children:[" ",a.jsx("strong",{children:"Gmail App Password:"})," Make sure you're using an app password, not your regular Gmail password"]}),a.jsxs("p",{children:[" ",a.jsx("strong",{children:"2FA Required:"})," Gmail requires 2-factor authentication to generate app passwords"]}),a.jsxs("p",{children:[" ",a.jsx("strong",{children:"Less Secure Apps:"}),' App passwords bypass the need for "less secure apps" setting']}),a.jsxs("p",{children:[" ",a.jsx("strong",{children:"Rate Limits:"})," Gmail has sending limits (500 emails/day for free accounts)"]}),a.jsxs("p",{children:[" ",a.jsx("strong",{children:"Spam Filters:"})," Test emails might go to spam initially"]})]})]})]})})}const HZ=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],go={startTime:"09:00",endTime:"18:00",slotDuration:30};function zZ(){const[u,f]=j.useState(go),[x,_]=j.useState({}),[E,y]=j.useState({}),[R,P]=j.useState(!1),[U,G]=j.useState(!0),F=()=>{const te=[],ie=new Date;for(let ue=0;ue<7;ue++){const Ne=new Date(ie);Ne.setDate(ie.getDate()+ue),te.push({date:Ne.toISOString().split("T")[0],dayName:HZ[Ne.getDay()],displayDate:Ne.toLocaleDateString("en-US",{month:"short",day:"numeric"}),isToday:ue===0})}return te},[k]=j.useState(F());j.useEffect(()=>{X()},[]);const X=async()=>{var te,ie,ue,Ne,be,Q,pe;try{const{data:he}=await sr.getMyAvailability(),Ae={startTime:((ie=(te=he.availability)==null?void 0:te.settings)==null?void 0:ie.startTime)||go.startTime,endTime:((Ne=(ue=he.availability)==null?void 0:ue.settings)==null?void 0:Ne.endTime)||go.endTime,slotDuration:((Q=(be=he.availability)==null?void 0:be.settings)==null?void 0:Q.slotDuration)||go.slotDuration};f(Ae),(pe=he.availability)!=null&&pe.blockedSlots&&y(he.availability.blockedSlots),q(Ae)}catch(he){console.error("Failed to fetch availability:",he),q(go)}finally{G(!1)}},q=te=>{te||(te=go);const ie={},ue=te.startTime||go.startTime,Ne=te.endTime||go.endTime,be=te.slotDuration||go.slotDuration,Q=ue.split(":"),pe=Ne.split(":");if(Q.length<2||pe.length<2){console.error("Invalid time format");return}const he=parseInt(Q[0],10),Ae=parseInt(Q[1],10),fe=parseInt(pe[0],10),le=parseInt(pe[1],10);k.forEach(we=>{ie[we.date]=[];let re=he*60+Ae;const oe=fe*60+le;for(;re<oe;){const J=Math.floor(re/60),Oe=re%60,$e=`${J.toString().padStart(2,"0")}:${Oe.toString().padStart(2,"0")}`,He=new Date(`2000-01-01T${$e}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});ie[we.date].push({time:$e,display:He}),re+=be}}),_(ie)},D=(te,ie)=>{const ue={...u,[te]:ie};f(ue),q(ue)},H=(te,ie)=>{y(ue=>{const Ne=ue[te]||[];return Ne.includes(ie)?{...ue,[te]:Ne.filter(be=>be!==ie)}:{...ue,[te]:[...Ne,ie]}})},B=te=>{const ie=x[te]||[];(E[te]||[]).length===ie.length?y(Ne=>({...Ne,[te]:[]})):y(Ne=>({...Ne,[te]:ie.map(be=>be.time)}))},ne=(te,ie)=>(E[te]||[]).includes(ie),ae=te=>{const ie=x[te]||[],ue=E[te]||[];return ie.length>0&&ue.length===ie.length},Z=async()=>{var te,ie;P(!0);try{const ue=await sr.updateMyAvailability({settings:u,blockedSlots:E});console.log("Save response:",ue.data),Ve.success("Availability saved successfully!")}catch(ue){console.error("Failed to save:",ue),Ve.error(((ie=(te=ue.response)==null?void 0:te.data)==null?void 0:ie.message)||"Failed to save availability")}finally{P(!1)}};return U?a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-500",children:"Loading availability..."})]})}):a.jsxs("div",{className:"space-y-6 animate-fade-in",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"Manage Your Slots"}),a.jsx("p",{className:"text-slate-500 mt-1",children:"Set your operating hours and block unavailable times"})]}),a.jsxs("button",{onClick:Z,disabled:R,className:"flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl font-medium hover:shadow-lg transition-all disabled:opacity-50",children:[R?a.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}):a.jsx(b2,{className:"w-5 h-5"}),"Save Changes"]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-6 shadow-sm",children:[a.jsxs("h2",{className:"text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2",children:[a.jsx(Yr,{className:"w-5 h-5 text-cyan-500"}),"Operating Hours"]}),a.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"Start Time"}),a.jsx("select",{value:u.startTime,onChange:te=>D("startTime",te.target.value),className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:border-cyan-500 focus:outline-none",children:Array.from({length:24},(te,ie)=>{const ue=`${ie.toString().padStart(2,"0")}:00`,Ne=new Date(`2000-01-01T${ue}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return a.jsx("option",{value:ue,children:Ne},ue)})})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"End Time"}),a.jsx("select",{value:u.endTime,onChange:te=>D("endTime",te.target.value),className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:border-cyan-500 focus:outline-none",children:Array.from({length:24},(te,ie)=>{const ue=`${ie.toString().padStart(2,"0")}:00`,Ne=new Date(`2000-01-01T${ue}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return a.jsx("option",{value:ue,children:Ne},ue)})})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"Slot Duration"}),a.jsxs("select",{value:u.slotDuration,onChange:te=>D("slotDuration",parseInt(te.target.value)),className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:border-cyan-500 focus:outline-none",children:[a.jsx("option",{value:15,children:"15 minutes"}),a.jsx("option",{value:30,children:"30 minutes"}),a.jsx("option",{value:45,children:"45 minutes"}),a.jsx("option",{value:60,children:"60 minutes"})]})]})]}),a.jsxs("p",{className:"text-sm text-slate-400 mt-3",children:["Current: ",u.startTime," to ",u.endTime,", ",u.slotDuration," min slots"]})]}),a.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-4 h-4 rounded-full bg-emerald-100 border-2 border-emerald-300"}),a.jsx("span",{className:"text-slate-600",children:"Available"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-4 h-4 rounded-full bg-red-100 border-2 border-red-300"}),a.jsx("span",{className:"text-slate-600",children:"Blocked"})]}),a.jsx("p",{className:"text-slate-400 ml-auto",children:"Click on slots to block/unblock"})]}),a.jsx("div",{className:"space-y-4",children:k.map(te=>{const ie=x[te.date]||[],ue=ae(te.date);return a.jsxs("div",{className:"bg-white rounded-2xl border border-slate-200 p-5 shadow-sm",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(Pn,{className:"w-5 h-5 text-cyan-500"}),a.jsxs("div",{children:[a.jsxs("h3",{className:"font-semibold text-slate-800",children:[te.dayName,te.isToday&&a.jsx("span",{className:"ml-2 text-xs bg-cyan-100 text-cyan-600 px-2 py-0.5 rounded-full",children:"Today"})]}),a.jsx("p",{className:"text-sm text-slate-500",children:te.displayDate})]})]}),a.jsx("button",{onClick:()=>B(te.date),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all ${ue?"bg-emerald-100 text-emerald-600 hover:bg-emerald-200":"bg-red-100 text-red-600 hover:bg-red-200"}`,children:ue?a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(cc,{className:"w-4 h-4"})," Unblock All"]}):a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(ra,{className:"w-4 h-4"})," Block Day"]})})]}),a.jsxs("div",{className:"flex flex-wrap gap-2",children:[ie.map(Ne=>{const be=ne(te.date,Ne.time);return a.jsx("button",{onClick:()=>H(te.date,Ne.time),className:`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${be?"bg-red-100 text-red-600 border border-red-200 hover:bg-red-200":"bg-emerald-100 text-emerald-600 border border-emerald-200 hover:bg-emerald-200"}`,children:Ne.display},Ne.time)}),ie.length===0&&a.jsx("p",{className:"text-slate-400 text-sm py-2",children:"No slots - check your operating hours"})]})]},te.date)})}),a.jsxs("div",{className:"bg-cyan-50 border border-cyan-200 rounded-xl p-4",children:[a.jsx("h3",{className:"font-medium text-cyan-800 mb-2",children:" Quick Tips"}),a.jsxs("ul",{className:"text-sm text-cyan-700 space-y-1",children:[a.jsx("li",{children:" Set your operating hours above to auto-generate time slots"}),a.jsx("li",{children:" Click individual slots to block specific times"}),a.jsx("li",{children:' Use "Block Day" to mark entire days as unavailable'}),a.jsx("li",{children:" Don't forget to save your changes!"})]})]})]})}function KZ(){var he,Ae,fe,le,we,re;const{user:u}=ia(),[f,x]=j.useState(!0),[_,E]=j.useState(!1),[y,R]=j.useState(null),[P,U]=j.useState(null),[G,F]=j.useState(null),[k,X]=j.useState([]),[q,D]=j.useState(null),[H,B]=j.useState(!1),[ne,ae]=j.useState(null),[Z,te]=j.useState(!1);j.useEffect(()=>{window.scrollTo(0,0),ie(),ue(),be(),Q()},[]),j.useEffect(()=>{if(ne&&y&&y.generatedAt){const oe=new Date(y.generatedAt),J=new Date(ne.updatedAt||ne.createdAt);console.log(" Checking if plan is outdated..."),console.log(" Plan generated:",oe),console.log(" Goal updated:",J),J>oe?(te(!0),console.log(" Diet plan is OUTDATED - goals were updated after plan generation")):(te(!1),console.log(" Diet plan is up-to-date"))}},[ne,y]),j.useEffect(()=>{q&&Ne(q)},[q]);const ie=async()=>{var oe;try{const J=localStorage.getItem("token"),Oe=await fetch("/api/nutrition/goals",{headers:{Authorization:`Bearer ${J}`}});if(console.log(" Nutrition goal response status:",Oe.status),Oe.status===404){B(!1),console.log(" No nutrition goal set (404)");return}if(Oe.ok){const $e=await Oe.json();console.log(" Full response data:",JSON.stringify($e,null,2)),console.log(" data.success:",$e.success),console.log(" data.healthGoal:",$e.healthGoal),console.log(" data.healthGoal?.goalType:",(oe=$e.healthGoal)==null?void 0:oe.goalType),$e.success&&$e.healthGoal&&$e.healthGoal.goalType?(B(!0),ae($e.healthGoal),console.log(" User has nutrition goal:",$e.healthGoal.goalType)):(B(!1),console.log(" No nutrition goal in response"))}else B(!1),console.log(" Failed to fetch nutrition goal, status:",Oe.status)}catch(J){console.error("Failed to check nutrition goal:",J),B(!1)}},ue=async()=>{try{const{data:oe}=await qr.getReports(),Oe=(Array.isArray(oe)?oe:oe.reports||[]).filter($e=>{var He;return(He=$e.aiAnalysis)==null?void 0:He.dietPlan});if(X(Oe),Oe.length>0&&!q){const $e=Oe[0];D($e._id)}}catch(oe){console.error("Failed to fetch reports:",oe)}finally{x(!1)}},Ne=async oe=>{var J,Oe;try{x(!0);const{data:$e}=await qr.getReport(oe),He=$e.report;if(console.log(" Report Data:",He),console.log(" AI Analysis:",He.aiAnalysis),console.log(" Diet Plan:",(J=He.aiAnalysis)==null?void 0:J.dietPlan),(Oe=He.aiAnalysis)!=null&&Oe.dietPlan){const ot=He.aiAnalysis.dietPlan;console.log(" Breakfast:",ot.breakfast),console.log(" Lunch:",ot.lunch),console.log(" Dinner:",ot.dinner),console.log(" Snacks:",ot.snacks);let _t={protein:150,carbs:250,fats:65},Ke=2e3,ht=!1;try{const ct=localStorage.getItem("token"),ys=await(await fetch("/api/nutrition/goals",{headers:{Authorization:`Bearer ${ct}`}})).json();ys.healthGoal&&(Ke=ys.healthGoal.dailyCalorieTarget||2e3,_t=ys.healthGoal.macroTargets||_t,ht=!0)}catch{console.log("Using default macro targets")}const st={mealPlan:{breakfast:Array.isArray(ot.breakfast)?ot.breakfast:[],lunch:Array.isArray(ot.lunch)?ot.lunch:[],dinner:Array.isArray(ot.dinner)?ot.dinner:[],snacks:Array.isArray(ot.snacks)?ot.snacks:[]},dailyCalorieTarget:Ke,macroTargets:_t,hasGoals:ht,keyFoods:[],lifestyleRecommendations:Array.isArray(ot.tips)?ot.tips:[],createdAt:He.createdAt,source:"report",reportId:oe};console.log(" Setting personalized plan:",st),console.log(" Meal counts:",{breakfast:st.mealPlan.breakfast.length,lunch:st.mealPlan.lunch.length,dinner:st.mealPlan.dinner.length,snacks:st.mealPlan.snacks.length}),R(st),st.mealPlan.breakfast.length===0&&st.mealPlan.lunch.length===0&&st.mealPlan.dinner.length===0&&st.mealPlan.snacks.length===0&&Ve.error("Diet plan is empty. The AI analysis may not have generated meal recommendations.")}else console.log(" No diet plan in AI analysis"),R(null),Ve.error("This report does not contain a diet plan")}catch($e){console.error(" Failed to fetch report diet plan:",$e),Ve.error("Failed to load diet plan from report"),R(null)}finally{x(!1)}},be=async()=>{try{const oe=localStorage.getItem("token"),J=await fetch("/api/diet-recommendations/diet-plan/active",{headers:{Authorization:`Bearer ${oe}`}});if(J.status===404){console.log("Diet recommendation routes not available");return}const Oe=await J.json();Oe.success&&Oe.dietPlan&&(R(Oe.dietPlan),console.log(" Fetched diet plan:",Oe.dietPlan.generatedAt))}catch(oe){console.error("Failed to fetch personalized plan:",oe)}},Q=async()=>{try{const oe=localStorage.getItem("token"),J=await fetch("/api/diet-recommendations/supplements/active",{headers:{Authorization:`Bearer ${oe}`}});if(J.status===404){console.log("Supplement recommendation routes not available");return}const Oe=await J.json();Oe.success&&Oe.recommendations&&U(Oe.recommendations)}catch(oe){console.error("Failed to fetch supplement recommendations:",oe)}},pe=async()=>{E(!0);try{const oe=localStorage.getItem("token"),J=await fetch("/api/diet-recommendations/diet-plan/generate",{method:"POST",headers:{Authorization:`Bearer ${oe}`,"Content-Type":"application/json"}});if(J.status===404){Ve.error("Diet plan service is not available. Please restart the server.");return}const Oe=await J.json();Oe.success?(R(Oe.dietPlan),te(!1),Ve.success("AI-powered diet plan generated!")):Ve.error(Oe.message||"Failed to generate plan")}catch(oe){console.error("Failed to generate AI plan:",oe),Ve.error("Failed to generate personalized plan. Please restart the server.")}finally{E(!1)}};return f?a.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-600",children:"Loading your personalized plan..."})]})}):a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-cyan-50 via-blue-50 to-cyan-100 pb-20",children:a.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 animate-fade-in p-4",children:[a.jsxs("div",{className:"md:hidden flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-md flex-shrink-0",children:((Ae=(he=u==null?void 0:u.name)==null?void 0:he[0])==null?void 0:Ae.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const oe=new Date().getHours();return oe<12?"Good Morning":oe<18?"Good Afternoon":"Good Evening"})(),", ",((fe=u==null?void 0:u.name)==null?void 0:fe.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),a.jsxs("div",{className:"relative overflow-hidden bg-gradient-to-br from-emerald-500 via-green-500 to-teal-500 rounded-3xl p-8 text-white shadow-2xl",children:[a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32"}),a.jsx("div",{className:"absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full -ml-24 -mb-24"}),a.jsxs("div",{className:"relative z-10",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx("div",{className:"w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center",children:a.jsx(Ji,{className:"w-8 h-8"})}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl sm:text-4xl font-bold",children:"Your Personalized Diet Plan"}),a.jsx("p",{className:"text-emerald-100 mt-1",children:"AI-powered nutrition guidance tailored for you"})]})]}),(u==null?void 0:u.profile)&&a.jsxs("div",{className:"flex flex-wrap gap-3 mt-6",children:[u.profile.age&&a.jsxs("div",{className:"px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center gap-2",children:[a.jsx(Pn,{className:"w-4 h-4"}),a.jsxs("span",{className:"text-sm font-medium",children:[u.profile.age," years"]})]}),u.profile.gender&&a.jsxs("div",{className:"px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center gap-2",children:[a.jsx(vr,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm font-medium capitalize",children:u.profile.gender})]}),u.profile.dietaryPreference&&a.jsxs("div",{className:"px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl flex items-center gap-2",children:[a.jsx(qv,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm font-medium capitalize",children:u.profile.dietaryPreference})]})]})]})]}),k.length>0&&a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-xl font-bold text-slate-800 flex items-center gap-2",children:[a.jsx(un,{className:"w-6 h-6 text-cyan-500"}),"Select Report for Diet Plan"]}),a.jsxs(Rt,{to:"/upload",className:"px-3 py-1.5 bg-cyan-500 text-white rounded-lg text-sm font-medium hover:bg-cyan-600 transition-colors flex items-center gap-1",children:[a.jsx(Qn,{className:"w-3 h-3"}),"Upload New"]})]}),a.jsx("select",{value:q||"",onChange:oe=>D(oe.target.value),className:"w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl text-slate-800 font-medium focus:border-cyan-500 focus:outline-none cursor-pointer",children:k.map(oe=>{var J;return a.jsxs("option",{value:oe._id,children:[oe.reportType," - ",new Date(oe.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})," ",(J=oe.aiAnalysis)!=null&&J.healthScore?`(Score: ${oe.aiAnalysis.healthScore})`:""]},oe._id)})})]}),k.length===0&&a.jsx("div",{className:"text-center",children:a.jsxs(Rt,{to:"/upload",className:"inline-flex items-center gap-2 px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium hover:bg-cyan-600 transition-colors",children:[a.jsx(Qn,{className:"w-4 h-4"}),"Upload Report"]})}),y&&a.jsxs(a.Fragment,{children:[Z&&a.jsxs("div",{className:"bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-2xl p-6 flex items-start gap-4 shadow-lg",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-amber-500 flex items-center justify-center shrink-0",children:a.jsx(hn,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-lg font-bold text-amber-900 mb-2",children:"Your Goals Have Changed!"}),a.jsx("p",{className:"text-amber-800 mb-4",children:"You've updated your nutrition goals since this diet plan was created. Generate a new plan to match your current goals."}),a.jsx("button",{onClick:pe,disabled:_,className:"px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:_?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Generating New Plan..."]}):a.jsxs(a.Fragment,{children:[a.jsx(bo,{className:"w-5 h-5"}),"Generate New Diet Plan"]})})]})]}),a.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-5 text-center hover:shadow-xl transition-shadow",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center mx-auto mb-3",children:a.jsx(zr,{className:"w-6 h-6 text-white"})}),a.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Daily Calories"}),a.jsx("p",{className:"text-2xl font-bold text-slate-800",children:y.dailyCalorieTarget}),y.source==="report"&&!y.hasGoals&&a.jsx(Rt,{to:"/profile?tab=goals",className:"text-xs text-cyan-600 hover:underline mt-1 block",children:"Set Goals"})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-5 text-center hover:shadow-xl transition-shadow",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center mx-auto mb-3",children:a.jsx(vr,{className:"w-6 h-6 text-white"})}),a.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Protein"}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:[(le=y.macroTargets)==null?void 0:le.protein,"g"]})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-5 text-center hover:shadow-xl transition-shadow",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center mx-auto mb-3",children:a.jsx(qv,{className:"w-6 h-6 text-white"})}),a.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Carbs"}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:[(we=y.macroTargets)==null?void 0:we.carbs,"g"]})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-5 text-center hover:shadow-xl transition-shadow",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center mx-auto mb-3",children:a.jsx(zn,{className:"w-6 h-6 text-white"})}),a.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Fats"}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:[(re=y.macroTargets)==null?void 0:re.fats,"g"]})]})]}),y.source==="report"&&!y.hasGoals&&a.jsxs("div",{className:"bg-amber-50 border-2 border-amber-200 rounded-2xl p-4 flex items-start gap-3",children:[a.jsx(hn,{className:"w-5 h-5 text-amber-600 shrink-0 mt-0.5"}),a.jsx("div",{className:"flex-1",children:a.jsxs("p",{className:"text-sm text-amber-900",children:[a.jsx("strong",{children:"Using default macro targets."})," For personalized calorie and macro goals based on your body metrics,",a.jsx(Rt,{to:"/profile?tab=goals",className:"text-amber-700 hover:underline font-semibold ml-1",children:"set your fitness goals "})]})})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(mg,{className:"w-6 h-6 text-emerald-500"}),"Your Daily Meal Plan"]}),a.jsx("div",{className:"space-y-4",children:Object.entries(y.mealPlan||{}).map(([oe,J])=>J&&J.length>0&&a.jsx(YZ,{mealType:oe,meals:J,expanded:G===oe,onToggle:()=>F(G===oe?null:oe)},oe))})]}),y.keyFoods&&y.keyFoods.length>0&&a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-slate-800 mb-4 flex items-center gap-2",children:[a.jsx(qv,{className:"w-6 h-6 text-green-500"}),"Key Foods to Include"]}),a.jsx("div",{className:"grid sm:grid-cols-2 gap-3",children:y.keyFoods.map((oe,J)=>a.jsxs("div",{className:"p-4 bg-green-50 rounded-xl border-2 border-green-200 hover:shadow-md transition-shadow",children:[a.jsx("p",{className:"font-bold text-green-900 mb-1",children:oe.name}),a.jsx("p",{className:"text-sm text-green-700 mb-2",children:oe.reason}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600",children:[a.jsx(Yr,{className:"w-3 h-3"}),a.jsx("span",{className:"font-medium",children:oe.frequency})]})]},J))})]}),y.lifestyleRecommendations&&y.lifestyleRecommendations.length>0&&a.jsxs("div",{className:"bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl border-2 border-cyan-200 p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-cyan-900 mb-4 flex items-center gap-2",children:[a.jsx(hq,{className:"w-6 h-6 text-cyan-600"}),"Lifestyle Tips"]}),a.jsx("ul",{className:"space-y-3",children:y.lifestyleRecommendations.map((oe,J)=>a.jsxs("li",{className:"flex items-start gap-3 text-cyan-800",children:[a.jsx(Hs,{className:"w-5 h-5 mt-0.5 text-cyan-500 shrink-0"}),a.jsx("span",{children:oe})]},J))})]}),(P==null?void 0:P.supplements)&&P.supplements.length>0&&a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[a.jsxs("h2",{className:"text-xl font-bold text-slate-800 mb-4 flex items-center gap-2",children:[a.jsx(bo,{className:"w-6 h-6 text-purple-500"}),"Supplement Recommendations"]}),a.jsx("p",{className:"text-sm text-slate-600 mb-6",children:P.consultationNote||"Always consult a healthcare provider before starting supplements."}),a.jsx("div",{className:"space-y-4",children:P.supplements.map((oe,J)=>a.jsxs("div",{className:"p-5 bg-purple-50 border-2 border-purple-200 rounded-xl hover:shadow-md transition-shadow",children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsx("h3",{className:"font-bold text-purple-900 text-lg",children:oe.name}),oe.priority&&a.jsx("span",{className:`text-xs px-3 py-1 rounded-full font-semibold ${oe.priority==="high"?"bg-red-100 text-red-700":oe.priority==="medium"?"bg-amber-100 text-amber-700":"bg-green-100 text-green-700"}`,children:oe.priority.toUpperCase()})]}),a.jsx("p",{className:"text-sm text-purple-700 mb-3",children:oe.reason}),a.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 mb-3",children:[a.jsxs("div",{className:"p-3 bg-white rounded-lg",children:[a.jsx("p",{className:"text-xs text-purple-600 font-semibold mb-1",children:"Dosage"}),a.jsx("p",{className:"text-sm text-purple-900",children:oe.dosage})]}),a.jsxs("div",{className:"p-3 bg-white rounded-lg",children:[a.jsx("p",{className:"text-xs text-purple-600 font-semibold mb-1",children:"Timing"}),a.jsx("p",{className:"text-sm text-purple-900",children:oe.timing})]})]}),oe.precautions&&a.jsx("div",{className:"p-3 bg-amber-50 rounded-lg border border-amber-200",children:a.jsxs("p",{className:"text-xs text-amber-700",children:[a.jsx("strong",{children:" Precautions:"})," ",oe.precautions]})})]},J))})]})]}),!y&&!f&&a.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-12 text-center",children:[a.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center mx-auto mb-6",children:a.jsx(Ji,{className:"w-10 h-10 text-white"})}),a.jsx("h3",{className:"text-2xl font-bold text-slate-800 mb-3",children:H?"Generate Your Diet Plan":"Set Your Goals First"}),a.jsx("p",{className:"text-slate-600 mb-6 max-w-md mx-auto",children:H?"Click the button below to generate a personalized AI-powered diet plan based on your nutrition goals.":"Set your nutrition goals in your profile to get a personalized diet plan. You can also upload health reports for more detailed recommendations."}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[H?a.jsx("button",{onClick:pe,disabled:_,className:"px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:_?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Generating..."]}):a.jsxs(a.Fragment,{children:[a.jsx(bo,{className:"w-5 h-5"}),"Generate AI Diet Plan"]})}):a.jsxs(Rt,{to:"/profile?tab=goals",className:"px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2",children:[a.jsx(vr,{className:"w-5 h-5"}),"Set Your Goals"]}),a.jsx(Rt,{to:"/upload",className:"px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl font-medium hover:shadow-lg transition-all",children:"Upload Report"})]})]}),a.jsxs("div",{className:"bg-slate-100 border-2 border-slate-200 rounded-xl p-4 text-sm text-slate-600",children:[a.jsx("strong",{className:"text-slate-800",children:"Disclaimer:"})," This diet plan is AI-generated for informational purposes only. It is not a substitute for professional medical advice. Please consult a healthcare provider or registered dietitian before making significant changes to your diet."]})]})})}function YZ({mealType:u,meals:f,expanded:x,onToggle:_}){const E={breakfast:{icon:pq,color:"from-amber-400 to-orange-500",bg:"bg-amber-50",border:"border-amber-200",text:"text-amber-700"},lunch:{icon:f2,color:"from-orange-400 to-red-500",bg:"bg-orange-50",border:"border-orange-200",text:"text-orange-700"},dinner:{icon:Yd,color:"from-indigo-400 to-purple-500",bg:"bg-indigo-50",border:"border-indigo-200",text:"text-indigo-700"},snacks:{icon:Ji,color:"from-green-400 to-emerald-500",bg:"bg-green-50",border:"border-green-200",text:"text-green-700"}},y=E[u.toLowerCase()]||E.breakfast,R=y.icon,P=Array.isArray(f)?f:[];return a.jsxs("div",{className:`${y.bg} border-2 ${y.border} rounded-xl p-5 hover:shadow-md transition-all`,children:[a.jsxs("button",{onClick:_,className:"w-full flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-12 h-12 rounded-xl bg-gradient-to-br ${y.color} flex items-center justify-center`,children:a.jsx(R,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{className:"text-left",children:[a.jsx("h3",{className:"font-bold text-slate-800 text-lg capitalize",children:u.replace(/([A-Z])/g," $1").trim()}),a.jsxs("p",{className:"text-sm text-slate-600",children:[P.length," options"]})]})]}),x?a.jsx(mq,{className:"w-6 h-6 text-slate-400"}):a.jsx(yo,{className:"w-6 h-6 text-slate-400"})]}),x&&P.length>0&&a.jsx("div",{className:"mt-4 space-y-3",children:P.map((U,G)=>{let F="Meal",k="",X="",q="",D="";try{typeof U=="string"?F=U:U&&typeof U=="object"&&(F=String(U.name||U.meal||"Meal"),k=String(U.description||U.tip||""),X=String(U.benefits||""),U.nutrients&&typeof U.nutrients=="object"?(q=String(U.nutrients.calories||U.nutrients.Calories||""),D=String(U.nutrients.protein||U.nutrients.Protein||"")):(q=String(U.calories||""),D=String(U.protein||"")))}catch(H){console.error("Error parsing meal item:",H,U),F="Meal"}return a.jsx("div",{className:"p-4 bg-white rounded-xl border border-slate-200",children:a.jsxs("div",{className:"flex justify-between items-start mb-2",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-bold text-slate-800",children:F}),k&&a.jsx("p",{className:"text-sm text-slate-600 mt-1",children:k}),X&&a.jsxs("p",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[a.jsx(Hs,{className:"w-3 h-3"}),a.jsx("span",{children:X})]})]}),q&&a.jsxs("div",{className:"text-right ml-4",children:[a.jsx("p",{className:"text-lg font-bold text-slate-800",children:q}),a.jsx("p",{className:"text-xs text-slate-500",children:"calories"}),D&&a.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:[D,"g protein"]})]})]})},G)})}),x&&P.length===0&&a.jsx("div",{className:"mt-4 p-4 bg-white rounded-xl border border-slate-200 text-center text-slate-500",children:"No meals available for this category"})]})}function qZ(){var Ae,fe,le;const{user:u}=ia(),f=hg(),[x,_]=j.useState([]),[E,y]=j.useState(""),[R,P]=j.useState(!1),[U,G]=j.useState(!1),[F,k]=j.useState(""),[X,q]=j.useState(null),[D,H]=j.useState([]),[B,ne]=j.useState(!1),ae=j.useRef(null),Z=j.useRef(null);j.useEffect(()=>{(async()=>{try{const re=localStorage.getItem("token"),oe=await fetch("/api/health/reports",{headers:{Authorization:`Bearer ${re}`}});if(oe.ok){const J=await oe.json();H(J.reports||[])}}catch(re){console.error("Failed to load reports:",re)}})()},[]),j.useEffect(()=>{var re,oe;u&&(async()=>{try{const J=localStorage.getItem("token"),Oe=await fetch("/api/chat/history",{headers:{Authorization:`Bearer ${J}`}});if(Oe.ok){const He=await Oe.json();if(He.success&&He.messages&&He.messages.length>0){_(He.messages),localStorage.setItem(`chat_history_${u==null?void 0:u.id}`,JSON.stringify(He.messages));return}}const $e=localStorage.getItem(`chat_history_${u==null?void 0:u.id}`);if($e){const He=JSON.parse($e);_(He)}else{const He=te();_([{role:"assistant",content:He,timestamp:new Date}])}}catch(J){console.error("Failed to load chat history:",J);const Oe=localStorage.getItem(`chat_history_${u==null?void 0:u.id}`);if(Oe)_(JSON.parse(Oe));else{const $e=te();_([{role:"assistant",content:$e,timestamp:new Date}])}}})(),(re=f.state)!=null&&re.initialQuery?(y(f.state.initialQuery),setTimeout(()=>{const J=document.querySelector("form");J&&J.requestSubmit()},500)):(oe=f.state)!=null&&oe.selectedText&&y(`Can you explain this: "${f.state.selectedText}"`)},[u==null?void 0:u.id,f.state,u==null?void 0:u.name]),j.useEffect(()=>{var we;(we=ae.current)==null||we.scrollIntoView({behavior:"smooth"})},[x,F]);const te=()=>{let we=`Hello ${(u==null?void 0:u.name)||"there"}!  I'm your AI health assistant.

`;return D&&D.length>0?(we+=`I've reviewed your uploaded health reports:

`,D.slice(0,3).forEach(re=>{const oe=new Date(re.uploadDate).toLocaleDateString();if(we+=` **${re.reportType}** (${oe})
`,re.analysis&&(we+=`   ${re.analysis.substring(0,100)}...
`),re.metrics&&Object.keys(re.metrics).length>0){const J=Object.keys(re.metrics).slice(0,2);we+=`   Key metrics: ${J.join(", ")}
`}we+=`
`}),we+=`I have a complete understanding of your health profile. Feel free to ask me about your reports, health concerns, or get personalized recommendations!

What would you like to know?`):we+="I can help you understand your health reports, explain medical terms, provide diet guidance, and answer health-related questions. What would you like to know?",we},ie=(we,re)=>{G(!0),k("");let oe=0;const J=setInterval(()=>{oe<=we.length?(k(we.substring(0,oe)),oe++):(clearInterval(J),G(!1),re())},15);return()=>clearInterval(J)},ue=async we=>{try{const re=localStorage.getItem("token"),oe=we.slice(-2);await fetch("/api/chat/history",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${re}`},body:JSON.stringify({messages:oe})}),localStorage.setItem(`chat_history_${u==null?void 0:u.id}`,JSON.stringify(we))}catch(re){console.error("Failed to save chat to backend:",re),localStorage.setItem(`chat_history_${u==null?void 0:u.id}`,JSON.stringify(we))}},Ne=async()=>{if(confirm("Are you sure you want to clear the chat history?"))try{const we=localStorage.getItem("token");await fetch("/api/chat/history",{method:"DELETE",headers:{Authorization:`Bearer ${we}`}}),localStorage.removeItem(`chat_history_${u==null?void 0:u.id}`);const re=te();_([{role:"assistant",content:re,timestamp:new Date}]),Ve.success("Chat cleared")}catch(we){console.error("Failed to clear chat:",we),localStorage.removeItem(`chat_history_${u==null?void 0:u.id}`);const re=te();_([{role:"assistant",content:re,timestamp:new Date}]),Ve.error("Chat cleared locally")}},be=()=>{const we=te();_([{role:"assistant",content:we,timestamp:new Date}]),ne(!1),Ve.success("New chat started")},Q=async we=>{if(we.preventDefault(),!E.trim()||R)return;const re={role:"user",content:E,timestamp:new Date};_(J=>[...J,re]);const oe=E;y(""),P(!0);try{const J=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:oe,conversationHistory:x.slice(-10),userReports:D.map($e=>({type:$e.reportType,date:$e.uploadDate,analysis:$e.analysis,metrics:$e.metrics}))})});if(!J.ok)throw new Error("Failed to get AI response");const Oe=await J.json();Oe.success&&Oe.response&&ie(Oe.response,()=>{const $e={role:"assistant",content:Oe.response,timestamp:new Date},He=[...x,re,$e];_(He),k(""),ue(He)})}catch(J){console.error("AI Chat error:",J),Ve.error("Failed to get response");const Oe=pe(oe);ie(Oe,()=>{const $e={role:"assistant",content:Oe,timestamp:new Date},He=[...x,re,$e];_(He),k(""),ue(He)})}finally{P(!1)}},pe=we=>{const re=we.toLowerCase();return re.includes("vitamin d")?`Based on your query about Vitamin D:

**What is Vitamin D?**
Vitamin D is essential for bone health, immune function, and overall wellbeing.

**Normal Range:** 30-100 ng/mL

**If Low:**
 Get 15-20 minutes of morning sunlight daily
 Eat fish, eggs, fortified milk
 Consider supplements (consult your doctor)`:re.includes("iron")||re.includes("hemoglobin")?`Regarding Iron and Hemoglobin:

**Importance:**
Iron is crucial for producing hemoglobin, which carries oxygen in your blood.

**Normal Hemoglobin:** 12-17 g/dL
**Normal Iron:** 60-170 mcg/dL

**To Increase Iron:**
 Red meat, spinach, dal
 Eat with Vitamin C foods
 Avoid tea/coffee with meals`:"Thank you for your question. I'm here to help with understanding your health reports, explaining medical terms, providing diet guidance, and answering health-related questions."},he=(we,re)=>{navigator.clipboard.writeText(we),q(re),setTimeout(()=>q(null),2e3),Ve.success("Copied to clipboard")};return a.jsxs("div",{className:"w-full h-full bg-white flex flex-col md:flex-row",children:[a.jsxs("div",{className:"md:hidden fixed top-0 left-0 right-0 z-30 bg-white border-b border-gray-200 px-4 py-2.5 flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold shadow-md flex-shrink-0",children:((fe=(Ae=u==null?void 0:u.name)==null?void 0:Ae[0])==null?void 0:fe.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const we=new Date().getHours();return we<12?"Good Morning":we<18?"Good Afternoon":"Good Evening"})(),", ",((le=u==null?void 0:u.name)==null?void 0:le.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-8 h-8 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all border border-gray-200 flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),B&&a.jsx("div",{className:"fixed inset-0 bg-black/30 z-40 md:hidden",onClick:()=>ne(!1)}),a.jsxs("div",{className:`fixed md:static left-0 top-0 h-full w-64 bg-white border-r border-gray-200 flex flex-col transition-transform duration-300 z-50 md:z-auto ${B?"translate-x-0":"-translate-x-full md:translate-x-0"} md:translate-x-0 shrink-0`,children:[a.jsxs("div",{className:"p-3 border-b border-gray-200 flex items-center justify-between shrink-0",children:[a.jsx("h2",{className:"font-bold text-gray-900 text-xs",children:"Chat History"}),a.jsx("button",{onClick:()=>ne(!1),className:"p-1 hover:bg-gray-100 rounded md:hidden",children:a.jsx(ra,{className:"w-4 h-4"})})]}),a.jsx("button",{onClick:be,className:"m-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 font-medium text-xs shrink-0",children:"+ New Chat"}),a.jsx("div",{className:"flex-1 overflow-y-auto px-2 space-y-1",children:a.jsxs("div",{className:"p-3 text-center",children:[a.jsx("p",{className:"text-xs text-gray-500",children:"Chat history is saved automatically"}),a.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[x.length," messages in current chat"]})]})}),a.jsx("div",{className:"p-2 border-t border-gray-200 space-y-1 shrink-0",children:a.jsxs("button",{onClick:Ne,className:"w-full px-2 py-1.5 text-xs text-red-600 hover:bg-red-50 rounded-lg transition flex items-center justify-center gap-2",children:[a.jsx(Bd,{className:"w-3 h-3"}),"Clear Chat"]})})]}),a.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[a.jsx("div",{className:"flex items-center px-3 py-2 border-b border-gray-200 bg-white shrink-0 mt-16 md:mt-0",children:a.jsx("button",{onClick:()=>ne(!B),className:"p-1.5 hover:bg-gray-100 rounded-lg transition md:hidden",title:"Toggle chat history",children:a.jsx(d2,{className:"w-5 h-5 text-gray-700"})})}),a.jsxs("div",{ref:Z,className:"flex-1 overflow-y-auto px-3 py-4 space-y-3 pb-24 md:pb-4",style:{userSelect:"text"},children:[x.map((we,re)=>a.jsxs("div",{className:`flex gap-2 ${we.role==="user"?"justify-end":"justify-start"}`,children:[we.role==="assistant"&&a.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center shrink-0 bg-blue-600",children:a.jsx(Xv,{className:"w-4 h-4 text-white"})}),a.jsxs("div",{className:`max-w-xs md:max-w-md rounded-2xl px-3 py-2 ${we.role==="user"?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"}`,children:[a.jsx("div",{className:"whitespace-pre-wrap break-words text-sm leading-relaxed",children:we.content}),a.jsxs("div",{className:"flex items-center justify-between mt-1 gap-2",children:[a.jsx("span",{className:`text-xs ${we.role==="user"?"text-blue-100":"text-gray-500"}`,children:we.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),we.role==="assistant"&&a.jsx("button",{onClick:()=>he(we.content,re),className:"transition-colors p-0.5 rounded hover:bg-gray-200",title:"Copy response",children:X===re?a.jsx(cc,{className:"w-3 h-3 text-green-500"}):a.jsx(fq,{className:"w-3 h-3 text-gray-500"})})]})]}),we.role==="user"&&a.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center shrink-0 bg-gray-300",children:a.jsx($i,{className:"w-4 h-4 text-gray-700"})})]},re)),U&&F&&a.jsxs("div",{className:"flex gap-2 justify-start",children:[a.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center shrink-0 bg-blue-600",children:a.jsx(Xv,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"max-w-xs md:max-w-md bg-gray-100 rounded-2xl px-3 py-2",children:a.jsxs("div",{className:"whitespace-pre-wrap break-words text-sm leading-relaxed text-gray-900",children:[F,a.jsx("span",{className:"inline-block w-1 h-3 ml-1 animate-pulse bg-blue-600"})]})})]}),R&&!U&&a.jsxs("div",{className:"flex gap-2 justify-start",children:[a.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center shrink-0 bg-blue-600",children:a.jsx(Xv,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"bg-gray-100 rounded-2xl px-3 py-2",children:a.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[a.jsx(uc,{className:"w-3 h-3 animate-spin text-blue-600"}),a.jsx("span",{className:"text-xs",children:"Analyzing..."})]})})]}),a.jsx("div",{ref:ae})]}),a.jsx("div",{className:"fixed md:relative bottom-0 left-0 right-0 md:bottom-auto border-t border-gray-200 bg-white p-3 shrink-0 md:w-auto",children:a.jsxs("form",{onSubmit:Q,className:"flex gap-2 items-end",children:[a.jsxs("div",{className:"flex-1 relative",children:[a.jsx("input",{type:"text",value:E,onChange:we=>y(we.target.value),placeholder:"Ask...",className:"w-full px-3 py-2.5 bg-gray-50 rounded-2xl focus:outline-none transition-all text-sm border border-gray-200 focus:border-blue-500 focus:bg-white",disabled:R||U}),E&&a.jsx("button",{type:"button",onClick:()=>y(""),className:"absolute right-2 top-1/2 -translate-y-1/2 text-lg hover:opacity-70 transition-opacity text-gray-500",children:""})]}),a.jsx("button",{type:"submit",disabled:!E.trim()||R||U,className:"px-3 py-2.5 text-white rounded-2xl font-medium hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 flex-shrink-0 bg-blue-600 hover:bg-blue-700",title:E.trim()?"Send message":"Type a message first",children:R||U?a.jsx(uc,{className:"w-4 h-4 animate-spin"}):a.jsx(Uh,{className:"w-4 h-4"})})]})})]})]})}function XZ(){var mn,hs,ze,It,wt,ft,Os,Kn;const{user:u}=ia(),{invalidateCache:f}=vL(),x=Ga(),[_,E]=j.useState(!1),[y,R]=j.useState(!0),[P,U]=j.useState([]),[G,F]=j.useState(null),[k,X]=j.useState(null),[q,D]=j.useState(!1),[H,B]=j.useState(""),[ne,ae]=j.useState(0),[Z,te]=j.useState(null),[ie,ue]=j.useState(""),[Ne,be]=j.useState(""),[Q,pe]=j.useState(!1),[he,Ae]=j.useState(null),[fe,le]=j.useState(""),[we,re]=j.useState(""),[oe,J]=j.useState(""),[Oe,$e]=j.useState(""),[He,ot]=j.useState(null),[_t,Ke]=j.useState([]),[ht,st]=j.useState(""),ct=Ye=>{const Pt=Ye.toLowerCase();return Pt.includes("roti")||Pt.includes("naan")||Pt.includes("paratha")?["1 pc","2 pcs","3 pcs","4 pcs"]:Pt.includes("rice")||Pt.includes("biryani")||Pt.includes("khichdi")?["1 bowl","1 plate","1 cup","2 cups"]:Pt.includes("samosa")||Pt.includes("pakora")||Pt.includes("momos")?["1 pc","2 pcs","3 pcs","5 pcs"]:Pt.includes("idli")||Pt.includes("dosa")||Pt.includes("vada")?["1 pc","2 pcs","3 pcs","1 plate"]:Pt.includes("pizza")||Pt.includes("burger")?["1 slice","2 slices","1 whole","1 med"]:Pt.includes("chicken")||Pt.includes("paneer")||Pt.includes("tikka")?["1 bowl","1 plate","150g","200g"]:["1 bowl","1 plate","1 piece","100g","150g"]},[fs,ys]=j.useState([]);j.useEffect(()=>{As()},[]);const As=async()=>{E(!0);try{const Pt={Authorization:`Bearer ${localStorage.getItem("token")}`},oa=new Date().toISOString().split("T")[0],[Js,En,Ln]=await Promise.all([ks.get("/api/nutrition/logs/today",{headers:Pt}),ks.get(`/api/nutrition/summary/daily?date=${oa}`,{headers:Pt}),ks.get("/api/nutrition/goals",{headers:Pt}).catch(()=>({data:{healthGoal:null}}))]);U(Js.data.foodLogs||[]),F(En.data.summary),X(Ln.data.healthGoal);const ln=localStorage.getItem(`waterIntake_${oa}`);ae(ln?parseInt(ln):0),R(!1)}catch(Ye){console.error("Failed to fetch data:",Ye),Ve.error("Failed to load nutrition data"),R(!1)}finally{E(!1)}},zs=()=>{const Ye=new Date().toISOString().split("T")[0],Pt=ne+1;ae(Pt),localStorage.setItem(`waterIntake_${Ye}`,Pt),Ve.success("Water added! ")},je=Ye=>{if(!k){Ve.error("Please set your fitness goal first"),x("/profile?tab=goals");return}B(Ye),D(!0),te(null),ue(""),be(""),pe(!1),Ae(null),le(""),re(""),J(""),$e(""),ot(null)},Ze=Ye=>{var Pt,oa,Js,En,Ln,ln,ca,yr,rr,Bn,gl,Hh,To,eu;te(Ye),B(Ye.mealType),ue(((oa=(Pt=Ye.foodItems)==null?void 0:Pt[0])==null?void 0:oa.name)||""),be(""),Ae({calories:((Js=Ye.totalNutrition)==null?void 0:Js.calories)||0,protein:((En=Ye.totalNutrition)==null?void 0:En.protein)||0,carbs:((Ln=Ye.totalNutrition)==null?void 0:Ln.carbs)||0,fats:((ln=Ye.totalNutrition)==null?void 0:ln.fats)||0}),le(((yr=(ca=Ye.totalNutrition)==null?void 0:ca.calories)==null?void 0:yr.toString())||""),re(((Bn=(rr=Ye.totalNutrition)==null?void 0:rr.protein)==null?void 0:Bn.toString())||""),J(((Hh=(gl=Ye.totalNutrition)==null?void 0:gl.carbs)==null?void 0:Hh.toString())||""),$e(((eu=(To=Ye.totalNutrition)==null?void 0:To.fats)==null?void 0:eu.toString())||""),D(!0)},Ct=async()=>{var Ye,Pt,oa,Js,En;if(!ie.trim()||!Ne.trim()){Ve.error("Please enter food name and quantity");return}pe(!0);try{const Ln=localStorage.getItem("token"),ln=await ks.post("/api/nutrition/quick-check",{foodDescription:`${Ne} ${ie} ${ht}`},{headers:{Authorization:`Bearer ${Ln}`}});if(ln.data.success&&((Ye=ln.data.data)!=null&&Ye.foodItem)){const ca=ln.data.data.foodItem.nutrition;ot(ln.data.data),Ae(ca),le(((Pt=ca.calories)==null?void 0:Pt.toString())||"0"),re(((oa=ca.protein)==null?void 0:oa.toString())||"0"),J(((Js=ca.carbs)==null?void 0:Js.toString())||"0"),$e(((En=ca.fats)==null?void 0:En.toString())||"0"),Ve.success("Food analyzed! ")}else Ve.error("Could not analyze food")}catch(Ln){console.error("Analysis error:",Ln),Ve.error("Failed to analyze food")}finally{pe(!1)}},zt=async()=>{if(!ie.trim()||!he){Ve.error("Please analyze food first");return}try{const Ye=localStorage.getItem("token");Z?(await ks.put(`/api/nutrition/logs/${Z._id}`,{foodItems:[{name:`${Ne} ${ie}`,nutrition:{calories:parseFloat(fe)||0,protein:parseFloat(we)||0,carbs:parseFloat(oe)||0,fats:parseFloat(Oe)||0}}]},{headers:{Authorization:`Bearer ${Ye}`}}),Ve.success("Meal updated!")):(await ks.post("/api/nutrition/log-meal",{mealType:H,foodItems:[{name:`${Ne} ${ie}`,nutrition:{calories:parseFloat(fe)||0,protein:parseFloat(we)||0,carbs:parseFloat(oe)||0,fats:parseFloat(Oe)||0}}]},{headers:{Authorization:`Bearer ${Ye}`}}),Ve.success("Meal logged!")),D(!1),f(["dashboard"]),As()}catch(Ye){console.error("Log meal error:",Ye),Ve.error("Failed to log meal")}},ts=async Ye=>{if(confirm("Delete this meal?"))try{const Pt=localStorage.getItem("token");await ks.delete(`/api/nutrition/logs/${Ye}`,{headers:{Authorization:`Bearer ${Pt}`}}),Ve.success("Meal deleted"),f(["dashboard"]),As()}catch(Pt){console.error("Delete error:",Pt),Ve.error("Failed to delete meal")}},ge=Ye=>({breakfast:"",lunch:"",snack:"",dinner:""})[Ye]||"";if(y&&_)return a.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:a.jsx(uc,{className:"w-8 h-8 animate-spin text-purple-500"})});const We=((k==null?void 0:k.dailyCalorieTarget)||2e3)-((G==null?void 0:G.totalCalories)||0),rt=(G==null?void 0:G.totalCalories)||0,ws=(k==null?void 0:k.dailyCalorieTarget)||2e3,Cn=Math.min(rt/ws*100,100),Fe=(G==null?void 0:G.totalProtein)||0,Je=((mn=k==null?void 0:k.macroTargets)==null?void 0:mn.protein)||150,De=Math.min(Fe/Je*100,100),it=(G==null?void 0:G.totalCarbs)||0,gs=((hs=k==null?void 0:k.macroTargets)==null?void 0:hs.carbs)||250,Gt=Math.min(it/gs*100,100),Ss=(G==null?void 0:G.totalFats)||0,pn=((ze=k==null?void 0:k.macroTargets)==null?void 0:ze.fats)||80,Zn=Math.min(Ss/pn*100,100),tn=8;return a.jsxs("div",{className:"w-full min-h-screen pb-24",children:[a.jsxs("div",{className:"w-full max-w-2xl mx-auto px-4 py-6 space-y-6",children:[a.jsxs("div",{className:"md:hidden flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-md flex-shrink-0",children:((wt=(It=u==null?void 0:u.name)==null?void 0:It[0])==null?void 0:wt.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const Ye=new Date().getHours();return Ye<12?"Good Morning":Ye<18?"Good Afternoon":"Good Evening"})(),", ",((ft=u==null?void 0:u.name)==null?void 0:ft.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),a.jsxs("div",{className:"card card-gradient p-8 text-slate-800 shadow-2xl relative overflow-hidden ring-1 ring-white/50 border-none",children:[a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white/20 rounded-full blur-3xl -mr-20 -mt-20"}),a.jsxs("div",{className:"flex items-start justify-between mb-8 relative z-10",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-slate-600 mb-2",children:"Calories Remaining"}),a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-6xl font-black tracking-tighter text-slate-900",children:Math.max(We,0).toLocaleString()}),a.jsx("span",{className:"text-slate-500 font-bold text-lg",children:"kcal"})]})]}),a.jsx("div",{className:"w-16 h-16 rounded-[1.5rem] bg-white/40 backdrop-blur-md flex items-center justify-center border border-white/50 shadow-inner group transition-transform duration-500 hover:rotate-6",children:a.jsx(qi,{className:"w-8 h-8 text-orange-500 drop-shadow-md"})})]}),a.jsxs("div",{className:"flex items-center justify-between text-[10px] font-black uppercase tracking-widest text-slate-500 mb-4 px-1",children:[a.jsxs("span",{children:["GOAL: ",ws]}),a.jsxs("span",{className:"text-purple-600",children:["CONSUMED: ",rt]})]}),a.jsx("div",{className:"relative h-4 bg-white/30 rounded-full overflow-hidden mb-8 border border-white/50",children:a.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-purple-500 via-indigo-500 to-blue-500 rounded-full transition-all duration-1000 ease-out shadow-[0_0_20px_rgba(139,92,246,0.3)]",style:{width:`${Cn}%`}})}),a.jsx("div",{className:"grid grid-cols-3 gap-6 relative z-10",children:[{label:"Prot",value:Math.round(Fe),goal:Je,color:"from-blue-400 to-blue-600",text:"text-blue-600",bg:"bg-blue-50/50",iconSize:"w-2 h-2",percentage:De},{label:"Carbs",value:Math.round(it),goal:gs,color:"from-emerald-400 to-emerald-600",text:"text-emerald-600",bg:"bg-emerald-50/50",iconSize:"w-2 h-2",percentage:Gt},{label:"Fat",value:Math.round(Ss),goal:pn,color:"from-amber-400 to-amber-600",text:"text-amber-600",bg:"bg-amber-50/50",iconSize:"w-2 h-2",percentage:Zn}].map(Ye=>a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center gap-2 px-1",children:[a.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${Ye.text.replace("text-","bg-")}`}),a.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-slate-400",children:Ye.label})]}),a.jsxs("div",{className:`${Ye.bg} backdrop-blur-md p-3 rounded-2xl border border-white/50 shadow-inner`,children:[a.jsxs("p",{className:"text-xl font-black text-slate-800 tracking-tight",children:[Ye.value,a.jsx("span",{className:"text-[10px] ml-0.5",children:"g"})]}),a.jsx("div",{className:"w-full h-1.5 bg-white/40 rounded-full mt-2 overflow-hidden",children:a.jsx("div",{className:`h-full bg-gradient-to-r ${Ye.color} rounded-full transition-all duration-700`,style:{width:`${Ye.percentage}%`}})})]})]},Ye.label))})]}),a.jsxs("div",{className:"card p-6 border-none shadow-xl",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-14 h-14 rounded-2xl bg-blue-50/50 backdrop-blur-md flex items-center justify-center border border-blue-100 shadow-inner",children:a.jsx(Dh,{className:"w-7 h-7 text-blue-500 drop-shadow-sm"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-black text-slate-800 tracking-tight",children:"HYDRATION"}),a.jsxs("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:[ne," of ",tn," glasses"]})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("p",{className:"text-4xl font-black text-blue-600 tracking-tighter",children:ne}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] -mt-1",children:"Glasses"})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2.5 mb-6",children:[Array.from({length:tn}).map((Ye,Pt)=>a.jsx("button",{onClick:zs,className:`w-10 h-11 rounded-xl flex items-center justify-center transition-all transform hover:scale-110 active:scale-95 border-2 ${Pt<ne?"bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200":"bg-white/40 border-slate-100 text-slate-400 hover:border-blue-200"}`,children:a.jsx(Dh,{className:`w-5 h-5 ${Pt<ne?"animate-bounce":""}`})},Pt)),a.jsx("button",{onClick:zs,className:"w-10 h-11 rounded-xl flex items-center justify-center bg-slate-50 border-2 border-dashed border-slate-200 text-slate-400 hover:border-blue-300 hover:bg-white transition-all transition-all",children:a.jsx(vi,{className:"w-5 h-5"})})]}),a.jsx("div",{className:"w-full h-1.5 bg-slate-100 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-1000 ease-out",style:{width:`${ne/tn*100}%`}})})]}),a.jsx("div",{className:"space-y-4",children:["breakfast","lunch","snack","dinner"].map(Ye=>{const Pt=P.filter(Js=>Js.mealType===Ye),oa=Pt.reduce((Js,En)=>{var Ln;return Js+(((Ln=En.totalNutrition)==null?void 0:Ln.calories)||0)},0);return a.jsxs("div",{className:"card p-6 border-none shadow-xl",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"w-14 h-14 rounded-2xl bg-white/40 backdrop-blur-md flex items-center justify-center border border-white/50 shadow-inner text-3xl",children:ge(Ye)}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-black text-slate-800 tracking-tight uppercase",children:Ye}),a.jsxs("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:[Pt.length," items  ",a.jsxs("span",{className:"text-purple-600",children:[oa," kcal"]})]})]})]}),a.jsx("button",{onClick:()=>je(Ye),className:"w-12 h-12 rounded-[1.25rem] bg-slate-900 text-white flex items-center justify-center hover:bg-slate-800 transition-all shadow-xl hover:scale-110 active:scale-95 group",children:a.jsx(vi,{className:"w-6 h-6 group-hover:rotate-90 transition-transform duration-300"})})]}),Pt.length>0&&a.jsx("div",{className:"space-y-3",children:Pt.map(Js=>{var En,Ln,ln,ca,yr,rr;return a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-2xl",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-semibold text-slate-800",children:((Ln=(En=Js.foodItems)==null?void 0:En[0])==null?void 0:Ln.name)||"Food"}),a.jsxs("div",{className:"flex items-center gap-4 mt-1 text-xs text-slate-500",children:[a.jsxs("span",{children:["P: ",Math.round(((ln=Js.totalNutrition)==null?void 0:ln.protein)||0),"g"]}),a.jsxs("span",{children:["C: ",Math.round(((ca=Js.totalNutrition)==null?void 0:ca.carbs)||0),"g"]}),a.jsxs("span",{children:["F: ",Math.round(((yr=Js.totalNutrition)==null?void 0:yr.fats)||0),"g"]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"font-bold text-slate-800",children:Math.round(((rr=Js.totalNutrition)==null?void 0:rr.calories)||0)}),a.jsx("span",{className:"text-xs text-slate-500",children:"kcal"}),a.jsx("button",{onClick:()=>Ze(Js),className:"p-2 hover:bg-gray-200 rounded-lg transition-all ml-2",children:a.jsx(m2,{className:"w-4 h-4 text-slate-600"})}),a.jsx("button",{onClick:()=>ts(Js._id),className:"p-2 hover:bg-red-100 rounded-lg transition-all",children:a.jsx(Bd,{className:"w-4 h-4 text-red-500"})})]})]},Js._id)})})]},Ye)})})]}),q&&a.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-end md:items-center md:justify-center",onClick:()=>D(!1),children:a.jsxs("div",{className:"bg-white w-full md:w-full md:max-w-lg rounded-t-3xl md:rounded-3xl p-6 max-h-[85vh] overflow-y-auto",onClick:Ye=>Ye.stopPropagation(),children:[a.jsxs("div",{className:"flex items-center justify-between mb-8",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center",children:a.jsx(Utensils,{className:"w-5 h-5 text-purple-600"})}),a.jsxs("div",{children:[a.jsxs("h2",{className:"text-xl font-black text-slate-800 tracking-tight",children:[Z?"Edit":"Add"," ",H.charAt(0).toUpperCase()+H.slice(1)]}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mt-0.5",children:"Track your nutrition"})]})]}),a.jsx("button",{onClick:()=>D(!1),className:"w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all",children:a.jsx(ra,{className:"w-5 h-5"})})]}),a.jsx("div",{className:"space-y-4",children:he?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"space-y-6 animate-in slide-in-from-bottom-4 duration-500",children:a.jsxs("div",{className:"bg-white rounded-[2.5rem] p-8 border border-slate-100 shadow-[0_20px_50px_rgba(0,0,0,0.05)] relative overflow-hidden",children:[a.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/5 to-blue-500/5 rounded-bl-full pointer-events-none"}),a.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-6 mb-8 relative z-10",children:[a.jsxs("div",{className:"relative w-24 h-24 flex-shrink-0",children:[a.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[a.jsx("circle",{cx:"48",cy:"48",r:"42",stroke:"#f1f5f9",strokeWidth:"8",fill:"none"}),a.jsx("circle",{cx:"48",cy:"48",r:"42",stroke:(He==null?void 0:He.healthScore10)>=7?"#10b981":(He==null?void 0:He.healthScore10)>=4?"#f59e0b":"#ef4444",strokeWidth:"8",fill:"none",strokeDasharray:264,strokeDashoffset:264-((He==null?void 0:He.healthScore10)||(He==null?void 0:He.healthScore)/10)*26.4,strokeLinecap:"round",className:"transition-all duration-1000 ease-out"})]}),a.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[a.jsx("span",{className:"text-2xl font-black text-slate-800",children:(He==null?void 0:He.healthScore10)||((He==null?void 0:He.healthScore)/10).toFixed(1)}),a.jsx("span",{className:"text-[8px] font-black text-slate-400 tracking-widest uppercase",children:"SCORE"})]})]}),a.jsxs("div",{className:"text-center sm:text-left flex-1 min-w-0",children:[a.jsx("h3",{className:"text-2xl font-black text-slate-800 mb-2 truncate",title:ie,children:ie}),a.jsxs("div",{className:"flex items-center justify-center sm:justify-start gap-2",children:[a.jsx("span",{className:"px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-black rounded-lg uppercase tracking-wider shadow-sm",children:Ne}),a.jsx("div",{className:`px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider shadow-sm ${(He==null?void 0:He.healthScore10)>=7?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:(He==null?void 0:He.healthScore10)>=7?"Optimal":"Moderate"})]})]})]}),a.jsx("div",{className:"grid grid-cols-4 gap-3 mb-8 relative z-10",children:[{label:"Kcal",value:Math.round(he.calories),color:"text-orange-600",bg:"bg-orange-50",border:"border-orange-100"},{label:"Prot",value:Math.round(he.protein),color:"text-blue-600",bg:"bg-blue-50",border:"border-blue-100"},{label:"Carbs",value:Math.round(he.carbs),color:"text-emerald-600",bg:"bg-emerald-50",border:"border-emerald-100"},{label:"Fats",value:Math.round(he.fats),color:"text-rose-600",bg:"bg-rose-50",border:"border-rose-100"}].map(Ye=>a.jsxs("div",{className:`${Ye.bg} ${Ye.border} border rounded-2xl p-3 text-center shadow-sm transition-transform hover:-translate-y-1 group`,children:[a.jsx("p",{className:"text-lg font-black text-slate-800 leading-none mb-1 group-hover:scale-110 transition-transform origin-bottom",children:Ye.value}),a.jsx("p",{className:`text-[9px] font-black uppercase tracking-tighter ${Ye.color}`,children:Ye.label})]},Ye.label))}),a.jsxs("div",{className:"space-y-6 relative z-10",children:[a.jsxs("div",{className:"bg-gradient-to-br from-slate-50 to-white rounded-[1.5rem] p-5 border border-slate-100 shadow-inner group",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx(Brain,{className:"w-4 h-4 text-purple-500 group-hover:rotate-12 transition-transform"}),a.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:"Medical Analysis"})]}),a.jsxs("p",{className:"text-xs font-semibold text-slate-600 leading-relaxed italic",children:['"',He==null?void 0:He.analysis,'"']})]}),a.jsxs("div",{className:"grid gap-4",children:[((Os=He==null?void 0:He.enhancementTips)==null?void 0:Os.length)>0&&a.jsxs("div",{className:"space-y-3",children:[a.jsxs("h4",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 px-1",children:[a.jsx(Sparkles,{className:"w-3 h-3 text-emerald-500"}),"Boost Nutrition"]}),a.jsx("div",{className:"space-y-2",children:He.enhancementTips.map((Ye,Pt)=>a.jsxs("div",{className:"px-4 py-3 bg-emerald-50/50 border border-emerald-100/50 rounded-2xl flex items-center gap-3",children:[a.jsx("div",{className:"w-5 h-5 rounded-lg bg-emerald-100 flex items-center justify-center shrink-0",children:a.jsx(vi,{className:"w-3 h-3 text-emerald-600"})}),a.jsx("p",{className:"text-[10px] font-bold text-emerald-900 leading-tight pt-0.5",children:Ye})]},Pt))})]}),((Kn=He==null?void 0:He.micronutrients)==null?void 0:Kn.length)>0&&a.jsxs("div",{className:"space-y-3",children:[a.jsxs("h4",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 px-1",children:[a.jsx(ms,{className:"w-3 h-3 text-blue-500"}),"Essential Nutrients"]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:He.micronutrients.map((Ye,Pt)=>a.jsxs("div",{className:"px-3 py-2 bg-blue-50 border border-blue-100 rounded-xl flex items-center gap-1.5 shadow-sm",children:[a.jsx(CheckCircle,{className:"w-3 h-3 text-blue-500"}),a.jsx("span",{className:"text-[10px] font-black text-blue-800 uppercase tracking-widest",children:Ye})]},Pt))})]})]})]})]})}),a.jsxs("div",{className:"flex gap-4 pt-4",children:[a.jsx("button",{onClick:()=>{Ae(null),be("")},className:"flex-1 py-5 bg-slate-100 text-slate-600 rounded-[2rem] font-black text-sm uppercase tracking-widest hover:bg-slate-200 transition-all active:scale-95",children:"Back"}),a.jsxs("button",{onClick:zt,className:"flex-[2] py-5 bg-slate-900 text-white rounded-[2rem] font-black text-sm uppercase tracking-widest shadow-2xl hover:bg-slate-800 transition-all active:scale-95 flex items-center justify-center gap-3 group relative overflow-hidden",children:[a.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1 bg-white/20 transform translate-y-2 group-hover:translate-y-0 transition-transform"}),a.jsxs("div",{className:"relative z-10 flex items-center gap-3",children:[a.jsx(CheckCircle,{className:"w-5 h-5 text-emerald-400 group-hover:scale-110 transition-transform"}),Z?"Update Meal":"Add to Diary"]})]})]})]}):a.jsx(a.Fragment,{children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 ml-1",children:"Food Name"}),a.jsx("input",{type:"text",value:ie,onChange:Ye=>{ue(Ye.target.value),ys(ct(Ye.target.value))},placeholder:"e.g., Chicken Salad",className:"w-full px-5 py-4 bg-slate-50/80 border-2 border-slate-100 rounded-[1.5rem] focus:border-purple-500 focus:bg-white focus:outline-none text-slate-900 font-bold transition-all placeholder:text-slate-400 shadow-inner",onKeyPress:Ye=>Ye.key==="Enter"&&Ct()})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1",children:"Quantity"}),a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:fs.map((Ye,Pt)=>a.jsx("button",{type:"button",onClick:()=>be(Ye),className:`px-3 py-2 rounded-xl text-[11px] font-bold transition-all border-2 ${Ne===Ye?"bg-purple-600 border-purple-600 text-white shadow-lg shadow-purple-200":"bg-white border-slate-100 text-slate-600 hover:border-purple-200"}`,children:Ye},Pt))}),a.jsx("input",{type:"text",value:Ne,onChange:Ye=>be(Ye.target.value),placeholder:"e.g., 1 bowl, 100g",className:"w-full px-5 py-3.5 bg-slate-50/80 border-2 border-slate-100 rounded-[1.5rem] focus:border-purple-500 focus:bg-white focus:outline-none text-slate-900 font-bold transition-all placeholder:text-slate-400 shadow-inner",onKeyPress:Ye=>Ye.key==="Enter"&&Ct()})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1",children:"Preparation"}),a.jsx("div",{className:"grid grid-cols-3 gap-2",children:[{label:"Fried",icon:""},{label:"Baked",icon:""},{label:"Grilled",icon:""},{label:"Home",icon:""},{label:"Dine-in",icon:""},{label:"Packaged",icon:""}].map(Ye=>a.jsxs("button",{type:"button",onClick:()=>st(Ye.label),className:`p-2.5 rounded-xl transition-all border-2 flex flex-col items-center gap-1.5 ${ht===Ye.label?"bg-purple-600 border-purple-600 text-white shadow-lg shadow-purple-200":"bg-white border-slate-100 text-slate-600 hover:border-purple-200"}`,children:[a.jsx("span",{className:"text-lg leading-none",children:Ye.icon}),a.jsx("span",{className:"text-[9px] font-black uppercase tracking-tighter",children:Ye.label})]},Ye.label))})]}),a.jsxs("button",{onClick:Ct,disabled:Q||!ie.trim()||!Ne.trim(),className:"w-full bg-slate-900 text-white font-black py-5 rounded-[2rem] hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 transition-all shadow-[0_20px_40px_-12px_rgba(15,23,42,0.3)] uppercase tracking-widest text-sm relative overflow-hidden group active:scale-[0.98]",children:[a.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1 bg-white/20 transform translate-y-2 group-hover:translate-y-0 transition-transform"}),a.jsx("div",{className:"relative z-10 flex items-center gap-3",children:Q?a.jsxs(a.Fragment,{children:[a.jsx(uc,{className:"w-5 h-5 animate-spin text-purple-400"}),"Analyzing..."]}):a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:"w-5 h-5 text-purple-400 group-hover:animate-pulse"}),"Calculate Nutrition"]})})]})]})})})]})})]})}const JZ=()=>a.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 sm:p-6 animate-pulse",children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("div",{className:"h-8 bg-slate-700/50 rounded w-48 mb-2"}),a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-64"})]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[1,2,3,4,5,6].map(u=>a.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-5 border border-slate-700/50",children:[a.jsxs("div",{className:"flex items-start justify-between mb-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"h-5 bg-slate-700/50 rounded w-32 mb-2"}),a.jsx("div",{className:"h-4 bg-slate-700/50 rounded w-24"})]}),a.jsx("div",{className:"w-10 h-10 bg-slate-700/50 rounded-lg"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("div",{className:"h-3 bg-slate-700/50 rounded w-full"}),a.jsx("div",{className:"h-3 bg-slate-700/50 rounded w-3/4"})]}),a.jsx("div",{className:"mt-4 h-9 bg-slate-700/50 rounded-lg"})]},u))})]});function $Z(){var k,X,q;const{user:u}=ia(),[f,x]=j.useState([]),[_,E]=j.useState(!0),[y,R]=j.useState("all");j.useEffect(()=>{window.scrollTo(0,0),P()},[]);const P=async()=>{try{const{data:D}=await qr.getReports();x(D)}catch{Ve.error("Failed to load reports")}finally{E(!1)}},U=async(D,H)=>{if(H.preventDefault(),H.stopPropagation(),!!window.confirm("Are you sure you want to delete this report? This action cannot be undone."))try{await qr.deleteReport(D),x(f.filter(B=>B._id!==D)),Ve.success("Report deleted successfully")}catch{Ve.error("Failed to delete report")}},G=y==="all"?f:f.filter(D=>D.reportType.toLowerCase().includes(y.toLowerCase())),F=["all",...new Set(f.map(D=>D.reportType))];return _?a.jsx(JZ,{}):a.jsxs("div",{className:"max-w-6xl mx-auto space-y-8 animate-fade-in p-6 pb-24",children:[a.jsxs("div",{className:"md:hidden flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-md flex-shrink-0",children:((X=(k=u==null?void 0:u.name)==null?void 0:k[0])==null?void 0:X.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const D=new Date().getHours();return D<12?"Good Morning":D<18?"Good Afternoon":"Good Evening"})(),", ",((q=u==null?void 0:u.name)==null?void 0:q.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),a.jsxs("div",{className:"card card-gradient p-8 text-slate-800 shadow-2xl relative overflow-hidden ring-1 ring-white/50 border-none",children:[a.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-white/20 rounded-full blur-3xl -mr-20 -mt-20"}),a.jsxs("div",{className:"relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6",children:[a.jsxs("div",{children:[a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-500 hover:text-purple-600 font-black transition-all mb-4 text-[10px] uppercase tracking-widest group",children:[a.jsx("div",{className:"p-1.5 bg-white/50 rounded-lg group-hover:scale-110 transition-transform shadow-sm border border-white",children:a.jsx(dn,{className:"w-3.5 h-3.5"})}),"Back to Dashboard"]}),a.jsx("h1",{className:"text-3xl font-black text-slate-900 tracking-tight mb-2 uppercase",children:"Your Health Archive"}),a.jsxs("p",{className:"text-slate-500 text-sm font-bold opacity-80",children:["Track your progress across ",f.length," diagnostic reports"]})]}),a.jsxs(Rt,{to:"/upload",className:"px-6 py-4 bg-slate-900 text-white rounded-[1.5rem] font-black hover:shadow-2xl transition-all flex items-center justify-center gap-3 text-sm uppercase tracking-widest active:scale-95 group shadow-xl",children:[a.jsx(Kr,{className:"w-4 h-4 group-hover:-translate-y-1 transition-transform"}),"Upload New Report"]})]})]}),f.length>0&&a.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[a.jsx("div",{className:"card p-5 group hover:scale-[1.02] transition-all duration-300",children:a.jsxs("div",{className:"flex flex-col items-center sm:items-start gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-2xl bg-purple-50 flex items-center justify-center shadow-inner group-hover:rotate-12 transition-transform",children:a.jsx(un,{className:"w-5 h-5 text-purple-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-3xl font-black text-slate-900 tracking-tighter leading-none",children:f.length}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mt-2",children:"Reports"})]})]})}),a.jsx("div",{className:"card p-5 group hover:scale-[1.02] transition-all duration-300",children:a.jsxs("div",{className:"flex flex-col items-center sm:items-start gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-2xl bg-emerald-50 flex items-center justify-center shadow-inner group-hover:rotate-12 transition-transform",children:a.jsx(Qn,{className:"w-5 h-5 text-emerald-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-3xl font-black text-slate-900 tracking-tighter leading-none",children:f.filter(D=>D.status==="completed").length}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mt-2",children:"Analyzed"})]})]})}),a.jsx("div",{className:"card p-5 group hover:scale-[1.02] transition-all duration-300",children:a.jsxs("div",{className:"flex flex-col items-center sm:items-start gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-2xl bg-amber-50 flex items-center justify-center shadow-inner group-hover:rotate-12 transition-transform",children:a.jsx(Pn,{className:"w-5 h-5 text-amber-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-xl sm:text-2xl font-black text-slate-900 tracking-tighter leading-none pt-1",children:f.length>0?new Date(f[0].createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"N/A"}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mt-2",children:"Latest"})]})]})})]}),a.jsx("div",{className:"flex gap-3 overflow-x-auto pb-4 snap-x snap-mandatory scrollbar-hide -mx-6 px-6 sm:mx-0 sm:px-0",children:F.map(D=>a.jsx("button",{onClick:()=>R(D),className:`px-5 py-2.5 rounded-2xl font-black whitespace-nowrap transition-all text-[11px] uppercase tracking-widest leading-none snap-start border-2 ${y===D?"bg-slate-900 border-slate-900 text-white shadow-xl scale-105":"bg-white/50 backdrop-blur-sm text-slate-600 border-white hover:border-purple-200 hover:bg-white"}`,children:D==="all"?"All Diagnostics":D},D))}),G.length>0?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"hidden sm:grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:G.map(D=>{var H;return a.jsxs("div",{className:"card p-6 border-none hover:shadow-2xl transition-all duration-300 group relative ring-1 ring-white/50",children:[a.jsx("button",{onClick:B=>U(D._id,B),className:"absolute top-4 right-4 w-9 h-9 rounded-xl bg-red-50 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all z-10 shadow-sm opacity-0 group-hover:opacity-100",children:a.jsx(Bd,{className:"w-4 h-4"})}),a.jsxs("div",{className:"flex items-start gap-5 mb-6",children:[a.jsx("div",{className:"w-16 h-16 rounded-[1.25rem] bg-indigo-50 flex items-center justify-center shadow-inner group-hover:bg-indigo-100 transition-colors",children:a.jsx(un,{className:"w-8 h-8 text-indigo-600"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"flex items-center gap-2 mb-2",children:a.jsx("span",{className:`text-[9px] font-black px-2.5 py-1 rounded-lg uppercase tracking-widest ${D.status==="completed"?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:D.status})}),a.jsx("h3",{className:"text-xl font-black text-slate-800 leading-tight uppercase group-hover:text-purple-600 transition-colors mb-1",children:D.reportType}),a.jsxs("div",{className:"flex items-center gap-2 text-slate-400 text-[10px] font-black uppercase tracking-widest font-mono",children:[a.jsx(Pn,{className:"w-3 h-3"}),new Date(D.reportDate||D.createdAt).toLocaleDateString()]})]})]}),((H=D.aiAnalysis)==null?void 0:H.healthScore)&&a.jsxs("div",{className:"bg-slate-50/50 backdrop-blur-md rounded-2xl p-4 border border-white/50 mb-6 shadow-inner flex items-center justify-between",children:[a.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:"Health Score"}),a.jsxs("div",{className:"flex items-baseline gap-1",children:[a.jsx("span",{className:"text-3xl font-black text-slate-900 tracking-tighter",children:D.aiAnalysis.healthScore}),a.jsx("span",{className:"text-slate-400 font-bold text-xs",children:"/100"})]})]}),a.jsxs(Rt,{to:`/reports/${D._id}`,onClick:()=>window.scrollTo(0,0),className:"w-full py-4 bg-white border-2 border-slate-100 text-slate-800 rounded-2xl font-black text-xs uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95",children:[a.jsx(hl,{className:"w-4 h-4"}),"Analysis Details"]})]},D._id)})}),a.jsx("div",{className:"sm:hidden",children:G.length<=3?a.jsx("div",{className:"grid grid-cols-1 gap-4",children:G.map(D=>{var H;return a.jsxs("div",{className:"card p-5 relative border-none ring-1 ring-white/50",children:[a.jsx("button",{onClick:B=>U(D._id,B),className:"absolute top-3 right-3 w-8 h-8 rounded-xl bg-red-50 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all z-10",children:a.jsx(Bd,{className:"w-4 h-4"})}),a.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-[1rem] bg-indigo-50 flex items-center justify-center flex-shrink-0 shadow-inner",children:a.jsx(un,{className:"w-6 h-6 text-indigo-600"})}),a.jsxs("div",{className:"flex-1 min-w-0 pr-8",children:[a.jsx("div",{className:"flex items-start justify-between gap-2 mb-1",children:a.jsx("h3",{className:"text-sm font-black text-slate-800 truncate uppercase",children:D.reportType})}),a.jsx("div",{className:"flex items-center gap-2 mb-2",children:a.jsx("span",{className:`text-[8px] font-black px-2 py-0.5 rounded-md uppercase tracking-widest whitespace-nowrap ${D.status==="completed"?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:D.status})}),a.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest text-slate-400 font-mono mb-2",children:new Date(D.reportDate||D.createdAt).toLocaleDateString()}),((H=D.aiAnalysis)==null?void 0:H.healthScore)&&a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-slate-400",children:"Score:"}),a.jsx("span",{className:"text-lg font-black text-slate-900 tracking-tighter",children:D.aiAnalysis.healthScore}),a.jsx("span",{className:"text-[10px] text-slate-400 font-bold",children:"/100"})]})]})]}),a.jsxs(Rt,{to:`/reports/${D._id}`,onClick:()=>window.scrollTo(0,0),className:"w-full py-3 bg-white border-2 border-slate-100 text-slate-800 rounded-xl font-black text-[10px] uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95",children:[a.jsx(hl,{className:"w-3 h-3"}),"Details"]})]},D._id)})}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex overflow-x-auto gap-4 pb-6 snap-x snap-mandatory scrollbar-hide -mx-6 px-6",children:G.map(D=>{var H;return a.jsxs("div",{className:"min-w-[280px] card p-5 relative snap-start flex-shrink-0 border-none ring-1 ring-white/50",children:[a.jsx("button",{onClick:B=>U(D._id,B),className:"absolute top-3 right-3 w-8 h-8 rounded-xl bg-red-50 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all z-10",children:a.jsx(Bd,{className:"w-4 h-4"})}),a.jsxs("div",{className:"flex items-start gap-4 mb-4 pr-8",children:[a.jsx("div",{className:"w-12 h-12 rounded-[1rem] bg-indigo-50 flex items-center justify-center flex-shrink-0 shadow-inner",children:a.jsx(un,{className:"w-6 h-6 text-indigo-600"})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:"text-sm font-black text-slate-800 mb-1 uppercase truncate",children:D.reportType}),a.jsx("span",{className:`text-[8px] px-2 py-0.5 rounded-md font-black uppercase tracking-widest inline-block ${D.status==="completed"?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:D.status})]})]}),a.jsx("p",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest font-mono mb-4",children:new Date(D.reportDate||D.createdAt).toLocaleDateString()}),((H=D.aiAnalysis)==null?void 0:H.healthScore)&&a.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50/50 backdrop-blur-md border border-white/50 rounded-xl mb-4 shadow-inner",children:[a.jsx("span",{className:"text-[9px] font-black text-slate-400 uppercase tracking-widest",children:"Health Score"}),a.jsxs("div",{className:"flex items-baseline gap-1",children:[a.jsx("span",{className:"text-2xl font-black text-slate-900 tracking-tighter",children:D.aiAnalysis.healthScore}),a.jsx("span",{className:"text-[10px] text-slate-400 font-bold",children:"/100"})]})]}),a.jsxs(Rt,{to:`/reports/${D._id}`,onClick:()=>window.scrollTo(0,0),className:"w-full py-3 bg-white border-2 border-slate-100 text-slate-800 rounded-xl font-black text-[10px] uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95",children:[a.jsx(hl,{className:"w-3 h-3"}),"Details"]})]},D._id)})}),a.jsx("div",{className:"flex items-center justify-center gap-2 text-slate-400 text-[10px] font-black uppercase tracking-widest mt-2",children:a.jsx("span",{children:" Swipe for more "})})]})})]}):a.jsxs("div",{className:"text-center py-16 px-6 card border-none shadow-xl flex flex-col items-center max-w-lg mx-auto mt-12",children:[a.jsxs("div",{className:"w-24 h-24 bg-purple-50 rounded-3xl flex items-center justify-center mb-6 shadow-inner relative",children:[a.jsx("div",{className:"absolute inset-0 bg-white/20 rounded-3xl blur"}),a.jsx(un,{className:"w-12 h-12 text-purple-300 relative z-10"})]}),a.jsx("h3",{className:"text-xl font-black text-slate-800 tracking-tight mb-2 uppercase",children:"No Data Found"}),a.jsx("p",{className:"text-slate-500 mb-8 text-sm font-bold opacity-80 max-w-xs leading-relaxed",children:y==="all"?"Start your health journey by uploading your first diagnostic report.":`No ${y} diagnostic records exist yet.`}),a.jsxs(Rt,{to:"/upload",className:"w-full sm:w-auto px-8 py-4 bg-slate-900 text-white rounded-[1.5rem] font-black hover:shadow-2xl transition-all flex items-center justify-center gap-3 text-sm uppercase tracking-widest active:scale-95 shadow-xl",children:[a.jsx(Kr,{className:"w-4 h-4"}),"Upload Report"]})]})]})}const Ah=[{id:"water",label:"Drink 8 glasses of water",icon:""},{id:"workout",label:"Workout/Yoga (30 mins)",icon:""},{id:"fruits",label:"Eat 2 servings of fruits",icon:""},{id:"vegetables",label:"Eat 3 servings of vegetables",icon:""},{id:"sleep",label:"Sleep 7-8 hours",icon:""},{id:"meditation",label:"Meditate (10 mins)",icon:""},{id:"steps",label:"Walk 8,000 steps",icon:""},{id:"screen",label:"Limit screen time (< 2 hrs)",icon:""}];function QZ(){const[u,f]=j.useState(()=>{const D=localStorage.getItem("challenge30DaysCurrentDay");return D?parseInt(D):1}),[x,_]=j.useState({}),[E,y]=j.useState(0),[R,P]=j.useState(!0);j.useEffect(()=>{window.scrollTo(0,0),U()},[]),j.useEffect(()=>{localStorage.setItem("challenge30DaysCurrentDay",u)},[u]);const U=async()=>{const D=localStorage.getItem("challenge30Days"),H=localStorage.getItem("challenge30DaysStreak");if(D)try{const B=JSON.parse(D);_(B),y(parseInt(H)||0)}catch(B){console.error("Error parsing saved data:",B)}try{const B=await et.get("/health/challenge"),ne=B.data.challengeData||{},ae={};ne&&typeof ne=="object"&&Object.keys(ne).forEach(Z=>{ae[Z]=ne[Z]}),_(ae),y(B.data.streakDays||0),localStorage.setItem("challenge30Days",JSON.stringify(ae)),localStorage.setItem("challenge30DaysStreak",B.data.streakDays||0)}catch(B){console.error("Failed to load challenge data from server:",B)}finally{P(!1)}},G=async D=>{let H=0;const B=Object.keys(D).map(Number).sort((ne,ae)=>ae-ne);for(const ne of B){const ae=D[ne];if(Object.values(ae).filter(Boolean).length>=5)H++;else break}y(H),localStorage.setItem("challenge30Days",JSON.stringify(D)),localStorage.setItem("challenge30DaysStreak",H);try{const ne=await et.post("/health/challenge",{challengeData:D});ne.data.streakDays!==H&&(y(ne.data.streakDays),localStorage.setItem("challenge30DaysStreak",ne.data.streakDays))}catch(ne){console.error("Failed to save challenge data to server:",ne)}},F=(D,H)=>{var ae;const B={...x,[D]:{...x[D],[H]:!((ae=x[D])!=null&&ae[H])}};_(B),G(B);const ne=Object.values(B[D]).filter(Boolean).length;ne===Ah.length?Ve.success(" Amazing! You completed all tasks for today!"):ne===5&&Ve.success(" Great job! You're doing awesome!")},k=D=>{const H=x[D]||{};return Object.values(H).filter(Boolean).length/Ah.length*100},X=()=>{let D=0;for(let H=1;H<=30;H++){const B=x[H]||{};D+=Object.values(B).filter(Boolean).length}return D/(Ah.length*30)*100},q=()=>{let D=0;for(let H=1;H<=30;H++){const B=x[H]||{};Object.values(B).filter(Boolean).length>=5&&D++}return D};return a.jsx("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in p-4",children:R?a.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"}),a.jsx("p",{className:"text-slate-600",children:"Loading your challenge..."})]})}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:[a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors mb-2",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]}),a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold text-slate-800 flex items-center gap-3",children:[a.jsx(lE,{className:"w-8 h-8 text-amber-500"}),"30 Days Health Challenge"]}),a.jsx("p",{className:"text-slate-500 mt-1",children:"Build healthy habits, one day at a time"})]})})]}),a.jsxs("div",{className:"grid grid-cols-3 gap-2 sm:gap-4",children:[a.jsx("div",{className:"bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl sm:rounded-2xl p-3 sm:p-6 text-white",children:a.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:gap-3 mb-2",children:[a.jsx(qi,{className:"w-6 h-6 sm:w-8 sm:h-8 mb-1 sm:mb-0"}),a.jsxs("div",{className:"text-center sm:text-left",children:[a.jsx("p",{className:"text-2xl sm:text-3xl font-bold",children:E}),a.jsx("p",{className:"text-amber-100 text-[10px] sm:text-sm",children:"Day Streak"})]})]})}),a.jsx("div",{className:"bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl sm:rounded-2xl p-3 sm:p-6 text-white",children:a.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:gap-3 mb-2",children:[a.jsx(Hs,{className:"w-6 h-6 sm:w-8 sm:h-8 mb-1 sm:mb-0"}),a.jsxs("div",{className:"text-center sm:text-left",children:[a.jsx("p",{className:"text-2xl sm:text-3xl font-bold",children:q()}),a.jsx("p",{className:"text-emerald-100 text-[10px] sm:text-sm",children:"Days Done"})]})]})}),a.jsx("div",{className:"bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl sm:rounded-2xl p-3 sm:p-6 text-white",children:a.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:gap-3 mb-2",children:[a.jsx(vr,{className:"w-6 h-6 sm:w-8 sm:h-8 mb-1 sm:mb-0"}),a.jsxs("div",{className:"text-center sm:text-left",children:[a.jsxs("p",{className:"text-2xl sm:text-3xl font-bold",children:[X().toFixed(0),"%"]}),a.jsx("p",{className:"text-cyan-100 text-[10px] sm:text-sm",children:"Progress"})]})]})})]}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-4 sm:p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h3",{className:"text-base sm:text-lg font-semibold text-slate-800",children:"Select Day"}),a.jsxs("span",{className:"text-xs sm:text-sm text-slate-500",children:["Current: Day ",u]})]}),a.jsx("div",{className:"block sm:hidden space-y-3 max-h-[300px] overflow-y-auto",children:[0,1,2,3].map(D=>a.jsx("div",{className:"flex gap-2",children:Array.from({length:7},(H,B)=>D*7+B+1).filter(H=>H<=30).map(H=>{const B=k(H),ne=B>=62.5;return a.jsx("button",{onClick:()=>f(H),className:`flex-1 aspect-square rounded-xl font-bold text-sm transition-all ${u===H?"bg-cyan-500 text-white shadow-lg scale-105":ne?"bg-emerald-100 text-emerald-700 hover:bg-emerald-200":B>0?"bg-amber-100 text-amber-700 hover:bg-amber-200":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:H},H)})},D))}),a.jsx("div",{className:"hidden sm:grid grid-cols-10 gap-2",children:Array.from({length:30},(D,H)=>H+1).map(D=>{const H=k(D),B=H>=62.5;return a.jsx("button",{onClick:()=>f(D),className:`aspect-square rounded-xl font-bold text-sm transition-all ${u===D?"bg-cyan-500 text-white shadow-lg scale-110":B?"bg-emerald-100 text-emerald-700 hover:bg-emerald-200":H>0?"bg-amber-100 text-amber-700 hover:bg-amber-200":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:D},D)})})]}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{children:[a.jsxs("h3",{className:"text-xl font-bold text-slate-800",children:["Day ",u," Tasks"]}),a.jsxs("p",{className:"text-slate-500 text-sm",children:[Object.values(x[u]||{}).filter(Boolean).length," of ",Ah.length," completed"]})]}),a.jsxs("div",{className:"text-right",children:[a.jsxs("div",{className:"text-2xl font-bold text-cyan-600",children:[k(u).toFixed(0),"%"]}),a.jsx("div",{className:"text-xs text-slate-500",children:"Progress"})]})]}),a.jsx("div",{className:"w-full bg-slate-100 rounded-full h-3 mb-6",children:a.jsx("div",{className:"h-3 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500",style:{width:`${k(u)}%`}})}),a.jsx("div",{className:"space-y-3",children:Ah.map(D=>{var B;const H=(B=x[u])==null?void 0:B[D.id];return a.jsxs("button",{onClick:()=>F(u,D.id),className:`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${H?"bg-emerald-50 border-emerald-200 hover:bg-emerald-100":"bg-white border-slate-200 hover:bg-slate-50"}`,children:[a.jsx("div",{className:"text-3xl",children:D.icon}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("p",{className:`font-medium ${H?"text-emerald-700 line-through":"text-slate-800"}`,children:D.label})}),a.jsx("div",{children:H?a.jsx(Hs,{className:"w-6 h-6 text-emerald-500"}):a.jsx(gq,{className:"w-6 h-6 text-slate-300"})})]},D.id)})})]}),a.jsxs("div",{className:"bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-6 text-white",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx(UE,{className:"w-6 h-6"}),a.jsx("h3",{className:"text-lg font-semibold",children:"Achievements"})]}),a.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[a.jsxs("div",{className:`p-3 rounded-xl text-center ${E>=3?"bg-white/20":"bg-white/10 opacity-50"}`,children:[a.jsx("div",{className:"text-2xl mb-1",children:""}),a.jsx("p",{className:"text-xs font-medium",children:"3 Day Streak"})]}),a.jsxs("div",{className:`p-3 rounded-xl text-center ${E>=7?"bg-white/20":"bg-white/10 opacity-50"}`,children:[a.jsx("div",{className:"text-2xl mb-1",children:""}),a.jsx("p",{className:"text-xs font-medium",children:"1 Week Streak"})]}),a.jsxs("div",{className:`p-3 rounded-xl text-center ${q()>=15?"bg-white/20":"bg-white/10 opacity-50"}`,children:[a.jsx("div",{className:"text-2xl mb-1",children:""}),a.jsx("p",{className:"text-xs font-medium",children:"Half Way"})]}),a.jsxs("div",{className:`p-3 rounded-xl text-center ${q()>=30?"bg-white/20":"bg-white/10 opacity-50"}`,children:[a.jsx("div",{className:"text-2xl mb-1",children:""}),a.jsx("p",{className:"text-xs font-medium",children:"Champion"})]})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-6",children:[a.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:" Tips for Success"}),a.jsxs("ul",{className:"space-y-2 text-slate-600",children:[a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-cyan-500 mt-1",children:""}),a.jsx("span",{children:"Complete at least 5 tasks daily to maintain your streak"})]}),a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-cyan-500 mt-1",children:""}),a.jsx("span",{children:"Set reminders on your phone for each task"})]}),a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-cyan-500 mt-1",children:""}),a.jsx("span",{children:"Start with easier tasks and gradually increase difficulty"})]}),a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-cyan-500 mt-1",children:""}),a.jsx("span",{children:"Share your progress with friends for accountability"})]})]})]})]})})}function ZZ(){var q,D,H;const{user:u}=ia(),[f,x]=j.useState("HbA1c"),[_,E]=j.useState([]),[y,R]=j.useState(5.8),[P,U]=j.useState(108);j.useEffect(()=>{const B=localStorage.getItem("glucose_readings");if(B)E(JSON.parse(B));else{const ne=[{id:1,type:"Fasting",value:98,time:"Today  08:00 AM",status:"optimal",date:new Date().toISOString()},{id:2,type:"Post-Meal",value:142,time:"Today  01:30 PM",status:"monitor",date:new Date().toISOString()},{id:3,type:"HbA1c",value:5.8,time:"Feb 15  Last Lab",status:"target",date:"2026-02-15"}];E(ne),localStorage.setItem("glucose_readings",JSON.stringify(ne))}},[]);const G=[{day:"Tue",value:105},{day:"Wed",value:110},{day:"Thu",value:115},{day:"Fri",value:108},{day:"Sat",value:102},{day:"Sun",value:108}],F=B=>{switch(B){case"optimal":return"text-green-600 bg-green-100";case"monitor":return"text-orange-600 bg-orange-100";case"target":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}},k=B=>{switch(B){case"optimal":return"OPTIMAL";case"monitor":return"MONITOR";case"target":return"TARGET";default:return"NORMAL"}},X=B=>{switch(B){case"Fasting":return"bg-green-100 text-green-600";case"Post-Meal":return"bg-orange-100 text-orange-600";case"HbA1c":return"bg-red-100 text-red-600";default:return"bg-gray-100 text-gray-600"}};return a.jsx("div",{className:"min-h-screen bg-gray-50 pb-20",children:a.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[a.jsxs("div",{className:"md:hidden flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-md flex-shrink-0",children:((D=(q=u==null?void 0:u.name)==null?void 0:q[0])==null?void 0:D.toUpperCase())||"U"}),a.jsxs("h1",{className:"text-sm font-bold text-slate-800 truncate",children:[(()=>{const B=new Date().getHours();return B<12?"Good Morning":B<18?"Good Afternoon":"Good Evening"})(),", ",((H=u==null?void 0:u.name)==null?void 0:H.split(" ")[0])||"there","!"]})]}),a.jsx("button",{className:"w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center hover:shadow-lg transition-all flex-shrink-0",children:a.jsx(Eo,{className:"w-4 h-4 text-slate-700"})})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900",children:"Diabetes Care"}),a.jsx("p",{className:"text-sm text-slate-600 mt-1",children:"Glycemic Control & Trends"})]}),a.jsx("button",{className:"w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-blue-600 text-white flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all",children:a.jsx(vi,{className:"w-6 h-6 md:w-7 md:h-7"})})]}),a.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center",children:a.jsx(Qn,{className:"w-5 h-5 text-blue-600"})}),a.jsx("h2",{className:"text-lg font-bold text-slate-900",children:"WEEKLY PROGRESS"})]}),a.jsxs("button",{className:"flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm font-medium text-slate-700",children:[f,a.jsx(yo,{className:"w-4 h-4"})]})]}),a.jsx("div",{className:"relative h-48 mb-4",children:a.jsxs("svg",{className:"w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[a.jsx("defs",{children:a.jsxs("linearGradient",{id:"chartGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[a.jsx("stop",{offset:"0%",stopColor:"#3b82f6",stopOpacity:"0.3"}),a.jsx("stop",{offset:"100%",stopColor:"#3b82f6",stopOpacity:"0"})]})}),a.jsx("path",{d:"M 0 40 Q 16.67 35 33.33 30 T 66.67 45 T 100 40 L 100 100 L 0 100 Z",fill:"url(#chartGradient)"}),a.jsx("path",{d:"M 0 40 Q 16.67 35 33.33 30 T 66.67 45 T 100 40",fill:"none",stroke:"#3b82f6",strokeWidth:"2",strokeLinecap:"round"})]})}),a.jsx("div",{className:"grid grid-cols-6 gap-2 text-center text-xs text-slate-500",children:G.map((B,ne)=>a.jsx("div",{children:B.day},ne))})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-5 text-white shadow-xl",children:[a.jsx("p",{className:"text-slate-400 text-xs uppercase tracking-wide mb-2",children:"CURRENT HBA1C"}),a.jsxs("div",{className:"flex items-baseline gap-2 mb-3",children:[a.jsx("span",{className:"text-4xl font-bold",children:y}),a.jsx("span",{className:"text-green-400 text-lg",children:"%"})]}),a.jsx("div",{className:"w-full h-2 bg-slate-700 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-green-400 to-cyan-400 rounded-full",style:{width:"60%"}})}),a.jsx("p",{className:"text-xs text-cyan-400 mt-2 uppercase tracking-wide",children:"Target Range"})]}),a.jsxs("div",{className:"bg-white rounded-3xl p-5 shadow-lg border-2 border-slate-200",children:[a.jsx("p",{className:"text-slate-600 text-xs uppercase tracking-wide mb-2",children:"DAILY AVG"}),a.jsxs("div",{className:"flex items-baseline gap-2 mb-3",children:[a.jsx("span",{className:"text-4xl font-bold text-slate-900",children:P}),a.jsx("span",{className:"text-slate-500 text-sm",children:"mg/dL"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ms,{className:"w-4 h-4 text-blue-600"}),a.jsx("span",{className:"text-xs text-blue-600 font-semibold uppercase",children:"Stable Baseline"})]})]})]}),a.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h2",{className:"text-lg font-bold text-slate-900",children:"RECENT ACTIVITY"}),a.jsx(Rt,{to:"/diabetes/history",className:"text-sm text-blue-600 font-semibold hover:underline",children:"View All"})]}),a.jsx("div",{className:"space-y-3",children:_.map(B=>a.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-2xl hover:bg-gray-100 transition-all",children:[a.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[a.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center ${X(B.type)}`,children:a.jsx(LE,{className:"w-6 h-6"})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("h3",{className:"font-bold text-slate-900",children:[B.type," Reading"]}),a.jsx("p",{className:"text-sm text-slate-500",children:B.time})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsxs("p",{className:"text-2xl font-bold text-slate-900",children:[B.value,a.jsx("span",{className:"text-sm text-slate-500 ml-1",children:B.type==="HbA1c"?"%":"MG/DL"})]}),a.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-semibold uppercase ${F(B.status)}`,children:k(B.status)})]})]},B.id))})]}),a.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-6 border-2 border-blue-200",children:a.jsxs("div",{className:"flex items-start gap-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center flex-shrink-0",children:a.jsx(vo,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-lg font-bold text-blue-900 mb-2",children:"SMART FORECAST"}),a.jsx("p",{className:"text-sm text-blue-800 leading-relaxed",children:"Your post-meal glucose has increased by 4% compared to last week. Consider tracking fiber intake to stabilize spikes."})]})]})}),a.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-lg",children:[a.jsx("h2",{className:"text-lg font-bold text-slate-900 mb-4",children:"Quick Tips"}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(Hs,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-slate-700",children:"Test fasting glucose before breakfast for accurate baseline readings"})]}),a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(Hs,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-slate-700",children:"Check post-meal levels 2 hours after eating to monitor spikes"})]}),a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(hn,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-slate-700",children:"Aim for HbA1c below 7% for optimal diabetes management"})]})]})]})]})})}function PL({vital:u,onClose:f}){const[x,_]=j.useState("overview"),[E,y]=j.useState(null),[R,P]=j.useState(!0);if(!u)return console.error("VitalDetailsPopup: vital prop is null or undefined"),null;const{name:U="Unknown Metric",value:G="N/A",unit:F="",normalRange:k="N/A",status:X="normal",description:q="",recommendations:D=[],foodsToConsume:H=[],foodsToAvoid:B=[],symptoms:ne=[],severity:ae=""}=u||{};j.useEffect(()=>{U&&U!=="Unknown Metric"?(async()=>{try{P(!0),console.log(" Fetching AI info for vital:",U);const he=await qr.getMetricInfo({metricName:U,metricValue:G,normalRange:k,unit:F});he.data&&he.data.metricInfo&&(console.log(" Received AI info for vital:",U),y(he.data.metricInfo.en))}catch(he){console.error(" Error fetching AI info:",he)}finally{P(!1)}})():P(!1)},[U,G,k,F]);const te=(pe=>{if(!pe)return{min:0,max:100};const he=pe.split("-").map(Ae=>parseFloat(Ae.trim()));return{min:he[0],max:he[1]}})(k),ie=parseFloat(G),ue=()=>ie<te.min?0:ie>te.max?100:(ie-te.min)/(te.max-te.min)*100,be=X==="normal"?{bg:"bg-emerald-50",border:"border-emerald-200",text:"text-emerald-700",badge:"bg-emerald-100"}:X==="borderline"?{bg:"bg-amber-50",border:"border-amber-200",text:"text-amber-700",badge:"bg-amber-100"}:{bg:"bg-red-50",border:"border-red-200",text:"text-red-700",badge:"bg-red-100"},Q=ue();return a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4",onClick:pe=>{pe.target===pe.currentTarget&&f()},children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:pe=>pe.stopPropagation(),children:[a.jsxs("div",{className:`${be.bg} border-b-2 ${be.border} p-6 flex items-center justify-between sticky top-0 z-10`,children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:`w-12 h-12 rounded-xl ${be.badge} flex items-center justify-center`,children:[X==="normal"&&a.jsx(Hs,{className:`w-6 h-6 ${be.text}`}),X==="borderline"&&a.jsx(hn,{className:`w-6 h-6 ${be.text}`}),X==="high"&&a.jsx(Qn,{className:`w-6 h-6 ${be.text}`})]}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:U}),a.jsx("p",{className:`text-sm ${be.text} font-medium capitalize`,children:X})]})]}),a.jsx("button",{onClick:f,className:"p-2 hover:bg-white/50 rounded-lg transition-colors",children:a.jsx(ra,{className:"w-6 h-6 text-slate-600"})})]}),a.jsxs("div",{className:"p-6 space-y-6",children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[a.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 border border-slate-200",children:[a.jsx("p",{className:"text-xs text-slate-600 font-medium mb-1",children:"Your Value"}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:[G," ",a.jsx("span",{className:"text-sm text-slate-500",children:F})]})]}),a.jsxs("div",{className:"bg-blue-50 rounded-xl p-4 border border-blue-200",children:[a.jsx("p",{className:"text-xs text-blue-600 font-medium mb-1",children:"Normal Range"}),a.jsx("p",{className:"text-2xl font-bold text-blue-700",children:k})]}),a.jsxs("div",{className:`${be.bg} rounded-xl p-4 border-2 ${be.border}`,children:[a.jsx("p",{className:`text-xs ${be.text} font-medium mb-1`,children:"Status"}),a.jsx("p",{className:`text-2xl font-bold ${be.text} capitalize`,children:X})]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("p",{className:"text-sm font-semibold text-slate-800",children:"Range Indicator"}),a.jsxs("div",{className:"relative h-12 bg-gradient-to-r from-red-200 via-amber-200 to-emerald-200 rounded-xl overflow-hidden border-2 border-slate-200",children:[a.jsx("div",{className:"absolute top-0 bottom-0 bg-white/40 border-l-2 border-r-2 border-blue-500",style:{left:`${te.min/(te.max*1.2)*100}%`,right:`${100-te.max/(te.max*1.2)*100}%`}}),a.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 w-1 h-full bg-slate-800 border-2 border-white shadow-lg",style:{left:`${Q}%`},children:a.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 -translate-x-1/2 left-0 w-8 h-8 bg-slate-800 rounded-full border-4 border-white shadow-lg"})})]}),a.jsxs("div",{className:"flex justify-between text-xs text-slate-600 font-medium",children:[a.jsx("span",{children:"Low"}),a.jsx("span",{children:"Normal"}),a.jsx("span",{children:"High"})]})]})]}),a.jsx("div",{className:"flex gap-2 border-b border-slate-200",children:[{id:"overview",label:"Overview"},{id:"recommendations",label:"What to Do"},{id:"foods",label:"Foods & Diet"}].map(pe=>a.jsx("button",{onClick:()=>_(pe.id),className:`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${x===pe.id?"border-cyan-500 text-cyan-600":"border-transparent text-slate-600 hover:text-slate-800"}`,children:pe.label},pe.id))}),a.jsxs("div",{className:"space-y-4",children:[x==="overview"&&a.jsx("div",{className:"space-y-4",children:R?a.jsxs("div",{className:"text-center py-8",children:[a.jsx("div",{className:"w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-3"}),a.jsx("p",{className:"text-slate-500 text-sm",children:"Loading AI insights..."})]}):a.jsxs(a.Fragment,{children:[((E==null?void 0:E.whatIsIt)||q)&&a.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl border border-blue-200",children:[a.jsxs("h3",{className:"font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[a.jsx(vo,{className:"w-4 h-4"}),"What is ",U,"?"]}),a.jsx("p",{className:"text-sm text-blue-900 leading-relaxed",children:(E==null?void 0:E.whatIsIt)||q||`${U} is a health metric that helps monitor your overall health.`})]}),a.jsxs("div",{className:`p-4 rounded-xl border-2 ${be.border} ${be.bg}`,children:[a.jsxs("h3",{className:`font-semibold ${be.text} mb-2 flex items-center gap-2`,children:[a.jsx(vo,{className:"w-4 h-4"}),"What This Means"]}),a.jsxs("p",{className:`text-sm ${be.text}`,children:[X==="normal"&&"Your value is within the normal range. Keep maintaining your current lifestyle and habits.",X==="borderline"&&"Your value is slightly outside the normal range. Consider making lifestyle adjustments and monitor regularly.",X==="high"&&"Your value is significantly outside the normal range. Consult with a healthcare provider and make necessary changes.",X==="low"&&"Your value is below the normal range. Consult with a healthcare provider for guidance."]})]}),(E==null?void 0:E.whenLowEffects)&&E.whenLowEffects.length>0&&a.jsxs("div",{className:"p-4 bg-amber-50 rounded-xl border border-amber-200",children:[a.jsxs("h3",{className:"font-semibold text-amber-900 mb-3 flex items-center gap-2",children:[a.jsx(fg,{className:"w-4 h-4"}),E.whenLowTitle||"When Low"]}),a.jsx("ul",{className:"space-y-2",children:E.whenLowEffects.map((pe,he)=>a.jsxs("li",{className:"text-sm text-amber-800 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-amber-600 rounded-full mt-1.5 flex-shrink-0"}),pe]},he))})]}),(E==null?void 0:E.whenHighEffects)&&E.whenHighEffects.length>0&&a.jsxs("div",{className:"p-4 bg-red-50 rounded-xl border border-red-200",children:[a.jsxs("h3",{className:"font-semibold text-red-900 mb-3 flex items-center gap-2",children:[a.jsx(Qn,{className:"w-4 h-4"}),E.whenHighTitle||"When High"]}),a.jsx("ul",{className:"space-y-2",children:E.whenHighEffects.map((pe,he)=>a.jsxs("li",{className:"text-sm text-red-800 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-red-600 rounded-full mt-1.5 flex-shrink-0"}),pe]},he))})]}),!E&&ne&&Array.isArray(ne)&&ne.length>0&&a.jsxs("div",{className:"p-4 bg-amber-50 rounded-xl border border-amber-200",children:[a.jsxs("h3",{className:"font-semibold text-amber-900 mb-3 flex items-center gap-2",children:[a.jsx(hn,{className:"w-4 h-4"}),"Associated Symptoms"]}),a.jsx("ul",{className:"space-y-2",children:ne.map((pe,he)=>a.jsxs("li",{className:"text-sm text-amber-800 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-amber-600 rounded-full mt-1.5 flex-shrink-0"}),pe]},he))})]})]})}),x==="recommendations"&&a.jsx("div",{className:"space-y-4",children:R?a.jsxs("div",{className:"text-center py-8",children:[a.jsx("div",{className:"w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mx-auto mb-3"}),a.jsx("p",{className:"text-slate-500 text-sm",children:"Loading recommendations..."})]}):a.jsxs(a.Fragment,{children:[E!=null&&E.solutions&&E.solutions.length>0?a.jsxs("div",{className:"p-4 bg-emerald-50 rounded-xl border border-emerald-200",children:[a.jsxs("h3",{className:"font-semibold text-emerald-900 mb-3 flex items-center gap-2",children:[a.jsx(Hs,{className:"w-4 h-4"}),"How to Improve"]}),a.jsx("ul",{className:"space-y-3",children:E.solutions.map((pe,he)=>a.jsxs("li",{className:"text-sm text-emerald-800 flex items-start gap-3 p-3 bg-white rounded-lg",children:[a.jsx("span",{className:"w-6 h-6 bg-emerald-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0",children:he+1}),a.jsx("span",{children:pe})]},he))})]}):D&&Array.isArray(D)&&D.length>0?a.jsxs("div",{className:"p-4 bg-emerald-50 rounded-xl border border-emerald-200",children:[a.jsxs("h3",{className:"font-semibold text-emerald-900 mb-3 flex items-center gap-2",children:[a.jsx(Hs,{className:"w-4 h-4"}),"Recommendations"]}),a.jsx("ul",{className:"space-y-3",children:D.map((pe,he)=>a.jsxs("li",{className:"text-sm text-emerald-800 flex items-start gap-3 p-3 bg-white rounded-lg",children:[a.jsx("span",{className:"w-6 h-6 bg-emerald-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0",children:he+1}),a.jsx("span",{children:pe})]},he))})]}):a.jsxs("div",{className:"text-center py-8 text-slate-500",children:[a.jsx(vo,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),a.jsx("p",{children:"Consult with a healthcare professional for personalized recommendations."})]}),a.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl border border-blue-200",children:[a.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"General Tips"}),a.jsxs("ul",{className:"space-y-2 text-sm text-blue-800",children:[a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full mt-1.5 flex-shrink-0"}),"Monitor this value regularly"]}),a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full mt-1.5 flex-shrink-0"}),"Maintain a healthy lifestyle"]}),a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full mt-1.5 flex-shrink-0"}),"Consult a healthcare provider if concerned"]})]})]})]})}),x==="foods"&&a.jsxs("div",{className:"space-y-4",children:[H&&Array.isArray(H)&&H.length>0&&a.jsxs("div",{className:"p-4 bg-emerald-50 rounded-xl border border-emerald-200",children:[a.jsxs("h3",{className:"font-semibold text-emerald-900 mb-3 flex items-center gap-2",children:[a.jsx(Hs,{className:"w-4 h-4"}),"Foods to Consume"]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:H.map((pe,he)=>a.jsx("span",{className:"px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-sm font-medium",children:pe},he))})]}),B&&Array.isArray(B)&&B.length>0&&a.jsxs("div",{className:"p-4 bg-red-50 rounded-xl border border-red-200",children:[a.jsxs("h3",{className:"font-semibold text-red-900 mb-3 flex items-center gap-2",children:[a.jsx(hn,{className:"w-4 h-4"}),"Foods to Avoid"]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:B.map((pe,he)=>a.jsx("span",{className:"px-3 py-1.5 bg-red-100 text-red-700 rounded-full text-sm font-medium",children:pe},he))})]}),(!H||!Array.isArray(H)||H.length===0)&&(!B||!Array.isArray(B)||B.length===0)&&a.jsx("div",{className:"p-4 bg-slate-50 rounded-xl border border-slate-200",children:a.jsx("p",{className:"text-sm text-slate-600",children:"No specific dietary recommendations available."})})]})]}),ae&&a.jsx("div",{className:`p-4 rounded-xl border-2 ${ae==="severe"?"bg-red-50 border-red-200":ae==="moderate"?"bg-amber-50 border-amber-200":"bg-yellow-50 border-yellow-200"}`,children:a.jsxs("p",{className:`text-sm font-medium ${ae==="severe"?"text-red-700":ae==="moderate"?"text-amber-700":"text-yellow-700"}`,children:[a.jsx("strong",{children:"Severity:"})," ",ae.charAt(0).toUpperCase()+ae.slice(1)]})})]}),a.jsx("div",{className:"border-t border-slate-200 p-6 bg-slate-50",children:a.jsx("p",{className:"text-xs text-slate-600 text-center",children:"This information is for educational purposes only. Always consult with a healthcare provider for medical advice."})})]})})}function eee(){var q,D,H,B,ne,ae,Z;const{id:u}=Lh(),[f,x]=j.useState(null),[_,E]=j.useState(!0),[y,R]=j.useState(null),[P,U]=j.useState(!1);j.useEffect(()=>{(async()=>{try{const{data:ie}=await qr.getReport(u);x(ie.report)}catch{Ve.error("Failed to load report")}finally{E(!1)}})()},[u]);const G=(te,ie)=>{const ue={name:te,value:ie.value,unit:ie.unit||"",normalRange:ie.normalRange||"N/A",status:ie.status||"normal",description:ie.description||"",recommendations:ie.recommendations||[],foodsToConsume:ie.foodsToConsume||[],foodsToAvoid:ie.foodsToAvoid||[],symptoms:ie.symptoms||[],severity:ie.severity||""};R(ue),U(!0)},F=()=>{U(!1),R(null)};if(_)return a.jsx(No,{});if(!f)return a.jsx("div",{className:"text-center py-12 text-slate-400",children:"Report not found"});const{aiAnalysis:k}=f,X=(k==null?void 0:k.healthScore)||0;return a.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 animate-fade-in p-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]}),a.jsx(Rt,{to:`/reports/${u}`,className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors",children:"Back to Report Details "})]}),a.jsx("div",{className:"bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl p-8 text-white",children:a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-6",children:[a.jsxs("div",{children:[(f.patientName||(k==null?void 0:k.patientName))&&a.jsxs("div",{className:"mb-3",children:[a.jsx("p",{className:"text-sm text-white/60 uppercase tracking-wide",children:"Patient Name"}),a.jsx("p",{className:"text-xl font-semibold",children:f.patientName||(k==null?void 0:k.patientName)})]}),a.jsxs("h1",{className:"text-3xl font-bold mb-2",children:[f.reportType," Analysis"]}),a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-white/70",children:[a.jsxs("p",{children:["Analyzed on ",new Date(f.createdAt).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),(f.reportDate||(k==null?void 0:k.reportDate))&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"hidden sm:inline",children:""}),a.jsxs("p",{children:["Report Date: ",new Date(f.reportDate||(k==null?void 0:k.reportDate)).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]})]})]})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-5xl font-bold mb-2",children:X}),a.jsx("div",{className:"text-sm text-white/70",children:"Health Score"})]})]})}),(k==null?void 0:k.summary)&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-blue-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2",children:[a.jsx(ms,{className:"w-6 h-6 text-cyan-500"})," Report Summary"]}),a.jsx("p",{className:"text-slate-700 leading-relaxed text-lg",children:k.summary})]}),((q=k==null?void 0:k.keyFindings)==null?void 0:q.length)>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(zn,{className:"w-6 h-6 text-red-500"})," Key Findings"]}),a.jsx("div",{className:"space-y-3",children:k.keyFindings.map((te,ie)=>a.jsxs("div",{className:"flex items-start gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200",children:[a.jsx(Hs,{className:"w-5 h-5 text-blue-500 flex-shrink-0 mt-1"}),a.jsx("p",{className:"text-slate-700 text-base",children:te})]},ie))})]}),(k==null?void 0:k.metrics)&&Object.keys(k.metrics).length>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(ms,{className:"w-6 h-6 text-cyan-500"})," All Health Metrics"]}),a.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(k.metrics).map(([te,ie])=>a.jsxs("button",{onClick:()=>G(te,ie),className:`p-5 rounded-xl border-2 text-left transition-all hover:scale-105 hover:shadow-lg cursor-pointer ${ie.status==="normal"?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":ie.status==="high"?"bg-red-50 border-red-200 hover:border-red-300":"bg-amber-50 border-amber-200 hover:border-amber-300"}`,children:[a.jsx("p",{className:"text-sm text-slate-600 font-medium mb-2",children:te}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800 mb-2",children:[ie.value," ",a.jsx("span",{className:"text-sm font-normal text-slate-500",children:ie.unit})]}),a.jsxs("p",{className:"text-xs text-slate-600 mb-3",children:["Normal: ",ie.normalRange]}),a.jsx("span",{className:`inline-block px-3 py-1 rounded-full text-xs font-semibold ${ie.status==="normal"?"bg-emerald-100 text-emerald-700":ie.status==="high"?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}`,children:ie.status.toUpperCase()})]},te))})]}),((D=k==null?void 0:k.deficiencies)==null?void 0:D.length)>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-l-4 border-amber-500 border-t-2 border-r-2 border-b-2 border-t-slate-200 border-r-slate-200 border-b-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(lc,{className:"w-6 h-6 text-amber-500"})," Detected Deficiencies"]}),a.jsx("div",{className:"space-y-4",children:k.deficiencies.map((te,ie)=>{var ue;return a.jsxs("div",{className:`p-5 rounded-xl border-2 ${te.severity==="Severe"?"bg-red-50 border-red-200":te.severity==="Moderate"?"bg-amber-50 border-amber-200":"bg-yellow-50 border-yellow-200"}`,children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-800",children:te.name}),a.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${te.severity==="Severe"?"bg-red-100 text-red-700":te.severity==="Moderate"?"bg-amber-100 text-amber-700":"bg-yellow-100 text-yellow-700"}`,children:te.severity})]}),te.explanation&&a.jsx("p",{className:"text-slate-700 mb-3",children:te.explanation}),((ue=te.symptoms)==null?void 0:ue.length)>0&&a.jsxs("div",{className:"mb-3",children:[a.jsx("p",{className:"text-sm font-semibold text-slate-700 mb-2",children:"Symptoms:"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:te.symptoms.map((Ne,be)=>a.jsx("span",{className:"text-xs bg-white px-2 py-1 rounded border border-slate-300",children:Ne},be))})]}),te.currentValue&&a.jsxs("p",{className:"text-sm text-slate-600",children:[a.jsx("strong",{children:"Current:"})," ",te.currentValue," | ",a.jsx("strong",{children:"Normal:"})," ",te.normalRange]})]},ie)})})]}),(k==null?void 0:k.foodRecommendations)&&Object.keys(k.foodRecommendations).length>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(Ji,{className:"w-6 h-6 text-emerald-500"})," Recommended Foods"]}),a.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:Object.entries(k.foodRecommendations).map(([te,ie])=>a.jsxs("div",{className:"p-6 bg-emerald-50 rounded-xl border-2 border-emerald-200",children:[a.jsx("h3",{className:"font-bold text-emerald-700 mb-2 text-lg",children:te}),ie.explanation&&a.jsx("p",{className:"text-sm text-emerald-600 mb-3",children:ie.explanation}),ie.frequency&&a.jsxs("p",{className:"text-xs text-emerald-700 font-medium mb-3",children:["Frequency: ",ie.frequency]}),ie.foods&&a.jsx("div",{className:"flex flex-wrap gap-2",children:ie.foods.map((ue,Ne)=>a.jsx("span",{className:"text-xs bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-full font-medium",children:ue},Ne))})]},te))})]}),(k==null?void 0:k.supplementRecommendations)&&Object.keys(k.supplementRecommendations).length>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(oc,{className:"w-6 h-6 text-blue-600"})," Recommended Supplements"]}),a.jsx("div",{className:"space-y-6",children:Object.entries(k.supplementRecommendations).map(([te,ie])=>a.jsxs("div",{children:[a.jsx("h3",{className:"font-bold text-blue-700 mb-4 text-lg",children:te}),Array.isArray(ie)?a.jsx("div",{className:"space-y-3",children:ie.map((ue,Ne)=>a.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[a.jsxs("div",{className:"flex items-start justify-between mb-2",children:[a.jsx("p",{className:"font-semibold text-slate-800",children:ue.name}),ue.frequency&&a.jsx("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-medium",children:ue.frequency})]}),ue.dosage&&a.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[a.jsx("strong",{children:"Dosage:"})," ",ue.dosage]}),ue.timing&&a.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[a.jsx("strong",{children:"Timing:"})," ",ue.timing]}),ue.whyItHelps&&a.jsxs("p",{className:"text-sm text-slate-600 mb-1",children:[a.jsx("strong",{children:"Why:"})," ",ue.whyItHelps]}),ue.note&&a.jsxs("p",{className:"text-xs text-slate-600 italic",children:[" ",ue.note]})]},Ne))}):null]},te))})]}),(k==null?void 0:k.recommendations)&&Object.keys(k.recommendations).length>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-8 shadow-sm",children:[a.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2",children:[a.jsx(zn,{className:"w-6 h-6 text-red-500"})," Health Recommendations"]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[((H=k.recommendations.immediate)==null?void 0:H.length)>0&&a.jsxs("div",{className:"p-6 bg-red-50 rounded-xl border-2 border-red-200",children:[a.jsx("h3",{className:"font-bold text-red-700 mb-4 text-lg",children:" Immediate Actions"}),a.jsx("ul",{className:"space-y-2",children:k.recommendations.immediate.map((te,ie)=>a.jsxs("li",{className:"text-sm text-red-700 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-red-500 rounded-full mt-1.5 flex-shrink-0"}),te]},ie))})]}),((B=k.recommendations.shortTerm)==null?void 0:B.length)>0&&a.jsxs("div",{className:"p-6 bg-amber-50 rounded-xl border-2 border-amber-200",children:[a.jsx("h3",{className:"font-bold text-amber-700 mb-4 text-lg",children:" Short-Term (2-4 weeks)"}),a.jsx("ul",{className:"space-y-2",children:k.recommendations.shortTerm.map((te,ie)=>a.jsxs("li",{className:"text-sm text-amber-700 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-amber-500 rounded-full mt-1.5 flex-shrink-0"}),te]},ie))})]}),((ne=k.recommendations.longTerm)==null?void 0:ne.length)>0&&a.jsxs("div",{className:"p-6 bg-emerald-50 rounded-xl border-2 border-emerald-200",children:[a.jsx("h3",{className:"font-bold text-emerald-700 mb-4 text-lg",children:" Long-Term (Ongoing)"}),a.jsx("ul",{className:"space-y-2",children:k.recommendations.longTerm.map((te,ie)=>a.jsxs("li",{className:"text-sm text-emerald-700 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-emerald-500 rounded-full mt-1.5 flex-shrink-0"}),te]},ie))})]}),k.recommendations.diet&&a.jsxs("div",{className:"p-6 bg-blue-50 rounded-xl border-2 border-blue-200",children:[a.jsx("h3",{className:"font-bold text-blue-700 mb-4 text-lg",children:" Diet Recommendations"}),a.jsx("p",{className:"text-sm text-blue-700",children:k.recommendations.diet})]}),((ae=k.recommendations.lifestyle)==null?void 0:ae.length)>0&&a.jsxs("div",{className:"p-6 bg-violet-50 rounded-xl border-2 border-violet-200",children:[a.jsx("h3",{className:"font-bold text-violet-700 mb-4 text-lg",children:" Lifestyle Changes"}),a.jsx("ul",{className:"space-y-2",children:k.recommendations.lifestyle.map((te,ie)=>a.jsxs("li",{className:"text-sm text-violet-700 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-violet-500 rounded-full mt-1.5 flex-shrink-0"}),te]},ie))})]}),((Z=k.recommendations.followUpTests)==null?void 0:Z.length)>0&&a.jsxs("div",{className:"p-6 bg-cyan-50 rounded-xl border-2 border-cyan-200",children:[a.jsx("h3",{className:"font-bold text-cyan-700 mb-4 text-lg",children:" Follow-Up Tests"}),a.jsx("ul",{className:"space-y-2",children:k.recommendations.followUpTests.map((te,ie)=>a.jsxs("li",{className:"text-sm text-cyan-700 flex items-start gap-2",children:[a.jsx("span",{className:"w-1.5 h-1.5 bg-cyan-500 rounded-full mt-1.5 flex-shrink-0"}),te]},ie))})]})]})]}),a.jsx("div",{className:"p-6 bg-blue-50 rounded-xl border-2 border-blue-200",children:a.jsxs("p",{className:"text-sm text-blue-700",children:[a.jsx("strong",{children:"Disclaimer:"})," This AI analysis is for informational wellness support only and should not replace professional medical advice. Always consult with a healthcare provider for medical decisions."]})}),P&&y&&a.jsx(PL,{vital:y,onClose:F})]})}function tee(){var he,Ae;const[u,f]=j.useState([]),[x,_]=j.useState(null),[E,y]=j.useState(null),[R,P]=j.useState(!0),[U,G]=j.useState(null),[F,k]=j.useState(!1),[X,q]=j.useState(null);j.useEffect(()=>{D()},[]),j.useEffect(()=>{if(x){const fe=u.find(le=>le._id===x);y(fe)}},[x,u]);const D=async()=>{try{const{data:fe}=await qr.getReports();f(fe),fe.length>0&&_(fe[0]._id)}catch(fe){console.error("Failed to fetch reports:",fe)}finally{P(!1)}},H=(fe,le)=>{if(!le||typeof le!="object")return;const we={name:fe||"Unknown Metric",value:le.value!==void 0?le.value:"N/A",unit:le.unit||"",normalRange:le.normalRange||"N/A",status:le.status||"normal",description:le.description||`Details for ${fe}`,recommendations:Array.isArray(le.recommendations)?le.recommendations:[],foodsToConsume:Array.isArray(le.foodsToConsume)?le.foodsToConsume:[],foodsToAvoid:Array.isArray(le.foodsToAvoid)?le.foodsToAvoid:[],symptoms:Array.isArray(le.symptoms)?le.symptoms:[],severity:le.severity||""};G(we),k(!0)},B=()=>{k(!1),G(null)},ne=()=>{const fe=new Set;return u.forEach(le=>{var we;(we=le.aiAnalysis)!=null&&we.metrics&&Object.keys(le.aiAnalysis.metrics).forEach(re=>fe.add(re))}),Array.from(fe).sort()},ae=fe=>fe?u.filter(le=>{var we,re;return(re=(we=le.aiAnalysis)==null?void 0:we.metrics)==null?void 0:re[fe]}).reverse().map(le=>({date:new Date(le.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"2-digit"}),value:le.aiAnalysis.metrics[fe].value,unit:le.aiAnalysis.metrics[fe].unit,status:le.aiAnalysis.metrics[fe].status,normalRange:le.aiAnalysis.metrics[fe].normalRange,fullDate:new Date(le.createdAt)})):[],Z=fe=>{if(fe.length<2)return{direction:"stable",change:0,percentChange:0};const le=fe[fe.length-1].value,we=fe[fe.length-2].value,re=le-we,oe=(re/we*100).toFixed(1);let J="stable";return re>0?J="up":re<0&&(J="down"),{direction:J,change:re.toFixed(2),percentChange:oe}},te=(fe,le)=>{if(le.length<2)return{message:"Not enough data to analyze trend. Upload more reports to track progress.",color:"text-slate-600",bgColor:"bg-slate-50",icon:"info"};const we=Z(le),re=le[le.length-1],oe=re.status==="normal",J=["Cholesterol","LDL","Triglycerides","Blood Sugar","Glucose","HbA1c","Blood Pressure","Systolic","Diastolic","Weight","BMI"],Oe=["HDL","Hemoglobin","RBC","Vitamin D","Vitamin B12","Iron","Calcium"],$e=J.some(Ke=>fe.toLowerCase().includes(Ke.toLowerCase())),He=Oe.some(Ke=>fe.toLowerCase().includes(Ke.toLowerCase()));let ot=!1,_t="";return we.direction==="stable"?oe?(_t=` Your ${fe} is stable and within normal range. Great job maintaining your health!`,ot=!0):(_t=` Your ${fe} remains outside normal range. Consider consulting your doctor for guidance.`,ot=!1):we.direction==="up"?He?(_t=` Your ${fe} is increasing (${we.change} ${re.unit}). This is a positive trend! Keep up the good work.`,ot=!0):$e?(_t=` Your ${fe} is rising (${we.change} ${re.unit}). Consider lifestyle changes to bring it down.`,ot=!1):(_t=` Your ${fe} increased by ${we.change} ${re.unit}. ${oe?"Still within normal range.":"Monitor this closely."}`,ot=oe):$e?(_t=` Your ${fe} is decreasing (${we.change} ${re.unit}). Excellent progress! Keep it up.`,ot=!0):He?(_t=` Your ${fe} is dropping (${we.change} ${re.unit}). You may need to improve this value.`,ot=!1):(_t=` Your ${fe} decreased by ${Math.abs(we.change)} ${re.unit}. ${oe?"Still within normal range.":"Monitor this closely."}`,ot=oe),{message:_t,color:ot?"text-green-700":"text-amber-700",bgColor:ot?"bg-green-50":"bg-amber-50",borderColor:ot?"border-green-200":"border-amber-200",icon:ot?"good":"warning"}};if(R)return a.jsx(No,{});if(u.length===0)return a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in p-4",children:[a.jsx("div",{className:"flex items-center gap-4 mb-6",children:a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]})}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-12 text-center",children:[a.jsx("div",{className:"w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6",children:a.jsx(ms,{className:"w-10 h-10 text-red-500"})}),a.jsx("h2",{className:"text-2xl font-bold text-slate-800 mb-3",children:"No Vital Signs Available"}),a.jsx("p",{className:"text-slate-600 mb-6 max-w-md mx-auto",children:"Upload your health report to view your vital signs and health metrics extracted from your reports."}),a.jsxs(Rt,{to:"/upload",className:"inline-flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors",children:[a.jsx(Kr,{className:"w-5 h-5"}),"Upload Report"]})]})]});const ie=((he=E==null?void 0:E.aiAnalysis)==null?void 0:he.metrics)||{},ue=Object.keys(ie).length>0,Ne=ne(),be=X?ae(X):[],Q=be.length>0?Z(be):null,pe=X&&be.length>0?te(X,be):null;return a.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 animate-fade-in p-4 pb-20",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors mb-2",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]}),a.jsxs("h1",{className:"text-3xl font-bold text-slate-800 flex items-center gap-3",children:[a.jsx(ms,{className:"w-8 h-8 text-red-500"}),"Vital Signs"]}),a.jsx("p",{className:"text-slate-600 mt-2",children:"View your health metrics from reports"})]}),u.length>1&&a.jsxs("div",{className:"relative",children:[a.jsx("select",{value:x||"",onChange:fe=>_(fe.target.value),className:"appearance-none px-4 py-3 pr-10 bg-white border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-800 hover:border-cyan-400 focus:border-cyan-500 focus:outline-none cursor-pointer transition-colors",children:u.map(fe=>a.jsxs("option",{value:fe._id,children:[fe.reportType," - ",new Date(fe.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]},fe._id))}),a.jsx(yo,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"})]})]}),E&&a.jsxs("div",{className:"bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl p-6 text-white",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[a.jsx(un,{className:"w-6 h-6"}),a.jsx("h2",{className:"text-xl font-bold",children:E.reportType})]}),a.jsxs("p",{className:"text-white/80 text-sm",children:["Report Date: ",new Date(E.createdAt).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),((Ae=E.aiAnalysis)==null?void 0:Ae.healthScore)&&a.jsxs("div",{className:"mt-4 inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg",children:[a.jsx("span",{className:"text-sm",children:"Health Score:"}),a.jsx("span",{className:"text-2xl font-bold",children:E.aiAnalysis.healthScore})]})]}),u.length>1&&Ne.length>0&&a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-6 shadow-sm",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"Vital Progress Tracker"}),a.jsx("p",{className:"text-slate-600 text-sm",children:"Select a vital to see its progress over time"})]}),a.jsxs("div",{className:"relative min-w-[200px]",children:[a.jsxs("select",{value:X||"",onChange:fe=>q(fe.target.value),className:"appearance-none w-full px-4 py-3 pr-10 bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-200 rounded-xl text-sm font-medium text-slate-800 hover:border-cyan-400 focus:border-cyan-500 focus:outline-none cursor-pointer transition-colors",children:[a.jsx("option",{value:"",children:"Select Vital"}),Ne.map(fe=>a.jsx("option",{value:fe,children:fe},fe))]}),a.jsx(yo,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-600 pointer-events-none"})]})]}),X&&be.length>0?a.jsxs("div",{className:"space-y-4",children:[Q&&be.length>1&&a.jsxs("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Current Value"}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:[be[be.length-1].value," ",a.jsx("span",{className:"text-sm font-normal text-slate-500",children:be[be.length-1].unit})]}),a.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["Normal: ",be[be.length-1].normalRange]})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("p",{className:"text-sm text-slate-600 mb-2",children:"Trend"}),a.jsx("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full font-bold ${Q.direction==="up"?"bg-blue-100 text-blue-700":Q.direction==="down"?"bg-purple-100 text-purple-700":"bg-slate-100 text-slate-700"}`,children:Q.direction==="up"?a.jsxs(a.Fragment,{children:[a.jsx(Qn,{className:"w-5 h-5"}),a.jsxs("span",{children:["+",Q.change]})]}):Q.direction==="down"?a.jsxs(a.Fragment,{children:[a.jsx(fg,{className:"w-5 h-5"}),a.jsx("span",{children:Q.change})]}):a.jsxs(a.Fragment,{children:[a.jsx(Xd,{className:"w-5 h-5"}),a.jsx("span",{children:"Stable"})]})}),a.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:[Math.abs(Q.percentChange),"% change"]})]})]}),a.jsx("div",{className:"h-64 sm:h-80",children:a.jsx(jh,{width:"100%",height:"100%",children:a.jsxs(oE,{data:be,children:[a.jsx("defs",{children:a.jsxs("linearGradient",{id:"vitalGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[a.jsx("stop",{offset:"5%",stopColor:"#06b6d4",stopOpacity:.3}),a.jsx("stop",{offset:"95%",stopColor:"#06b6d4",stopOpacity:0})]})}),a.jsx(gg,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),a.jsx(xg,{dataKey:"date",stroke:"#94a3b8",fontSize:12,tickLine:!1}),a.jsx(bg,{stroke:"#94a3b8",fontSize:12,tickLine:!1}),a.jsx(ME,{contentStyle:{backgroundColor:"#fff",border:"2px solid #06b6d4",borderRadius:"12px",padding:"12px"},labelStyle:{color:"#64748b",fontWeight:"bold",marginBottom:"4px"},formatter:(fe,le,we)=>[`${fe} ${we.payload.unit}`,X]}),a.jsx(cE,{type:"monotone",dataKey:"value",stroke:"#06b6d4",strokeWidth:3,fill:"url(#vitalGradient)",dot:{fill:"#06b6d4",strokeWidth:2,r:5},activeDot:{r:7,fill:"#0891b2"}})]})})}),a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:be.slice(-4).reverse().map((fe,le)=>a.jsxs("div",{className:"p-3 bg-slate-50 rounded-lg border border-slate-200",children:[a.jsx("p",{className:"text-xs text-slate-500 mb-1",children:fe.date}),a.jsx("p",{className:"text-lg font-bold text-slate-800",children:fe.value}),a.jsx("span",{className:`inline-block mt-1 px-2 py-0.5 rounded text-xs font-semibold ${fe.status==="normal"?"bg-emerald-100 text-emerald-700":"bg-red-100 text-red-700"}`,children:fe.status})]},le))}),pe&&a.jsx("div",{className:`p-4 rounded-xl border-2 ${pe.borderColor} ${pe.bgColor}`,children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx("div",{className:"flex-shrink-0 mt-0.5",children:pe.icon==="good"?a.jsx("div",{className:"w-8 h-8 rounded-full bg-green-500 flex items-center justify-center",children:a.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}):pe.icon==="warning"?a.jsx("div",{className:"w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center",children:a.jsx(hn,{className:"w-5 h-5 text-white"})}):a.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-400 flex items-center justify-center",children:a.jsx(ms,{className:"w-5 h-5 text-white"})})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h4",{className:`font-semibold mb-1 ${pe.color}`,children:"Health Insight"}),a.jsx("p",{className:`text-sm ${pe.color} leading-relaxed`,children:pe.message})]})]})})]}):X?a.jsxs("div",{className:"text-center py-12 text-slate-400",children:[a.jsx(ms,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),a.jsx("p",{children:"No data available for this vital across your reports"})]}):a.jsxs("div",{className:"text-center py-12 text-slate-400",children:[a.jsx(ms,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),a.jsx("p",{children:"Select a vital from the dropdown to see its progress"})]})]}),ue?a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-6 shadow-sm",children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800 mb-6",children:"Current Health Metrics"}),a.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(ie).map(([fe,le])=>a.jsxs("button",{onClick:()=>H(fe,le),className:`p-5 rounded-xl border-2 text-left transition-all hover:scale-105 hover:shadow-lg cursor-pointer ${le.status==="normal"?"bg-emerald-50 border-emerald-200 hover:border-emerald-300":le.status==="high"||le.status==="low"?"bg-red-50 border-red-200 hover:border-red-300":"bg-amber-50 border-amber-200 hover:border-amber-300"}`,children:[a.jsx("p",{className:"text-sm text-slate-600 font-medium mb-2",children:fe}),a.jsxs("p",{className:"text-2xl font-bold text-slate-800 mb-2",children:[le.value," ",a.jsx("span",{className:"text-sm font-normal text-slate-500",children:le.unit})]}),a.jsxs("p",{className:"text-xs text-slate-600 mb-3",children:["Normal: ",le.normalRange]}),a.jsx("span",{className:`inline-block px-3 py-1 rounded-full text-xs font-semibold ${le.status==="normal"?"bg-emerald-100 text-emerald-700":le.status==="high"||le.status==="low"?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}`,children:le.status.toUpperCase()})]},fe))})]}):a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-12 text-center",children:[a.jsx(ms,{className:"w-16 h-16 text-slate-300 mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-semibold text-slate-800 mb-2",children:"No Metrics Found"}),a.jsx("p",{className:"text-slate-600 mb-6",children:"This report doesn't contain any extracted health metrics. Try uploading a different report."}),a.jsxs(Rt,{to:"/upload",className:"inline-flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors",children:[a.jsx(Kr,{className:"w-5 h-5"}),"Upload New Report"]})]}),F&&U&&a.jsx(PL,{vital:U,onClose:B})]})}function see(){const[u,f]=j.useState([]),[x,_]=j.useState(null),[E,y]=j.useState(null),[R,P]=j.useState([]),[U,G]=j.useState(!0);j.useEffect(()=>{F()},[]),j.useEffect(()=>{if(x){const q=u.find(D=>D._id===x);y(q),k(q)}},[x,u]);const F=async()=>{try{const{data:q}=await qr.getReports();f(q),q.length>0&&_(q[0]._id)}catch(q){console.error("Failed to fetch reports:",q)}finally{G(!1)}},k=q=>{var H;if(!q){P([]);return}const D=[];(H=q.aiAnalysis)!=null&&H.supplementRecommendations&&Object.entries(q.aiAnalysis.supplementRecommendations).forEach(([B,ne])=>{Array.isArray(ne)&&ne.forEach(ae=>{D.push({...ae,category:B,reportId:q._id,reportType:q.reportType,reportDate:q.createdAt})})}),P(D)};if(U)return a.jsx(No,{});if(u.length===0)return a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in p-4",children:[a.jsx("div",{className:"flex items-center gap-4 mb-6",children:a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]})}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-12 text-center",children:[a.jsx("div",{className:"w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6",children:a.jsx(oc,{className:"w-10 h-10 text-purple-500"})}),a.jsx("h2",{className:"text-2xl font-bold text-slate-800 mb-3",children:"No Supplement Recommendations Yet"}),a.jsx("p",{className:"text-slate-600 mb-6 max-w-md mx-auto",children:"Upload your health report to get personalized supplement recommendations based on your deficiencies and health conditions."}),a.jsxs(Rt,{to:"/upload",className:"inline-flex items-center gap-2 px-6 py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600 transition-colors",children:[a.jsx(Kr,{className:"w-5 h-5"}),"Upload Report"]})]})]});if(R.length===0&&E)return a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-fade-in p-4",children:[a.jsx("div",{className:"flex items-center gap-4 mb-6",children:a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]})}),u.length>1&&a.jsx("div",{className:"flex justify-end",children:a.jsxs("div",{className:"relative",children:[a.jsx("select",{value:x||"",onChange:q=>_(q.target.value),className:"appearance-none px-4 py-3 pr-10 bg-white border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-800 hover:border-cyan-400 focus:border-cyan-500 focus:outline-none cursor-pointer transition-colors",children:u.map(q=>a.jsxs("option",{value:q._id,children:[q.reportType," - ",new Date(q.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]},q._id))}),a.jsx(yo,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"})]})}),a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-12 text-center",children:[a.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6",children:a.jsx(Hs,{className:"w-10 h-10 text-green-500"})}),a.jsx("h2",{className:"text-2xl font-bold text-slate-800 mb-3",children:"No Supplements Needed"}),a.jsx("p",{className:"text-slate-600 mb-6 max-w-md mx-auto",children:"Great news! This report doesn't show any deficiencies that require supplements. Keep maintaining your healthy lifestyle!"}),u.length>1?a.jsx("p",{className:"text-sm text-slate-500",children:"Try selecting a different report above to view its supplement recommendations."}):a.jsx(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 px-6 py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-colors",children:"Back to Dashboard"})]})]});const X=R.reduce((q,D)=>(q[D.category]||(q[D.category]=[]),q[D.category].push(D),q),{});return a.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 animate-fade-in p-4 pb-20",children:[a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsxs(Rt,{to:"/dashboard",className:"inline-flex items-center gap-2 text-slate-400 hover:text-cyan-400 font-medium transition-colors mb-2",children:[a.jsx(dn,{className:"w-4 h-4"})," Back to Dashboard"]}),a.jsxs("h1",{className:"text-3xl font-bold text-slate-800 flex items-center gap-3",children:[a.jsx(oc,{className:"w-8 h-8 text-purple-500"}),"Supplement Recommendations"]}),a.jsx("p",{className:"text-slate-600 mt-2",children:"Based on your selected health report"})]}),u.length>1&&a.jsxs("div",{className:"relative",children:[a.jsx("select",{value:x||"",onChange:q=>_(q.target.value),className:"appearance-none px-4 py-3 pr-10 bg-white border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-800 hover:border-cyan-400 focus:border-cyan-500 focus:outline-none cursor-pointer transition-colors",children:u.map(q=>a.jsxs("option",{value:q._id,children:[q.reportType," - ",new Date(q.createdAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]},q._id))}),a.jsx(yo,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"})]})]}),E&&a.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl p-6 text-white",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[a.jsx(un,{className:"w-6 h-6"}),a.jsx("h2",{className:"text-xl font-bold",children:E.reportType})]}),a.jsxs("p",{className:"text-white/80 text-sm",children:["Report Date: ",new Date(E.createdAt).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),R.length>0&&a.jsxs("div",{className:"mt-4 inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg",children:[a.jsx(oc,{className:"w-5 h-5"}),a.jsxs("span",{className:"text-sm",children:[R.length," Supplement",R.length!==1?"s":""," Recommended"]})]})]}),a.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-xl p-4 flex items-start gap-3",children:[a.jsx(vo,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),a.jsxs("div",{className:"text-sm text-blue-800",children:[a.jsx("p",{className:"font-semibold mb-1",children:"Important Information"}),a.jsx("p",{children:"These recommendations are based on your selected health report. Always consult with a healthcare provider before starting any new supplements."})]})]}),Object.entries(X).map(([q,D])=>a.jsxs("div",{className:"bg-white rounded-2xl border-2 border-slate-200 p-6 shadow-sm",children:[a.jsxs("h2",{className:"text-xl font-bold text-purple-700 mb-4 flex items-center gap-2",children:[a.jsx(oc,{className:"w-6 h-6"}),q]}),a.jsx("div",{className:"space-y-4",children:D.map((H,B)=>a.jsxs("div",{className:"p-5 bg-purple-50 rounded-xl border-2 border-purple-200",children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-1",children:H.name}),a.jsxs("p",{className:"text-xs text-slate-500",children:["From ",H.reportType,"  ",new Date(H.reportDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]})]}),H.frequency&&a.jsx("span",{className:"px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold",children:H.frequency})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-3",children:[H.dosage&&a.jsxs("div",{children:[a.jsx("p",{className:"text-xs text-slate-600 font-semibold mb-1",children:"Dosage"}),a.jsx("p",{className:"text-sm text-slate-800",children:H.dosage})]}),H.timing&&a.jsxs("div",{children:[a.jsx("p",{className:"text-xs text-slate-600 font-semibold mb-1",children:"Timing"}),a.jsx("p",{className:"text-sm text-slate-800",children:H.timing})]})]}),H.whyItHelps&&a.jsxs("div",{className:"mb-3",children:[a.jsx("p",{className:"text-xs text-slate-600 font-semibold mb-1",children:"Why It Helps"}),a.jsx("p",{className:"text-sm text-slate-700",children:H.whyItHelps})]}),H.note&&a.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:[a.jsx(hn,{className:"w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-xs text-amber-800",children:H.note})]})]},B))})]},q)),a.jsxs("div",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-6",children:[a.jsxs("h3",{className:"font-semibold text-slate-800 mb-2 flex items-center gap-2",children:[a.jsx(hn,{className:"w-5 h-5 text-slate-600"}),"Disclaimer"]}),a.jsx("p",{className:"text-sm text-slate-600",children:"These supplement recommendations are generated based on your health reports and are for informational purposes only. They should not replace professional medical advice. Always consult with a qualified healthcare provider before starting any new supplements, especially if you have existing medical conditions or are taking medications."})]})]})}function nee(){var st,ct,fs,ys,As,zs,je,Ze,Ct,zt,ts,ge,We,rt,ws,Cn;const u=Ga();j.useRef(!1);const[f,x]=j.useState(""),[_,E]=j.useState(null),[y,R]=j.useState(null),[P,U]=j.useState(!1),[G,F]=j.useState(!1),[k,X]=j.useState(null),[q,D]=j.useState(null),[H,B]=j.useState(!1),[ne,ae]=j.useState(!1),[Z,te]=j.useState({quantity:"",prepMethod:"",additionalInfo:""}),[ie,ue]=j.useState(!1),[Ne]=j.useState(["Chicken Biryani","Paneer Tikka","Dal Makhani","Butter Chicken","Roti","Naan","Rice","Pasta","Pizza","Burger","Salad","Sandwich","Idli","Dosa","Samosa","Paratha","Chole Bhature","Rajma Chawal","Khichdi","Fried Rice","Momos","Spring Roll","Manchurian"]),[be,Q]=j.useState([]),pe=Fe=>{const Je=Fe.toLowerCase();return Je.includes("roti")||Je.includes("naan")||Je.includes("paratha")?["1 piece","2 pieces","3 pieces","4 pieces"]:Je.includes("rice")||Je.includes("biryani")||Je.includes("khichdi")||Je.includes("dal")||Je.includes("rajma")||Je.includes("chole")?["1 bowl","1 plate","1 cup","2 cups"]:Je.includes("samosa")||Je.includes("pakora")||Je.includes("momos")||Je.includes("spring roll")?["1 piece","2 pieces","3 pieces","5 pieces","1 plate"]:Je.includes("idli")||Je.includes("dosa")||Je.includes("vada")?["1 piece","2 pieces","3 pieces","1 plate"]:Je.includes("pizza")||Je.includes("burger")?["1 slice","2 slices","1 whole","1 medium","1 large"]:Je.includes("chicken")||Je.includes("paneer")||Je.includes("tikka")?["1 bowl","1 plate","100g","150g","200g"]:Je.includes("pasta")||Je.includes("noodles")||Je.includes("manchurian")?["1 bowl","1 plate","1 cup"]:Je.includes("salad")||Je.includes("sandwich")?["1 bowl","1 plate","1 piece","1 full"]:["1 bowl","1 plate","1 piece","100g","150g"]},[he,Ae]=j.useState([]),[fe,le]=j.useState(!1),[we,re]=j.useState("breakfast");j.useEffect(()=>{var De;const Fe=sessionStorage.getItem("foodScanResult"),Je=sessionStorage.getItem("foodScanImage");if(console.log("Checking for persisted data...",{hasResult:!!Fe,hasImage:!!Je}),Fe)try{const it=JSON.parse(Fe);console.log(" Recovered persisted result:",(De=it.foodItem)==null?void 0:De.name),X(it),F(!0),Je&&D(Je),sessionStorage.removeItem("foodScanResult"),sessionStorage.removeItem("foodScanImage"),Ve.success("Food analysis recovered!",{duration:2e3})}catch(it){console.error(" Failed to recover persisted result:",it),sessionStorage.removeItem("foodScanResult"),sessionStorage.removeItem("foodScanImage")}},[]),j.useEffect(()=>{if(P){console.log(" Blocking navigation - analysis in progress");const Fe=De=>{De.preventDefault(),De.returnValue=""};window.addEventListener("beforeunload",Fe);const Je=De=>{De.preventDefault(),window.history.pushState(null,"",window.location.pathname),Ve.error("Please wait for analysis to complete")};return window.addEventListener("popstate",Je),window.history.pushState(null,"",window.location.pathname),()=>{window.removeEventListener("beforeunload",Fe),window.removeEventListener("popstate",Je)}}},[P,u]),j.useEffect(()=>{var Fe;if(G&&k)return console.log("Modal is now visible with result:",(Fe=k.foodItem)==null?void 0:Fe.name),document.body.style.overflow="hidden",()=>{document.body.style.overflow="unset"}},[G,k]);const oe=Fe=>{const Je=Fe.target.value;if(x(Je),Je.trim().length>0){const De=Ne.filter(it=>it.toLowerCase().includes(Je.toLowerCase()));Q(De.slice(0,5)),ue(De.length>0),Ae(pe(Je))}else ue(!1),Q([]),Ae([])},J=Fe=>{x(Fe),ue(!1),Q([]),Ae(pe(Fe))},Oe=async Fe=>new Promise((Je,De)=>{const it=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),gs=Fe.size>5*1024*1024;let Gt=.5,Ss=800;it?(Gt=gs?.3:.4,Ss=gs?640:800):gs&&(Gt=.4,Ss=960),console.log(" AGGRESSIVE Compression settings:",{isMobile:it,targetQuality:Gt,maxDimension:Ss,originalSize:(Fe.size/1024).toFixed(2)+" KB"});const pn=new FileReader;pn.readAsDataURL(Fe),pn.onload=Zn=>{const tn=new Image;tn.src=Zn.target.result,tn.onload=()=>{try{const mn=document.createElement("canvas");let hs=tn.width,ze=tn.height;hs>ze?hs>Ss&&(ze=Math.round(ze*Ss/hs),hs=Ss):ze>Ss&&(hs=Math.round(hs*Ss/ze),ze=Ss),console.log(" Resizing from",tn.width,"x",tn.height,"to",hs,"x",ze),mn.width=hs,mn.height=ze;const It=mn.getContext("2d",{alpha:!1,willReadFrequently:!1});It.imageSmoothingEnabled=!0,It.imageSmoothingQuality="low",It.drawImage(tn,0,0,hs,ze),mn.toBlob(wt=>{if(!wt){De(new Error("Failed to compress image"));return}const ft=new File([wt],Fe.name,{type:"image/jpeg",lastModified:Date.now()});console.log(" Original size:",(Fe.size/1024).toFixed(2),"KB"),console.log(" Compressed size:",(ft.size/1024).toFixed(2),"KB"),console.log(" Compression ratio:",((1-ft.size/Fe.size)*100).toFixed(1),"%"),mn.width=0,mn.height=0,It.clearRect(0,0,1,1),tn.src="",tn.onload=null,pn.onload=null,window.gc&&window.gc(),Je(ft)},"image/jpeg",Gt)}catch(mn){console.error("Compression error:",mn),De(mn)}},tn.onerror=()=>{pn.onload=null,De(new Error("Failed to load image"))}},pn.onerror=()=>{pn.onload=null,De(new Error("Failed to read file"))}}),$e=async Fe=>{Fe.preventDefault(),Fe.stopPropagation();const Je=Fe.target.files[0];if(Je){if(Je.size>100*1024*1024){Ve.error("Image too large. Please use an image smaller than 100MB");return}ae(!0);const De=Ve.loading("Compressing image...");try{await new Promise(Ss=>setTimeout(Ss,100));const it=await Oe(Je),gs=3*1024*1024;if(it.size>gs){Ve.error(`Image still too large (${(it.size/1024/1024).toFixed(1)}MB). Try a smaller image or type the food name.`,{id:De}),ae(!1);return}Ve.success(`Image ready! ${(it.size/1024).toFixed(0)}KB`,{id:De}),E(it);const Gt=new FileReader;Gt.onloadend=()=>{R(Gt.result),Gt.onloadend=null,Gt.onerror=null},Gt.onerror=()=>{Ve.error("Failed to preview image"),Gt.onloadend=null,Gt.onerror=null},Gt.readAsDataURL(it)}catch(it){console.error("Compression error:",it),Ve.error("Failed to compress image. Please try a different image.",{id:De})}finally{ae(!1)}}Fe.target.value=""},He=async Fe=>{B(!0);try{const Je=localStorage.getItem("token"),De=await ks.get(`/api/nutrition/food-image?foodName=${encodeURIComponent(Fe)}`,{headers:{Authorization:`Bearer ${Je}`}});if(De.data.success&&De.data.imageUrl){D(De.data.imageUrl);try{sessionStorage.setItem("foodScanImage",De.data.imageUrl)}catch{console.warn("Failed to persist food image")}}}catch(Je){console.error("Failed to fetch food image:",Je)}finally{B(!1)}},ot=async()=>{var it,gs,Gt,Ss,pn,Zn,tn,mn;if(!f.trim()&&!_){Ve.error("Please enter a food item or upload an image");return}if(_&&!Z.quantity&&!Z.prepMethod){Ve.error("Please provide quantity and preparation method for the image");return}const Fe=localStorage.getItem("token");if(!Fe){Ve.error("Please login to use this feature"),setTimeout(()=>{window.location.href="/login"},1500);return}U(!0),D(null);let Je=null,De=!1;try{let hs=null;if(_){console.log("Converting image to base64..."),console.log("Image size:",(_.size/1024).toFixed(2),"KB");const ft=new FileReader;hs=await new Promise((Os,Kn)=>{ft.onloadend=()=>{const Ye=ft.result.split(",")[1];console.log("Base64 conversion complete. Size:",(Ye.length*.75/1024).toFixed(2),"KB"),ft.onloadend=null,ft.onerror=null,Os(Ye)},ft.onerror=Ye=>{console.error("FileReader error:",Ye),ft.onloadend=null,ft.onerror=null,Kn(Ye)},ft.readAsDataURL(_)})}let ze="";if(_&&(Z.quantity||Z.prepMethod||Z.additionalInfo)){const ft=[];Z.quantity&&ft.push(`Quantity: ${Z.quantity}`),Z.prepMethod&&ft.push(`Preparation: ${Z.prepMethod}`),Z.additionalInfo&&ft.push(Z.additionalInfo),f&&ft.push(`Additional info: ${f}`),ze=ft.join(", ")}else ze=f;console.log("Sending analysis request..."),console.log("Token present:",!!Fe),console.log("Has image:",!!hs),console.log("Context text:",ze);const It=localStorage.getItem("token");if(!It)throw new Error("Session expired during processing. Please login again.");const wt=await ks.post("/api/nutrition/quick-check",{foodDescription:f||"Food from image",imageBase64:hs,additionalContext:ze},{headers:{Authorization:`Bearer ${It}`},timeout:6e4,skipAutoLogout:!0});if(console.log("API Response received:",wt.data),hs=null,!wt.data||!wt.data.data)throw new Error("Invalid response from server");Je=wt.data.data,De=!0,console.log("Analysis successful, persisting result...");try{sessionStorage.setItem("foodScanResult",JSON.stringify(Je)),console.log(" Result persisted to sessionStorage")}catch(ft){console.warn(" Failed to persist result:",ft);try{localStorage.setItem("foodScanResult",JSON.stringify(Je)),console.log(" Result persisted to localStorage (fallback)")}catch{console.error(" Both storage methods failed")}}console.log("Setting state now..."),X(Je),F(!0),U(!1),console.log(" State updated, modal should be visible"),console.log("Modal state:",{showResultModal:!0,hasResult:!!Je}),(it=Je==null?void 0:Je.foodItem)!=null&&it.name&&He(Je.foodItem.name).then(()=>{if(q)try{sessionStorage.setItem("foodScanImage",q)}catch{console.warn("Failed to persist food image")}}),Ve.success("Food analyzed!");return}catch(hs){if(console.error("Analysis error:",hs),console.error("Error response:",hs.response),console.error("Error status:",(gs=hs.response)==null?void 0:gs.status),U(!1),((Gt=hs.response)==null?void 0:Gt.status)===401){Ve.error("Session expired. Please login again.",{duration:5e3}),setTimeout(()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/login"},2e3);return}((Ss=hs.response)==null?void 0:Ss.status)===400&&((Zn=(pn=hs.response)==null?void 0:pn.data)==null?void 0:Zn.error)==="UNABLE_TO_DETECT_FOOD"?(E(null),R(null),Ve.error("Could not detect food in image. Please type the food name for accurate results.",{duration:5e3})):hs.code==="ECONNABORTED"?Ve.error("Request timeout. Please try again or use text description."):hs.message&&hs.message.includes("memory")?(Ve.error("Image too large for device. Please try a smaller image or type the food name."),E(null),R(null)):hs.message&&hs.message.includes("Network Error")?Ve.error("Network error. Please check your connection and try again."):Ve.error(((mn=(tn=hs.response)==null?void 0:tn.data)==null?void 0:mn.message)||"Failed to analyze food. Please try again.")}},_t=()=>{console.log("Resetting form..."),F(!1),X(null),D(null),x(""),E(null),R(null),te({quantity:"",prepMethod:"",additionalInfo:""}),le(!1),re("breakfast"),sessionStorage.removeItem("foodScanResult"),sessionStorage.removeItem("foodScanImage"),localStorage.removeItem("foodScanResult"),localStorage.removeItem("foodScanImage"),window.gc&&window.gc()},Ke=()=>{le(!0)},ht=async()=>{var Fe,Je;try{const De=localStorage.getItem("token"),it={name:((Fe=k.foodItem)==null?void 0:Fe.name)||"Food from scan",quantity:Z.quantity||"1 serving",nutrition:((Je=k.foodItem)==null?void 0:Je.nutrition)||{},notes:Z.prepMethod?`Preparation: ${Z.prepMethod}`:""};console.log("Logging meal with user input:",{quantity:Z.quantity,prepMethod:Z.prepMethod,foodItem:it}),(await ks.post("/api/nutrition/log-meal",{mealType:we,foodItems:[it],notes:"Logged from Quick Food Scan",timestamp:new Date},{headers:{Authorization:`Bearer ${De}`},skipAutoLogout:!0})).data.success&&(Ve.success(`Meal logged to ${we}! `),le(!1),_t(),setTimeout(()=>{u("/nutrition#daily-target")},1e3))}catch(De){console.error("Log meal error:",De),Ve.error("Failed to log meal. Please try again.")}};return a.jsxs("div",{className:"min-h-screen bg-[#f8fafc] flex flex-col font-sans selection:bg-blue-100",children:[a.jsx("div",{className:"w-full px-6 py-5 bg-white/70 backdrop-blur-xl border-b border-white/40 sticky top-0 z-[100] shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)]",children:a.jsxs("div",{className:"max-w-4xl mx-auto flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("button",{onClick:()=>u(-1),className:"group p-2.5 bg-white rounded-2xl shadow-sm border border-slate-100 hover:bg-slate-50 transition-all active:scale-95",children:a.jsx(dn,{className:"w-5 h-5 text-slate-600 group-hover:text-blue-600 transition-colors"})}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-xl font-extrabold text-[#1e293b] leading-tight tracking-tight",children:"Food Scanner"}),a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"}),a.jsx("p",{className:"text-[11px] font-bold text-slate-500 uppercase tracking-wider",children:"AI Nutrition Analysis"})]})]})]}),a.jsx("div",{className:"flex items-center gap-3",children:a.jsx("div",{className:"bg-blue-50/80 p-2 rounded-xl border border-blue-100",children:a.jsx(l2,{className:"w-5 h-5 text-blue-600"})})})]})}),a.jsx("div",{className:"flex-1 overflow-y-auto pb-32",children:a.jsxs("div",{className:"max-w-4xl mx-auto px-5 py-8 space-y-8",children:[!y&&a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"relative group",children:[a.jsx("div",{className:"absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-[2rem] blur opacity-20 group-hover:opacity-30 transition duration-1000"}),a.jsxs("div",{className:"relative bg-white rounded-[2rem] p-6 sm:p-8 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.08)] border border-slate-100",children:[!f.trim()&&!y&&a.jsxs("div",{className:"flex flex-col items-center text-center mb-8 animate-in fade-in zoom-in duration-500",children:[a.jsx("div",{className:"w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-4 border border-blue-100/50",children:a.jsx(_P,{className:"w-8 h-8 text-blue-600"})}),a.jsx("h2",{className:"text-2xl font-black text-[#1e293b] mb-2",children:"Track Your Meal"}),a.jsx("p",{className:"text-slate-500 text-sm max-w-[280px]",children:"Take a photo or type what you ate for instant nutritional insights."})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"absolute left-4 top-1/2 -translate-y-1/2 bg-blue-50 p-1.5 rounded-lg border border-blue-100",children:a.jsx(vo,{className:"w-4 h-4 text-blue-500"})}),a.jsx("input",{type:"text",value:f,onChange:oe,onFocus:()=>{f.trim()&&be.length>0&&ue(!0)},placeholder:"What's on your plate?",className:"w-full pl-14 pr-4 py-6 bg-slate-50/50 border-2 border-blue-400 rounded-2xl focus:outline-none focus:border-blue-600 focus:bg-white transition-all text-xl text-slate-800 font-black placeholder-slate-400 shadow-xl"}),ie&&be.length>0&&a.jsx("div",{className:"absolute z-[110] w-full mt-2 bg-white/95 backdrop-blur-md border border-slate-200 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in slide-in-from-top-2",children:be.map((Fe,Je)=>a.jsxs("button",{onClick:()=>J(Fe),className:"w-full px-5 py-3.5 text-left hover:bg-blue-50 transition-colors text-sm font-semibold text-slate-700 flex items-center gap-3 border-b border-slate-50 last:border-0",children:[a.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400"}),Fe]},Je))})]}),a.jsxs("div",{className:"flex items-center gap-4 py-2",children:[a.jsx("div",{className:"flex-1 h-[1px] bg-slate-100"}),a.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]",children:"OR"}),a.jsx("div",{className:"flex-1 h-[1px] bg-slate-100"})]}),a.jsxs("div",{children:[a.jsx("input",{id:"camera-input",type:"file",accept:"image/*",capture:"environment",onChange:$e,className:"hidden",disabled:ne}),a.jsxs("button",{onClick:()=>document.getElementById("camera-input").click(),disabled:ne,className:"w-full group relative overflow-hidden py-5 bg-slate-900 text-white rounded-2xl font-bold text-sm tracking-wide transition-all active:scale-[0.98] shadow-xl hover:shadow-2xl hover:bg-slate-800 disabled:opacity-75",children:[a.jsx("div",{className:"relative z-10 flex items-center justify-center gap-3",children:ne?a.jsxs(a.Fragment,{children:[a.jsx(uc,{className:"w-5 h-5 animate-spin text-blue-400"}),a.jsx("span",{children:"Optimizing Image..."})]}):a.jsxs(a.Fragment,{children:[a.jsx(FE,{className:"w-5 h-5 group-hover:scale-110 transition-transform"}),a.jsx("span",{children:"Scan Food with Camera"})]})}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-600/20 to-cyan-500/20 opacity-0 group-hover:opacity-100 transition-opacity"})]})]})]})]})]}),!f.trim()&&!y&&a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"bg-emerald-50/50 p-4 rounded-3xl border border-emerald-100 flex flex-col gap-2",children:[a.jsx("div",{className:"w-8 h-8 bg-emerald-100 rounded-xl flex items-center justify-center",children:a.jsx(qi,{className:"w-4 h-4 text-emerald-600"})}),a.jsx("p",{className:"text-xs font-bold text-emerald-900",children:"Track Calories"}),a.jsx("p",{className:"text-[10px] text-emerald-700/80 leading-snug",children:"Instantly see the energy content of your meals."})]}),a.jsxs("div",{className:"bg-amber-50/50 p-4 rounded-3xl border border-amber-100 flex flex-col gap-2",children:[a.jsx("div",{className:"w-8 h-8 bg-amber-100 rounded-xl flex items-center justify-center",children:a.jsx(zr,{className:"w-4 h-4 text-amber-600"})}),a.jsx("p",{className:"text-xs font-bold text-amber-900",children:"Health Score"}),a.jsx("p",{className:"text-[10px] text-amber-700/80 leading-snug",children:"Know how healthy your food choices are."})]})]})]}),(f.trim()||y)&&a.jsxs("div",{className:"space-y-6 animate-in slide-in-from-bottom-4 duration-500",children:[y&&a.jsxs("div",{className:"relative group",children:[a.jsx("div",{className:"absolute -inset-1 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-[2.2rem] blur opacity-10"}),a.jsxs("div",{className:"relative rounded-[2rem] overflow-hidden border-4 border-white shadow-2xl",children:[a.jsx("img",{src:y,alt:"Scanned Food",className:"w-full h-72 object-cover transition-transform duration-700 group-hover:scale-105"}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-60"}),a.jsx("button",{onClick:()=>{E(null),R(null),te({quantity:"",prepMethod:"",additionalInfo:""})},className:"absolute top-4 right-4 p-2.5 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl hover:bg-red-50 hover:text-red-500 transition-all active:scale-95",children:a.jsx(ra,{className:"w-5 h-5"})}),a.jsx("div",{className:"absolute bottom-4 left-4 flex items-center gap-2",children:a.jsxs("div",{className:"bg-white/95 backdrop-blur-md text-blue-600 px-4 py-2 rounded-2xl text-[11px] font-black uppercase tracking-wider shadow-lg flex items-center gap-2",children:[a.jsx(Hs,{className:"w-4 h-4"}),"Image Ready"]})})]})]}),a.jsxs("div",{className:"bg-white rounded-[2rem] p-6 sm:p-8 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.06)] border border-slate-100 space-y-6",children:[a.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[a.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center",children:a.jsx(qi,{className:"w-5 h-5 text-blue-600"})}),a.jsx("h3",{className:"text-xl font-extrabold text-[#1e293b]",children:"Refine Details"})]}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1",children:"Serving Quantity"}),a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:(he.length>0?he:["1 serving","1 bowl","1 plate","100g"]).map((Fe,Je)=>a.jsx("button",{type:"button",onClick:()=>te({...Z,quantity:Fe}),className:`px-3 py-2 rounded-xl text-[11px] font-bold transition-all border-2 ${Z.quantity===Fe?"bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200":"bg-white border-slate-100 text-slate-600 hover:border-blue-200"}`,children:Fe},Je))}),a.jsx("input",{type:"text",value:Z.quantity,onChange:Fe=>te({...Z,quantity:Fe.target.value}),placeholder:"Or specify exact amount",className:"w-full px-5 py-3.5 bg-slate-50/80 border-2 border-blue-200 rounded-xl focus:outline-none focus:border-blue-600 focus:bg-white transition-all text-sm font-semibold text-slate-800 placeholder-slate-400"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-1",children:"Preparation Method"}),a.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-6 gap-2",children:[{label:"Fried",icon:""},{label:"Baked",icon:""},{label:"Grilled",icon:""},{label:"Home",icon:""},{label:"Dine-in",icon:""},{label:"Packaged",icon:""}].map(Fe=>a.jsxs("button",{type:"button",onClick:()=>te({...Z,prepMethod:Fe.label}),className:`p-2.5 rounded-xl transition-all border-2 flex flex-col items-center gap-1.5 ${Z.prepMethod===Fe.label?"bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200":"bg-white border-slate-100 text-slate-600 hover:border-blue-200"}`,children:[a.jsx("span",{className:"text-lg leading-none",children:Fe.icon}),a.jsx("span",{className:"text-[9px] font-black uppercase tracking-tighter",children:Fe.label})]},Fe.label))})]}),a.jsx("div",{className:"pt-4",children:a.jsxs("button",{onClick:ot,disabled:P,className:"w-full group relative overflow-hidden py-5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-[2rem] font-black text-base tracking-widest transition-all active:scale-[0.98] shadow-[0_20px_40px_-12px_rgba(59,130,246,0.3)] disabled:opacity-50",children:[a.jsx("div",{className:"relative z-10 flex items-center justify-center gap-3 uppercase",children:P?a.jsxs(a.Fragment,{children:[a.jsx(uc,{className:"w-5 h-5 animate-spin"}),a.jsx("span",{children:"Processing..."})]}):a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:"w-5 h-5 group-hover:animate-pulse"}),a.jsx("span",{children:"Analyze Now"})]})}),a.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1 bg-white/20 transform translate-y-2 group-hover:translate-y-0 transition-transform"})]})})]})]})]}),a.jsx("div",{className:"max-w-md mx-auto text-center",children:a.jsxs("div",{className:"inline-flex items-center gap-2 px-6 py-3 bg-blue-50/50 backdrop-blur-sm rounded-full border border-blue-100 group",children:[a.jsx(vo,{className:"w-4 h-4 text-blue-500 group-hover:rotate-12 transition-transform"}),a.jsx("p",{className:"text-[11px] font-semibold text-blue-800 tracking-wide",children:"AI analysis is an estimate. Portions may impact accuracy."})]})})]})}),G&&k&&a.jsx("div",{className:"fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[200] overflow-y-auto px-4 py-8",onClick:Fe=>{Fe.target===Fe.currentTarget&&_t()},children:a.jsxs("div",{className:"max-w-2xl mx-auto bg-white rounded-[2.5rem] shadow-[0_32px_64px_-12px_rgba(0,0,0,0.2)] overflow-hidden relative animate-in zoom-in-95 duration-300",onClick:Fe=>Fe.stopPropagation(),children:[a.jsx("div",{className:"relative p-8 pb-0",children:a.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-8",children:[a.jsxs("div",{className:"flex items-center gap-6",children:[a.jsxs("div",{className:"relative w-32 h-32 flex-shrink-0",children:[a.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[a.jsx("circle",{cx:"64",cy:"64",r:"58",stroke:"#f1f5f9",strokeWidth:"10",fill:"none"}),a.jsx("circle",{cx:"64",cy:"64",r:"58",stroke:k.healthScore10>=7?"#10b981":k.healthScore10>=4?"#f59e0b":"#ef4444",strokeWidth:"10",fill:"none",strokeDasharray:364.4,strokeDashoffset:364.4-(k.healthScore10||k.healthScore/10)*36.44,strokeLinecap:"round",className:"transition-all duration-1000 ease-out"})]}),a.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[a.jsx("span",{className:"text-4xl font-black text-slate-800",children:k.healthScore10||(k.healthScore/10).toFixed(1)}),a.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:"Score"})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:`inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 ${k.isHealthy?"bg-emerald-100 text-emerald-700":"bg-rose-100 text-rose-700"}`,children:[k.isHealthy?a.jsx(Hs,{className:"w-3 h-3"}):a.jsx(hn,{className:"w-3 h-3"}),k.isHealthy?"Healthy Choice":"Watch Portions"]}),a.jsx("h2",{className:"text-3xl font-black text-slate-800 leading-tight mb-1",children:(st=k.foodItem)==null?void 0:st.name}),a.jsxs("p",{className:"text-slate-500 font-bold flex items-center gap-2 uppercase text-[11px] tracking-widest",children:[a.jsx(zr,{className:"w-4 h-4 text-purple-500"}),((ct=k.foodItem)==null?void 0:ct.quantity)||"Standard Serving"]})]})]}),a.jsx("div",{className:"flex md:flex-col gap-2",children:a.jsx("button",{onClick:_t,className:"p-3 bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-all active:scale-95",children:a.jsx(ra,{className:"w-6 h-6"})})})]})}),a.jsx("div",{className:"px-8 mt-10",children:a.jsxs("div",{className:"bg-slate-50 rounded-[2.5rem] p-8 border border-slate-100 shadow-inner",children:[a.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6",children:[{label:"Calories",value:(ys=(fs=k.foodItem)==null?void 0:fs.nutrition)==null?void 0:ys.calories,icon:qi,color:"text-orange-500",bg:"bg-orange-100",b:"border-orange-200"},{label:"Protein",value:(zs=(As=k.foodItem)==null?void 0:As.nutrition)==null?void 0:zs.protein,icon:zr,color:"text-blue-500",bg:"bg-blue-100",b:"border-blue-200"},{label:"Carbs",value:(Ze=(je=k.foodItem)==null?void 0:je.nutrition)==null?void 0:Ze.carbs,icon:ms,color:"text-emerald-500",bg:"bg-emerald-100",b:"border-emerald-200"},{label:"Fats",value:(zt=(Ct=k.foodItem)==null?void 0:Ct.nutrition)==null?void 0:zt.fats,icon:zn,color:"text-rose-500",bg:"bg-rose-100",b:"border-rose-200"}].map(Fe=>{const Je=Fe.icon;return a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsx("div",{className:`w-14 h-14 rounded-2xl ${Fe.bg} flex items-center justify-center mb-3 shadow-sm border ${Fe.b}`,children:a.jsx(Je,{className:`w-7 h-7 ${Fe.color}`})}),a.jsx("span",{className:"text-sm font-black text-slate-800",children:Fe.value||0}),a.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:Fe.label})]},Fe.label)})}),a.jsx("div",{className:"flex flex-wrap justify-center gap-6 mt-8 pt-8 border-t border-slate-200",children:[{label:"Fiber",value:(ge=(ts=k.foodItem)==null?void 0:ts.nutrition)==null?void 0:ge.fiber,unit:"g"},{label:"Sugar",value:(rt=(We=k.foodItem)==null?void 0:We.nutrition)==null?void 0:rt.sugar,unit:"g"},{label:"Sodium",value:(Cn=(ws=k.foodItem)==null?void 0:ws.nutrition)==null?void 0:Cn.sodium,unit:"mg"}].map(Fe=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-300"}),a.jsxs("span",{className:"text-[11px] font-bold text-slate-500 uppercase tracking-widest",children:[Fe.label,":"]}),a.jsxs("span",{className:"text-xs font-black text-slate-800",children:[Fe.value||0,Fe.unit]})]},Fe.label))})]})}),a.jsxs("div",{className:"px-8 py-10 space-y-10",children:[a.jsxs("div",{className:"relative group",children:[a.jsx("div",{className:"absolute -inset-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-[2.5rem] opacity-0 group-hover:opacity-100 transition-opacity"}),a.jsxs("div",{className:"relative",children:[a.jsxs("h3",{className:"text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2",children:[a.jsx(PE,{className:"w-4 h-4 text-blue-500"}),"Medical Analysis"]}),a.jsx("div",{className:"bg-white rounded-3xl p-6 border border-slate-100 shadow-sm",children:a.jsx("p",{className:"text-slate-600 font-medium leading-relaxed",children:k.analysis})})]})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[k.enhancementTips&&k.enhancementTips.length>0&&a.jsxs("div",{children:[a.jsxs("h3",{className:"text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2",children:[a.jsx(bo,{className:"w-4 h-4 text-amber-500"}),"Optimize Meal"]}),a.jsx("div",{className:"space-y-3",children:k.enhancementTips.map((Fe,Je)=>a.jsxs("div",{className:"flex items-start gap-4 p-4 bg-amber-50/50 rounded-2xl border border-amber-100 group hover:bg-amber-50 transition-colors",children:[a.jsx("div",{className:"w-8 h-8 rounded-xl bg-white flex items-center justify-center shrink-0 shadow-sm",children:a.jsx(vi,{className:"w-4 h-4 text-amber-600"})}),a.jsx("p",{className:"text-xs font-bold text-amber-900 leading-tight pt-1.5",children:Fe})]},Je))})]}),k.micronutrients&&k.micronutrients.length>0&&a.jsxs("div",{children:[a.jsxs("h3",{className:"text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2",children:[a.jsx(ms,{className:"w-4 h-4 text-emerald-500"}),"Essential Nutrients"]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:k.micronutrients.map((Fe,Je)=>a.jsxs("div",{className:"px-4 py-3 bg-emerald-50 rounded-2xl border border-emerald-100 flex items-center gap-2",children:[a.jsx(Hs,{className:"w-3 h-3 text-emerald-500"}),a.jsx("span",{className:"text-[11px] font-black text-emerald-800 uppercase tracking-wider",children:Fe})]},Je))})]})]})]}),k.warnings&&k.warnings.length>0&&a.jsxs("div",{className:"space-y-4",children:[a.jsx("h3",{className:"text-xs font-black text-slate-400 uppercase tracking-widest ml-1",children:"Nutritional Alerts"}),a.jsx("div",{className:"grid gap-3",children:k.warnings.map((Fe,Je)=>a.jsxs("div",{className:"bg-rose-50/50 border border-rose-100 rounded-2xl p-4 flex items-center gap-4 group",children:[a.jsx("div",{className:"w-10 h-10 bg-rose-100 rounded-xl flex items-center justify-center shrink-0 group-hover:rotate-12 transition-transform",children:a.jsx(hn,{className:"w-5 h-5 text-rose-600"})}),a.jsx("p",{className:"text-xs font-bold text-rose-900 leading-tight",children:Fe})]},Je))})]}),k.alternatives&&k.alternatives.length>0&&a.jsxs("div",{className:"space-y-4 px-8 pb-10",children:[a.jsxs("h3",{className:"text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 flex items-center gap-2",children:[a.jsx(qi,{className:"w-4 h-4 text-emerald-500"}),"Smart Alternatives"]}),a.jsx("div",{className:"flex overflow-x-auto scrollbar-hide gap-5 -mx-8 px-8",children:k.alternatives.map((Fe,Je)=>{var De;return a.jsxs("div",{className:"min-w-[280px] group bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all",children:[a.jsxs("div",{className:"flex items-start justify-between mb-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-black text-slate-800 text-base leading-tight group-hover:text-emerald-600 transition-colors uppercase tracking-tight",children:Fe.name}),a.jsxs("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:[Fe.prepTime||"Quick"," Prep"]})]}),a.jsxs("div",{className:"bg-emerald-50 text-emerald-600 text-[11px] font-black px-3 py-1.5 rounded-xl border border-emerald-100",children:[(De=Fe.nutrition)==null?void 0:De.calories," Kcal"]})]}),a.jsxs("p",{className:"text-xs text-slate-500 font-medium leading-relaxed mb-6 line-clamp-2 italic",children:['"',Fe.description,'"']}),a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-slate-50",children:[a.jsx("div",{className:"flex gap-2",children:a.jsx("div",{className:"px-2 py-1 bg-blue-50 text-blue-600 text-[9px] font-black rounded-lg uppercase",children:"High Prot"})}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[9px] font-black text-slate-400 uppercase tracking-widest",children:"Satiety"}),a.jsxs("span",{className:"text-xs font-black text-slate-800",children:[Fe.satietyScore||8,"/10"]})]})]})]},Je)})})]}),a.jsxs("div",{className:"flex gap-4 pt-6",children:[a.jsx("button",{onClick:_t,className:"flex-1 py-5 bg-slate-100 text-slate-600 rounded-[2rem] font-black text-sm uppercase tracking-widest hover:bg-slate-200 transition-all active:scale-95",children:"Discard"}),a.jsxs("button",{onClick:Ke,className:"flex-[2] py-5 bg-[#1e293b] text-white rounded-[2rem] font-black text-sm uppercase tracking-widest shadow-2xl hover:bg-slate-800 transition-all active:scale-95 flex items-center justify-center gap-3",children:[a.jsx(Hs,{className:"w-5 h-5 text-blue-400"}),"Add to Diary"]})]})]})}),fe&&a.jsx("div",{className:"fixed inset-0 bg-black/60 z-[10001] flex items-end sm:items-center justify-center",onClick:()=>le(!1),children:a.jsxs("div",{className:"bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl p-6",onClick:Fe=>Fe.stopPropagation(),children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Select Meal Type"}),a.jsx("button",{onClick:()=>le(!1),className:"p-2 hover:bg-gray-100 rounded-full",children:a.jsx(ra,{className:"w-5 h-5 text-gray-700"})})]}),a.jsx("div",{className:"space-y-3 mb-6",children:[{type:"breakfast",icon:"",label:"Breakfast",color:"from-orange-400 to-yellow-400"},{type:"lunch",icon:"",label:"Lunch",color:"from-yellow-400 to-amber-400"},{type:"dinner",icon:"",label:"Dinner",color:"from-indigo-400 to-purple-400"},{type:"snack",icon:"",label:"Snacks",color:"from-green-400 to-emerald-400"}].map(Fe=>a.jsxs("button",{onClick:()=>re(Fe.type),className:`w-full p-4 rounded-xl flex items-center gap-4 transition-all ${we===Fe.type?`bg-gradient-to-r ${Fe.color} text-white shadow-lg scale-105`:"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[a.jsx("span",{className:"text-3xl",children:Fe.icon}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("p",{className:"font-bold text-lg",children:Fe.label})}),we===Fe.type&&a.jsx(Hs,{className:"w-6 h-6"})]},Fe.type))}),a.jsxs("button",{onClick:ht,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg transition-all",children:["Log to ",we.charAt(0).toUpperCase()+we.slice(1)]})]})}),P&&a.jsxs("div",{className:"fixed inset-0 bg-slate-900 z-[10000] flex items-center justify-center overflow-hidden",style:{position:"fixed",top:0,left:0,right:0,bottom:0,touchAction:"none"},children:[a.jsxs("div",{className:"absolute top-0 left-0 w-full h-full",children:[a.jsx("div",{className:"absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[120px] animate-pulse"}),a.jsx("div",{className:"absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-600/20 rounded-full blur-[120px] animate-pulse",style:{animationDelay:"1s"}})]}),a.jsxs("div",{className:"relative text-center px-8 w-full max-w-lg",children:[a.jsx("div",{className:"relative mb-12",children:a.jsxs("div",{className:"w-48 h-48 mx-auto relative",children:[a.jsx("div",{className:"absolute inset-0 border-[3px] border-dashed border-blue-400/30 rounded-full animate-spin",style:{animationDuration:"8s"}}),a.jsx("div",{className:"absolute inset-4 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full p-1 shadow-[0_0_50px_rgba(59,130,246,0.5)]",children:a.jsxs("div",{className:"w-full h-full bg-slate-900 rounded-full flex items-center justify-center overflow-hidden",children:[a.jsx("div",{className:"absolute inset-x-0 h-1 bg-blue-400/50 blur-sm animate-[scan_2s_linear_infinite]"}),a.jsx(_P,{className:"w-16 h-16 text-blue-400 drop-shadow-[0_0_10px_rgba(96,165,250,0.8)]"})]})})]})}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("h2",{className:"text-4xl font-black text-white tracking-tighter",children:["Scanning ",a.jsx("span",{className:"text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300",children:"Nutrition"})]}),a.jsx("p",{className:"text-slate-400 font-bold text-sm uppercase tracking-[0.3em]",children:"AI processing active"})]}),a.jsx("div",{className:"mt-12 space-y-3 bg-white/5 backdrop-blur-md rounded-[2.5rem] p-8 border border-white/10 shadow-2xl",children:[{text:"Optimizing high-res capture",active:!1,done:!0},{text:"Neural food recognition",active:!0,done:!1},{text:"Cross-referencing database",active:!1,done:!1},{text:"Calculating health impact",active:!1,done:!1}].map((Fe,Je)=>a.jsxs("div",{className:`flex items-center gap-4 transition-opacity duration-500 ${Fe.done||Fe.active?"opacity-100":"opacity-20"}`,children:[Fe.done?a.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-400 shadow-[0_0_10px_rgba(96,165,250,1)]"}):Fe.active?a.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-400 animate-ping"}):a.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-600"}),a.jsx("span",{className:`text-xs font-bold uppercase tracking-widest ${Fe.active?"text-blue-400":"text-slate-300"}`,children:Fe.text})]},Je))}),a.jsxs("div",{className:"mt-8 flex items-center justify-center gap-3",children:[a.jsx(vo,{className:"w-4 h-4 text-blue-400"}),a.jsx("p",{className:"text-[10px] font-black text-slate-500 uppercase tracking-widest leading-loose",children:"DO NOT DISCONNECT  ANALYZING COMPOSITION"})]})]}),a.jsx("style",{dangerouslySetInnerHTML:{__html:`
                @keyframes scan {
                  0% { transform: translateY(-100%); opacity: 0; }
                  50% { opacity: 1; }
                  100% { transform: translateY(100%); opacity: 0; }
                }
                .scrollbar-hide::-webkit-scrollbar { display: none; }
                .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
              `}})]})]})}const aee=({isOpen:u,onClose:f,onSave:x})=>{const[_,E]=j.useState(150),[y,R]=j.useState("fasting"),P=new Date;P.setMinutes(P.getMinutes()-P.getTimezoneOffset());const[U,G]=j.useState(P.toISOString().slice(0,16)),F=j.useRef(null),k=j.useRef(!1),X=40,q=400;j.useEffect(()=>{if(u&&F.current){const Ne=(_-X)*8-F.current.clientWidth/2;F.current.scrollLeft=Math.max(0,Ne)}},[u]);const D=()=>{if(!F.current)return;const ue=8,Ne=F.current.scrollLeft,be=F.current.clientWidth/2,Q=Math.round((Ne+be)/ue)+X;Q>=X&&Q<=q&&E(Q)},H=ue=>{const Ne=parseInt(ue.target.value);if(isNaN(Ne))E("");else if(E(Ne),F.current&&Ne>=X&&Ne<=q){const Q=(Ne-X)*8-F.current.clientWidth/2;F.current.scrollLeft=Math.max(0,Q)}},B=ue=>{E(Ne=>{const be=Math.min(Math.max(Ne+ue,X),q);if(F.current){const pe=(be-X)*8-F.current.clientWidth/2;F.current.scrollLeft=Math.max(0,pe)}return be})},ne=()=>{const ue={value:_,type:y,time:new Date(U).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),timestamp:new Date(U).toISOString()};x(ue),f(),E(150),R("fasting")},ae=()=>_>=70&&_<=130?"text-slate-800":_>130?"text-red-600":"text-yellow-600";if(!u)return null;const Z=[{id:"fasting",label:"Fasting",description:"Reading taken after an overnight fast",icon:a.jsx("div",{className:"w-11 h-11 bg-gray-100 rounded-full flex items-center justify-center",children:a.jsx(Yr,{className:"w-5 h-5 text-gray-500"})})},{id:"before-meal",label:"Before meal",description:"Reading taken within 15 minutes before a major meal",icon:a.jsx("div",{className:"w-11 h-11 bg-gray-100 rounded-full flex items-center justify-center",children:a.jsx("svg",{className:"w-5 h-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})})},{id:"after-meal",label:"After meal",description:"Reading taken 2 hours after a meal",icon:a.jsx("div",{className:"w-11 h-11 bg-gray-100 rounded-full flex items-center justify-center",children:a.jsx("svg",{className:"w-5 h-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})})},{id:"bedtime",label:"Bedtime",description:"Reading taken before going to sleep",icon:a.jsx("div",{className:"w-11 h-11 bg-gray-100 rounded-full flex items-center justify-center",children:a.jsx("svg",{className:"w-5 h-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})})})}],te=q-X,ie=[];for(let ue=0;ue<=te;ue++){const Ne=X+ue,be=Ne%10===0,Q=Ne%5===0&&!be;ie.push({val:Ne,isMajor:be,isMid:Q})}return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 transition-opacity duration-300",onClick:f}),a.jsx("div",{className:"fixed inset-x-0 bottom-0 z-50 animate-slide-up",children:a.jsxs("div",{className:"bg-white rounded-t-3xl shadow-2xl max-h-[92vh] overflow-y-auto",children:[a.jsx("div",{className:"flex justify-center pt-3 pb-1",children:a.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),a.jsxs("div",{className:"sticky top-0 bg-white px-5 py-3 flex items-center gap-3 z-10",children:[a.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-700"})}),a.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Log Glucose"})]}),a.jsxs("div",{className:"px-5 pb-8",children:[a.jsxs("div",{className:"bg-gray-50 rounded-2xl p-6 mb-6 text-center flex items-center justify-center",children:[a.jsx("input",{type:"number",value:_,onChange:H,className:`w-28 text-6xl font-extrabold ${ae()} tracking-tight text-center bg-transparent border-none outline-none focus:ring-0`}),a.jsx("span",{className:"text-lg text-gray-400 font-medium ml-1",children:"mg/dL"})]}),a.jsxs("div",{className:"mb-8 relative",children:[a.jsx("div",{className:"flex justify-center mb-1",children:a.jsx("div",{className:"w-0 h-0 border-l-[8px] border-r-[8px] border-t-[10px] border-l-transparent border-r-transparent border-t-blue-500"})}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:()=>B(-5),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(Xd,{className:"w-4 h-4 text-gray-600"})}),a.jsx("div",{ref:F,onScroll:D,className:"flex-1 overflow-x-auto scrollbar-hide relative",style:{scrollBehavior:k.current?"auto":"smooth",WebkitOverflowScrolling:"touch"},onTouchStart:()=>{k.current=!0},onTouchEnd:()=>{k.current=!1},onMouseDown:()=>{k.current=!0},onMouseUp:()=>{k.current=!1},children:a.jsx("div",{className:"flex items-end h-20",style:{width:`${te*8}px`,paddingLeft:"50%",paddingRight:"50%"},children:ie.map((ue,Ne)=>a.jsxs("div",{className:"flex flex-col items-center",style:{width:"8px",flexShrink:0},children:[a.jsx("div",{className:`w-px ${ue.isMajor?"h-10 bg-gray-700":ue.isMid?"h-6 bg-gray-400":"h-3 bg-gray-300"}`}),ue.isMajor&&a.jsx("span",{className:"text-[10px] text-gray-500 mt-1 font-medium",children:ue.val})]},Ne))})}),a.jsx("button",{onClick:()=>B(5),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(vi,{className:"w-4 h-4 text-gray-600"})})]})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-3",children:"When was this reading taken?"}),a.jsx("div",{className:"bg-gray-50 rounded-xl p-4 flex items-center justify-between border border-gray-200",children:a.jsx("input",{type:"datetime-local",value:U,onChange:ue=>G(ue.target.value),className:"bg-transparent text-gray-700 text-sm font-medium w-full outline-none"})})]}),a.jsxs("div",{className:"mb-8",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-3",children:"Type of reading"}),a.jsx("div",{className:"space-y-3",children:Z.map(ue=>a.jsx("button",{onClick:()=>R(ue.id),className:`w-full p-4 rounded-2xl border-2 transition-all duration-200 ${y===ue.id?"border-blue-500 bg-blue-50/50 shadow-sm":"border-gray-200 bg-white hover:border-gray-300"}`,children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[ue.icon,a.jsxs("div",{className:"text-left",children:[a.jsx("div",{className:"font-semibold text-slate-800 text-sm",children:ue.label}),a.jsx("div",{className:"text-xs text-gray-500 mt-0.5 leading-relaxed",children:ue.description})]})]}),a.jsx("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 ml-3 transition-all ${y===ue.id?"border-blue-500 bg-blue-500":"border-gray-300"}`,children:y===ue.id&&a.jsx("div",{className:"w-2.5 h-2.5 bg-white rounded-full"})})]})},ue.id))})]}),a.jsx("button",{onClick:ne,className:"w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-full font-bold text-base hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-[0.98]",children:"Save Reading"})]})]})}),a.jsx("style",{children:`
        @keyframes slide-up {
          from {
            transform: translateY(100%);
          }
          to {
            transform: translateY(0);
          }
        }
        .animate-slide-up {
          animation: slide-up 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `})]})},ree=({isOpen:u,onClose:f,onSave:x})=>{const[_,E]=j.useState(5.7),y=new Date;y.setMinutes(y.getMinutes()-y.getTimezoneOffset());const[R,P]=j.useState(y.toISOString().slice(0,16)),U=j.useRef(null),G=j.useRef(!1),F=30,k=150;j.useEffect(()=>{if(u&&U.current){const te=(_*10-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,te)}},[u]);const X=()=>{if(!U.current)return;const Z=8,te=U.current.scrollLeft,ie=U.current.clientWidth/2,ue=Math.round((te+ie)/Z)+F;ue>=F&&ue<=k&&E(ue/10)},q=Z=>{const te=parseFloat(Z.target.value);if(isNaN(te))E("");else if(E(te),U.current&&te*10>=F&&te*10<=k){const ue=(te*10-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,ue)}},D=Z=>{E(te=>{const ie=Math.min(Math.max(te*10+Z,F),k),ue=ie/10;if(U.current){const be=(ie-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,be)}return ue})},H=()=>{const Z={value:_,type:"hba1c",time:new Date(R).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),timestamp:new Date(R).toISOString()};x(Z),f()},B=()=>_>=4&&_<=5.6?"text-emerald-600":_>=5.7&&_<=6.4?"text-yellow-600":"text-red-600";if(!u)return null;const ne=k-F,ae=[];for(let Z=0;Z<=ne;Z++){const te=F+Z,ie=te%10===0,ue=te%5===0&&!ie;ae.push({val:te/10,isMajor:ie,isMid:ue})}return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 transition-opacity duration-300",onClick:f}),a.jsx("div",{className:"fixed inset-x-0 bottom-0 z-50 animate-slide-up",children:a.jsxs("div",{className:"bg-white rounded-t-3xl shadow-2xl max-h-[92vh] overflow-y-auto pb-4",children:[a.jsx("div",{className:"flex justify-center pt-3 pb-1",children:a.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),a.jsxs("div",{className:"sticky top-0 bg-white px-5 py-3 flex items-center gap-3 z-10",children:[a.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-700"})}),a.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Log HbA1c"})]}),a.jsxs("div",{className:"px-5 pb-8",children:[a.jsxs("div",{className:"bg-gray-50 rounded-2xl p-6 mb-6 text-center flex items-center justify-center",children:[a.jsx("input",{type:"number",step:"0.1",value:_,onChange:q,className:`w-32 text-6xl font-extrabold ${B()} tracking-tight text-center bg-transparent border-none outline-none focus:ring-0`}),a.jsx("span",{className:"text-lg text-gray-400 font-medium ml-1",children:"%"})]}),a.jsxs("div",{className:"mb-8 relative",children:[a.jsx("div",{className:"flex justify-center mb-1",children:a.jsx("div",{className:"w-0 h-0 border-l-[8px] border-r-[8px] border-t-[10px] border-l-transparent border-r-transparent border-t-blue-500"})}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:()=>D(-1),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(Xd,{className:"w-4 h-4 text-gray-600"})}),a.jsx("div",{ref:U,onScroll:X,className:"flex-1 overflow-x-auto scrollbar-hide relative",style:{scrollBehavior:G.current?"auto":"smooth",WebkitOverflowScrolling:"touch"},onTouchStart:()=>{G.current=!0},onTouchEnd:()=>{G.current=!1},onMouseDown:()=>{G.current=!0},onMouseUp:()=>{G.current=!1},children:a.jsx("div",{className:"flex items-end h-20",style:{width:`${ne*8}px`,paddingLeft:"50%",paddingRight:"50%"},children:ae.map((Z,te)=>a.jsxs("div",{className:"flex flex-col items-center",style:{width:"8px",flexShrink:0},children:[a.jsx("div",{className:`w-px ${Z.isMajor?"h-10 bg-gray-700":Z.isMid?"h-6 bg-gray-400":"h-3 bg-gray-300"}`}),Z.isMajor&&a.jsx("span",{className:"text-[10px] text-gray-500 mt-1 font-medium",children:Z.val})]},te))})}),a.jsx("button",{onClick:()=>D(1),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(vi,{className:"w-4 h-4 text-gray-600"})})]})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-3",children:"When was this reading taken?"}),a.jsx("div",{className:"bg-gray-50 rounded-xl p-4 flex items-center justify-between border border-gray-200",children:a.jsx("input",{type:"datetime-local",value:R,onChange:Z=>P(Z.target.value),className:"bg-transparent text-gray-700 text-sm font-medium w-full outline-none"})})]}),a.jsx("button",{onClick:H,className:"w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-full font-bold text-base hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-[0.98]",children:"Save Reading"})]})]})})]})},iee=({isOpen:u,onClose:f,onSave:x})=>{const[_,E]=j.useState(70),y=new Date;y.setMinutes(y.getMinutes()-y.getTimezoneOffset());const[R,P]=j.useState(y.toISOString().slice(0,16)),U=j.useRef(null),G=j.useRef(!1),F=200,k=2500;j.useEffect(()=>{if(u&&U.current){const Z=(_*10-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,Z)}},[u]);const X=ae=>{const Z=parseFloat(ae.target.value);if(isNaN(Z))E("");else if(E(Z),U.current&&Z*10>=F&&Z*10<=k){const ie=(Z*10-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,ie)}},q=ae=>{E(Z=>{const te=Math.min(Math.max(Z*10+ae,F),k),ie=te/10;if(U.current){const Ne=(te-F)*8-U.current.clientWidth/2;U.current.scrollLeft=Math.max(0,Ne)}return ie})},D=()=>{const ae={value:_,type:"weight",time:new Date(R).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),timestamp:new Date(R).toISOString()};x(ae),f()};if(!u)return null;const H=[];for(let ae=0;ae<=(k-F)/10;ae++){const Z=F/10+ae,te=Z%5===0,ie=Z%1===0&&!te;H.push({val:Z,isMajor:te,isMid:ie})}const B=80,ne=()=>{if(!U.current)return;const ae=U.current.scrollLeft,Z=U.current.clientWidth/2,te=Math.round((ae+Z)/(B/10))+F;te>=F&&te<=k&&E(te/10)};return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 transition-opacity duration-300",onClick:f}),a.jsx("div",{className:"fixed inset-x-0 bottom-0 z-50 animate-slide-up",children:a.jsxs("div",{className:"bg-white rounded-t-3xl shadow-2xl max-h-[92vh] overflow-y-auto pb-4",children:[a.jsx("div",{className:"flex justify-center pt-3 pb-1",children:a.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),a.jsxs("div",{className:"sticky top-0 bg-white px-5 py-3 flex items-center gap-3 z-10",children:[a.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-700"})}),a.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Log Weight"})]}),a.jsxs("div",{className:"px-5 pb-8",children:[a.jsxs("div",{className:"bg-gray-50 rounded-2xl p-6 mb-6 text-center flex items-center justify-center",children:[a.jsx("input",{type:"number",step:"0.1",value:_,onChange:X,className:"w-36 text-6xl font-extrabold text-blue-900 tracking-tight text-center bg-transparent border-none outline-none focus:ring-0"}),a.jsx("span",{className:"text-lg text-gray-400 font-medium ml-1",children:"kg"})]}),a.jsxs("div",{className:"mb-8 relative",children:[a.jsx("div",{className:"flex justify-center mb-1",children:a.jsx("div",{className:"w-0 h-0 border-l-[8px] border-r-[8px] border-t-[10px] border-l-transparent border-r-transparent border-t-blue-500"})}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:()=>q(-10),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(Xd,{className:"w-4 h-4 text-gray-600"})}),a.jsx("div",{ref:U,onScroll:ne,className:"flex-1 overflow-x-auto scrollbar-hide relative",style:{scrollBehavior:G.current?"auto":"smooth",WebkitOverflowScrolling:"touch"},onTouchStart:()=>{G.current=!0},onTouchEnd:()=>{G.current=!1},onMouseDown:()=>{G.current=!0},onMouseUp:()=>{G.current=!1},children:a.jsx("div",{className:"flex items-end h-20",style:{width:`${H.length*B}px`,paddingLeft:"50%",paddingRight:"50%"},children:H.map((ae,Z)=>a.jsxs("div",{className:"flex justify-between items-end",style:{width:`${B}px`,flexShrink:0},children:[a.jsxs("div",{className:"flex flex-col items-center flex-1",children:[a.jsx("div",{className:`w-px ${ae.isMajor?"h-10 bg-gray-700":"h-6 bg-gray-400"}`}),ae.isMajor&&a.jsx("span",{className:"text-[10px] text-gray-500 mt-1 font-medium",children:ae.val})]}),a.jsx("div",{className:"w-px h-3 bg-gray-300"}),a.jsx("div",{className:"w-px h-3 bg-gray-300"}),a.jsx("div",{className:"w-px h-3 bg-gray-300"})]},Z))})}),a.jsx("button",{onClick:()=>q(10),className:"flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors active:scale-95",children:a.jsx(vi,{className:"w-4 h-4 text-gray-600"})})]})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-3",children:"When was this reading taken?"}),a.jsx("div",{className:"bg-gray-50 rounded-xl p-4 flex items-center justify-between border border-gray-200",children:a.jsx("input",{type:"datetime-local",value:R,onChange:ae=>P(ae.target.value),className:"bg-transparent text-gray-700 text-sm font-medium w-full outline-none"})})]}),a.jsx("button",{onClick:D,className:"w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-full font-bold text-base hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-[0.98]",children:"Save Reading"})]})]})})]})},oee=()=>{const u=Ga(),[f,x]=j.useState(!1),[_,E]=j.useState(!1),[y,R]=j.useState(!1),[P,U]=j.useState([]),[G,F]=j.useState([]),[k,X]=j.useState([]),[q,D]=j.useState([]),[H,B]=j.useState(108),[ne,ae]=j.useState("stable"),[Z,te]=j.useState(!1),[ie,ue]=j.useState("108"),[Ne,be]=j.useState(!0),[Q,pe]=j.useState("blood_sugar"),[he,Ae]=j.useState("Week"),[fe,le]=j.useState(!1),we=j.useRef(null),re=j.useRef(null);j.useEffect(()=>{oe()},[]);const oe=async()=>{try{be(!0);const je=await et.get("/metrics/blood_sugar?limit=10");U(je.data);const[Ze,Ct,zt]=await Promise.all([et.get("/metrics/blood_sugar?limit=50"),et.get("/metrics/hba1c?limit=50"),et.get("/metrics/weight?limit=50")]);if(F(Ze.data),X(Ct.data),D(zt.data),je.data&&je.data.length>0){const ts=je.data[0].value;B(ts),ue(String(ts)),J(ts)}}catch(je){console.error("Error fetching metrics:",je)}finally{be(!1)}},J=je=>{je>=70&&je<=130?ae("stable"):je>130?ae("high"):ae("low")},Oe=async(je,Ze,Ct,zt,ts)=>{try{const ge={type:je,value:Ze,unit:Ct,readingContext:zt,recordedAt:ts,notes:""};await et.post("/metrics",ge),oe()}catch(ge){console.error("Error saving reading:",ge)}},$e=async je=>{await Oe("blood_sugar",je.value,"mg/dL",je.type,je.timestamp)},He=async je=>{await Oe("hba1c",je.value,"%","fasting",je.timestamp),pe("hba1c")},ot=async je=>{await Oe("weight",je.value,"kg","general",je.timestamp),pe("weight")},_t=()=>{te(!0),ue(String(H)),setTimeout(()=>{var je;return(je=we.current)==null?void 0:je.select()},50)},Ke=je=>{const Ze=je.target.value.replace(/[^0-9]/g,"");if(Ze.length<=3){ue(Ze);const Ct=parseInt(Ze)||0;Ct>=40&&Ct<=400&&(B(Ct),J(Ct))}},ht=()=>{te(!1);const je=parseInt(ie)||108,Ze=Math.min(Math.max(je,40),400);B(Ze),ue(String(Ze)),J(Ze)},st=je=>{je.key==="Enter"&&ht()},ct=je=>{if(!re.current)return;const Ze=re.current.getBoundingClientRect(),Ct=Ze.left+Ze.width/2,zt=Ze.top+Ze.height*.85,ts=je.touches?je.touches[0].clientX:je.clientX,ge=je.touches?je.touches[0].clientY:je.clientY,We=ts-Ct,rt=zt-ge;let ws=Math.atan2(We,rt)*(180/Math.PI);ws=Math.max(-135,Math.min(135,ws));const Cn=40,Fe=400,Je=Math.round(Cn+(ws+135)/270*(Fe-Cn)),De=Math.min(Math.max(Je,Cn),Fe);B(De),ue(String(De)),J(De)},fs=()=>-135+(Math.min(Math.max(H,40),400)-40)/360*270,ys=()=>{let je=[];if(Q==="blood_sugar"?je=G:Q==="hba1c"?je=k:Q==="weight"&&(je=q),!je||je.length===0)return[{day:"N/A",value:0}];const Ze=[...je].sort((We,rt)=>new Date(We.recordedAt)-new Date(rt.recordedAt)),Ct=new Date;let zt=new Date;he==="Week"?zt.setDate(Ct.getDate()-7):he==="Month"?zt.setMonth(Ct.getMonth()-1):he==="3 Months"&&zt.setMonth(Ct.getMonth()-3);const ts=Ze.filter(We=>new Date(We.recordedAt)>=zt);return(ts.length>0?ts:Ze.slice(-7)).map(We=>{const rt=new Date(We.recordedAt);return{day:rt.toLocaleDateString("en-US",{weekday:"short"}),value:We.value,fullDate:rt.toLocaleDateString()}})},As=()=>Q==="hba1c"?[4,6,8,10]:Q==="weight"?[50,70,90,110]:[1,48,95,142,190],zs=je=>{const{cx:Ze,cy:Ct,value:zt}=je;let ts="#10b981";return Q==="blood_sugar"&&(zt>150&&(ts="#f59e0b"),zt<50&&(ts="#ef4444")),a.jsx("circle",{cx:Ze,cy:Ct,r:4,strokeWidth:2,stroke:"#fff",fill:ts})};return a.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-cyan-50 via-blue-50 to-cyan-100 pb-28",children:[a.jsx("div",{className:"sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-white/40",children:a.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx("button",{onClick:()=>u("/dashboard"),className:"mr-3 p-2 hover:bg-white/60 rounded-full transition-colors",children:a.jsx(dn,{className:"w-5 h-5 text-slate-700"})}),a.jsx("h1",{className:"text-lg font-bold text-slate-800",children:"Blood Sugar"})]}),a.jsx("div",{children:a.jsx("span",{className:`px-3 py-1 text-white rounded-full text-[11px] font-bold tracking-wide ${ne==="stable"?"bg-emerald-500":ne==="high"?"bg-red-500":"bg-yellow-500"}`,children:ne==="stable"?"IN RANGE":ne.toUpperCase()})})]})}),a.jsxs("div",{className:"px-3 md:px-4 py-4 space-y-6 max-w-7xl mx-auto",children:[a.jsx("p",{className:"text-center text-gray-500 text-sm",children:ne==="stable"?"Your current status is stable":`Your glucose is ${ne}`}),a.jsxs("div",{ref:re,className:"relative w-64 h-40 mx-auto cursor-pointer select-none",onClick:ct,onMouseDown:je=>{const Ze=zt=>ct(zt),Ct=()=>{document.removeEventListener("mousemove",Ze),document.removeEventListener("mouseup",Ct)};document.addEventListener("mousemove",Ze),document.addEventListener("mouseup",Ct)},onTouchStart:je=>{ct(je);const Ze=zt=>ct(zt),Ct=()=>{document.removeEventListener("touchmove",Ze),document.removeEventListener("touchend",Ct)};document.addEventListener("touchmove",Ze),document.addEventListener("touchend",Ct)},children:[a.jsxs("svg",{viewBox:"0 0 200 130",className:"w-full h-full",children:[a.jsx("path",{d:"M 20 120 A 80 80 0 0 1 180 120",fill:"none",stroke:"#e5e7eb",strokeWidth:"18",strokeLinecap:"round"}),a.jsx("path",{d:"M 20 120 A 80 80 0 0 1 55 45",fill:"none",stroke:"#22c55e",strokeWidth:"18",strokeLinecap:"round"}),a.jsx("path",{d:"M 55 45 A 80 80 0 0 1 100 30",fill:"none",stroke:"#f59e0b",strokeWidth:"18",strokeLinecap:"round"}),a.jsx("path",{d:"M 100 30 A 80 80 0 0 1 145 45",fill:"none",stroke:"#ef4444",strokeWidth:"18",strokeLinecap:"round"}),a.jsx("path",{d:"M 145 45 A 80 80 0 0 1 180 120",fill:"none",stroke:"#f3f4f6",strokeWidth:"18",strokeLinecap:"round"}),a.jsxs("g",{transform:`rotate(${fs()}, 100, 120)`,className:"transition-transform duration-200",children:[a.jsx("line",{x1:"100",y1:"120",x2:"100",y2:"48",stroke:"#1e293b",strokeWidth:"3",strokeLinecap:"round"}),a.jsx("circle",{cx:"100",cy:"120",r:"6",fill:"#1e293b"}),a.jsx("circle",{cx:"100",cy:"120",r:"3",fill:"white"})]})]}),a.jsx("div",{className:"absolute bottom-0 left-1/2 transform -translate-x-1/2 text-center",children:Z?a.jsxs("div",{className:"flex items-baseline justify-center gap-1",children:[a.jsx("input",{ref:we,type:"text",inputMode:"numeric",value:ie,onChange:Ke,onBlur:ht,onKeyDown:st,className:"w-24 text-5xl font-extrabold text-center bg-transparent outline-none border-b-2 border-blue-500 text-slate-800",autoFocus:!0}),a.jsx("span",{className:"text-sm text-gray-400 font-semibold tracking-wider",children:"MG/DL"})]}):a.jsxs("button",{onClick:_t,className:"group",children:[a.jsx("div",{className:"text-5xl font-extrabold text-slate-800 leading-none group-hover:text-blue-600 transition-colors",children:H}),a.jsx("div",{className:"text-sm text-gray-400 font-semibold tracking-wider mt-1",children:"MG/DL"}),a.jsx("div",{className:"text-[10px] text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity",children:"tap to edit"})]})})]}),a.jsxs("div",{className:"flex justify-center gap-2 px-2 mt-8",children:[a.jsx("button",{onClick:()=>E(!0),className:"flex-1 bg-white border border-blue-100 shadow-sm text-blue-600 py-3 rounded-2xl font-bold text-[13px] hover:bg-blue-50 transition-colors",children:"Log HbA1c"}),a.jsx("button",{onClick:()=>x(!0),className:"flex-[1.5] bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-md shadow-blue-200 py-3 rounded-2xl font-bold text-[13px] hover:from-blue-600 hover:to-blue-700 transition-colors focus:scale-95",children:"+ Log Glucose"}),a.jsx("button",{onClick:()=>R(!0),className:"flex-1 bg-white border border-blue-100 shadow-sm text-blue-600 py-3 rounded-2xl font-bold text-[13px] hover:bg-blue-50 transition-colors",children:"Log Weight"})]}),a.jsxs("div",{className:"mt-8",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[a.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"Trend"}),a.jsxs("div",{className:"relative",children:[a.jsxs("button",{onClick:()=>le(!fe),className:"flex items-center gap-1.5 text-sm font-semibold text-blue-600 bg-blue-50/80 px-3 py-1.5 rounded-full",children:[Q==="blood_sugar"?"Glucose":Q==="hba1c"?"HbA1c":"Weight",a.jsx(yo,{className:"w-4 h-4"})]}),fe&&a.jsxs("div",{className:"absolute right-0 top-full mt-1 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden z-20 w-36",children:[a.jsx("button",{onClick:()=>{pe("blood_sugar"),le(!1)},className:`w-full text-left px-4 py-2.5 text-sm font-medium hover:bg-blue-50 ${Q==="blood_sugar"?"text-blue-600 bg-blue-50/50":"text-slate-700"}`,children:"Glucose"}),a.jsx("button",{onClick:()=>{pe("hba1c"),le(!1)},className:`w-full text-left px-4 py-2.5 text-sm font-medium hover:bg-blue-50 ${Q==="hba1c"?"text-blue-600 bg-blue-50/50":"text-slate-700"}`,children:"HbA1c"}),a.jsx("button",{onClick:()=>{pe("weight"),le(!1)},className:`w-full text-left px-4 py-2.5 text-sm font-medium hover:bg-blue-50 ${Q==="weight"?"text-blue-600 bg-blue-50/50":"text-slate-700"}`,children:"Weight"})]})]})]}),a.jsxs("div",{className:"bg-white/90 backdrop-blur-md rounded-3xl p-5 shadow-[0_4px_20px_rgba(0,0,0,0.04)] border border-white",children:[a.jsx("div",{className:"bg-gray-100/80 rounded-full p-1 flex items-center justify-between mb-4",children:["Week","Month","3 Months"].map(je=>a.jsx("button",{onClick:()=>Ae(je),className:`flex-1 py-2 text-[13px] font-bold rounded-full transition-all ${he===je?"bg-[#1e293b] text-white shadow-md":"text-slate-500 hover:text-slate-700"}`,children:je},je))}),a.jsxs("div",{className:"flex justify-between items-end mb-4",children:[a.jsx("div",{children:a.jsxs("div",{className:"text-2xl font-extrabold text-[#112340] leading-none flex items-baseline gap-1",children:[(()=>{const Ze=ys().filter(zt=>zt.day!=="N/A");if(Ze.length===0)return"0%";const Ct=Ze.filter(zt=>Q==="blood_sugar"?zt.value>=70&&zt.value<=130:Q==="hba1c"?zt.value<7:!0).length;return Math.round(Ct/Ze.length*100)+"%"})()," ",a.jsx("span",{className:"text-sm font-bold text-slate-800",children:Q==="blood_sugar"?"normal":Q==="hba1c"?"goal":"recorded"})]})}),a.jsx("div",{className:"text-xs font-semibold text-slate-400",children:he==="Week"?"Last 7 days":he==="Month"?"Last 30 days":"Last 90 days"})]}),Q==="blood_sugar"&&a.jsxs("div",{className:"flex items-center gap-4 mb-6 flex-wrap",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-[11.5px] font-bold text-slate-700",children:[a.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-[#10b981]"})," ","Normal"]}),a.jsxs("div",{className:"flex items-center gap-1.5 text-[11.5px] font-bold text-slate-700",children:[a.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-[#f59e0b]"})," High"]}),a.jsxs("div",{className:"flex items-center gap-1.5 text-[11.5px] font-bold text-slate-700",children:[a.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-[#ef4444]"})," ","Critical"]}),a.jsxs("div",{className:"flex items-center gap-1.5 text-[11.5px] font-bold text-slate-700",children:[a.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-[#d97706]"})," Low"]})]}),a.jsx("div",{className:"h-56 w-full -ml-3",children:a.jsx(jh,{width:"100%",height:"100%",children:a.jsxs(_2,{data:ys(),margin:{top:10,right:10,left:0,bottom:0},children:[a.jsx(gg,{strokeDasharray:"3 3",vertical:!0,horizontal:!0,stroke:"#f1f5f9"}),a.jsx(xg,{dataKey:"day",axisLine:!1,tickLine:!1,tick:{fontSize:11,fill:"#94a3b8",fontWeight:600},dy:10}),a.jsx(bg,{axisLine:!1,tickLine:!1,tick:{fontSize:11,fill:"#94a3b8",fontWeight:600},ticks:As(),domain:["dataMin - 10","dataMax + 10"]}),a.jsx(v2,{type:"monotone",dataKey:"value",stroke:"#94a3b8",strokeWidth:1.5,dot:zs,isAnimationActive:!0})]})})}),Q==="blood_sugar"&&a.jsxs("div",{className:"flex overflow-x-auto scrollbar-hide gap-2 mt-6 pb-1",children:[a.jsx("button",{className:"flex-shrink-0 bg-[#1e293b] text-white px-4 py-1.5 rounded-full text-xs font-bold",children:"All"}),a.jsxs("button",{className:"flex-shrink-0 bg-blue-50/50 text-[#1c5dfd] px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-1",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-sm bg-blue-500 rotate-45"})," ","Fasting"]}),a.jsxs("button",{className:"flex-shrink-0 bg-blue-50/50 text-[#1c5dfd] px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-1",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-sm bg-blue-500"})," ","Pre-meal"]}),a.jsxs("button",{className:"flex-shrink-0 bg-blue-50/50 text-[#1c5dfd] px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-1",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-sm bg-blue-500 rotate-45"})," ","Post-meal"]}),a.jsxs("button",{className:"flex-shrink-0 bg-blue-50/50 text-[#1c5dfd] px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-1",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-blue-500"})," ","Random"]})]})]})]}),(()=>{const je=Q==="blood_sugar"?G:Q==="hba1c"?k:q;return!je||je.length===0?null:a.jsxs("div",{className:"bg-white/70 backdrop-blur-sm rounded-3xl border border-white/60 shadow-sm p-4 sm:p-6 !mt-6",children:[a.jsxs("h3",{className:"text-sm font-bold text-slate-800 mb-3",children:["Recent ",Q==="blood_sugar"?"Glucose":Q==="hba1c"?"HbA1c":"Weight"," Logs"]}),a.jsx("div",{className:"space-y-2",children:je.slice(0,5).map((Ze,Ct)=>{var ge,We;const ts=new Date(Ze.recordedAt||Ze.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return a.jsxs("div",{className:"flex items-center justify-between p-3 bg-white/60 rounded-xl",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-9 h-9 rounded-full flex items-center justify-center ${Ze.value>=70&&Ze.value<=130?"bg-green-100":Ze.value>130?"bg-red-100":"bg-yellow-100"}`,children:a.jsx(LE,{className:`w-4 h-4 ${Ze.value>=70&&Ze.value<=130?"text-green-600":Ze.value>130?"text-red-600":"text-yellow-600"}`})}),a.jsxs("div",{children:[a.jsxs("p",{className:"text-sm font-semibold text-slate-700",children:[Ze.value," ",Ze.type==="hba1c"?"%":Ze.type==="weight"?"kg":"mg/dL"]}),a.jsx("p",{className:"text-xs text-gray-400 capitalize",children:((ge=Ze.readingContext)==null?void 0:ge.replace("-"," "))||((We=Ze.type)==null?void 0:We.replace("_"," "))})]})]}),a.jsx("span",{className:"text-xs text-gray-400",children:ts})]},Ct)})})]})})()]}),a.jsx(aee,{isOpen:f,onClose:()=>x(!1),onSave:$e}),a.jsx(ree,{isOpen:_,onClose:()=>E(!1),onSave:He}),a.jsx(iee,{isOpen:y,onClose:()=>R(!1),onSave:ot})]})},$n=({children:u,allowedRoles:f})=>{const{user:x,loading:_}=ia();return _?a.jsx(No,{}):x?f&&!f.includes(x.role)?x.role==="admin"?a.jsx(_r,{to:"/admin"}):x.role==="doctor"?a.jsx(_r,{to:"/doctor/dashboard"}):a.jsx(_r,{to:"/dashboard"}):u:a.jsx(_r,{to:"/login"})},cee=({children:u})=>{const{user:f,loading:x,isAdmin:_}=ia();return x?a.jsx(No,{}):f?_()?u:a.jsx(_r,{to:"/dashboard"}):a.jsx(_r,{to:"/login"})},rE=({children:u})=>{const{user:f,loading:x,isDoctor:_}=ia();return x?a.jsx(No,{}):f?_()?u:a.jsx(_r,{to:"/dashboard"}):a.jsx(_r,{to:"/login"})};function lee(){const{user:u,isAdmin:f,isDoctor:x}=ia(),_=()=>u?f()?a.jsx(_r,{to:"/admin"}):x()?a.jsx(_r,{to:"/doctor/dashboard"}):a.jsx(_r,{to:"/dashboard"}):a.jsx(fQ,{});return a.jsxs("div",{className:"min-h-screen bg-fixed bg-gradient-to-br from-cyan-50 via-blue-50 to-cyan-100",children:[a.jsx(JJ,{}),a.jsxs(HY,{children:[a.jsx(Fs,{path:"/",element:a.jsx(mQ,{})}),a.jsx(Fs,{path:"/login",element:_()}),a.jsx(Fs,{path:"/register",element:u?a.jsx(_r,{to:"/dashboard"}):a.jsx(xQ,{})}),a.jsx(Fs,{path:"/register/doctor",element:u?a.jsx(_r,{to:"/doctor/dashboard"}):a.jsx(_Q,{})}),a.jsx(Fs,{path:"/dashboard",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(RQ,{})})})}),a.jsx(Fs,{path:"/upload",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(wZ,{})})})}),a.jsx(Fs,{path:"/reports",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx($Z,{})})})}),a.jsx(Fs,{path:"/reports/:id",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(SZ,{})})})}),a.jsx(Fs,{path:"/reports/:id/summary",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(eee,{})})})}),a.jsx(Fs,{path:"/challenge",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(QZ,{})})})}),a.jsx(Fs,{path:"/diabetes",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(ZZ,{})})})}),a.jsx(Fs,{path:"/doctors",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(TZ,{})})})}),a.jsx(Fs,{path:"/consultation/:appointmentId",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(FZ,{})})}),a.jsx(Fs,{path:"/consultation-summary/:appointmentId",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(BZ,{})})})}),a.jsx(Fs,{path:"/wearables",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(MZ,{})})})}),a.jsx(Fs,{path:"/nutrition",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(XZ,{})})})}),a.jsx(Fs,{path:"/quick-food-scan",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(nee,{})})})}),a.jsx(Fs,{path:"/glucose-log",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(oee,{})})})}),a.jsx(Fs,{path:"/vital-signs",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(tee,{})})})}),a.jsx(Fs,{path:"/supplements",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(see,{})})})}),a.jsx(Fs,{path:"/subscription",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(LZ,{})})})}),a.jsx(Fs,{path:"/diet-plan",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(KZ,{})})})}),a.jsx(Fs,{path:"/ai-chat",element:a.jsx($n,{allowedRoles:["patient","client"],children:a.jsx(kn,{children:a.jsx(qZ,{})})})}),a.jsx(Fs,{path:"/doctor/dashboard",element:a.jsx(rE,{children:a.jsx(kn,{isDoctor:!0,children:a.jsx(CQ,{})})})}),a.jsx(Fs,{path:"/doctor/availability",element:a.jsx(rE,{children:a.jsx(kn,{isDoctor:!0,children:a.jsx(zZ,{})})})}),a.jsx(Fs,{path:"/patient/:patientId",element:a.jsx(rE,{children:a.jsx(kn,{isDoctor:!0,children:a.jsx(UZ,{})})})}),a.jsx(Fs,{path:"/profile",element:a.jsx($n,{children:a.jsx(kn,{children:a.jsx(RZ,{})})})}),a.jsx(Fs,{path:"/admin",element:a.jsx(cee,{children:a.jsx(kn,{isAdmin:!0,children:a.jsx(DZ,{})})})}),a.jsx(Fs,{path:"/demo",element:a.jsx(OZ,{})}),a.jsx(Fs,{path:"/video-test",element:a.jsx(GZ,{})}),a.jsx(Fs,{path:"/email-test",element:a.jsx(WZ,{})})]})]})}pE.createRoot(document.getElementById("root")).render(a.jsx(o2.StrictMode,{children:a.jsx(zY,{children:a.jsx(HJ,{children:a.jsxs(vQ,{children:[a.jsx(lee,{}),a.jsx(dX,{position:"top-right"})]})})})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(u=>{console.log(" Service Worker registered:",u.scope)}).catch(u=>{console.log(" Service Worker registration failed:",u)})});
